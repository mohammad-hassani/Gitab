---
layout: layout.njk
title: ูพุฑุณโูุฌููุง LINQ
---
# ูุตู ูุดุชู: ูพุฑุณโูุฌููุง LINQ

**LINQ** ุง **Language Integrated Query** ูุฌููุนูโุง ุงุฒ ูฺฺฏโูุง ุฒุจุงู ู ุฒูุงู ุงุฌุฑุงุณุช ฺฉู ุจุฑุง ููุดุชู ูพุฑุณโูุฌููุง ุณุงุฎุชุงุฑุงูุชู ู ููุน-ุงูู (**type-safe**) ุฑู ูุฌููุนูโูุง ูุญู ุงุฒ ุงุดุง ู ููุงุจุน ุฏุงุฏู ุฑุงู ุฏูุฑ ุงุณุชูุงุฏู ูโุดูุฏ.

LINQ ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ุฑู ูุฑ ูุฌููุนูโุง ฺฉู **IEnumerable<T>** ุฑุง ูพุงุฏูโุณุงุฒ ฺฉุฑุฏู ุงุณุช ูพุฑุณโูุฌู ฺฉูุฏุ ฺู ฺฉ ุขุฑุงูุ ูุณุชุ ุง **XML Document Object Model (DOM)** ุจุงุดุฏุ ู ฺู ููุงุจุน ุฏุงุฏู ุฑุงู ุฏูุฑ ูุงููุฏ ุฌุฏููโูุง ููุฌูุฏ ุฏุฑ ูพุงฺฏุงู ุฏุงุฏู **SQL Server**. LINQ ูุฒุงุง ุจุฑุฑุณ ููุน ุฏุฑ ุฒูุงู ฺฉุงููพุงู (**compile-time type checking**) ู ุชุฑฺฉุจ ูพุฑุณโูุฌููุง ูพูุง (**dynamic query composition**) ุฑุง ุงุฑุงุฆู ูโุฏูุฏ.

ุงู ูุตู ูุนูุงุฑ LINQ ู ุงุตูู ููุดุชู ูพุฑุณโูุฌููุง ุฑุง ุชูุถุญ ูโุฏูุฏ. ูููโ ููุนโูุง ุงุตู ุฏุฑ **System.Linq** ู **System.Linq.Expressions** ุชุนุฑู ุดุฏูโุงูุฏ.

ูุซุงูโูุง ุงู ูุตู ู ุฏู ูุตู ุจุนุฏ ุฏุฑ ฺฉ ุงุจุฒุงุฑ ุชุนุงูู ูพุฑุณโูุฌู ุจู ูุงู **LINQPad** ุจุงุฑฺฏุฐุงุฑ ุดุฏูโุงูุฏ. ูโุชูุงูุฏ **LINQPad** ุฑุง ุงุฒ [ุงู ููฺฉ](http://www.linqpad.net) ุฏุงูููุฏ ฺฉูุฏ.

---

### ุดุฑูุน ฺฉุงุฑ ๐

ูุงุญุฏูุง ูพุงู ุฏุงุฏู ุฏุฑ LINQุ **ุฏูุจุงููโูุง (sequences)** ู **ุนูุงุตุฑ (elements)** ูุณุชูุฏ. ฺฉ ุฏูุจุงูู ูุฑ ุดุฆ ุงุณุช ฺฉู **IEnumerable<T>** ุฑุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ ู ูุฑ ุนูุตุฑุ ฺฉ ุขุชู ุฏุฑ ุขู ุฏูุจุงูู ุงุณุช.

ูุซุงู ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

```csharp
string[] names = { "Tom", "Dick", "Harry" };
```

ุฏุฑ ุงู ูุซุงูุ `names` ฺฉ ุฏูุจุงูู ุงุณุช ู `"Tom"`, `"Dick"`, ู `"Harry"` ุนูุงุตุฑ ุขู ูุณุชูุฏ.
ุจู ุงู ุฏูุจุงูู **ูุญู (local sequence)** ฺฏูุชู ูโุดูุฏ ฺูู ูุฌููุนูโุง ุงุฒ ุงุดุง ุฏุฑ ุญุงูุธู ูุญู ุฑุง ููุงุด ูโุฏูุฏ.

---

### ุนููฺฏุฑูุง ูพุฑุณโูุฌู ๐๏ธ

ฺฉ **ุนููฺฏุฑ ูพุฑุณโูุฌู (query operator)** ูุชุฏ ุงุณุช ฺฉู ฺฉ ุฏูุจุงูู ุฑุง ุชุบุฑ ูโุฏูุฏ. ฺฉ ุนููฺฏุฑ ูุนูููุ ฺฉ ุฏูุจุงูู ูุฑูุฏ ูโฺฏุฑุฏ ู ฺฉ ุฏูุจุงูู ุฎุฑูุฌ ุชุบุฑ ุงูุชู ุชููุฏ ูโฺฉูุฏ. ุฏุฑ ฺฉูุงุณ **Enumerable** ุฏุฑ **System.Linq** ุญุฏูุฏ ดฐ ุนููฺฏุฑ ูพุฑุณโูุฌู ุงุณุชุงูุฏุงุฑุฏ ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏ ฺฉู ููฺฏ ุจูโุตูุฑุช **ูุชุฏูุง ุชูุณุนูโุง (extension methods)** ูุณุชูุฏ.

ูพุฑุณโูุฌููุง ฺฉู ุฑู ุฏูุจุงููโูุง ูุญู ฺฉุงุฑ ูโฺฉููุฏุ **ูพุฑุณโูุฌููุง ูุญู** ุง **LINQ-to-objects** ูุงูุฏู ูโุดููุฏ.

LINQ ููฺูู ุฏูุจุงููโูุง ุฑุง ูพุดุชุจุงู ูโฺฉูุฏ ฺฉู ูโุชูุงููุฏ ุจูโุทูุฑ ูพูุง ุงุฒ ฺฉ ููุจุน ุฏุงุฏู ุฑุงู ุฏูุฑ ูุงููุฏ **SQL Server** ุชุบุฐู ุดููุฏ. ุงู ุฏูุจุงููโูุง ุนูุงูู ุจุฑ **IEnumerable<T>**ุ ุฑุงุจุท **IQueryable<T>** ุฑุง ูุฒ ูพุงุฏูโุณุงุฒ ูโฺฉููุฏ ู ุงุฒ ุทุฑู ูุฌููุนูโุง ุงุฒ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุงุณุชุงูุฏุงุฑุฏ ุฏุฑ ฺฉูุงุณ **Queryable** ูพุดุชุจุงู ูโุดููุฏ. ุฌุฒุฆุงุช ุจุดุชุฑ ุฏุฑ ุจุฎุด ยซูพุฑุณโูุฌููุง ุชูุณุฑ ุดุฏู (Interpreted Queries)ยป ุฏุฑ ุตูุญู ดดธ ุขูุฏู ุงุณุช.

---

### ููุดุชู ฺฉ ูพุฑุณโูุฌู ุณุงุฏู โจ

ฺฉ ูพุฑุณโูุฌู ฺฉ **ุนุจุงุฑุช (expression)** ุงุณุช ฺฉู ููุช ุดูุงุฑุด ูโุดูุฏุ ุฏูุจุงููโูุง ุฑุง ุจุง ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุชุบุฑ ูโุฏูุฏ. ุณุงุฏูโุชุฑู ูพุฑุณโูุฌู ุดุงูู ฺฉ ุฏูุจุงูู ูุฑูุฏ ู ฺฉ ุนููฺฏุฑ ุงุณุช.

ูุซุงู ุฒุฑ ุงุฒ ุนููฺฏุฑ **Where** ุจุฑุง ุงุณุชุฎุฑุงุฌ ุฑุดุชูโูุง ฺฉู ุทูู ุขูโูุง ุญุฏุงูู ฺูุงุฑ ฺฉุงุฑุงฺฉุชุฑ ุงุณุชุ ุงุณุชูุงุฏู ูโฺฉูุฏ:

```csharp
string[] names = { "Tom", "Dick", "Harry" };
IEnumerable<string> filteredNames = System.Linq.Enumerable.Where(names, n => n.Length >= 4);
foreach (string n in filteredNames)
    Console.WriteLine(n);
```

ุฎุฑูุฌ:

```
Dick
Harry
```

ุงุฒ ุขูุฌุง ฺฉู ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ ูพุฑุณโูุฌู ุจูโุตูุฑุช **extension methods** ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏุ ูโุชูุงูู **Where** ุฑุง ูุณุชููุงู ุฑู `names` ูุฑุงุฎูุงู ฺฉููุ ุงูฺฏุงุฑ ฺฉู ฺฉ ูุชุฏ ููููู ุงุณุช:

```csharp
IEnumerable<string> filteredNames = names.Where(n => n.Length >= 4);
```

ุจุฑุง ุงูฺฉู ุงู ฺฉุฏ ฺฉุงููพุงู ุดูุฏุ ุจุงุฏ ูุถุง ูุงู **System.Linq** ุฑุง ูุงุฑุฏ ฺฉูุฏ. ูุซุงู ฺฉุงูู:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;

string[] names = { "Tom", "Dick", "Harry" };
IEnumerable<string> filteredNames = names.Where(n => n.Length >= 4);
foreach (string name in filteredNames)
    Console.WriteLine(name);
```

ุฎุฑูุฌ:

```
Dick
Harry
```

ูโุชูุงูู ฺฉุฏ ุฑุง ุจุง **ููุนโุฏู ุถูู (implicit typing)** ฺฉูุชุงูโุชุฑ ฺฉูู:

```csharp
var filteredNames = names.Where(n => n.Length >= 4);
```

ุงูุง ุงู ฺฉุงุฑ ูโุชูุงูุฏ ุฎูุงูุง ฺฉุฏ ุฑุง ุฏุฑ ุฎุงุฑุฌ ุงุฒ ูุญุท IDE ฺฉุงูุด ุฏูุฏุ ุฒุฑุง ุงุจุฒุงุฑูุง ุฑุงูููุง ูุฌูุฏ ูุฏุงุฑูุฏ. ุจู ููู ุฏูู ุฏุฑ ุงู ูุตู ฺฉูุชุฑ ุงุฒ ููุนโุฏู ุถูู ุงุณุชูุงุฏู ูโฺฉูู.

---

### ุงุณุชูุงุฏู ุงุฒ ุนุจุงุฑุงุช ูุงูุจุฏุง ๐น

ุงฺฉุซุฑ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ฺฉ **ุนุจุงุฑุช ูุงูุจุฏุง (lambda expression)** ุจูโุนููุงู ุขุฑฺฏููุงู ูโูพุฐุฑูุฏ. ุงู ุนุจุงุฑุช ูุงูุจุฏุง ุจู ูุฏุงุช ู ุดฺฉูโุฏู ูพุฑุณโูุฌู ฺฉูฺฉ ูโฺฉูุฏ.

ุฏุฑ ูุซุงู ูุงุ ุนุจุงุฑุช ูุงูุจุฏุง ุจู ุดฺฉู ุฒุฑ ุงุณุช:

```csharp
n => n.Length >= 4
```

ุขุฑฺฏููุงู ูุฑูุฏ `n` ูุดุงูโุฏููุฏู ูุฑ ุนูุตุฑ ุฏุฑ ุฏูุจุงูู ุงุณุช ู ููุน ุขู **string** ุงุณุช. ุนููฺฏุฑ **Where** ูุงุฒ ุฏุงุฑุฏ ฺฉู ุนุจุงุฑุช ูุงูุจุฏุง ฺฉ ููุฏุงุฑ **bool** ุจุงุฒฺฏุฑุฏุงูุฏุ ุงฺฏุฑ **true** ุจุงุดุฏุ ุนูุตุฑ ุฏุฑ ุฏูุจุงูู ุฎุฑูุฌ ูุฑุงุฑ ูโฺฏุฑุฏ.

ุงูุถุง ุขู:

```csharp
public static IEnumerable<TSource> Where<TSource>(
    this IEnumerable<TSource> source, 
    Func<TSource,bool> predicate
)
```

ูุซุงู ุจุนุฏุ ุงุณุชุฎุฑุงุฌ ุชูุงู ูุงูโูุง ฺฉู ุดุงูู ุญุฑู "a" ูุณุชูุฏ:

```csharp
IEnumerable<string> filteredNames = names.Where(n => n.Contains("a"));
foreach (string name in filteredNames)
    Console.WriteLine(name);  // Harry
```

---

### ุชุฑฺฉุจ ูพุฑุณโูุฌููุง ู **Fluent Syntax** ๐

ุชุงฺฉููู ูพุฑุณโูุฌููุง ุฑุง ุจุง **ูุชุฏูุง ุชูุณุนูโุง** ู **ุนุจุงุฑุงุช ูุงูุจุฏุง** ุณุงุฎุชูโุงู. ุงู ุฑูุด ุจุณุงุฑ ูุงุจู ุชุฑฺฉุจ ุงุณุช ู ุงูฺฉุงู ุฒูุฌุฑูโุง ฺฉุฑุฏู ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุฑุง ูุฑุงูู ูโฺฉูุฏ. ุฏุฑ ุงู ฺฉุชุงุจ ุจู ุงู ุฑูุด **Fluent Syntax** ฺฏูุชู ูโุดูุฏ.

C# ููฺูู ฺฉ ูุญู ุฏฺฏุฑ ุจุฑุง ููุดุชู ูพุฑุณโูุฌููุง ุฏุงุฑุฏ ุจู ูุงู **Query Expression Syntax**. ูพุฑุณโูุฌู ูุจู ุจู ุดฺฉู ฺฉ **Query Expression**:

```csharp
IEnumerable<string> filteredNames = from n in names
                                    where n.Contains("a")
                                    select n;
```

**Fluent Syntax** ู **Query Syntax** ูฺฉูู ฺฉุฏฺฏุฑ ูุณุชูุฏ. ุฏุฑ ุฏู ุจุฎุด ุจุนุฏุ ูุฑ ฺฉุฏุงู ุฑุง ุจุง ุฌุฒุฆุงุช ุจุดุชุฑ ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.

### ูุญู Fluent ๐

**Fluent Syntax** ููุนุทูโุชุฑู ู ุจูุงุฏโุชุฑู ูุญู ููุดุชู ูพุฑุณโูุฌููุงุณุช. ุฏุฑ ุงู ุจุฎุดุ ุชูุถุญ ูโุฏูู ฺฺฏููู ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุฑุง ุฒูุฌุฑูโุง ฺฉูู ุชุง ูพุฑุณโูุฌููุง ูพฺุฏูโุชุฑ ุจุณุงุฒู ู ูุดุงู ูโุฏูู ฺุฑุง **extension methods** ุจุฑุง ุงู ูุฑุขูุฏ ุงููุช ุฏุงุฑูุฏ. ููฺูู ุชูุถุญ ูโุฏูู ฺฺฏููู **ุนุจุงุฑุงุช ูุงูุจุฏุง** ุฑุง ุจุฑุง ฺฉ ุนููฺฏุฑ ูพุฑุณโูุฌู ูุฑูููู ฺฉูู ู ฺูุฏ ุนููฺฏุฑ ูพุฑุณโูุฌู ุฌุฏุฏ ุฑุง ูุนุฑู ูโฺฉูู.

---

### ุฒูุฌุฑูโุณุงุฒ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ๐๏ธ

ุฏุฑ ุจุฎุด ูุจูุ ุฏู ูพุฑุณโูุฌู ุณุงุฏู ูุดุงู ุฏุงุฏู ฺฉู ูุฑฺฉุฏุงู ุชููุง ุดุงูู ฺฉ ุนููฺฏุฑ ูพุฑุณโูุฌู ุจูุฏูุฏ. ุจุฑุง ุณุงุฎุช ูพุฑุณโูุฌููุง ูพฺุฏูโุชุฑุ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุจุดุชุฑ ุฑุง ุจู ุนุจุงุฑุช ุงุถุงูู ูโฺฉูู ู ฺฉ **ุฒูุฌุฑู** ุงุฌุงุฏ ูโฺฉูู.

ูุซุงู ุฒุฑ ุชูุงู ุฑุดุชูโูุง ฺฉู ุดุงูู ุญุฑู "a" ูุณุชูุฏ ุฑุง ุงุณุชุฎุฑุงุฌ ฺฉุฑุฏูุ ุจุฑ ุงุณุงุณ ุทูู ูุฑุชุจ ูโฺฉูุฏ ู ุณูพุณ ูุชุฌู ุฑุง ุจู ุญุฑูู ุจุฒุฑฺฏ ุชุจุฏู ูโฺฉูุฏ:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;

string[] names = { "Tom", "Dick", "Harry", "Mary", "Jay" };
IEnumerable<string> query = names
    .Where(n => n.Contains("a"))
    .OrderBy(n => n.Length)
    .Select(n => n.ToUpper());

foreach (string name in query)
    Console.WriteLine(name);
```

ุฎุฑูุฌ:

```
JAY
MARY
HARRY
```

---

### ูุญุฏูุฏู ูุชุบุฑูุง ูุงูุจุฏุง ๐น

ูุชุบุฑ `n` ุฏุฑ ูุซุงู ูุง ุจูโุตูุฑุช ุฎุตูุต ุฏุฑ ูุฑ ุนุจุงุฑุช ูุงูุจุฏุง ูุญุฏูุฏูโุจูุฏ ุดุฏู ุงุณุช. ูโุชูุงูู ููู ุดูุงุณู `n` ุฑุง ุฏูุจุงุฑู ุงุณุชูุงุฏู ฺฉููุ ูุดุงุจู ุงูฺฉู ูโุชูุงูู ุดูุงุณู `c` ุฑุง ุฏุฑ ูุซุงู ุฒุฑ ุฏูุจุงุฑู ุงุณุชูุงุฏู ฺฉูู:

```csharp
void Test()
{
    foreach (char c in "string1") Console.Write(c);
    foreach (char c in "string2") Console.Write(c);
    foreach (char c in "string3") Console.Write(c);
}
```

---

### ุนููฺฉุฑุฏ ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ ูพุฑุณโูุฌู โ๏ธ

* **Where**: ูุณุฎู ููุชุฑุดุฏู ุฏูุจุงูู ูุฑูุฏ ุฑุง ุจุงุฒูโฺฏุฑุฏุงูุฏ.
* **OrderBy**: ูุณุฎู ูุฑุชุจโุดุฏู ุฏูุจุงูู ูุฑูุฏ ุฑุง ุจุงุฒูโฺฏุฑุฏุงูุฏ.
* **Select**: ุฏูุจุงููโุง ุจุงุฒูโฺฏุฑุฏุงูุฏ ฺฉู ูุฑ ุนูุตุฑ ูุฑูุฏ ุจุง ุนุจุงุฑุช ูุงูุจุฏุง ุฏุงุฏู ุดุฏู ุชุจุฏู ุง ูฺฏุงุดุช ุดุฏู ุงุณุช (ุฏุฑ ุงู ูุซุงู `n.ToUpper()`).

ุฏุงุฏูโูุง ุงุฒ ฺูพ ุจู ุฑุงุณุช ุงุฒ ุทุฑู ุฒูุฌุฑู ุนููฺฏุฑูุง ุฌุฑุงู ูโุงุจูุฏุ ุงุจุชุฏุง ููุชุฑ ูโุดููุฏุ ุณูพุณ ูุฑุชุจุ ู ุฏุฑ ููุงุช ูฺฏุงุดุช ูโุดููุฏ.

ฺฉ ุนููฺฏุฑ ูพุฑุณโูุฌู ูุฑฺฏุฒ ุฏูุจุงูู ูุฑูุฏ ุฑุง ุชุบุฑ ููโุฏูุฏุ ุจูฺฉู ฺฉ ุฏูุจุงูู ุฌุฏุฏ ุจุฑูโฺฏุฑุฏุงูุฏ. ุงู ุฑูุชุงุฑ ุจุง **ุงูฺฏู ุจุฑูุงููโููุณ ุชุงุจุน (functional programming)** ฺฉู ุงููุงูโุจุฎุด LINQ ุจูุฏูุ ููุฎูุงู ุฏุงุฑุฏ.

---

### ุงูุถุง ูุชุฏูุง ุชูุณุนูโุง โ๏ธ

ุงูุถุง ุงู ูุชุฏูุง ุชูุณุนูโุง ุจูโุตูุฑุช ุฒุฑ ุงุณุช (ุงูุถุง **OrderBy** ฺฉู ุณุงุฏู ุดุฏู):

```csharp
public static IEnumerable<TSource> Where<TSource>(
    this IEnumerable<TSource> source, 
    Func<TSource,bool> predicate
)

public static IEnumerable<TSource> OrderBy<TSource,TKey>(
    this IEnumerable<TSource> source, 
    Func<TSource,TKey> keySelector
)

public static IEnumerable<TResult> Select<TSource,TResult>(
    this IEnumerable<TSource> source, 
    Func<TSource,TResult> selector
)
```

---

ููุช ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุจูโุตูุฑุช ุฒูุฌุฑูโุง ุงุณุชูุงุฏู ูโุดููุฏุ ุฏูุจุงูู ุฎุฑูุฌ ฺฉ ุนููฺฏุฑุ ุฏูุจุงูู ูุฑูุฏ ุนููฺฏุฑ ุจุนุฏ ุงุณุช. ูพุฑุณโูุฌู ฺฉุงูู ุดุจู ฺฉ **ุฎุท ุชููุฏ ุจุง ููุงุฑ ููุงูู** ุงุณุชุ ููุงูโุทูุฑ ฺฉู ุฏุฑ ุดฺฉู ธ-ฑ ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-1.jpeg)
</div>

ูโุชูุงูู ููุงู ูพุฑุณโูุฌู ูุจู ุฑุง ุจูโุตูุฑุช ูุฑุญููโุง ุจุณุงุฒูุ ุจู ุงู ุดฺฉู:

```csharp
// ุจุฑุง ฺฉุงููพุงู ุดุฏูุ ุจุงุฏ ูุถุง ูุงู System.Linq ุฑุง ูุงุฑุฏ ฺฉูุฏ:
IEnumerable<string> filtered   = names   .Where   (n => n.Contains("a"));
IEnumerable<string> sorted     = filtered.OrderBy (n => n.Length);
IEnumerable<string> finalQuery = sorted  .Select  (n => n.ToUpper());
```

`finalQuery` ุงุฒ ูุธุฑ ุชุฑฺฉุจ **ฺฉุงููุงู ูุดุงุจู** ูพุฑุณโูุฌู ุงุณุช ฺฉู ูุจูุงู ุณุงุฎุชูโุงู.

ุนูุงูู ุจุฑ ุงูุ ูุฑ ูุฑุญูู ูุงู ูุฒ ฺฉ ูพุฑุณโูุฌู ูุนุชุจุฑ ุงุณุช ฺฉู ูโุชูุงูู ุงุฌุฑุง ฺฉูู:

```csharp
foreach (string name in filtered)
    Console.Write(name + "|");        // Harry|Mary|Jay|
Console.WriteLine();

foreach (string name in sorted)
    Console.Write(name + "|");        // Jay|Mary|Harry|
Console.WriteLine();

foreach (string name in finalQuery)
    Console.Write(name + "|");        // JAY|MARY|HARRY|
```

---

### ุงููุช **extension methods** โญ

ุจู ุฌุง ุงุณุชูุงุฏู ุงุฒ ูุญู **extension method**ุ ูโุชูุงู ุงุฒ ูุญู ูุชุฏ ุงุณุชุง (**static method syntax**) ุจุฑุง ูุฑุงุฎูุงู ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุงุณุชูุงุฏู ฺฉุฑุฏ:

```csharp
IEnumerable<string> filtered = Enumerable.Where(names, n => n.Contains("a"));
IEnumerable<string> sorted   = Enumerable.OrderBy(filtered, n => n.Length);
IEnumerable<string> finalQuery = Enumerable.Select(sorted, n => n.ToUpper());
```

ุฏุฑ ูุงูุนุ **ฺฉุงููพุงูุฑ** ููู ุชุฑุฌูู ุฑุง ุจุฑุง ูุฑุงุฎูุงู ูุชุฏูุง ุชูุณุนูโุง ุงูุฌุงู ูโุฏูุฏ.

ุงูุง ุงฺฏุฑ ุจุฎูุงูุฏ ูพุฑุณโูุฌู ุฑุง ุฏุฑ ฺฉ **ุนุจุงุฑุช ูุงุญุฏ** ุจููุณุฏุ ุงุณุชูุงุฏู ูฺฉุฑุฏู ุงุฒ **extension methods** ูุฒููโุจุฑ ุฎูุงูุฏ ุจูุฏ.

---

#### ูพุฑุณโูุฌู ฺฉโุนุจุงุฑุช ุจุง **extension method syntax**

```csharp
IEnumerable<string> query = names.Where(n => n.Contains("a"))
                                 .OrderBy(n => n.Length)
                                 .Select(n => n.ToUpper());
```

ุดฺฉู ุทุจุน ู ุฎุท ุขู ุฌุฑุงู ุฏุงุฏู ุงุฒ **ฺูพ ุจู ุฑุงุณุช** ุฑุง ูุดุงู ูโุฏูุฏ ู ููฺูู ุนุจุงุฑุงุช ูุงูุจุฏุง ุฑุง ฺฉูุงุฑ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ูฺฏู ูโุฏุงุฑุฏ (**infix notation**).

ุจุฏูู **extension methods**ุ ุฑูุงู ูพุฑุณโูุฌู ุงุฒ ุจู ูโุฑูุฏ:

```csharp
IEnumerable<string> query =
    Enumerable.Select(
        Enumerable.OrderBy(
            Enumerable.Where(
                names, n => n.Contains("a")
            ), n => n.Length
        ), n => n.ToUpper()
    );
```

---

### ุชุฑฺฉุจ ุนุจุงุฑุงุช ูุงูุจุฏุง ๐น

ุฏุฑ ูุซุงูโูุง ูุจูุ ุนุจุงุฑุช ูุงูุจุฏุง ุฒุฑ ุจู **ุนููฺฏุฑ Where** ุฏุงุฏู ุดุฏู ุจูุฏ:

```csharp
n => n.Contains("a")   // ููุน ูุฑูุฏ = stringุ ููุน ุฎุฑูุฌ = bool
```

ฺฉ ุนุจุงุฑุช ูุงูุจุฏุง ฺฉู ฺฉ ููุฏุงุฑ ูโฺฏุฑุฏ ู **bool** ุจุฑูโฺฏุฑุฏุงูุฏุ **predicate** ูุงูุฏู ูโุดูุฏ.

ูุฏู ุนุจุงุฑุช ูุงูุจุฏุง ุจู ุนููฺฏุฑ ูพุฑุณโูุฌู ุจุณุชฺฏ ุฏุงุฑุฏ:

* ุจุง **Where**ุ ูุดุงู ูโุฏูุฏ ฺฉู ุขุง ฺฉ ุนูุตุฑ ุจุงุฏ ุฏุฑ ุฏูุจุงูู ุฎุฑูุฌ ุจุงุดุฏ ุง ูู.
* ุจุง **OrderBy**ุ ุนูุตุฑ ูุฑูุฏ ุฑุง ุจู ฺฉูุฏ ูุฑุชุจโุณุงุฒ ุขู ูฺฏุงุดุช ูโฺฉูุฏ.
* ุจุง **Select**ุ ุชุนู ูโฺฉูุฏ ูุฑ ุนูุตุฑ ูุฑูุฏ ูุจู ุงุฒ ุงุฑุณุงู ุจู ุฏูุจุงูู ุฎุฑูุฌ ฺฺฏููู ุชุจุฏู ุดูุฏ.

ฺฉ ุนุจุงุฑุช ูุงูุจุฏุง ููุดู ุฑู **ุนูุงุตุฑ ูุฑุฏ** ุฏูุจุงูู ูุฑูุฏ ฺฉุงุฑ ูโฺฉูุฏุ ูู ุฑู ุฏูุจุงูู ุจูโุตูุฑุช ฺฉู.

---

### ูุญูู ุงุฑุฒุงุจ ูุงูุจุฏุง

ุนููฺฏุฑ ูพุฑุณโูุฌู ุนุจุงุฑุช ูุงูุจุฏุง ุดูุง ุฑุง **ุจูโุตูุฑุช ุชูุจู ู ุฏุฑ ุฒูุงู ูุงุฒ** ุงุฑุฒุงุจ ูโฺฉูุฏุ ูุนูููุงู ฺฉ ุจุงุฑ ุจุฑุง ูุฑ ุนูุตุฑ ุฏูุจุงูู ูุฑูุฏ.

ุนุจุงุฑุงุช ูุงูุจุฏุง ุจู ุดูุง ุงุฌุงุฒู ูโุฏููุฏ ููุทู ุฎูุฏ ุฑุง ุจู ุนููฺฏุฑูุง ูพุฑุณโูุฌู ููุชูู ฺฉูุฏุ ฺฉู ุจุงุนุซ ุงูุนุทุงูโูพุฐุฑ ุขูโูุง ูโุดูุฏุ ุฏุฑ ุญุงู ฺฉู ุณุงุฎุชุงุฑ ุฏุงุฎู ุณุงุฏู ุจุงู ูโูุงูุฏ.

ูููููโุง ุงุฒ ูพุงุฏูโุณุงุฒ ฺฉุงูู **Enumerable.Where** (ุจู ุฌุฒ ูุฏุฑุช ุงุณุชุซูุงูุง):

```csharp
public static IEnumerable<TSource> Where<TSource>(
    this IEnumerable<TSource> source, 
    Func<TSource,bool> predicate
)
{
    foreach (TSource element in source)
        if (predicate(element))
            yield return element;
}
```

---

### ุนุจุงุฑุงุช ูุงูุจุฏุง ู ุงูุถุง **Func** โ๏ธ

ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ ูพุฑุณโูุฌู ุงุฒ **generic Func delegates** ุงุณุชูุงุฏู ูโฺฉููุฏ.
**Func** ฺฉ ุฎุงููุงุฏู ุงุฒ ุฏูฺฏุชโูุง ุนููู ุฏุฑ ูุถุง ูุงู **System** ุงุณุช ฺฉู ุจุง ูุฏู ุฒุฑ ุชุนุฑู ุดุฏูโุงูุฏ:

* ุขุฑฺฏููุงูโูุง ููุน (**type arguments**) ุฏุฑ **Func** ููุงู ุชุฑุชุจ ุฑุง ุฏุงุฑูุฏ ฺฉู ุฏุฑ ุนุจุงุฑุงุช ูุงูุจุฏุง ุงุณุชูุงุฏู ูโุดููุฏ.
* ุจูุงุจุฑุงูุ **Func\<TSource,bool>** ุจุง ูุงูุจุฏุง **TSource => bool** ูุทุงุจูุช ุฏุงุฑุฏ: ฺฉ ุขุฑฺฏููุงู TSource ูโฺฏุฑุฏ ู ฺฉ ููุฏุงุฑ bool ุจุงุฒูโฺฏุฑุฏุงูุฏ.
* ุจูโุทูุฑ ูุดุงุจูุ **Func\<TSource,TResult>** ุจุง ูุงูุจุฏุง **TSource => TResult** ูุทุงุจูุช ุฏุงุฑุฏ.

ูุณุช ุฏูฺฏุชโูุง **Func** ุฏุฑ ุจุฎุด ยซLambda Expressionsยป ุฏุฑ ุตูุญู ฑธธ ุขูุฏู ุงุณุช.

---

### ุนุจุงุฑุงุช ูุงูุจุฏุง ู ููุนโุฏู ุนูุงุตุฑ

ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ ูพุฑุณโูุฌู ุงุฒ ูุงูโูุง ูพุงุฑุงูุชุฑ ููุน (**type parameter names**) ุฒุฑ ุงุณุชูุงุฏู ูโฺฉููุฏ:
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-2.jpeg)
</div>

### ููุนโุฏู ุนูุงุตุฑ ุฏุฑ ุนุจุงุฑุงุช ูุงูุจุฏุง ๐ฏ

**TSource** ุชูุณุท ุฏูุจุงูู ูุฑูุฏ ุชุนู ูโุดูุฏ. **TResult** ู **TKey** ูุนูููุงู ุงุฒ ุฑู ุนุจุงุฑุช ูุงูุจุฏุง ุดูุง ุงุณุชูุชุงุฌ ูโุดููุฏ.

ุจุฑุง ูุซุงูุ ุจู ุงูุถุง ุนููฺฏุฑ ูพุฑุณโูุฌู **Select** ุชูุฌู ฺฉูุฏ:

```csharp
public static IEnumerable<TResult> Select<TSource,TResult>(
    this IEnumerable<TSource> source, 
    Func<TSource,TResult> selector
)
```

ุนุจุงุฑุช ูุงูุจุฏุง **Func\<TSource,TResult>** ุจุง ูุงูุจุฏุง **TSource => TResult** ูุทุงุจูุช ุฏุงุฑุฏ: ุนูุตุฑ ุงุฒ ููุน ูุฑูุฏ ุฑุง ุจู ุนูุตุฑ ุงุฒ ููุน ุฎุฑูุฌ ูฺฏุงุดุช ูโฺฉูุฏ. **TSource** ู **TResult** ูโุชูุงููุฏ ููุนโูุง ูุชูุงูุช ุฏุงุดุชู ุจุงุดูุฏุ ุจูุงุจุฑุงู ูุงูุจุฏุง ูโุชูุงูุฏ ููุน ูุฑ ุนูุตุฑ ุฑุง ุชุบุฑ ุฏูุฏ. ุนูุงูู ุจุฑ ุงูุ ููุน ุฏูุจุงูู ุฎุฑูุฌ ุชูุณุท ูุงูุจุฏุง ุชุนู ูโุดูุฏ.

ูุซุงู ุฒุฑ ุงุฒ **Select** ุจุฑุง ุชุจุฏู ุนูุงุตุฑ ุฑุดุชูโุง ุจู ุนูุงุตุฑ ุนุฏุฏ ุตุญุญ ุงุณุชูุงุฏู ูโฺฉูุฏ:

```csharp
string[] names = { "Tom", "Dick", "Harry", "Mary", "Jay" };
IEnumerable<int> query = names.Select(n => n.Length);

foreach (int length in query)
    Console.Write(length + "|");   // 3|4|5|4|3|
```

ฺฉุงููพุงูุฑ ููุน **TResult** ุฑุง ุงุฒ ููุฏุงุฑ ุจุงุฒฺฏุดุช ูุงูุจุฏุง ุงุณุชูุชุงุฌ ูโฺฉูุฏ. ุฏุฑ ุงู ูุซุงูุ `n.Length` ฺฉ ููุฏุงุฑ **int** ุจุฑูโฺฏุฑุฏุงูุฏุ ุจูุงุจุฑุงู **TResult** ุจุฑุงุจุฑ ุจุง **int** ุงุณุช.

---

ุนููฺฏุฑ **Where** ุณุงุฏูโุชุฑ ุงุณุช ู ูุงุฒ ุจู ุงุณุชูุชุงุฌ ููุน ุจุฑุง ุฎุฑูุฌ ูุฏุงุฑุฏุ ุฒุฑุง ุนูุงุตุฑ ูุฑูุฏ ู ุฎุฑูุฌ ุงุฒ ฺฉ ููุน ูุณุชูุฏ. ุงู ููุทู ุงุณุช ฺูู ุงู ุนููฺฏุฑ ููุท ุนูุงุตุฑ ุฑุง ููุชุฑ ูโฺฉูุฏ ู ุขูโูุง ุฑุง ุชุจุฏู ููโฺฉูุฏ:

```csharp
public static IEnumerable<TSource> Where<TSource>(
    this IEnumerable<TSource> source, 
    Func<TSource,bool> predicate
)
```

---

### ุงูุถุง ุนููฺฏุฑ **OrderBy** ๐

```csharp
// ฺฉู ุณุงุฏู ุดุฏู
public static IEnumerable<TSource> OrderBy<TSource,TKey>(
    this IEnumerable<TSource> source, 
    Func<TSource,TKey> keySelector
)
```

ุนุจุงุฑุช ูุงูุจุฏุง **Func\<TSource,TKey>** ฺฉ ุนูุตุฑ ูุฑูุฏ ุฑุง ุจู **ฺฉูุฏ ูุฑุชุจโุณุงุฒ (sorting key)** ูฺฏุงุดุช ูโฺฉูุฏ. **TKey** ุงุฒ ุฑู ูุงูุจุฏุง ุงุณุชูุชุงุฌ ูโุดูุฏ ู ุงุฒ ููุน ุนูุตุฑ ูุฑูุฏ ู ุฎุฑูุฌ ุฌุฏุงุณุช.

ุจุฑุง ูุซุงูุ ูโุชูุงูู ูุณุช ูุงูโูุง ุฑุง ุจุฑ ุงุณุงุณ ุทูู (**ฺฉูุฏ int**) ุง ุจูโุตูุฑุช ุงููุจุง (**ฺฉูุฏ string**) ูุฑุชุจ ฺฉูู:

```csharp
string[] names = { "Tom", "Dick", "Harry", "Mary", "Jay" };
IEnumerable<string> sortedByLength, sortedAlphabetically;

sortedByLength       = names.OrderBy(n => n.Length);   // int key
sortedAlphabetically = names.OrderBy(n => n);          // string key
```

ูโุชูุงู ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุฏุฑ **Enumerable** ุฑุง ุจุง **delegateูุง ุณูุช** ฺฉู ุจู ูุชุฏูุง ุงุดุงุฑู ุฏุงุฑูุฏุ ูุฑุงุฎูุงู ฺฉุฑุฏ. ุงู ุฑูุด ุจุฑุง ุณุงุฏู ฺฉุฑุฏู ุจุฑุฎ ูพุฑุณโูุฌููุง ูุญูุ ุจูโูฺู ุฏุฑ **LINQ to XML** ููุฏ ุงุณุช ู ุฏุฑ ูุตู ฑฐ ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.

ุงูุง ุงู ุฑูุด ุฏุฑ ุฏูุจุงููโูุง ูุจุชู ุจุฑ **IQueryable<T>** (ูุซูุงู ููฺฏุงู ูพุฑุณโูุฌู ุงุฒ ูพุงฺฏุงู ุฏุงุฏู) ฺฉุงุฑ ููโฺฉูุฏุ ุฒุฑุง ุนููฺฏุฑูุง **Queryable** ูุงุฒ ุจู ุนุจุงุฑุงุช ูุงูุจุฏุง ุฏุงุฑูุฏ ุชุง ุจุชูุงููุฏ **expression tree** ุชููุฏ ฺฉููุฏ. ุงู ููุถูุน ุจุนุฏุงู ุฏุฑ ุจุฎุด ยซูพุฑุณโูุฌููุง ุชูุณุฑ ุดุฏูยป ุตูุญู ดดธ ุชูุถุญ ุฏุงุฏู ูโุดูุฏ.

---

### ุชุฑุชุจ ุทุจุน ุนูุงุตุฑ ๐

ุชุฑุชุจ ุงุตู ุนูุงุตุฑ ุฏุฑ ุฏูุจุงูู ูุฑูุฏ ุฏุฑ LINQ ุงููุช ุฏุงุฑุฏ. ุจุฑุฎ ุนููฺฏุฑูุง ุจู ุงู ุชุฑุชุจ ูุงุจุณุชูโุงูุฏุ ูุงููุฏ **Take**ุ **Skip** ู **Reverse**:

* **Take**: ุงููู x ุนูุตุฑ ุฑุง ุฎุฑูุฌ ูโุฏูุฏ ู ุจูู ุฑุง ุญุฐู ูโฺฉูุฏ:

```csharp
int[] numbers = { 10, 9, 8, 7, 6 };
IEnumerable<int> firstThree = numbers.Take(3);   // {10, 9, 8}
```

* **Skip**: x ุนูุตุฑ ุงูู ุฑุง ูุงุฏุฏู ูโฺฏุฑุฏ ู ุจูู ุฑุง ุฎุฑูุฌ ูโุฏูุฏ:

```csharp
IEnumerable<int> lastTwo = numbers.Skip(3);     // {7, 6}
```

* **Reverse**: ุนูุงุตุฑ ุฑุง ุจุฑุนฺฉุณ ูโฺฉูุฏ:

```csharp
IEnumerable<int> reversed = numbers.Reverse();  // {6, 7, 8, 9, 10}
```

ุฏุฑ ูพุฑุณโูุฌููุง ูุญู (**LINQ-to-objects**)ุ ุนููฺฏุฑูุง ูุงููุฏ **Where** ู **Select** ุชุฑุชุจ ุงุตู ุฏูุจุงูู ูุฑูุฏ ุฑุง ุญูุธ ูโฺฉููุฏ (ููฺูู ููู ุนููฺฏุฑูุง ุฏฺฏุฑุ ูฺฏุฑ ุขูโูุง ฺฉู ุตุฑุงุญุชุงู ุชุฑุชุจ ุฑุง ุชุบุฑ ูโุฏููุฏ).

---

### ุณุงุฑ ุนููฺฏุฑูุง ๐น

ููู ุนููฺฏุฑูุง ูพุฑุณโูุฌู ฺฉ ุฏูุจุงูู ุจุฑููโฺฏุฑุฏุงููุฏ.

* **ุนููฺฏุฑูุง ุนูุตุฑ (element operators)** ฺฉ ุนูุตุฑ ุงุฒ ุฏูุจุงูู ูุฑูุฏ ุงุณุชุฎุฑุงุฌ ูโฺฉููุฏุ ูุงููุฏ **First**ุ **Last** ู **ElementAt**:

```csharp
int[] numbers    = { 10, 9, 8, 7, 6 };
int firstNumber  = numbers.First();          // 10
int lastNumber   = numbers.Last();           // 6
int secondNumber = numbers.ElementAt(1);     // 9
int secondLowest = numbers.OrderBy(n => n).Skip(1).First(); // 7
```

ุงู ุนููฺฏุฑูุง ูุนูููุงู ุฎุฑูุฌ ุฎูุฏ ุฑุง ุจุฑุง ุงุฌุฑุง ุนููฺฏุฑูุง ุฏฺฏุฑ ูุฑุงุฎูุงู ููโฺฉููุ ูฺฏุฑ ุขู ุนูุตุฑ ุฎูุฏุด ฺฉ ูุฌููุนู ุจุงุดุฏ.

* **ุนููฺฏุฑูุง ุชุฌูุน (aggregation operators)** ฺฉ ููุฏุงุฑ ุงุณฺฉุงูุฑุ ูุนูููุงู ุนุฏุฏุ ุจุฑูโฺฏุฑุฏุงููุฏ:

```csharp
int count = numbers.Count();   // 5
int min   = numbers.Min();     // 6
```

* **ุนููฺฏุฑูุง ฺฉู (quantifiers)** ููุฏุงุฑ **bool** ุจุฑูโฺฏุฑุฏุงููุฏ:

```csharp
bool hasTheNumberNine     = numbers.Contains(9);          // true
bool hasMoreThanZeroElements = numbers.Any();            // true
bool hasAnOddElement      = numbers.Any(n => n % 2 != 0); // true
```

* ุจุฑุฎ ุนููฺฏุฑูุง ุฏู ุฏูุจุงูู ูุฑูุฏ ูโฺฏุฑูุฏุ ูุงููุฏ **Concat** ฺฉู ฺฉ ุฏูุจุงูู ุฑุง ุจู ุฏฺฏุฑ ุงุถุงูู ูโฺฉูุฏ ู **Union** ฺฉู ูุดุงุจู ุขู ุงุณุช ุงูุง ููุงุฏุฑ ุชฺฉุฑุงุฑ ุฑุง ุญุฐู ูโฺฉูุฏ:

```csharp
int[] seq1 = {1, 2, 3};
int[] seq2 = {3, 4, 5};
IEnumerable<int> concat = seq1.Concat(seq2);  // {1, 2, 3, 3, 4, 5}
IEnumerable<int> union  = seq1.Union(seq2);   // {1, 2, 3, 4, 5}
```

* **ุนููฺฏุฑูุง ุงุชุตุงู (joining operators)** ูุฒ ุฏุฑ ููู ุฏุณุชู ูุฑุงุฑ ูโฺฏุฑูุฏ. ูุตู น ุชูุงู ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุฑุง ุจูโุชูุตู ูพูุดุด ูโุฏูุฏ.

### ุนุจุงุฑุงุช ูพุฑุณโูุฌู (Query Expressions) ๐

C# ฺฉ **ูุงูโุจุฑ ูุญู** ุจุฑุง ููุดุชู ูพุฑุณโูุฌููุง LINQ ูุฑุงูู ูโฺฉูุฏ ฺฉู ุจู ุขู **query expressions** ฺฏูุชู ูโุดูุฏ. ุจุฑุฎูุงู ุชุตูุฑ ุฑุงุฌุ ุนุจุงุฑุช ูพุฑุณโูุฌู **ุนู SQL ุฏุงุฎู C#** ูุณุช. ุฏุฑ ูุงูุนุ ุทุฑุงุญ **query expressions** ุนูุฏุชุงู ุงุฒ **list comprehensions** ุฏุฑ ุฒุจุงูโูุง ุจุฑูุงููโููุณ ุชุงุจุน ูุงููุฏ **LISP** ู **Haskell** ุงููุงู ฺฏุฑูุชู ุดุฏู ุงุณุชุ ูุฑฺูุฏ SQL ูู ฺฉู ุชุฃุซุฑ ุธุงูุฑ ุฏุงุดุชู ุงุณุช.

ุฏุฑ ุงู ฺฉุชุงุจุ ูุญู **query expressions** ุฑุง ุจู ุณุงุฏฺฏ **query syntax** ูโูุงูู.

---

ุฏุฑ ุจุฎุด ูุจูุ ูพุฑุณโูุฌู ุจุง **Fluent Syntax** ููุดุชู ุชุง ุฑุดุชูโูุง ฺฉู ุดุงูู ุญุฑู "a" ูุณุชูุฏ ุฑุง ุงุณุชุฎุฑุงุฌ ฺฉุฑุฏูุ ุจุฑ ุงุณุงุณ ุทูู ูุฑุชุจ ฺฉูู ู ุจู ุญุฑูู ุจุฒุฑฺฏ ุชุจุฏู ฺฉูู. ููุงู ูพุฑุณโูุฌู ุจู ุดฺฉู **query syntax** ุจู ุงู ุตูุฑุช ุงุณุช:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;

string[] names = { "Tom", "Dick", "Harry", "Mary", "Jay" };

IEnumerable<string> query =
    from    n in names
    where   n.Contains("a")     // ููุชุฑ ฺฉุฑุฏู ุนูุงุตุฑ
    orderby n.Length             // ูุฑุชุจโุณุงุฒ ุนูุงุตุฑ
    select  n.ToUpper();         // ุชุจุฏู ูุฑ ุนูุตุฑ (projection)

foreach (string name in query)
    Console.WriteLine(name);
```

ุฎุฑูุฌ:

```
JAY
MARY
HARRY
```

---

### ุณุงุฎุชุงุฑ ุนุจุงุฑุงุช ูพุฑุณโูุฌู ๐๏ธ

ุนุจุงุฑุงุช ูพุฑุณโูุฌู ููุดู ุจุง **from** ุดุฑูุน ู ุจุง **select** ุง **group** ูพุงุงู ูโุงุจูุฏ.

* **from** ฺฉ **ูุชุบุฑ ุฏุงููู (range variable)** ุชุนุฑู ูโฺฉูุฏ (ุฏุฑ ุงู ูุซุงู `n`) ฺฉู ูุงููุฏ ฺฉ ุญููู `foreach`ุ ุฏูุจุงูู ูุฑูุฏ ุฑุง ูพูุงุด ูโฺฉูุฏ.

ุดฺฉู ฺฉุงูู ูุญูุ ููุงููุฏ **ูููุฏุงุฑ ุฑุงูโุขูู (railroad diagram)** ุฏุฑ ุดฺฉู ธ-ฒ ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.

ุจุฑุง ุฎูุงูุฏู ุงู ูููุฏุงุฑุ ุงุฒ ุณูุช ฺูพ ุดุฑูุน ฺฉุฑุฏู ู ูุงููุฏ ฺฉ ูุทุงุฑ ูุณุฑ ุฑุง ุฏูุจุงู ฺฉูุฏ.

* ูพุณ ุงุฒ **from** ุงุฌุจุงุฑุ ูโุชูุงู ุจูโุตูุฑุช ุงุฎุชุงุฑ ุงุฒ **orderby**ุ **where**ุ **let** ุง **join** ุงุณุชูุงุฏู ฺฉุฑุฏ.
* ุณูพุณ ูโุชูุงู ุจุง **select** ุง **group** ุงุฏุงูู ุฏุงุฏุ ุง ุฏูุจุงุฑู ฺฉ **from**ุ **orderby**ุ **where**ุ **let** ุง **join** ุงุถุงูู ฺฉุฑุฏ.

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-3.jpeg)
</div>

### ูพุฑุฏุงุฒุด ุนุจุงุฑุงุช ูพุฑุณโูุฌู ุชูุณุท ฺฉุงููพุงูุฑ โ๏ธ

ฺฉุงููพุงูุฑ ฺฉ **query expression** ุฑุง ุจุง ุชุฑุฌูู ุขู ุจู **Fluent Syntax** ูพุฑุฏุงุฒุด ูโฺฉูุฏ. ุงู ูุฑุขูุฏ ูุณุจุชุงู ูฺฉุงูฺฉ ุงุณุชโูุดุงุจู ุชุจุฏู ุญูููโูุง `foreach` ุจู ูุฑุงุฎูุงูโูุง `GetEnumerator` ู `MoveNext`.

ุงู ุนู ูุฑ ฺุฒ ฺฉู ุจุชูุงูุฏ ุฏุฑ **query syntax** ุจููุณุฏุ ูโุชูุงูุฏ ุจู ููุงู ุดฺฉู ุฏุฑ **fluent syntax** ูุฒ ุจููุณุฏ. ุจุฑุง ูุซุงูุ ูพุฑุณโูุฌู ูุจู ุชูุณุท ฺฉุงููพุงูุฑ ุจู ุงู ุดฺฉู ุชุฑุฌูู ูโุดูุฏ:

```csharp
IEnumerable<string> query = names.Where(n => n.Contains("a"))
                                 .OrderBy(n => n.Length)
                                 .Select(n => n.ToUpper());
```

ุนููฺฏุฑูุง **Where**ุ **OrderBy** ู **Select** ููุงู ููุงุนุฏ ุฑุง ุฏูุจุงู ูโฺฉููุฏ ฺฉู ุงฺฏุฑ ูพุฑุณโูุฌู ุฑุง ุจุง **fluent syntax** ููุดุชู ุจูุฏุฏุ ุงุนูุงู ูโุดุฏ. ุฏุฑ ุงู ูุซุงูุ ุขูโูุง ุจู **extension methods** ุฏุฑ ฺฉูุงุณ **Enumerable** ูุชุตู ูโุดููุฏุ ุฒุฑุง ูุถุง ูุงู **System.Linq** ูุงุฑุฏ ุดุฏู ู `names` ูพุงุฏูโุณุงุฒโฺฉููุฏู `IEnumerable<string>` ุงุณุช.

ฺฉุงููพุงูุฑ ููฺฏุงู ุชุฑุฌูู ุนุจุงุฑุงุช ูพุฑุณโูุฌูุ ุจูโุทูุฑ ุฎุงุต ฺฉูุงุณ **Enumerable** ุฑุง ุชุฑุฌุญ ููโุฏูุฏ. ูโุชูุงู ุชุตูุฑ ฺฉุฑุฏ ฺฉู ฺฉุงููพุงูุฑ ฺฉููุงุช **โWhereโ**ุ **โOrderByโ** ู **โSelectโ** ุฑุง ุจูโุตูุฑุช ูฺฉุงูฺฉ ุฏุฑ ุนุจุงุฑุช ูุงุฑุฏ ฺฉุฑุฏู ู ุขู ุฑุง ุจูโุนููุงู ูุชุฏูุง ุนุงุฏ ฺฉุงููพุงู ูโฺฉูุฏ. ุงู ุงูุนุทุงูโูพุฐุฑ ุจุงุนุซ ูโุดูุฏ ฺฉู ุนููฺฏุฑูุง ูพุฑุณโูุฌู ูพุงฺฏุงู ุฏุงุฏูุ ุฏุฑ ุจุฎุดโูุง ุจุนุฏุ ุจู **extension methods** ุฏุฑ ฺฉูุงุณ **Queryable** ูุชุตู ุดููุฏ.

ุงฺฏุฑ ุฏุณุชูุฑ `using System.Linq` ุฑุง ุญุฐู ฺฉูุฏุ ูพุฑุณโูุฌู ฺฉุงููพุงู ูุฎูุงูุฏ ุดุฏุ ุฒุฑุง ูุชุฏูุง **Where**ุ **OrderBy** ู **Select** ุจู ุฌุง ุจุฑุง ุงุชุตุงู ูุฏุงุฑูุฏ. ุจูุงุจุฑุงู ุนุจุงุฑุงุช ูพุฑุณโูุฌู **ุจุฏูู ูุงุฑุฏ ฺฉุฑุฏู System.Linq ุง ูุถุง ุจุง ูพุงุฏูโุณุงุฒ ุงู ูุชุฏูุงุ ฺฉุงููพุงู ููโุดููุฏ**.

---

### ูุชุบุฑูุง ุฏุงููู (Range Variables) ๐น

ุดูุงุณูโุง ฺฉู ุจูุงูุงุตูู ูพุณ ุงุฒ **from** ูโุขุฏุ **range variable** ูุงูุฏู ูโุดูุฏ. ฺฉ ูุชุบุฑ ุฏุงููู ุจู **ุนูุตุฑ ุฌุงุฑ ุฏุฑ ุฏูุจุงูู** ฺฉู ุนููุงุช ุฑู ุขู ุงูุฌุงู ูโุดูุฏุ ุงุดุงุฑู ุฏุงุฑุฏ.

ุฏุฑ ูุซุงูโูุง ูุงุ ูุชุบุฑ ุฏุงููู `n` ุฏุฑ ูุฑ ุจุฎุด ูพุฑุณโูุฌู ุธุงูุฑ ูโุดูุฏ. ุจุง ุงู ุญุงูุ ุงู ูุชุบุฑ ุฏุฑ ูุฑ ุจุฎุด ุฑู ุฏูุจุงููโุง ูุชูุงูุช ุดูุงุฑุด ูโุดูุฏ:

```csharp
from    n in names           // n ูุชุบุฑ ุฏุงููู ูุงุณุช
where   n.Contains("a")     // n = ูุณุชูู ุงุฒ ุขุฑุงู
orderby n.Length             // n = ูพุณ ุงุฒ ููุชุฑ ุดุฏู
select  n.ToUpper()          // n = ูพุณ ุงุฒ ูุฑุชุจโุณุงุฒ
```

ุงู ููุถูุน ุจุง ุชุฑุฌูู ูฺฉุงูฺฉ ฺฉุงููพุงูุฑ ุจู **fluent syntax** ูุงุถุญ ูโุดูุฏ:

```csharp
names.Where(n => n.Contains("a"))   // n ุจุง ุฏุงููู ูุญู
     .OrderBy(n => n.Length)         // n ุจุง ุฏุงููู ูุญู
     .Select(n => n.ToUpper())       // n ุจุง ุฏุงููู ูุญู
```

ููุงูโุทูุฑ ฺฉู ูโุจูุฏุ ูุฑ ููููู ุงุฒ `n` **ุจูโุตูุฑุช ุฎุตูุต** ุฏุฑ ูุงูุจุฏุง ุฎูุฏ ูุญุฏูุฏูโุจูุฏ ุดุฏู ุงุณุช.

---

### ูุนุฑู ูุชุบุฑูุง ุฏุงููู ุฌุฏุฏ

ุนุจุงุฑุงุช ูพุฑุณโูุฌู ุงุฌุงุฒู ูโุฏููุฏ ุชุง ูุชุบุฑูุง ุฏุงููู ุฌุฏุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ุจุฎุดโูุง ุฒุฑ ูุนุฑู ุดููุฏ:

* **let**
* **into**
* ฺฉ **from** ุงุถุงู
* **join**

ุงู ููุงุฑุฏ ุฏุฑ ุงุฏุงูู ูุตู ุฏุฑ ุจุฎุด ยซComposition Strategiesยป ุตูุญู ดดฒ ู ููฺูู ุฏุฑ ูุตู นุ ุฏุฑ ุจุฎุดโูุง ยซProjectingยป ุตูุญู ดทณ ู ยซJoiningยป ุตูุญู ดทณ ุจุฑุฑุณ ูโุดููุฏ.

---

### ููุงุณู Query Syntax ุจุง SQL Syntax โก

ุนุจุงุฑุงุช ูพุฑุณโูุฌู ุงุฒ ูุธุฑ ุธุงูุฑ ุดุจู SQL ูุณุชูุฏุ ุงูุง ุฏุฑ ูุงูุน ุจุณุงุฑ ูุชูุงูุชโุงูุฏ:

* ฺฉ ูพุฑุณโูุฌู LINQ ุฏุฑ ููุงุช **ฺฉ ุนุจุงุฑุช C#** ุงุณุช ู ููุงูู ุงุณุชุงูุฏุงุฑุฏ C# ุฑุง ุฏูุจุงู ูโฺฉูุฏ.
* ุฏุฑ LINQ ููโุชูุงูุฏ ุงุฒ ูุชุบุฑ ูุจู ุงุฒ ุชุนุฑู ุขู ุงุณุชูุงุฏู ฺฉูุฏุ ุฏุฑ ุญุงู ฺฉู ุฏุฑ SQL ูโุชูุงู ฺฉ **table alias** ุฑุง ุฏุฑ SELECT ูุจู ุงุฒ FROM ุงุณุชูุงุฏู ฺฉุฑุฏ.
* ฺฉ **Subquery** ุฏุฑ LINQ ุตุฑูุงู ฺฉ ุนุจุงุฑุช C# ุฏฺฏุฑ ุงุณุช ู ูุงุฒ ุจู ูุญู ูฺู ูุฏุงุฑุฏุ ุงูุง ุฏุฑ SQL ููุงุนุฏ ุฎุงุต ุฏุงุฑุฏ.
* ุฌุฑุงู ุฏุงุฏู ุฏุฑ LINQ ุงุฒ **ฺูพ ุจู ุฑุงุณุช** ุงุณุชุ ุฏุฑ ุญุงู ฺฉู ุฏุฑ SQL ุชุฑุชุจ ุฏุงุฏู ฺฉูุชุฑ ุณุงุฎุชุงุฑููุฏ ุงุณุช.
* ูพุฑุณโูุฌู LINQ ฺฉ **ุฎุท ุชููุฏ ุง pipeline** ุงุฒ ุนููฺฏุฑูุงุณุช ฺฉู ุชุฑุชุจ ุนูุงุตุฑ ุฏุฑ ุขู ููู ุงุณุชุ ุงูุง SQL ุนูุฏุชุงู ุจุง ูุฌููุนูโูุง ุจุฏูู ุชุฑุชุจ ฺฉุงุฑ ูโฺฉูุฏ.

---

### ููุงุณู Query Syntax ุจุง Fluent Syntax ๐

ูุฑ ุฏู ูุญู ูุฒุงุง ุฏุงุฑูุฏ:

* **Query syntax** ุจุฑุง ูพุฑุณโูุฌููุง ฺฉู ุดุงูู ููุงุฑุฏ ุฒุฑ ูุณุชูุฏ ุณุงุฏูโุชุฑ ุงุณุช:

  * **let clause** ุจุฑุง ูุนุฑู ูุชุบุฑ ุฌุฏุฏ ุฏุฑ ฺฉูุงุฑ ูุชุบุฑ ุฏุงููู
  * **SelectMany**ุ **Join** ุง **GroupJoin** ุจุง ุงุฑุฌุงุน ุจู ูุชุบุฑ ุฏุงููู ุจุฑูู

* ุจุฑุง ูพุฑุณโูุฌููุง ุณุงุฏู ุจุง **Where**ุ **OrderBy** ู **Select**ุ ูุฑ ุฏู ูุญู ุฎูุจ ฺฉุงุฑ ูโฺฉููุฏ ู ุงูุชุฎุงุจ ุจุดุชุฑ ุดุฎุต ุงุณุช.

* ุจุฑุง ูพุฑุณโูุฌููุง ฺฉู ููุท ุดุงูู ฺฉ ุนููฺฏุฑ ูุณุชูุฏุ **Fluent syntax** ฺฉูุชุงูโุชุฑ ู ูุฑุชุจโุชุฑ ุงุณุช.

* ุจุฑุฎ ุนููฺฏุฑูุง ุฏุฑ **query syntax** ฺฉูุฏูุงฺู ูุฏุงุฑูุฏ ู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุขูโูุง ุญุฏุงูู ุจุฎุด ุงุฒ Fluent syntax ูุงุฒู ุงุณุช. ุงู ุนููฺฏุฑูุง ุฎุงุฑุฌ ุงุฒ ููุงุฑุฏ ุฒุฑ ูุณุชูุฏ:

```
Where, Select, SelectMany
OrderBy, ThenBy, OrderByDescending, ThenByDescending
GroupBy, Join, GroupJoin
```

---

### ูพุฑุณโูุฌููุง ุชุฑฺฉุจ (Mixed-Syntax) โ๏ธ

ุงฺฏุฑ ฺฉ ุนููฺฏุฑ ูพุฑุณโูุฌู ุฏุฑ **query syntax** ูพุดุชุจุงู ูุดูุฏุ ูโุชูุงูุฏ **query syntax** ู **fluent syntax** ุฑุง ุชุฑฺฉุจ ฺฉูุฏ. ุชููุง ูุญุฏูุฏุช ุงู ุงุณุช ฺฉู ูุฑ ุจุฎุด query syntax ุจุงุฏ **ฺฉุงูู** ุจุงุดุฏ (ุนู ุจุง from ุดุฑูุน ู ุจุง select ุง group ูพุงุงู ุงุจุฏ).

ุจุฑุง ูุซุงูุ ุจุง ุขุฑุงู ุฒุฑ:

```csharp
string[] names = { "Tom", "Dick", "Harry", "Mary", "Jay" };
```

ูุซุงู ุชุฑฺฉุจ ุฒุฑ ุชุนุฏุงุฏ ูุงูโูุง ฺฉู ุดุงูู ุญุฑู "a" ูุณุชูุฏ ุฑุง ูโุดูุงุฑุฏ:

```csharp
int matches = (from n in names
               where n.Contains("a")
               select n).Count();   // 3
```

ููฺูู ุงููู ูุงู ุจู ุชุฑุชุจ ุงููุจุง ุฑุง ูโฺฏุฑุฏ:

```csharp
string first = (from n in names
                orderby n
                select n).First();   // Dick
```

ุฏุฑ ูพุฑุณโูุฌููุง ุณุงุฏูุ ูโุชูุงู ฺฉู ฺฉุงุฑ ุฑุง ุจุง Fluent syntax ุงูุฌุงู ุฏุงุฏ:

```csharp
int matches = names.Where(n => n.Contains("a")).Count();   // 3
string first = names.OrderBy(n => n).First();              // Dick
```

ฺฏุงู ูพุฑุณโูุฌููุง ุชุฑฺฉุจ ุจุงูุงุชุฑู **ฺฉุงุฑุง ู ุณุงุฏฺฏ** ุฑุง ุงุฑุงุฆู ูโุฏููุฏ. ุจูุงุจุฑุงู ููู ุงุณุช ฺฉู ููุดู ุจูโุทูุฑ ฺฉโุฌุงูุจู ููุท ฺฉ ูุญู ุฑุง ุชุฑุฌุญ ูุฏูุฏุ ุชุง ููฺฏุงู ูุงุฒ ุจุชูุงูุฏ ุงุฒ ูพุฑุณโูุฌู ุชุฑฺฉุจ ุจูุฑู ุจุจุฑุฏ.

---

ุฏุฑ ุงุฏุงูู ุงู ูุตูุ ููุงูู ฺฉูุฏ ุจุง ูุฑ ุฏู ูุญู **fluent** ู **query syntax** ูุดุงู ุฏุงุฏู ูโุดููุฏ.

### ุงุฌุฑุง ุจู ุชุนููโุงูุชุงุฏู (Deferred Execution) โณ

ฺฉ ุงุฒ ูฺฺฏโูุง ููู ุจุดุชุฑ **query operators** ุงู ุงุณุช ฺฉู **ุฏุฑ ุฒูุงู ุณุงุฎุช ูพุฑุณโูุฌู ุงุฌุฑุง ููโุดููุฏ**ุ ุจูฺฉู ุฒูุงู ุงุฌุฑุง ูโุดููุฏ ฺฉู ุดูุงุฑุด ุดููุฏ (ุนู ููุช `MoveNext` ุฑู enumerator ูุฑุงุฎูุงู ุดูุฏ).

ูุซุงู ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

```csharp
var numbers = new List<int> { 1 };
IEnumerable<int> query = numbers.Select(n => n * 10);   // ุณุงุฎุช ูพุฑุณโูุฌู
numbers.Add(2);                                         // ุงุถุงูู ฺฉุฑุฏู ุนูุตุฑ ุฌุฏุฏ
foreach (int n in query)
    Console.Write(n + "|");                             // 10|20|
```

ุนูุตุฑ ุงุถุงููโุดุฏู ูพุณ ุงุฒ ุณุงุฎุช ูพุฑุณโูุฌู ุฏุฑ ูุชุฌู ูุญุงุธ ูโุดูุฏุ ุฒุฑุง **ูฺ ููุชุฑ ุง ูุฑุชุจโุณุงุฒ ุชุง ุฒูุงู ุงุฌุฑุง `foreach` ุงูุฌุงู ููโุดูุฏ**. ุจู ุงู ูฺฺฏ **deferred ุง lazy execution** ฺฏูุชู ูโุดูุฏุ ูุดุงุจู ุขูฺู ุจุง **delegates** ุฑุฎ ูโุฏูุฏ:

```csharp
Action a = () => Console.WriteLine("Foo");
// ูููุฒ ฺุฒ ุจู Console ูููุดุชูโุงู. ุญุงูุง ุงุฌุฑุง ูโฺฉูู:
a();  // ุงุฌุฑุง ุจู ุชุนููโุงูุชุงุฏู!
```

ุชูุงู **standard query operators** ุงุฌุฑุง ุจู ุชุนููโุงูุชุงุฏู ุฏุงุฑูุฏุ ุจู ุฌุฒ ููุงุฑุฏ ุฒุฑ:

* ุนููฺฏุฑูุง ฺฉู **ฺฉ ุนูุตุฑ ุง ููุฏุงุฑ scalar** ุจุฑูโฺฏุฑุฏุงููุฏุ ูุซู `First` ุง `Count`
* ุนููฺฏุฑูุง ุชุจุฏู ูุงููุฏ:

  * `ToArray`, `ToList`, `ToDictionary`, `ToLookup`, `ToHashSet`

ุงู ุนููฺฏุฑูุง **ูพุฑุณโูุฌู ุฑุง ููุฑุงู ุงุฌุฑุง ูโฺฉููุฏ** ุฒุฑุง ููุน ุฎุฑูุฌ ุขูโูุง ูฺฉุงูุฒู ุจุฑุง ุงุฌุฑุง ุจู ุชุนููโุงูุชุงุฏู ูุฏุงุฑุฏ. ุจู ุนููุงู ูุซุงูุ `Count` ฺฉ **ุนุฏุฏ ุณุงุฏู** ุจุฑูโฺฏุฑุฏุงูุฏ ู ุฏฺฏุฑ ุดูุงุฑุด ููโุดูุฏ:

```csharp
int matches = numbers.Where(n => n <= 2).Count();   // ุงุฌุฑุง ููุฑุงู ุงูุฌุงู ูโุดูุฏ
```

**ุงููุช ุงุฌุฑุง ุจู ุชุนููโุงูุชุงุฏู** ุฏุฑ ุงู ุงุณุช ฺฉู **ุณุงุฎุช ูพุฑุณโูุฌู ุฑุง ุงุฒ ุงุฌุฑุง ุขู ุฌุฏุง ูโฺฉูุฏ**. ุงู ุงูฺฉุงู ุฑุง ูโุฏูุฏ ฺฉู ูพุฑุณโูุฌู ุฑุง ุฏุฑ ฺูุฏ ูุฑุญูู ุจุณุงุฒุฏ ู ููฺูู ูพุฑุณโูุฌููุง ูพุงฺฏุงู ุฏุงุฏู ุฑุง ููฺฉู ูโุณุงุฒุฏ.

---

### ุงุฑุฒุงุจ ูุฌุฏุฏ (Reevaluation) ๐

**Subqueries** ุณุทุญ ุฏฺฏุฑ ุงุฒ **indirection** ุงุฌุงุฏ ูโฺฉููุฏ. ุชูุงู ูุญุชูุงุช ฺฉ subquery ูุฒ ุงุฒ deferred execution ูพุฑู ูโฺฉููุฏุ ุงุฒ ุฌููู **aggregation** ู **conversion methods**.

ุงุฌุฑุง ุจู ุชุนููโุงูุชุงุฏู ฺฉ ูพุงูุฏ ุฏฺฏุฑ ูู ุฏุงุฑุฏ: **ูุฑ ุจุงุฑ ฺฉู ูพุฑุณโูุฌู ุฏูุจุงุฑู ุดูุงุฑุด ุดูุฏุ ุฏูุจุงุฑู ุงุฑุฒุงุจ ูโุดูุฏ**:

```csharp
var numbers = new List<int>() { 1, 2 };
IEnumerable<int> query = numbers.Select(n => n * 10);

foreach (int n in query) Console.Write(n + "|");  // 10|20|
numbers.Clear();
foreach (int n in query) Console.Write(n + "|");  // <ฺุฒ ููุงุด ุฏุงุฏู ููโุดูุฏ>
```

ฺฏุงู ุงุฑุฒุงุจ ูุฌุฏุฏ ููฺฉู ุงุณุช **ูุฒุงุญูุชโุขูุฑู** ุจุงุดุฏ:

* ููุช ูโุฎูุงูุฏ ูุชุงุฌ ุฑุง ุฏุฑ ฺฉ ููุทู ุฒูุงู ูุดุฎุต **ุฐุฎุฑู ุง freeze** ฺฉูุฏ
* ููุช ูพุฑุณโูุฌู ูุญุงุณุจุงุช ุณูฺฏู ุฏุงุฑุฏ ุง ุจู ูพุงฺฏุงู ุฏุงุฏู ุฎุงุฑุฌ ูุงุจุณุชู ุงุณุชุ ุชฺฉุฑุงุฑ ุบุฑุถุฑูุฑ ุขู ููุทู ูุณุช

ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงุฑุฒุงุจ ูุฌุฏุฏุ ูโุชูุงูุฏ ุงุฒ **conversion operators** ูุงููุฏ `ToArray` ุง `ToList` ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
var numbers = new List<int>() { 1, 2 };
List<int> timesTen = numbers
    .Select(n => n * 10)
    .ToList();                // ููุฑุงู ุงุฌุฑุง ู ุฏุฑ List<int> ุฐุฎุฑู ุดุฏ
numbers.Clear();
Console.WriteLine(timesTen.Count);  // ูููุฒ 2
```

---

### ูุชุบุฑูุง ฺฏุฑูุชูโุดุฏู (Captured Variables) โ๏ธ

ุงฺฏุฑ **lambda expressions** ูพุฑุณโูุฌู ูุชุบุฑูุง ุจุฑูู ุฑุง ฺฏุฑูุชู ุจุงุดูุฏุ **ููุฏุงุฑ ุขูโูุง ููฺฏุงู ุงุฌุฑุง ูพุฑุณโูุฌู ูุญุงุธ ูโุดูุฏ**:

```csharp
int[] numbers = { 1, 2 };
int factor = 10;
IEnumerable<int> query = numbers.Select(n => n * factor);
factor = 20;

foreach (int n in query) Console.Write(n + "|");  // 20|40|
```

ุงู ูโุชูุงูุฏ **ฺฉ ุชูู ุฏุฑ ุญูููโูุง** ุงุฌุงุฏ ฺฉูุฏ. ูุซุงู ุญุฐู ุญุฑูู ุตุฏุงุฏุงุฑ ุงุฒ ฺฉ ุฑุดุชู:

```csharp
IEnumerable<char> query = "Not what you might expect";
query = query.Where(c => c != 'a');
query = query.Where(c => c != 'e');
query = query.Where(c => c != 'i');
query = query.Where(c => c != 'o');
query = query.Where(c => c != 'u');

foreach (char c in query) Console.Write(c);  // Nt wht y mght xpct
```

ุงฺฏุฑ ุจุฎูุงูู ุงุฒ **for loop** ุงุณุชูุงุฏู ฺฉูู:

```csharp
IEnumerable<char> query = "Not what you might expect";
string vowels = "aeiou";
for (int i = 0; i < vowels.Length; i++)
    query = query.Where(c => c != vowels[i]);

foreach (char c in query) Console.Write(c);
```

ฺฉ **IndexOutOfRangeException** ุฑุฎ ูโุฏูุฏุ ุฒุฑุง ูุชุบุฑ ุญููู `i` ุฏุฑ closure ฺฏุฑูุชู ุดุฏู ู ููฺฏุงู ุดูุงุฑุด ููุฏุงุฑ ุขู ุจุฑุงุจุฑ ต ุงุณุช.

ุฑุงู ุญูโูุง:

1. **ุชุนุฑู ูุชุบุฑ ูุญู ุฏุงุฎู ุจููฺฉ**:

```csharp
for (int i = 0; i < vowels.Length; i++)
{
    char vowel = vowels[i];
    query = query.Where(c => c != vowel);
}
```

2. ุง ุงุณุชูุงุฏู ุงุฒ **foreach**:

```csharp
foreach (char vowel in vowels)
    query = query.Where(c => c != vowel);
```

---

### ูุญูู ฺฉุงุฑ Deferred Execution ๐ง

ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุงุฌุฑุง ุจู ุชุนููโุงูุชุงุฏู ุฑุง ุจุง **ุจุงุฒฺฏุฑุฏุงูุฏู decorator sequences** ูุฑุงูู ูโฺฉููุฏ.

ุจุฑุฎูุงู ฺฉูุงุณโูุง ุณูุช ูุงููุฏ ุขุฑุงู ุง ูุณุช ูพููุฏุ ฺฉ **decorator sequence** ูุนูููุงู ุณุงุฎุชุงุฑ ุฏุงุฎู ุจุฑุง ุฐุฎุฑู ุนูุงุตุฑ ูุฏุงุฑุฏ. ุฏุฑ ุนูุถุ ฺฉ **sequence ุฏฺฏุฑ** ฺฉู ููฺฏุงู ุงุฌุฑุง ุชุฃูู ูโฺฉูุฏ ุฑุง ูพูุดุด ูโุฏูุฏ ู ูุงุจุณุชฺฏ ุฏุงุฆู ุจู ุขู ุฏุงุฑุฏ. ูุฑ ุจุงุฑ ฺฉู ุฏุงุฏู ุงุฒ decorator ุฏุฑุฎูุงุณุช ุดูุฏุ ุจุงุฏ ุฏุงุฏู ุฑุง ุงุฒ ุฏูุจุงูู ูุฑูุฏ ุฏุฑุงูุช ฺฉูุฏ.

**ุชุจุฏู ุง ุชุบุฑ ุนููฺฏุฑ ูพุฑุณโูุฌู ููุงู โdecorationโ ุงุณุช.** ุงฺฏุฑ ุฏูุจุงูู ุฎุฑูุฌ ูฺ ุชุจุฏู ุงูุฌุงู ูุฏูุฏุ ฺฉ **proxy** ุงุณุช ูู decorator.

ูุฑุงุฎูุงู `Where` ุตุฑูุงู **ุฏูุจุงูู wrapper** ุฑุง ูโุณุงุฒุฏ ฺฉู ุดุงูู ุงุฑุฌุงุน ุจู **input sequence**ุ **lambda expression** ู ุณุงุฑ ุขุฑฺฏููุงูโูุง ุงุณุช. ุฏูุจุงูู ูุฑูุฏ **ููุท ุฒูุงู ุดูุงุฑุด ูโุดูุฏ ฺฉู decorator ุดูุงุฑุด ุดูุฏ**.

ูุซุงู:

```csharp
IEnumerable<int> lessThanTen = new int[] { 5, 12, 3 }.Where(n => n < 10);
```

ุงู ุณุงุฎุชุงุฑ ููุงููุฏ ุดฺฉู ธ-ณ ุชุฑฺฉุจ ูโุดูุฏ.
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-4.jpeg)
</div>

ููฺฏุงู ฺฉู `lessThanTen` ุฑุง ุดูุงุฑุด ูโฺฉูุฏุ ุฏุฑ ูุงูุน **ุขุฑุงู ุฑุง ุงุฒ ุทุฑู decorator `Where` ูพุฑุณโูุฌู ูโฺฉูุฏ**. โ

ุฎุจุฑ ุฎูุจ ุงู ุงุณุช ฺฉู ุงฺฏุฑ ุจุฎูุงูุฏ **ฺฉ query operator ุดุฎุต ุจุณุงุฒุฏ**ุ ูพุงุฏูโุณุงุฒ ฺฉ **decorator sequence** ุจุง **C# iterator** ุจุณุงุฑ ุณุงุฏู ุงุณุช. ูุซุงู ุณุงุฎุช ูุชุฏ `Select` ุฎูุฏุชุงู:

```csharp
public static IEnumerable<TResult> MySelect<TSource,TResult>
    (this IEnumerable<TSource> source, Func<TSource,TResult> selector)
{
    foreach (TSource element in source)
        yield return selector(element);
}
```

ุงู ูุชุฏ ุจู ุฏูู ุงุณุชูุงุฏู ุงุฒ **`yield return`** ฺฉ **iterator** ุงุณุช. ุงุฒ ูุธุฑ ุนููฺฉุฑุฏุ ูุนุงุฏู ฺฉูุชุงูโุดุฏูโ ฺฉุฏ ุฒุฑ ุงุณุช:

```csharp
public static IEnumerable<TResult> MySelect<TSource,TResult>
    (this IEnumerable<TSource> source, Func<TSource,TResult> selector)
{
    return new SelectSequence(source, selector);
}
```

ฺฉู ุฏุฑ ุขู `SelectSequence` ฺฉ **ฺฉูุงุณ ููุดุชูโุดุฏู ุชูุณุท ฺฉุงููพุงูุฑ** ุงุณุช ฺฉู **enumerator ุขู ููุทู ููุฌูุฏ ุฏุฑ iterator ุฑุง encapsulate ูโฺฉูุฏ**.

ุจูุงุจุฑุงูุ ููุช ุนููุงุช ูุงููุฏ `Select` ุง `Where` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ุฏุฑ ูุงูุน **ุชููุง ฺฉ ฺฉูุงุณ enumerable ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู ุฏูุจุงูู ูุฑูุฏ ุฑุง decorate ูโฺฉูุฏ**. ๐

---

### ุฒูุฌุฑูโุณุงุฒ Decorators ๐

ุฒูุฌุฑูโุณุงุฒ **query operators** ุจุงุนุซ **ูุงูโูุงู ุดุฏู decorators** ูโุดูุฏ. ูุซุงู:

```csharp
IEnumerable<int> query = new int[] { 5, 12, 3 }
    .Where(n => n < 10)
    .OrderBy(n => n)
    .Select(n => n * 10);
```

ูุฑ **query operator** ฺฉ decorator ุฌุฏุฏ ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู **ุฏูุจุงูู ูุจู ุฑุง ูโูพูุดุงูุฏ** (ูุงููุฏ **ุนุฑูุณฺฉโูุง ุฑูุณ ุชู ุฏุฑ ุชู**). ๐ช

ุดฺฉู ธ-ด **ูุฏู ุดุก (object model)** ุงู ูพุฑุณโูุฌู ุฑุง ูุดุงู ูโุฏูุฏ. ุชูุฌู ฺฉูุฏ ฺฉู **ุงู ูุฏู ุดุก ฺฉุงููุงู ูุจู ุงุฒ ูุฑ ุดูุงุฑุด ุณุงุฎุชู ูโุดูุฏ** ู ูฺ ุฏุงุฏูโุง ูููุฒ ูพุฑุฏุงุฒุด ูุดุฏู ุงุณุช.
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-5.jpeg)
</div>

ููุช `query` ุฑุง ุดูุงุฑุด ูโฺฉูุฏุ ุฏุฑ ูุงูุน **ุขุฑุงู ุงุตู ุฑุง ุงุฒ ุทุฑู ฺฉ ุฒูุฌุฑู ุง ูุงูโุจูุฏ ุงุฒ decorators ูพุฑุณโูุฌู ูโฺฉูุฏ**. ๐

ุงุถุงูู ฺฉุฑุฏู `ToList` ุฏุฑ ุงูุชูุง ุงู ูพุฑุณโูุฌู ุจุงุนุซ ูโุดูุฏ ฺฉู **ุนููฺฏุฑูุง ูุจู ููุฑุงู ุงุฌุฑุง ุดููุฏ** ู ฺฉู **ูุฏู ุดุก (object model)** ุจู ฺฉ **ูุณุช ูุงุญุฏ** ุชุจุฏู ุดูุฏ. ๐

ุดฺฉู ธ-ต ููุงู ุชุฑฺฉุจ ุดุก ุฑุง ุฏุฑ **UML (Unified Modeling Language)** ูุดุงู ูโุฏูุฏ:

* decorator `Select` ุจู decorator `OrderBy` ุงุฑุฌุงุน ูโุฏูุฏุ
* decorator `OrderBy` ุจู decorator `Where` ุงุฑุฌุงุน ูโุฏูุฏุ
* ู decorator `Where` ุจู ุขุฑุงู ุงุตู ุงุฑุฌุงุน ูโุฏูุฏ.

ูฺฺฏ ุงุฌุฑุง ุจู ุชุนููโุงูุชุงุฏู ุงู ุงุณุช ฺฉู ุงฺฏุฑ **ูพุฑุณโูุฌู ุฑุง ุจู ุตูุฑุช ูุฑุญููโุง ุจุณุงุฒุฏ**ุ **ููุงู ูุฏู ุดุก ุณุงุฎุชู ูโุดูุฏ**:

```csharp
IEnumerable<int>
    source    = new int[] { 5, 12, 3 },
    filtered  = source   .Where(n => n < 10),
    sorted    = filtered .OrderBy(n => n),
    query     = sorted   .Select(n => n * 10);
```

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-6.jpeg)
</div>

### ูุญูู ุงุฌุฑุง ูพุฑุณโูุฌููุง โ๏ธ

ูุชุงุฌ ุดูุงุฑุด ูพุฑุณโูุฌู ูุจู ุจู ุงู ุตูุฑุช ุงุณุช:

```csharp
foreach (int n in query) Console.WriteLine(n);
```

ุฎุฑูุฌ:

```
30
50
```

---

ุฏุฑ ูพุดุช ุตุญููุ `foreach` ูุชุฏ **`GetEnumerator`** ุฑุง ุฑู decorator `Select` (ุขุฎุฑู ุง ุจุฑููโุชุฑู ุนููฺฏุฑ) ูุฑุงุฎูุงู ูโฺฉูุฏ ู ุงู **ุชูุงู ุนููุงุช ุฑุง ุขุบุงุฒ ูโฺฉูุฏ**. ๐

ูุชุฌูุ ฺฉ **ุฒูุฌุฑู ุงุฒ enumeratorโูุง** ุงุณุช ฺฉู **ุจู ุทูุฑ ุณุงุฎุชุงุฑ ุดุจู ุฒูุฌุฑู decorator sequences** ุงุณุช.

ุดฺฉู ธ-ถ **ุฌุฑุงู ุงุฌุฑุง ูพุฑุณโูุฌู ุฏุฑ ุญู ุดูุงุฑุด** ุฑุง ูุดุงู ูโุฏูุฏ.
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-7.jpeg)
</div>

ุฏุฑ ุจุฎุด ุงูู ุงู ูุตูุ ฺฉ ูพุฑุณโูุฌู ุฑุง ุจูโุนููุงู ฺฉ **ุฎุท ุชููุฏ ุจุง ููุงุฑ ููุงูู** ูุดุงู ุฏุงุฏู. ุจุง ฺฏุณุชุฑุด ุงู ูุงุณุ ูโุชูุงู ฺฏูุช ฺฉู ฺฉ ูพุฑุณโูุฌู LINQ ฺฉ **ุฎุท ุชููุฏ ุชูุจู (lazy)** ุงุณุชุ ุฌุง ฺฉู **ููุงุฑูุง ููุงูู ุชููุง ููฺฏุงู ูุงุฒ ุนูุงุตุฑ ุฑุง ุญุฑฺฉุช ูโุฏููุฏ**. ๐ญ

ุณุงุฎุชู ฺฉ ูพุฑุณโูุฌูุ **ุณุงุฎุชู ุฎุท ุชููุฏ ุจุง ููู ุงุฌุฒุง** ุงุณุชโุงูุง ูฺ ฺุฒ ูููุฒ ุญุฑฺฉุช ููโฺฉูุฏ. ุณูพุณุ ููุช **ูุตุฑูโฺฉููุฏู ฺฉ ุนูุตุฑ ุฏุฑุฎูุงุณุช ูโฺฉูุฏ** (ุนู ูพุฑุณโูุฌู ุฑุง ุดูุงุฑุด ูโฺฉูุฏ)ุ **ููุงุฑ ููุงูู ุณูุช ุฑุงุณุช ูุนุงู ูโุดูุฏ**ุ ุงู ุจู ููุจู ุฎูุฏ ุฏฺฏุฑ ููุงุฑูุง ุฑุง ุชุญุฑฺฉ ูโฺฉูุฏ ุชุง ุญุฑฺฉุช ฺฉููุฏโูุฑฺฏุงู ฺฉู ุนูุงุตุฑ ุฏูุจุงูู ูุฑูุฏ ูุงุฒ ุจุงุดูุฏ. LINQ ุงุฒ ูุฏู **pull ูุจุชู ุจุฑ ุชูุงุถุง** ูพุฑู ูโฺฉูุฏุ ูู ูุฏู push ูุจุชู ุจุฑ ุนุฑุถู. ุงู ูฺฺฏ ุงููุช ุฏุงุฑุฏโููุงูโุทูุฑ ฺฉู ุจุนุฏุงู ุฎูุงูุฏ ุฏุฏโฺุฑุง ฺฉู ุจู LINQ ุงุฌุงุฒู ูโุฏูุฏ **ุจุฑุง ูพุฑุณโูุฌููุง SQL ููุงุณโูพุฐุฑ ุจุงุดุฏ**. โก

---

### Subqueries (ุฒุฑูพุฑุณโูุฌููุง) ๐

ฺฉ **ุฒุฑูพุฑุณโูุฌู**ุ ูพุฑุณโูุฌู ุงุณุช ฺฉู ุฏุฑ **lambda expression** ฺฉ ูพุฑุณโูุฌู ุฏฺฏุฑ ูุฑุงุฑ ุฏุงุฑุฏ. ูุซุงู ุฒุฑุ ุงุฒ ฺฉ ุฒุฑูพุฑุณโูุฌู ุจุฑุง ูุฑุชุจ ฺฉุฑุฏู ููุณูโุฏุงูโูุง ุจุฑ ุงุณุงุณ **ูุงู ุฎุงููุงุฏฺฏ** ุงุณุชูุงุฏู ูโฺฉูุฏ:

```csharp
string[] musos = { "David Gilmour", "Roger Waters", "Rick Wright", "Nick Mason" };
IEnumerable<string> query = musos.OrderBy(m => m.Split().Last());
```

* `m.Split` ูุฑ ุฑุดุชู ุฑุง ุจู ฺฉ ูุฌููุนู ุงุฒ ฺฉููุงุช ุชุจุฏู ูโฺฉูุฏุ ุณูพุณ **ุนููฺฏุฑ `Last`** ุฑู ุขู ูุฑุงุฎูุงู ูโุดูุฏ.
* `m.Split().Last` ููุงู **ุฒุฑูพุฑุณโูุฌู** ุงุณุชุ ู `query` ูพุฑุณโูุฌู ุจุฑูู ุฑุง ูุดุงู ูโุฏูุฏ.

---

ุฒุฑูพุฑุณโูุฌููุง ูุฌุงุฒ ูุณุชูุฏ ุฒุฑุง **ูโุชูุงู ูุฑ ุนุจุงุฑุช ูุนุชุจุฑ C# ุฑุง ุฏุฑ ุณูุช ุฑุงุณุช lambda ูุฑุงุฑ ุฏุงุฏ**. ุฒุฑูพุฑุณโูุฌู ุตุฑูุงู ฺฉ **ุนุจุงุฑุช C# ุฏฺฏุฑ** ุงุณุช ู ููุงูู ุขู **ุชุจุนุช ุงุฒ ููุงูู lambda expressions** ู ุฑูุชุงุฑ ฺฉู query operators ุฏุงุฑุฏ.

ุฏุฑ ุงู ฺฉุชุงุจุ ููุช ุงุฒ ุงุตุทูุงุญ **subquery** ุงุณุชูุงุฏู ูโฺฉููุ ููุธูุฑ **ูพุฑุณโูุฌู ุงุณุช ฺฉู ุฏุฑ lambda expression ฺฉ ูพุฑุณโูุฌู ุฏฺฏุฑ ุงุฑุฌุงุน ุดุฏู**. ุฏุฑ **query expressions**ุ ฺฉ ุฒุฑูพุฑุณโูุฌู ูุนุงุฏู ูพุฑุณโูุฌู ุงุณุช ฺฉู ุงุฒ ฺฉ ุนุจุงุฑุช ุฏุฑ ูุฑ clause ุจู ุฌุฒ **from** ุงุฑุฌุงุน ุดุฏู ุจุงุดุฏ.

ุฒุฑูพุฑุณโูุฌู ุจู **ุทูุฑ ุฎุตูุต ุฏุฑ ูุญุฏูุฏู ุนุจุงุฑุช ุงุญุงุทูโฺฉููุฏู** ุงุณุช ู ูโุชูุงูุฏ ุจู **ูพุงุฑุงูุชุฑูุง lambda ุจุฑูู** ุง **range variables ุฏุฑ query expression** ุงุฑุฌุงุน ุฏูุฏ.

ูุซุงู ุณุงุฏู:

```csharp
string[] names = { "Tom", "Dick", "Harry", "Mary", "Jay" };
IEnumerable<string> outerQuery = names
    .Where(n => n.Length == names.OrderBy(n2 => n2.Length)
                                .Select(n2 => n2.Length).First());
// Tom, Jay
```

ููุงู ูุซุงู ุจู ุตูุฑุช query expression:

```csharp
IEnumerable<string> outerQuery =
    from n in names
    where n.Length ==
        (from n2 in names orderby n2.Length select n2.Length).First()
    select n;
```

* **ุชูุฌู:** ฺูู **range variable ุจุฑูู (n)** ุฏุฑ ูุญุฏูุฏู ุฒุฑูพุฑุณโูุฌู ุฏุฑ ุฏุณุชุฑุณ ุงุณุชุ ููโุชูุงู ุงุฒ ููุงู ูุงู `n` ุจุฑุง ุฒุฑูพุฑุณโูุฌู ุงุณุชูุงุฏู ฺฉุฑุฏ.

---

**ุฒูุงู ุงุฌุฑุง ุฒุฑูพุฑุณโูุฌู:**
ฺฉ ุฒุฑูพุฑุณโูุฌู **ูุฑฺฏุงู lambda ุงุญุงุทูโฺฉููุฏู ุงุฑุฒุงุจ ุดูุฏุ ุงุฌุฑุง ูโุดูุฏ**. ุจู ุนุจุงุฑุช ุฏฺฏุฑุ **ุงุฌุฑุง ุงุฒ ุจุฑูู ุจู ุฏุงุฎู** ุงูุฌุงู ูโุดูุฏ.

* ุจุฑุง **ูพุฑุณโูุฌููุง ูุญู (local queries)**ุ ุงู ูุฏู ุฏููุงู ุฑุนุงุช ูโุดูุฏ.
* ุจุฑุง **ูพุฑุณโูุฌููุง ุชูุณุฑุดุฏู (interpreted queries)**ุ ูุงููุฏ ูพุฑุณโูุฌููุง ูพุงฺฏุงู ุฏุงุฏูุ ุงู ูุฏู **ุจู ุตูุฑุช ููููู** ุฑุนุงุช ูโุดูุฏ.

---

ุฒุฑูพุฑุณโูุฌู **ูุฑ ุฒูุงู ฺฉู ูุงุฒ ุจุงุดุฏ ุงุฌุฑุง ูโุดูุฏ ุชุง ูพุฑุณโูุฌู ุจุฑูู ุฑุง ุชุบุฐู ฺฉูุฏ**. ููุงูโุทูุฑ ฺฉู ุฏุฑ ุดฺฉูโูุง ธ-ท ู ธ-ธ ูุดุงู ุฏุงุฏู ุดุฏูุ **ุฒุฑูพุฑุณโูุฌู (ููุงุฑ ููุงูู ุจุงูุง)** ุจุฑุง ูุฑ ุชฺฉุฑุงุฑ ุญููู ุจุฑูู ฺฉ ุจุงุฑ ุงุฌุฑุง ูโุดูุฏ.
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-8.jpeg)
</div>

ูโุชูุงูู **ุฒุฑูพุฑุณโูุฌู ูุจู** ุฑุง ุจู ุดฺฉู ูุฎุชุตุฑุชุฑ ุงูโฺฏููู ุจุงู ฺฉูู:

```csharp
IEnumerable<string> query =
    from n in names
    where n.Length == names.OrderBy(n2 => n2.Length).First().Length
    select n;
```

ุจุง ุงุณุชูุงุฏู ุงุฒ **ุชุงุจุน ุชุฌูุน `Min`** ูโุชูุงู ูพุฑุณโูุฌู ุฑุง ุญุช ุณุงุฏูโุชุฑ ฺฉุฑุฏ:

```csharp
IEnumerable<string> query =
    from n in names
    where n.Length == names.Min(n2 => n2.Length)
    select n;
```

---

ุฏุฑ ุจุฎุด **โInterpreted Queriesโ** ุฏุฑ ุตูุญู 448ุ ุชูุถุญ ุฏุงุฏูโุงู ฺฉู ฺฺฏููู ูโุชูุงู ุงุฒ ููุงุจุน ุฑุงูโุฏูุฑ ูุงููุฏ ุฌุฏุงูู SQL ูพุฑุณโูุฌู ฺฏุฑูุช. ูุซุงู ุจุงูุง ุจุฑุง **ูพุฑุณโูุฌู ูพุงฺฏุงู ุฏุงุฏู** ุงุฏูโุขู ุงุณุชุ ุฒุฑุง ุจู ุตูุฑุช ฺฉ ูุงุญุฏ ูพุฑุฏุงุฒุด ูโุดูุฏ ู ููุท ฺฉ ุจุงุฑ ูุงุฒ ุจู ุงุฑุณุงู ุจู ุณุฑูุฑ ูพุงฺฏุงู ุฏุงุฏู ุฏุงุฑุฏ. ๐ฅ๏ธ

ุจุง ุงู ุญุงูุ ุจุฑุง ฺฉ ูุฌููุนู ูุญูุ ุงู ูพุฑุณโูุฌู **ุจููู ูุณุช**ุ ฺูู ุฒุฑูพุฑุณโูุฌู **ุฏุฑ ูุฑ ุชฺฉุฑุงุฑ ุญููู ุจุฑูู ุฏูุจุงุฑู ูุญุงุณุจู ูโุดูุฏ**.

ุจุฑุง ุงุฌุชูุงุจ ุงุฒ ุงู ูุงฺฉุงุฑุขูุฏุ ูโุชูุงูู ุฒุฑูพุฑุณโูุฌู ุฑุง **ุจู ุตูุฑุช ุฌุฏุงฺฏุงูู ุงุฌุฑุง ฺฉูู** ุชุง ุฏฺฏุฑ ุฒุฑูพุฑุณโูุฌู ูุจุงุดุฏ:

```csharp
int shortest = names.Min(n => n.Length);
IEnumerable<string> query =
    from n in names
    where n.Length == shortest
    select n;
```

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-9.jpeg)
</div>

ุชูฺฉฺฉ ุฒุฑูพุฑุณโูุฌููุง ุจู ุงู ุตูุฑุช ุชูุฑุจุงู ููุดู ุฏุฑ **ูพุฑุณโูุฌููุง ุฑู ูุฌููุนูโูุง ูุญู** ุชูุตู ูโุดูุฏุ ุฒุฑุง ฺฉุงุฑุง ู ูุถูุญ ฺฉุฏ ุฑุง ุงูุฒุงุด ูโุฏูุฏ. ุชููุง ุงุณุชุซูุงุก ุฒูุงู ุงุณุช ฺฉู ุฒุฑูพุฑุณโูุฌู **ูุฑุชุจุท (correlated)** ุจุงุดุฏุ ุนู ุจู ูุชุบุฑูุง ูุญุฏูุฏูโ ูพุฑุณโูุฌู ุจุฑูู ุงุดุงุฑู ฺฉูุฏ. ุฒุฑูพุฑุณโูุฌููุง ูุฑุชุจุท ุฏุฑ ุจุฎุด ยซProjectingยป ุฏุฑ ุตูุญู 473 ุชูุถุญ ุฏุงุฏู ุดุฏูโุงูุฏ.
**ุฒุฑูพุฑุณโูุฌููุง ู ุงุฌุฑุง ุชูุจู (Deferred Execution)**
ฺฉ ุนููฺฏุฑ ุนูุตุฑ ุง ุชุฌูุน ูุงููุฏ `First` ุง `Count` ุฏุฑ ฺฉ ุฒุฑูพุฑุณโูุฌูุ ุจุงุนุซ ุงุฌุฑุง ููุฑ ูพุฑุณโูุฌู ุจุฑูู ููโุดูุฏโุงุฌุฑุง ุชูุจู ูููุฒ ุจุฑุง ูพุฑุณโูุฌู ุจุฑูู ุจุฑูุฑุงุฑ ุงุณุช. ุฏูู ุงู ุงุณุช ฺฉู ุฒุฑูพุฑุณโูุฌููุง ุจูโุตูุฑุช ุบุฑูุณุชูู ูุฑุงุฎูุงู ูโุดููุฏโุฏุฑ ููุฑุฏ ูพุฑุณโูุฌููุง ูุญูุ ุงุฒ ุทุฑู ฺฉ **delegate** ู ุฏุฑ ููุฑุฏ ูพุฑุณโูุฌููุง ุชูุณุฑุดุฏูุ ุงุฒ ุทุฑู ฺฉ **expression tree**.

ฺฉ ุญุงูุช ุฌุงูุจ ุฒูุงู ูพุด ูโุขุฏ ฺฉู ุฒุฑูพุฑุณโูุฌู ุฑุง ุฏุฑ ฺฉ ุนุจุงุฑุช `Select` ูุฑุงุฑ ุฏูุฏ. ุฏุฑ ูพุฑุณโูุฌููุง ูุญูุ ุดูุง ุฏุฑ ูุงูุน **ฺฉ ุฏูุจุงูู ุงุฒ ูพุฑุณโูุฌููุง ุฑุง ูพุฑูุฌฺฉุช ูโฺฉูุฏ**โูุฑ ฺฉุฏุงู ุฎูุฏ ุชุญุช ุงุฌุฑุง ุชูุจู ูุณุชูุฏ. ุงู ฺฉุงุฑ ูุนูููุงู ุดูุงู ุงุณุช ู **ุจู ุจูุจูุฏ ฺฉุงุฑุง ฺฉูฺฉ ูโฺฉูุฏ**. ูุซุงูโูุง ุฏููโุชุฑ ุจุฑุง ุฒุฑูพุฑุณโูุฌููุง `Select` ุฏุฑ ูุตู 9 ุจุฑุฑุณ ุดุฏูโุงูุฏ.

---

### **ุงุณุชุฑุงุชฺโูุง ุชุฑฺฉุจ ูพุฑุณโูุฌููุง**

ุณู ุงุณุชุฑุงุชฺ ุงุตู ุจุฑุง ุณุงุฎุช ูพุฑุณโูุฌููุง ูพฺุฏูโุชุฑ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ููู ุขููุง **ุฒูุฌุฑูโุง ุงุฒ ุนููฺฏุฑูุง** ุงุฌุงุฏ ูโฺฉููุฏ ู ุฏุฑ ุฒูุงู ุงุฌุฑุง ูุชุฌูโุง ฺฉุณุงู ุฏุงุฑูุฏ:

1. **ุณุงุฎุช ุชุฏุฑุฌ ูพุฑุณโูุฌู (Progressive query construction)**
2. **ุงุณุชูุงุฏู ุงุฒ ฺฉููู ฺฉูุฏ `into`**
3. **ูพฺุงูุฏู ูพุฑุณโูุฌููุง (Wrapping queries)**

---

### **ุณุงุฎุช ุชุฏุฑุฌ ูพุฑุณโูุฌู (Progressive Query Building)**

ุฏุฑ ุงุจุชุฏุง ูุตูุ ูุญูู ุณุงุฎุช ุชุฏุฑุฌ ฺฉ ูพุฑุณโูุฌู ุจุง **syntax ููููุช** ุฑุง ูุดุงูุฏู ฺฉุฑุฏู:

```csharp
var filtered = names.Where(n => n.Contains("a"));
var sorted   = filtered.OrderBy(n => n);
var query    = sorted.Select(n => n.ToUpper());
```

ูุฑ ุนููฺฏุฑ ูพุฑุณโูุฌู ฺฉ **decorator sequence** ุจุงุฒูโฺฏุฑุฏุงูุฏ ู ุฏุฑ ูุชุฌู ูพุฑุณโูุฌู ููุงู **ุฒูุฌุฑูโ ูุงูโูุงูโุง ุงุฒ ุฏฺฉูุฑุชูุฑูุง** ุฑุง ุฏุงุฑุฏ ฺฉู ุฏุฑ ฺฉ ูพุฑุณโูุฌู ุชฺฉโุนุจุงุฑุช ุงุฌุงุฏ ูโุดูุฏ.

**ูุฒุงุง ุณุงุฎุช ุชุฏุฑุฌ ูพุฑุณโูุฌู:**

* ููุดุชู ูพุฑุณโูุฌููุง ุขุณุงูโุชุฑ ูโุดูุฏ.
* ุงูฺฉุงู ุงูุฒูุฏู ุนููฺฏุฑูุง ุจูโุตูุฑุช ุดุฑุท ูุฌูุฏ ุฏุงุฑุฏ. ูุซุงู:

```csharp
if (includeFilter) 
    query = query.Where(...);
```

ุงู ุฑูุด **ุจูููโุชุฑ ุงุฒ ููุดุชู ุดุฑุท ุฏุงุฎู ูพุฑุณโูุฌู** ุงุณุช:

```csharp
query = query.Where(n => !includeFilter || <expression>);
```

ุฒุฑุง ุงฺฏุฑ `includeFilter` ุจุฑุงุจุฑ `false` ุจุงุดุฏุ ฺฉ ุนููฺฏุฑ ุงุถุงูู ุงุถุงูู ููโุดูุฏ.

---

### **ูุซุงู ุนูู: ุญุฐู ุญุฑูู ุตุฏุงุฏุงุฑ ู ูุฑุชุจโุณุงุฒ**

ูโุฎูุงูู ุงุฒ ฺฉ ูุณุช ุงุณุงู ุชูุงู **ุญุฑูู ุตุฏุงุฏุงุฑ** ุฑุง ุญุฐู ฺฉูู ู ุณูพุณ ุงุณุงู ุจุง ุทูู ุจุด ุงุฒ ุฏู ุญุฑู ุฑุง ุจู ุชุฑุชุจ ุงููุจุง ูุฑุชุจ ฺฉูู. ุจุง syntax ููููุช:

```csharp
IEnumerable<string> query = names
    .Select(n => n.Replace("a","").Replace("e","").Replace("i","")
                  .Replace("o","").Replace("u",""))
    .Where(n => n.Length > 2)
    .OrderBy(n => n);

// ุฎุฑูุฌ:
// Dck
// Hrry
// Mry
```

ุจู ุฌุง ูพูุฌ ุจุงุฑ ูุฑุงุฎูุงู `Replace` ูโุชูุงู ุงุฒ **Regular Expression** ูู ุงุณุชูุงุฏู ฺฉุฑุฏ:

```csharp
n => Regex.Replace(n, "[aeiou]", "")
```

ูุฒุช `Replace` ุงู ุงุณุช ฺฉู ุฏุฑ **ูพุฑุณโูุฌููุง ูพุงฺฏุงู ุฏุงุฏู** ูุฒ ฺฉุงุฑ ูโฺฉูุฏ.

---

### **ฺุงูุด ุฏุฑ ุชุฑุฌูู ูุณุชูู ุจู Query Syntax**

ุฏุฑ **query syntax**ุ `select` ุจุงุฏ ุจุนุฏ ุงุฒ `where` ู `orderby` ุจุงุฏุ ู ุงฺฏุฑ ุชุฑุชุจ ุฑุง ุชุบุฑ ุฏููุ ูุชุฌู ูุชูุงูุช ุฎูุงูุฏ ุจูุฏ:

```csharp
IEnumerable<string> query =
    from n in names
    where n.Length > 2
    orderby n
    select n.Replace("a","").Replace("e","").Replace("i","")
             .Replace("o","").Replace("u","");

// ุฎุฑูุฌ:
// Dck
// Hrry
// Jy
// Mry
// Tm
```

---

### **ุฑุงู ุญู: ูพุฑุณโูุฌู ุชุฏุฑุฌ ุฏุฑ Query Syntax**

```csharp
IEnumerable<string> query =
    from n in names
    select n.Replace("a","").Replace("e","").Replace("i","")
            .Replace("o","").Replace("u","");

query = from n in query
        where n.Length > 2
        orderby n
        select n;

// ุฎุฑูุฌ:
// Dck
// Hrry
// Mry
```

ุจุง ุงู ุฑูุดุ ูุชุฌู ููุงููุฏ ูพุฑุณโูุฌู ููููุช ุจุงู ูโูุงูุฏ ู **ุฎูุงูุง ู ุงูุนุทุงู ุจุดุชุฑ** ุฏุงุฑุฏ.

### **ฺฉููู ฺฉูุฏ `into` ุฏุฑ LINQ**

ฺฉููู ฺฉูุฏ `into` ุฏุฑ **query expressions** ุจุณุชู ุจู ุฒูููุ ุฏู ูุนูุง ุฏุงุฑุฏ. ูุนูุง ฺฉู ุฏุฑ ุงูุฌุง ุจุฑุฑุณ ูโฺฉูู ุจุฑุง **ุงุฏุงูู ุฏุงุฏู ูพุฑุณโูุฌู ุจุนุฏ ุงุฒ ฺฉ projection** ุงุณุช (ูุนูุง ุฏฺฏุฑ ุจุฑุง `GroupJoin` ุงุณุช).

ุจุง `into` ูโุชูุงู ูพุฑุณโูุฌู ุฑุง **ูพุณ ุงุฒ ฺฉ select ุงุฏุงูู ุฏุงุฏ** ู ุงู ุฏุฑ ูุงูุน ฺฉ **ูุงูุจุฑ ุจุฑุง ูพุฑุณโูุฌู ุชุฏุฑุฌ** ุงุณุช. ุจุฑุง ูุซุงูุ ูพุฑุณโูุฌู ูุจู ุฑุง ูโุชูุงู ุจู ุดฺฉู ุฒุฑ ููุดุช:

```csharp
IEnumerable<string> query =
    from n in names
    select n.Replace("a","").Replace("e","").Replace("i","")
            .Replace("o","").Replace("u","")
    into noVowel
    where noVowel.Length > 2
    orderby noVowel
    select noVowel;
```

* **ูุญุฏูุฏู ุงุณุชูุงุฏู**: ุชููุง ุจุนุฏ ุงุฒ ฺฉ `select` ุง `group` ูโุชูุงู ุงุฒ `into` ุงุณุชูุงุฏู ฺฉุฑุฏ.
* `into` ูพุฑุณโูุฌู ุฑุง ยซุฑุณุชุงุฑุชยป ูโฺฉูุฏ ู ุงุฌุงุฒู ูโุฏูุฏ ฺฉู **clauses ุฌุฏุฏ** ูุซู `where`ุ `orderby` ู `select` ุงุถุงูู ุดููุฏ.
* ุงุฒ ุฏุฏ **fluent syntax**ุ ุชูุงู ูพุฑุณโูุฌู ฺฉ ูพุฑุณโูุฌู ูุงุญุฏ ุงุณุช ู ุงุณุชูุงุฏู ุงุฒ `into` **ูฺ ูุฒูู ุนููฺฉุฑุฏ ุงุถุงู** ูุฏุงุฑุฏ.

**ูุนุงุฏู ุฏุฑ Fluent Syntax**: ุฏุฑ ูุงูุน ฺฉ **ุฒูุฌุฑู ุทููุงูโุชุฑ ุงุฒ ุนููฺฏุฑูุง** ุงุณุช.

---

### **ููุงูู ูุญุฏูุฏู (Scoping Rules)**

ุชูุงู **range variables** ูพุณ ุงุฒ `into` ุงุฒ ูุญุฏูุฏู ุฎุงุฑุฌ ูโุดููุฏ. ูุซุงู ูุงุฏุฑุณุช:

```csharp
var query =
    from n1 in names
    select n1.ToUpper()
    into n2          // ููุท n2 ูุงุจู ุฏุณุชุฑุณ ุงุณุช
    where n1.Contains("x")  // ุฎุทุง: n1 ุงุฒ ูุญุฏูุฏู ุฎุงุฑุฌ ุดุฏู
    select n2;
```

**ุชูุถุญ:** ุฏุฑ fluent syntax ูุนุงุฏู:

```csharp
var query = names
    .Select(n1 => n1.ToUpper())
    .Where(n2 => n1.Contains("x")); // ุฎุทุง: n1 ุฏฺฏุฑ ุฏุฑ ุฏุณุชุฑุณ ูุณุช
```

---

### **ูพฺุงูุฏู ูพุฑุณโูุฌููุง (Wrapping Queries)**

ฺฉ ูพุฑุณโูุฌู ุชุฏุฑุฌ ูโุชูุงูุฏ ุจู ุดฺฉู **ฺฉ statement ูุงุญุฏ** ุจุง **ูพฺุงูุฏู ฺฉ ูพุฑุณโูุฌู ุฏุฑ ูพุฑุณโูุฌู ุฏฺฏุฑ** ููุดุชู ุดูุฏ:

```csharp
var tempQuery = tempQueryExpr;
var finalQuery = from ... in tempQuery ...
```

ูุนุงุฏู **ูุฑู ุจุฏูู ูุชุบุฑ ูุงุณุท**:

```csharp
var finalQuery = from ... in (tempQueryExpr)
                 ...
```

**ูุซุงู ุนูู:**

ูพุฑุณโูุฌู ุชุฏุฑุฌ:

```csharp
IEnumerable<string> query =
    from n in names
    select n.Replace("a","").Replace("e","").Replace("i","")
            .Replace("o","").Replace("u","");

query = from n in query
        where n.Length > 2
        orderby n
        select n;
```

ููุงู ูพุฑุณโูุฌู ุจู ุตูุฑุช **wrapped**:

```csharp
IEnumerable<string> query =
    from n1 in
    (
        from n2 in names
        select n2.Replace("a","").Replace("e","").Replace("i","")
                 .Replace("o","").Replace("u","")
    )
    where n1.Length > 2
    orderby n1
    select n1;
```

ุฏุฑ **fluent syntax**ุ ูุชุฌู ููุงู ุฒูุฌุฑู ุฎุท ุนููฺฏุฑูุง ุงุณุช:

```csharp
IEnumerable<string> query = names
    .Select(n => n.Replace("a","").Replace("e","").Replace("i","")
                   .Replace("o","").Replace("u",""))
    .Where(n => n.Length > 2)
    .OrderBy(n => n);
```

> ฺฉุงููพุงูุฑ **ุขุฎุฑู `Select` ุฑุง ุญุฐู ูโฺฉูุฏ** ฺูู ุงุถุงูู ู ุชฺฉุฑุงุฑ ุงุณุช.

---

### **ุชูุงูุช Wrapping ุจุง Subquery**

* **Wrapping**: ูพุฑุณโูุฌู ุฏุงุฎู ููุงู ูพุฑุณโูุฌู ูุจู ุงุณุช ู ููุท ุจู **ุชุฑุชุจ ุนููฺฏุฑูุง** ุฒูุฌุฑูโุง ุงุถุงูู ูโุดูุฏ.
* **Subquery**: ูพุฑุณโูุฌู ุฏุงุฎู **ุฏุฑ Lambda ูพุฑุณโูุฌู ุจุฑูู** ูุฑุงุฑ ุฏุงุฑุฏ ู **ุจุฑ ุงุณุงุณ ุชูุงุถุง** ุงุฌุฑุง ูโุดูุฏ.

๐น ูุซุงู ูุงุณ:

* Wrapping โ ูพุฑุณโูุฌู ุฏุงุฎู = **ููุงุฑ ููุงูู ูุจู**
* Subquery โ ูพุฑุณโูุฌู ุฏุงุฎู = **ุฑู ููุงุฑ ููุงูู ุณูุงุฑ ุงุณุช ู ููฺฏุงู ูุงุฒ ูุนุงู ูโุดูุฏ**

### **Projection Strategies ุฏุฑ LINQ**

ุฏุฑ ุงู ุจุฎุด ุจู **ุฑูุดโูุง ูพุดุฑูุชูโ projection** ุฏุฑ LINQ ูโูพุฑุฏุงุฒูุ ุนู ุชุจุฏู ุนูุงุตุฑ ูุฌููุนู ุจู ุดฺฉู ุฏูุฎูุงู ูุจู ุงุฒ ุจุงุฒฺฏุฑุฏุงูุฏู ุขูโูุง.

---

## **Object Initializers**

ุชุง ฺฉููู ุฏุฑ `select`ุ ููุท ุนูุงุตุฑ ุงุณฺฉุงูุฑ (ูุงููุฏ `int` ุง `string`) ุฑุง projection ฺฉุฑุฏูโุงู. ุจุง **object initializers** ูโุชูุงูู projection ุฑุง ุจู **ุงููุงุน ูพฺุฏูโุชุฑ** ุงูุฌุงู ุฏูู.

ูุซุงู: ูโุฎูุงูู ูุงูโูุง ุฑุง ุจุฏูู ุญุฑูู ุตุฏุงุฏุงุฑ ุฏุงุดุชู ุจุงุดูุ ูู ูุงู ุงุตู ูู ุญูุธ ุดูุฏ:

```csharp
class TempProjectionItem
{
    public string Original;   // ูุงู ุงุตู
    public string Vowelless;  // ูุงู ุจุฏูู ุญุฑูู ุตุฏุงุฏุงุฑ
}
```

ุณูพุณ ุฏุฑ ูพุฑุณโูุฌู ูโุชูุงูู projection ฺฉูู:

```csharp
string[] names = { "Tom", "Dick", "Harry", "Mary", "Jay" };

IEnumerable<TempProjectionItem> temp =
    from n in names
    select new TempProjectionItem
    {
        Original = n,
        Vowelless = n.Replace("a","").Replace("e","").Replace("i","")
                     .Replace("o","").Replace("u","")
    };
```

ูุชุฌู ููุน `IEnumerable<TempProjectionItem>` ุฎูุงูุฏ ุจูุฏ ู ูโุชูุงูู ูพุฑุณโูุฌู ุจุนุฏ ุฑู ุขู ุงูุฌุงู ุฏูู:

```csharp
IEnumerable<string> query =
    from item in temp
    where item.Vowelless.Length > 2
    select item.Original;

// ูุชุฌู:
// Dick
// Harry
// Mary
```

---

## **Anonymous Types**

ุจุฑุง ุญุฐู ูุงุฒ ุจู ููุดุชู ฺฉูุงุณ ูููุชุ ูโุชูุงู ุงุฒ **anonymous types** ุงุณุชูุงุฏู ฺฉุฑุฏ:

```csharp
var intermediate =
    from n in names
    select new
    {
        Original = n,
        Vowelless = n.Replace("a","").Replace("e","").Replace("i","")
                     .Replace("o","").Replace("u","")
    };

IEnumerable<string> query =
    from item in intermediate
    where item.Vowelless.Length > 2
    select item.Original;
```

* ูุชุฌู ููุงููุฏ ููููู ูุจู ุงุณุช.
* ููุน `intermediate` ุชูุณุท ฺฉุงููพุงูุฑ ุณุงุฎุชู ูโุดูุฏ ู ูุงู ูุดุฎุต ูุฏุงุฑุฏุ ุจูุงุจุฑุงู ุชููุง ุจุง `var` ูโุชูุงู ุขู ุฑุง ูฺฏู ุฏุงุดุช.

ูโุชูุงู ฺฉู ูพุฑุณโูุฌู ุฑุง ุจุง `into` ุจู ุตูุฑุช ฺฉูุชุงูโุชุฑ ููุดุช:

```csharp
var query =
    from n in names
    select new
    {
        Original = n,
        Vowelless = n.Replace("a","").Replace("e","").Replace("i","")
                     .Replace("o","").Replace("u","")
    }
    into temp
    where temp.Vowelless.Length > 2
    select temp.Original;
```

---

## **ฺฉููู ฺฉูุฏ `let`**

`let` ฺฉ **ูุชุบุฑ ุฌุฏุฏ** ุฏุฑ ฺฉูุงุฑ range variable ุงุฌุงุฏ ูโฺฉูุฏ ู ุจุงุนุซ ุณุงุฏูโุชุฑ ุดุฏู ูพุฑุณโูุฌู ูโุดูุฏ.

ูุซุงู ุงุณุชุฎุฑุงุฌ ูุงูโูุง ฺฉู ุทูู ุขูโูุง ุจุฏูู ุญุฑูู ุตุฏุงุฏุงุฑ ุจุดุชุฑ ุงุฒ ฒ ุงุณุช:

```csharp
string[] names = { "Tom", "Dick", "Harry", "Mary", "Jay" };

IEnumerable<string> query =
    from n in names
    let vowelless = n.Replace("a","").Replace("e","").Replace("i","")
                     .Replace("o","").Replace("u","")
    where vowelless.Length > 2
    orderby vowelless
    select n; // n ูููุฒ ุฏุฑ ุฏุณุชุฑุณ ุงุณุช
```

**ูฺฺฏโูุง let:**

1. projection ุนูุงุตุฑ ุฌุฏุฏ ููุฑุงู ุจุง ุนูุงุตุฑ ููุฌูุฏ.
2. ุงูฺฉุงู ุงุณุชูุงุฏู ูุฌุฏุฏ ุงุฒ ฺฉ ุนุจุงุฑุช ุจุฏูู ูุงุฒ ุจู ููุดุชู ุฏูุจุงุฑู ุขู.

* let ูโุชูุงูุฏ ูุจู ุง ุจุนุฏ ุงุฒ `where` ูุฑุงุฑ ฺฏุฑุฏ.
* let ูโุชูุงูุฏ ุจู subsequence ูู ุงุดุงุฑู ฺฉูุฏุ ูู ููุท ุงุณฺฉุงูุฑ.

> ุฏุฑ ูุงูุนุ let ุชูุณุท ฺฉุงููพุงูุฑ ุจู **anonymous type** ุชุจุฏู ูโุดูุฏ ฺฉู ุดุงูู ูุชุบุฑ range ุงุตู ู ูุชุบุฑ let ุงุณุช.

### **Interpreted Queries ุฏุฑ LINQ**

LINQ ุฏู ูุนูุงุฑ ููุงุฒ ุฏุงุฑุฏ:

1. **Local Queries**: ุจุฑุง ูุฌููุนูโูุง ูุญู (`IEnumerable<T>`).
2. **Interpreted Queries**: ุจุฑุง ููุงุจุน ุฏุงุฏูโ ุฑุงู ุฏูุฑ ูุงููุฏ ูพุงฺฏุงู ุฏุงุฏู (`IQueryable<T>`).

---

## **Local vs Interpreted Queries**

* **Local Queries**:

  * ุฑู ูุฌููุนูโูุง ูุญู ุงุฌุฑุง ูโุดููุฏ (`IEnumerable<T>`).
  * ุงุฒ ูุชุฏูุง ฺฉูุงุณ `Enumerable` ุงุณุชูุงุฏู ูโฺฉููุฏ.
  * delegateูุง ฺฉุงููุงู ูุญู ูุณุชูุฏ ู ูุซู ูุฑ ูุชุฏ C# ุฏฺฏุฑ ุงุฌุฑุง ูโุดููุฏ.
  * ูุชุงุฌ ุจู ุตูุฑุช ุฒูุฌุฑูโุง ุงุฒ decorator sequences ุชููุฏ ูโุดููุฏ.

* **Interpreted Queries**:

  * ุฑู ููุงุจุน ุฑุงู ุฏูุฑ ุงุฌุฑุง ูโุดููุฏ (`IQueryable<T>`).
  * ุงุฒ ูุชุฏูุง ฺฉูุงุณ `Queryable` ุงุณุชูุงุฏู ูโฺฉููุฏ.
  * **expression tree** ุชููุฏ ูโฺฉููุฏ ฺฉู ุฏุฑ ุฒูุงู ุงุฌุฑุง ุชูุณุฑ ุดุฏู ู ูโุชูุงูุฏ ุจู SQL ุง ุฒุจุงู ุฏฺฏุฑ ุชุฑุฌูู ุดูุฏ.

> ุชูุฌู: ุงุณุชูุงุฏู ุงุฒ ูุชุฏูุง `Enumerable` ุฑู `IQueryable<T>` ุจุงุนุซ ุงุฌุฑุง ูุญู ุชูุงู ุฏุงุฏูโูุง ูโุดูุฏุ ุจูุงุจุฑุงู ุจุฑุง ูพุฑุณโูุฌููุง ุฑุงู ุฏูุฑุ ุจุงุฏ ุงุฒ `Queryable` ุงุณุชูุงุฏู ฺฉุฑุฏ.

---

## **ุงุฌุงุฏ ฺฉ Interpreted Query ุจุง EF Core**

ูุซุงู: ุฌุฏูู `Customer` ุฏุฑ SQL Server:

```sql
CREATE TABLE Customer
(
    ID int NOT NULL PRIMARY KEY,
    Name varchar(30)
);

INSERT Customer VALUES (1, 'Tom');
INSERT Customer VALUES (2, 'Dick');
INSERT Customer VALUES (3, 'Harry');
INSERT Customer VALUES (4, 'Mary');
INSERT Customer VALUES (5, 'Jay');
```

ูพุฑุณโูุฌู LINQ:

```csharp
using System;
using System.Linq;
using Microsoft.EntityFrameworkCore;

using var dbContext = new NutshellContext();

IQueryable<string> query = 
    from c in dbContext.Customers
    where c.Name.Contains("a")
    orderby c.Name.Length
    select c.Name.ToUpper();

foreach (string name in query)
    Console.WriteLine(name);
```

* ฺฉูุงุณ `Customer`:

```csharp
public class Customer
{
    public int ID { get; set; }
    public string Name { get; set; }
}
```

* ฺฉูุงุณ `DbContext`:

```csharp
public class NutshellContext : DbContext
{
    public virtual DbSet<Customer> Customers { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder builder)
        => builder.UseSqlServer("...connection string...");

    protected override void OnModelCreating(ModelBuilder modelBuilder)
        => modelBuilder.Entity<Customer>()
                       .ToTable("Customer")
                       .HasKey(c => c.ID);
}
```

EF Core ุงู ูพุฑุณโูุฌู ุฑุง ุจู SQL ุฒุฑ ุชุฑุฌูู ูโฺฉูุฏ:

```sql
SELECT UPPER([c].[Name])
FROM [Customers] AS [c]
WHERE CHARINDEX(N'a', [c].[Name]) > 0
ORDER BY CAST(LEN([c].[Name]) AS int)
```

ูุชุฌู:

```
JAY
MARY
HARRY
```

---

## **ูุญูู ฺฉุงุฑ Interpreted Queries**

1. **ุชุจุฏู syntax ูพุฑุณโูุฌู**:
   query syntax ุจู fluent syntax ุชุจุฏู ูโุดูุฏ:

```csharp
IQueryable<string> query = dbContext.Customers
                                    .Where(n => n.Name.Contains("a"))
                                    .OrderBy(n => n.Name.Length)
                                    .Select(n => n.Name.ToUpper());
```

2. **ุงูุชุฎุงุจ ูุชุฏ ููุงุณุจ**:

   * `dbContext.Customers` ููุน `DbSet<T>` ุฏุงุฑุฏ ฺฉู `IQueryable<T>` ุงุณุช.
   * ุจูุงุจุฑุงูุ ูุชุฏูุง ฺฉูุงุณ `Queryable` ุงูุชุฎุงุจ ูโุดููุฏุ ูู `Enumerable`.

3. **ุงุฌุงุฏ Expression Tree**:

   * `Queryable.Where` ฺฉ predicate ุงุฒ ููุน `Expression<Func<TSource,bool>>` ูโฺฏุฑุฏ.
   * ูุงูุจุฏุง (`n => n.Name.Contains("a")`) ุจู **expression tree** ุชุจุฏู ูโุดูุฏ.
   * ุงู ุฏุฑ ุฒูุงู ุงุฌุฑุง ุชูุณุท EF Core ุจู SQL ุชุจุฏู ูโุดูุฏ.

4. **ุชฺฉุฑุงุฑ ุจุฑุง ุณุงุฑ ุงูพุฑุงุชูุฑูุง**:

   * `OrderBy` ู `Select` ูุฒ expression tree ุชููุฏ ูโฺฉููุฏ.
   * ุฏุฑ ููุงุช ฺฉ ุณุงุฎุชุงุฑ ุฏุงุฏู (expression tree) ุฏุงุฑู ฺฉู ุชูุตู ฺฉุงูู ูพุฑุณโูุฌู ุฑุง ุฏุฑ ุฎูุฏ ูฺฏู ูโุฏุงุฑุฏ ู ูโุชูุงูุฏ ุฏุฑ runtime ุงุฌุฑุง ุง ุจู SQL ุชุฑุฌูู ุดูุฏ.

> ุงู ุฑูุด ุจุงุนุซ ูโุดูุฏ LINQ ุจุชูุงูุฏ ูู ุฑู ุฏุงุฏูโูุง ูุญู ู ูู ุฑู ูพุงฺฏุงู ุฏุงุฏูโูุง ุจู ุดฺฉู ฺฉุณุงู ฺฉุงุฑ ฺฉูุฏ.

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-10.jpeg)
</div>

### **Execution of Interpreted Queries in LINQ**

Interpreted queries (`IQueryable<T>`) ูู ูุงููุฏ local queries (`IEnumerable<T>`) ุงุฒ ูุฏู **deferred execution** ูพุฑู ูโฺฉููุฏ.

---

## **ูฺฺฏโูุง ฺฉูุฏ ุงุฌุฑุง Interpreted Queries**

1. **ุชููุฏ SQL ุฏุฑ ุฒูุงู ุงุฌุฑุง Enumeration**

   * SQL statement ุชุง ุฒูุงู ฺฉู query ุฑุง enumerate ูฺฉูุฏุ ุณุงุฎุชู ููโุดูุฏ.
   * enumerate ฺฉุฑุฏู ููุงู query ุฏูุจุงุฑู ุจุงุนุซ ุงุฌุฑุง ุฏูุจุงุฑู SQL ุฑู ูพุงฺฏุงู ุฏุงุฏู ูโุดูุฏ.

2. **ูพุฑุฏุงุฒุด Expression Tree**

   * ููฺฏุงู ฺฉู ฺฉ interpreted query ุฑุง enumerate ูโฺฉูุฏุ outermost sequence ุจุฑูุงููโุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ฺฉู **ุชูุงู expression tree** ุฑุง ุจู ุนููุงู ฺฉ ูุงุญุฏ ูพุฑุฏุงุฒุด ูโฺฉูุฏ.
   * EF Core ุงู expression tree ุฑุง ุจู ฺฉ SQL statement ุชุฑุฌูู ูโฺฉูุฏ ู ูุชุงุฌ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ.
   * ุฏุฑ analogy ุฎุท ุชููุฏ: ุชููุง **ฺฉ ููุงุฑ ููุงูู** ุดุฑูุน ุจู ฺฉุงุฑ ูโฺฉูุฏ ู ุณุงุฑ ููุงุฑูุง ููุท "shell" ูุณุชูุฏ ฺฉู ุฏุณุชูุฑุงูุนููโูุง ุฑุง ุชูุตู ูโฺฉููุฏ.

3. **ูุญุฏูุฏุช ุฏุฑ ุงูุฒูุฏู ูุชุฏูุง ุณูุงุฑุด**

   * ุงุฌุงุฏ extension method ุจุฑุง `IQueryable<T>` ุฏุดูุงุฑ ุงุณุช ู ูโุชูุงูุฏ ุจุงุนุซ ุนุฏู ุณุงุฒฺฏุงุฑ ุจุง ุณุงุฑ providers ุดูุฏ.
   * ูุฒุช ฺฉูุงุณ `Queryable` ุงู ุงุณุช ฺฉู ูุฌููุนู ุงุณุชุงูุฏุงุฑุฏ ุงุฒ ูุชุฏูุง ุจุฑุง ููู remote collections ูุฑุงูู ูโฺฉูุฏ.

4. **ูุญุฏูุฏุชโูุง Provider**

   * ุจุฑุฎ LINQ queries ููฺฉู ุงุณุช ุชูุณุท ฺฉ provider ุฎุงุต (ูุซู EF Core) ุชุฑุฌูู ูุดููุฏ.
   * ุนูุช: ูุญุฏูุฏุชโูุง ูพุงฺฏุงู ุฏุงุฏู.
   * ุฏุฑ ุงู ุญุงูุชุ ููฺฉู ุงุณุช runtime exception ุฏุฑุงูุช ฺฉูุฏ.

---

## **ุชุฑฺฉุจ Interpreted ู Local Queries**

* ุงูฺฏู: **operators ูุญู ุฏุฑ ุจุฑูู ู interpreted operators ุฏุฑ ุฏุงุฎู**
* ูุซุงู: extension method ุณูุงุฑุด ุจุฑุง ุฌูุชโุณุงุฒ ุนูุงุตุฑ (`Pair`)

```csharp
public static IEnumerable<string> Pair(this IEnumerable<string> source)
{
    string firstHalf = null;
    foreach (string element in source)
    {
        if (firstHalf == null)
            firstHalf = element;
        else
        {
            yield return firstHalf + ", " + element;
            firstHalf = null;
        }
    }
}
```

ุชุฑฺฉุจ ุจุง EF Core:

```csharp
using var dbContext = new NutshellContext();

IEnumerable<string> q = dbContext.Customers
    .Select(c => c.Name.ToUpper())  // Interpreted (IQueryable)
    .OrderBy(n => n)                // Interpreted
    .Pair()                          // Local (IEnumerable)
    .Select((n, i) => "Pair " + i + " = " + n);

foreach (string element in q)
    Console.WriteLine(element);

// Output:
// Pair 0 = DICK, HARRY
// Pair 1 = JAY, MARY
```

> ููุช ฺฉ operator ููุท ุจุฑุง `IEnumerable<T>` ุชุนุฑู ุดุฏู ุจุงุดุฏุ query ุจู local query ุชุจุฏู ูโุดูุฏ ู ุงุฏุงูู ูพุฑุฏุงุฒุด ุฑู client ุงูุฌุงู ูโุดูุฏ.

---

## **AsEnumerable**

* ุณุงุฏูโุชุฑู query operator ุจุฑุง ุชุจุฏู `IQueryable<T>` ุจู `IEnumerable<T>`:

```csharp
public static IEnumerable<TSource> AsEnumerable<TSource>(this IEnumerable<TSource> source)
{
    return source;
}
```

* ฺฉุงุฑุจุฑุฏ:

  * ุจุนุฏ ุงุฒ `AsEnumerable()`ุ ุชูุงู query operators ุจุนุฏ ุฑู **Enumerable class** ุงุฌุฑุง ูโุดููุฏ.
  * ุจุฑุฎูุงู `ToList` ุง `ToArray`ุ ุงุฌุฑุง query ุฑุง **ููุฑ ููโฺฉูุฏ** ู ูฺ ุญุงูุธู ุงุถุงู ุงุฌุงุฏ ููโฺฉูุฏ.

ูุซุงู ุจุง Regular Expression:

```csharp
Regex wordCounter = new Regex(@"\b(\w|[-'])+\b");

using var dbContext = new NutshellContext();

var query = dbContext.MedicalArticles
    .Where(article => article.Topic == "influenza")
    .AsEnumerable()  // Force subsequent operators to execute locally
    .Where(article => wordCounter.Matches(article.Abstract).Count < 100);
```

> ูฺฉุชู: ุงุฌุฑุง ุจุฎุด ุงุฒ query ุฑู client ูโุชูุงูุฏ performance ุฑุง ฺฉุงูุด ุฏูุฏุ ุฒุฑุง ููฺฉู ุงุณุช ุชุนุฏุงุฏ ุฑุฏูโูุง ุจุดุชุฑ ุงุฒ ูพุงฺฏุงู ุฏุงุฏู ุฏุฑุงูุช ุดูุฏ.

### EF Core โก

ุฏุฑ ุทูู ุงู ูุตู ู ูุตู นุ ูุง ุงุฒ **EF Core** ุจุฑุง ูุดุงู ุฏุงุฏู **interpreted queries** ุงุณุชูุงุฏู ูโฺฉูู.
ุงฺฉููู ุจุงุฏ ุจู ุจุฑุฑุณ ูฺฺฏโูุง ฺฉูุฏ ุงู ููุงูุฑ ุจูพุฑุฏุงุฒู.

---

### ฺฉูุงุณโูุง Entity ุฏุฑ EF Core ๐ท๏ธ

EF Core ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุชุง ุงุฒ **ูุฑ ฺฉูุงุณ** ุจุฑุง ููุงุด ุฏุงุฏูโูุง ุงุณุชูุงุฏู ฺฉูุฏุ ุจู ุดุฑุท ฺฉู ุจุฑุง ูุฑ ุณุชูู ููุฑุฏ ูุธุฑ ฺฉ **property ุนููู** ุฏุงุดุชู ุจุงุดุฏ.

ุจูโุนููุงู ูุซุงูุ ูโุชูุงูู ฺฉูุงุณ ุฒุฑ ุฑุง ุจุฑุง **query** ู **update** ุฌุฏูู Customers ุฏุฑ ูพุงฺฏุงู ุฏุงุฏู ุชุนุฑู ฺฉูู:

```csharp
public class Customer
{
    public int ID { get; set; } 
    public string Name { get; set; }
}
```

---

### DbContext ๐ฆ

ูพุณ ุงุฒ ุชุนุฑู ฺฉูุงุณโูุง entityุ ูุฑุญูู ุจุนุฏ **subclass ฺฉุฑุฏู DbContext** ุงุณุช.
ฺฉ ููููู ุงุฒ ุงู ฺฉูุงุณ ูุดุงูโุฏููุฏู ุฌูุณุงุช ุดูุง ุจุฑุง ฺฉุงุฑ ุจุง ูพุงฺฏุงู ุฏุงุฏู ุงุณุช. ูุนูููุงู subclass ุดูุง ุดุงูู **ฺฉ property ุงุฒ ููุน DbSet<T>** ุจุฑุง ูุฑ entity ุฏุฑ ูุฏู ุดูุง ุฎูุงูุฏ ุจูุฏ:

```csharp
public class NutshellContext : DbContext
{
    public DbSet<Customer> Customers { get; set; }
    ... properties ุจุฑุง ุฌุฏุงูู ุฏฺฏุฑ ...
}
```

ฺฉ **ุดุก DbContext** ุณู ฺฉุงุฑ ุงูุฌุงู ูโุฏูุฏ:

* ๐น ุจูโุนููุงู **factory** ุจุฑุง ุชููุฏ ุงุดุงุก DbSet<> ฺฉู ูโุชูุงูุฏ ุฑู ุขูโูุง query ุจููุณุฏ.
* ๐น **ุฑุฏุงุจ ุชุบุฑุงุช** ุงุฌุงุฏ ุดุฏู ุฑู entityูุงุ ุชุง ุจุชูุงูุฏ ุขูโูุง ุฑุง ุฏูุจุงุฑู ุฏุฑ ูพุงฺฏุงู ุฏุงุฏู ุฐุฎุฑู ฺฉูุฏ (ูฺฏุงู ฺฉูุฏ ุจู โChange Trackingโ ุฏุฑ ุตูุญู 461).
* ๐น ุงุฑุงุฆู **ูุชุฏูุง virtual** ฺฉู ูโุชูุงูุฏ ุขูโูุง ุฑุง override ฺฉูุฏ ุชุง connection ู ูุฏู ุฑุง ูพฺฉุฑุจูุฏ ฺฉูุฏ.

---

### ูพฺฉุฑุจูุฏ Connection ๐ง

ุจุง override ฺฉุฑุฏู ูุชุฏ **OnConfiguring**ุ ูโุชูุงูุฏ **database provider** ู **connection string** ุฑุง ูุดุฎุต ฺฉูุฏ:

```csharp
public class NutshellContext : DbContext
{
    ...
    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) =>
        optionsBuilder.UseSqlServer(
            @"Server=(local);Database=Nutshell;Trusted_Connection=True");
}
```

ุฏุฑ ุงู ูุซุงูุ **connection string** ุจูโุตูุฑุช **string literal** ูุดุฎุต ุดุฏู ุงุณุช.
ุฏุฑ ุจุฑูุงููโูุง ูุงูุนุ ูุนูููุงู ุขู ุฑุง ุงุฒ ฺฉ ูุงู ูพฺฉุฑุจูุฏ ูุงููุฏ **appsettings.json** ูโุฎูุงููุฏ.

ูุชุฏ **UseSqlServer** ฺฉ **extension method** ุงุณุช ฺฉู ุฏุฑ **assembly ูุฑุจูุท ุจู Microsoft.EntityFramework.SqlServer NuGet package** ุชุนุฑู ุดุฏู ุงุณุช.
ุจุฑุง ุณุงุฑ ูพุงฺฏุงูโูุง ุฏุงุฏู ูุงููุฏ Oracleุ MySQLุ PostgreSQL ู SQLite ูุฒ ูพฺฉุฌโูุง ูุดุงุจู ูุฌูุฏ ุฏุงุฑูุฏ.

---

ุงฺฏุฑ ุงุฒ **ASP.NET** ุงุณุชูุงุฏู ูโฺฉูุฏุ ูโุชูุงูุฏ ุจู **dependency injection framework** ุงุฌุงุฒู ุฏูุฏ ฺฉู **optionsBuilder** ุฑุง ุงุฒ ูุจู ูพฺฉุฑุจูุฏ ฺฉูุฏุ ุฏุฑ ุงฺฉุซุฑ ููุงุฑุฏุ ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ฺฉู ูุงุฒ ุจู override ฺฉุฑุฏู **OnConfiguring** ูุฏุงุดุชู ุจุงุดุฏ.

ุจุฑุง ูุนุงู ฺฉุฑุฏู ุงู ูุงุจูุชุ ูโุชูุงูุฏ ฺฉ **constructor** ุจุฑุง DbContext ุจู ุดฺฉู ุฒุฑ ุชุนุฑู ฺฉูุฏ:

```csharp
public NutshellContext(DbContextOptions<NutshellContext> options)
    : base(options) { }
```

ุงฺฏุฑ ุจุฎูุงูุฏ **OnConfiguring** ุฑุง override ฺฉูุฏ (ูุซูุงู ุจุฑุง ูุฑุงูู ฺฉุฑุฏู ูพฺฉุฑุจูุฏ ุฏุฑ ุณูุงุฑููุง ุฏฺฏุฑ)ุ ูโุชูุงูุฏ ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง ฺฏุฒููโูุง ุงุฒ ูุจู ูพฺฉุฑุจูุฏ ุดุฏูโุงูุฏ ุง ุฎุฑ:

```csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    if (!optionsBuilder.IsConfigured)
    {
        ...
    }
}
```

ุฏุฑ ูุชุฏ **OnConfiguring** ูโุชูุงูุฏ ฺฏุฒููโูุง ุฏฺฏุฑ ูุงููุฏ **lazy loading** ุฑุง ูุฒ ูุนุงู ฺฉูุฏ (ูฺฏุงู ฺฉูุฏ ุจู โLazy loadingโ ุฏุฑ ุตูุญู 464).

### ูพฺฉุฑุจูุฏ ูุฏู ๐๏ธ

ุจูโุทูุฑ ูพุดโูุฑุถุ **EF Core** ุจุฑ ุงุณุงุณ **convention** ุนูู ูโฺฉูุฏุ ุนู **schema ูพุงฺฏุงู ุฏุงุฏู** ุฑุง ุงุฒ ุฑู ูุงู ฺฉูุงุณโูุง ู propertyูุง ุญุฏุณ ูโุฒูุฏ.

ูโุชูุงูุฏ ุงู ูพุดโูุฑุถโูุง ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ **fluent API** ู override ฺฉุฑุฏู **OnModelCreating** ู ูุฑุงุฎูุงู extension methodูุง ุฑู ูพุงุฑุงูุชุฑ **ModelBuilder** ุชุบุฑ ุฏูุฏ.
ุจูโุนููุงู ูุซุงูุ ูโุชูุงูู ูุงู ุฌุฏูู ูพุงฺฏุงู ุฏุงุฏู ุจุฑุง entity ฺฉูุงุณ **Customer** ุฑุง ุจูโุตูุฑุช ุตุฑุญ ูุดุฎุต ฺฉูู:

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder) =>
    modelBuilder.Entity<Customer>()
        .ToTable("Customer");   // ูุงู ุฌุฏูู 'Customer' ุงุณุช
```

ุจุฏูู ุงู ฺฉุฏุ EF Core ุงู entity ุฑุง ุจู ุฌุฏูู ุจุง ูุงู **โCustomersโ** ูฺฏุงุดุช ูโฺฉูุฏุ ูู โCustomerโุ ุฒุฑุง ูุง ุฏุฑ **DbContext** ุฎูุฏ ฺฉ property ุงุฒ ููุน **DbSet<Customer>** ุฏุงุฑู ฺฉู ูุงู ุขู **Customers** ุงุณุช:

```csharp
public DbSet<Customer> Customers { get; set; }
```

---

ฺฉุฏ ุฒุฑ ุชูุงู entityูุง ุดูุง ุฑุง ุจู **ูุงู ฺฉูุงุณ entity** ูฺฏุงุดุช ูโฺฉูุฏ (ฺฉู ูุนูููุงู ููุฑุฏ ุงุณุช) ูู ุจู ูุงู propertyูุง **DbSet<T>** (ฺฉู ูุนูููุงู ุฌูุน ูุณุชูุฏ):

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    foreach (IMutableEntityType entityType in modelBuilder.Model.GetEntityTypes())
    {
        modelBuilder.Entity(entityType.Name)
                    .ToTable(entityType.ClrType.Name);
    }
}
```

---

### Fluent API ุจุฑุง ุณุชููโูุง ๐

**Fluent API** ฺฉ ุณูุชฺฉุณ ูพุดุฑูุชูโุชุฑ ุจุฑุง ูพฺฉุฑุจูุฏ ุณุชููโูุง ุงุฑุงุฆู ูโุฏูุฏ.
ุฏุฑ ูุซุงู ุฒุฑ ุงุฒ ุฏู ูุชุฏ ูุญุจูุจ ุงุณุชูุงุฏู ูโฺฉูู:

* **HasColumnName**: property ุฑุง ุจู ฺฉ ุณุชูู ุจุง ูุงู ูุชูุงูุช ูฺฏุงุดุช ูโฺฉูุฏ.
* **IsRequired**: ูุดุฎุต ูโฺฉูุฏ ฺฉู ุณุชูู **nullable** ูุณุช.

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder) =>
    modelBuilder.Entity<Customer>(entity =>
    {
        entity.ToTable("Customer");
        entity.Property(e => e.Name)
              .HasColumnName("Full Name")  // ูุงู ุณุชูู 'Full Name' ุงุณุช
              .IsRequired();                // ุณุชูู ููโุชูุงูุฏ null ุจุงุดุฏ
    });
```

ุฌุฏูู 8-1 ุจุฑุฎ ุงุฒ ูููโุชุฑู ูุชุฏูุง **fluent API** ุฑุง ููุฑุณุช ูโฺฉูุฏ.

---

ุจู ุฌุง ุงุณุชูุงุฏู ุงุฒ **fluent API**ุ ูโุชูุงูุฏ ูุฏู ุฎูุฏ ุฑุง ุจุง ุงุนูุงู **attributeูุง ุฎุงุต** ุฑู ฺฉูุงุณโูุง ู propertyูุง (**data annotations**) ูพฺฉุฑุจูุฏ ฺฉูุฏ.
ุงู ุฑูุด **ุงูุนุทุงูโูพุฐุฑ ฺฉูุชุฑ** ุฏุงุฑุฏุ ุฒุฑุง ูพฺฉุฑุจูุฏ ุจุงุฏ ุฏุฑ ุฒูุงู ฺฉุงููพุงู ุซุงุจุช ุจุงุดุฏุ ู **ูุฏุฑุช ฺฉูุชุฑ** ุฏุงุฑุฏุ ฺุฑุง ฺฉู ุจุฑุฎ ฺฏุฒููโูุง ููุท ุงุฒ ุทุฑู **fluent API** ูุงุจู ูพฺฉุฑุจูุฏ ูุณุชูุฏ.

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-11.jpeg)
</div>

### ุงุฌุงุฏ ูพุงฺฏุงู ุฏุงุฏู ๐๏ธ๐๏ธ

**EF Core** ุงุฒ ุฑูฺฉุฑุฏ **code-first** ูพุดุชุจุงู ูโฺฉูุฏุ ุจู ุงู ูุนูุง ฺฉู ูโุชูุงูุฏ ุงุจุชุฏุง ฺฉูุงุณโูุง **entity** ุฎูุฏ ุฑุง ุชุนุฑู ฺฉูุฏ ู ุณูพุณ ุงุฒ **EF Core** ุจุฎูุงูุฏ ูพุงฺฏุงู ุฏุงุฏู ุฑุง ุงุฌุงุฏ ฺฉูุฏ. ุณุงุฏูโุชุฑู ุฑูุด ุจุฑุง ุงู ฺฉุงุฑ ูุฑุงุฎูุงู ูุชุฏ ุฒุฑ ุฑู ฺฉ ููููู ุงุฒ **DbContext** ุงุณุช:

```csharp
dbContext.Database.EnsureCreated();
```

ุจุง ุงู ุญุงูุ ุฑูุด ุจูุชุฑ ุงุณุชูุงุฏู ุงุฒ ูุงุจูุช **migrations** ุฏุฑ EF Core ุงุณุช. ุงู ุฑูุด ูู ุชููุง ูพุงฺฏุงู ุฏุงุฏู ุฑุง ุงุฌุงุฏ ูโฺฉูุฏุ ุจูฺฉู ุขู ุฑุง ุทูุฑ ูพฺฉุฑุจูุฏ ูโฺฉูุฏ ฺฉู EF Core ุจุชูุงูุฏ ุฏุฑ ุขูุฏูุ ููฺฏุงู ุชุบุฑ ฺฉูุงุณโูุง entityุ **schema** ุฑุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ.

ุฏุฑ **Visual Studio**ุ ูโุชูุงูุฏ migrations ุฑุง ุงุฒ **Package Manager Console** ูุนุงู ฺฉูุฏ ู ูพุงฺฏุงู ุฏุงุฏู ุฑุง ุจุง ุฏุณุชูุฑุงุช ุฒุฑ ุงุฌุงุฏ ฺฉูุฏ:

```powershell
Install-Package Microsoft.EntityFrameworkCore.Tools
Add-Migration InitialCreate
Update-Database
```

* ุฏุณุชูุฑ ุงูู ุงุจุฒุงุฑูุง ูุฏุฑุช EF Core ุฑุง ุฏุฑ Visual Studio ูุตุจ ูโฺฉูุฏ.
* ุฏุณุชูุฑ ุฏูู ฺฉ ฺฉูุงุณ C# ูฺู ุจู ูุงู **code migration** ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู ุดุงูู ุฏุณุชูุฑุงูุนููโูุง ุงุฌุงุฏ ูพุงฺฏุงู ุฏุงุฏู ุงุณุช.
* ุฏุณุชูุฑ ุขุฎุฑ ุขู ุฏุณุชูุฑุงูุนููโูุง ุฑุง ุฑู connection string ูุดุฎุตโุดุฏู ุฏุฑ ูุงู ูพฺฉุฑุจูุฏ ูพุฑูฺู ุงุฌุฑุง ูโฺฉูุฏ.

---

### ุงุณุชูุงุฏู ุงุฒ DbContext ๐งฉ

ุจุนุฏ ุงุฒ ุชุนุฑู ฺฉูุงุณโูุง **Entity** ู ุงุฌุงุฏ ุฒุฑฺฉูุงุณ ุงุฒ **DbContext**ุ ูโุชูุงูุฏ ฺฉ ููููู ุงุฒ DbContext ุจุณุงุฒุฏ ู ูพุงฺฏุงู ุฏุงุฏู ุฑุง query ฺฉูุฏ:

```csharp
using var dbContext = new NutshellContext();
Console.WriteLine(dbContext.Customers.Count());
// ุงุฌุฑุง ุฏุณุชูุฑ SQL: "SELECT COUNT(*) FROM [Customer] AS [c]"
```

ููฺูู ูโุชูุงูุฏ ุงุฒ **DbContext** ุจุฑุง ููุดุชู ุฏุงุฏู ุฏุฑ ูพุงฺฏุงู ุฏุงุฏู ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
using var dbContext = new NutshellContext();
Customer cust = new Customer()
{
    Name = "Sara Wells"
};
dbContext.Customers.Add(cust);
dbContext.SaveChanges();    // ุชุบุฑุงุช ุฑุง ุจู ูพุงฺฏุงู ุฏุงุฏู ูโููุณุฏ
```

ุจุฑุง ุจุงุฒุงุจ ุฑฺฉูุฑุฏ ฺฉู ุชุงุฒู ุงุถุงูู ุดุฏู:

```csharp
using var dbContext = new NutshellContext();
Customer cust = dbContext.Customers
    .Single(c => c.Name == "Sara Wells");
```

ู ุจุฑุง ุจูโุฑูุฒุฑุณุงู ูุงู ูุดุชุฑ ู ุฐุฎุฑู ุชุบุฑุงุช:

```csharp
cust.Name = "Dr. Sara Wells";
dbContext.SaveChanges();
```

> ุชูุฌู: ูุชุฏ **Single** ุจุฑุง ุจุงุฒุงุจ ฺฉ ุฑฺฉูุฑุฏ ุจุง **primary key** ููุงุณุจ ุงุณุช. ุจุฑ ุฎูุงู **First**ุ ุงฺฏุฑ ุจุด ุงุฒ ฺฉ ุฑฺฉูุฑุฏ ุจุงุฒฺฏุฑุฏุงูุฏู ุดูุฏุ ุฎุทุง ูโุฏูุฏ.

---

### ุฑุฏุงุจ ุงุดุงุก (Object Tracking) ๐

ฺฉ ููููู **DbContext** ุชูุงู entityูุง ฺฉู ุงุฌุงุฏ ูโฺฉูุฏ ุฑุง ุฑุฏุงุจ ูโฺฉูุฏ ุชุง ูุฑ ุจุงุฑ ฺฉู ููุงู ุฑฺฉูุฑุฏูุง ุฑุง ุฏุฑุฎูุงุณุช ฺฉูุฏุ ููุงู ุงุดุงุก ุฑุง ุจู ุดูุง ุจุงุฒฺฏุฑุฏุงูุฏ. ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุฏุฑ ุทูู ุนูุฑ ฺฉ contextุ ูฺ ุฏู entity ุฌุฏุงฺฏุงููโุง ุจุฑุง ฺฉ ุฑฺฉูุฑุฏ ูุดุฎุต (ุจุง primary key) ุงุฌุงุฏ ููโุดูุฏ. ุงู ูุงุจูุช **object tracking** ูุงู ุฏุงุฑุฏ.

ุจุฑุง ูุซุงูุ ูุฑุถ ฺฉูุฏ ูุดุชุฑโุง ฺฉู ุงุฒ ูุธุฑ ุญุฑูู ุงููุจุง ุงููู ุงุณุชุ ฺฉูุชุฑู **ID** ุฑุง ูุฒ ุฏุงุฑุฏ. ุฏุฑ ูุซุงู ุฒุฑุ `a` ู `b` ุจู ฺฉ **object** ุงุดุงุฑู ุฎูุงููุฏ ฺฉุฑุฏ:

```csharp
using var dbContext = new NutshellContext();
Customer a = dbContext.Customers.OrderBy(c => c.Name).First();
Customer b = dbContext.Customers.OrderBy(c => c.ID).First();
```

### ูุฏุฑุช ููุงุจุน ู DbContext ๐๏ธ๐งฉ

ุงฺฏุฑฺู **DbContext** ุงุฒ **IDisposable** ูพุฑู ูโฺฉูุฏุ ุงูุง ูุนูููุงู ูโุชูุงูุฏ ุจุฏูู ูุฑุงุฎูุงู **Dispose** ุงุฒ ูููููโูุง ุงุณุชูุงุฏู ฺฉูุฏ. ูุฑุงุฎูุงู **Dispose** ุจุงุนุซ ูโุดูุฏ ฺฉู **connection** ุฏุงุฎู context ูู ุจุณุชู ุดูุฏุ ุงูุง ุงู ูุนูููุงู ุถุฑูุฑ ูุณุช ุฒุฑุง **EF Core** ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ูพุณ ุงุฒ ูพุงุงู ุฏุฑุงูุช ูุชุงุฌ ุงุฒ ฺฉ queryุ **connection** ุฑุง ูโุจูุฏุฏ.

ูุฑุงุฎูุงู ุฒูุฏููฺฏุงู **Dispose** ูโุชูุงูุฏ ูุดฺฉูโุณุงุฒ ุจุงุดุฏุ ูุฎุตูุตุงู ุจู ุฏูู **lazy evaluation**. ูุซุงู ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

```csharp
IQueryable<Customer> GetCustomers(string prefix)
{
    using (var dbContext = new NutshellContext())
        return dbContext.Customers
                        .Where(c => c.Name.StartsWith(prefix));
}

foreach (Customer c in GetCustomers("a"))
    Console.WriteLine(c.Name);
```

ุงู ฺฉุฏ ุดฺฉุณุช ูโุฎูุฑุฏุ ุฒุฑุง query ุฒูุงู ุงุฑุฒุงุจ ูโุดูุฏ ฺฉู ุขู ุฑุง **enumerate** ูโฺฉููโู ุงู ุจุนุฏ ุงุฒ **Dispose** ุดุฏู **DbContext** ุงุณุช.

ฺูุฏ ูฺฉุชู ุฏุฑุจุงุฑู ุนุฏู ูุฑุงุฎูุงู **Dispose** ูุฌูุฏ ุฏุงุฑุฏ:

* ุงู ฺฉุงุฑ ูุชฺฉ ุจู ุงู ุงุณุช ฺฉู **connection object** ุชูุงู ููุงุจุน unmanaged ุฑุง ููฺฏุงู ูุฑุงุฎูุงู **Close** ุขุฒุงุฏ ฺฉูุฏ. ูุฑฺูุฏ ุงู ุฏุฑ **SqlConnection** ุตุงุฏู ุงุณุชุ ุงูุง ููฺฉู ุงุณุช ฺฉ connection ุดุฎุต ุซุงูุซ ููุงุจุน ุฑุง ุจุงุฒ ูฺฏู ุฏุงุฑุฏ ุงฺฏุฑ **Close** ุดูุฏ ุงูุง **Dispose** ูุฑุงุฎูุงู ูุดูุฏ.
* ุงฺฏุฑ ุจูโุตูุฑุช ุฏุณุช **GetEnumerator** ุฑู query ูุฑุงุฎูุงู ฺฉูุฏ ู ุณูพุณ enumerator ุฑุง **dispose** ูฺฉูุฏ ุง ุชูุงู ุนูุงุตุฑ ุฑุง ูุตุฑู ูฺฉูุฏุ connection ุจุงุฒ ุฎูุงูุฏ ูุงูุฏ. ุฏุฑ ุงู ุณูุงุฑููุง **Dispose** ฺฉ backup ุงุณุช.
* ุจุฑุฎ ุงูุฑุงุฏ ุงุญุณุงุณ ูโฺฉููุฏ ุชูุฒุชุฑ ุงุณุช ฺฉู contextูุง ู ุชูุงู ุงุดุงุก ูพุฑูโฺฉููุฏู ุงุฒ **IDisposable** ุฑุง **dispose** ฺฉููุฏ.

ุงฺฏุฑ ูโุฎูุงูุฏ contextูุง ุฑุง ุตุฑุญุงู **dispose** ฺฉูุฏุ ุจุงุฏ ููููู **DbContext** ุฑุง ุจู ูุชุฏูุง ูุงููุฏ **GetCustomers** ููุชูู ฺฉูุฏ ุชุง ูุดฺฉู ููู ูพุด ูุงุฏ. ุฏุฑ ูุญุทโูุง ูุงููุฏ **ASP.NET Core MVC** ฺฉู context ุงุฒ ุทุฑู **Dependency Injection (DI)** ุงุฑุงุฆู ูโุดูุฏุ **DI** ูุฏุฑุช ุทูู ุนูุฑ context ุฑุง ุจุฑ ุนูุฏู ุฏุงุฑุฏ: ุงุฌุงุฏ ุขู ููฺฏุงู ุดุฑูุน ูุงุญุฏ ฺฉุงุฑ (ูุซูุงู HTTP request) ู **Dispose** ููฺฏุงู ูพุงุงู ูุงุญุฏ ฺฉุงุฑ.

---

### ุชุงุซุฑ object tracking ุฏุฑ EF Core ๐

ูุฑุถ ฺฉูุฏ ููุช EF Core ุฏููู query ุฑุง ุงุฌุฑุง ูโฺฉูุฏุ ุงุจุชุฏุง ฺฉ ุฑฺฉูุฑุฏ ุงุฒ ูพุงฺฏุงู ุฏุงุฏู ุฏุฑุงูุช ฺฉุฑุฏู ู **primary key** ุขู ุฑุง ูโุฎูุงูุฏุ ุณูพุณ ุฏุฑ **entity cache** context ุฌุณุชุฌู ูโฺฉูุฏ. ุงฺฏุฑ match ูพุฏุง ุดูุฏุ ููุงู **object** ููุฌูุฏ ุฑุง ุจุฏูู ุจุฑูุฒุฑุณุงู ููุงุฏุฑ ุจุฑูโฺฏุฑุฏุงูุฏ.

* ุงู ุฑูุชุงุฑ ุจุฑุง ุฌููฺฏุฑ ุงุฒ **side effect**ูุง ุบุฑููุชุธุฑู ุถุฑูุฑ ุงุณุช (ููฺฉู ุงุณุช **Customer** ุฏุฑ ุฌุง ุฏฺฏุฑ ุงุณุชูุงุฏู ุดูุฏ).
* ููฺูู ูุฏุฑุช **concurrency** ุฑุง ุชุณูู ูโฺฉูุฏ. ุงฺฏุฑ ุดูุง ุชุบุฑุงุช ุฑู **Customer** ุฏุงุฏูโุงุฏ ู ูููุฒ **SaveChanges** ุฑุง ูุฑุงุฎูุงู ูฺฉุฑุฏูโุงุฏุ ููโุฎูุงูุฏ ููุงุฏุฑ ุดูุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุจุงุฒููุณ ุดูุฏ.

ูโุชูุงูุฏ **object tracking** ุฑุง ุจุง ูุฑุงุฎูุงู **AsNoTracking** ุฑู query ุง ุจุง ุชูุธู **ChangeTracker.QueryTrackingBehavior = QueryTrackingBehavior.NoTracking** ุบุฑูุนุงู ฺฉูุฏ. ุงู queries ุจุฏูู tracking ุจุฑุง ุฏุงุฏูโูุง **read-only** ููุฏ ุงุณุช ุฒุฑุง ฺฉุงุฑุง ุฑุง ุงูุฒุงุด ู ูุตุฑู ุญุงูุธู ุฑุง ฺฉุงูุด ูโุฏูุฏ.

ุจุฑุง ุฏุฑุงูุช ุงุทูุงุนุงุช ุชุงุฒู ุงุฒ ูพุงฺฏุงู ุฏุงุฏูุ ุจุงุฏ ุง ฺฉ context ุฌุฏุฏ ุจุณุงุฒุฏ ุง ูุชุฏ **Reload** ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ:

```csharp
dbContext.Entry(myCustomer).Reload();
```

ุจูุชุฑู ุฑูุด ุงู ุงุณุช ฺฉู ุจุฑุง ูุฑ **unit of work** ฺฉ **DbContext** ุฌุฏุฏ ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ูุงุฒ ุจู **Reload** ุฏุณุช ุจู ุญุฏุงูู ุจุฑุณุฏ.

---

### ุฑุฏุงุจ ุชุบุฑุงุช (Change Tracking) ๐

ููฺฏุงู ฺฉู ููุฏุงุฑ ฺฉ property ุฏุฑ ฺฉ entity ุจุงุฑฺฏุฐุงุฑโุดุฏู ุชูุณุท **DbContext** ุชุบุฑ ฺฉูุฏุ EF Core ุงู ุชุบุฑ ุฑุง ุชุดุฎุต ุฏุงุฏู ู ููฺฏุงู ูุฑุงุฎูุงู **SaveChanges** ูพุงฺฏุงู ุฏุงุฏู ุฑุง ูุทุงุจู ุชุบุฑุงุช ุจูโุฑูุฒ ูโฺฉูุฏ.

EF Core ุจุฑุง ุงู ฺฉุงุฑุ **snapshot** ุงุฒ ูุถุนุช entityูุง ุงุฌุงุฏ ูโฺฉูุฏ ู ูุถุนุช ูุนู ุฑุง ุจุง ูุถุนุช ุงุตู ููฺฏุงู **SaveChanges** ููุงุณู ูโฺฉูุฏ.

ุจุฑุง ูุดุงูุฏู ุชุบุฑุงุช ุฑุฏุงุจโุดุฏู:

```csharp
foreach (var e in dbContext.ChangeTracker.Entries())
{
    Console.WriteLine($"{e.Entity.GetType().FullName} is {e.State}");
    foreach (var m in e.Members)
        Console.WriteLine(
            $"  {m.Metadata.Name}: '{m.CurrentValue}' modified: {m.IsModified}");
}
```

ููฺฏุงู ูุฑุงุฎูุงู **SaveChanges**ุ EF Core ุจุง ุงุณุชูุงุฏู ุงุฒ ุงุทูุงุนุงุช **ChangeTracker**ุ ุฏุณุชูุฑุงุช SQL ุงุฌุงุฏ ูโฺฉูุฏ:

* **Insert** ุจุฑุง ุงุถุงูู ฺฉุฑุฏู ุฑฺฉูุฑุฏ ุฌุฏุฏ
* **Update** ุจุฑุง ุชุบุฑ ุฏุงุฏูโูุง
* **Delete** ุจุฑุง ุญุฐู ุฑฺฉูุฑุฏูุง ุญุฐูโุดุฏู ุงุฒ ฺฏุฑุงู object

ูุฑ **TransactionScope** ุงุญุชุฑุงู ฺฏุฐุงุดุชู ูโุดูุฏ ู ุฏุฑ ุตูุฑุช ุนุฏู ูุฌูุฏุ EF Core ุชูุงู ุฏุณุชูุฑุงุช ุฑุง ุฏุฑ ฺฉ ุชุฑุงฺฉูุด ุฌุฏุฏ ุงุฌุฑุง ูโฺฉูุฏ.

ุจุฑุง ุจูููโุณุงุฒ **change tracking** ูโุชูุงูุฏ ุงูุชุฑูุณโูุง **INotifyPropertyChanged** ู ุงุฎุชุงุฑ **INotifyPropertyChanging** ุฑุง ุฏุฑ entityูุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ. ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ EF Core ุงุฒ ููุงุณู state ุงููู ู ูุนู ุตุฑูโูุธุฑ ฺฉูุฏ ู ฺฉุงุฑุง ุงูุฒุงุด ุงุจุฏ. ุณูพุณ ุจุง ูุฑุงุฎูุงู **HasChangeTrackingStrategy** ุฏุฑ **ModelBuilder**ุ ุงู ุจูููโุณุงุฒ ูุนุงู ูโุดูุฏ.

---

### Navigation Properties ๐

**Navigation properties** ุจู ุดูุง ุงูฺฉุงู ูโุฏููุฏ:

* ุฌุฏุงูู ูุฑุชุจุท ุฑุง ุจุฏูู ูุงุฒ ุจู join ุฏุณุช query ฺฉูุฏ
* ุฑฺฉูุฑุฏูุง ูุฑุชุจุท ุฑุง ุฏุฑุฌุ ุญุฐู ุง ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ ุจุฏูู ุขูโฺฉู ฺฉูุฏ ุฎุงุฑุฌ ุฑุง ุจูโุตูุฑุช ุตุฑุญ ุชุบุฑ ุฏูุฏ

ูุซุงู: ูุฑุถ ฺฉูุฏ ูุฑ ูุดุชุฑ ูโุชูุงูุฏ ฺูุฏ ุฎุฑุฏ ุฏุงุดุชู ุจุงุดุฏ. ุฑุงุจุทู **one-to-many** ุจู **Customer** ู **Purchase** ุฑุง ูโุชูุงู ุจู ุดฺฉู ุฒุฑ ููุงุด ุฏุงุฏ:

```csharp
public class Customer
{
    public int ID { get; set; }
    public string Name { get; set; }
    public virtual List<Purchase> Purchases { get; set; } = new List<Purchase>();
}

public class Purchase
{
    public int ID { get; set; }
    public DateTime Date { get; set; }
    public string Description { get; set; }
    public decimal Price { get; set; }
    public int? CustomerID { get; set; }  // Foreign key
    public Customer Customer { get; set; } // Parent navigation
}
```

EF Core ุจุง ุชูุฌู ุจู ูุงู **CustomerID**ุ ุขู ุฑุง ุจู ุนููุงู **foreign key** ุจู ุฌุฏูู **Customer** ุชุดุฎุต ูโุฏูุฏ. ุงฺฏุฑ EF Core ูุชูุงูุฏ ุฑุงุจุทู ุฑุง ุงุณุชูุชุงุฌ ฺฉูุฏุ ูโุชูุงูุฏ ุขู ุฑุง ุตุฑุญุงู ุฏุฑ **OnModelCreating** ูพฺฉุฑุจูุฏ ฺฉูุฏ:

```csharp
modelBuilder.Entity<Purchase>()
    .HasOne(e => e.Customer)
    .WithMany(e => e.Purchases)
    .HasForeignKey(e => e.CustomerID);
```

ุจุง ุงู navigation propertiesุ ูโุชูุงู queries ูุงููุฏ ุฒุฑ ููุดุช:

```csharp
var customersWithPurchases = Customers.Where(c => c.Purchases.Any());
```

ุฏุฑ ูุตู ุจุนุฏุ ูุญูู ููุดุชู ุงู ููุน queryูุง ุฑุง ุจู ุชูุตู ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.

### ุงูุฒูุฏู ู ุญุฐู ููุฌูุฏุชโูุง ุงุฒ ูุฌููุนูโูุง Navigation ๐โ

ููุช ููุฌูุฏุชโูุง ุฌุฏุฏ ุจู ฺฉ **collection navigation property** ุงุถุงูู ูโฺฉูุฏุ **EF Core** ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉูุฏูุง ุฎุงุฑุฌ ุฑุง ููฺฏุงู ูุฑุงุฎูุงู **SaveChanges** ูพุฑ ูโฺฉูุฏ:

```csharp
Customer cust = dbContext.Customers.Single(c => c.ID == 1);
Purchase p1 = new Purchase { Description="Bike", Price=500 };
Purchase p2 = new Purchase { Description="Tools", Price=100 };
cust.Purchases.Add(p1);
cust.Purchases.Add(p2);
dbContext.SaveChanges();
```

ุฏุฑ ุงู ูุซุงูุ **EF Core** ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ููุฏุงุฑ `1` ุฑุง ุฏุฑ ุณุชูู **CustomerID** ูุฑ ุฎุฑุฏ ุฌุฏุฏ ูโููุณุฏ ู **ID** ุชููุฏุดุฏู ุชูุณุท ูพุงฺฏุงู ุฏุงุฏู ุฑุง ุจู **Purchase.ID** ุงุฎุชุตุงุต ูโุฏูุฏ.

ุงฺฏุฑ ููุฌูุฏุช ุฑุง ุงุฒ ฺฉ **collection navigation property** ุญุฐู ฺฉุฑุฏู ู **SaveChanges** ุฑุง ูุฑุงุฎูุงู ฺฉูุฏุ EF Core ุจุณุชู ุจู ููุน ูพฺฉุฑุจูุฏ ุง ุงุณุชูุชุงุฌ ุฑุงุจุทูุ ฺฉ ุงุฒ ฺฉุงุฑูุง ุฒุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ:

* ูพุงฺฉ ฺฉุฑุฏู ููุฏุงุฑ **foreign key**
* ุญุฐู ุฑุฏู ูุฑุจูุทู ุงุฒ ูพุงฺฏุงู ุฏุงุฏู

ุฏุฑ ุงู ูุซุงูุ ฺูู **Purchase.CustomerID** ุจู ุตูุฑุช nullable ุชุนุฑู ุดุฏู ุงุณุช (ุชุง ุฎุฑุฏ ุจุฏูู ูุดุชุฑ ุง ุชุฑุงฺฉูุด ููุฏ ุฑุง ุจุชูุงู ููุงุด ุฏุงุฏ)ุ ุญุฐู ฺฉ ุฎุฑุฏ ุงุฒ ูุดุชุฑุ ููุฏุงุฑ foreign key ุฑุง ูพุงฺฉ ูโฺฉูุฏ ู ุฑฺฉูุฑุฏ ุงุฒ ูพุงฺฏุงู ุฏุงุฏู ุญุฐู ููโุดูุฏ.

---

### ุจุงุฑฺฏุฐุงุฑ Navigation Properties ๐ฆ

ุฒูุงู ฺฉู **EF Core** ฺฉ entity ุฑุง populate ูโฺฉูุฏุ ุจูโุทูุฑ ูพุดโูุฑุถ navigation properties ุขู ุฑุง ูพุฑ ููโฺฉูุฏ:

```csharp
using var dbContext = new NutshellContext();
var cust = dbContext.Customers.First();
Console.WriteLine(cust.Purchases.Count);    // ููุดู 0
```

ุฑุงูโุญูโูุง:

1. **ุงุณุชูุงุฏู ุงุฒ Include:** ุงู ุฑูุด ุจู EF Core ุฏุณุชูุฑ ูโุฏูุฏ ฺฉู navigation properties ุฑุง eager load ฺฉูุฏ:

```csharp
var cust = dbContext.Customers
    .Include(c => c.Purchases)
    .Where(c => c.ID == 2)
    .First();
```

2. **ุงุณุชูุงุฏู ุงุฒ Projection:** ุงู ุชฺฉูฺฉ ุฒูุงู ููุฏ ุงุณุช ฺฉู ููุท ุจุฎุด ุงุฒ propertyูุง entity ูุงุฒ ุจุงุดุฏุ ุฒุฑุง ุญุฌู ุงูุชูุงู ุฏุงุฏู ฺฉุงูุด ูโุงุจุฏ:

```csharp
var custInfo = dbContext.Customers
    .Where(c => c.ID == 2)
    .Select(c => new
    {
        Name = c.Name,
        Purchases = c.Purchases.Select(p => new { p.Description, p.Price })
    })
    .First();
```

ูุฑ ุฏู ุฑูุด ุจู EF Core ุงุทูุงุน ูโุฏููุฏ ฺฉู ฺู ุฏุงุฏูโุง ูุงุฒ ุฏุงุฑุฏ ุชุง ุจุชูุงูุฏ ุขู ุฑุง ุฏุฑ ฺฉ query ุจูโุฏุณุช ุขูุฑุฏ.

3. **Explicit Loading:** ูโุชูุงูุฏ EF Core ุฑุง ุจูโุตูุฑุช ุฏุณุช ูุงุฏุงุฑ ุจู populate ฺฉุฑุฏู navigation property ฺฉูุฏ:

```csharp
dbContext.Entry(cust).Collection(b => b.Purchases).Load();
// cust.Purchases ุงฺฉููู ูพุฑ ุดุฏู ุงุณุช
```

ุงู ุฑูุด ฺฉ round trip ุงุถุงู ุจู ูพุงฺฏุงู ุฏุงุฏู ุงุฌุงุฏ ูโฺฉูุฏ.

---

### Lazy Loading ๐ค

ุฑูุด ุฏฺฏุฑ ุจุฑุง ุจุงุฑฺฏุฐุงุฑ navigation propertiesุ **lazy loading** ุงุณุช. ุจุง ูุนุงู ุดุฏูุ EF Core navigation properties ุฑุง ุจูโุตูุฑุช demand-load ูพุฑ ูโฺฉูุฏ. ุจุฑุง ุงู ฺฉุงุฑ:

* ูุฑ navigation property ุจุงุฏ **virtual** ุจุงุดุฏ
* ฺฉูุงุณ entity ุจุงุฏ ูุงุจูุช ุงุฑุซโุจุฑ ุฏุงุดุชู ุจุงุดุฏ (sealed ูุจุงุดุฏ)
* context ูุจุงุฏ ูุจู ุงุฒ lazy load **Dispose** ุดุฏู ุจุงุดุฏ

ูุนุงู ฺฉุฑุฏู lazy loading ุฏุฑ ูุชุฏ **OnConfiguring** DbContext ุจู ุดฺฉู ุฒุฑ ุงุณุช:

```csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    optionsBuilder
        .UseLazyLoadingProxies();
    ...
}
```

> ุชูุฌู: ุจุงุฏ ุจุณุชู **Microsoft.EntityFrameworkCore.Proxies** ุฑุง ูู ุงุถุงูู ฺฉูุฏ.

ูุฒูู lazy loading ุงู ุงุณุช ฺฉู ูุฑ ุจุงุฑ ฺฉู ุจู navigation property ุจุงุฑฺฏุฐุงุฑโูุดุฏู ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏุ ฺฉ ุฏุฑุฎูุงุณุช ุงุถุงู ุจู ูพุงฺฏุงู ุฏุงุฏู ุงุฑุณุงู ูโุดูุฏ. ุงฺฏุฑ ุชุนุฏุงุฏ ุฒุงุฏ ุงุฒ ุงู ุฏุฑุฎูุงุณุชโูุง ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ฺฉุงุฑุง ฺฉุงูุด ูโุงุจุฏ.

ุจุง ูุนุงู ุจูุฏู lazy loadingุ ููุน runtime ฺฉูุงุณโูุง ูพุฑูฺฉุณ ุงุณุช ฺฉู ุงุฒ ฺฉูุงุณ entity ูุดุชู ุดุฏู ุงุณุช:

```csharp
using var dbContext = new NutshellContext();
var cust = dbContext.Customers.First();
Console.WriteLine(cust.GetType());
// ุฎุฑูุฌ: Castle.Proxies.CustomerProxy
```

### ุงุฌุฑุง ุจู ุชุฃุฎุฑ ุงูุชุงุฏู (Deferred Execution) โณ

ฺฉูุฆุฑโูุง **EF Core** ูุฒ ูุงููุฏ ฺฉูุฆุฑโูุง ูุญู ุงุฒ ูุฏู **deferred execution** ูพุฑู ูโฺฉููุฏ. ุงู ูฺฺฏ ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ฺฉูุฆุฑโูุง ุฑุง ุจูโุชุฏุฑุฌ ุจุณุงุฒุฏ. ุจุง ุงู ุญุงูุ ฺฉ ูฺฉุชู ูฺู ุฏุฑ **EF Core** ูุฌูุฏ ุฏุงุฑุฏ ู ุขู ุฒูุงู ุงุณุช ฺฉู **subquery** ุฏุงุฎู ฺฉ **Select expression** ูุฑุงุฑ ฺฏุฑุฏ.

ุจุง ฺฉูุฆุฑโูุง ูุญูุ ุดูุง **double-deferred execution** ุฏุงุฑุฏุ ุฒุฑุง ุงุฒ ุฏุฏฺฏุงู ุชุงุจุนุ ุฏุฑ ุญุงู ุงูุชุฎุงุจ ฺฉ ุฏูุจุงูู ุงุฒ ฺฉูุฆุฑโูุง ูุณุชุฏ. ุจูุงุจุฑุงู ุงฺฏุฑ ุฏูุจุงูู ุจุฑูู ุฑุง ุดูุงุฑุด ฺฉูุฏ ุงูุง ุฏูุจุงููโูุง ุฏุงุฎู ูุฑฺฏุฒ ุดูุงุฑุด ูุดููุฏุ subquery ุงุฌุฑุง ูุฎูุงูุฏ ุดุฏ.

ุฏุฑ **EF Core**ุ subquery ููุฒูุงู ุจุง ุงุฌุฑุง ฺฉูุฆุฑ ุจุฑูู ุงุฌุฑุง ูโุดูุฏ ุชุง ุงุฒ ุงุฑุณุงู ุฏุฑุฎูุงุณุชโูุง ุงุถุงู ุฌููฺฏุฑ ุดูุฏ.

ูุซุงู: ุงู ฺฉูุฆุฑ ุชููุง ุฏุฑ ฺฉ round trip ุจู ูพุงฺฏุงู ุฏุงุฏู ุงุฌุฑุง ูโุดูุฏ:

```csharp
using var dbContext = new NutshellContext();
var query = from c in dbContext.Customers
            select from p in c.Purchases
                   select new { c.Name, p.Price };

foreach (var customerPurchaseResults in query)
    foreach (var namePrice in customerPurchaseResults)
        Console.WriteLine($"{namePrice.Name} spent {namePrice.Price}");
```

ุชูุงู **navigation properties** ฺฉู ุจูโุตูุฑุช ุตุฑุญ projection ุดุฏูโุงูุฏุ ุฏุฑ ฺฉ round trip ฺฉุงูู ูพุฑ ูโุดููุฏ:

```csharp
var query = from c in dbContext.Customers
            select new { c.Name, c.Purchases };

foreach (var row in query)
    foreach (Purchase p in row.Purchases)   // ุจุฏูู round-trip ุงุถุงู
        Console.WriteLine(row.Name + " spent " + p.Price);
```

ุงูุง ุงฺฏุฑ ฺฉ navigation property ุฑุง ุจุฏูู eager load ุง projection ุดูุงุฑุด ฺฉูุฏุ ููุงูู deferred execution ุงุนูุงู ูโุดููุฏ:

```csharp
foreach (Customer c in dbContext.Customers.ToArray())
    foreach (Purchase p in c.Purchases)    // SQL round-trip ุงุถุงู
        Console.WriteLine(c.Name + " spent " + p.Price);
```

ุงู ูุฏู ุฒูุงู ููุฏ ุงุณุช ฺฉู ุจุฎูุงูุฏ ุงุฌุฑุง ุญููู ุฏุงุฎู ุฑุง ุจูโุตูุฑุช ุงูุชุฎุงุจ ุงูุฌุงู ุฏูุฏ:

```csharp
foreach (Customer c in dbContext.Customers.ToArray())
    if (myWebService.HasBadCreditHistory(c.ID))
        foreach (Purchase p in c.Purchases)   // SQL round-trip ุงุถุงู
            Console.WriteLine(c.Name + " spent " + p.Price);
```

> ุชูุฌู: ุงุณุชูุงุฏู ุงุฒ **ToArray** ุถุฑูุฑ ุงุณุชุ ุฒุฑุง SQL Server ุจูโุตูุฑุช ูพุดโูุฑุถ ููโุชูุงูุฏ ฺฉ ฺฉูุฆุฑ ุฌุฏุฏ ุฑุง ุฏุฑ ุญุงู ฺฉู ูุชุงุฌ ฺฉูุฆุฑ ูุนู ูููุฒ ูพุฑุฏุงุฒุด ูโุดููุฏุ ุขุบุงุฒ ฺฉูุฏ.
> ูโุชูุงู ุจุง ุงุถุงูู ฺฉุฑุฏู `;MultipleActiveResultSets=True` ุจู connection stringุ ุงูฺฉุงู **MARS** ุฑุง ูุนุงู ฺฉุฑุฏุ ุงูุง ุจุง ุงุญุชุงุท ุงุณุชูุงุฏู ฺฉูุฏุ ุฒุฑุง ููฺฉู ุงุณุช ูุดฺฉูุงุช ุทุฑุงุญ ุฏุชุงุจุณ ฺฉู ูโุชูุงููุฏ ุจุง eager loading ุง projection ุจูุจูุฏ ุงุจูุฏุ ูพููุงู ุดููุฏ.

---

### ุณุงุฎุช Expressions ุจุฑุง ฺฉูุฆุฑโูุง ๐๏ธ

ุชุงฺฉูููุ ููุช ูุงุฒ ุจู ุงุฌุงุฏ ฺฉูุฆุฑโูุง ุฏุงูุงูฺฉ ุฏุงุดุชูุ ุงู ฺฉุงุฑ ุฑุง ุจุง chaining ุดุฑุท **query operators** ุงูุฌุงู ูโุฏุงุฏู. ุงู ุฑูุด ุฏุฑ ุจุณุงุฑ ุงุฒ ุณูุงุฑููุง ฺฉุงู ุงุณุชุ ุงูุง ฺฏุงู ูุงุฒ ุฏุงุฑู ุจู ุณุทุญ ุฏููโุชุฑ ุฑูุชู ู **lambda expression**ูุง ฺฉู ุจู operatorูุง ุฏุงุฏู ูโุดููุฏ ุฑุง ุฏุงูุงูฺฉ ุจุณุงุฒู.

ูุฑุถ ฺฉูุฏ ฺฉูุงุณ ุฒุฑ ุฏุงุฑู:

```csharp
public class Product
{
    public int ID { get; set; }
    public string Description { get; set; }
    public bool Discontinued { get; set; }
    public DateTime LastSale { get; set; }
}
```

---

### Delegates ุฏุฑ ููุงุจู Expression Trees ๐งฉ

ุจู ุงุฏ ุฏุงุดุชู ุจุงุดุฏ:

* ฺฉูุฆุฑโูุง ูุญู (**Enumerable operators**) ุงุฒ **delegates** ุงุณุชูุงุฏู ูโฺฉููุฏ.
* ฺฉูุฆุฑโูุง ุชูุณุฑุดุฏู (**Queryable operators**) ุงุฒ **expression trees** ุงุณุชูุงุฏู ูโฺฉููุฏ.

ูโุชูุงู ุงู ุฑุง ุจุง ููุงุณู signature ูุชุฏ **Where** ุฏุฑ Enumerable ู Queryable ุฏุฏ:

```csharp
public static IEnumerable<TSource> Where<TSource>(this IEnumerable<TSource> source, Func<TSource,bool> predicate)
public static IQueryable<TSource> Where<TSource>(this IQueryable<TSource> source, Expression<Func<TSource,bool>> predicate)
```

ููุช ฺฉ lambda expression ุฏุฑูู ฺฉ ฺฉูุฆุฑ ูุฑุงุฑ ูโฺฏุฑุฏุ ุธุงูุฑ ุขู ุดุจู ูู ุงุณุชุ ฺู ุจู operatorูุง Enumerable ูุชุตู ุดูุฏ ู ฺู Queryable:

```csharp
IEnumerable<Product> q1 = localProducts.Where(p => !p.Discontinued);
IQueryable<Product>  q2 = sqlProducts.Where(p => !p.Discontinued);
```

ุงูุง ุงฺฏุฑ lambda ุฑุง ุจู ฺฉ ูุชุบุฑ ูุงู ุงุฎุชุตุงุต ุฏูุฏุ ุจุงุฏ ูุดุฎุต ฺฉูุฏ ฺฉู **delegate** ูโุฎูุงูุฏ ุง **expression tree**. ูุซุงู:

```csharp
Func<Product, bool> predicate1 = p => !p.Discontinued;
IEnumerable<Product> q1 = localProducts.Where(predicate1);

Expression<Func<Product, bool>> predicate2 = p => !p.Discontinued;
IQueryable<Product> q2 = sqlProducts.Where(predicate2);
```

> ุชูุฌู: `predicate1` ู `predicate2` ูุงุจู ุฌุงฺฏุฒู ูุณุชูุฏ.

### ฺฉุงููพุงู ฺฉุฑุฏู Expression Treeูุง โ๏ธ

ูโุชูุงูุฏ ฺฉ **expression tree** ุฑุง ุจุง ูุฑุงุฎูุงู ูุชุฏ **Compile** ุจู **delegate** ุชุจุฏู ฺฉูุฏ. ุงู ฺฉุงุฑ ุจูโูฺู ุฒูุงู ุงุฑุฒุดููุฏ ุงุณุช ฺฉู ุจุฎูุงูุฏ ูุชุฏูุง ุจููุณุฏ ฺฉู **expressions ูุงุจู ุงุณุชูุงุฏู ูุฌุฏุฏ** ุจุฑูโฺฏุฑุฏุงููุฏ.

ุจุฑุง ูุซุงูุ ูุฑุถ ฺฉูุฏ ฺฉ ูุชุฏ ุงุณุชุงุชฺฉ ุจู ฺฉูุงุณ **Product** ุงุถุงูู ฺฉูู ฺฉู ฺฉ predicate ุจุฑูโฺฏุฑุฏุงูุฏ ู ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ูุญุตูู **discontinued** ูุจุงุดุฏ ู ุฏุฑ ณฐ ุฑูุฒ ฺฏุฐุดุชู ูุฑูุฎุชู ุดุฏู ุจุงุดุฏ:

```csharp
public class Product
{
    public static Expression<Func<Product, bool>> IsSelling()
    {
        return p => !p.Discontinued && p.LastSale > DateTime.Now.AddDays(-30);
    }
}
```

ุงู ูุชุฏ ูโุชูุงูุฏ ูู ุฏุฑ ฺฉูุฆุฑโูุง **interpreted** ู ูู **local** ุงุณุชูุงุฏู ุดูุฏ:

```csharp
void Test()
{
    var dbContext = new NutshellContext();
    Product[] localProducts = dbContext.Products.ToArray();
    
    IQueryable<Product> sqlQuery = dbContext.Products.Where(Product.IsSelling());
    IEnumerable<Product> localQuery = localProducts.Where(Product.IsSelling().Compile());
}
```

---

### AsQueryable ๐งต

ุฏุฑ .NET API ูุณุชูู ุจุฑุง ุชุจุฏู **delegate** ุจู **expression tree** ูุฌูุฏ ูุฏุงุฑุฏ. ุงู ูฺฺฏุ **expression tree**ูุง ุฑุง ุงูุนุทุงูโูพุฐุฑุชุฑ ูโฺฉูุฏ.

ุนููฺฏุฑ **AsQueryable** ุงุฌุงุฒู ูโุฏูุฏ ฺฉู ฺฉ ฺฉูุฆุฑ ุฑุง ุทูุฑ ุจููุณุฏ ฺฉู ูู ุฑู ุฏูุจุงููโูุง ูุญู ู ูู ุฑู ุฏูุจุงููโูุง ุฑููุช ุงุฌุฑุง ุดูุฏ:

```csharp
IQueryable<Product> FilterSortProducts(IQueryable<Product> input)
{
    return from p in input
           where ...
           orderby ...
           select p;
}

void Test()
{
    var dbContext = new NutshellContext();
    Product[] localProducts = dbContext.Products.ToArray();

    var sqlQuery   = FilterSortProducts(dbContext.Products);
    var localQuery = FilterSortProducts(localProducts.AsQueryable());
}
```

> **AsQueryable** ุฏูุจุงูู ูุญู ุฑุง ุจู ฺฉ `IQueryable<T>` ุชุจุฏู ูโฺฉูุฏ ุชุง query operators ุจุนุฏ ุจู **expression tree**ูุง ูุชุตู ุดููุฏ. ููุช ุจุนุฏุงู ุฑู ูุชุฌู ุดูุงุฑุด ุงูุฌุงู ุดูุฏุ **expression tree**ูุง ุจูโุตูุฑุช ุถูู ฺฉุงููพุงู ูโุดููุฏ (ุจุง ูุฒูู ฺฉูฺฺฉ ุนููฺฉุฑุฏ)ุ ู ุฏูุจุงูู ูุญู ูุซู ุญุงูุช ุนุงุฏ ุดูุงุฑุด ูโุดูุฏ.

---

### Expression Trees ๐ณ

ูุจูุงู ฺฏูุชู ฺฉู ุชุจุฏู ุถูู ฺฉ lambda expression ุจู `Expression<TDelegate>` ุจุงุนุซ ูโุดูุฏ ฺฉุงููพุงูุฑ **C#** ฺฉุฏ ุชููุฏ ฺฉูุฏ ฺฉู ฺฉ **expression tree** ูโุณุงุฒุฏ.

ุจุง ฺฉู ุชูุงุด ุจุฑูุงููโููุณุ ูโุชูุงูุฏ ุงู ฺฉุงุฑ ุฑุง **ุฏูุงูฺฉ ู ุฏุฑ ุฒูุงู ุงุฌุฑุง** ุงูุฌุงู ุฏูุฏุ ุนู ฺฉ **expression tree** ุฑุง ุงุฒ ุตูุฑ ุจุณุงุฒุฏ. ูุชุฌู ุฑุง ูโุชูุงู ุจู `Expression<TDelegate>` ุชุจุฏู ฺฉุฑุฏ ู ุฏุฑ ฺฉูุฆุฑโูุง **EF Core** ุงุณุชูุงุฏู ฺฉุฑุฏ ุง ุจุง ูุฑุงุฎูุงู **Compile** ุจู ฺฉ **delegate** ูุนููู ุชุจุฏู ูููุฏ.

---

### Expression DOM ๐๏ธ

ฺฉ **expression tree** ุฏุฑ ูุงูุน ฺฉ **miniature code DOM** ุงุณุช. ูุฑ ููุฏ ุฏุฑ ุงู ุฏุฑุฎุช ุจุง ฺฉ ููุน ุฏุฑ namespace `System.Linq.Expressions` ูุดุงู ุฏุงุฏู ูโุดูุฏ. ุดฺฉู ธ-ฑฐ ุงููุงุน ุงู ููุฏูุง ุฑุง ูุดุงู ูโุฏูุฏ.
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-12.jpeg)
</div>

ฺฉูุงุณ ูพุงู ุจุฑุง ุชูุงู ููุฏูุงุ ฺฉูุงุณ **Expression** ุบุฑุฌูุฑฺฉ ุงุณุช.

ฺฉูุงุณ **generic Expression<TDelegate>** ุฏุฑ ูุงูุน ุจู ูุนูุง "**typed lambda expression**" ุงุณุช ู ุงฺฏุฑ ูุณุฆูู ูพฺุฏฺฏ ุฒุฑ ูุจูุฏุ ูโุชูุงูุณุช ูุงูุด **LambdaExpression<TDelegate>** ุจุงุดุฏ:

```csharp
LambdaExpression<Func<Customer,bool>> f = ...
```

ฺฉูุงุณ ูพุงู **Expression<T>** ููุงู ฺฉูุงุณ ุบุฑุฌูุฑฺฉ **LambdaExpression** ุงุณุช. **LambdaExpression** ููุนโุจูุฏ ฺฉููุงุฎุช ุจุฑุง **lambda expression tree**ูุง ุฑุง ูุฑุงูู ูโฺฉูุฏุ ุจู ุทูุฑ ฺฉู ูุฑ **Expression<T>** ูุงุจู ุชุจุฏู ุจู **LambdaExpression** ุงุณุช.

ูฺฺฏ ูุชูุงุฒ **LambdaExpression** ุงุฒ **Expression**ูุง ูุนููู ุงู ุงุณุช ฺฉู **lambda expression**ูุง ุฏุงุฑุง ูพุงุฑุงูุชุฑ ูุณุชูุฏ.

ุจุฑุง ุณุงุฎุช ฺฉ **expression tree**ุ ูุจุงุฏ ูุณุชููุงู ููุฏูุง ุฑุง instantiate ฺฉูุฏุ ุจูฺฉู ุจุงุฏ ุงุฒ ูุชุฏูุง ุงุณุชุงุชฺฉ ุงุฑุงุฆูโุดุฏู ุฏุฑ ฺฉูุงุณ **Expression** ุงุณุชูุงุฏู ฺฉูุฏุ ูุงููุฏ: `Add`, `And`, `Call`, `Constant`, `LessThan` ู ุบุฑู.

ุดฺฉู ธ-ฑฑ ุฏุฑุฎุช **expression** ุงุฌุงุฏุดุฏู ุชูุณุท ุงูุชุณุงุจ ุฒุฑ ุฑุง ูุดุงู ูโุฏูุฏ:

```csharp
Expression<Func<string, bool>> f = s => s.Length < 5;
```

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/08/Table-8-13.jpeg)
</div>
ูโุชูุงูู ุงู ููุถูุน ุฑุง ุจู ุตูุฑุช ุฒุฑ ูุดุงู ุฏูู:

```csharp
Console.WriteLine(f.Body.NodeType);                     // LessThan
Console.WriteLine(((BinaryExpression) f.Body).Right);   // 5
```

ุญุงู ุจุงุฏ ุงู **expression** ุฑุง ุงุฒ ุตูุฑ ุจุณุงุฒู. ุงุตู ุงู ุงุณุช ฺฉู ุงุฒ ูพุงู ุฏุฑุฎุช ุดุฑูุน ฺฉุฑุฏู ู ุจู ุณูุช ุจุงูุง ูพุด ุจุฑูู. ูพุงูโุชุฑู ุนูุตุฑ ุฏุฑุฎุช ูุง ฺฉ **ParameterExpression** ุงุณุชุ ุนู ูพุงุฑุงูุชุฑ **lambda expression** ุจู ูุงู `"s"` ุงุฒ ููุน `string`:

```csharp
ParameterExpression p = Expression.Parameter(typeof(string), "s");
```

ฺฏุงู ุจุนุฏ ุณุงุฎุช **MemberExpression** ู **ConstantExpression** ุงุณุช. ุฏุฑ ููุฑุฏ ุงููุ ุจุงุฏ ุจู ุฎุงุตุช `Length` ูพุงุฑุงูุชุฑ `"s"` ุฏุณุชุฑุณ ูพุฏุง ฺฉูู:

```csharp
MemberExpression stringLength = Expression.Property(p, "Length");
ConstantExpression five = Expression.Constant(5);
```

ฺฏุงู ุจุนุฏ ููุงุณู **LessThan** ุงุณุช:

```csharp
BinaryExpression comparison = Expression.LessThan(stringLength, five);
```

ุขุฎุฑู ฺฏุงูุ ุณุงุฎุช **lambda expression** ุงุณุช ฺฉู **expression Body** ุฑุง ุจู ูุฌููุนูโุง ุงุฒ ูพุงุฑุงูุชุฑูุง ูุชุตู ูโฺฉูุฏ:

```csharp
Expression<Func<string, bool>> lambda
    = Expression.Lambda<Func<string, bool>>(comparison, p);
```

ุฑุงู ุณุงุฏู ุจุฑุง ุชุณุช **lambda** ุงู ุงุณุช ฺฉู ุขู ุฑุง ุจู ฺฉ **delegate** ฺฉุงููพุงู ฺฉูู:

```csharp
Func<string, bool> runnable = lambda.Compile();
Console.WriteLine(runnable("kangaroo"));   // False
Console.WriteLine(runnable("dog"));        // True
```

ุณุงุฏูโุชุฑู ุฑูุด ุจุฑุง ุชุนู ุงูฺฉู ฺฉุฏุงู ููุน **expression** ุฑุง ุจุงุฏ ุงุณุชูุงุฏู ฺฉุฑุฏุ ุงู ุงุณุช ฺฉู ฺฉ **lambda expression** ููุฌูุฏ ุฑุง ุฏุฑ **Visual Studio debugger** ุจุฑุฑุณ ฺฉูุฏ.

ูุง ุงุฏุงูู ุงู ุจุญุซ ุฑุง ุขููุงู ุงุฑุงุฆู ุฏุงุฏูโุงู ุฏุฑ: [http://www.albahari.com/expressions](http://www.albahari.com/expressions) โ
