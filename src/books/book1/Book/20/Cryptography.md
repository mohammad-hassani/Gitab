# ูุตู ุจุณุชู:  ุฑูุฒูฺฏุงุฑ

ุฏุฑ ุงู ูุตูุ ูุง ุจู ุจุฑุฑุณ APIูุง ุงุตู **Cryptography** ุฏุฑ .NET ูโูพุฑุฏุงุฒู:

* **Windows Data Protection API (DPAPI)**
* **Hashing**
* **Symmetric encryption**
* **Public key encryption and signing**

ุงููุงุน (Types) ูพูุดุด ุฏุงุฏู ุดุฏู ุฏุฑ ุงู ูุตู ุฏุฑ **namespace**ูุง ุฒุฑ ุชุนุฑู ุดุฏูโุงูุฏ:

```
System.Security;
System.Security.Cryptography;
```

---

### ูุฑูุฑ ฺฉู ๐

ุฌุฏูู **ฒฐ-ฑ** ุฎูุงุตูโุง ุงุฒ ฺฏุฒููโูุง **Cryptography** ุฏุฑ .NET ุฑุง ูุดุงู ูโุฏูุฏ. ุฏุฑ ุจุฎุดโูุง ุจุนุฏุ ูุฑ ฺฉ ุงุฒ ุงู ููุงุฑุฏ ุฑุง ุจู ุชูุตู ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/20/Table-20-1.jpeg)
</div>

### ูพุดุชุจุงูโูุง ูฺูโุชุฑ ุฏุฑ .NET โจ

.NET ููฺูู ูพุดุชุจุงูโูุง ุชุฎุตุตโุชุฑ ุจุฑุง **ุงุฌุงุฏ ู ุงุนุชุจุงุฑุณูุฌ ุงูุถุงูุง ูุจุชู ุจุฑ XML** ุฏุฑ `System.Security.Cryptography.Xml` ู ููฺูู **ุงููุงุน (Types) ูุฑุชุจุท ุจุง ฺฉุงุฑ ุจุง ฺฏูุงูโูุง ุฏุฌุชุงู** ุฏุฑ `System.Security.Cryptography.X509Certificates` ุงุฑุงุฆู ูโุฏูุฏ.

---

### Windows Data Protection ๐ช๐

ูฺฺฏ **Windows Data Protection** ููุท ุฑู ููุฏูุฒ ุฏุฑ ุฏุณุชุฑุณ ุงุณุช ู ุฏุฑ ุณุณุชูโุนุงููโูุง ุฏฺฏุฑ ฺฉ ุงุณุชุซูุงุก ุงุฒ ููุน `PlatformNotSupportedException` ุงุฌุงุฏ ูโฺฉูุฏ.

ุฏุฑ ุจุฎุด **โFile and Directory Operationsโ** ุฏุฑ ุตูุญู ทฒณ ุชูุถุญ ุฏุงุฏู ฺฉู ฺฺฏููู ูโุชูุงูุฏ ุงุฒ `File.Encrypt` ุจุฑุง ุฏุฑุฎูุงุณุช ุฑูุฒูฺฏุงุฑ ุดูุงู (transparent) ูุงู ุชูุณุท ุณุณุชูโุนุงูู ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
File.WriteAllText ("myfile.txt", "");
File.Encrypt ("myfile.txt");
File.AppendAllText ("myfile.txt", "sensitive data");
```

๐ ุฏุฑ ุงู ุญุงูุชุ ุฑูุฒูฺฏุงุฑ ุงุฒ ฺฉูุฏ ุงุณุชูุงุฏู ูโฺฉูุฏ ฺฉู ุงุฒ **ุฑูุฒ ุนุจูุฑ ฺฉุงุฑุจุฑ ูุงฺฏูโุดุฏู** ุงุณุชุฎุฑุงุฌ ุดุฏู ุงุณุช. ุดูุง ูโุชูุงูุฏ ููู ฺฉูุฏ ุงุณุชุฎุฑุงุฌโุดุฏู ุถูู ุฑุง ุจุฑุง ุฑูุฒูฺฏุงุฑ ฺฉ **ุขุฑุงูโ ุจุงุช** ุจุง ุงุณุชูุงุฏู ุงุฒ **Windows Data Protection API (DPAPI)** ุจูโฺฉุงุฑ ุจฺฏุฑุฏ.

DPAPI ุงุฒ ุทุฑู ฺฉูุงุณ `ProtectedData` ุฏุฑ ุฏุณุชุฑุณ ูุฑุงุฑ ฺฏุฑูุชู ุงุณุชุ ฺฉูุงุณ ุณุงุฏู ุจุง ุฏู ูุชุฏ **static**:

```csharp
public static byte[] Protect
 (byte[] userData, byte[] optionalEntropy, DataProtectionScope scope);

public static byte[] Unprotect
 (byte[] encryptedData, byte[] optionalEntropy, DataProtectionScope scope);
```

๐ ูุฑ ฺุฒ ฺฉู ุฏุฑ `optionalEntropy` ูุฑุงุฑ ุฏูุฏ ุจู ฺฉูุฏ ุงุถุงูู ูโุดูุฏ ู ุงููุช ุขู ุฑุง ุงูุฒุงุด ูโุฏูุฏ.
ูพุงุฑุงูุชุฑ `DataProtectionScope` ุฏู ฺฏุฒูู ุฏุงุฑุฏ:

* **CurrentUser** โ ฺฉูุฏ ุงุฒ ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ (credentials) ฺฉุงุฑุจุฑ ูุนู ุงุณุชุฎุฑุงุฌ ูโุดูุฏ.
* **LocalMachine** โ ฺฉ ฺฉูุฏ ุฏุฑ ุณุทุญ ฺฉู ุณุณุชู (machine-wide) ุงุณุชูุงุฏู ูโุดูุฏ ฺฉู ุจู ููู ฺฉุงุฑุจุฑุงู ูุดุชุฑฺฉ ุงุณุช.

โก๏ธ ุงู ุนู ุงฺฏุฑ **CurrentUser** ุงูุชุฎุงุจ ุดูุฏุ ุฏุงุฏูโูุง ุฑูุฒูฺฏุงุฑโุดุฏู ุชูุณุท ฺฉ ฺฉุงุฑุจุฑ ูุงุจู ุฑูุฒฺฏุดุง ุชูุณุท ฺฉุงุฑุจุฑ ุฏฺฏุฑ ูุฎูุงููุฏ ุจูุฏ. ุฏุฑ ุญุงูโฺฉู ฺฉูุฏ **LocalMachine** ุงููุช ฺฉูุชุฑ ุฏุงุฑุฏุ ุงูุง ุจุฑุง ุณุฑูุณโูุง ููุฏูุฒ ุง ุจุฑูุงููโูุง ฺฉู ุจุงุฏ ุชุญุช ุญุณุงุจโูุง ูุฎุชูู ฺฉุงุฑ ฺฉููุฏุ ููุงุณุจ ุงุณุช.

---

### ูููููโุง ุณุงุฏู ุงุฒ ุฑูุฒูฺฏุงุฑ ู ุฑูุฒฺฏุดุง ๐งฉ

```csharp
byte[] original = {1, 2, 3, 4, 5};
DataProtectionScope scope = DataProtectionScope.CurrentUser;
byte[] encrypted = ProtectedData.Protect (original, null, scope);
byte[] decrypted = ProtectedData.Unprotect (encrypted, null, scope);
// decrypted is now {1, 2, 3, 4, 5}
```

๐ก Windows Data Protection ุงููุช ูุชูุณุท ุฏุฑ ุจุฑุงุจุฑ ููุงุฌู ฺฉู ุฏุณุชุฑุณ ฺฉุงูู ุจู ุฑุงุงูู ุฏุงุฑุฏ ูุฑุงูู ูโฺฉูุฏุ ุงู ููุถูุน ุจุณุชฺฏ ุจู ูุฏุฑุช ุฑูุฒ ุนุจูุฑ ฺฉุงุฑุจุฑ ุฏุงุฑุฏ.
ุจุง **LocalMachine**ุ ุงู ุฑูุด ููุท ุฏุฑ ุจุฑุงุจุฑ ฺฉุณุงู ฺฉู ุฏุณุชุฑุณ ูุฒฺฉ ุง ุงูฺฉุชุฑููฺฉ ูุญุฏูุฏ ุฏุงุฑูุฏ ูุคุซุฑ ุงุณุช.

---

### Hashing ๐๐

ฺฉ **ุงูฺฏูุฑุชู Hashing** ุญุฌู ุจุฒุฑฺฏ ุงุฒ ุฏุงุฏูโูุง ุฑุง ุจู ฺฉ **ฺฉุฏ ุซุงุจุช ู ฺฉูฺฺฉ (hashcode)** ุชุจุฏู ูโฺฉูุฏ.
ุงู ุงูฺฏูุฑุชูโูุง ุทูุฑ ุทุฑุงุญ ุดุฏูโุงูุฏ ฺฉู ุญุช ุงฺฏุฑ ุชููุง ฺฉ ุจุช ุฏุฑ ุฏุงุฏูโ ุงุตู ุชุบุฑ ฺฉูุฏุ ูุชุฌูโ **hashcode** ฺฉุงููุงู ูุชูุงูุช ุฎูุงูุฏ ุจูุฏ.

๐ ุงู ูฺฺฏ ุจุงุนุซ ูโุดูุฏ ฺฉู hashing ุจุฑุง **ููุงุณู ูุงูโูุง** ุง **ุชุดุฎุต ุฎุฑุงุจโูุง ุชุตุงุฏู (ุง ูุฎุฑุจ) ุฏุฑ ูุงู ุง ุฌุฑุงู ุฏุงุฏู (data stream)** ุจุณุงุฑ ููุงุณุจ ุจุงุดุฏ.

ุนูุงูู ุจุฑ ุงูุ **Hashing ููุน ุฑูุฒูฺฏุงุฑ ฺฉโุทุฑูู** ูุญุณูุจ ูโุดูุฏุ ุฒุฑุง ุจุงุฒฺฏุฑุฏุงูุฏู hashcode ุจู ุฏุงุฏู ุงุตู ุชูุฑุจุงู ุบุฑููฺฉู ุงุณุช.
ุจู ููู ุฏููุ ุฐุฎุฑูโุณุงุฒ ุฑูุฒ ุนุจูุฑ ุฏุฑ ูพุงฺฏุงู ุฏุงุฏู ุจูโุตูุฑุช hash ฺฉ ุฑูุด ุงูู ุงุณุช.
๐ ุงฺฏุฑ ูพุงฺฏุงู ุฏุงุฏู ุดูุง ุจู ุฎุทุฑ ุจูุชุฏุ ููุงุฌู ุจู ุฑูุฒ ุนุจูุฑูุง ูุชู ุณุงุฏู (plain-text) ุฏุณุชุฑุณ ูพุฏุง ูุฎูุงูุฏ ฺฉุฑุฏ.
ุจุฑุง ุงุญุฑุงุฒ ููุชุ ฺฉุงู ุงุณุช ูุฑูุฏ ฺฉุงุฑุจุฑ ุฑุง hash ฺฉุฑุฏู ู ุจุง ููุฏุงุฑ ุฐุฎุฑูโุดุฏู ุฏุฑ ูพุงฺฏุงู ุฏุงุฏู ููุงุณู ฺฉูุฏ.

---

### ุงุณุชูุงุฏู ุงุฒ ComputeHash ๐ฅ

ุจุฑุง ุชููุฏ hashุ ูุชุฏ `ComputeHash` ุงุฒ ฺฉ ุงุฒ ุฒุฑฺฉูุงุณโูุง `HashAlgorithm` (ูุซู `SHA1` ุง `SHA256`) ูุฑุงุฎูุงู ูโุดูุฏ:

```csharp
byte[] hash;
using (Stream fs = File.OpenRead ("checkme.doc"))
  hash = SHA1.Create().ComputeHash (fs);   // SHA1 hash is 20 bytes long
```

ูุชุฏ `ComputeHash` ููฺูู ฺฉ **ุขุฑุงูโ ุจุงุช** ุฑุง ูโูพุฐุฑุฏ ฺฉู ุจุฑุง hash ฺฉุฑุฏู ุฑูุฒูุง ุนุจูุฑ ุจุณุงุฑ ฺฉุงุฑุจุฑุฏ ุงุณุช (ุฑูุด ุงููโุชุฑ ุฏุฑ ุจุฎุด **โHashing Passwordsโ** ุฏุฑ ุตูุญู ธทธ ุชูุถุญ ุฏุงุฏู ุดุฏู ุงุณุช):

```csharp
byte[] data = System.Text.Encoding.UTF8.GetBytes ("stRhong%pword");
byte[] hash = SHA256.Create().ComputeHash (data);
```

๐ ูุชุฏ `GetBytes` ุฏุฑ ฺฉ ุดุก ุงุฒ ููุน `Encoding`ุ ฺฉ ุฑุดุชู (string) ุฑุง ุจู ุขุฑุงูโ ุจุงุช ุชุจุฏู ูโฺฉูุฏุ ูุชุฏ `GetString` ุขู ุฑุง ุจุฑุนฺฉุณ ุจุฑูโฺฏุฑุฏุงูุฏ.
ุงูุง ฺฉ ุดุก `Encoding` ููโุชูุงูุฏ ฺฉ ุขุฑุงูโ ุจุงุช ุฑูุฒูฺฏุงุฑโุดุฏู ุง hash ุดุฏู ุฑุง ุจู ุฑุดุชู ุจุฑฺฏุฑุฏุงูุฏุ ฺูู ุฏุงุฏูโ scramble ุดุฏู ูุนูููุงู ููุงูู encoding ูุชู ุฑุง ููุถ ูโฺฉูุฏ.

ุจู ุฌุง ุขู ุจุงุฏ ุงุฒ ูุชุฏูุง ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:

* `Convert.ToBase64String`
* `Convert.FromBase64String`

ุงูโูุง ุชุจุฏู ุจู ูุฑ **ุขุฑุงูโ ุจุงุช** ู ฺฉ ุฑุดุชู ูุนุชุจุฑ (ู ุณุงุฒฺฏุงุฑ ุจุง XML ุง JSON) ุฑุง ุงูุฌุงู ูโุฏููุฏ.

---

### ุงูฺฏูุฑุชูโูุง Hash ุฏุฑ .NET ๐งฎ

`SHA1` ู `SHA256` ุฏู ููููู ุงุฒ ุฒุฑููุนโูุง `HashAlgorithm` ูุณุชูุฏ ฺฉู ุชูุณุท .NET ุงุฑุงุฆู ุดุฏูโุงูุฏ.
ูููโุชุฑู ุงูฺฏูุฑุชูโูุงุ ุจู ุชุฑุชุจ **ุงูุฒุงุด ุงููุช** ุนุจุงุฑุชโุงูุฏ ุงุฒ: โฆ

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/20/Table-20-2.jpeg)
</div>

### ุงูฺฏูุฑุชูโูุง Hash ุฏุฑ .NET ๐งฎ

ุชูุงู ูพูุฌ ุงูฺฏูุฑุชู ุฏุฑ ูพุงุฏูโุณุงุฒโูุง ูุนู ุชูุฑุจุงู ุจุง ุณุฑุนุช ูุดุงุจู ุงุฌุฑุง ูโุดููุฏุ ุจู ุฌุฒ **SHA256** ฺฉู ุญุฏูุฏ ฒ ุชุง ณ ุจุฑุงุจุฑ ุณุฑุนโุชุฑ ุงุณุช (ุงู ููุถูุน ูโุชูุงูุฏ ุจุณุชู ุจู ุณุฎุชโุงูุฒุงุฑ ู ุณุณุชูโุนุงูู ูุชูุงูุช ุจุงุดุฏ).

๐ ุจูโุทูุฑ ุชูุฑุจ ูโุชูุงูุฏ ุงูุชุธุงุฑ ุณุฑุนุช ุญุฏุงูู **ตฐฐ ูฺฏุงุจุงุช ุฏุฑ ุซุงูู** ุฑุง ุฑู ฺฉ ุฏุณฺฉุชุงูพ ุง ุณุฑูุฑ ุณุงู ฒฐฒด ุงุฒ ุชูุงู ุงู ุงูฺฏูุฑุชูโูุง ุฏุงุดุชู ุจุงุดุฏ.

๐ ูุฑฺู ุทูู hash ุจุดุชุฑ ุจุงุดุฏุ ุงุญุชูุงู **collision** (ุนู ุชููุฏ ฺฉ hash ูุดุงุจู ุงุฒ ุฏู ูุงู ูุชูุงูุช) ฺฉุงูุด ูโุงุจุฏ. ุจูุงุจุฑุงู:

* ููฺฏุงู **hash ฺฉุฑุฏู ุฑูุฒ ุนุจูุฑูุง** ุง ุฏุงุฏูโูุง ุญุณุงุณ ุงููุชุ ุญุฏุงูู ุงุฒ **SHA256** ุงุณุชูุงุฏู ฺฉูุฏ.
* ุงูฺฏูุฑุชูโูุง **MD5** ู **SHA1** ุงุฒ ูุธุฑ ุงููุช ุถุนู ูุญุณูุจ ูโุดููุฏ ู ุชููุง ุจุฑุง ูุญุงูุธุช ุฏุฑ ุจุฑุงุจุฑ ุฎุฑุงุจโูุง ุชุตุงุฏู ููุงุณุจโุงูุฏุ ูู ุฏุณุชฺฉุงุฑโูุง ุนูุฏ.

ุฏุฑ .NET 8 ู ุจุงูุงุชุฑุ ูพุดุชุจุงู ุงุฒ ุขุฎุฑู ุงุณุชุงูุฏุงุฑุฏ **SHA-3** ูุฒ ุงุถุงูู ุดุฏู ุงุณุชุ ุดุงูู ฺฉูุงุณโูุง:

* `SHA3_256`
* `SHA3_384`
* `SHA3_512`

ุงูฺฏูุฑุชูโูุง SHA-3 ุงุฒ ุงูฺฏูุฑุชูโูุง ูุจู **ุงููโุชุฑ (ู ุงูุจุชู ฺฉูุฏุชุฑ)** ูุณุชูุฏุ ุงูุง ุจู **Windows Build 25324+** ุง **Linux ุจุง OpenSSL 1.1.1+** ูุงุฒ ุฏุงุฑูุฏ.
ูโุชูุงูุฏ ูพุดุชุจุงู ุณุณุชูโุนุงูู ุฑุง ุงุฒ ุทุฑู ูฺฺฏ **static** ุจู ูุงู `IsSupported` ุฏุฑ ุงู ฺฉูุงุณโูุง ุจุฑุฑุณ ฺฉูุฏ.

---

### Hashing Passwords ๐๐ง

ุงูฺฏูุฑุชูโูุง SHA ุจุง ุทูู ุจุดุชุฑ ุจุฑุง hash ฺฉุฑุฏู ุฑูุฒ ุนุจูุฑูุง ููุงุณุจโุงูุฏุ ุจู ุดุฑุท ฺฉู ฺฉ **ุณุงุณุช ุฑูุฒ ุนุจูุฑ ูู** ุงุนูุงู ฺฉูุฏ ุชุง ุงุฒ ุญูููโ **dictionary attack** ุฌููฺฏุฑ ุดูุฏ.
๐ ุฏุฑ ุงู ููุน ุญูููุ ููุงุฌู ุฌุฏูู ุงุฒ ุฑูุฒูุง ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู ุดุงูู hash ุชูุงู ฺฉููุงุช ููุฌูุฏ ุฏุฑ ฺฉ ูุฑููฺฏ ูุบุช ุงุณุช.

โ ฺฉ ุชฺฉูฺฉ ุงุณุชุงูุฏุงุฑุฏ ููฺฏุงู hash ฺฉุฑุฏู ุฑูุฒูุงุ ุงุณุชูุงุฏู ุงุฒ **salt** ุงุณุช:
ฺฉ ุฏูุจุงููโ ุทููุงู ุงุฒ ุจุงุชโูุง ฺฉู ุงุจุชุฏุง ุจุง ฺฉ **ุชููุฏฺฉููุฏู ุงุนุฏุงุฏ ุชุตุงุฏู** ุจู ุฏุณุช ูโุขุฏ ู ุณูพุณ ูพุด ุงุฒ hash ุดุฏูุ ุจุง ุฑูุฒ ุนุจูุฑ ุชุฑฺฉุจ ูโุดูุฏ.

ุงู ฺฉุงุฑ ุฏู ูุฒุช ููู ุฏุงุฑุฏ:

* ููุงุฌู ุจุงุฏ ุงุฒ ุจุงุชโูุง salt ูู ุงุทูุงุน ุฏุงุดุชู ุจุงุดุฏ.
* ุงุณุชูุงุฏู ุงุฒ **rainbow tables** (ูพุงฺฏุงูโูุง ุฏุงุฏูโ ุงุฒ ูพุด ูุญุงุณุจูโุดุฏูโ ุฑูุฒูุง ู hash ุขูโูุง) ุจโุงุซุฑ ูโุดูุฏุ ูุฑฺูุฏ ุญูููโ dictionary ููฺูุงู ุจุง ูุฏุฑุช ูุญุงุณุจุงุช ฺฉุงู ููฺฉู ุงุณุช.

---

### Password Stretching โณ

ูโุชูุงูุฏ ุงููุช ุฑุง ุจุง ุชฺฉูฺฉ **stretching** ุชููุช ฺฉูุฏุ ุนู ุจุง **ุชฺฉุฑุงุฑ ฺูุฏุจุงุฑู hash ฺฉุฑุฏู**ุ ูุฑุขูุฏ ุชููุฏ hash ุฑุง ูุญุงุณุจุงุชโุชุฑ ฺฉูุฏ.

ุจูโุนููุงู ูุซุงู:
ุงฺฏุฑ ฑฐฐ ุจุงุฑ rehash ฺฉูุฏุ ุญูููโ dictionary ฺฉู ุดุงุฏ ฺฉ ูุงู ุทูู ุจฺฉุดุฏุ ุงฺฉููู ุญุฏูุฏ **ธ ุณุงู** ุฒูุงู ุฎูุงูุฏ ุจุฑุฏ.

ฺฉูุงุณโูุง ุฒุฑ ุฏููุงู ููู ููุน stretching ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉููุฏ ู ููฺูู ุงูฺฉุงู ุงุณุชูุงุฏู ุขุณุงู ุงุฒ salting ุฑุง ูุฑุงูู ูโุขูุฑูุฏ:

* `KeyDerivation`
* `Rfc2898DeriveBytes`
* `PasswordDeriveBytes`

ุงุฒ ูุงู ุขูโูุงุ ุจูุชุฑู ุงูุชุฎุงุจ:
**`KeyDerivation.Pbkdf2`** โ

ูุซุงู:

```csharp
byte[] encrypted = KeyDerivation.Pbkdf2 (
   password: "stRhong%pword",
   salt: Encoding.UTF8.GetBytes ("j78Y#p)/saREN!y3@"),
   prf: KeyDerivationPrf.HMACSHA512,
   iterationCount: 100,
   numBytesRequested: 64);
```

๐ฆ `KeyDerivation.Pbkdf2` ูุงุฒููุฏ ูุตุจ ุจุณุชูโ NuGet ุจู ูุงู:
`Microsoft.AspNetCore.Cryptography.KeyDerivation` ุงุณุช.
ุงฺฏุฑฺู ุงู ฺฉูุงุณ ุฏุฑ **namespace** ูุฑุจูุท ุจู ASP.NET Core ูุฑุงุฑ ุฏุงุฑุฏุ ุงูุง ูุฑ ุจุฑูุงููโ .NET ูโุชูุงูุฏ ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุฏ.

---

### Symmetric Encryption ๐โ๏ธ

ุฏุฑ **ุฑูุฒูฺฏุงุฑ ูุชูุงุฑู (Symmetric Encryption)**ุ ฺฉ ฺฉูุฏ ฺฉุณุงู ุจุฑุง **ุฑูุฒูฺฏุงุฑ (encryption)** ู **ุฑูุฒฺฏุดุง (decryption)** ุงุณุชูุงุฏู ูโุดูุฏ.

ฺฉุชุงุจุฎุงูู ูพุงูโ .NET (BCL) ฺูุงุฑ ุงูฺฏูุฑุชู ูุชูุงุฑู ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุฏุฑ ูุงู ุขูโูุงุ **Rijndael** (ุชููุธ: "ุฑุงูโุฏุงู" ุง "ุฑูโุฏุงู") ุจูุชุฑู ฺฏุฒูู ุงุณุชุ ุฏฺฏุฑ ุงูฺฏูุฑุชูโูุง ุนูุฏุชุงู ุจุฑุง ุณุงุฒฺฏุงุฑ ุจุง ุจุฑูุงููโูุง ูุฏู ุงุณุชูุงุฏู ูโุดููุฏ.

โจ **Rijndael** ุณุฑุน ู ุงูู ุงุณุช ู ุฏุฑ ุฏู ูพุงุฏูโุณุงุฒ ุงุฑุงุฆู ูโุดูุฏ:

* `Rijndael`
* `Aes`

ุงู ุฏู ุชูุฑุจุงู ูุดุงุจูโุงูุฏุ ุจุง ุงู ุชูุงูุช ฺฉู `Aes` ุงุฌุงุฒู ููโุฏูุฏ ุงูุฏุงุฒูโ ุจููฺฉ (block size) ุฑุง ุชุบุฑ ุฏูุฏ ู ุฑูุฒูฺฏุงุฑ ุฑุง ุถุนู ฺฉูุฏ.
๐ ุชู ุงููุช CLR ุงุณุชูุงุฏู ุงุฒ **Aes** ุฑุง ุชูุตู ูโฺฉูุฏ.

ูุฑ ุฏู ุงูฺฏูุฑุชู ฺฉูุฏูุง ูุชูุงุฑู ุจุง ุทูู **ฑถุ ฒด ุง ณฒ ุจุงุช** ุฑุง ูพุดุชุจุงู ูโฺฉููุฏ ฺฉู ููฺฏ ุฏุฑ ุญุงู ุญุงุถุฑ ุงูู ูุญุณูุจ ูโุดููุฏ.

---

### ููููู ุฑูุฒูฺฏุงุฑ ๐

ุฑูุฒูฺฏุงุฑ ฺฉ ุขุฑุงูโ ุจุงุช ููฺฏุงู ููุดุชู ุฏุฑ ูุงู ุจุง ฺฉูุฏ ฑถ ุจุงุช:

```csharp
byte[] key = {145,12,32,245,98,132,98,214,6,77,131,44,221,3,9,50};
byte[] iv  = {15,122,132,5,93,198,44,31,9,39,241,49,250,188,80,7};
byte[] data = { 1, 2, 3, 4, 5 };   // ุฏุงุฏูโุง ฺฉู ุฑูุฒูฺฏุงุฑ ูโฺฉูู.
using (SymmetricAlgorithm algorithm = Aes.Create())
using (ICryptoTransform encryptor = algorithm.CreateEncryptor (key, iv))
using (Stream f = File.Create ("encrypted.bin"))
using (Stream c = new CryptoStream (f, encryptor, CryptoStreamMode.Write))
 c.Write (data, 0, data.Length);
```

---

### ููููู ุฑูุฒฺฏุดุง ๐

```csharp
byte[] key = {145,12,32,245,98,132,98,214,6,77,131,44,221,3,9,50};
byte[] iv  = {15,122,132,5,93,198,44,31,9,39,241,49,250,188,80,7};
byte[] decrypted = new byte[5];
using (SymmetricAlgorithm algorithm = Aes.Create())
using (ICryptoTransform decryptor = algorithm.CreateDecryptor (key, iv))
using (Stream f = File.OpenRead ("encrypted.bin"))
using (Stream c = new CryptoStream (f, decryptor, CryptoStreamMode.Read))
 for (int b; (b = c.ReadByte()) > -1;)
   Console.Write (b + " ");   // ุฎุฑูุฌ: 1 2 3 4 5
```

โก๏ธ ุฏุฑ ุงู ูุซุงูุ ฺฉ ฺฉูุฏ ฑถ ุจุงุช ุจูโุทูุฑ ุชุตุงุฏู ุณุงุฎุชู ุดุฏู ุงุณุช. ุงฺฏุฑ ฺฉูุฏ ุงุดุชุจุงู ุจุฑุง ุฑูุฒฺฏุดุง ุงุณุชูุงุฏู ุดูุฏุ `CryptoStream` ฺฉ ุงุณุชุซูุงุก ุงุฒ ููุน `CryptographicException` ุงุฌุงุฏ ูโฺฉูุฏ. ฺฏุฑูุชู ุงู ุงุณุชุซูุงุก ุชููุง ุฑุงู ุจุฑุง ุจุฑุฑุณ ุฏุฑุณุช ฺฉูุฏ ุงุณุช.

---

### ููุด IV (Initialization Vector) ๐ฒ

ุนูุงูู ุจุฑ ฺฉูุฏุ ูุง ฺฉ **IV (Initialization Vector)** ูู ุงุฌุงุฏ ฺฉุฑุฏู.
ุงู ุฏูุจุงููโ ฑถ ุจุงุช ุจุฎุด ุงุฒ ุงูฺฏูุฑุชู ุฑูุฒูฺฏุงุฑ ุงุณุชุ ุดุจู ุจู ฺฉูุฏุ ุงูุง ูุญุฑูุงูู ูุญุณูุจ ููโุดูุฏ.

๐ฉ ุงฺฏุฑ ูพุงู ุฑูุฒูฺฏุงุฑโุดุฏู ุฑุง ููุชูู ฺฉูุฏุ ูุนูููุงู IV ุฑุง ุจูโุตูุฑุช **plain text** (ูุซูุงู ุฏุฑ ูุฏุฑ ูพุงู) ุงุฑุณุงู ฺฉุฑุฏู ู ุฏุฑ ูุฑ ูพุงู ุขู ุฑุง ุชุบุฑ ูโุฏูุฏ.
ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ูุฑ ูพุงู ุฑูุฒูฺฏุงุฑโุดุฏู ุจุง ูพุงูโูุง ูุจู ุบุฑูุงุจู ุชุดุฎุต ุจุงุดุฏโeven ุงฺฏุฑ ูุณุฎูโ ูุชู (unencrypted) ุขูโูุง ูุดุงุจู ุง ฺฉุณุงู ุจุงุดูุฏ.

* ุงฺฏุฑ ููโุฎูุงูุฏ ุงุฒ IV ุงุณุชูุงุฏู ฺฉูุฏุ ูโุชูุงูุฏ ฺฉ ููุฏุงุฑ ฑถ ุจุงุช ฺฉุณุงู ุฑุง ูู ุจูโุนููุงู ฺฉูุฏ ู ูู ุจูโุนููุงู IV ุจู ฺฉุงุฑ ุจุจุฑุฏ.
  โ๏ธ ุงูุง ุงุณุชูุงุฏู ุงุฒ ฺฉ IV ุซุงุจุช ุฏุฑ ฺูุฏ ูพุงูุ ุฑูุฒูฺฏุงุฑ ุฑุง ุถุนู ฺฉุฑุฏู ู ููฺฉู ุงุณุช ุขู ุฑุง ูุงุจู ูููุฐ ฺฉูุฏ.

---

### ููุด ฺฉูุงุณโูุง ๐จโ๐ง๐จโ๐ซ

* **Aes** โ ุฑุงุถโุฏุงู ุงุณุชุ ุงูฺฏูุฑุชู ุฑูุฒูฺฏุงุฑ ู ุนููุงุช Encryptor/Decryptor ุฑุง ุงุนูุงู ูโฺฉูุฏ.
* **CryptoStream** โ ููููโฺฉุด ุงุณุชุ ูุฏุฑุช ุฌุฑุงู ุฏุงุฏู (stream plumbing) ุฑุง ุจุฑ ุนูุฏู ุฏุงุฑุฏ.

ุดูุง ูโุชูุงูุฏ **Aes** ุฑุง ุจุง ฺฉ ุงูฺฏูุฑุชู ูุชูุงุฑู ุฏฺฏุฑ ุฌุงฺฏุฒู ฺฉูุฏุ ุงูุง ููฺูุงู ุงุฒ **CryptoStream** ุงุณุชูุงุฏู ฺฉูุฏ.

๐ `CryptoStream` ุฏูุทุฑูู ุงุณุชุ ุจุณุชู ุจู ุงูุชุฎุงุจ ุดูุง (`CryptoStreamMode.Read` ุง `CryptoStreamMode.Write`) ูโุชูุงูุฏ ุจุฑุง ุฎูุงูุฏู ุง ููุดุชู ุงุณุชูุงุฏู ุดูุฏ.
ูุฑ ุฏู Encryptor ู Decryptor ุชูุงูุง ุฎูุงูุฏู ู ููุดุชู ุฏุงุฑูุฏ ู ฺูุงุฑ ุชุฑฺฉุจ ููฺฉู ุงุฌุงุฏ ูโฺฉููุฏโุงู ูโุชูุงูุฏ ฺฏุงู ููุฌุจ ฺฏุฌ ุดุฏู ุดูุง ุดูุฏ!

๐ ุงฺฏุฑ ูุทูุฆู ูุณุชุฏ:

* ุจุฑุง ุฑูุฒูฺฏุงุฑ ุงุฒ **Write** ุดุฑูุน ฺฉูุฏ.
* ุจุฑุง ุฑูุฒฺฏุดุง ุงุฒ **Read** ุดุฑูุน ฺฉูุฏ.

ุงู ุญุงูุช ูุนูููุงู ุทุจุนโุชุฑู ุงูุชุฎุงุจ ุงุณุช.

---

### ุชููุฏ ฺฉูุฏ ู IV ุชุตุงุฏู ๐ฒ

ุจุฑุง ุชููุฏ ฺฉ ฺฉูุฏ ุง IV ุชุตุงุฏูุ ุงุฒ `RandomNumberGenerator` ุฏุฑ `System.Cryptography` ุงุณุชูุงุฏู ฺฉูุฏ.
ุงุนุฏุงุฏ ฺฉู ุงู ฺฉูุงุณ ุชููุฏ ูโฺฉูุฏ ูุงูุนุงู ุบุฑูุงุจู ูพุดโุจู ู **cryptographically strong** ูุณุชูุฏ (ุจุฑุฎูุงู `System.Random`).

ูุซุงู:

```csharp
byte[] key = new byte [16];
byte[] iv  = new byte [16];
RandomNumberGenerator rand = RandomNumberGenerator.Create();
rand.GetBytes (key);
rand.GetBytes (iv);
```

ุงุฒ .NET 6 ุจู ุจุนุฏ:

```csharp
byte[] key = RandomNumberGenerator.GetBytes (16);
byte[] iv = RandomNumberGenerator.GetBytes (16);
```

ุงฺฏุฑ ฺฉูุฏ ู IV ูุดุฎุต ูฺฉูุฏุ ููุงุฏุฑ ุชุตุงุฏู ูู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุชููุฏ ูโุดููุฏ.
ูโุชูุงูุฏ ุงู ููุงุฏุฑ ุฑุง ุงุฒ ุทุฑู ูฺฺฏโูุง `Key` ู `IV` ุฏุฑ ุดุก `Aes` ุฏุฑุงูุช ฺฉูุฏ.

### ๐ ุฑูุฒูฺฏุงุฑ ุฏุฑ ุญุงูุธู

ุงุฒ **.NET 6** ุจู ุจุนุฏุ ูโุชูุงูุฏ ุจุฑุง ุณุงุฏูโุณุงุฒ ูุฑุขูุฏ ุฑูุฒูฺฏุงุฑ ู ุฑูุฒฺฏุดุง ุขุฑุงูโูุง ุจุงุช ุงุฒ ูุชุฏูุง **EncryptCbc** ู **DecryptCbc** ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
public static byte[] Encrypt (byte[] data, byte[] key, byte[] iv)
{
    using Aes algorithm = Aes.Create();
    algorithm.Key = key;
    return algorithm.EncryptCbc(data, iv);
}

public static byte[] Decrypt (byte[] data, byte[] key, byte[] iv)
{
    using Aes algorithm = Aes.Create();
    algorithm.Key = key;
    return algorithm.DecryptCbc(data, iv);
}
```

---

### โ๏ธ ูุนุงุฏู ุณุงุฒฺฏุงุฑ ุจุง ููู ูุณุฎูโูุง .NET

ุฏุฑ ูุณุฎูโูุง ูุฏูโุชุฑุ ุจุงุฏ ุงุฒ **ICryptoTransform** ู **CryptoStream** ุงุณุชูุงุฏู ฺฉูู:

```csharp
public static byte[] Encrypt (byte[] data, byte[] key, byte[] iv)
{
    using (Aes algorithm = Aes.Create())
    using (ICryptoTransform encryptor = algorithm.CreateEncryptor(key, iv))
        return Crypt(data, encryptor);
}

public static byte[] Decrypt (byte[] data, byte[] key, byte[] iv)
{
    using (Aes algorithm = Aes.Create())
    using (ICryptoTransform decryptor = algorithm.CreateDecryptor(key, iv))
        return Crypt(data, decryptor);
}

static byte[] Crypt (byte[] data, ICryptoTransform cryptor)
{
    MemoryStream m = new MemoryStream();
    using (Stream c = new CryptoStream(m, cryptor, CryptoStreamMode.Write))
        c.Write(data, 0, data.Length);
    return m.ToArray();
}
```

> ๐ ุชูุฌู: ุญุงูุช **CryptoStreamMode.Write** ูู ุจุฑุง ุฑูุฒูฺฏุงุฑ ู ูู ุจุฑุง ุฑูุฒฺฏุดุง ููุงุณุจ ุงุณุชุ ุฒุฑุง ุฏุฑ ูุฑ ุฏู ุญุงูุช ุฏุงุฏูโูุง ุฑุง ุจู ุฏุงุฎู ฺฉ **MemoryStream** ุชุงุฒู "ูพูุด" ูโฺฉูู.

---

### ๐ ูุณุฎู ูุฎุตูุต ุฑุดุชูโูุง (String)

```csharp
public static string Encrypt (string data, byte[] key, byte[] iv)
{
    return Convert.ToBase64String(
        Encrypt(Encoding.UTF8.GetBytes(data), key, iv));
}

public static string Decrypt (string data, byte[] key, byte[] iv)
{
    return Encoding.UTF8.GetString(
        Decrypt(Convert.FromBase64String(data), key, iv));
}
```

**ููููู ุงุณุชูุงุฏู:**

```csharp
byte[] key = new byte[16];
byte[] iv = new byte[16];
var cryptoRng = RandomNumberGenerator.Create();
cryptoRng.GetBytes(key);
cryptoRng.GetBytes(iv);

string encrypted = Encrypt("Yeah!", key, iv);
Console.WriteLine(encrypted);   // R1/5gYvcxyR2vzPjnT7yaQ==
string decrypted = Decrypt(encrypted, key, iv);
Console.WriteLine(decrypted);   // Yeah!
```

---

### โ๏ธ ุฒูุฌุฑูโุณุงุฒ ุงุณุชุฑูโูุง (Chaining Streams)

ุงุฒ ุขูโุฌุง ฺฉู **CryptoStream ฺฉ ุฏฺฉูุฑุชูุฑ** ุงุณุชุ ูโุชูุงูุฏ ุขู ุฑุง ุจุง ุณุงุฑ ุงุณุชุฑูโูุง ุฒูุฌุฑู ฺฉูุฏ. ุฏุฑ ูุซุงู ุฒุฑุ ฺฉ ูุชู ูุดุฑุฏู ู ุฑูุฒูฺฏุงุฑโุดุฏู ุฑุง ุฏุฑ ูุงู ุฐุฎุฑู ฺฉุฑุฏู ู ุณูพุณ ุจุงุฒุงุจ ูโฺฉูู:

```csharp
byte[] key = new byte[16];
byte[] iv = new byte[16];
var cryptoRng = RandomNumberGenerator.Create();
cryptoRng.GetBytes(key);
cryptoRng.GetBytes(iv);

using (Aes algorithm = Aes.Create())
{
    using (ICryptoTransform encryptor = algorithm.CreateEncryptor(key, iv))
    using (Stream f = File.Create("serious.bin"))
    using (Stream c = new CryptoStream(f, encryptor, CryptoStreamMode.Write))
    using (Stream d = new DeflateStream(c, CompressionMode.Compress))
    using (StreamWriter w = new StreamWriter(d))
        await w.WriteLineAsync("Small and secure!");

    using (ICryptoTransform decryptor = algorithm.CreateDecryptor(key, iv))
    using (Stream f = File.OpenRead("serious.bin"))
    using (Stream c = new CryptoStream(f, decryptor, CryptoStreamMode.Read))
    using (Stream d = new DeflateStream(c, CompressionMode.Decompress))
    using (StreamReader r = new StreamReader(d))
        Console.WriteLine(await r.ReadLineAsync());   // Small and secure!
}
```

๐ ุฏุฑ ุงู ูุซุงูุ ููู ูุชุบุฑูุง ฺฉโุญุฑู ุจุฎุด ุงุฒ ุฒูุฌุฑู ูุณุชูุฏ. ุงุฌุฒุง ุงุตู ูุซู **algorithm**ุ **encryptor** ู **decryptor** ุฏุฑ ูุงูุน ุจู **CryptoStream** ฺฉูฺฉ ูโฺฉููุฏ ุชุง ุนููุงุช ุฑูุฒูฺฏุงุฑ ู ุฑูุฒฺฏุดุง ุงูุฌุงู ุดูุฏ.

---

โก ูฺฉุชู ููู: ุฒูุฌุฑูโุณุงุฒ ุงุณุชุฑูโูุง ุจู ุงู ุดฺฉูุ ุจุงุนุซ ูโุดูุฏ ฺฉู ุตุฑูโูุธุฑ ุงุฒ ุงูุฏุงุฒู ูุงู ุง ุฏุงุฏูุ ูุตุฑู ุญุงูุธู ุจุณุงุฑ ฺฉู ุจุงู ุจูุงูุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/20/Table-20-3.jpeg)
</div>

### ๐งน ูพุงฺฉโุณุงุฒ ุงุดุง ุฑูุฒูฺฏุงุฑ (Disposing Encryption Objects)

ููุช ฺฉ **CryptoStream** ุฑุง Dispose ูโฺฉูุฏุ ฺฉุด ุฏุงุฎู ุขู ุจู ุงุณุชุฑู ุฒุฑู ููุชูู (Flush) ูโุดูุฏ. ุงู ฺฉุด ุฏุงุฎู ุจุฑุง ุงูฺฏูุฑุชูโูุง ุฑูุฒูฺฏุงุฑ ูุงุฒู ุงุณุชุ ฺูู ุขูโูุง ุฏุงุฏูโูุง ุฑุง ุจู ุตูุฑุช **ุจููฺฉโูุง ุฏุงุฏู** ูพุฑุฏุงุฒุด ูโฺฉููุฏุ ูู ุจุงุช ุจู ุจุงุช.

๐ ูฺฉุชู:

* ูุชุฏ **Flush** ุฏุฑ CryptoStream ูฺ ฺฉุงุฑ ุงูุฌุงู ููโุฏูุฏ.
* ุจุฑุง *ููุงุด ฺฉุฑุฏู ุจุฏูู Dispose ฺฉุฑุฏู* ุจุงุฏ ุงุฒ **FlushFinalBlock** ุงุณุชูุงุฏู ฺฉูุฏ. ุงู ูุชุฏ ููุท ฺฉ ุจุงุฑ ูุงุจู ูุฑุงุฎูุงู ุงุณุช ู ุจุนุฏ ุงุฒ ุขู ุฏฺฏุฑ ููโุชูุงูุฏ ุฏุงุฏูโุง ุจููุณุฏ.

ูุง ููฺูู ุงุดุง **Aes** ู **ICryptoTransform** (ุนู `algorithm`, `encryptor`, `decryptor`) ุฑุง Dispose ูโฺฉูู. ููุช ุงู Transformูุง Dispose ุดููุฏุ ฺฉูุฏ ูุชูุงุฑู ู ุฏุงุฏูโูุง ูุฑุชุจุท ุงุฒ ุญุงูุธู ูพุงฺฉ ูโุดููุฏ. ุงู ฺฉุงุฑ ุฌูู ฺฉุดู ฺฉูุฏ ุชูุณุท ูุฑูโุงูุฒุงุฑูุง ูุฎุฑุจ ุฑุง ูโฺฏุฑุฏ.
ุจู **Garbage Collector** ููโุชูุงู ุงุนุชูุงุฏ ฺฉุฑุฏุ ฺูู ุขู ููุท ุญุงูุธู ุฑุง *ุขุฒุงุฏ* ูโฺฉูุฏุ ูู ุงูฺฉู ุจุงุชโูุง ุฑุง ุตูุฑ ฺฉูุฏ.

๐ ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง Dispose ฺฉุฑุฏู ฺฉ ุดุก **Aes** ุฎุงุฑุฌ ุงุฒ `using`ุ ูุฑุงุฎูุงู ูุชุฏ **Clear** ุงุณุช.
ูุชุฏ **Dispose** ุขู ุจู ุตูุฑุช explicit ูพุงุฏูโุณุงุฒ ุดุฏู ุชุง ูุดุงู ุฏูุฏ ุงู Dispose ุบุฑูุนููู ุงุณุช (ูพุงฺฉ ฺฉุฑุฏู ุญุงูุธู ุจูโุฌุง ุขุฒุงุฏุณุงุฒ ููุงุจุน unmanaged).

#### ๐ ูฺฉุงุช ุงููุช ุจุฑุง ุฌููฺฏุฑ ุงุฒ ูุดุช ุฏุงุฏูโูุง ุญุณุงุณ

* โ ุงุฒ **ุฑุดุชูโูุง (string)** ุจุฑุง ุงุทูุงุนุงุช ุงููุช ุงุณุชูุงุฏู ูฺฉูุฏ (ุฑุดุชูโูุง ุชุบุฑูุงูพุฐุฑูุฏ ู ููุฏุงุฑุดุงู ูุฑฺฏุฒ ูุงุจู ูพุงฺฉ ฺฉุฑุฏู ูุณุช).
* โ ุจูุงูุงุตูู ุจุนุฏ ุงุฒ ุจโุงุณุชูุงุฏู ุดุฏูุ ุจุงูุฑูุง ุฑุง ุจุงุฒููุณ ฺฉูุฏ (ูุซูุงู ุจุง `Array.Clear`).

---

### ๐ ูุฏุฑุช ฺฉูุฏ (Key Management)

ูุฏุฑุช ฺฉูุฏ ุจุฎุด ุญุงุช ุงููุช ุงุณุช: ุงฺฏุฑ ฺฉูุฏูุง ูู ุจุฑููุฏุ ุฏุงุฏูโูุง ูู ุฏุฑ ุฎุทุฑ ุฎูุงููุฏ ุจูุฏ.

* ุจุงุฏ ูุดุฎุต ฺฉูุฏ ฺู ฺฉุณุงู ุจู ฺฉูุฏูุง ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดูุฏ.
* ฺฉูุฏูุง ุฑุง ุฏุฑ ุจุฑุงุจุฑ ุฏุณุชุฑุณ ุบุฑูุฌุงุฒ ูุญุงูุธุช ฺฉูุฏ.
* ูุณุฎูโูุง ูพุดุชุจุงู ุฏุงุดุชู ุจุงุดุฏ (ุจุฑุง ููุงูุน ุฎุฑุงุจ ุณุฎุชโุงูุฒุงุฑ).

๐ซ ุชูุตู ููโุดูุฏ ฺฉูุฏูุง ุฑุง **ุณุฎุชโฺฉุฏ (hardcode)** ฺฉูุฏุ ฺูู ุงุจุฒุงุฑูุง ุณุงุฏูโุง ุจุฑุง ุฏฺฉุงููพุงู ุงุณูุจูโูุง ูุฌูุฏ ุฏุงุฑุฏ.
โ ุฑุงู ุจูุชุฑ ุฏุฑ ููุฏูุฒ: ุชููุฏ ฺฉูุฏ ุชุตุงุฏู ุจุฑุง ูุฑ ูุตุจ ู ุฐุฎุฑู ุขู ุจุง ุงุณุชูุงุฏู ุงุฒ **Windows Data Protection**.

ุฏุฑ **ุงุจุฑ (Cloud)**ุ ุณุฑูุณโูุง ูุซู **Azure** ู **AWS** ุณุณุชูโูุง ูุฏุฑุช ฺฉูุฏ (KMS) ุงุฑุงุฆู ูโุฏููุฏ ฺฉู ูุงุจูุชโูุง ูุซู ุซุจุช ูุงฺฏ ุฏุณุชุฑุณโูุง (audit trails) ุฏุงุฑูุฏ.

---

### ๐ ุฑูุฒูฺฏุงุฑ ฺฉูุฏ ุนููู (Public-Key Encryption and Signing)

ุฑูุฒูฺฏุงุฑ ฺฉูุฏ ุนููู **ูุงูุชูุงุฑู (asymmetric)** ุงุณุชุ ุนู ุจุฑุง ุฑูุฒูฺฏุงุฑ ู ุฑูุฒฺฏุดุง ุงุฒ **ฺฉูุฏูุง ูุชูุงูุช** ุงุณุชูุงุฏู ูโุดูุฏ:

* ๐ ฺฉูุฏ ุนููู (**public key**) โ ุจุฑุง ุฑูุฒูฺฏุงุฑ
* ๐ ฺฉูุฏ ุฎุตูุต (**private key**) โ ุจุฑุง ุฑูุฒฺฏุดุง

ูฺฺฏ ููู:

* ุงุฒ ุฑู ฺฉูุฏ ุนููู ููโุชูุงู ฺฉูุฏ ุฎุตูุต ุฑุง ูุญุงุณุจู ฺฉุฑุฏ.
* ุงฺฏุฑ ฺฉูุฏ ุฎุตูุต ฺฏู ุดูุฏุ ุฏุงุฏูโูุง ุฑูุฒูฺฏุงุฑโุดุฏู ุจุงุฒุงุจ ููโุดููุฏ.
* ุงฺฏุฑ ฺฉูุฏ ุฎุตูุต ูู ุจุฑูุฏุ ฺฉู ุณุณุชู ุฑูุฒูฺฏุงุฑ ุจโูุงุฏู ูโุดูุฏ.

---

### ๐ก ูุซุงู: ุงุฑุชุจุงุท ุงูู ุฏู ฺฉุงููพูุชุฑ ุงุฒ ุทุฑู ฺฉูุฏ ุนููู

ูุฑุถ ฺฉูุฏ **Origin** ูโุฎูุงูุฏ ุจู **Target** ูพุงู ูุญุฑูุงูู ุจูุฑุณุชุฏ:

1. **Target** ฺฉ ุฌูุช ฺฉูุฏ ุนููู/ุฎุตูุต ูโุณุงุฒุฏ ู ฺฉูุฏ ุนููู ุฑุง ุจุฑุง Origin ูโูุฑุณุชุฏ.
2. **Origin** ูพุงู ูุญุฑูุงูู ุฑุง ุจุง ฺฉูุฏ ุนููู Target ุฑูุฒูฺฏุงุฑ ฺฉุฑุฏู ู ุงุฑุณุงู ูโฺฉูุฏ.
3. **Target** ูพุงู ุฑุง ุจุง ฺฉูุฏ ุฎุตูุต ุฎูุฏุด ุฑูุฒฺฏุดุง ูโฺฉูุฏ.

๐ ุดููุฏฺฉููุฏู (eavesdropper) ููุท ุงูโูุง ุฑุง ูโุจูุฏ:

* ฺฉูุฏ ุนููู Target
* ูพุงู ุฑูุฒูฺฏุงุฑโุดุฏู ุจุง ุขู ฺฉูุฏ

ุงูุง ุจุฏูู ฺฉูุฏ ุฎุตูุต Targetุ ููโุชูุงูุฏ ูพุงู ุฑุง ุฑูุฒฺฏุดุง ฺฉูุฏ.

---

### โ๏ธ ูฺฉุชู ุงููุช: ุญููู ูุฑุฏ ูุงู (MITM)

Origin ูุทูุฆู ูุณุช ฺฉู Target ูุงูุน ุงุณุช ุง ูุฑุฏ ูุฎุฑุจ!
ุฑุงูโุญู:

* ุงุฒ ูุจู ฺฉูุฏ ุนููู Target ุฑุง ุจุดูุงุณุฏ.
* ุง ฺฉูุฏ ุนููู ุฑุง ุงุฒ ุทุฑู ฺฉ **ฺฏูุงู ุฏุฌุชุงู (digital certificate)** ูุนุชุจุฑ ุชุฃุฏ ฺฉูุฏ.

---

### ๐ ุชุฑฺฉุจ ฺฉูุฏ ุนููู ู ูุชูุงุฑู

ุฑูุฒูฺฏุงุฑ ฺฉูุฏ ุนููู ฺฉูุฏ ุงุณุช ู ุงูุฏุงุฒู ูพุงู ูุญุฏูุฏ ุฏุงุฑุฏ.
ุจู ููู ุฏูู ูุนูููุงู ูพุงู ุงููู ููุท ุดุงูู ฺฉ ฺฉูุฏ ูุชูุงุฑู ุชุงุฒู ุงุณุช.

๐ ุฑููุฏ:

* Origin โ ฺฉูุฏ ูุชูุงุฑู ุฑุง ุจุง ฺฉูุฏ ุนููู Target ุฑูุฒ ูโฺฉูุฏ ู ูโูุฑุณุชุฏ.
* Target โ ฺฉูุฏ ูุชูุงุฑู ุฑุง ุจุง ฺฉูุฏ ุฎุตูุตโุงุด ุฑูุฒฺฏุดุง ูโฺฉูุฏ.
* ุจูู ูพุงูโูุง โ ุจุง ุงูฺฏูุฑุชู ูุชูุงุฑู (ุณุฑุนโุชุฑ) ุฑูุฒ ูโุดููุฏ.

ุงฺฏุฑ ุจุฑุง ูุฑ ุฌูุณู ฺฉ ุฌูุช ฺฉูุฏ ุนููู/ุฎุตูุต ุชุงุฒู ุณุงุฎุชู ุดูุฏุ ุงููุช ุจุงูุงุชุฑ ูโุฑูุฏ ฺูู ุฏฺฏุฑ ูุงุฒ ุจู ุฐุฎุฑูโุณุงุฒ ฺฉูุฏูุง ุฏุฑ ูฺโฺฉุฏุงู ุงุฒ ฺฉุงููพูุชุฑูุง ูุณุช.

---

### ๐ ูุญุฏูุฏุช ฺฉูุฏ ุนููู

ุงูฺฏูุฑุชูโูุง ฺฉูุฏ ุนููู ููุท ูพุงูโูุง ุฑุง ุฑูุฒ ูโฺฉููุฏ ฺฉู ุงุฒ ุฎูุฏ ฺฉูุฏ **ฺฉูฺฺฉโุชุฑ ุจุงุดูุฏ**.
ุจูุงุจุฑุงู ุจุฑุง ูพุงูโูุง ุจุฒุฑฺฏ (ุจุดุชุฑ ุงุฒ ูุตู ุงูุฏุงุฒู ฺฉูุฏ)ุ ุงุณุชุซูุง (Exception) ูพุฑุชุงุจ ูโุดูุฏ.

### ๐ ฺฉูุงุณ RSA ุฏุฑ .NET

ุฏุฑ .NET ฺูุฏู ุงูฺฏูุฑุชู ูุงูุชูุงุฑู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู **RSA** ูุญุจูุจโุชุฑู ุขูโูุงุณุช.

#### ๐ ุฑูุฒูฺฏุงุฑ ู ุฑูุฒฺฏุดุง ุจุง RSA

```csharp
byte[] data = { 1, 2, 3, 4, 5 };   // ุฏุงุฏูโุง ฺฉู ูโุฎูุงูู ุฑูุฒ ฺฉูู
using (var rsa = new RSACryptoServiceProvider())
{
    byte[] encrypted = rsa.Encrypt(data, true);
    byte[] decrypted = rsa.Decrypt(encrypted, true);
}
```

ฺูู ูฺ ฺฉูุฏ ุนููู ุง ุฎุตูุตโุง ูุดุฎุต ูฺฉุฑุฏูุ ูุฑุงููโฺฉููุฏู ุฑูุฒูฺฏุงุฑ ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ฺฉ ุฌูุช ฺฉูุฏ (Key Pair) ุจุง ุทูู ูพุดโูุฑุถ **ูกููขูค ุจุช** ุณุงุฎุช.
ูโุชูุงูุฏ ฺฉูุฏูุง ุจููุฏุชุฑ (ุฏุฑ ูุถุงุฑุจ ูจ ุจุงุช) ุจุฎูุงูุฏ. ุจุฑุง ุจุฑูุงููโูุง ุงููุช ุญุณุงุณุ ุงุณุชูุงุฏู ุงุฒ **ูขููคูจ ุจุช** ุชูุตู ูโุดูุฏ:

```csharp
var rsa = new RSACryptoServiceProvider(2048);
```

ุณุงุฎุช ฺฉูุฏ ูุญุงุณุจุงุช ุณูฺฏู ุงุณุช (ุญุฏูุฏ **ูกู ููโุซุงูู** ุทูู ูโฺฉุดุฏ). ุจู ููู ุฏููุ ูพุงุฏูโุณุงุฒ RSA ุชููุฏ ฺฉูุฏ ุฑุง ุชุง ุฒูุงู ฺฉู ูุงูุนุงู ูุงุฒู ุจุงุดุฏ (ูุซูุงู ููฺฏุงู ูุฑุงุฎูุงู `Encrypt`) ุจู ุชุฃุฎุฑ ูโุงูุฏุงุฒุฏ. ุงู ูุฑุตุช ุฑุง ูโุฏูุฏ ฺฉู ุงฺฏุฑ ฺฉูุฏ ููุฌูุฏ ุฏุงุฑุฏุ ุขู ุฑุง ุจุงุฑฺฏุฐุงุฑ ฺฉูุฏ.

---

### ๐พ ุฐุฎุฑูโุณุงุฒ ู ุจุงุฑฺฏุฐุงุฑ ฺฉูุฏูุง

* ูุชุฏูุง **ImportCspBlob** ู **ExportCspBlob**: ุจุงุฑฺฏุฐุงุฑ/ุฐุฎุฑู ฺฉูุฏ ุฏุฑ ูุงูุจ ุขุฑุงู ุจุงุช.
* ูุชุฏูุง **FromXmlString** ู **ToXmlString**: ููู ฺฉุงุฑ ุฑุง ุฏุฑ ูุงูุจ ุฑุดุชู (XML) ุงูุฌุงู ูโุฏููุฏ.

ูพุงุฑุงูุชุฑ ุจูู ุชุนู ูโฺฉูุฏ ฺฉู ฺฉูุฏ ุฎุตูุต ูู ุฐุฎุฑู ุดูุฏ ุง ูู.

ูุซุงู: ุณุงุฎุช ฺฉ ุฌูุช ฺฉูุฏ ู ุฐุฎุฑู ุขู ุฑู ุฏุณฺฉ:

```csharp
using (var rsa = new RSACryptoServiceProvider())
{
    File.WriteAllText("PublicKeyOnly.xml", rsa.ToXmlString(false));
    File.WriteAllText("PublicPrivate.xml", rsa.ToXmlString(true));
}
```

ฺูู ฺฉูุฏ ูุฏุงุดุชูุ ุงููู ุจุงุฑ `ToXmlString` ูุฌุจูุฑ ุดุฏ ฺฉ ุฌูุช ฺฉูุฏ ุชุงุฒู ุจุณุงุฒุฏ.

ุจุงุฑฺฏุฐุงุฑ ูุฌุฏุฏ ู ุงุณุชูุงุฏู ุงุฒ ุขูโูุง:

```csharp
byte[] data = Encoding.UTF8.GetBytes("Message to encrypt");
string publicKeyOnly = File.ReadAllText("PublicKeyOnly.xml");
string publicPrivate = File.ReadAllText("PublicPrivate.xml");
byte[] encrypted, decrypted;

using (var rsaPublicOnly = new RSACryptoServiceProvider())
{
    rsaPublicOnly.FromXmlString(publicKeyOnly);
    encrypted = rsaPublicOnly.Encrypt(data, true);

    // ุฎุทุง: ฺูู ฺฉูุฏ ุฎุตูุต ูุฏุงุฑู ููโุชูุงูู Decrypt ฺฉูู:
    // decrypted = rsaPublicOnly.Decrypt(encrypted, true);
}

using (var rsaPublicPrivate = new RSACryptoServiceProvider())
{
    rsaPublicPrivate.FromXmlString(publicPrivate);
    decrypted = rsaPublicPrivate.Decrypt(encrypted, true); // ููููุชโุขูุฒ
}
```

---

### ๐๏ธ ุงูุถุง ุฏุฌุชุงู (Digital Signing)

ุงูฺฏูุฑุชูโูุง ฺฉูุฏ ุนููู ุจุฑุง **ุงูุถุง ุฏุฌุชุงู** ูู ุงุณุชูุงุฏู ูโุดููุฏ.
ุงูุถุง ูุซู Hash ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู ุชููุฏ ุขู ุจู ฺฉูุฏ ุฎุตูุต ูุงุฒ ุฏุงุฑุฏ ู ุฌุนูโูพุฐุฑ ูุณุช. ฺฉูุฏ ุนููู ุจุฑุง ุชุฃุฏ ุงูุถุง ุงุณุชูุงุฏู ูโุดูุฏ.

ูุซุงู:

```csharp
byte[] data = Encoding.UTF8.GetBytes("Message to sign");
byte[] publicKey;
byte[] signature;
object hasher = SHA1.Create(); // ุงูฺฏูุฑุชู ูุด ุงูุชุฎุงุจ ูุง

// ุชููุฏ ุฌูุช ฺฉูุฏ ุฌุฏุฏ ู ุงูุถุง ุฏุงุฏู:
using (var publicPrivate = new RSACryptoServiceProvider())
{
    signature = publicPrivate.SignData(data, hasher);
    publicKey = publicPrivate.ExportCspBlob(false); // ฺฏุฑูุชู ฺฉูุฏ ุนููู
}

// ุณุงุฎุช RSA ุฌุฏุฏ ุจุง ฺฉูุฏ ุนููู ู ุชุณุช ุงูุถุง:
using (var publicOnly = new RSACryptoServiceProvider())
{
    publicOnly.ImportCspBlob(publicKey);
    Console.Write(publicOnly.VerifyData(data, hasher, signature)); // True

    // ุชุบุฑ ุฏุงุฏู ู ุชุณุช ุฏูุจุงุฑู:
    data[0] = 0;
    Console.Write(publicOnly.VerifyData(data, hasher, signature)); // False

    // ุฎุทุง: ฺูู ฺฉูุฏ ุฎุตูุต ูุฏุงุฑู ููโุชูุงูู ุงูุถุง ุชููุฏ ฺฉูู:
    signature = publicOnly.SignData(data, hasher);
}
```

---

### โ๏ธ ุฌุฒุฆุงุช ุนููฺฉุฑุฏ ุงูุถุง

ุงูุถุง ุจุง ุงู ูุฑุงุญู ุงูุฌุงู ูโุดูุฏ:

1. ุฏุงุฏู ุงุจุชุฏุง **ูุด** ูโุดูุฏ.
2. ุงูฺฏูุฑุชู ูุงูุชูุงุฑู (RSA) ุฑู ูุด ุงุนูุงู ูโุดูุฏ.

ุงุฒ ุขูุฌุง ฺฉู ูุด ุงูุฏุงุฒู ฺฉูฺฺฉ ุฏุงุฑุฏุ ุงูุถุง ุงุณูุงุฏ ุจุฒุฑฺฏ ุณุฑุน ุงูุฌุงู ูโุดูุฏ (ฺูู RSA ุจูโุชููุง ูพุฑูุฒููโุชุฑ ุงุณุช).

ูโุชูุงูุฏ ูุด ุฑุง ุฎูุฏุชุงู ูุญุงุณุจู ฺฉูุฏ ู ุณูพุณ ุงุฒ **SignHash** ุจูโุฌุง `SignData` ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
using (var rsa = new RSACryptoServiceProvider())
{
    byte[] hash = SHA1.Create().ComputeHash(data);
    signature = rsa.SignHash(hash, CryptoConfig.MapNameToOID("SHA1"));
}
```

`SignHash` ุจุงุฏ ุจุฏุงูุฏ ุงุฒ ฺู ุงูฺฏูุฑุชู ุจุฑุง ูุด ุงุณุชูุงุฏู ฺฉุฑุฏูโุงุฏ. ูุชุฏ `CryptoConfig.MapNameToOID` ุงู ุงุทูุงุนุงุช ุฑุง ุงุฒ ฺฉ ูุงู ุณุงุฏู ูุซู `"SHA1"` ูุฑุงูู ูโฺฉูุฏ.

๐ ุงูุฏุงุฒู ุงูุถุง: ุฎุฑูุฌ ุงูุถุง ุจุง ุงูุฏุงุฒู ฺฉูุฏ ุจุฑุงุจุฑ ุงุณุช. ุฏุฑ ุญุงู ุญุงุถุฑ ุงูฺฏูุฑุชู ฺฉู ุงูุถุง ุงูู ฺฉูฺฺฉุชุฑ ุงุฒ **ูกูขูจ ุจุงุช** ุชููุฏ ฺฉูุฏ (ุจุฑุง ูุซุงู ฺฉุฏ ูุนุงูโุณุงุฒ ูุญุตูู) ูุฌูุฏ ูุฏุงุฑุฏ.

---

### ๐ ุงุนุชูุงุฏ ุจู ฺฉูุฏ ุนููู

ุจุฑุง ุงูฺฉู ุงูุถุง ูุนุชุจุฑ ุจุงุดุฏุ ฺฏุฑูุฏู ุจุงุฏ ฺฉูุฏ ุนููู ูุฑุณุชูุฏู ุฑุง ุจุดูุงุณุฏ ู ุจู ุขู ุงุนุชูุงุฏ ฺฉูุฏ. ุงู ูโุชูุงูุฏ ุงุฒ ุฑุงูโูุง ุฒุฑ ุงูุฌุงู ุดูุฏ:

* ุงุฑุชุจุงุท ูุจู
* ูพฺฉุฑุจูุฏ ุงุฒ ูพุด
* ุง ุงุณุชูุงุฏู ุงุฒ **ฺฏูุงู ุฏุฌุชุงู (site certificate)**

๐ ฺฉ ฺฏูุงู ุฏุฌุชุงู ุฑฺฉูุฑุฏ ุงูฺฉุชุฑููฺฉ ฺฉูุฏ ุนููู ู ูุงู ูุฑุณุชูุฏู ุงุณุช ฺฉู ุฎูุฏุด ุชูุณุท ฺฉ ูุฑุฌุน ูุนุชุจุฑ ูุณุชูู ุงูุถุง ุดุฏู ุงุณุช.

๐ฆ ูุถุง ูุงู `System.Security.Cryptography.X509Certificates` ุงููุงุน ูุงุฒู ุจุฑุง ฺฉุงุฑ ุจุง ฺฏูุงูโูุง ุฑุง ูุฑุงูู ูโฺฉูุฏ.
