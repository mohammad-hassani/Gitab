---
layout: layout.njk
title: ูุฏุฑุช Disposal ู Garbage Collection
---
# ูุตู ุฏูุงุฒุฏูู: ูุฏุฑุช Disposal ู Garbage Collection

ุจุฑุฎ ุงุฒ ุงุดุงุก ูุงุฒููุฏ ฺฉุฏูุง ูุฎุตูุต ุจุฑุง **ุฌูุนโฺฉุฑุฏู (tear-down)** ูุณุชูุฏ ุชุง ููุงุจุน ูุซู ูุงูโูุง ุจุงุฒุ ูููโูุง (locks)ุ ููุฏูโูุง ุณุณุชูโุนุงูู ู ุงุดุงุก **unmanaged** ุขุฒุงุฏ ุจุดู. ุฏุฑ ุงุตุทูุงุญ ุฏุงุชโูุชุ ุจู ุงู ฺฉุงุฑ **Disposal** ฺฏูุชู ูโุดู ู ุงุฒ ุทุฑู ุงูุชุฑูุณ **IDisposable** ูพุดุชุจุงู ูโุดู.

ููฺูู ุญุงูุธู ูุฏุฑุชโุดุฏู (Managed Memory) ฺฉู ุชูุณุท ุงุดุงุก ุงุณุชูุงุฏูโูุดุฏู ุงุดุบุงู ุดุฏูุ ุจุงุฏ ุฏุฑ ฺฉ ููุทู ุขุฒุงุฏ ุจุดู. ุงู ฺฉุงุฑ **Garbage Collection** ูุงู ุฏุงุฑู ู ุชูุณุท **CLR** ุงูุฌุงู ูโุดู.

ุชูุงูุช Disposal ู Garbage Collection ุฏุฑ ุงูู ฺฉู:

* **Disposal** ูุนูููุงู ุจูโุตูุฑุช ุตุฑุญ ู ุชูุณุท ุจุฑูุงููโููุณ ุงูุฌุงู ูโุดู. ๐งโ๐ป
* **Garbage Collection** ฺฉุงููุงู ุฎูุฏฺฉุงุฑ ูุณุช ู ุชูุณุท CLR ูุฏุฑุช ูโุดู. โ๏ธ

ุจู ุนุจุงุฑุช ุฏฺฏูุ ุขุฒุงุฏ ฺฉุฑุฏู ฺุฒูุง ูุซู **file handles**ุ **locks** ู ููุงุจุน ุณุณุชูโุนุงูู ุจุฑ ุนูุฏูโ ุจุฑูุงููโููุณ ูุณุชุ ุฏุฑ ุญุงู ฺฉู ุขุฒุงุฏุณุงุฒ ุญุงูุธู ุฑู CLR ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุฏู.

ุงู ูุตู ุจู ูุฑ ุฏู ููุถูุน **Disposal** ู **Garbage Collection** ูโูพุฑุฏุงุฒู ู ููฺูู **Finalizer**โูุง ุณโุดุงุฑูพ ู ุงูฺฏู (Pattern) ูุฑุชุจุท ุฑู ุชูุถุญ ูโุฏู ฺฉู ูโุชููู ููุด ูพุดุชุจุงู ุจุฑุง Disposal ุฏุงุดุชู ุจุงุดู. ุฏุฑ ููุงุชุ ุจู ุฌุฒุฆุงุช **Garbage Collector** ู ุณุงุฑ ฺฏุฒููโูุง ูุฏุฑุช ุญุงูุธู ุฎูุงูู ูพุฑุฏุงุฎุช.

---

## โป๏ธ IDisposableุ Dispose ู Close

ุฏุงุชโูุช ฺฉ ุงูุชุฑูุณ ุฎุงุต ุจุฑุง ุชุงูพโูุง ฺฉู ูุงุฒููุฏ ูุชุฏ tear-down ูุณุชู ุชุนุฑู ฺฉุฑุฏู:

```csharp
public interface IDisposable
{
  void Dispose();
}
```

ุณโุดุงุฑูพ ุฏุณุชูุฑ **using** ุฑู ุจูโุนููุงู ฺฉ ูุงูโุจูุฑ ูุญู (syntactic shortcut) ูุฑุงูู ฺฉุฑุฏู ุชุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ูุชุฏ **Dispose** ุฑู ุงุดุงุฆ ฺฉู ุงุฒ **IDisposable** ูพุฑู ูโฺฉูู ูุฑุงุฎูุงู ุจุดู. ุงู ฺฉุงุฑ ุฏุฑ ูพุดุชโุตุญูู ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ุจูุงฺฉ **try/finally** ุงูุฌุงู ูโุดู:

```csharp
using (FileStream fs = new FileStream("myFile.txt", FileMode.Open))
{
  // ... Write to the file ...
}
```

ฺฉุงููพุงูุฑ ุงู ุฑู ุจู ฺฉุฏ ุฒุฑ ุชุจุฏู ูโฺฉูู:

```csharp
FileStream fs = new FileStream("myFile.txt", FileMode.Open);
try
{
  // ... Write to the file ...
}
finally
{
  if (fs != null) ((IDisposable)fs).Dispose();
}
```

ุจูุงฺฉ **finally** ุชุถูู ูโฺฉูู ฺฉู ูุชุฏ **Dispose** ุญุช ุฏุฑ ุตูุฑุช ฺฉู **Exception** ุฑุฎ ุจุฏู ุง ฺฉุฏ ุฒูุฏุชุฑ ุงุฒ ุจูุงฺฉ ุฎุงุฑุฌ ุจุดูุ ุญุชูุงู ูุฑุงุฎูุงู ุจุดู.

ุจูโุทูุฑ ูุดุงุจูุ ููุดุชู ฺฉุฏ ุจู ุดฺฉู ุฒุฑ ุชุถูู ูโฺฉูู ฺฉู **Dispose** ุจูโูุญุถ ุฎุฑูุฌ **fs** ุงุฒ ูุญุฏูุฏูโ (scope) ุฎูุฏุด ุงูุฌุงู ุจุดู:

```csharp
using FileStream fs = new FileStream("myFile.txt", FileMode.Open);
// ... Write to the file ...
```

ุฏุฑ ุณูุงุฑููุง ุณุงุฏูุ ููุดุชู ฺฉ ุชุงูพ disposable ููุท ูุงุฒููุฏ ูพุงุฏูโุณุงุฒ **IDisposable** ู ููุดุชู ูุชุฏ **Dispose** ูุณุช:

```csharp
sealed class Demo : IDisposable
{
  public void Dispose()
  {
    // Perform cleanup / tear-down.
    ...
  }
}
```

ุงู ุงูฺฏู ุจุฑุง ููุงุฑุฏ ุณุงุฏู ู ฺฉูุงุณโูุง **sealed** (ุบุฑูุงุจู ุงุฑุซโุจุฑ) ุฎู ุฎูุจ ุนูู ูโฺฉูู. ุฏุฑ ุจุฎุด ยซCalling Dispose from a Finalizerยป (ุตูุญู ตนฐ) ฺฉ ุงูฺฏู ูพุดุฑูุชูโุชุฑ ุชูุถุญ ุฏุงุฏู ูโุดู ฺฉู ูโุชููู ุจุฑุง ูุตุฑูโฺฉููุฏฺฏุงู ฺฉู **Dispose** ุฑู ูุฑุงููุด ูโฺฉููุ ููุด ูพุดุชุจุงู ุฏุงุดุชู ุจุงุดู.

ุจุฑุง ุชุงูพโูุง **unsealed** (ูุงุจู ุงุฑุซโุจุฑ)ุ ุจูุชุฑู ุงุฒ ูููู ุงุจุชุฏุง ุงุฒ ุงู ุงูฺฏู ูพุดุฑูุชูโุชุฑ ูพุฑู ุจุดูุ ฺูู ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุงฺฏู ุฒุฑฺฉูุงุณ ุจุฎูุงุฏ ฺูู ูุงุจูุช ุงุถุงูู ฺฉููุ ุงูุถุงุน ุฎู ูพฺุฏู ูโุดู.

---

## ๐ ููุงูู ุงุณุชุงูุฏุงุฑุฏ Disposal

ุฏุงุชโูุช ฺฉ ูุฌููุนูโ ุบุฑุฑุณู (de facto) ุงุฒ ููุงูู ุจุฑุง ููุทู Disposal ุฏุงุฑู. ุงู ููุงูู ูุณุชููุงู ุฏุฑ ุฏุงุชโูุช ุง ุฒุจุงู C# ฺฉุฏููุณ ูุดุฏูุ ุงูุง ูุฏูโุดูู ุงุฌุงุฏ ฺฉ **ูพุฑูุชฺฉู ุณุงุฒฺฏุงุฑ ุจุฑุง ูุตุฑูโฺฉููุฏฺฏุงู** ูุณุช. ููุงูู ุนุจุงุฑุชโุงูุฏ ุงุฒ:

ฑ. ุจุนุฏ ุงุฒ ุงูฺฉู ฺฉ ุดุก Dispose ุดุฏุ ุฏฺฏู ูุงุจู ุงุณุชูุงุฏู ูุณุช. ููโุดู ุฏูุจุงุฑู ูุนุงูุด ฺฉุฑุฏ ู ูุฑฺฏููู ูุฑุงุฎูุงู ูุชุฏ ุง property (ุจูโุฌุฒ **Dispose**) ุจุงุนุซ ูพุฑุชุงุจ ุดุฏู **ObjectDisposedException** ูโุดู.
ฒ. ูุฑุงุฎูุงู ฺูุฏุจุงุฑูโ ูุชุฏ **Dispose** ุฑู ฺฉ ุดุก ูฺ ุฎุทุง ุงุฌุงุฏ ููโฺฉูู.
ณ. ุงฺฏุฑ ฺฉ ุดุก disposable ุจูโูุงู **x** ูุงูฺฉ ฺฉ ุดุก disposable ุฏฺฏู ุจูโูุงู **y** ุจุงุดูุ ูุชุฏ **Dispose** ุดุก **x** ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ูุชุฏ **Dispose** ุดุก **y** ุฑู ูุฑุงุฎูุงู ูโฺฉููโูฺฏุฑ ุงูฺฉู ุฎูุงู ุงู ููุถูุน ูุดุฎุต ุดุฏู ุจุงุดู.

ุงู ููุงูู ููฺฏุงู ููุดุชู ุชุงูพโูุง ุฌุฏุฏ ูู ููุฏ ูุณุชูุ ูุฑฺูุฏ **ุงุฌุจุงุฑ** ูุณุชู. ฺุฒ ุฌูู ุดูุง ุฑู ุจุฑุง ููุดุชู ูุชุฏ ูุซู ยซUndisposeยป ููโฺฏุฑูโุงูุจุชู ุงุญุชูุงูุงู ุจุง ูุงฺฉูุด ููู ููฺฉุงุฑุงูุชูู ุฑูุจูโุฑู ุฎูุงูุฏ ุดุฏ! ๐

ุทุจู ูุงููู ุณููุ ฺฉ **container object** ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงุดุงุก ูุฑุฒูุฏ ุฎูุฏุด ุฑู Dispose ูโฺฉูู.

* ูุซุงู ุฎูุจ ุงู ููุถูุน ฺฉูุชุฑูโูุง ฺฉุงูุชูุฑ ุฏุฑ **Windows Forms** ูุซู **Form** ุง **Panel** ูุณุชู. ููุช ุงู ฺฉูุชุฑูโูุง ุจุณุชู ุง Dispose ูโุดูุ ูููโ ฺฉูุชุฑูโูุง ูุฑุฒูุฏ ูู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ Dispose ูโุดู.
* ูุซุงู ุฏฺฏูุ ุฒูุงู ูุณุช ฺฉู ฺฉ **FileStream** ุฑู ุฏุงุฎู ฺฉ **DeflateStream** ูโูพฺู. Dispose ฺฉุฑุฏู **DeflateStream** ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ **FileStream** ุฑู ูู Dispose ูโฺฉููโูฺฏุฑ ุงูฺฉู ุฎูุงู ุงู ููุถูุน ุฏุฑ ุณุงุฒูุฏู (constructor) ูุดุฎุต ุดุฏู ุจุงุดู.

---

## ๐ Close ู Stop

ุจุฑุฎ ุชุงูพโูุง ุนูุงูู ุจุฑ ูุชุฏ **Dispose**ุ ูุชุฏ ุจูโูุงู **Close** ูู ุฏุงุฑู. ฺฉุชุงุจุฎุงููโ ุงุตู ุฏุงุชโูุช (BCL) ุฏุฑ ููุฑุฏ ูุนูุง ุฏูู ูุชุฏ Close ฺฉุงููุงู ุณุงุฒฺฏุงุฑ ูุณุชุ ุงูุง ุชูุฑุจุงู ููุดู ฺฉ ุงุฒ ุงู ุฏู ุญุงูุช ูุณุช:

* ุงุฒ ูุธุฑ ฺฉุงุฑฺฉุฑุฏ ฺฉุงููุงู ุจุฑุงุจุฑ ุจุง **Dispose**.
* ุฒุฑูุฌููุนูโุง ุงุฒ ฺฉุงุฑฺฉุฑุฏ **Dispose**.

ูุซุงู ุญุงูุช ุฏูู **IDbConnection** ูุณุช:

* ฺฉ connection ฺฉู ุจุณุชู (Closed) ุดุฏู ูโุชููู ุฏูุจุงุฑู ุจุงุฒ ุจุดู (Re-Opened).
* ุงูุง connection ฺฉู Dispose ุดุฏู ุจุงุดู ุฏฺฏู ููโุชููู.

ูุซุงู ุฏฺฏู ฺฉ **Windows Form** ูุณุช ฺฉู ุจุง **ShowDialog** ูุนุงู ุดุฏู:

* ูุฑุงุฎูุงู **Close** ููุท ูุฑู ุฑู ูุฎู ูโฺฉูู.
* ุงูุง ูุฑุงุฎูุงู **Dispose** ููุงุจุนุด ุฑู ูู ุขุฒุงุฏ ูโฺฉูู.

ุจุฑุฎ ฺฉูุงุณโูุง ูุชุฏ ุจูโูุงู **Stop** ุชุนุฑู ฺฉุฑุฏู (ูุซู **Timer** ุง **HttpListener**).

* ูุชุฏ **Stop** ููฺฉูู ูุซู **Dispose** ููุงุจุน unmanaged ุฑู ุขุฒุงุฏ ฺฉููุ
* ุงูุง ุจุฑ ุฎูุงู Disposeุ ุงุฌุงุฒูโ **ุดุฑูุน ูุฌุฏุฏ (Restarting)** ุฑู ูโุฏู.

## ๐๏ธ ฺู ุฒูุงู ุจุงุฏ Dispose ฺฉููุ

ฺฉ ูุงููู ุงูู (ุฏุฑ ุชูุฑุจุงู ูููโ ููุงุฑุฏ) ุงูู ฺฉู:
๐ **ยซุงฺฏุฑ ุดฺฉ ุฏุงุฑุ Dispose ฺฉู.ยป**

ุงุดุงุฆ ฺฉู ฺฉ **unmanaged resource handle** ุฑู ุฏุฑ ุฎูุฏุดูู ูฺฏู ูโุฏุงุฑูุ ุชูุฑุจุงู ููุดู ูุงุฒููุฏ Dispose ูุณุชู ุชุง ุงูู ููุฏู ุขุฒุงุฏ ุจุดู. ูููููโูุง ุดุงูู:

* **File ุง Network Stream**โูุง
* **Network Socket**โูุง
* ฺฉูุชุฑูโูุง **Windows Forms**
* ุงุจุฒุงุฑูุง **GDI+** ูุซู **pen**ุ **brush** ู **bitmap**

ุงุฒ ุทุฑู ุฏฺฏูุ ุงฺฏู ฺฉ ุชุงูพ **disposable** ุจุงุดูุ ูุนูููุงู (ุงูุง ูู ููุดู) ุจูโุทูุฑ ูุณุชูู ุง ุบุฑูุณุชูู ฺฉ **unmanaged handle** ุฑู ูุฑุฌุนโุฏู ูโฺฉูู. ุฏููุด ุงูู ฺฉู unmanaged handleูุง ุฏุฑูุงุฒูโุง ุจู ยซุฏูุง ุจุฑููยป ูุซู ููุงุจุน ุณุณุชูโุนุงููุ ุงุชุตุงูโูุง ุดุจฺฉู ู ูููโูุง ุฏุชุงุจุณ ูุณุชูโุฑุงู ุงุตูโุง ฺฉู ุงุดุงุก ูโุชููู ุฏุฑ ุตูุฑุช ุฑูุง ุดุฏู ูุงุฏุฑุณุชุ ุจุฑูู ุงุฒ ุฎูุฏุดูู ุฏุฑุฏุณุฑ ุงุฌุงุฏ ฺฉูู. โ๏ธ

---

### ๐ ุณู ุณูุงุฑู ุนุฏู ูุงุฒ ุจู Dispose

ุงูุจุชู ุณู ุญุงูุช ูุณุช ฺฉู ูุจุงุฏ Dispose ุงูุฌุงู ุจุดู:

ฑ. ุฒูุงู ฺฉู ุดูุง **ูุงูฺฉ ุดุก ูุณุชุฏ**โูุซูุงู ููุช ฺฉ ุดุก ูุดุชุฑฺฉ ุฑู ุงุฒ ุทุฑู ฺฉ **static field ุง property** ูโฺฏุฑุฏ.
ฒ. ุฒูุงู ฺฉู ูุชุฏ **Dispose** ุดุก ฺฉุงุฑ ุงูุฌุงู ูโุฏู ฺฉู ุดูุง ููโุฎูุงุฏ.
ณ. ุฒูุงู ฺฉู ูุชุฏ **Dispose** ุจุฑุง ุดุก **ุงุตูุงู ุทุฑุงุญ ูุดุฏู** ู Dispose ฺฉุฑุฏู ุงูู ููุท ูพฺุฏฺฏ ุบุฑุถุฑูุฑ ุจู ุจุฑูุงูู ุงุถุงูู ูโฺฉูู.

---

### ๐ต ุฏุณุชู ุงูู: ููุงุฑุฏ ูุงุฏุฑ

ุงู ุญุงูุช ุฎู ฺฉู ูพุด ูุงุฏ. ูููููโูุง ุงุตู ุฏุฑ ูุถุง ูุงู **System.Drawing** ุฏุฏู ูโุดู:

* ุงุดุงุก GDI+ ฺฉู ุงุฒ ุทุฑู **static field ุง property** ุจูโุฏุณุช ูุงู (ูุซู **Brushes.Blue**) ูุฑฺฏุฒ ูุจุงุฏ Dispose ุจุดูุ ฺูู ูููู ููููู ุฏุฑ ุชูุงู ุทูู ุนูุฑ ุจุฑูุงูู ุงุณุชูุงุฏู ูโุดู.
* ุงูุง ูููููโูุง ฺฉู ุงุฒ ุทุฑู **constructor** ุณุงุฎุชู ูโุดู (ูุซู **new SolidBrush**) ุง ูููููโูุง ฺฉู ุงุฒ ุทุฑู **static method** ูุซู **Font.FromHdc** ุจูโุฏุณุช ูุงูุ ุจุงุฏ Dispose ุจุดู.

---

### ๐ ุฏุณุชู ุฏูู: ููุงุฑุฏ ุฑุงุฌโุชุฑ

ุงู ุฏุณุชู ุฎู ุจุดุชุฑ ุฏุฏู ูโุดู. ูููููโูุง ุฎูุจุด ุฏุฑ ูุถุง ูุงูโูุง **System.IO** ู **System.Data** ูุณุชู.

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/12/Table-12-1.jpeg)
</div>

## ๐๏ธ MemoryStream ู ุฏุณุชูโ ุณูู ุงุฒ ุนุฏู ูุงุฒ ุจู Dispose

ูุชุฏ **Dispose** ุฏุฑ ฺฉูุงุณ **MemoryStream** ููุท ุดุก ุฑู ุบุฑูุนุงู ูโฺฉููุ ูฺ ุนููุงุช ููู ุจุฑุง ูพุงฺฉโุณุงุฒ ุงูุฌุงู ููโุฏู ฺูู MemoryStream ูฺ **unmanaged handle** ุง ููุจุน ูุดุงุจู ุฏุฑ ุงุฎุชุงุฑ ูุฏุงุฑู.

ุฏุณุชูโ ุณูู ุดุงูู ฺฉูุงุณโูุง ูุซู **StringReader** ู **StringWriter** ูโุดู. ุงู ุชุงูพโูุง ุจูโุฎุงุทุฑ **base class** ุฎูุฏุดูู disposable ูุณุชูุ ูู ุจู ุงู ุฏูู ฺฉู ูุงูุนุงู ูุงุฒููุฏ ูพุงฺฉโุณุงุฒ ุญุงุช ุจุงุดู.

* ุงฺฏู ฺูู ุดุฆ ุฑู ููุท ุฏุงุฎู ฺฉ ูุชุฏ ุจุณุงุฒุฏ ู ุงุฒุด ุงุณุชูุงุฏู ฺฉูุฏุ ูพฺุฏู ุงูู ุฏุงุฎู ฺฉ ุจูุงฺฉ **using** ฺฉุงุฑ ุณุฎุช ูุณุช.
* ุงูุง ุงฺฏู ุนูุฑ ุงูู ุดุก ุทููุงูโุชุฑ ุจุงุดูุ ูุฏุฑุช ุงูฺฉู ฺู ุฒูุงู ุฏฺฏู ุงุณุชูุงุฏู ููโุดู ู Dispose ฺฉุฑุฏูุดุ ููุท ูพฺุฏฺฏ ุบุฑุถุฑูุฑ ุจู ุจุฑูุงูู ุงุถุงูู ูโฺฉูู.

ุฏุฑ ฺูู ููุงุฑุฏ ูโุชููุฏ ุจูโุณุงุฏฺฏ **Dispose ุฑู ูุงุฏุฏู ุจฺฏุฑุฏ**. ุงูุจุชู ูุงุฏุฏู ฺฏุฑูุชู Dispose ฺฏุงู ูโุชููู ูุฒููโ ฺฉุงุฑุง ุฏุงุดุชู ุจุงุดู (ุจุฎุด ยซCalling Dispose from a Finalizerยป ุตูุญู ตนฐ ุฑู ุจุจูุฏ).

---

## ๐งน ูพุงฺฉโุณุงุฒ ููุฏูุง ุฏุฑ Dispose

ุจูโุทูุฑ ฺฉูุ ุฏุฑ ูุชุฏ **Dispose** ูุงุฒู ูุณุช ููุฏูุง ฺฉ ุดุก ุฑู ูพุงฺฉ ฺฉูุฏ. ุจุง ุงู ุญุงูุ ฺฉ ฺฉุงุฑ ุฎูุจ ุงูู ฺฉู ุงุฒ **event**โูุง ฺฉู ุดุก ุฏุฑ ุทูู ุนูุฑุด ุจู ุงููโูุง subscribe ฺฉุฑุฏูุ **unsubscribe** ฺฉูุฏ (ุจุฑุง ูููููุ ุจุฎุด ยซManaged Memory Leaksยป ุฏุฑ ุตูุญู ถฐฐ ุฑู ุจุจูุฏ).

ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดู:

* ุงุนูุงูโูุง ูุงุฎูุงุณุชู ุฏุฑุงูุช ูฺฉูุฏ.
* ู ุฌูู ุฒูุฏู ูููุฏู ูุงุฎูุงุณุชูโ ุดุก ุฏุฑ ูฺฏุงู **Garbage Collector (GC)** ฺฏุฑูุชู ุจุดู.

ุฎูุฏ ูุชุฏ **Dispose** ุจุงุนุซ ุขุฒุงุฏุณุงุฒ ุญุงูุธูโ ูุฏุฑุชโุดุฏู (Managed Memory) ููโุดูโุงู ููุท ุฏุฑ ุฒูุงู **Garbage Collection** ุงุชูุงู ูโุงูุชู.

ููฺูู ุฎูุจู ฺฉ ููุฏ ูุฑุงุฑ ุจุฏุฏ ุชุง ูุดูู ุจุฏู ุดุก Dispose ุดุฏู. ุงูุทูุฑ ุงฺฏู ุจุนุฏุงู ูุตุฑูโฺฉููุฏู ุจุฎูุงุฏ ุฑู ุดุก ูุชุฏ ุตุฏุง ุจุฒููุ ูโุชููุฏ ฺฉ **ObjectDisposedException** ูพุฑุชุงุจ ฺฉูุฏ:

```csharp
public bool IsDisposed { get; private set; }
```

ุนูุงูู ุจุฑ ุงูุ (ูุฑฺูุฏ ุงุฒ ูุธุฑ ูู ุถุฑูุฑ ูุณุช) ุจูุชุฑู ููุฏูุฑูุง event ุฏุงุฎู ุดุก ุฑู ูู ุฏุฑ ูุชุฏ Dispose ูพุงฺฉ ฺฉูุฏ (ุจุง ููุฏุงุฑุฏู **null**). ุงู ุจุงุนุซ ูโุดู ุงูู eventูุง ุญู ุง ุจุนุฏ ุงุฒ Dispose ุดุฏูุ ุงุฌุฑุง ูุดู.

ฺฏุงู ฺฉ ุดุก ุฏุงุฏูโูุง ูุญุฑูุงูู ู ุญุณุงุณ ูุซู ฺฉูุฏูุง ุฑูุฒูฺฏุงุฑ ูฺฏู ูโุฏุงุฑู. ุฏุฑ ุงู ุญุงูุช ููุทูู ฺฉู ุงูู ุฏุงุฏูโูุง ุฑู ููฺฏุงู Dispose ูพุงฺฉ ฺฉูุฏ (ุจุฑุง ุฌููฺฏุฑ ุงุฒ ฺฉุดู ุงุญุชูุงู ุชูุณุท ุณุงุฑ ูพุฑุฏุงุฒูโูุง ููุช ุญุงูุธู ุจุนุฏุงู ุจู ุณุณุชูโุนุงูู ุจุงุฒฺฏุฑุฏููุฏู ูโุดู). ฺฉูุงุณ **SymmetricAlgorithm** ุฏุฑ ูุถุง ูุงู **System.Security.Cryptography** ุฏููุงู ููู ฺฉุงุฑ ุฑู ูโฺฉูู ู ุฑู ุขุฑุงูโ ุจุงุช ฺฉู ฺฉูุฏ ุฑูุฒูฺฏุงุฑ ุฑู ูฺฏู ูโุฏุงุฑูุ ูุชุฏ **Array.Clear** ุฑู ุตุฏุง ูโุฒูู.

---

## ๐น๏ธ Anonymous Disposal

ฺฏุงู ููุฏู ฺฉู **IDisposable** ุฑู ูพุงุฏูโุณุงุฒ ฺฉูู ุจุฏูู ุงูฺฉู ฺฉ ฺฉูุงุณ ฺฉุงูู ุจููุณู.

ูุฑุถ ฺฉูุฏ ูโุฎูุงุฏ ุฏุฑ ฺฉ ฺฉูุงุณุ ูุชุฏูุง ุจุฑุง **suspend** ู **resume** ฺฉุฑุฏู ูพุฑุฏุงุฒุด event ุฏุงุดุชู ุจุงุดุฏ:

```csharp
class Foo
{
  int _suspendCount;
  public void SuspendEvents() => _suspendCount++;           
  public void ResumeEvents() => _suspendCount--;            
  void FireSomeEvent()
  {
    if (_suspendCount == 0)
      ... fire some event ...
  }
  ...
}
```

ุงู API ุฏุณุชโููพุงฺฏุฑ ูุณุช ฺูู ูุตุฑูโฺฉููุฏูโูุง ุจุงุฏ ุญุชูุงู **ResumeEvents** ุฑู ุตุฏุง ุจุฒูู. ุจุฑุง ูุทูุฆู ุจูุฏูุ ุจุงุฏ ุงู ฺฉุงุฑ ุฑู ุฏุงุฎู ฺฉ ุจูุงฺฉ **finally** ุงูุฌุงู ุจุฏู (ุฏุฑ ุตูุฑุช ฺฉู Exception ุฑุฎ ุจุฏู):

```csharp
var foo = new Foo();
foo.SuspendEvents();
try
{
  ... do stuff ...      // ููฺฉูู ุงูุฌุง Exception ูพุฑุชุงุจ ุจุดู
}
finally
{
  foo.ResumeEvents();   // ุจุงุฏ ุญุชูุงู ุงูุฌุง ุตุฏุง ุฒุฏู ุจุดู
}
```

ฺฉ ุงูฺฏู ุจูุชุฑ ุงูู ฺฉู ูุชุฏ **ResumeEvents** ุฑู ุญุฐู ฺฉูู ู ูุชุฏ **SuspendEvents** ฺฉ **IDisposable** ุจุฑฺฏุฑุฏููู. ูุตุฑูโฺฉููุฏูโูุง ูโุชููู ุงูุทูุฑ ุงุณุชูุงุฏู ฺฉูู:

```csharp
using (foo.SuspendEvents())
{
  ... do stuff ...
}
```

ุงูุง ูุดฺฉู ุงูุฌุงุณุช ฺฉู ูพุงุฏูโุณุงุฒ ูุชุฏ **SuspendEvents** ุจุฑุง ูุง ุฒุญูุช ุงุถุงูู ุฏุฑุณุช ูโฺฉูู:

```csharp
public IDisposable SuspendEvents()
{
  _suspendCount++;
  return new SuspendToken(this);
}

class SuspendToken : IDisposable 
{
  Foo _foo;          
  public SuspendToken(Foo foo) => _foo = foo;
  public void Dispose()
  {
    if (_foo != null) _foo._suspendCount--;
    _foo = null;  // ุฌููฺฏุฑ ุงุฒ ุฏูุจุงุฑ Dispose ุดุฏู
  }
}
```

---

### ๐ช ุงูฺฏู Anonymous Disposal

ุงู ูุดฺฉู ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ฺฉูุงุณ **Disposable** ูุงุจู ุงุณุชูุงุฏูโ ูุฌุฏุฏ ุญู ูโุดู:

```csharp
public class Disposable : IDisposable
{
  public static Disposable Create(Action onDispose)
    => new Disposable(onDispose);
  Action _onDispose;
  Disposable(Action onDispose) => _onDispose = onDispose;
  public void Dispose()
  {
    _onDispose?.Invoke();   // ุงุฌุฑุง ุนููุงุช Dispose ุฏุฑ ุตูุฑุช ูุฌูุฏ
    _onDispose = null;      // ุฌููฺฏุฑ ุงุฒ ุงุฌุฑุง ุฏูุจุงุฑู
  }
}
```

ุญุงูุง ูโุชููู ูุชุฏ **SuspendEvents** ุฑู ุจูโุดฺฉู ุฒุฑ ุณุงุฏู ฺฉูู:

```csharp
public IDisposable SuspendEvents()
{
  _suspendCount++;
  return Disposable.Create(() => _suspendCount--);
}
```

## โ๏ธ Garbage Collection ุฎูุฏฺฉุงุฑ

ูุฑู ููโฺฉูู ฺฉ ุดุก ูุงุฒููุฏ ูุชุฏ **Dispose** ุจุฑุง ููุทู tear-down ุณูุงุฑุด ุจุงุดู ุง ููุ ุฏุฑ ูุฑ ุตูุฑุช ุญุงูุธูโุง ฺฉู ุฑู heap ุงุดุบุงู ฺฉุฑุฏู ุจุงุฏ ุฏุฑ ฺฉ ููุทู ุขุฒุงุฏ ุจุดู. ุงู ุจุฎุด ุจูโุทูุฑ ฺฉุงูู ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุชูุณุท **CLR** ู ุงุฒ ุทุฑู ฺฉ **Garbage Collector (GC)** ุฎูุฏฺฉุงุฑ ูุฏุฑุช ูโุดู. ุดูุง ูฺโููุช ุญุงูุธูโ ูุฏุฑุชโุดุฏู (Managed Memory) ุฑู ุฎูุฏุชูู ุขุฒุงุฏ ููโฺฉูุฏ.

ูุซุงู:

```csharp
public void Test()
{
  byte[] myArray = new byte[1000];
  ...
}
```

ููุช ูุชุฏ **Test** ุงุฌุฑุง ูโุดูุ ฺฉ ุขุฑุงู ุจุฑุง ูฺฏูุฏุงุฑ ฑฐฐฐ ุจุงุช ุฑู heap ุชุฎุตุต ุฏุงุฏู ูโุดู. ุงู ุขุฑุงู ุชูุณุท ูุชุบุฑ **myArray** ฺฉู ุฑู stack ูุชุบุฑูุง ูุญู ูุฑุงุฑ ุฏุงุฑูุ ูุฑุฌุนโุฏู ูโุดู. ููุช ูุชุฏ ุฎุงุฑุฌ ูโุดูุ ุงู ูุชุบุฑ ูุญู ุงุฒ scope ุฎุงุฑุฌ ูโุดูุ ุนู ุฏฺฏู ูฺ ฺุฒ ุจู ุงูู ุขุฑุงู ุฑู heap ุงุดุงุฑู ููโฺฉูู. ุฏุฑ ุงู ุญุงูุชุ ุขุฑุงูโ ุจโุตุงุญุจ ูโุชููู ุฏุฑ ูุฑุขูุฏ Garbage Collection ุขุฒุงุฏ ุจุดู.

ุฏุฑ **ุญุงูุช Debug** ููุช ุจูููโุณุงุฒโูุง ุบุฑูุนุงู ุจุงุดูุ ุทูู ุนูุฑ ฺฉ ุดุก ฺฉู ุชูุณุท ูุชุบุฑ ูุญู ูุฑุฌุนโุฏู ูโุดู ุชุง ูพุงุงู ุจูุงฺฉ ฺฉุฏ ุงุฏุงูู ูพุฏุง ูโฺฉูู ุชุง ุงุดฺฉุงูโุฒุฏุง ุฑุงุญุชโุชุฑ ุจุงุดู. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุดุก ุฏุฑ ุงููู ููุทูโุง ฺฉู ุฏฺฏู ุงุณุชูุงุฏู ููโุดูุ ูุงุฌุฏ ุดุฑุงุท ุฌูุนโุขูุฑ ูโุดู.

Garbage Collection ุจูุงูุงุตูู ุจุนุฏ ุงุฒ ุจโุตุงุญุจ ุดุฏู ฺฉ ุดุก ุงูุฌุงู ููโุดู. ุฏุฑุณุช ูุซู ุฌูุนโุขูุฑ ุฒุจุงูู ุฏุฑ ุฎุงุจุงูุ ุงู ฺฉุงุฑ ุจูโุตูุฑุช ุฏูุฑูโุง ุงูุฌุงู ูโุดูโุงูุจุชู ุจุฑ ุฎูุงู ุฌูุนโุขูุฑ ุฒุจุงูู ุฏุฑ ุฎุงุจุงูุ ุฒูุงูโุจูุฏ ุซุงุจุช ูุฏุงุฑู. ุชุตูู CLR ุจุฑุง ุงุฌุฑุง GC ุจุฑ ุงุณุงุณ ุนูุงูู ูุซู ูุฒุงู ุญุงูุธูโ ููุฌูุฏุ ุญุฌู ุชุฎุตุต ุญุงูุธูุ ู ูุฏุช ุฒูุงู ฺฏุฐุดุชู ุงุฒ ุขุฎุฑู GC ฺฏุฑูุชู ูโุดู (GC ุฎูุฏุด ุฑู ุจุฑ ุงุณุงุณ ุงูฺฏููุง ุฏุณุชุฑุณ ุญุงูุธูโ ุจุฑูุงูู ุชูุธู ูโฺฉูู).

ุจู ููู ุฎุงุทุฑุ ฺฉ ุชุฃุฎุฑ ูุงูุดุฎุต ุจู ุจโุตุงุญุจ ุดุฏู ฺฉ ุดุก ู ุขุฒุงุฏ ุดุฏู ุญุงูุธูโ ุงูู ูุฌูุฏ ุฏุงุฑู. ุงู ุชุฃุฎุฑ ูโุชููู ุงุฒ ูุงููุซุงูู ุชุง ฺูุฏ ุฑูุฒ ุทูู ุจฺฉุดู.

GC ูููโ ุฒุจุงููโูุง ุฑู ุฏุฑ ูุฑ ุจุงุฑ ุฌูุนโุขูุฑ ูพุงฺฉ ููโฺฉูู.
ูุฏุฑ ุญุงูุธู ุงุดุงุก ุฑู ุจู **generation**โูุง ุชูุณู ูโฺฉูู ู GC ุงุดุงุก ุชุงุฒู (ุฌุฏุฏุงู ุชุฎุตุต ุฏุงุฏูโุดุฏู) ุฑู ุจุดุชุฑ ุงุฒ ุงุดุงุก ูุฏู (ุจุง ุทูู ุนูุฑ ุฒุงุฏ) ุฌูุนโุขูุฑ ูโฺฉูู. ุฌุฒุฆุงุช ุงู ููุถูุน ุฏุฑ ุจุฎุด ยซHow the GC Worksยป (ุตูุญู ตนณ) ุชูุถุญ ุฏุงุฏู ุดุฏู.

---

## ๐ Garbage Collection ู ูุตุฑู ุญุงูุธู

GC ุชูุงุด ูโฺฉูู ุจู **ุฒูุงู ฺฉู ุตุฑู ุฌูุนโุขูุฑ ูโฺฉูู** ู **ูุฒุงู ุญุงูุธูโุง ฺฉู ุจุฑูุงูู ูุตุฑู ูโฺฉูู (Working Set)** ุชุนุงุฏู ุจุฑูุฑุงุฑ ฺฉูู. ุจู ููู ุฏููุ ุจุฑูุงููโูุง ูโุชููู ุจุดุชุฑ ุงุฒ ูุงุฒุดูู ุญุงูุธู ูุตุฑู ฺฉููุ ุจูโูฺู ููุช ุขุฑุงูโูุง ูููุช ุจุฒุฑฺฏ ุณุงุฎุชู ูโุดู.

ุดูุง ูโุชููุฏ ูุตุฑู ุญุงูุธูโ ฺฉ ูพุฑุฏุงุฒู ุฑู ุงุฒ ุทุฑู **Windows Task Manager** ุง **Resource Monitor** ูุงูุชูุฑ ฺฉูุฏโุง ุจูโุตูุฑุช ุจุฑูุงููโููุณุ ุจุง ุงุณุชูุงุฏู ุงุฒ **PerformanceCounter**:

```csharp
// ุงู ุชุงูพโูุง ุฏุฑ System.Diagnostics ูุณุชู:
string procName = Process.GetCurrentProcess().ProcessName;
using PerformanceCounter pc = new PerformanceCounter
     ("Process", "Private Bytes", procName);
Console.WriteLine(pc.NextValue());
```

ุงู ฺฉุฏ **Private Working Set** ุฑู ุจุฑูโฺฏุฑุฏููู ฺฉู ุจูุชุฑู ูุดููู ุจุฑุง ูุตุฑู ุญุงูุธูโ ุจุฑูุงููโุณุช. ุงู ููุฏุงุฑ ุจูโุทูุฑ ุฎุงุต ุญุงูุธูโุง ุฑู ฺฉู CLR ุจูโุตูุฑุช ุฏุงุฎู ุขุฒุงุฏ ฺฉุฑุฏู ู ุขูุงุฏูโุณุช ุจู ุณุณุชูโุนุงูู ูพุณ ุจุฏู (ุงฺฏู ฺฉ ูพุฑุฏุงุฒูโ ุฏฺฏู ุจู ุงูู ูุงุฒ ุฏุงุดุชู ุจุงุดู)ุ ุดุงูู ููโุดู.

---

## ๐ฑ Root

**Root** ฺุฒ ูุณุช ฺฉู ุจุงุนุซ ูโุดู ฺฉ ุดุก ุฒูุฏู ุจูููู. ุงฺฏู ฺฉ ุดุก ุจูโุทูุฑ ูุณุชูู ุง ุบุฑูุณุชูู ุชูุณุท ฺฉ Root ูุฑุฌุนโุฏู ูุดูุ ูุงุฌุฏ ุดุฑุงุท Garbage Collection ูโุดู.

Root ูโุชููู ฺฉ ุงุฒ ููุงุฑุฏ ุฒุฑ ุจุงุดู:

* ฺฉ ูุชุบุฑ ูุญู ุง ูพุงุฑุงูุชุฑ ุฏุฑ ฺฉ ูุชุฏ ุฏุฑ ุญุงู ุงุฌุฑุง (ุง ุฏุฑ ูุฑ ูุชุฏ ุฏุฑ call stack ุงูู)
* ฺฉ ูุชุบุฑ **static**
* ฺฉ ุดุก ุฏุฑ ุตู ฺฉู ุงุดุงุก ุขูุงุฏู ุจุฑุง **Finalization** ุฑู ุฐุฎุฑู ูโฺฉูู

ุงุฒ ุงููโุฌุง ฺฉู ุบุฑููฺฉูู ฺฉุฏ ุฏุฑ ฺฉ ุดุก ุญุฐูโุดุฏู ุงุฌุฑุง ุจุดูุ ุงฺฏู ุงุญุชูุงู ุงุฌุฑุง ฺฉ ูุชุฏ instance ูุฌูุฏ ุฏุงุดุชู ุจุงุดูุ ุงูู ุดุก ุจุงุฏ ุจู ฺฉ ุงุฒ ุงู ุฑูุดโูุง ูุฑุฌุนโุฏู ุจุดู.

ุชูุฌู ฺฉูุฏ ฺฉู ฺฏุฑูู ุงุฒ ุงุดุงุฆ ฺฉู ุจูโุตูุฑุช ฺุฑุฎูโุง ุจู ููุฏฺฏู ูุฑุฌุน ูโุฏูุ ุจุฏูู ฺฉ Root **ูุฑุฏู** ูุญุณูุจ ูโุดู (ุดฺฉู ฑฒ-ฑ ุฑู ุจุจูุฏ). ุจู ุจุงู ุฏฺฏูุ ุงุดุงุฆ ฺฉู ูุชููุฏ ุจุง ุฏูุจุงู ฺฉุฑุฏู ูพฺฉุงูโูุง (references) ุงุฒ ฺฉ Root ุจู ุงููโูุง ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏุ **unreachable** ูุณุชูโู ุจูุงุจุฑุงู ูุดููู ุฌูุนโุขูุฑ ูโุดู.
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/12/Table-12-2.jpeg)
</div>

## โฐ๏ธ Finalizers

ูพุด ุงุฒ ุงูฺฉู ฺฉ ุดุก ุงุฒ ุญุงูุธู ุขุฒุงุฏ ุจุดูุ ุงฺฏุฑ **Finalizer** ุฏุงุดุชู ุจุงุดูุ ุงุฌุฑุง ูโุดู. ฺฉ Finalizer ุดุจู ุจู ฺฉ ุณุงุฒูุฏู (**Constructor**) ุชุนุฑู ูโุดูุ ุจุง ุงู ุชูุงูุช ฺฉู ูุจู ุงุฒ ุงุณู ฺฉูุงุณ ุนูุงูุช `~` ูุฑุงุฑ ูโฺฏุฑู:

```csharp
class Test
{
  ~Test()
  {
    // Finalizer logic...
  }
}
```

(ุงฺฏุฑฺู ุฏุฑ ูุญู ููุดุชู ุดุจู ุณุงุฒูุฏูโุณุชุ ุงูุง **Finalizer**โูุง ููโุชููู `public` ุง `static` ุจุงุดูุ ูพุงุฑุงูุชุฑ ุจฺฏุฑู ุง ุณุงุฒูุฏูโ ูพุงู (base class) ุฑู ุตุฏุง ุจุฒูู.)

ูุฌูุฏ Finalizerูุง ุจู ุงู ุฎุงุทุฑ ููฺฉูู ฺฉู ูุฑุขูุฏ Garbage Collection ุฏุฑ ฺูุฏู ูุงุฒ ุงูุฌุงู ูโุดู. ุฏุฑ ูุฑุญููโ ุงููุ GC ุงุดุงุก ุจูุงุงุณุชูุงุฏู ุฑู ุดูุงุณุง ูโฺฉูู. ุงููโูุง ฺฉู Finalizer ูุฏุงุฑูุ ููุฑุงู ุญุฐู ูโุดู. ุงูุง ุงุดุงุฆ ฺฉู Finalizer ุฏุงุฑูุ ูููุชุงู ุฒูุฏู ูฺฏู ุฏุงุดุชู ูโุดู ู ุชู ฺฉ ุตู ุฎุงุต ูุฑุงุฑ ูโฺฏุฑู.

ุฏุฑ ุงูู ูุญุธูุ ูุฑุขูุฏ Garbage Collection ุชููู ูโุดู ู ุจุฑูุงููโ ุดูุง ุจู ุงุฌุฑุง ุฎูุฏุด ุงุฏุงูู ูโุฏู. ุจุนุฏ ูุฎ (Thread) ูุฑุจูุท ุจู Finalizer ูุงุฑุฏ ุนูู ูโุดู ู ุจูโุตูุฑุช ููุงุฒ ุจุง ุจุฑูุงูู ุงุฌุฑุง ูโุดูุ ุงุดุงุก ุฑู ุงุฒ ุตู ุจุฑูโุฏุงุฑู ู ูุชุฏ Finalizer ุงููโูุง ุฑู ุงุฌุฑุง ูโฺฉูู.

ุชุง ูพุด ุงุฒ ุงุฌุฑุง Finalizer ูุฑ ุดุกุ ุงูู ูููุฒ ยซุฒูุฏูยป ุญุณุงุจ ูโุดูโฺูู ุงูู ุตู ุจูโุนููุงู ฺฉ Root ุนูู ูโฺฉูู. ุจุนุฏ ุงุฒ ุฎุงุฑุฌ ุดุฏู ุงุฒ ุตู ู ุงุฌุฑุง Finalizerุ ุดุก ุจโุตุงุญุจ ูโุดู ู ุฏุฑ ุฌูุนโุขูุฑ ุจุนุฏ (ุจุฑุง ูููู Generation) ุญุฐู ุฎูุงูุฏ ุดุฏ.

---

### โ๏ธ ูฺฉุงุช ููู ุฏุฑุจุงุฑู Finalizerูุง

* ๐ซ Finalizerูุง ุณุฑุนุช ุชุฎุตุต ู ุฌูุนโุขูุฑ ุญุงูุธู ุฑู ฺฉุงูุด ูโุฏู (ฺูู GC ุจุงุฏ ุฏูุจุงู ฺฉูู ฺฉู ฺฉุฏูู Finalizer ุงุฌุฑุง ุดุฏู).
* โณ ุทูู ุนูุฑ ุดุก ู ุงุดุงุก ูุฑุฌุน ุงููโูุง ุฑู ุทููุงูโุชุฑ ูโฺฉูู.
* ๐ ุชุฑุชุจ ุงุฌุฑุง Finalizerูุง ุจุฑุง ูุฌููุนูโุง ุงุฒ ุงุดุงุก ุบุฑูุงุจู ูพุดโุจูู.
* ๐๏ธ ฺฉูุชุฑู ุดูุง ุฑู ุฒูุงู ุงุฌุฑุง Finalizer ุฎู ูุญุฏูุฏู.
* ๐ ุงฺฏุฑ ฺฉุฏ ุฏุฑ Finalizer ูุณุฏูุฏ ุจุดูุ ุจูู ุงุดุงุก ูู ููโุชููู Finalize ุจุดู.
* โ Finalizerูุง ููฺฉูู ุจูโุทูุฑ ฺฉุงูู ุฏูุฑ ุฒุฏู ุจุดู ุงฺฏุฑ ุจุฑูุงูู ุจูโุฏุฑุณุช unload ูุดู.

๐ ุฏุฑ ฺฉูุ Finalizerูุง ุดุจู ูฺฉู ูุณุชูโูุฑฺูุฏ ุฏุฑ ุจุนุถ ุดุฑุงุท ูุงูุนุงู ุจูุดูู ูุงุฒ ุฏุงุฑุฏุ ูู ุจูโุทูุฑ ฺฉู ุจูุชุฑู ูฺฏุฑ ุฏุฑ ุตูุฑุช ุถุฑูุฑุช ูุทูู ุงุฒุดูู ุงุณุชูุงุฏู ูฺฉูุฏ.

---

### ๐ ุฏุณุชูุฑุงูุนููโูุง ูพุงุฏูโุณุงุฒ Finalizerูุง

* โ ูุทูุฆู ุจุดุฏ Finalizer ุณุฑุน ุงุฌุฑุง ูโุดู.
* โ ูุฑฺฏุฒ ุฏุฑ Finalizer ุจูุงฺฉ ูฺฉูุฏ (ุจู ุจุฎุด โBlockingโ ุฏุฑ ุตูุญู ถณด ูุฑุงุฌุนู ฺฉูุฏ).
* ๐ซ ุจู ุงุดุงุก ุฏฺฏูโุง ฺฉู ุฎูุฏุดูู Finalizer ุฏุงุฑู ุงุฑุฌุงุน ูุฏุฏ.
* โ ุงุณุชุซูุง (Exception) ูพุฑุชุงุจ ูฺฉูุฏ.

> ูฺฉุชู: CLR ูโุชููู Finalizer ฺฉ ุดุก ุฑู ุญุช ุงฺฏุฑ ุฏุฑ ุทูู ุณุงุฒูุฏู ุงุณุชุซูุง ุฑุฎ ุฏุงุฏู ุจุงุดูุ ูุฑุงุฎูุงู ฺฉูู. ูพุณ ูุจุงุฏ ูุฑุถ ฺฉูุฏ ููุฏูุง ููุดู ุจูโุฏุฑุณุช ููุฏุงุฑุฏู ุดุฏู.

---

## ๐ ูุฑุงุฎูุงู Dispose ุงุฒ Finalizer

ฺฉ ุงูฺฏู ูุชุฏุงูู ุงูู ฺฉู Finalizer ูุชุฏ **Dispose** ุฑู ูุฑุงุฎูุงู ฺฉูู. ุงู ฺฉุงุฑ ููุทูู ููุช ูพุงฺฉโุณุงุฒ ููุฑ ูุงุฒู ูุณุช ู ุตุฏุง ุฒุฏู Dispose ุจุดุชุฑ ฺฉ **ุจูููโุณุงุฒ** ุญุณุงุจ ูโุดู ุชุง ฺฉ ุถุฑูุฑุช.

ุงูุง ุชูุฌู ฺฉูุฏ ฺฉู ุงู ุงูฺฏู ุจุงุนุซ ูโุดู ุขุฒุงุฏุณุงุฒ ุญุงูุธู ู ุขุฒุงุฏุณุงุฒ ููุงุจุน (Resource) ุจู ูู ฺฏุฑู ุจุฎูุฑูโฺฉู ููฺฉูู ุงูุฏุงู ูุชูุงูุช ุฏุงุดุชู ุจุงุดู. ููฺูู ุจุงุฑ ุจุดุชุฑ ุจู ูุฎ Finalizer ูุงุฑุฏ ูโฺฉูู.

ุงู ุงูฺฏู ุจูโุนููุงู **ูพุดุชุจุงู** ูู ุจูโฺฉุงุฑ ูโุฑูุ ุจุฑุง ููุช ฺฉู ูุตุฑูโฺฉููุฏู ุดุก ูุฑุงููุด ฺฉูู Dispose ุฑู ุตุฏุง ุจุฒูู. ุฏุฑ ุงู ุญุงูุชุ ุจูุชุฑู ุฎุทุง ุฑู ูุงฺฏ ฺฉูุฏ ุชุง ุจุนุฏุงู ุจุชููุฏ ูุดฺฉู ุฑู ุฑูุน ฺฉูุฏ.

ฺฉ ุงูฺฏู ุงุณุชุงูุฏุงุฑุฏ ุจุฑุง ูพุงุฏูโุณุงุฒ ุงู ุฑูุด ุจู ุดฺฉู ุฒุฑู:

```csharp
class Test : IDisposable
{
  public void Dispose()             // NOT virtual
  {
    Dispose(true);
    GC.SuppressFinalize(this);     // ูุงูุน ุงุฌุฑุง Finalizer ูโุดู
  }

  protected virtual void Dispose(bool disposing)
  {
    if (disposing)
    {
      // Dispose ุฑู ุงุดุงุก ุฏฺฏูโุง ฺฉู ูุชุนูู ุจู ุงู ุดุก ูุณุชู.
      // ูโุชููุฏ ุงูุฌุง ุจู ุงุดุงุก Finalizable ูู ุงุฑุฌุงุน ุจุฏุฏ.
    }

    // ุขุฒุงุฏุณุงุฒ ููุงุจุน unmanaged ูุชุนูู ุจู ููู ุดุก.
  }

  ~Test() => Dispose(false);
}
```

ุฏุฑ ุงูุฌุง:

* ูุชุฏ **Dispose ุจุฏูู ูพุงุฑุงูุชุฑ**ุ `virtual` ูุณุช ู ููุท ูุณุฎูโ ุชูุณุนูโุงูุชู ุฑู ุจุง ููุฏุงุฑ `true` ุตุฏุง ูโุฒูู.
* ูุณุฎูโ ุชูุณุนูโุงูุชู `protected` ู `virtual` ูุณุช ู ููุทู ุงุตู ุขุฒุงุฏุณุงุฒ ุฑู ุฏุงุฑู.
* ูพุงุฑุงูุชุฑ **disposing** ูุดุฎุต ูโฺฉูู ุขุง ูุชุฏ ุงุฒ Dispose ุตุฏุง ุฒุฏู ุดุฏู (true) ุง ุงุฒ Finalizer (false).

ููุช disposing ุจุฑุงุจุฑ false ุจุงุดูุ ูุจุงุฏ ุจู ุงุดุงุฆ ฺฉู Finalizer ุฏุงุฑู ุงุฑุฌุงุน ุจุฏุฏุ ฺูู ููฺฉูู ุฎูุฏุดูู ูุจูุงู Finalize ุดุฏู ุจุงุดู.

ฺฉุงุฑูุง ฺฉู ููฺูุงู ุฏุฑ ุงู ุญุงูุช ูโุดู ุงูุฌุงู ุฏุงุฏ:

* ุขุฒุงุฏ ฺฉุฑุฏู ูุฑุงุฌุน ูุณุชูู ุจู ููุงุจุน ุณุณุชูโุนุงูู (ูุซูุงู ุงุฒ ุทุฑู P/Invoke ุจู Win32 API).
* ุญุฐู ูุงู ูููุช ฺฉู ุฏุฑ ุณุงุฒูุฏู ุณุงุฎุชู ุดุฏู.

ุจุฑุง ููุงููโุณุงุฒุ ูุฑ ฺฉุฏ ฺฉู ููฺฉูู ุงุณุชุซูุง ูพุฑุชุงุจ ฺฉูู ุจุงุฏ ุฏุฑ ุจููฺฉ try/catch ูุฑุงุฑ ุจฺฏุฑู ู ุงุณุชุซูุง ูุงฺฏ ุจุดู (ุจู ุณุงุฏูโุชุฑู ู ูุทูุฆูโุชุฑู ุดฺฉู).

ูุฑุงุฎูุงู **GC.SuppressFinalize** ุฏุฑ Dispose ุจุฏูู ูพุงุฑุงูุชุฑ ุจุงุนุซ ูโุดู Finalizer ุจุนุฏุงู ุงุฌุฑุง ูุดู. ุงู ฺฉุงุฑ ุนูุงูู ุจุฑ ุจูุจูุฏ ฺฉุงุฑุงุ ุงุฌุงุฒู ูโุฏู ุดุก (ู ุงุดุงุก ูุฑุฌุน ุงูู) ุฏุฑ ฺฉ ฺุฑุฎู GC ุขุฒุงุฏ ุจุดู.

---

## ๐ง Resurrection

ูุฑุถ ฺฉูุฏ ฺฉ Finalizerุ ุดุก ุฒูุฏูโุง ุฑู ุทูุฑ ุชุบุฑ ุจุฏู ฺฉู ุจู ุดุก ุฏุฑ ุญุงู ูุฑฺฏ ุงุฑุฌุงุน ุจุฏู. ุฏุฑ ุงู ุตูุฑุชุ ููุช GC ุจุนุฏ ุงุฌุฑุง ุจุดูุ CLR ุงูู ุดุก ุฑู ุฏฺฏู ุจโุตุงุญุจ ููโุจูู ู ุจูุงุจุฑุงู ุงุฒ ุฌูุนโุขูุฑ ูุฑุงุฑ ูโฺฉูู. ุจู ุงู ุณูุงุฑู **Resurrection** ูโฺฏู.

ูุซุงู: ููุดุชู ฺฉูุงุณ ุจุฑุง ูุฏุฑุช ฺฉ ูุงู ูููุช:

```csharp
public class TempFileRef
{
  public readonly string FilePath;
  public TempFileRef(string filePath) { FilePath = filePath; }
  ~TempFileRef() { File.Delete(FilePath); }
}
```

โ๏ธ ูุดฺฉู: `File.Delete` ููฺฉูู ุงุณุชุซูุง ูพุฑุชุงุจ ฺฉูู (ูุซูุงู ุจู ุฎุงุทุฑ ูุฏุงุดุชู ุฏุณุชุฑุณุ ุฏุฑ ุญุงู ุงุณุชูุงุฏู ุจูุฏู ูุงู ุง ูุจูุงู ุญุฐู ุดุฏู). ุงู ุฎุทุง ุจุงุนุซ ฺฉุฑุด ฺฉู ุจุฑูุงูู ูโุดู ู ูุงูุน ุงุฌุฑุง Finalizerูุง ุฏฺฏู ูู ุฎูุงูุฏ ุดุฏ.

ูโุชููู ุงุณุชุซูุง ุฑู ุจุง ฺฉ ุจููฺฉ catch ุฎุงู ุจุจูุนูุ ุงูุง ูฺโููุช ูุชูุฌู ููโุดู ฺฉู ุฎุทุง ุฑุฎ ุฏุงุฏู. ุง ูโุชููู ฺฉ API ูพฺุฏูโ ฺฏุฒุงุฑุด ุฎุทุง ุตุฏุง ุจุฒููุ ุงูุง ุงู ุจุงุฑ ูุฎ Finalizer ุฑู ุณูฺฏู ูโฺฉูู. ุจูุงุจุฑุงู ุจุงุฏ ุนููุงุช Finalizer ุฑู ุจู ูุธุงู ุณุงุฏูุ ูุทูุฆู ู ุณุฑุน ูุญุฏูุฏ ฺฉูู.

ุฑุงู ุจูุชุฑ: ุซุจุช ุฎุทุง ุฏุฑ ฺฉ ฺฉุงูฺฉุดู ุงุณุชุงุชฺฉ:

```csharp
public class TempFileRef
{
  static internal readonly ConcurrentQueue<TempFileRef> FailedDeletions
    = new ConcurrentQueue<TempFileRef>();

  public readonly string FilePath;
  public Exception DeletionError { get; private set; }

  public TempFileRef(string filePath) { FilePath = filePath; }

  ~TempFileRef()
  {
    try { File.Delete(FilePath); }
    catch (Exception ex)
    {
      DeletionError = ex;
      FailedDeletions.Enqueue(this);   // Resurrection
    }
  }
}
```

ุงุถุงูู ฺฉุฑุฏู ุดุก ุจู ฺฉุงูฺฉุดู **FailedDeletions** ฺฉ ูุฑุฌุน ุฌุฏุฏ ุจุฑุงุด ุงุฌุงุฏ ูโฺฉูู ู ุจุงุนุซ ูโุดู ุฒูุฏู ุจูููู ุชุง ุฒูุงู ฺฉู dequeue ุจุดู.

`ConcurrentQueue<T>` ูุณุฎูโ **Thread-Safe** ุงุฒ `Queue<T>` ูุณุช ู ุฏุฑ ูุถุง ูุงู `System.Collections.Concurrent` ุชุนุฑู ุดุฏู (ุจุฎุด ฒฒ).

ุฏูุงู ุงุณุชูุงุฏู ุงุฒ ฺฉุงูฺฉุดู Thread-Safe:

1. CLR ูโุชููู Finalizerูุง ุฑู ุฑู ุจุด ุงุฒ ฺฉ Thread ุจูโุทูุฑ ููุงุฒ ุงุฌุฑุง ฺฉููุ ูพุณ ููุช ุจู state ูุดุชุฑฺฉ ูุซู ฺฉ ฺฉุงูฺฉุดู ุงุณุชุงุชฺฉ ุฏุณุชุฑุณ ุฏุงุฑูุ ุจุงุฏ ุงุญุชูุงู Finalize ุดุฏู ููโุฒูุงู ุฏู ุดุก ุฑู ุฏุฑ ูุธุฑ ุจฺฏุฑู.
2. ุฏุฑ ููุงุช ุจุงุฏ ุงุดุงุก ุฑู ุงุฒ `FailedDeletions` dequeue ฺฉูู ุชุง ุจุชููู ฺฉุงุฑ ุจุฑุงุดูู ุงูุฌุงู ุจุฏู. ุงู ุนููุงุช ูู ุจุงุฏ Thread-Safe ุจุงุดูุ ฺูู ููฺฉูู ููโุฒูุงู ุจุง enqueue ุดุฏู ฺฉ ุดุก ุชูุณุท Finalizer ุงูุฌุงู ุจุดู.

## ๐ GC.ReRegisterForFinalize

ฺฉ ุดุก ฺฉู **Resurrect** ุดุฏู (ุฏูุจุงุฑู ุฒูุฏู ุดุฏู) ุฏฺฏู Finalizerุด ุจุฑุง ุจุงุฑ ุฏูู ุงุฌุฑุง ููโุดูโูฺฏุฑ ุงูฺฉู ุดูุง ูุชุฏ **GC.ReRegisterForFinalize** ุฑู ุตุฏุง ุจุฒูุฏ.

ุฏุฑ ูุซุงู ุฒุฑุ ูุง ุชูุงุด ูโฺฉูู ุฏุฑ Finalizer ฺฉ ูุงู ูููุช ุฑู ุญุฐู ฺฉูู (ูุซู ูุซุงู ูุจู). ุงูุง ุงฺฏุฑ ุญุฐู ุดฺฉุณุช ุฎูุฑุฏุ ุดุก ุฑู ุฏูุจุงุฑู ุซุจุช ูโฺฉูู ุชุง ุฏุฑ Garbage Collection ุจุนุฏ ุฏูุจุงุฑู ุงูุชุญุงู ฺฉูู:

```csharp
public class TempFileRef
{
  public readonly string FilePath;
  int _deleteAttempt;

  public TempFileRef(string filePath) { FilePath = filePath; }

  ~TempFileRef()
  {
    try { File.Delete(FilePath); }
    catch
    {
      if (_deleteAttempt++ < 3)
        GC.ReRegisterForFinalize(this);
    }
  }
}
```

ุจุนุฏ ุงุฒ ุณููู ุชูุงุด ูุงููููุ Finalizer ูุง ุจุฏูู ุณุฑ ู ุตุฏุง ุงุฒ ุญุฐู ูุงู ุฏุณุช ูโฺฉุดู.
๐ง ูโุชููู ุงู ุฑู ุจูุชุฑ ฺฉูู ู ุจุง ูุซุงู ูุจู ุชุฑฺฉุจ ฺฉููโุนู ุจุนุฏ ุงุฒ ุณููู ุดฺฉุณุชุ ุดุก ุฑู ุจู ุตู **FailedDeletions** ุงุถุงูู ฺฉูู.

โ๏ธ ุชูุฌู:
ุญุชูุงู ููุท **ฺฉโุจุงุฑ** ุฏุฑูู Finalizer ูุชุฏ ReRegisterForFinalize ุฑู ุตุฏุง ุจุฒูุฏ.
ุงฺฏู ุฏูุจุงุฑ ุตุฏุง ุจุฒูุฏุ ุดุก ุฏูุจุงุฑู ุฏูุจุงุฑ ุซุจุช ูโุดู ู ุจุงุฏ ุฏู ุจุงุฑ ุฏฺฏู Finalize ุจุดู!

---

## โ๏ธ GC ฺฺฏููู ฺฉุงุฑ ูโฺฉูุฏุ

**CLR** ุงุฒ ฺฉ Garbage Collector ุงุณุชุงูุฏุงุฑุฏ **Generational Mark-and-Compact** ุงุณุชูุงุฏู ูโฺฉูู ฺฉู ูุฏุฑุช ุญุงูุธูโ ุฎูุฏฺฉุงุฑ ุจุฑุง ุงุดุงุก ุฐุฎุฑูโุดุฏู ุฏุฑ **Managed Heap** ุฑู ุงูุฌุงู ูโุฏู.

GC ฺฉ **Tracing GC** ูุญุณูุจ ูโุดูุ ฺูู ุฌูู ูุฑ ุฏุณุชุฑุณ ุจู ุดุก ุฑู ููโฺฏุฑู. ุจูฺฉู ุจูโุทูุฑ ุฏูุฑูโุง ุจุฏุงุฑ ูโุดู ู ฺฏุฑุงู ุงุดุงุก ููุฌูุฏ ุฏุฑ heap ุฑู ุฏูุจุงู ูโฺฉูู ุชุง ุจูููู ฺฉุฏูู ุงุดุงุก ุฏฺฏู ุงุณุชูุงุฏู ููโุดู ู ุจุงุฏ ุฌูุนโุขูุฑ ุจุดู.

---

### ๐๏ธ ฺู ุฒูุงู GC ูุนุงู ูโุดูุ

* ููุช ุชุฎุตุต ุญุงูุธู ุฌุฏุฏ ุจุง `new` ุงูุฌุงู ุจุดู ู ููุฏุงุฑ ูุดุฎุต ุงุฒ ุญุงูุธู ูุตุฑู ุดุฏู ุจุงุดู.
* ุง ุฏุฑ ุฒูุงูโูุง ุฏฺฏู ุจุฑุง ฺฉุงูุด ูุฒุงู ุญุงูุธู ูุตุฑู ุจุฑูุงูู.
* ููฺูู ูโุชููุฏ ุจูโุตูุฑุช ุฏุณุช ูุชุฏ `System.GC.Collect` ุฑู ุตุฏุง ุจุฒูุฏ.

๐ ุฏุฑ ุทูู Garbage Collectionุ ููฺฉูู ูููโ Threadูุง ูุชููู (Freeze) ุจุดู (ุชูุถุญุงุช ุจุดุชุฑ ุฏุฑ ุจุฎุด ุจุนุฏ).

---

### ๐ ูุฑุขูุฏ ุฌูุนโุขูุฑ

1. GC ุงุฒ **Root object references** ุดุฑูุน ูโฺฉูู ู ฺฏุฑุงู ุงุดุงุก ุฑู ุฏูุจุงู ูโฺฉูู.
2. ูููโ ุงุดุงุฆ ฺฉู ุฏุฑ ุงู ูุณุฑ ููุณ ุจุดู ุจูโุนููุงู **reachable** ุนูุงูุชโฺฏุฐุงุฑ ูโุดู.
3. ุงุดุงุฆ ฺฉู ุนูุงูุช ูุฎูุฑุฏู ุจุงุดูุ ุจูุงุงุณุชูุงุฏู ูุญุณูุจ ูโุดู ู ูุงุจู ุฌูุนโุขูุฑ ูุณุชู.

   * ุงุดุงุก ุจูุงุงุณุชูุงุฏู **ุจุฏูู Finalizer** ููุฑุงู ุญุฐู ูโุดู.
   * ุงุดุงุก ุจูุงุงุณุชูุงุฏู **ุฏุงุฑุง Finalizer** ุจู ุตู Finalizer Thread ุงุถุงูู ูโุดู ู ุฏุฑ GC ุจุนุฏ (ุจุฑุง ูููู Generation) ุญุฐู ุฎูุงููุฏ ุดุฏ (ูฺฏุฑ ุงูฺฉู Resurrect ุจุดู).
4. ุงุดุงุก ุจุงูโูุงูุฏูโ ุฒูุฏู ุจู ุงุจุชุฏุง Heap ููุชูู ูโุดู (**Compaction**).

๐ ูุฒุงุง:

* ุฌููฺฏุฑ ุงุฒ **Fragmentation** ุญุงูุธู.
* ุณุงุฏูโุชุฑ ุดุฏู ุงุณุชุฑุงุชฺ ุชุฎุตุต ุญุงูุธู (ููุดู ุฏุฑ ุงูุชูุง Heap).

---

### ๐จ ุฎุทุง ฺฉูุจูุฏ ุญุงูุธู

ุงฺฏุฑ ุจุนุฏ ุงุฒ Garbage Collection ูุถุง ฺฉุงู ุจุฑุง ุชุฎุตุต ุญุงูุธู ุฌุฏุฏ ูุจุงุดู ู ุณุณุชูโุนุงูู ูู ูุชููู ุญุงูุธู ุจุดุชุฑ ุจุฏูุ ฺฉ **OutOfMemoryException** ูพุฑุชุงุจ ูโุดู.

---

### ๐ ูุธุงุฑุช ุจุฑ ูุถุนุช Heap

ูโุชููุฏ ุงุทูุงุนุงุช ูุถุนุช ูุนู Heap ุฑู ุจุง ูุฑุงุฎูุงู:

```csharp
GC.GetGCMemoryInfo();
```

ุงุฒ .NET 5 ุจู ุจุนุฏุ ุงู ูุชุฏ ุฏุงุฏูโูุง ูุฑุจูุท ุจู ฺฉุงุฑุง ุฑู ูู ุจุฑูโฺฏุฑุฏููู.

---

## ๐ ุชฺฉูฺฉโูุง ุจูููโุณุงุฒ GC

### ๐ฑ Generational Collection

ูููโุชุฑู ุจูููโุณุงุฒ GC ุงูู ฺฉู **ูุณู (Generational)** ุนูู ูโฺฉูู.

ูุดุงูุฏู ุดุฏู ฺฉู ุฎู ุงุฒ ุงุดุงุก ุณุฑุน ุณุงุฎุชู ู ุณุฑุน ูู ุฑูุง ูโุดูุ ุงูุง ุจุนุถ ุงุฒ ุงุดุงุก **ุทูู ุนูุฑ ุจุดุชุฑ** ุฏุงุฑู ู ูุงุฒ ูุณุช ูุฑ ุจุงุฑ ุจุฑุฑุณ ุจุดู.

ุจู ููู ุฎุงุทุฑุ Heap ุจู ุณู ูุณู ุชูุณู ูโุดู:

* **Gen0** โ ุงุดุงุก ุชุงุฒู ุณุงุฎุชูโุดุฏู.
* **Gen1** โ ุงุดุงุฆ ฺฉู ฺฉ ฺุฑุฎู GC ุฑู ูพุดุช ุณุฑ ฺฏุฐุงุดุชู.
* **Gen2** โ ูููโ ุงุดุงุก ุฏฺฏู (ุจููุฏูุฏุช).

> Gen0 ู Gen1 ุจูโุนููุงู ูุณูโูุง **Ephemeral (ฺฉูุชุงูโุนูุฑ)** ุดูุงุฎุชู ูโุดู.

---

### โก ุงูุฏุงุฒู ูุณูโูุง

* ุจุฎุด Gen0 ูุนูููุงู ฺฉูฺฺฉู (ฺูุฏ ุตุฏ KB ุชุง ฺูุฏ MB).
* ููุช Gen0 ูพุฑ ูโุดูุ ฺฉ **Gen0 Collection** ุงุชูุงู ูโุงูุชู (ุฎู ุณุฑุน ู ุฑุงุฌ).
* ููู ููุทู ุจุฑุง Gen1 ูู ูุฌูุฏ ุฏุงุฑู (ูุซู ฺฉ ุจุงูุฑ ุจุฑุง Gen2).
* ุงูุง **Full Collection** (ฺฉู ุดุงูู Gen2 ูู ูโุดู) ุฎู ุณูฺฏูโุชุฑู ู ุจูโูุฏุฑุช ุงุชูุงู ูโุงูุชู.

๐ ุดฺฉู 12-2 ุฏุฑ ฺฉุชุงุจ ุงุซุฑ ฺฉ Full Collection ุฑู ูุดูู ูโุฏู.
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/12/Table-12-3.jpeg)
</div>

## โก ุณุฑุนุช ุฌูุนโุขูุฑ ูุณูโูุง (Gen0 ู Gen2)

ุจูโุทูุฑ ุชูุฑุจ:

* ฺฉ **Gen0 Collection** ูุนูููุงู ฺฉูุชุฑ ุงุฒ **ฑ ููโุซุงูู** ุทูู ูโฺฉุดู ๐ ู ุฏุฑ ฺฉ ุจุฑูุงููโ ุนุงุฏ ุงุตูุงู ูุงุจู ุชูุฌู ูุณุช.
* ฺฉ **Full Collection (ุดุงูู Gen2)** ููฺฉูู ุชุง **ฑฐฐ ููโุซุงูู** ุทูู ุจฺฉุดู โณุ ูุฎุตูุตุงู ุฏุฑ ุจุฑูุงููโูุง ุจุง ฺฏุฑุงู ุงุดุงุก ุจุฒุฑฺฏ.

ุงู ุงุนุฏุงุฏ ุจุณุชู ุจู ุดุฑุงุท ุฎู ุชุบุฑ ูโฺฉููุ ุจูโูฺู ุฏุฑ ููุฑุฏ **Gen2** ฺฉู ุงูุฏุงุฒูโ ุซุงุจุช ูุฏุงุฑู (ุจุฑุฎูุงู Gen0 ู Gen1).
๐ ูุชุฌู: ุงุดุงุก ฺฉูุชุงูโุนูุฑ ุฎู ุจููู ุจุง GC ฺฉุงุฑ ูโฺฉูู.

ูุซูุงู ุฏุฑ ุงู ูุชุฏุ StringBuilderูุง ฺฉู ุณุงุฎุชู ุดุฏู ุจู ุงุญุชูุงู ุฒุงุฏ ุฎู ุณุฑุน ุชู Gen0 ุฌูุนโุขูุฑ ูโุดู:

```csharp
string Foo()
{
  var sb1 = new StringBuilder("test");
  sb1.Append("...");
  var sb2 = new StringBuilder("test");
  sb2.Append(sb1.ToString());
  return sb2.ToString();
}
```

---

## ๐๏ธ Large Object Heap (LOH)

GC ฺฉ heap ุฌุฏุงฺฏุงูู ุจุฑุง ุงุดุงุก ุจุฒุฑฺฏโุชุฑ ุงุฒ **ธต,ฐฐฐ ุจุงุช** ุฏุงุฑู.
ูุฏูุด ุงูู ฺฉู:

* ูุฒููโ ุจุงูุง ุฌุงุจูโุฌุง (Compaction) ุงุดุงุก ุจุฒุฑฺฏ ุฑู ุญุฐู ฺฉูู.
* ุฌูู ุชุฑฺฏุฑ ุดุฏู ูฺฉุฑุฑ Gen0 Collection ุฑู ุจฺฏุฑู.

### ูฺฺฏโูุง

* **ูพุดโูุฑุถ**: LOH ูุดุฑุฏู (Compact) ููโุดูุ ฺูู ุฌุงุจูโุฌุง ุจููฺฉโูุง ุฎู ุจุฒุฑฺฏ ูุฒููโ ุฒุงุฏ ุฏุงุฑู.
* **ูุชุงุฌ**:

  * ุชุฎุตุต ุญุงูุธู ฺฉูุฏุชุฑ ูโุดู ฺูู GC ุจุงุฏ ุชู ูุณุท heap ูู ุฏูุจุงู ุญูุฑูโูุง ุขุฒุงุฏ ุจฺฏุฑุฏู (ุจุง ูุณุช ูพููุฏ).
  * **Fragmentation** ุฑุฎ ูโุฏู: ุขุฒุงุฏ ุดุฏู ฺฉ ุดุก ููฺฉูู ุญูุฑูโุง ุงุฌุงุฏ ฺฉูู ฺฉู ุจุนุฏุงู ุณุฎุช ูพุฑ ุจุดู. ูุซูุงู ุญูุฑูโ ูุฑุจูุท ุจู ุดุก ธถ,ฐฐฐ ุจุงุช ููุท ุจุง ุงุดุงุฆ ูพุฑ ูโุดู ฺฉู ุจู ธต,ฐฐฐ ุชุง ธถ,ฐฐฐ ุจุงุช ุจุงุดู (ูฺฏุฑ ุงูฺฉู ุจุง ุญูุฑูโูุง ุฏฺฏู ฺฉ ุจุดู).

### ุฑุงูฺฉุงุฑูุง

1. ูุดุฑุฏูโุณุงุฒ LOH ุฏุฑ ุฌูุนโุขูุฑ ุจุนุฏ:

   ```csharp
   GCSettings.LargeObjectHeapCompactionMode =
       GCLargeObjectHeapCompactionMode.CompactOnce;
   ```

2. ุงุณุชูุงุฏู ุงุฒ **Array Pooling** (ุตูุญู 599) ุจุฑุง ุจุฑูุงููโูุง ฺฉู ุฒุงุฏ ุขุฑุงูโูุง ุจุฒุฑฺฏ ูโุณุงุฒู.

๐ ูฺฉุชู: LOH ูุณู (Generational) ูุณุชโูููโ ุงุดุงุก LOH ุฏุฑ Gen2 ูุฑุงุฑ ูโฺฏุฑู.

---

## ๐ฅ๏ธ Workstation vs Server Collection

.NET ุฏู ุญุงูุช GC ุงุฑุงุฆู ูโุฏู:

* **Workstation (ูพุดโูุฑุถ)**
* **Server** (ุจุฑุง ูพุฑุฏุงุฒุดโูุง ุณูฺฏู)

ูุนุงูโุณุงุฒ ุญุงูุช Server ุฏุฑ `.csproj`:

```xml
<PropertyGroup>
  <ServerGarbageCollection>true</ServerGarbageCollection>
</PropertyGroup>
```

ู ุฏุฑ ูุงู `.runtimeconfig.json` ูุงุฏ:

```json
"runtimeOptions": {
  "configProperties": {
    "System.GC.Server": true
  }
}
```

### ุชูุงูุชโูุง

* ุฏุฑ ุญุงูุช **Server**ุ CLR ุจุฑุง ูุฑ **ูุณุชูโ CPU** ฺฉ Heap ู ฺฉ GC ุฌุฏุง ุฏุฑุณุช ูโฺฉูู.

  * โ ุณุฑุนุช ุจุงูุงุชุฑ ุฏุฑ ุฌูุนโุขูุฑ
  * โ ูุตุฑู ุจุดุชุฑ ุญุงูุธู ู CPU (ูุฑ ูุณุชู ฺฉ Thread ุงุฎุชุตุงุต ูโุฎูุงุฏ)
* ุฏุฑ ุณุณุชูโูุง ุจุง ูพุฑุฏุงุฒุดโูุง ุฒุงุฏุ ุงู ููุถูุน ูโุชููู ุจุงุนุซ **CPU Oversubscription** ุจุดู โ ุณุณุชู ฺฉูุฏ ู ุบุฑูุงุจูโูพุงุณุฎ ุจู ูุธุฑ ูุงุฏ.
* ููุท ุฑู ุณุณุชูโูุง **ฺูุฏโูุณุชูโุง** ูุนุงู ูโุดู. ุฑู ุชฺฉโูุณุชูโุงโูุง (ุง VM ุชฺฉโูุณุชูโุง) ูุงุฏุฏู ฺฏุฑูุชู ูโุดู.

---

## ๐ Background Collection

ุฏุฑ ูุฑ ุฏู ุญุงูุช Workstation ู Serverุ ูพุดโูุฑุถ **Background GC** ูุนุงูู.

ูโุชููุฏ ุฏุฑ `.csproj` ุบุฑูุนุงูุด ฺฉูุฏ:

```xml
<PropertyGroup>
  <ConcurrentGarbageCollection>false</ConcurrentGarbageCollection>
</PropertyGroup>
```

ู ุฏุฑ `.runtimeconfig.json`:

```json
"runtimeOptions": {
  "configProperties": {
    "System.GC.Concurrent": false
  }
}
```

### ุงุซุฑุงุช

* ุจุง ูุนุงู ุจูุฏู:

  * ุงูพูฺฉุดู ุฑูุงูโุชุฑู ฺูู **Pauseูุง** ฺฉูุชุงูโุชุฑ ูโุดู.
  * ูุฒููโ ฺฉู ุฑู CPU ู ุญุงูุธู ุฏุงุฑู.
* ุจุง ุบุฑูุนุงู ุจูุฏู:

  * ูุตุฑู CPU ู ุญุงูุธู ฺฉู ฺฉูุชุฑู.
  * ูู **ููููโูุง (Latency)** ูููุน GC ุทููุงูโุชุฑ ูโุดู.

๐ Background Collection ููุท ุจุฑุง **Gen2** ุจูโฺฉุงุฑ ูโุฑูุ ฺูู Gen0 ู Gen1 ุฎู ุณุฑุน ูุณุชู.

> ุงู ูุณุฎู ุจูุจูุฏโุงูุชูโ **Concurrent Collection** ูุฏููุ ู ูุดฺฉู ูุฏู ูพุฑ ุดุฏู Gen0 ุญู ุงุฌุฑุง Gen2 ุฑู ุญู ฺฉุฑุฏู.

---

## ๐ GC Notifications

ููุช **Background Collection** ุบุฑูุนุงู ุจุงุดูุ ูโุชููุฏ ุงุฒ GC ุจุฎูุงุฏ **ูุจู ุงุฒ ฺฉ Full GC** ุจูุชูู ุงุทูุงุน ุจุฏู.

๐ ฺฉุงุฑุจุฑุฏ: ุฏุฑ **Server Farms** โ ูุจู ุงุฒ GC ุฏุฑุฎูุงุณุชโูุง ุฑู ุจู ุณุฑูุฑ ุฏฺฏู ุจูุฑุณุชุฏุ ุจุนุฏ GC ุฑู ุงูุฌุงู ุจุฏุฏุ ุณูพุณ ุฏุฑุฎูุงุณุชโูุง ุฑู ุจุฑฺฏุฑุฏููุฏ.

### ูุฑุงุญู

1. ุซุจุชโูุงู ุจุฑุง ุงุนูุงู:

   ```csharp
   GC.RegisterForFullGCNotification();
   ```

2. ุงุฌุฑุง ฺฉ Thread ฺฉู:

   * `GC.WaitForFullGCApproach` โ ููุช GC ูุฒุฏฺฉู.
   * ุฏุฑุฎูุงุณุชโูุง ุฑู ุจู ุณุฑูุฑูุง ุฏฺฏู ููุชูู ฺฉูุฏ.
   * ุฏุณุช `GC.Collect()` ุฑู ุตุฏุง ุจุฒูุฏ.
   * `GC.WaitForFullGCComplete` โ ููุช GC ุชููู ุดุฏุ ุฏูุจุงุฑู ุฏุฑุฎูุงุณุชโูุง ุฑู ุจฺฏุฑุฏ.

ู ุงู ฺุฑุฎู ุชฺฉุฑุงุฑ ูโุดู.

## ๐งน ูุงุฏุงุฑ ฺฉุฑุฏู Garbage Collection

ุดูุง ูโุชููุฏ ูุฑ ุฒูุงู ุจูโุตูุฑุช ุฏุณุช **GC.Collect** ุฑู ุตุฏุง ุจุฒูุฏ ุชุง ฺฉ Garbage Collection ุงูุฌุงู ุจุดู.

* ุจุฏูู ุขุฑฺฏููุงู: ฺฉ **Full Collection** ุงุฌุฑุง ูโุดู.
* ุจุง ุนุฏุฏ (ูุซู `GC.Collect(0)`): ููุท ุชุง ูููู ูุณู ุฌูุนโุขูุฑ ูโุดู โ ุงูุฌุง ููุท **Gen0** ุจูโุณุฑุนุช ูพุงฺฉโุณุงุฒ ูโุดู.

๐ ุชูุตู:
ูุนูููุงู ุจูุชุฑู ุจุฐุงุฑุฏ ุฎูุฏ **GC** ุฒูุงู ููุงุณุจ ุฌูุนโุขูุฑ ุฑู ุชุดุฎุต ุจุฏู. ฺูู:

* ููฺฉูู ุจุงุนุซ **ุงุฑุชูุงุก ุบุฑุถุฑูุฑ** ุงุดุงุก ุจุดู (Gen0 โ Gen1ุ ุง Gen1 โ Gen2).
* ูโุชููู ุชูุธูุงุช ุฎูุฏฺฉุงุฑ ู ููุดููุฏ GC ุฑู ุจูโูู ุจุฒูู.

### ุงุณุชุซูุงูุง

ฺฉ ุณูุงุฑู ุฑุงุฌ: ููุช ุจุฑูุงูู ุจุฑุง ูุฏุช **ุจู ุฎูุงุจ ูโุฑู**.
ูุซุงู: ฺฉ **Windows Service** ฺฉู ุฑูุฒ ฺฉโุจุงุฑ ุงุฌุฑุง ูโุดู. ุจุนุฏ ุงุฒ ุงุฌุฑุง ูุนุงูุช ุฑูุฒุงูู (ูุซูุงู ุจุฑุฑุณ ุขูพุฏุชโูุง)ุ ุจูโูุฏุช ฒด ุณุงุนุช ุฏฺฏู ูฺ ฺฉุงุฑ ุงูุฌุงู ููโุฏู. ฺูู ูฺ ุชุฎุตุต ุญุงูุธูโุง ุงุชูุงู ููโุงูุชูุ GC ูู ูุนุงู ููโุดู. ุฏุฑ ุงู ุญุงูุช ุญุงูุธูโุง ฺฉู ูุตุฑู ุดุฏู ุจุฑุง ฺฉู ฒด ุณุงุนุช ุขุฒุงุฏ ููโุดูโeven ุงฺฏุฑ ฺฏุฑุงู ุงุดุงุก ุฎุงู ุจุงุดู!

โ ุฑุงูโุญู:
ุจูุงูุงุตูู ุจุนุฏ ุงุฒ ุงูุฌุงู ูุนุงูุช ุฑูุฒุงููุ ุตุฏุง ุจุฒูุฏ:

```csharp
GC.Collect();
GC.WaitForPendingFinalizers();
GC.Collect();
```

ุงู ุชุถูู ูโฺฉูู ุญุช ุงุดุงุฆ ฺฉู Finalizer ุฏุงุฑู ูู ูพุงฺฉ ุจุดู. (ฺฏุงู ุฏุงุฎู ฺฉ ุญููู ุงุฌุฑุง ูโุดู ฺูู ุงุฌุฑุง Finalizerูุง ุฎูุฏุด ุจุงุนุซ ุขุฒุงุฏ ุดุฏู ุงุดุงุก ุจุดุชุฑ ูโุดู).

๐ ููุฑุฏ ุฏฺฏู: ููุช ุฏุงุฑุฏ ฺฉูุงุณ ุจุง **Finalizer** ุฑู ุชุณุช ูโฺฉูุฏ.

---

## โ๏ธ ุชูุธู Garbage Collection ุฏุฑ ุฒูุงู ุงุฌุฑุง

ุชูุธู ุจุง `GCSettings.LatencyMode`:

* **Interactive (ูพุดโูุฑุถ)** โ ุชุนุงุฏู ุจู ูพุงุณุฎโุฏู ู ฺฉุงุฑุง.
* **LowLatency** ุง **SustainedLowLatency** โ ุฌูุนโุขูุฑ ุณุฑุนโุชุฑ ูู ูฺฉุฑุฑุชุฑ โ ููุงุณุจ ุจุฑุง ุงูพูฺฉุดูโูุง Real-Time โก.
* **Batch** โ ุจุดุชุฑู Throughputุ ูู ูพุงุณุฎโุฏู ุถุนูโุชุฑ โ ููุงุณุจ ูพุฑุฏุงุฒุดโูุง Batch.

๐ ูฺฉุชู: ุงฺฏุฑ Background GC ุบุฑูุนุงู ุจุงุดูุ ุญุงูุช **SustainedLowLatency** ูพุดุชุจุงู ููโุดู.

ููฺูู ูโุชููุฏ:

* ูููุชุงู GC ุฑู ูุชููู ฺฉูุฏ: `GC.TryStartNoGCRegion()`
* ุฏูุจุงุฑู ูุนุงู ฺฉูุฏ: `GC.EndNoGCRegion()`

---

## ๐ Memory Pressure

ุฒูุงู ุงุฌุฑุง CLR ุชุตูู ูโฺฏุฑู ฺฉ GC ุงูุฌุงู ุจุฏูุ ุจุฑ ุงุณุงุณ ูุงฺฉุชูุฑูุง ูุซู **ุจุงุฑ ุญุงูุธูโ ฺฉู ุณุณุชู**.

ุงูุง ุงฺฏุฑ ุจุฑูุงููโุชูู **ุญุงูุธูโ Unmanaged** ุชุฎุตุต ุจุฏู (ูุซู P/Invoke ุง Native Code)ุ CLR ููุท ุงุฒ Managed Memory ุฎุจุฑ ุฏุงุฑู โ ุนู ูุฒุงู ูุตุฑู ูุงูุน ุญุงูุธู ฺฉูุชุฑ ุงุฒ ฺุฒ ฺฉู ูุณุช ูุดูู ุฏุงุฏู ูโุดู.

ุฑุงูโุญู:

* ุจู CLR ุงุนูุงู ฺฉูุฏ ฺฉู ุญุงูุธูโ Unmanaged ุชุฎุตุต ุฏุงุฏู ุดุฏู:

  ```csharp
  GC.AddMemoryPressure(size);
  ```

* ููุช ุขุฒุงุฏ ุดุฏ:

  ```csharp
  GC.RemoveMemoryPressure(size);
  ```

---

## ๐ Array Pooling

ุงฺฏุฑ ุฒุงุฏ ุขุฑุงู ูโุณุงุฒุฏุ ูโุชููุฏ ุจุง **Array Pooling** ุจุงุฑ GC ุฑู ฺฉู ฺฉูุฏ. ุงู ูุงุจูุช ุงุฒ .NET Core 3 ูุนุฑู ุดุฏ.

* ุงุฌุงุฑูโ ุขุฑุงู:

  ```csharp
  int[] pooledArray = ArrayPool<int>.Shared.Rent(100); // ุญุฏุงูู 100 ุจุงุช
  ```

  (ููฺฉูู ุขุฑุงูโุง ุจุฒุฑฺฏโุชุฑ ุจุฑฺฏุฑุฏูุ ูุนูููุงู ุฏุฑ ุชูุงูโูุง ฒ ุชุฎุตุต ุฏุงุฏู ูโุดู).

* ุจุฑฺฏุฑุฏุงูุฏู ุขุฑุงู:

  ```csharp
  ArrayPool<int>.Shared.Return(pooledArray);
  ```

  (ูโุชููุฏ ฺฉ `bool` ูู ุจุฏุฏ ฺฉู ูุจู ุงุฒ ุจุงุฒฺฏุดุชุ ุขุฑุงู ูพุงฺฉ ุจุดู).

๐ ูุญุฏูุฏุช:
ุงฺฏุฑ ุจุนุฏ ุงุฒ Return ููฺูุงู ุงุฒ ุขุฑุงู ุงุณุชูุงุฏู ฺฉูุฏ โ ุฎุทุง ุฌุฏ ุฑุฎ ูโุฏู โ. ฺูู ููฺฉูู ุชูุณุท APIูุง ุฏฺฏู ูุซู **ASP.NET Core** ุฏูุจุงุฑู ุงุณุชูุงุฏู ุจุดู.

---

## ๐๏ธ Pool ุงุฎุชุตุงุต

ุจูโุฌุง Pool ุงุดุชุฑุงฺฉ ูโุชููุฏ Pool ุดุฎุต ุจุณุงุฒุฏ:

```csharp
var myPool = ArrayPool<int>.Create();
int[] array = myPool.Rent(100);
...
```

ุงู ฺฉุงุฑ:

* โ ุฑุณฺฉ ุฎุฑุงุจ ฺฉุฑุฏู APIูุง ุฏฺฏู ุฑู ฺฉู ูโฺฉูู.
* โ ูู ูุตุฑู ุญุงูุธูโ ฺฉู ุฑู ุจุงูุง ูโุจุฑู (ฺูู ูุฑุตุชโูุง Reuse ฺฉูโุชุฑ ูโุดู).

๐พ **ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู (Managed Memory Leaks)**

ุฏุฑ ุฒุจุงูโูุง unmanaged ูุงููุฏ C++ุ ุดูุง ุจุงุฏ ุจูโุตูุฑุช ุฏุณุช ุญุงูุธู ุฑุง ุฒูุงู ฺฉู ฺฉ ุดุก ุฏฺฏุฑ ูุงุฒ ูุณุช ุขุฒุงุฏ ฺฉูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ูุดุช ุญุงูุธู ุฑุฎ ูโุฏูุฏ. ุฏุฑ ุฏูุง managedุ ุงู ููุน ุฎุทุง ุจูโุฏูู ุณุณุชู **garbage collection** ุฎูุฏฺฉุงุฑ **CLR** ุบุฑููฺฉู ุงุณุช.

ุจุง ุงู ุญุงูุ ุจุฑูุงููโูุง ุจุฒุฑฺฏ ู ูพฺุฏู .NET ูโุชูุงููุฏ ููุน ูุฑู ุฎูู ุงุฒ ููู ูุดฺฉู ุฑุง ูุดุงู ุฏููุฏ ฺฉู ูุชุฌู ุขู ูุดุงุจู ุงุณุช: ุจุฑูุงูู ุฏุฑ ุทูู ุนูุฑ ุฎูุฏ ุญุงูุธู ุจุดุชุฑ ูุตุฑู ูโฺฉูุฏ ุชุง ููุงุชุงู ูุงุฒ ุจู ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ูพุฏุง ฺฉูุฏ. ุฎุจุฑ ุฎูุจ ุงู ุงุณุช ฺฉู **ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู** ูุนูููุงู ุฑุงุญุชโุชุฑ ูุงุจู ุชุดุฎุต ู ูพุดฺฏุฑ ุงุณุช.

ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู ุฒูุงู ุฑุฎ ูโุฏูุฏ ฺฉู ุงุดุงุก ุงุณุชูุงุฏูโูุดุฏู ุจูโูุงุณุทู ูุฑุงุฌุน ูุฑุงููุดโุดุฏู ุง ุงุณุชูุงุฏูโูุดุฏู ูููุฒ ุฒูุฏู ุจูุงููุฏ. ฺฉ ููููู ุฑุงุฌ **event handlers** ูุณุชูุฏโุงูโูุง ฺฉ ูุฑุฌุน ุจู ุดุก ูุฏู ูฺฏู ูโุฏุงุฑูุฏ (ูฺฏุฑ ุงูฺฉู ูุฏู ฺฉ ูุชุฏ static ุจุงุดุฏ). ุจูโุนููุงู ูุซุงูุ ฺฉูุงุณโูุง ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

```csharp
class Host
{
 public event EventHandler Click;
}

class Client
{
 Host _host;
 public Client (Host host)
 {
   _host = host;
   _host.Click += HostClicked;
 }
 void HostClicked (object sender, EventArgs e) { ... }
}
```

ฺฉูุงุณ ุชุณุช ุฒุฑ ฺฉ ูุชุฏ ุฏุงุฑุฏ ฺฉู ฑฐฐฐ ุดุก Client ุงุฌุงุฏ ูโฺฉูุฏ:

```csharp
class Test
{
 static Host _host = new Host();
 public static void CreateClients()
 {
   Client[] clients = Enumerable.Range(0, 1000)
     .Select(i => new Client(_host))
     .ToArray();
   // ุงูุฌุงู ฺฉุงุฑ ุจุง clients ...
 }
}
```

ููฺฉู ุงุณุช ุงูุชุธุงุฑ ุฏุงุดุชู ุจุงุดุฏ ูพุณ ุงุฒ ุงุฌุฑุง **CreateClients**ุ ุงู ฑฐฐฐ ุดุก Client ูุงุฌุฏ ุดุฑุงุท ุฌูุนโุขูุฑ ุดููุฏ. ูุชุฃุณูุงููุ ูุฑ Client ฺฉ ูุฑุฌุน ุฏฺฏุฑ ูู ุฏุงุฑุฏ: ุดุก **\_host** ฺฉู event **Click** ูุฑ ููููู Client ุฑุง ูฺฏู ูโุฏุงุฑุฏ.

ุงู ูุดฺฉู ููฺฉู ุงุณุช ูุงุฏุฏู ฺฏุฑูุชู ุดูุฏ ุงฺฏุฑ event **Click** ุงุฌุฑุง ูุดูุฏ ุง ูุชุฏ **HostClicked** ฺฉุงุฑ ุงูุฌุงู ูุฏูุฏ ฺฉู ุชูุฌู ุฑุง ุฌูุจ ฺฉูุฏ.

ฺฉ ุงุฒ ุฑุงูโุญูโูุง ุงู ุงุณุช ฺฉู **Client** ุฑุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ ุชุง **IDisposable** ุจุงุดุฏ ู ุฏุฑ ูุชุฏ **Dispose**ุ **event handler** ุฑุง ูุบู ุงุดุชุฑุงฺฉ ฺฉูุฏ:

```csharp
public void Dispose() { _host.Click -= HostClicked; }
```

ุณูพุณ ูุตุฑูโฺฉููุฏฺฏุงู Client ูพุณ ุงุฒ ุงุชูุงู ุงุณุชูุงุฏู ุงุฒ ูููููโูุง ุขูโูุง ุฑุง Dispose ูโฺฉููุฏ:

```csharp
Array.ForEach(clients, c => c.Dispose());
```

---

โฑ **Timers**

ุฏุฑ ุจุฎุด ยซWeak Referencesยป ุฏุฑ ุตูุญู 603ุ ุฑุงูโุญู ุฏฺฏุฑ ุจุฑุง ุงู ูุดฺฉู ุงุฑุงุฆู ุดุฏู ุงุณุช ฺฉู ุฏุฑ ูุญุทโูุง ฺฉู ุชูุงู ุจู ุงุณุชูุงุฏู ุงุฒ ุงุดุงุก disposable ูุฏุงุฑูุฏ (ูุซูุงู **WPF**) ููุฏ ุงุณุช. ุฏุฑ ูุงูุนุ WPF ฺฉ ฺฉูุงุณ ุจู ูุงู **WeakEventManager** ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุงุฒ ุงูฺฏู weak references ุงุณุชูุงุฏู ูโฺฉูุฏ.

ุชุงูุฑูุง ูุฑุงููุดโุดุฏู ูุฒ ูโุชูุงููุฏ ุจุงุนุซ ูุดุช ุญุงูุธู ุดููุฏ (ุฏุฑ ูุตู 21 ุชุงูุฑูุง ุฑุง ุจุฑุฑุณ ฺฉุฑุฏูโุงู). ุฏู ุณูุงุฑู ูุชูุงูุช ูุฌูุฏ ุฏุงุฑุฏุ ุจุณุชู ุจู ููุน ุชุงูุฑ:

ุงุจุชุฏุง ุชุงูุฑ ุฏุฑ **System.Timers** ุฑุง ุจุฑุฑุณ ูโฺฉูู. ุฏุฑ ูุซุงู ุฒุฑุ ฺฉูุงุณ **Foo** (ููฺฏุงู ูููููโุณุงุฒ) ูุฑ ุซุงูู ูุชุฏ **tmr\_Elapsed** ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ:

```csharp
using System.Timers;
class Foo
{
 Timer _timer;
 Foo() 
 {
   _timer = new System.Timers.Timer { Interval = 1000 };
   _timer.Elapsed += tmr_Elapsed;
   _timer.Start();
 }
 void tmr_Elapsed(object sender, ElapsedEventArgs e) { ... }
}
```

ูุชุฃุณูุงููุ ูููููโูุง Foo ูุฑฺฏุฒ ุฌูุนโุขูุฑ ููโุดููุฏ! ูุดฺฉู ุงู ุงุณุช ฺฉู runtime ุฎูุฏุด ุจู ุชุงูุฑูุง ูุนุงู ูุฑุฌุน ุฏุงุฑุฏ ุชุง ุจุชูุงูุฏ event **Elapsed** ุขูโูุง ุฑุง ุงุฌุฑุง ฺฉูุฏุ ุจูุงุจุฑุงู:

* runtime ุดุก **\_timer** ุฑุง ุฒูุฏู ูฺฏู ูโุฏุงุฑุฏ.
* **\_timer** ุดุก Foo ุฑุง ุงุฒ ุทุฑู **tmr\_Elapsed** ุฒูุฏู ูฺฏู ูโุฏุงุฑุฏ.

ุฑุงู ุญู ูุงุถุญ ุงุณุช: ฺูู **Timer** ูพุงุฏูโุณุงุฒ **IDisposable** ุฏุงุฑุฏุ ุจุง Dispose ฺฉุฑุฏู ุชุงูุฑุ ุงุฌุฑุง ุขู ูุชููู ุดุฏู ู runtime ุฏฺฏุฑ ุจู ุดุก ูุฑุฌุน ูุฏุงุฑุฏ:

```csharp
class Foo : IDisposable
{
 ...
 public void Dispose() { _timer.Dispose(); }
}
```

ฺฉ ุฏุณุชูุฑุงูุนูู ุฎูุจ ุงู ุงุณุช ฺฉู ุงฺฏุฑ ูุฑ ููุฏ ุฏุฑ ฺฉูุงุณ ุดูุง ุจู ุดุฆ ุงุฎุชุตุงุต ุฏุงุฑุฏ ฺฉู **IDisposable** ุฑุง ูพุงุฏูโุณุงุฒ ฺฉุฑุฏูุ ุฎูุฏุชุงู IDisposable ุฑุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ.

ุชุงูุฑูุง **WPF** ู **Windows Forms** ูุฒ ุจู ููู ุดฺฉู ุฑูุชุงุฑ ูโฺฉููุฏ.

ุชุงูุฑ ุฏุฑ **System.Threading**ุ ุจุง ุงู ุญุงูุ ุฎุงุต ุงุณุช. .NET ุจู ุชุงูุฑูุง threading ูุนุงู ูุฑุฌุน ูุฏุงุฑุฏุ ุจูฺฉู ูุณุชููุงู delegateโูุง callback ุฑุง ูุฑุฌุน ูโฺฉูุฏ. ุงู ุจุฏุงู ูุนูุงุณุช ฺฉู ุงฺฏุฑ Dispose ฺฉุฑุฏู ุชุงูุฑ threading ูุฑุงููุด ุดูุฏุ ฺฉ finalizer ูโุชูุงูุฏ ุงุฌุฑุง ุดูุฏ ู ุชุงูุฑ ุฑุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ูุชููู ู Dispose ฺฉูุฏ:

```csharp
static void Main()
{
 var tmr = new System.Threading.Timer(TimerTick, null, 1000, 1000);
 GC.Collect();
 System.Threading.Thread.Sleep(10000); // ุตุจุฑ 10 ุซุงูู
}

static void TimerTick(object notUsed) { Console.WriteLine("tick"); }
```

ุงฺฏุฑ ุงู ูุซุงู ุฏุฑ ุญุงูุช release (debug ุบุฑูุนุงู ู ุจูููโุณุงุฒ ูุนุงู) ฺฉุงููพุงู ุดูุฏุ ุชุงูุฑ ูุจู ุงุฒ ุงูฺฉู ฺฉ ุจุงุฑ ูู ุงุฌุฑุง ุดูุฏุ ุฌูุนโุขูุฑ ู ููุง ุฎูุงูุฏ ุดุฏ!

ุฏูุจุงุฑูุ ุงู ูุดฺฉู ุจุง Dispose ฺฉุฑุฏู ุชุงูุฑ ููฺฏุงู ุงุชูุงู ุงุณุชูุงุฏู ุจุฑุทุฑู ูโุดูุฏ:

```csharp
using (var tmr = new System.Threading.Timer(TimerTick, null, 1000, 1000))
{
 GC.Collect();
 System.Threading.Thread.Sleep(10000); // ุตุจุฑ 10 ุซุงูู
}
```

ูุฑุงุฎูุงู ุถูู **tmr.Dispose** ุฏุฑ ูพุงุงู **using** ุจุงุนุซ ูโุดูุฏ ฺฉู ูุชุบุฑ **tmr** โุงุณุชูุงุฏูโุดุฏูโ ุฏุฑ ูุธุฑ ฺฏุฑูุชู ุดูุฏ ู ุชุง ูพุงุงู ุจููฺฉ ุชูุณุท GC ูุฑุฏู ูุญุณูุจ ูุดูุฏ.

ุทูุฒ ุงู ุงุณุช ฺฉู ุงู ูุฑุงุฎูุงู Dispose ุฏุฑ ูุงูุน ุนูุฑ ุดุก ุฑุง ุทููุงูโุชุฑ ูโฺฉูุฏ! ๐ฏ

๐ต๏ธโโ๏ธ **ุชุดุฎุต ูุดุช ุญุงูุธู (Diagnosing Memory Leaks)**

ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ **ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู** ุงู ุงุณุช ฺฉู ุงุฒ ููุงู ุงุจุชุฏุง ูุตุฑู ุญุงูุธู ุฑุง ุฏุฑ ุญู ููุดุชู ุจุฑูุงูู ุชุญุช ูุธุฑ ุฏุงุดุชู ุจุงุดุฏ. ูโุชูุงูุฏ ูุตุฑู ูุนู ุญุงูุธู ุงุดุงุก ุจุฑูุงูู ุฑุง ุจู ุงู ุตูุฑุช ุจูโุฏุณุช ุขูุฑุฏ (ุขุฑฺฏููุงู **true** ุจู GC ูโฺฏูุฏ ุงุจุชุฏุง ฺฉ ุฌูุนโุขูุฑ ุงูุฌุงู ุฏูุฏ):

```csharp
long memoryUsed = GC.GetTotalMemory(true);
```

ุงฺฏุฑ ุงุฒ ุชูุณุนู ูุจุชู ุจุฑ ุชุณุช (**test-driven development**) ุงุณุชูุงุฏู ูโฺฉูุฏุ ูโุชูุงูุฏ ุงุฒ **unit test**ูุง ุจุฑุง ุงุทููุงู ุงุฒ ุขุฒุงุฏ ุดุฏู ุญุงูุธู ุงุณุชูุงุฏู ฺฉูุฏ. ุงฺฏุฑ ุงู ุจุฑุฑุณ ุดฺฉุณุช ุฎูุฑุฏุ ููุท ฺฉุงู ุงุณุช ุชุบุฑุงุช ุงุฎุฑ ุฎูุฏ ุฑุง ุจุฑุฑุณ ฺฉูุฏ.

ุงฺฏุฑ ูุจูุงู ฺฉ ุจุฑูุงูู ุจุฒุฑฺฏ ุจุง **ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู** ุฏุงุฑุฏุ ุงุจุฒุงุฑ **windbg.exe** ูโุชูุงูุฏ ฺฉูฺฉโฺฉููุฏู ุจุงุดุฏ. ููฺูู ุงุจุฒุงุฑูุง ฺฏุฑุงูฺฉ ุฏูุณุชุงููโุชุฑ ูุงููุฏ **CLR Profiler** ูุงฺฉุฑูุณุงูุชุ **Memory Profiler** ุดุฑฺฉุช SciTech ู **ANTS Memory Profiler** ุดุฑฺฉุช Red Gate ูุฒ ููุฌูุฏ ูุณุชูุฏ.

**CLR** ููฺูู ุดูุงุฑูุฏูโูุง ุฑูุฏุงุฏ ูุฎุชูู ุงุฑุงุฆู ูโุฏูุฏ ุชุง ุฏุฑ ูุธุงุฑุช ุจุฑ ููุงุจุน ฺฉูฺฉ ฺฉูุฏ.

---

๐ **Weak References**

ฺฏุงู ุงููุงุช ููุฏ ุงุณุช ฺฉู ฺฉ ูุฑุฌุน ุจู ุดุฆ ุฏุงุดุชู ุจุงุดู ฺฉู ุจุฑุง **GC** ยซูุงูุฑุฆยป ุจุงุดุฏ ู ูุงูุน ุฌูุนโุขูุฑ ุขู ูุดูุฏ. ุงู ููุน ูุฑุฌุน ุฑุง **weak reference** ูโูุงููุฏ ู ุจุง ฺฉูุงุณ **System.WeakReference** ูพุงุฏูโุณุงุฒ ูโุดูุฏ.

ุจุฑุง ุงุณุชูุงุฏู ุงุฒ **WeakReference**ุ ุขู ุฑุง ุจุง ุดุก ูุฏู ุงุฌุงุฏ ฺฉูุฏ:

```csharp
var sb = new StringBuilder("this is a test");
var weak = new WeakReference(sb);
Console.WriteLine(weak.Target); // This is a test
```

ุงฺฏุฑ ุดุก ูุฏู ุชููุง ุชูุณุท ฺฉ ุง ฺูุฏ **weak reference** ูุฑุฌุน ุดูุฏุ GC ุขู ุฑุง ูุงุฌุฏ ุดุฑุงุท ุฌูุนโุขูุฑ ูโุฏุงูุฏ. ูพุณ ุงุฒ ุฌูุนโุขูุฑุ ูฺฺฏ **Target** ุจุฑุงุจุฑ **null** ุฎูุงูุฏ ุจูุฏ:

```csharp
var weak = GetWeakRef();
GC.Collect();
Console.WriteLine(weak.Target); // (nothing)

WeakReference GetWeakRef() => new WeakReference(new StringBuilder("weak"));
```

ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฌูุนโุขูุฑ ูุฏู ุจู ุจุฑุฑุณ null ู ุงุณุชูุงุฏู ุงุฒ ุขูุ ุขู ุฑุง ุจู ฺฉ ูุชุบุฑ ูุญู ุงุฎุชุตุงุต ุฏูุฏ:

```csharp
var sb = (StringBuilder)weak.Target;
if (sb != null) { /* ุงุณุชูุงุฏู ุงุฒ sb */ }
```

ูพุณ ุงุฒ ุงุฎุชุตุงุต ูุฏู ุจู ฺฉ ูุชุบุฑ ูุญูุ ุขู ฺฉ **strong root** ูพุฏุง ูโฺฉูุฏ ู ุชุง ุฒูุงู ฺฉู ูุชุบุฑ ุฏุฑ ุงุณุชูุงุฏู ุจุงุดุฏุ ุฌูุนโุขูุฑ ููโุดูุฏ.

ฺฉูุงุณ ุฒุฑ ุงุฒ **weak references** ุจุฑุง ูพฺฏุฑ ููู ุงุดุงุก **Widget** ฺฉู ุงุฌุงุฏ ุดุฏูโุงูุฏ ุงุณุชูุงุฏู ูโฺฉูุฏุ ุจุฏูู ุงูฺฉู ูุงูุน ุฌูุนโุขูุฑ ุขูโูุง ุดูุฏ:

```csharp
class Widget
{
 static List<WeakReference> _allWidgets = new List<WeakReference>();
 public readonly string Name;
 public Widget(string name)
 {
   Name = name;
   _allWidgets.Add(new WeakReference(this));
 }
 public static void ListAllWidgets()
 {
   foreach (WeakReference weak in _allWidgets)
   {
     Widget w = (Widget)weak.Target;
     if (w != null) Console.WriteLine(w.Name);
   }
 }
}
```

ุชููุง ูฺฉุชู ุงู ุงุณุช ฺฉู ุงู **static list** ุจุง ฺฏุฐุดุช ุฒูุงู ุฑุดุฏ ูโฺฉูุฏ ู **weak references** ุจุง **target null** ุฌูุน ูโุดููุฏ. ุจูุงุจุฑุงูุ ุจุงุฏ ฺฉ **ุงุณุชุฑุงุชฺ ูพุงฺฉุณุงุฒ** ูพุงุฏูโุณุงุฒ ฺฉูุฏ.

---

๐พ **Weak References ู Caching**

ฺฉ ุงุฒ ฺฉุงุฑุจุฑุฏูุง **WeakReference**ุ **cache ฺฉุฑุฏู ุงุดุงุก ุจุฒุฑฺฏ** ุงุณุช. ุงู ุฑูุด ุงุฌุงุฒู ูโุฏูุฏ ุฏุงุฏูโูุง ูพุฑุญุฌู ุจู ุทูุฑ ูููุช ุฐุฎุฑู ุดููุฏ ุจุฏูู ุงูฺฉู ูุตุฑู ุญุงูุธู ุจุด ุงุฒ ุญุฏ ุดูุฏ:

```csharp
_weakCache = new WeakReference(...); // _weakCache ฺฉ ููุฏ ุงุณุช
...
var cache = _weakCache.Target;
if (cache == null) { /* cache ุฑุง ุฏูุจุงุฑู ุงุฌุงุฏ ู ุจู _weakCache ุงุฎุชุตุงุต ุฏูุฏ */ }
```

ุงู ุงุณุชุฑุงุชฺ ุฏุฑ ุนูู ููุท ุชุง ุญุฏ ูุคุซุฑ ุงุณุชุ ุฒุฑุง ุดูุง ฺฉูุชุฑู ุจุฑ ุฒูุงู ุงุฌุฑุง GC ู ูุณู ุฌูุนโุขูุฑ ุดุฏู ูุฏุงุฑุฏ. ุจูโูฺู ุงฺฏุฑ cache ุดูุง ุฏุฑ **Gen0** ุจุงุดุฏุ ููฺฉู ุงุณุช ุธุฑู ูฺฉุฑูุซุงูู ุฌูุนโุขูุฑ ุดูุฏ. ุจูุงุจุฑุงูุ ุจูุชุฑ ุงุณุช ุงุฒ **cache ุฏู ุณุทุญ** ุงุณุชูุงุฏู ฺฉูุฏ: ุงุจุชุฏุง ุจุง **strong references** ุดุฑูุน ฺฉูุฏ ู ุณูพุณ ุจู **weak references** ุชุจุฏู ฺฉูุฏ.

---

๐ **Weak References ู Events**

ูุจูุงู ุฏุฏู ฺฉู **events** ูโุชูุงููุฏ ุจุงุนุซ ูุดุช ุญุงูุธู ุดููุฏ. ุณุงุฏูโุชุฑู ุฑุงู ุญู ุงู ุงุณุช ฺฉู ุงุฒ subscribe ุฏุฑ ฺูู ุดุฑุงุท ุงุฌุชูุงุจ ฺฉูุฏ ุง ฺฉ ูุชุฏ **Dispose** ุจุฑุง unsubscribe ูพุงุฏูโุณุงุฒ ฺฉูุฏ. **Weak references** ุฑุงู ุญู ุฏฺฏุฑ ุงุฑุงุฆู ูโุฏููุฏ.

ุชุตูุฑ ฺฉูุฏ ฺฉ **delegate** ฺฉู ููุท **weak references** ุจู ุงูุฏุงู ุฎูุฏ ูฺฏู ูโุฏุงุฑุฏ. ฺูู delegateโุง ุงูุฏุงู ุฑุง ุฒูุฏู ูฺฏู ููโุฏุงุฑุฏโูฺฏุฑ ุงูฺฉู ุขู ุงูุฏุงู ูุฑุฌุน ูุณุชูู ุฏุงุดุชู ุจุงุดูุฏ. ุงูุจุชู ุงู ูุงูุน ุงุฌุฑุง delegate ููโุดูุฏ ฺฉู ููฺฉู ุงุณุช ุจู ูุฏู ุจุฏูู ูุฑุฌุน ุจุฑุณุฏุ ุจู ุฒูุงู ฺฉู ูุฏู ูุงุฌุฏ ุดุฑุงุท ุฌูุนโุขูุฑ ุดุฏู ู GC ูููุฒ ุขู ุฑุง ุฌูุนโุขูุฑ ูฺฉุฑุฏู ุงุณุช.

ุจุฑุง ุงูฺฉู ฺูู ุฑุงูโุญู ูุคุซุฑ ุจุงุดุฏุ ฺฉุฏ ุดูุง ุจุงุฏ ุฏุฑ ุงู ุณูุงุฑู ููุงูู ุจุงุดุฏ. ุฏุฑ ุงู ุตูุฑุช ูโุชูุงูุฏ ฺฉูุงุณ **weak delegate** ุฑุง ุจู ุงู ุดฺฉู ูพุงุฏูโุณุงุฒ ฺฉูุฏ:

```csharp
public class WeakDelegate<TDelegate> where TDelegate : Delegate
{
 class MethodTarget
 {
   public readonly WeakReference Reference;
   public readonly MethodInfo Method;
   public MethodTarget(Delegate d)
   {
     if (d.Target != null) Reference = new WeakReference(d.Target);
     Method = d.Method;
   }
 }
 List<MethodTarget> _targets = new List<MethodTarget>();

 public void Combine(TDelegate target)
 {
   if (target == null) return;
   foreach (Delegate d in (target as Delegate).GetInvocationList())
     _targets.Add(new MethodTarget(d));
 }

 public void Remove(TDelegate target)
 {
   if (target == null) return;
   foreach (Delegate d in (target as Delegate).GetInvocationList())
   {
     MethodTarget mt = _targets.Find(w =>
       Equals(d.Target, w.Reference?.Target) &&
       Equals(d.Method.MethodHandle, w.Method.MethodHandle));
     if (mt != null) _targets.Remove(mt);
   }
 }

 public TDelegate Target
 {
   get
   {
     Delegate combinedTarget = null;
     foreach (MethodTarget mt in _targets.ToArray())
     {
       WeakReference wr = mt.Reference;
       if (wr == null || wr.Target != null)
       {
         var newDelegate = Delegate.CreateDelegate(typeof(TDelegate), wr?.Target, mt.Method);
         combinedTarget = Delegate.Combine(combinedTarget, newDelegate);
       }
       else
         _targets.Remove(mt);
     }
     return combinedTarget as TDelegate;
   }
   set
   {
     _targets.Clear();
     Combine(value);
   }
 }
}
```

ุฏุฑ ูุชุฏูุง **Combine** ู **Remove**ุ ุชุจุฏู ูุฑุฌุน ุงุฒ target ุจู **Delegate** ุจุง **as operator** ุงูุฌุงู ูโุดูุฏ ุชุง ุงุฒ ุงุจูุงู ุจุงูููู ุจู **custom conversion** ู **reference conversion** ุฌููฺฏุฑ ุดูุฏ.

ุฏุฑ ูฺฺฏ **Target**ุ ฺฉ **multicast delegate** ุงุฌุงุฏ ูโฺฉูู ฺฉู ููู delegateูุง ุฒูุฏูโุง ฺฉู ุชูุณุท **weak references** ูฺฏู ุฏุงุดุชู ุดุฏูโุงูุฏ ุฑุง ุชุฑฺฉุจ ูโฺฉูุฏ ู ูุงุจู (dead) ุฑุง ุงุฒ ูุณุช ุญุฐู ูโฺฉูุฏ ุชุง ูุณุช \_targets ุจโูพุงุงู ุฑุดุฏ ูฺฉูุฏ.

---

๐ ูุซุงู ุงุณุชูุงุฏู ุงุฒ ุงู delegate ุฏุฑ ูพุงุฏูโุณุงุฒ event:

```csharp
public class Foo
{
 WeakDelegate<EventHandler> _click = new WeakDelegate<EventHandler>();
 public event EventHandler Click
 {
   add { _click.Combine(value); }
   remove { _click.Remove(value); }
 }
 protected virtual void OnClick(EventArgs e)
   => _click.Target?.Invoke(this, e);
}
```
