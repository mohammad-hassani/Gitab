---
layout: layout.njk
title: Threading ูพุดุฑูุชู
---
# ูุตู ุจุณุช ู ฺฉู:  Threading ูพุดุฑูุชู

ูุง ุฏุฑ **ูุตู ฑด** ุจุง ูุจุงู ุงูููโ **Threading** ุดุฑูุน ฺฉุฑุฏู ุชุง ููุฏููโุง ุจุฑุง **Tasks** ู **Asynchrony** ุจุงุดุฏ. ุจู ุทูุฑ ูุดุฎุตุ ูุดุงู ุฏุงุฏู ฺุทูุฑ ูโุชูุงู ฺฉ **Thread** ุฑุง ุดุฑูุน ู ูพฺฉุฑุจูุฏ ฺฉุฑุฏ ู ููุงูู ุงุณุงุณ ูุซู **Thread Pooling**ุ **Blocking**ุ **Spinning** ู **Synchronization Contexts** ุฑุง ูพูุดุด ุฏุงุฏู. ููฺูู ุจู **Locking** ู **Thread Safety** ูพุฑุฏุงุฎุชู ู ุณุงุฏูโุชุฑู ุณุงุฒูโ ุณฺฏูุงูโุฏูุ ุนู **ManualResetEvent** ุฑุง ูุนุฑู ฺฉุฑุฏู.

ุงู ูุตู ุฏููุงู ุงุฒ ููุงูโุฌุง ุงุฏุงูู ูพุฏุง ูโฺฉูุฏ ฺฉู ูุตู ฑด ุฏุฑ ููุถูุน **Threading** ูุชููู ุดุฏ. ุฏุฑ ุณู ุจุฎุด ุงููุ ุจูโุทูุฑ ุนููโุชุฑ ุจู **Synchronization**ุ **Locking** ู **Thread Safety** ูโูพุฑุฏุงุฒู. ุณูพุณ ููุงุฑุฏ ุฒุฑ ุฑุง ูพูุดุด ูโุฏูู:

* ๐ **Nonexclusive locking** (ูุงููุฏ **Semaphore** ู **Reader/Writer Locks**)
* ๐ ูููโ ุณุงุฒูโูุง ุณฺฏูุงูโุฏู (**AutoResetEvent**ุ **ManualResetEvent**ุ **CountdownEvent** ู **Barrier**)
* ๐ข **Lazy Initialization** (ุจุง ุงุณุชูุงุฏู ุงุฒ **Lazy<T>** ู **LazyInitializer**)
* ๐งฉ **Thread-local storage** (ูุงููุฏ **ThreadStaticAttribute**ุ **ThreadLocal<T>** ู **GetData/SetData**)
* โฑ **Timers**

ููุถูุน **Threading** ุขูโูุฏุฑ ูุณุน ุงุณุช ฺฉู ูุง ุจุฎุดโูุง ุชฺฉูู ุฑุง ุจูโุตูุฑุช ุขููุงู ูุฑุงุฑ ุฏุงุฏูโุงู ุชุง ุชุตูุฑ ฺฉุงููโุชุฑ ุงุฑุงุฆู ุดูุฏ. ุจุฑุง ูุทุงูุนูโ ููุถูุนุงุช ูพุดุฑูุชูโุชุฑุ ุจู ูุจโุณุงุช ุฒุฑ ูุฑุงุฌุนู ฺฉูุฏ:

๐ [http://albahari.com/threading](http://albahari.com/threading)

ุฏุฑ ุขูโุฌุง ูุจุงุญุซ ุฒุฑ ุฑุง ุฎูุงูุฏ ุงูุช:

* โ๏ธ **Monitor.Wait** ู **Monitor.Pulse** ุจุฑุง ุณูุงุฑููุง ุฎุงุต ุณฺฏูุงูโุฏู
* ๐ ุชฺฉูฺฉโูุง **Nonblocking Synchronization** ุจุฑุง **Micro-Optimization** (ูุงููุฏ **Interlocked**ุ **Memory Barriers**ุ **volatile**)
* ๐ **SpinLock** ู **SpinWait** ุจุฑุง ุณูุงุฑููุง ุจุง **Concurrency** ุจุงูุง

---

## ๐ Synchronization Overview (ูุฑูุฑ Synchronization)

**Synchronization** ุนู ููุงููฺฏโุณุงุฒ ุนููุงุช ููุฒูุงู ุจุฑุง ุฏุณุชุงุจ ุจู ฺฉ ูุชุฌูโ ูุงุจู ูพุดโุจู. ุงู ููุถูุน ุจูโูฺู ููุช ุงููุช ูพุฏุง ูโฺฉูุฏ ฺฉู ฺูุฏู **Thread** ุจู ุฏุงุฏูโ ูุดุชุฑฺฉ ุฏุณุชุฑุณ ุฏุงุฑูุฏุ ุฏุฑ ุงู ุดุฑุงุทุ ุฎู ุฑุงุญุช ูโุชูุงู ุฏฺุงุฑ ูุดฺฉู ุดุฏ.

ุณุงุฏูโุชุฑู ู ฺฉุงุฑุจุฑุฏโุชุฑู ุงุจุฒุงุฑูุง **Synchronization** ุงุญุชูุงูุงู ููุงู **Continuations** ู **Task Combinators** ูุณุชูุฏ ฺฉู ุฏุฑ ูุตู ฑด ุชูุถุญ ุฏุงุฏู. ุจุง ูุฑูููู ฺฉุฑุฏู ุจุฑูุงููโูุง ููุฒูุงู ุฏุฑ ูุงูุจ ุนููุงุช **Asynchronous** ฺฉู ุจุง **Continuations** ู **Combinators** ุจู ูู ูุชุตู ูโุดููุฏุ ูุงุฒ ุจู **Locking** ู **Signaling** ฺฉูุชุฑ ูโุดูุฏ. ุจุง ุงู ุญุงูุ ูููุฒ ููุงูุน ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุณุงุฒูโูุง ุณุทุญ ูพุงูโุชุฑ ูุงุฑุฏ ุนูู ูโุดููุฏ.

ุณุงุฒูโูุง **Synchronization** ุฑุง ูโุชูุงู ุจู ุณู ุฏุณุชู ุชูุณู ฺฉุฑุฏ:

1. ๐ **Exclusive Locking**
   ุงู ุณุงุฒูโูุง ุงุฌุงุฒู ูโุฏููุฏ ููุท ฺฉ **Thread** ุฏุฑ ูุฑ ูุญุธู ูุนุงูุช ุฎุงุต ุงูุฌุงู ุฏูุฏ ุง ุจุฎุด ุงุฒ ฺฉุฏ ุฑุง ุงุฌุฑุง ฺฉูุฏ. ูุฏู ุงุตู ุขูโูุง ุงู ุงุณุช ฺฉู **Threads** ุจุชูุงููุฏ ุจู ูุถุนุช ูุดุชุฑฺฉ ุฏุฑ ุญุงู ููุดุชู ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดูุฏ ุจุฏูู ุงูโฺฉู ูุฒุงุญู ูู ุดููุฏ. ุณุงุฒูโูุง **Exclusive Locking** ุนุจุงุฑุชโุงูุฏ ุงุฒ:
   **lock**ุ **Mutex** ู **SpinLock**.

2. ๐ **Nonexclusive Locking**
   ุงู ููุน **Locking** ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ูุฒุงู **Concurrency** ุฑุง ูุญุฏูุฏ ฺฉูุฏ. ุณุงุฒูโูุง ุขู ุนุจุงุฑุชโุงูุฏ ุงุฒ:
   **Semaphore(Slim)** ู **ReaderWriterLock(Slim)**.

3. ๐ข **Signaling**
   ุงู ุณุงุฒูโูุง ุจู ฺฉ **Thread** ุงุฌุงุฒู ูโุฏููุฏ ุชุง ุฒูุงู ฺฉู ุงุฒ ฺฉ ุง ฺูุฏ **Thread** ุฏฺฏุฑ ุงุทูุงุน (Notification) ุฏุฑุงูุช ูฺฉุฑุฏูุ ุฏุฑ ุญุงูุช **Block** ุจุงู ุจูุงูุฏ. ุณุงุฒูโูุง **Signaling** ุดุงูู **ManualResetEvent(Slim)**ุ **AutoResetEvent**ุ **CountdownEvent** ู **Barrier** ูุณุชูุฏ. ุณู ููุฑุฏ ุงูู ูุนูููุงู ุจุง ุนููุงู **Event Wait Handles** ุดูุงุฎุชู ูโุดููุฏ.

ููฺูู ุงูฺฉุงู (ู ุงูุจุชู ุฏุดูุงุฑ) ุงูุฌุงู ุจุฑุฎ ุนููุงุช ููุฒูุงู ุฑู ุฏุงุฏูโ ูุดุชุฑฺฉ ุจุฏูู ุงุณุชูุงุฏู ุงุฒ **Locking** ูุฌูุฏ ุฏุงุฑุฏุ ุจุง ฺฉูฺฉ ุณุงุฒูโูุง **Nonblocking Synchronization**. ุงู ุณุงุฒูโูุง ุนุจุงุฑุชโุงูุฏ ุงุฒ:
**Thread.MemoryBarrier**ุ **Thread.VolatileRead**ุ **Thread.VolatileWrite**ุ ฺฉูุฏูุงฺูโ **volatile** ู ฺฉูุงุณ **Interlocked**.

ูุง ุงู ููุถูุน ุฑุง ุจู ููุฑุงู ูุชุฏูุง **Monitor.Wait/Pulse** ฺฉู ุจุฑุง ููุดุชู ููุทู ุณูุงุฑุด ุณฺฏูุงูโุฏู ฺฉุงุฑุจุฑุฏ ุฏุงุฑูุฏุ ุจูโุตูุฑุช ุขููุงู ูพูุดุด ุฏุงุฏูโุงู.

---

## ๐ Exclusive Locking (ูููโฺฏุฐุงุฑ ุงูุญุตุงุฑ)

ุณู ุณุงุฒูโ ุงุตู ุจุฑุง **Exclusive Locking** ูุฌูุฏ ุฏุงุฑุฏ: ุฏุณุชูุฑ **lock**ุ **Mutex** ู **SpinLock**.

* ุฏุณุชูุฑ **lock** ุฑุงุญุชโุชุฑู ู ูพุฑฺฉุงุฑุจุฑุฏุชุฑู ฺฏุฒูู ุงุณุช.
* **Mutex** ุฒูุงู ุงุณุชูุงุฏู ูโุดูุฏ ฺฉู ุจุฎูุงูุฏ ููู ุฑุง ุจู ฺูุฏู **Process** ฺฏุณุชุฑุด ุฏูุฏ (ูููโูุง ุณุทุญ ฺฉุงููพูุชุฑ).
* **SpinLock** ฺฉ **Micro-Optimization** ุงุณุช ฺฉู ูโุชูุงูุฏ ุฏุฑ ุณูุงุฑููุง ุจุง **Concurrency** ุจุงูุง ุจุงุนุซ ฺฉุงูุด **Context Switches** ุดูุฏ. ๐

### ๐ The `lock` Statement (ุฏุณุชูุฑ lock)

ุจุฑุง ูุดุงู ุฏุงุฏู ูุงุฒ ุจู **Locking**ุ ฺฉูุงุณ ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

```csharp
class ThreadUnsafe
{
  static int _val1 = 1, _val2 = 1;
  static void Go()
  {
    if (_val2 != 0) Console.WriteLine (_val1 / _val2);
    _val2 = 0;
  }
}
```

ุงู ฺฉูุงุณ **Thread-Safe** ูุณุช: ุงฺฏุฑ ูุชุฏ `Go` ุจูโุทูุฑ ููุฒูุงู ุชูุณุท ุฏู **Thread** ูุฑุงุฎูุงู ุดูุฏุ ุงูฺฉุงู ุฑุฎ ุฏุงุฏู ุฎุทุง **Division by Zero** ูุฌูุฏ ุฏุงุฑุฏ. ฺุฑุงุ ฺูู ููฺฉู ุงุณุช ุฏุฑ ููุงู ูุญุธูโุง ฺฉู ฺฉ **Thread** ุจู ุงุฌุฑุง ุฏุณุชูุฑ `if` ู `Console.WriteLine` ุงุณุชุ **Thread** ุฏฺฏุฑ ููุฏุงุฑ `_val2` ุฑุง ุจุฑุงุจุฑ ุตูุฑ ูุฑุงุฑ ุฏูุฏ.

ุงูุฌุงุณุช ฺฉู ุฏุณุชูุฑ **lock** ูุดฺฉู ุฑุง ุญู ูโฺฉูุฏ:

```csharp
class ThreadSafe
{
  static readonly object _locker = new object();
  static int _val1 = 1, _val2 = 1;
  static void Go()
  {
    lock (_locker)
    {
      if (_val2 != 0) Console.WriteLine (_val1 / _val2);
      _val2 = 0;
    }
  }
}
```

ููุท ฺฉ **Thread** ุฏุฑ ูุฑ ูุญุธู ูโุชูุงูุฏ ุดุก ููฺฏุงูโุณุงุฒ (ุฏุฑ ุงูุฌุง `_locker`) ุฑุง ููู ฺฉูุฏ. ูุฑ **Thread** ุฏฺฏุฑ ฺฉู ุจุฑุง ููู ุฑูุงุจุช ฺฉูุฏุ **Blocked** ูโุดูุฏ ุชุง ุฒูุงู ฺฉู ููู ุขุฒุงุฏ ุดูุฏ.

ุงฺฏุฑ ุจุด ุงุฒ ฺฉ **Thread** ุจุฑุง ููู ุฑูุงุจุช ฺฉูุฏุ ุขูโูุง ุฏุฑ ฺฉ **Ready Queue** ูุฑุงุฑ ูโฺฏุฑูุฏ ู ุจู ุชุฑุชุจ ูุฑูุฏุ ููู ุจู ุขูโูุง ุฏุงุฏู ูโุดูุฏ (ุงูุจุชู โ๏ธ ุฏุฑ ุจุนุถ ุดุฑุงุท ุณุณุชูโุนุงูู **Windows** ู **CLR** ููฺฉู ุงุณุช ุงู ุนุฏุงูุช ููุถ ุดูุฏ).

ุจู ููู ุฏููุ ูููโูุง ุงูุญุตุงุฑ ุฑุง ฺฏุงู ุงููุงุช ุทูุฑ ุชูุตู ูโฺฉููุฏ ฺฉู **ุฏุณุชุฑุณ ุณุฑุงู** ุฑุง ุจู ฺุฒ ฺฉู ุชูุณุท ููู ูุญุงูุธุช ูโุดูุฏุ ุงุนูุงู ูโฺฉููุฏุ ุฒุฑุง ุฏุณุชุฑุณ ฺฉ **Thread** ููโุชูุงูุฏ ุจุง ุฏฺฏุฑ ูููพูุดุงู ุฏุงุดุชู ุจุงุดุฏ. ุฏุฑ ุงู ูุซุงูุ ูุง ูู ููุทู ุฏุงุฎู ูุชุฏ `Go` ู ูู ููุฏูุง `_val1` ู `_val2` ุฑุง ูุญุงูุธุช ฺฉุฑุฏูโุงู.

---

### โ๏ธ Monitor.Enter ู Monitor.Exit

ุฏุณุชูุฑ `lock` ุฏุฑ C# ุฏุฑ ุญููุช ฺฉ **ูุงูโุจุฑ ูุญู (Syntactic Shortcut)** ุจุฑุง ูุฑุงุฎูุงู ูุชุฏูุง `Monitor.Enter` ู `Monitor.Exit` ุจู ููุฑุงู ฺฉ ุจููฺฉ `try/finally` ุงุณุช.

ุจูโุทูุฑ ุณุงุฏูุ ฺฉุฏ ฺฉู ุฏุฑ ูุชุฏ `Go` ุงุชูุงู ูโุงูุชุฏุ ูุนุงุฏู ุฒุฑ ุงุณุช:

```csharp
Monitor.Enter (_locker);
try
{
  if (_val2 != 0) Console.WriteLine (_val1 / _val2);
  _val2 = 0;
}
finally { Monitor.Exit (_locker); }
```

โ๏ธ ุงฺฏุฑ ูุชุฏ `Monitor.Exit` ุจุฏูู ุงูโฺฉู ูุจูุงู `Monitor.Enter` ุฑู ููุงู ุดุก ุตุฏุง ุฒุฏู ุดุฏู ุจุงุดุฏุ ูุฑุงุฎูุงู ุดูุฏุ ฺฉ **Exception** ูพุฑุชุงุจ ูโุดูุฏ.

---

### ๐ก overloadูุง lockTaken

ฺฉุฏ ฺฉู ุฏุฑ ุจุงูุง ุฏุฏู ฺฉ ุขุณุจโูพุฐุฑ ุธุฑู ุฏุงุฑุฏ. ูุฑุถ ฺฉูุฏ (ูุฑฺูุฏ ุจุนุฏ) ฺฉ **Exception** ุจู ูุฑุงุฎูุงู `Monitor.Enter` ู ุดุฑูุน ุจููฺฉ `try` ุฑุฎ ุฏูุฏ (ูุซูุงู ฺฉ **OutOfMemoryException** ุง ุฏุฑ **.NET Framework** ุงฺฏุฑ **Thread** ูุชููู ุดูุฏ).

ุฏุฑ ุงู ุดุฑุงุท:

* ุงฺฏุฑ ููู ฺฏุฑูุชู ูุดุฏู ุจุงุดุฏุ ุฎุทุฑ ูุฌูุฏ ูุฏุงุฑุฏ.
* ุงูุง ุงฺฏุฑ ููู ฺฏุฑูุชู ุดุฏู ุจุงุดุฏุ ฺูู ูฺโููุช ูุงุฑุฏ ุจููฺฉ `try/finally` ููโุดููุ ููู ุขุฒุงุฏ ูุฎูุงูุฏ ุดุฏ. ุงู ุนู **Leak ุดุฏู ููู**.

ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ูุดฺฉูุ ูุชุฏ ุฒุฑ ุฏุฑ **Monitor.Enter** ุชุนุฑู ุดุฏู ุงุณุช:

```csharp
public static void Enter (object obj, ref bool lockTaken);
```

๐ ุงฺฏุฑ ู ููุท ุงฺฏุฑ ูุชุฏ `Enter` ฺฉ **Exception** ูพุฑุชุงุจ ฺฉูุฏ ู ููู ฺฏุฑูุชู ูุดุฏู ุจุงุดุฏุ ููุฏุงุฑ `lockTaken` ุจุฑุงุจุฑ **false** ุฎูุงูุฏ ุจูุฏ.

ุงูฺฏู ุฏุฑุณุช ุงุณุชูุงุฏู ุงุฒ ุขู (ู ููุงู ฺุฒ ฺฉู ฺฉุงููพุงูุฑ C# ุฏุฑ ูพุดุชโุตุญูู ุจุฑุง ุฏุณุชูุฑ `lock` ุชููุฏ ูโฺฉูุฏ) ุจู ุดฺฉู ุฒุฑ ุงุณุช:

```csharp
bool lockTaken = false;
try
{
  Monitor.Enter (_locker, ref lockTaken);
  // Do your stuff...
}
finally { if (lockTaken) Monitor.Exit (_locker); }
```

---

### โฑ TryEnter

ฺฉูุงุณ **Monitor** ููฺูู ูุชุฏ ุจู ูุงู **TryEnter** ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ฺฉ **Timeout** ูุดุฎุต ฺฉูุฏ (ุจุฑ ุญุณุจ **Milliseconds** ุง ฺฉ **TimeSpan**).

* ุงฺฏุฑ ููู ฺฏุฑูุชู ุดูุฏุ ููุฏุงุฑ **true** ุจุฑูโฺฏุฑุฏุงูุฏ.
* ุงฺฏุฑ ููู ุจูโุฏูู **Timeout** ฺฏุฑูุชู ูุดูุฏุ ููุฏุงุฑ **false** ุจุฑูโฺฏุฑุฏุงูุฏ.

ุนูุงูู ุจุฑ ุงูุ ูุชุฏ **TryEnter** ูโุชูุงูุฏ ุจุฏูู ูฺ ุขุฑฺฏููุงู ูุฑุงุฎูุงู ุดูุฏ. ุฏุฑ ุงู ุญุงูุชุ ููุท **ููู ุฑุง ุชุณุช ูโฺฉูุฏ** ู ุงฺฏุฑ ุจูุงูุงุตูู ูุชูุงูุฏ ููู ุฑุง ุจฺฏุฑุฏุ ุจุฏูู ูุนุทู **false** ุจุฑูโฺฏุฑุฏุงูุฏ.

๐ ุฏุฑุณุช ูุซู ูุชุฏ `Enter`ุ ูุชุฏ **TryEnter** ูู ฺฉ ูุณุฎูโ overload ุฏุงุฑุฏ ฺฉู ุงุฒ ุขุฑฺฏููุงู **lockTaken** ูพุดุชุจุงู ูโฺฉูุฏ.

### ๐ Choosing the Synchronization Object (ุงูุชุฎุงุจ ุดุก ููฺฏุงูโุณุงุฒ)

ุดูุง ูโุชูุงูุฏ ุงุฒ ูุฑ ุดุฆ ฺฉู ุจุฑุง **Thread**โูุง ุดุฑฺฉุชโฺฉููุฏู ูุงุจู ูุดุงูุฏู ุจุงุดุฏุ ุจูโุนููุงู ุดุก ููฺฏุงูโุณุงุฒ ุงุณุชูุงุฏู ฺฉูุฏุ ุจุง ุงู ุดุฑุท ููู ฺฉู ุขู ุดุก ุจุงุฏ ฺฉ **Reference Type** ุจุงุดุฏ.

ุดุก ููฺฏุงูโุณุงุฒ ูุนูููุงู **private** ุงุณุช (ฺูู ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ููุทู ูููโฺฏุฐุงุฑ ุจูุชุฑ **Encapsulate** ุดูุฏ) ู ูุนูููุงู ฺฉ **Instance Field** ุง ฺฉ **Static Field** ุงุณุช.

ฺฏุงู ุงููุงุช ุดุก ููฺฏุงูโุณุงุฒ ููุงู ุดุก ูุญุงูุธุชโุดุฏู ุงุณุช. ูุงููุฏ ููุฏ `_list` ุฏุฑ ูุซุงู ุฒุฑ:

```csharp
class ThreadSafe
{
  List<string> _list = new List<string>();
  void Test()
  {
    lock (_list)
    {
      _list.Add("Item 1");
      ...
    }
  }
}
```

ุงูุจุชู ุฏุงุดุชู ฺฉ ููุฏ ุงุฎุชุตุงุต ุจุฑุง ูููโฺฏุฐุงุฑ (ูุซู `_locker` ุฏุฑ ูุซุงู ูุจู) ฺฉูุชุฑู ุฏููโุชุฑ ุฑู **Scope** ู **Granularity** ููู ูุฑุงูู ูโฺฉูุฏ.

ููฺูู ูโุชูุงูุฏ ุงุฒ ุดุก ุญุงู (ุนู `this`) ุจูโุนููุงู ุดุก ููฺฏุงูโุณุงุฒ ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
lock (this) { ... }
```

ุง ุญุช ุงุฒ ููุน ฺฉูุงุณ ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
lock (typeof(Widget)) { ... }   // ุจุฑุง ูุญุงูุธุช ุงุฒ ููุฏูุง static
```

โ ุนุจ ุงู ุฑูุดโูุง ุงู ุงุณุช ฺฉู ููุทู ูููโฺฏุฐุงุฑ **Encapsulate** ููโุดูุฏ ู ููู ูโุชูุงูุฏ ูุฏุฑุช **Deadlock** ู **Blocking** ุจุด ุงุฒ ุญุฏ ุฑุง ุณุฎุชโุชุฑ ฺฉูุฏ.

ุดูุง ุญุช ูโุชูุงูุฏ ุฑู ูุชุบุฑูุง ูุญู ฺฉู ุชูุณุท **Lambda Expressions** ุง **Anonymous Methods** ฺฏุฑูุชู ุดุฏูโุงูุฏ ูุฒ ููู ุจฺฏุฐุงุฑุฏ.

---

### โฐ When to Lock (ฺู ุฒูุงู ุจุงุฏ ููู ฺฉูู)

ููู ฺฉุฑุฏู ุฏุณุชุฑุณ ุจู ุฎูุฏ ุดุก ููฺฏุงูโุณุงุฒ ุฑุง ูุญุฏูุฏ ููโฺฉูุฏ. ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุงฺฏุฑ ูุชุฏ ูุซู `x.ToString()` ูุฑุงุฎูุงู ุดูุฏุ **Blocked** ูุฎูุงูุฏ ุดุฏ ููุท ุจู ุงู ุฏูู ฺฉู ฺฉ **Thread** ุฏฺฏุฑ ุฑู `lock(x)` ููู ฺฉุฑุฏู ุงุณุช.
ููุท ุฒูุงู **Blocking** ุงุชูุงู ูโุงูุชุฏ ฺฉู ูุฑ ุฏู **Thread** ุงุฒ `lock(x)` ุงุณุชูุงุฏู ฺฉููุฏ.

ูุงุนุฏูโ ูพุงูโุง ุงู ุงุณุช:
๐ ุดูุง ุจุงุฏ ููุดู ููฺฏุงู ุฏุณุชุฑุณ ุจู ูุฑ **Shared Writable Field** ุงุฒ ููู ุงุณุชูุงุฏู ฺฉูุฏ.

ุญุช ุฏุฑ ุณุงุฏูโุชุฑู ุญุงูุชโูุซูุงู ฺฉ ุนูู **Assignment** ุฑู ฺฉ ููุฏโุจุงุฏ **Synchronization** ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ.

ุจู ูุซุงู ุฒุฑ ุชูุฌู ฺฉูุฏ:

```csharp
class ThreadUnsafe
{
  static int _x;
  static void Increment() { _x++; }
  static void Assign()    { _x = 123; }
}
```

ุงู ฺฉูุงุณ **Thread-Safe** ูุณุช. ูุณุฎูโ ุงููโุชุฑ ุขู ุจู ุดฺฉู ุฒุฑ ุงุณุช:

```csharp
static readonly object _locker = new object();
static int _x;

static void Increment() { lock (_locker) _x++; }
static void Assign()    { lock (_locker) _x = 123; }
```

---

### โ๏ธ ูุดฺฉูุงุช ุจุฏูู Lock

ุงฺฏุฑ ููู ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏุ ุฏู ูุดฺฉู ุฑุฎ ูโุฏูุฏ:

1. โ ุนููุงุชโูุง ูุซู ุงูุฒุงุด ููุฏุงุฑ ฺฉ ูุชุบุฑ (ุง ุญุช ุฎูุงูุฏู/ููุดุชู ุขู ุฏุฑ ุดุฑุงุท ุฎุงุต) **Atomic** ูุณุชูุฏ.
2. โก **Compiler**ุ **CLR** ู **Processor** ูุฌุงุฒ ูุณุชูุฏ ุจุฑุง ุจูุจูุฏ ฺฉุงุฑุงุ ุฏุณุชูุฑุงุช ุฑุง **Reorder** ฺฉููุฏ ุง ูุชุบุฑูุง ุฑุง ุฏุฑ **CPU Registers** ฺฉุด ฺฉููุฏโุชุง ุฒูุงู ฺฉู ุงู ุจูููโุณุงุฒโูุง ุฑูุชุงุฑ ฺฉ ุจุฑูุงููโ ุชฺฉโุฑุณูุงู (ุง ฺูุฏุฑุณูุงู ฺฉู ุงุฒ ููู ุงุณุชูุงุฏู ูโฺฉูุฏ) ุฑุง ุชุบุฑ ูุฏูุฏ.

ูููโูุง ูุดฺฉู ุฏูู ุฑุง ุจุง ุงุฌุงุฏ ฺฉ **Memory Barrier** ูุจู ู ุจุนุฏ ุงุฒ ููู ฺฉุงูุด ูโุฏููุฏ.

๐งฑ **Memory Barrier** ูุงููุฏ ฺฉ ุญุตุงุฑ ุงุณุช ฺฉู ูุงูุน ุนุจูุฑ ุงุซุฑุงุช **Reordering** ู **Caching** ูโุดูุฏ.

ุงู ูุงุนุฏู ููุท ูุฎุตูุต ูููโูุง ูุณุชุ ุจูฺฉู ุจุฑุง ูููโ ุณุงุฒูโูุง **Synchronization** ุตุฏู ูโฺฉูุฏ.

ูุซุงู: ุงฺฏุฑ ฺฉ ุณุงุฒูโ ุณฺฏูุงูโุฏู ุชุถูู ฺฉูุฏ ฺฉู ููุท ฺฉ **Thread** ุฏุฑ ูุฑ ูุญุธู ูุชุบุฑ ุฑุง ุจุฎูุงูุฏ/ุจููุณุฏุ ุฏฺฏุฑ ูุงุฒ ุจู ููู ูุฏุงุฑุฏ:

```csharp
var signal = new ManualResetEvent(false);
int x = 0;
new Thread(() => { x++; signal.Set(); }).Start();
signal.WaitOne();
Console.WriteLine(x);   // ููุดู 1
```

ุฏุฑ ุจุฎุด ยซ**Nonblocking Synchronization**ยป ุชูุถุญ ุฏุงุฏูโุงู ฺฉู ฺุฑุง ฺูู ูุงุฒ ูพุด ูโุขุฏ ู ฺฺฏููู **Memory Barriers** ู ฺฉูุงุณ **Interlocked** ูโุชูุงููุฏ ุฌุงฺฏุฒู ููู ุฏุฑ ุงู ุณูุงุฑููุง ุจุงุดูุฏ.

---

### ๐ Locking and Atomicity (ูููโฺฏุฐุงุฑ ู ุงุชูฺฉ ุจูุฏู)

ุงฺฏุฑ ฺฏุฑูู ุงุฒ ูุชุบุฑูุง ููุดู ุฏุฑูู ฺฉ ููู ุฎูุงูุฏู ุง ููุดุชู ุดููุฏุ ูโุชูุงู ฺฏูุช ุงู ูุชุบุฑูุง ุจู ุดฺฉู **Atomic** ุฏุณุชุฑุณ ุฏุงุฑูุฏ.

ูุซุงู:

```csharp
lock (locker) { if (x != 0) y /= x; }
```

ุฏุฑ ุงู ุญุงูุชุ ูุชุบุฑูุง `x` ู `y` ุจูโุตูุฑุช **Atomic** ุฏุณุชุฑุณ ุฏุงุฏู ูโุดููุฏุ ุนู ูฺ **Thread** ุฏฺฏุฑ ููโุชูุงูุฏ ุฏุฑ ูุงููโ ุงู ุนููุงุช ุขูโูุง ุฑุง ุชุบุฑ ุฏูุฏ ู ูุชุฌู ุฑุง ุจโุงุนุชุจุงุฑ ฺฉูุฏ. ุจูุงุจุฑุงูุ ุดูุง ูุฑฺฏุฒ ุฎุทุง **Division by Zero** ุฏุฑุงูุช ููโฺฉูุฏุ ูุดุฑูุท ุจุฑ ุงูโฺฉู `x` ู `y` ููุดู ุฏุฑ ููู ููู ุงูุญุตุงุฑ ุฏุณุชุฑุณ ุฏุงุฏู ุดููุฏ.

---

### ๐จ ุงุณุชุซูุงูุง ู Atomicity

ุงุชูฺฉ ุจูุฏู ููู ููุถ ูโุดูุฏ ุงฺฏุฑ ุฏุงุฎู ุจููฺฉ ููู ฺฉ **Exception** ุฑุฎ ุฏูุฏ (ฺู ุจุฑูุงูู ฺูุฏุฑุณูุงู ุจุงุดุฏ ฺู ูุจุงุดุฏ).

ูุซุงู:

```csharp
decimal _savingsBalance, _checkBalance;
void Transfer(decimal amount)
{
  lock (_locker)
  {
    _savingsBalance += amount;
    _checkBalance -= amount + GetBankFee();
  }
}
```

ุงฺฏุฑ ูุชุฏ `GetBankFee()` ฺฉ **Exception** ูพุฑุชุงุจ ฺฉูุฏุ ุจุงูฺฉ ูพูู ุงุฒ ุฏุณุช ูโุฏูุฏ! ๐ฆ๐ธ

ุฏุฑ ุงู ุดุฑุงุท ูโุชูุงู ูุดฺฉู ุฑุง ุจุง ูุฑุงุฎูุงู `GetBankFee` ูพุด ุงุฒ ูุฑูุฏ ุจู ุจููฺฉ ููู ุจุฑุทุฑู ฺฉุฑุฏ.

๐ ุจุฑุง ููุงุฑุฏ ูพฺุฏูโุชุฑุ ฺฉ ุฑุงูโุญู ุงู ุงุณุช ฺฉู ููุทู **Rollback** ุฑุง ุฏุงุฎู ฺฉ ุจููฺฉ `catch` ุง `finally` ูพุงุฏูโุณุงุฒ ฺฉูู.

---

### โก Instruction Atomicity

ููููู **Instruction Atomicity** ูุชูุงูุช ุงูุง ูุดุงุจู ุงุณุช: ฺฉ ุฏุณุชูุฑ **Atomic** ุงุณุช ุงฺฏุฑ ุฑู ูพุฑุฏุงุฒูุฏูโ ุฒุฑู ุจูโุทูุฑ ุบุฑูุงุจู ุชูุณู ุงุฌุฑุง ุดูุฏ.

### ๐ ูููโูุง ุชู ุฏุฑ ุชู (Nested Locking)

ฺฉ **Thread** ูโุชูุงูุฏ ุจุงุฑูุง ฺฉ ุดุก ุฑุง ุจูโุตูุฑุช ุชู ุฏุฑ ุชู (ุง **Reentrant**) ููู ฺฉูุฏ:

```csharp
lock (locker)
  lock (locker)
    lock (locker)
    {
       // Do something...
    }
```

ุง ุจู ุฑูุด ุฏฺฏุฑ:

```csharp
Monitor.Enter (locker); 
Monitor.Enter (locker);  
Monitor.Enter (locker); 

// Do something...

Monitor.Exit (locker);  
Monitor.Exit (locker);   
Monitor.Exit (locker);
```

ุฏุฑ ุงู ุญุงูุชโูุงุ ุดุก ุชููุง ุฒูุงู **ุขุฒุงุฏ (unlock)** ูโุดูุฏ ฺฉู ุง ุฎุงุฑุฌโุชุฑู ุฏุณุชูุฑ `lock` ูพุงุงู ุงูุชู ุจุงุดุฏุ ุง ุชุนุฏุงุฏ ูุชูุงุธุฑ ุงุฒ `Monitor.Exit` ุงุฌุฑุง ุดุฏู ุจุงุดุฏ.

๐ **ููู ุชู ุฏุฑ ุชู** ุฒูุงู ููุฏ ุงุณุช ฺฉู ฺฉ ูุชุฏ ุงุฒ ุฏุงุฎู ฺฉ ูููุ ูุชุฏ ุฏฺฏุฑ ุฑุง ุตุฏุง ุจุฒูุฏ:

```csharp
object locker = new object();

lock (locker)
{
    AnotherMethod();
    // ูููุฒ ููู ุฏุงุฑู - ฺูู ูููโูุง Reentrant ูุณุชูุฏ
}

void AnotherMethod()
{
    lock (locker) { Console.WriteLine ("Another method"); }
}
```

โ ุฏุฑ ุงูุฌุง Thread ุชููุง ุฑู ุงููู (ุฎุงุฑุฌโุชุฑู) ููู ูุณุฏูุฏ ูโุดูุฏ.

---

### โ๏ธ ุจูโุจุณุชโูุง (Deadlocks)

**Deadlock** ุฒูุงู ุงุชูุงู ูโุงูุชุฏ ฺฉู ุฏู Thread ูุฑฺฉุฏุงู ููุชุธุฑ ฺฉ ููุจุน ุจุงุดูุฏ ฺฉู ุชูุณุท ุฏฺฏุฑ ููู ุดุฏู ุงุณุชุ ุฏุฑ ูุชุฌู ูฺโฺฉุฏุงู ูุงุฏุฑ ุจู ุงุฏุงูู ฺฉุงุฑ ูุฎูุงููุฏ ุจูุฏ.

ูุซุงู ุณุงุฏู ุจุง ุฏู ููู:

```csharp
object locker1 = new object();
object locker2 = new object();

new Thread (() => {
    lock (locker1)
    {
        Thread.Sleep (1000);
        lock (locker2);   // Deadlock
    }
}).Start();

lock (locker2)
{
    Thread.Sleep (1000);
    lock (locker1);       // Deadlock
}
```

๐ ุฏุฑ ุงู ุญุงูุชุ ูุฑ Thread ฺฉ ุงุฒ ูููโูุง ุฑุง ฺฏุฑูุชู ู ููุชุธุฑ ุฏฺฏุฑ ุงุณุช โ **ุจูโุจุณุช ุฏุงุฆู**.

* ุฏุฑ ูุญุท ุนุงุฏ CLRุ ุจุฑ ุฎูุงู SQL Serverุ **ุจูโุจุณุชโูุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุชุดุฎุต ู ุฑูุน ููโุดููุฏ**.
* ุงฺฏุฑ ุจูโุจุณุช ุฑุฎ ุฏูุฏุ Threadูุง ุจูโุทูุฑ ูุงูุญุฏูุฏ ูุณุฏูุฏ ูโุดููุฏ (ูฺฏุฑ ุงูโฺฉู ุฒูุงูโุงูุชุธุงุฑ ุง Timeout ุชุนุฑู ฺฉุฑุฏู ุจุงุดุฏ).
* ุฏุฑ ูุงุณุช SQL CLR (ุงุฏุบุงู SQL Server ุจุง CLR)ุ ุจูโุจุณุชโูุง ุดูุงุณุง ูโุดููุฏ ู ฺฉ ุงุณุชุซูุง ูุงุจูโูุฏุฑุช ุฑู ฺฉ ุงุฒ Threadูุง ูพุฑุชุงุจ ูโุดูุฏ.

---

### ๐ ฺุฑุง Deadlock ุณุฎุช ุงุณุชุ

* ููฺฏุงู ุทุฑุงุญ ุดโุกฺฏุฑุงุ ููฺฉู ุงุณุช ูููโูุง ุฏุฑ ุฒูุฌุฑูโุง ุงุฒ ูุชุฏูุง ุชู ุฏุฑ ุชู ฺฏุฑูุชู ุดููุฏ ฺฉู ุชุฑุชุจ ุขูโูุง ุฏุฑ ุฒูุงู ุงุฌุฑุง ูุดุฎุต ูโุดูุฏ.
* ููฺฉู ุงุณุช ุดูุง ุฑู ููุฏ `a` ุฏุฑ ฺฉูุงุณ `x` ููู ุจุฒูุฏุ ุฏุฑ ุญุงู ฺฉู ูุฑุงุฎูุงููุฏูโ ุดูุง ูุจูุงู ุฑู ููุฏ `b` ุฏุฑ ฺฉูุงุณ `y` ููู ุฒุฏู ุจุงุดุฏ. ููโุฒูุงู Thread ุฏฺฏุฑ ุจุฑุนฺฉุณ ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏูุฏ โ Deadlock.
* ุงูฺฏููุง ุฎูุจ ุทุฑุงุญ ุดโุกฺฏุฑุง (OOP) ุงู ูุดฺฉู ุฑุง ุชุดุฏุฏ ูโฺฉููุฏ ฺูู ูุฑุงุฎูุงูโูุง ุฏุฑ ุฒูุงู ุงุฌุฑุง ุชุนู ูโุดููุฏ.

---

### โ ุฑุงูฺฉุงุฑูุง ุจุฑุง ฺฉุงูุด Deadlock

1. **ูููโูุง ุฑุง ุจู ุชุฑุชุจ ุซุงุจุช ุจฺฏุฑุฏ** (ุฑูุด ฺฉูุงุณฺฉุ ูู ููุดู ุนูู ูุณุช).
2. ููฺฏุงู ููู ฺฉุฑุฏู ุงุทุฑุงู ูุฑุงุฎูุงู ูุชุฏูุง ุฏฺฏุฑ ุงุญุชุงุท ฺฉูุฏ.
3. ุจุฑุฑุณ ฺฉูุฏ ุขุง ูุงูุนุงู ูุงุฒู ุงุณุช ููฺฏุงู ูุฑุงุฎูุงู ูุชุฏูุง ุฏฺฏุฑ ููู ุจฺฏุฑุฏ ุง ุฎุฑ.
4. ุงุณุชูุงุฏู ุจุดุชุฑ ุงุฒ **ุณูฺฉุฑููโุณุงุฒ ุณุทุญ ุจุงูุงุชุฑ** ูุซู:

   * Task continuations/combinators
   * Data parallelism
   * Immutable types

๐ก ูฺฉุชู: ุฒูุงู ฺฉู ุฏุฑ ุญู ุฏุงุดุชู ฺฉ ูููุ ฺฉุฏ ุจุฑูู ุฑุง ุตุฏุง ูโุฒูุฏุ **ฺฉูพุณูููโุณุงุฒ ููู ูุดุช ูโฺฉูุฏ**. ุงู ฺฉ ูุญุฏูุฏุช ุฐุงุช ูฺฉุงูุฒู ูููโฺฏุฐุงุฑ ุงุณุชุ ูู ฺฉ ุถุนู CLR.

---

### โก๏ธ ุณูุงุฑู ุฎุงุต Deadlock ุฏุฑ UI

* ุฏุฑ ุงูพูฺฉุดูโูุง WPF: `Dispatcher.Invoke`
* ุฏุฑ Windows Forms: `Control.Invoke`

ุงฺฏุฑ ุงูโูุง ุฑุง ููฺฏุงู ุฏุงุดุชู ฺฉ ููู ุตุฏุง ุจุฒูุฏ ู Thread UI ููุชุธุฑ ููุงู ููู ุจุงุดุฏ โ Deadlock.

ุฑุงูโุญูโูุง:

* ุงุณุชูุงุฏู ุงุฒ `BeginInvoke` ุจูโุฌุง `Invoke`.
* ุง ุขุฒุงุฏ ฺฉุฑุฏู ููู ูุจู ุงุฒ ุตุฏุง ุฒุฏู `Invoke` (ุงูุจุชู ุงฺฏุฑ ููู ุชูุณุท Caller ฺฏุฑูุชู ุดุฏู ุจุงุดุฏุ ุฌูุงุจ ููโุฏูุฏ).

---

### ๐ ฺฉุงุฑุง (Performance)

* ฺฏุฑูุชู ู ุขุฒุงุฏ ฺฉุฑุฏู ููู ุฏุฑ ุญุงูุช **ุจุฏูู ุฑูุงุจุช (uncontended)** ุฑู ุณุณุชูโูุง 2020 ฺฉูุชุฑ ุงุฒ **ฒฐ ูุงููุซุงูู** ุทูู ูโฺฉุดุฏ.
* ุฏุฑ ุญุงูุช **ุฑูุงุจุช (contended)**ุ ูุฒูู ุจู ุญุฏูุฏ **ูฺฉุฑูุซุงูู** ูโุฑุณุฏ (ุจูโุฎุงุทุฑ Context Switch).
* ุฒูุงู ูุงูุน ุจุงุฒุฒูุงูโุจูุฏ Thread ููฺฉู ุงุณุช ุญุช ุจุดุชุฑ ุทูู ุจฺฉุดุฏ.

### ๐ **Mutex (ููุชฺฉุณ)**

ฺฉ **Mutex** ุดุจู ุจู ุฏุณุชูุฑ `lock` ุฏุฑ C# ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู ูโุชูุงูุฏ ุฏุฑ **ฺูุฏ ูพุฑุฏุงุฒู (multi-process)** ูู ฺฉุงุฑ ฺฉูุฏ. ุนู:

* `lock` ููุท ุฏุงุฎู ฺฉ ูพุฑุฏุงุฒู ฺฉุงุฑุจุฑุฏ ุฏุงุฑุฏ.
* `Mutex` ูู **ุณุฑุงุณุฑ ุฏุฑ ุณุทุญ ฺฉุงููพูุชุฑ (computer-wide)** ู ูู **ุณุทุญ ุจุฑูุงูู (application-wide)** ูุงุจู ุงุณุชูุงุฏู ุงุณุช.

โฑ ฺฏุฑูุชู ู ุขุฒุงุฏ ฺฉุฑุฏู ฺฉ Mutex (ุฏุฑ ุญุงูุช ุจุฏูู ุฑูุงุจุช) ุญุฏูุฏ **ฐ.ต ูฺฉุฑูุซุงูู** ุทูู ูโฺฉุดุฏุ ุนู ุจุด ุงุฒ **ฒฐ ุจุฑุงุจุฑ ฺฉูุฏุชุฑ ุงุฒ lock**.

---

### ๐ ุงุณุชูุงุฏู ุงุฒ Mutex

* ุจุฑุง ฺฏุฑูุชู ููู: `WaitOne()`
* ุจุฑุง ุขุฒุงุฏ ฺฉุฑุฏู: `ReleaseMutex()`
* ุฏููุงู ูุซู `lock`ุ ููุท ููุงู **Thread** ฺฉู Mutex ุฑุง ฺฏุฑูุชูุ ูโุชูุงูุฏ ุขู ุฑุง ุขุฒุงุฏ ฺฉูุฏ.

โ๏ธ ุงฺฏุฑ `ReleaseMutex` ุฑุง ูุฑุงููุด ฺฉูุฏ ู ููุท `Close` ุง `Dispose` ุตุฏุง ุจุฒูุฏุ
ุงููู Thread ุฏฺฏุฑ ฺฉู ุฑู ุขู ููุชุธุฑ ูุงูุฏู ุจุงุดุฏุ ุจุง **AbandonedMutexException** ููุงุฌู ูโุดูุฏ.

---

### ๐ฏ ฺฉุงุฑุจุฑุฏ ูุชุฏุงูู: ูุญุฏูุฏ ฺฉุฑุฏู ุงุฌุฑุง ฺูุฏู ูุณุฎู ุงุฒ ฺฉ ุจุฑูุงูู

ูุซุงู:

```csharp
// ุจุง ูุงูโฺฏุฐุงุฑ Mutexุ ุขู ุฑุง ุฏุฑ ุณุทุญ ฺฉู ฺฉุงููพูุชุฑ ูุงุจูโุฏุณุชุฑุณ ูโฺฉูู.
// ุจูุชุฑ ุงุณุช ูุงูุ ฺฉุชุง ุจุงุดุฏ (ูุซูุงู ุดุงูู ูุงู ุดุฑฺฉุช ุง URL).
using var mutex = new Mutex (true, @"Global\oreilly.com OneAtATimeDemo");

// ุงฺฏุฑ ููู ุงุดุบุงู ุจูุฏุ ฺูุฏ ุซุงูู ุตุจุฑ ฺฉูู
// ุดุงุฏ ูุณุฎู ูุจู ุจุฑูุงูู ุฏุฑ ุญุงู ุจุณุชู ุจุงุดุฏ.
if (!mutex.WaitOne (TimeSpan.FromSeconds (3), false))
{
    Console.WriteLine ("Another instance of the app is running. Bye!");
    return;
}

try { RunProgram(); }
finally { mutex.ReleaseMutex(); }

void RunProgram()
{
    Console.WriteLine ("Running. Press Enter to exit");
    Console.ReadLine();
}
```

๐ ูฺฉุชู:

* ุฏุฑ **Terminal Services** ุง **ฺฉูุณููโูุง ููฺฉุณ ุฌุฏุงฺฏุงูู**ุ Mutex ุณุฑุงุณุฑ ูุนูููุงู ููุท ุจุฑุง ุจุฑูุงููโูุง ุฏุฑ ููุงู **Session** ูุงุจูโุฏุณุชุฑุณ ุงุณุช.
* ุงฺฏุฑ ุจุฎูุงูุฏ ุจุฑุง ูููโ Sessionูุง ุฏุฑ ุฏุณุชุฑุณ ุจุงุดุฏุ ุจุงุฏ ูุงู Mutex ุฑุง ุจุง `"Global\"` ุดุฑูุน ฺฉูุฏ (ูุซู ููููู ฺฉุฏ).

---

### ๐งฉ Thread Safety (ุงูู ุฏุฑ ฺูุฏูุฎ)

ฺฉ ุจุฑูุงูู ุง ูุชุฏ ุฒูุงู **Thread-Safe** ุงุณุช ฺฉู ุฏุฑ ูุฑ ุณูุงุฑู ฺูุฏูุฎ ุฏุฑุณุช ฺฉุงุฑ ฺฉูุฏ.
ุงู ฺฉุงุฑ ุนูุฏุชุงู ุจุง **ูููโฺฏุฐุงุฑ (locking)** ู **ฺฉุงูุด ุชุนุงูู Threadูุง** ุจู ุฏุณุช ูโุขุฏ.

#### ฺุฑุง ูููโฺุฒ ููุดู Thread-Safe ูุณุชุ

1. ุณุฑุจุงุฑ ุชูุณุนู ุฒุงุฏ ุงุณุช (ุงฺฏุฑ ฺฉ ููุน ุชุนุฏุงุฏ ุฒุงุฏ ููุฏ ุฏุงุดุชู ุจุงุดุฏุ ูุฑ ููุฏ ูโุชูุงูุฏ ููุจุน ุชุฏุงุฎู ุจุงุดุฏ).
2. Thread-Safety ูุฒููโ ฺฉุงุฑุง ุฏุงุฑุฏ (ุญุช ุงฺฏุฑ ููุท ฺฉ Thread ุงุณุชูุงุฏู ฺฉูุฏ).
3. ุญุช ุงฺฏุฑ ฺฉ ฺฉูุงุณ Thread-Safe ุจุงุดุฏุ **ุจุฑูุงููโุง ฺฉู ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉูุฏุ ูุฒููุงู Thread-Safe ูุฎูุงูุฏ ุจูุฏ**.

โก๏ธ ุจูุงุจุฑุงูุ ูุนูููุงู **ููุท ููุงูโุฌุง Thread-Safe ูพุงุฏูโุณุงุฒ ูโุดูุฏ ฺฉู ูุงุฒู ุงุณุช**.

---

### โ๏ธ ุฑุงูโูุง "ูุงูโุจุฑ" ุจุฑุง Thread-Safety

1. **ูููโฺฏุฐุงุฑ ฺฉู (Coarse-Grained Locking)**

   * ฺฉู ุฏุณุชุฑุณ ุจู ฺฉ ุดุก ุฑุง ุฏุงุฎู ฺฉ ููู ุงูุญุตุงุฑ ูุฑุงุฑ ุฏูุฏ.
   * ุงู ุฑูุด ุจูโุฎุตูุต ุจุฑุง ุงุณุชูุงุฏู ุงุฒ **ฺฉุฏูุง ูุงุงูู ุฏุฑ ฺูุฏูุฎ** (ูุซู ุจุดุชุฑ ุงููุงุน .NET ุง ฺฉุฏูุง ุดุฎุต ุซุงูุซ) ุถุฑูุฑ ุงุณุช.
   * ุงฺฏุฑ ูุชุฏูุง ุดุก ุณุฑุน ุจุงุดูุฏุ ุงู ุฑูุด ุฌูุงุจ ูโุฏูุฏ. (ูฺฏุฑูู ููู ุฒุงุฏ ุจุงุนุซ ุจููฺฉู ุดุฏู ุฎูุงูุฏ ุดุฏ).

2. **ฺฉุงูุด ุชุนุงูู Threadูุง ุจุง ฺฉุงูุด ุฏุงุฏูโูุง ูุดุชุฑฺฉ**

   * ุงู ุงุณุชุฑุงุชฺ ุฏุฑ ุงูพูฺฉุดูโูุง Stateless (ูุซู ูุจโุณุฑูุฑูุง ุง ุณุฑูุณโูุง ูุงู) ุงุณุชูุงุฏู ูโุดูุฏ.
   * ฺูู ุฏุงุฏู ุจู ุฏุฑุฎูุงุณุชโูุง ุฐุฎุฑู ููโุดูุฏุ ุชุนุงูู Threadูุง ฺฉู ูโุดูุฏ.
   * ุชููุง ููุงุท ูุดุชุฑฺฉ ูโุชูุงููุฏ ููุฏูุง `static` ุจุงุดูุฏ (ูุซูุงู ุจุฑุง ฺฉุด ฺฉุฑุฏู ุฏุงุฏู ุง ุณุฑูุณโูุง ุฒุฑุณุงุฎุช ูุซู Authentication ู Auditing).

3. **ุงุฌุฑุง ฺฉุฏ ุฏุณุชุฑุณ ุจู ุฏุงุฏูโูุง ูุดุชุฑฺฉ ุฑู Thread ุฑุงุจุท ฺฉุงุฑุจุฑ (UI Thread)**

   * ุฏุฑ ุงูพูฺฉุดูโูุง ฺฉูุงูุช ุบู (Rich Client).
   * ุจุง ุงุณุชูุงุฏู ุงุฒ **ุชูุงุจุน Asynchronous** (ฺฉู ุฏุฑ ูุตู 14 ุฏุฏู) ุงู ฺฉุงุฑ ุฑุงุญุชโุชุฑ ูโุดูุฏ.

---

๐ ุฌูุนโุจูุฏ:

* ุงุฒ **Mutex** ููุช ุงุณุชูุงุฏู ฺฉูุฏ ฺฉู ูุงุฒ ุจู ููุงููฺฏ ุจู ฺูุฏ ูพุฑุฏุงุฒู ุฏุงุฑุฏ (ูุซู ุงุทููุงู ุงุฒ ุงุฌุฑุง ุชููุง ฺฉ ูุณุฎูโ ุจุฑูุงูู).
* ุจุฑุง **Thread-Safety**ุ ุง ุจุงุฏ ุจุง ูููโูุง ุฏุณุชุฑุณ ุฑุง ฺฉูุชุฑู ฺฉูุฏุ ุง ุจุง ุทุฑุงุญ ุตุญุญ (ูุซู Stateless ุง Immutable) ุชุนุงูู Threadูุง ุฑุง ุจู ุญุฏุงูู ุจุฑุณุงูุฏ.

### ุงูู ูุฎโูุง ู ุงููุงุน .NET ๐งต๐ก๏ธ

ุดูุง ูโุชูุงูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ **locking** ฺฉุฏ ฺฉู thread-unsafe ุงุณุช ุฑุง ุจู ฺฉุฏ thread-safe ุชุจุฏู ฺฉูุฏ. ฺฉ ุงุฒ ฺฉุงุฑุจุฑุฏูุง ุฎูุจ ุงู ฺฉุงุฑ ุฏุฑ **.NET** ุงุณุช: ุชูุฑุจุงู ูููโ ุงููุงุน **nonprimitive** (ุบุฑุงุจุชุฏุง) ุฏุฑ .NET ุฒูุงู ฺฉู ุณุงุฎุชู ูโุดููุฏุ thread-safe ูุณุชูุฏ (ุจุฑุง ฺุฒ ุจุดุชุฑ ุงุฒ ุฏุณุชุฑุณ ููุทโุฎูุงูุฏู). ุจุง ุงู ุญุงูุ ุดูุง ูโุชูุงูุฏ ุขูโูุง ุฑุง ุฏุฑ ฺฉุฏ ฺูุฏูุฎ (multithreaded) ุงุณุชูุงุฏู ฺฉูุฏุ ุจู ุดุฑุท ฺฉู ูููโ ุฏุณุชุฑุณโูุง ุจู ฺฉ ุดุก ูุดุฎุต ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ **lock** ูุญุงูุธุช ุดููุฏ.

ุฏุฑ ุงูุฌุง ูุซุงู ุฏุงุฑู ฺฉู ุฏุฑ ุขู ุฏู ูุฎ ุจูโุทูุฑ ููุฒูุงู ฺฉ ุขุชู ุฑุง ุจู ููุงู **List collection** ุงุถุงูู ูโฺฉููุฏ ู ุณูพุณ ุขู ูุณุช ุฑุง ูพูุงุด ูโฺฉููุฏ:

```csharp
class ThreadSafe
{
  static List<string> _list = new List<string>();
  static void Main()
  {
    new Thread (AddItem).Start();
    new Thread (AddItem).Start();
  }
  static void AddItem()
  {
    lock (_list) _list.Add ("Item " + _list.Count);
    string[] items;
    lock (_list) items = _list.ToArray();
    foreach (string s in items) Console.WriteLine (s);
  }
}
```

---

### ูููโฺฏุฐุงุฑ ู ุงูู ูุฎโูุง ๐

ุฏุฑ ุงู ุญุงูุชุ ูุง ุฑู ุฎูุฏ ุดุก **\_list** ููู ูโฺฉูู. ุงฺฏุฑ ุฏู ูุณุช ูุฑุชุจุท ุฏุงุดุชูุ ุจุงุฏ ฺฉ ุดุก ูุดุชุฑฺฉ ุฑุง ุจุฑุง ููู ุงูุชุฎุงุจ ูโฺฉุฑุฏู (ูโุชูุงูุณุชู ฺฉ ุงุฒ ูุณุชโูุง ุฑุง ุงูุชุฎุงุจ ฺฉูู ุง ุจูุชุฑ: ุงุฒ ฺฉ ููุฏ ูุณุชูู ุงุณุชูุงุฏู ฺฉูู).

ูพูุงุด (enumerating) ูุฌููุนูโูุง .NET ูุฒ thread-unsafe ุงุณุชุ ุจู ุงู ูุนูุง ฺฉู ุงฺฏุฑ ูุณุช ููฺฏุงู ูพูุงุด ุชุบุฑ ฺฉูุฏุ ฺฉ **exception** ุฑุฎ ูโุฏูุฏ. ุจู ุฌุง ูููโฺฏุฐุงุฑ ุฏุฑ ฺฉู ูุฏุช ูพูุงุดุ ุฏุฑ ุงู ูุซุงู ุงุจุชุฏุง ุขุชูโูุง ุฑุง ุฏุฑ ฺฉ **ุขุฑุงู** ฺฉูพ ูโฺฉูู. ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ููู ุจุฑุง ูุฏุช ุทููุงู ูฺฏู ุฏุงุดุชู ูุดูุฏุ ูุฎุตูุตุงู ุงฺฏุฑ ฺฉุงุฑ ฺฉู ููฺฏุงู ูพูุงุด ุงูุฌุงู ูโุฏูู ุฒูุงูโุจุฑ ุจุงุดุฏ. (ุฑุงูโุญู ุฏฺฏุฑ ุงุณุชูุงุฏู ุงุฒ ฺฉ **reader/writer lock** ุงุณุชุ ุจู ุจุฎุด ยซReader/Writer Locksยป ุฏุฑ ุตูุญู นฐท ูุฑุงุฌุนู ฺฉูุฏ.)

---

### ูููโฺฏุฐุงุฑ ุฑู ุงุดุงุก thread-safe โก

ฺฏุงู ูุงุฒู ุงุณุช ุญุช ููฺฏุงู ุฏุณุชุฑุณ ุจู ุงุดุงุก **thread-safe** ูุฒ ุงุฒ ููู ุงุณุชูุงุฏู ฺฉูุฏ. ุจุฑุง ุชูุถุญุ ูุฑุถ ฺฉูุฏ ฺฉู ฺฉูุงุณ **List** ุฏุฑ .NET ูุงูุนุงู thread-safe ุจูุฏ ู ูุง ูโุฎูุงุณุชู ฺฉ ุขุชู ุจู ูุณุช ุงุถุงูู ฺฉูู:

```csharp
if (!_list.Contains (newItem)) _list.Add (newItem);
```

ุตุฑูโูุธุฑ ุงุฒ ุงูฺฉู ูุณุช thread-safe ุจุงุดุฏ ุง ููุ ุงู ุฏุณุชูุฑ ูุทุนุงู thread-safe ูุณุช! ฺฉู ุนุจุงุฑุช **if** ุจุงุฏ ุฏุฑูู ฺฉ ููู ูุฑุงุฑ ฺฏุฑุฏ ุชุง ุงุฒ ูพุดโุฏุณุช (preemption) ุจู ุจุฑุฑุณ ุนุถูุช ู ุงุถุงูู ฺฉุฑุฏู ุขุชู ุฌููฺฏุฑ ุดูุฏ. ุงู ููู ุจุงุฏ ุฏุฑ ูููโ ุฌุงูุง ฺฉู ูุณุช ุฑุง ุชุบุฑ ูโุฏูู ุงุณุชูุงุฏู ุดูุฏ. ุจุฑุง ูุซุงูุ ุฏุณุชูุฑ ุฒุฑ ูุฒ ุจุงุฏ ุฏุฑ ููุงู ููู ูพฺุฏู ุดูุฏ ุชุง ุงุฒ ูพุดโุฏุณุช ูุณุจุช ุจู ุนุจุงุฑุช ูุจู ุฌููฺฏุฑ ฺฉูุฏ:

```csharp
_list.Clear();
```

ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุจุงุฏ ุฏููุงู ููุงููุฏ ฺฉูุงุณโูุง ูุฌููุนูโ thread-unsafe ูููโฺฏุฐุงุฑ ฺฉูู (ฺฉู ุงู ููุถูุน ุงูู ูุฎู ูุฑุถู ฺฉูุงุณ **List** ุฑุง ุจโุงุซุฑ ูโุณุงุฒุฏ).

---

### ุงุนุถุง ุงุณุชุง (Static Members) โ๏ธ

ูููโฺฏุฐุงุฑ ููฺฏุงู ุฏุณุชุฑุณ ุจู ฺฉ ูุฌููุนู ูโุชูุงูุฏ ุฏุฑ ูุญุทโูุง ุจุง ููุฑููุฏ ุจุงูุง (**highly concurrent environments**) ุจุงุนุซ **blocking** ุจุดโุงุฒุญุฏ ุดูุฏ. ุจุฑุง ูููุ .NET ฺฉ **queue**ุ **stack** ู **dictionary** thread-safe ูุฑุงูู ฺฉุฑุฏู ุงุณุช ฺฉู ุฏุฑ ูุตู ฒฒ ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.

ูพฺุฏู ุฏุณุชุฑุณ ุจู ฺฉ ุดุก ุฏุฑ ฺฉ ููู ุณูุงุฑุด ููุท ููุช ฺฉุงุฑ ูโฺฉูุฏ ฺฉู ูููโ ูุฎโูุง ููุฑููุฏ ุงุฒ ุขู ููู ุขฺฏุงู ุจุงุดูุฏ ู ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉููุฏ. ุงู ููฺฉู ุงุณุช ููุช ุดุก ุฏุฑ ุณุทุญ ูุณุน ุงุณุชูุงุฏู ูโุดูุฏ ุจุฑูุฑุงุฑ ูุจุงุดุฏ. ุจุฏุชุฑู ุญุงูุช ุฏุฑ ููุฑุฏ **static members** ุฏุฑ ฺฉ ููุน ุนููู (public type) ุฑุฎ ูโุฏูุฏ.

ุจุฑุง ูุซุงูุ ุชุตูุฑ ฺฉูุฏ ฺฉู ูฺฺฏ ุงุณุชุง **DateTime.Now** ุฏุฑ ุณุงุฎุชุงุฑ **DateTime** thread-safe ูุจูุฏ ู ุฏู ูุฑุงุฎูุงู ููุฒูุงู ูโุชูุงูุณุช ุฎุฑูุฌ ุฏุฑูู ุง ฺฉ **exception** ุงุฌุงุฏ ฺฉูุฏ. ุชููุง ุฑุงูโุญู ุจุง ูููโฺฏุฐุงุฑ ุฎุงุฑุฌ ุงู ุจูุฏ ฺฉู ูุจู ุงุฒ ูุฑุงุฎูุงู DateTime.Now ููุน ุฑุง ููู ฺฉูู:

```csharp
lock(typeof(DateTime))
```

ุงู ููุท ุฒูุงู ุฌูุงุจ ูโุฏูุฏ ฺฉู ูููโ ุจุฑูุงููโููุณุงู ุจุง ุงู ฺฉุงุฑ ููุงูู ุจุงุดูุฏ (ฺฉู ุจุนุฏ ุงุณุช). ุนูุงูู ุจุฑ ุงูุ ูููโฺฏุฐุงุฑ ุฑู ฺฉ ููุน ูุดฺฉูุงุช ุฎูุฏุด ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ.

ุจู ููู ุฏููุ ุงุนุถุง ุงุณุชุง **DateTime struct** ุจูโุทูุฑ ุฏูู thread-safe ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏ. ุงู ฺฉ ุงูฺฏู ุฑุงุฌ ุฏุฑ .NET ุงุณุช:

* ุงุนุถุง ุงุณุชุง (static members) โ **thread-safe** โ
* ุงุนุถุง ููููู (instance members) โ **thread-unsafe** โ

ุฏูุจุงู ฺฉุฑุฏู ุงู ุงูฺฏู ููฺฏุงู ููุดุชู ุงููุงุน ุจุฑุง ุงุณุชูุงุฏู ุนููู ููุทู ุงุณุช ุชุง ุงุฒ ุงุฌุงุฏ ูุนูุงูุง ุบุฑููฺฉูู ุงูู ูุฎ ุฌููฺฏุฑ ุดูุฏ. ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุจุง thread-safe ฺฉุฑุฏู ูุชุฏูุง ุงุณุชุงุ ุดูุง ุทูุฑ ฺฉุฏููุณ ูโฺฉูุฏ ฺฉู ูุงูุน ุงูู ูุฎ ุจุฑุง ูุตุฑูโฺฉููุฏฺฏุงู ุขู ููุน ูุดูุฏ.

โ๏ธ **ุงูู ูุฎ ุฏุฑ ูุชุฏูุง ุงุณุชุง ฺุฒ ุงุณุช ฺฉู ุจุงุฏ ุจูโุทูุฑ ุตุฑุญ ูพุงุฏูโุณุงุฒ ุดูุฏุ ุงู ูฺฺฏ ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ููุท ุจู ุฏูู ุงุณุชุง ุจูุฏู ูุชุฏ ุงุชูุงู ููโุงูุชุฏ!**

---

### ุงูู ูุฎ ุฏุฑ ุญุงูุช ููุทโุฎูุงูุฏู ๐

ุงูู ฺฉุฑุฏู ุงููุงุน ุจุฑุง ุฏุณุชุฑุณ ููุฒูุงู ููุทโุฎูุงูุฏู (ุฏุฑ ุตูุฑุช ุงูฺฉุงู) ุณูุฏููุฏ ุงุณุช ุฒุฑุง ุจู ุงู ูุนูุงุณุช ฺฉู ูุตุฑูโฺฉููุฏฺฏุงู ูโุชูุงููุฏ ุงุฒ ูููโฺฏุฐุงุฑ ุจุดโุงุฒุญุฏ ุฌููฺฏุฑ ฺฉููุฏ. ุจุณุงุฑ ุงุฒ ุงููุงุน .NET ุงู ุงุตู ุฑุง ุฏูุจุงู ูโฺฉููุฏ: ุจุฑุง ูุซุงูุ ูุฌููุนูโูุง ุจุฑุง ุฎูุงููุฏฺฏุงู ููุฒูุงู thread-safe ูุณุชูุฏ.

ุฏูุจุงู ฺฉุฑุฏู ุงู ุงุตู ุจุฑุง ุฎูุฏุชุงู ุณุงุฏู ุงุณุช: ุงฺฏุฑ ููุน ุฑุง ุจูโุนููุงู thread-safe ุจุฑุง ุฏุณุชุฑุณ ููุฒูุงู ููุทโุฎูุงูุฏู ูุณุชูุฏ ูโฺฉูุฏุ ุฏุฑ ูุชุฏูุง ฺฉู ูุตุฑูโฺฉููุฏู ุงูุชุธุงุฑ ุฏุงุฑุฏ ููุทโุฎูุงูุฏู ุจุงุดูุฏ ุจู ููุฏูุง ูููุณุฏ (ุง ุฏุฑ ุตูุฑุช ูุงุฒ ูููโฺฏุฐุงุฑ ฺฉูุฏ).

ุจุฑุง ูููููุ ุฏุฑ ูพุงุฏูโุณุงุฒ ฺฉ ูุชุฏ **ToArray()** ุฏุฑ ฺฉ ูุฌููุนูุ ููฺฉู ุงุณุช ุจุฎูุงูุฏ ุงุจุชุฏุง ุณุงุฎุชุงุฑ ุฏุงุฎู ูุฌููุนู ุฑุง ูุดุฑุฏูโุณุงุฒ ฺฉูุฏ. ุจุง ุงู ุญุงูุ ุงู ฺฉุงุฑ ุขู ุฑุง ุจุฑุง ูุตุฑูโฺฉููุฏฺฏุงู ฺฉู ุงูุชุธุงุฑ ุฏุงุดุชูุฏ ููุทโุฎูุงูุฏู ุจุงุดุฏุ thread-unsafe ูโฺฉูุฏ.

ุงูู ูุฎ ุฏุฑ ุญุงูุช ููุทโุฎูุงูุฏู ฺฉ ุงุฒ ุฏูุงู ุงุณุช ฺฉู **enumerator** ูุง ุงุฒ **enumerable** ูุง ุฌุฏุง ูุณุชูุฏ: ุฏู ูุฎ ูโุชูุงููุฏ ุจูโุทูุฑ ููุฒูุงู ุฑู ฺฉ ูุฌููุนู ูพูุงุด ฺฉููุฏ ฺูู ูุฑฺฉุฏุงู ฺฉ ุดุก enumerator ุฌุฏุง ุฏุฑุงูุช ูโฺฉููุฏ.

ุฏุฑ ูุจูุฏ ูุณุชูุฏุงุชุ ุจูุชุฑ ุงุณุช ูุญุชุงุท ุจุงุดุฏ ู ูุฑุถ ูฺฉูุฏ ฺฉู ฺฉ ูุชุฏ ุฐุงุชุงู ููุทโุฎูุงูุฏู ุงุณุช. ฺฉ ูุซุงู ุฎูุจ ฺฉูุงุณ **Random** ุงุณุช: ููุช **Random.Next()** ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ูพุงุฏูโุณุงุฒ ุฏุงุฎู ุขู ูุงุฒ ุฏุงุฑุฏ ฺฉู ููุงุฏุฑ ุจุฐุฑ ุฎุตูุต (private seed values) ุฑุง ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ. ุจูุงุจุฑุงูุ ุดูุง ุจุงุฏ ุง ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ฺฉูุงุณ Random ูููโฺฏุฐุงุฑ ฺฉูุฏ ุง ฺฉ ููููู ุฌุฏุงฺฏุงูู ุจุฑุง ูุฑ ูุฎ ูฺฏู ุฏุงุฑุฏ.

### ุงูู ูุฎ ุฏุฑ ุณุฑูุฑูุง ุจุฑูุงูู ๐ฅ๏ธ๐งต

ุณุฑูุฑูุง ุจุฑูุงูู (Application servers) ุจุงุฏ **ฺูุฏูุฎ (multithreaded)** ุจุงุดูุฏ ุชุง ุจุชูุงููุฏ ุฏุฑุฎูุงุณุชโูุง ููุฒูุงู ฺฉูุงูุชโูุง ุฑุง ูุฏุฑุช ฺฉููุฏ. ุจุฑูุงููโูุง **ASP.NET Core** ู **Web API** ุจูโุตูุฑุช ุถูู ฺูุฏูุฎ ูุณุชูุฏ. ุงู ุนู ููฺฏุงู ููุดุชู ฺฉุฏ ุฏุฑ ุณูุช ุณุฑูุฑุ ุงฺฏุฑ ุงุญุชูุงู ุชุนุงูู ูุงู ูุฎโูุง ฺฉู ุฏุฑุฎูุงุณุชโูุง ฺฉูุงูุช ุฑุง ูพุฑุฏุงุฒุด ูโฺฉููุฏ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ุจุงุฏ **ุงูู ูุฎ (thread safety)** ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ. ุฎูุดุจุฎุชุงููุ ฺูู ุงุญุชูุงู ูุงุฏุฑ ุงุณุชุ ฺฉ ฺฉูุงุณ ูุนููู ุฏุฑ ุณุฑูุฑ ุง **stateless** ุงุณุช (ูฺ ููุฏ ูุฏุงุฑุฏ) ุง ฺฉ ูุฏู ูุนุงูโุณุงุฒ ุฏุงุฑุฏ ฺฉู ุจุฑุง ูุฑ ฺฉูุงูุช ุง ูุฑ ุฏุฑุฎูุงุณุช ฺฉ ูููููโ ุฌุฏุง ุงุฒ ุดุก ูโุณุงุฒุฏ. ุชุนุงูู ูุนูููุงู ููุท ุงุฒ ุทุฑู **static fields** ุฑุฎ ูโุฏูุฏุ ฺฉู ฺฏุงู ุจุฑุง ฺฉุด ฺฉุฑุฏู ุจุฎุดโูุง ุงุฒ ุฏุชุงุจุณ ุฏุฑ ุญุงูุธู ุฌูุช ุจูุจูุฏ ฺฉุงุฑุง ุงุณุชูุงุฏู ูโุดููุฏ.

ุจุฑุง ูุซุงูุ ูุฑุถ ฺฉูุฏ ูุชุฏ ุจู ูุงู **RetrieveUser** ุฏุงุฑุฏ ฺฉู ฺฉ ุฏุชุงุจุณ ุฑุง ฺฉูุฆุฑ ูโฺฏุฑุฏ:

```csharp
// User is a custom class with fields for user data
internal User RetrieveUser (int id) { ... }
```

ุงฺฏุฑ ุงู ูุชุฏ ุจู ุฏูุนุงุช ูุฑุงุฎูุงู ุดูุฏุ ูโุชูุงู ุนููฺฉุฑุฏ ุฑุง ุจุง ฺฉุด ฺฉุฑุฏู ูุชุงุฌ ุฏุฑ ฺฉ **Dictionary** ุงุณุชุง ุจูุจูุฏ ุฏุงุฏ. ุฏุฑ ุงูุฌุง ฺฉ ุฑุงูโุญู ุณุงุฏูโ ููููู ุขูุฑุฏู ุดุฏู ุงุณุช ฺฉู ุงูู ูุฎ ุฑุง ูุฒ ุฏุฑ ูุธุฑ ูโฺฏุฑุฏ:

```csharp
static class UserCache
{
  static Dictionary<int, User> _users = new Dictionary<int, User>();
  internal static User GetUser (int id)
  {
    User u = null;
    lock (_users)
      if (_users.TryGetValue (id, out u))
        return u;
    u = RetrieveUser (id);           // Method to retrieve from database;
    lock (_users) _users[id] = u;
    return u;
  }
}
```

ุฏุฑ ุงูุฌุง ุจุงุฏ ุญุฏุงูู ููฺฏุงู ุฎูุงูุฏู ู ุจูโุฑูุฒุฑุณุงู ุฏฺฉุดูุฑ ูููโฺฏุฐุงุฑ ฺฉูู ุชุง ุงูู ูุฎ ุชุถูู ุดูุฏ. ุงู ุทุฑุงุญ ฺฉ ูุตุงูุญูโ ุนูู ูุงู ุณุงุฏฺฏ ู ฺฉุงุฑุง ุฏุฑ ูููโฺฏุฐุงุฑ ุงุณุช. ุงูุง ฺฉ ูุดฺฉู ฺฉูฺฺฉ ุงุฌุงุฏ ูโุดูุฏ: ุงฺฏุฑ ุฏู ูุฎ ุจูโุทูุฑ ููุฒูุงู ุงู ูุชุฏ ุฑุง ุจุง ฺฉ ุดูุงุณูโ ฺฉุณุงู (ฺฉู ูุจูุงู ูุงฺฉุด ูุดุฏู) ูุฑุงุฎูุงู ฺฉููุฏุ ูุชุฏ **RetrieveUser** ุฏูุจุงุฑ ุงุฌุฑุง ูโุดูุฏ ู ุฏฺฉุดูุฑ ุจโุฏูู ุจูโุฑูุฒุฑุณุงู ุฎูุงูุฏ ุดุฏ.

ููู ฺฉุฑุฏู ฺฉู ูุชุฏ ุฌูู ุงู ูุดฺฉู ุฑุง ูโฺฏุฑุฏุ ุงูุง ูุงฺฉุงุฑุขูุฏ ุจุดุชุฑ ุงุฌุงุฏ ูโฺฉูุฏ: ฺฉู ฺฉุด ุจุฑุง ูุฏุช ูุฑุงุฎูุงู **RetrieveUser** ููู ูโุดูุฏ ู ุฏุฑ ุงู ูุฏุช ุณุงุฑ ูุฎโูุง ุจุฑุง ูุงฺฉุด ฺฉุงุฑุจุฑุงู ุฏฺฏุฑ ุจูุงฺฉ ุฎูุงููุฏ ุดุฏ.

---

### ุฑุงูโุญู ุงุฏูโุขู ุจุง Task<User> โก

ุจุฑุง ฺฉ ุฑุงูโุญู ุงุฏูโุขูุ ุจุงุฏ ุงุณุชุฑุงุชฺโุง ฺฉู ุฏุฑ ุจุฎุด ยซCompleting synchronouslyยป ุตูุญู ถทท ุชูุถุญ ุฏุงุฏู ุดุฏ ุฑุง ุจูโฺฉุงุฑ ุจฺฏุฑู. ุจู ุฌุง ฺฉุด ฺฉุฑุฏู **User**ุ ูุง **Task<User>** ุฑุง ฺฉุด ูโฺฉูู ู ูุฑุงุฎูุงููุฏู ุขู ุฑุง **await** ูโฺฉูุฏ:

```csharp
static class UserCache
{
  static Dictionary<int, Task<User>> _userTasks = 
     new Dictionary<int, Task<User>>();
  internal static Task<User> GetUserAsync (int id)
  {
    lock (_userTasks)
      if (_userTasks.TryGetValue (id, out var userTask))
        return userTask;
      else
        return _userTasks[id] = Task.Run(() => RetrieveUser(id));
  }
}
```

ุฏุฑ ุงู ูุณุฎูุ ฺฉ ููู ูุงุญุฏ ฺฉู ููุทู ูุชุฏ ุฑุง ูพูุดุด ูโุฏูุฏ. ุงู ฺฉุงุฑ ุจู ููุฑููุฏ (concurrency) ุขุณุจ ููโุฒูุฏ ุฒุฑุง ุชููุง ฺฉุงุฑ ฺฉู ุฏุงุฎู ููู ุงูุฌุงู ูโุฏููุ ุฏุณุชุฑุณ ุจู ุฏฺฉุดูุฑ ู (ุงุญุชูุงูุงู) ุดุฑูุน ฺฉ ุนููุงุช **asynchronous** ุจุง ูุฑุงุฎูุงู **Task.Run** ุงุณุช.

ุงฺฏุฑ ุฏู ูุฎ ุจูโุทูุฑ ููุฒูุงู ุงู ูุชุฏ ุฑุง ุจุง ููุงู ุดูุงุณู (ID) ุตุฏุง ุจุฒููุฏุ ูุฑ ุฏู ููุชุธุฑ ููุงู **Task** ุฎูุงููุฏ ูุงูุฏุ ฺฉู ุฏููุงู ููุงู ฺุฒ ุงุณุช ฺฉู ูโุฎูุงูู. โ

---

### ุงุดุงุก ุชุบุฑูุงูพุฐุฑ (Immutable Objects) ๐

ฺฉ **immutable object** ุดุฆ ุงุณุช ฺฉู ูุถุนุชุด (state) ฺู ุจูโุตูุฑุช ุฎุงุฑุฌ ู ฺู ุฏุงุฎูุ ูุงุจู ุชุบุฑ ูุจุงุดุฏ. ููุฏูุง ฺฉ ุดุก immutable ูุนูููุงู **read-only** ุชุนุฑู ูโุดููุฏ ู ุฏุฑ ุทูู ุณุงุฒูุฏู (constructor) ููุฏุงุฑุฏู ฺฉุงูู ูโุดููุฏ.

ุชุบุฑูุงูพุฐุฑ (immutability) ฺฉ ุงุฒ ูฺฺฏโูุง ุงุตู **ุจุฑูุงููโููุณ ุชุงุจุน (functional programming)** ุงุณุชโุฌุง ฺฉู ุจูโุฌุง ุชุบุฑ ุฏุงุฏู ฺฉ ุดุกุ ฺฉ ุดุก ุฌุฏุฏ ุจุง ูฺฺฏโูุง ูุชูุงูุช ูโุณุงุฒุฏ. **LINQ** ุงุฒ ุงู ูพุงุฑุงุฏุงู ูพุฑู ูโฺฉูุฏ.

ุชุบุฑูุงูพุฐุฑ ุฏุฑ ุจุฑูุงููโูุง ฺูุฏูุฎ ูุฒ ุงุฑุฒุดููุฏ ุงุณุช ุฒุฑุง ูุดฺฉู **shared writable state** (ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ูุถุนุช ูุงุจูโููุดุชู) ุฑุง ุงุฒ ุจู ูโุจุฑุฏ ุง ุจู ุญุฏุงูู ูโุฑุณุงูุฏ.

ฺฉ ุงูฺฏู ุฑุงุฌ ุงู ุงุณุช ฺฉู ุงุฒ ุงุดุงุก immutable ุจุฑุง ฺฉูพุณููู ฺฉุฑุฏู ฺฏุฑูู ุงุฒ ููุฏูุง ูุฑุชุจุท ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ูุฏุช ุฒูุงู ูููโฺฏุฐุงุฑ ฺฉุงูุด ุงุจุฏ.

---

### ฺฉ ูุซุงู ุณุงุฏู ๐

ูุฑุถ ฺฉูุฏ ุฏู ููุฏ ุฒุฑ ุฏุงุฑู:

```csharp
int _percentComplete;
string _statusMessage;
```

ุญุงูุง ุงฺฏุฑ ุจุฎูุงูู ุขูโูุง ุฑุง ุจูโุทูุฑ ุงุชู (atomic) ุจุฎูุงูู ู ุจููุณูุ ุจู ุฌุง ูููโฺฏุฐุงุฑ ูุณุชูู ุฑู ุงู ููุฏูุงุ ูโุชูุงูู ฺฉ ฺฉูุงุณ immutable ุชุนุฑู ฺฉูู:

```csharp
class ProgressStatus    // Represents progress of some activity
{
  public readonly int PercentComplete;
  public readonly string StatusMessage;
  // This class might have many more fields...
  public ProgressStatus (int percentComplete, string statusMessage)
  {
    PercentComplete = percentComplete;
    StatusMessage = statusMessage;
  }
}
```

ุณูพุณ ูโุชูุงูู ฺฉ ููุฏ ุงุฒ ุงู ููุน ุจู ููุฑุงู ฺฉ ุดุก ููู ุชุนุฑู ฺฉูู:

```csharp
readonly object _statusLocker = new object();
ProgressStatus _status;
```

ุงฺฉููู ูโุชูุงูู ููุงุฏุฑ ุงู ููุน ุฑุง ุจุฏูู ูฺฏู ุฏุงุดุชู ููู ุจุฑุง ูุฏุช ุทููุงู ุจุฎูุงูู ู ุจููุณู:

```csharp
var status = new ProgressStatus (50, "Working on it");
// Imagine we were assigning many more fields...
// ...
lock (_statusLocker) _status = status;    // Very brief lock
```

ุจุฑุง ุฎูุงูุฏู ุดุกุ ุงุจุชุฏุง ฺฉ ฺฉูพ ุงุฒ ูุฑุฌุน ุดุก ุฑุง (ุฏุงุฎู ููู) ูโฺฏุฑู. ุณูพุณ ูโุชูุงูู ููุงุฏุฑุด ุฑุง ุจุฏูู ูุงุฒ ุจู ูฺฏู ุฏุงุดุชู ููู ุจุฎูุงูู:

```csharp
ProgressStatus status;
lock (_statusLocker) status = _status;   // Again, a brief lock
int pc = status.PercentComplete;
string msg = status.StatusMessage;
...
```

### ููู ุบุฑุงูุญุตุงุฑ (Nonexclusive Locking) ๐

ุณุงุฎุชุงุฑูุง ููู **ุบุฑุงูุญุตุงุฑ** ุจุฑุง ูุญุฏูุฏ ฺฉุฑุฏู ููโุฒูุงู (concurrency) ุจูโฺฉุงุฑ ูโุฑููุฏ. ุฏุฑ ุงู ุจุฎุดุ ุจู **Semaphore** ู **Read/Writer Locks** ูโูพุฑุฏุงุฒู ู ูุดุงู ูโุฏูู ฺฉู ฺฺฏููู ฺฉูุงุณ **SemaphoreSlim** ูโุชูุงูุฏ ููโุฒูุงู ุฑุง ุฏุฑ ุนููุงุช **ุขุณูฺฉุฑูู** ูุญุฏูุฏ ฺฉูุฏ.

---

### Semaphore ๐บ

ฺฉ **Semaphore** ุดุจู ฺฉ **ฺฉูุงุจ ุดุจุงูู** ุจุง ุธุฑูุช ูุญุฏูุฏ ุงุณุช ฺฉู ุชูุณุท **ุฏุฑุจุงู (bouncer)** ูุฏุฑุช ูโุดูุฏ.

* ููุช ฺฉูุงุจ ูพุฑ ุงุณุชุ ฺฉุณ ููโุชูุงูุฏ ูุงุฑุฏ ุดูุฏ ู ุตู ุฎุงุฑุฌ ุงุฒ ฺฉูุงุจ ุชุดฺฉู ูโุดูุฏ.
* ุชุนุฏุงุฏ Semaphore ุจุฑุงุจุฑ ุงุณุช ุจุง ุชุนุฏุงุฏ ุฌุงฺฏุงูโูุง ุฏุฑ ฺฉูุงุจ.
* **Release** ฺฉุฑุฏู ฺฉ Semaphore ุชุนุฏุงุฏ ุฑุง ุงูุฒุงุด ูโุฏูุฏุ ูุนูููุงู ููุช ฺฉุณ ฺฉูุงุจ ุฑุง ุชุฑฺฉ ูโฺฉูุฏ (ูุทุงุจูุช ุจุง ุขุฒุงุฏ ุดุฏู ฺฉ ููุจุน)ุ ุง ููุช Semaphore ููุฏุงุฑุฏู ุงููู ูโุดูุฏ.
* ูโุชูุงู ุฏุฑ ูุฑ ุฒูุงู **Release** ฺฉุฑุฏ ุชุง ุธุฑูุช ุงูุฒุงุด ุงุจุฏ.

**Wait ฺฉุฑุฏู ุฑู ฺฉ Semaphore** ุชุนุฏุงุฏ ุขู ุฑุง ฺฉุงูุด ูโุฏูุฏ ู ูุนูููุงู ูุจู ุงุฒ ฺฏุฑูุชู ฺฉ ููุจุน ุงูุฌุงู ูโุดูุฏ. ุงฺฏุฑ **Wait** ุฑู Semaphoreโุง ุจุง ููุฏุงุฑ ูุนู ุจุฒุฑฺฏโุชุฑ ุงุฒ ุตูุฑ ุงูุฌุงู ุดูุฏุ ุจูุงูุงุตูู ุชฺฉูู ูโุดูุฏ.

Semaphore ูโุชูุงูุฏ ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ (maximum count) ุฏุงุดุชู ุจุงุดุฏ ฺฉู ฺฉ ูุญุฏูุฏุช ุณุฎุช ูุญุณูุจ ูโุดูุฏ. ุงูุฒุงุด ููุฏุงุฑ ุจุด ุงุฒ ุงู ุญุฏ ุจุงุนุซ ูพุฑุชุงุจ ุงุณุชุซูุงุก ุฎูุงูุฏ ุดุฏ. ููฺฏุงู ุงุฌุงุฏ Semaphoreุ ููุฏุงุฑ ุงููู (initial count) ู ุงุฎุชุงุฑ ุญุฏุงฺฉุซุฑ ููุฏุงุฑ ูุดุฎุต ูโุดูุฏ.

---

ฺฉ **Semaphore** ุจุง ููุฏุงุฑ ุงููู ฺฉ ุดุจู **Mutex** ุง **lock** ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู **Semaphore** ูุงูฺฉ (owner) ูุฏุงุฑุฏ ู ูุณุชูู ุงุฒ ูุฎ ุงุณุช. ูุฑ ูุฎ ูโุชูุงูุฏ **Release** ฺฉูุฏุ ุฏุฑ ุญุงู ฺฉู ุฏุฑ Mutex ู lock ููุท ูุฎ ุฏุฑุงูุชโฺฉููุฏูโ ููู ูโุชูุงูุฏ ุขู ุฑุง ุขุฒุงุฏ ฺฉูุฏ.

ุฏู ูุณุฎูโ ุนููฺฉุฑุฏ ูุดุงุจู ูุฌูุฏ ุฏุงุฑุฏ: **Semaphore** ู **SemaphoreSlim**. ูุณุฎูโ ุฏูู ุจุฑุง ุจุฑูุงููโููุณ ููุงุฒ ุจุง ุชุฃุฎุฑ ูพุงู ุจููู ุดุฏู ุงุณุช ู ุฏุฑ **multithreading** ุณูุช ูุฒ ููุฏ ุงุณุชุ ุฒุฑุง ุงุฌุงุฒู ูโุฏูุฏ **CancellationToken** ููฺฏุงู **Wait** ูุดุฎุต ุดูุฏ ู ฺฉ ูุชุฏ **WaitAsync** ุจุฑุง ุจุฑูุงููโููุณ ุขุณูฺฉุฑูู ุงุฑุงุฆู ูโุฏูุฏ. ุงูุง ุจุฑุง ุณฺฏูุงูโุฏู ุจู ูุฑุขูุฏูุง (interprocess) ฺฉุงุฑุจุฑุฏ ูุฏุงุฑุฏ.

* **Semaphore** ุญุฏูุฏ ฑ ูฺฉุฑูุซุงูู ุจุฑุง ูุฑุงุฎูุงู **WaitOne** ู **Release** ุตุฑู ูโฺฉูุฏ.
* **SemaphoreSlim** ุชูุฑุจุงู ฺฉโุฏูู ุงู ุฒูุงู ุฑุง ูุตุฑู ูโฺฉูุฏ.

---

### ฺฉุงุฑุจุฑุฏ Semaphore ุจุฑุง ูุญุฏูุฏ ฺฉุฑุฏู ููโุฒูุงู โก

Semaphore ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงุฌุฑุง ุจุด ุงุฒ ุญุฏ ูุฎโูุง ุฑู ฺฉ ุจุฎุด ุฎุงุต ุงุฒ ฺฉุฏ ููุฏ ุงุณุช.

ูุซุงู ุฏุงุฑู ฺฉู ูพูุฌ ูุฎ ุชูุงุด ูโฺฉููุฏ ูุงุฑุฏ ฺฉ ฺฉูุงุจ ุดููุฏ ฺฉู ููุท ุณู ูุฎ ููุฒูุงู ุงุฌุงุฒู ูุฑูุฏ ุฏุงุฑูุฏ:

```csharp
class TheClub
{
  static SemaphoreSlim _sem = new SemaphoreSlim(3);    // ุธุฑูุช ณ
  static void Main()
  {
    for (int i = 1; i <= 5; i++) new Thread(Enter).Start(i);
  }

  static void Enter(object id)
  {
    Console.WriteLine(id + " wants to enter");
    _sem.Wait();
    Console.WriteLine(id + " is in!");           // ุญุฏุงฺฉุซุฑ ุณู ูุฎ
    Thread.Sleep(1000 * (int)id);               // ูโุชูุงููุฏ ููุฒูุงู
    Console.WriteLine(id + " is leaving");      // ุฏุฑ ฺฉูุงุจ ุจุงุดูุฏ
    _sem.Release();
  }
}
```

ููููู ุฎุฑูุฌ ููฺฉู:

```
1 wants to enter
1 is in!
2 wants to enter
2 is in!
3 wants to enter
3 is in!
4 wants to enter
5 wants to enter
1 is leaving
4 is in!
2 is leaving
5 is in!
```

---

ููฺูู ูุงููู ุงุณุช ฺฉู Semaphore ุฑุง ุจุง **ููุฏุงุฑ ุงููู ุตูุฑ** ุงุฌุงุฏ ฺฉูุฏ ู ุณูพุณ ุจุง **Release** ุชุนุฏุงุฏ ุขู ุฑุง ุงูุฒุงุด ุฏูุฏ. ูุซุงู ุฒุฑ ุฏู Semaphore ูุนุงุฏู ุฑุง ูุดุงู ูโุฏูุฏ:

```csharp
var semaphore1 = new SemaphoreSlim(3);
var semaphore2 = new SemaphoreSlim(0); 
semaphore2.Release(3);
```

ุงฺฏุฑ Semaphore ูุงูโฺฏุฐุงุฑ ุดุฏู ุจุงุดุฏุ ูโุชูุงูุฏ ูุงููุฏ Mutex ุจู ูุฑุขูุฏูุง ูุฒ ููุฑุฏ ุงุณุชูุงุฏู ูุฑุงุฑ ฺฏุฑุฏ. (Semaphore ูุงูโฺฏุฐุงุฑ ุดุฏู ููุท ุฏุฑ Windows ููุฌูุฏ ุงุณุชุ ุฏุฑ ุญุงู ฺฉู Mutex ูุงูโฺฏุฐุงุฑ ุดุฏู ุฑู Unix ูู ฺฉุงุฑ ูโฺฉูุฏ.)

### Semaphoreูุง ู ูููโูุง ุขุณูฺฉุฑูู (Asynchronous Semaphores and Locks) โณ

ููู ฺฉุฑุฏู (lock) **ุฏุฑ ฺฉ ุนุจุงุฑุช await ุบุฑูุฌุงุฒ ุงุณุช**:

```csharp
lock (_locker)
{
  await Task.Delay(1000);    // ุฎุทุง ฺฉุงููพุงู
  ...
}
```

ุฏููุด ุณุงุฏู ุงุณุช: ูููโูุง ุจู ฺฉ **ูุฎ ุฎุงุต** ุชุนูู ุฏุงุฑูุฏุ ู ููฺฏุงู ุจุงุฒฺฏุดุช ุงุฒ `await` ูุนูููุงู ูุฎ ุชุบุฑ ูโฺฉูุฏ. ุนูุงูู ุจุฑ ุงูุ **lock ุจููฺฉโฺฉููุฏู ุงุณุช** ู ุจููฺฉ ฺฉุฑุฏู ุจุฑุง ฺฉ ุจุงุฒู ุทููุงู ุฏููุงู ููุงู ฺุฒ ุงุณุช ฺฉู ุฏุฑ ุจุฑูุงููโูุง ุขุณูฺฉุฑูู ููโุฎูุงูุฏ.

---

ุจุง ุงู ุญุงูุ ฺฏุงู ุงููุงุช ูโุฎูุงูู ุนููุงุช ุขุณูฺฉุฑูู **ุจู ุตูุฑุช ูุชูุงู ุงุฌุฑุง ุดููุฏ** ุง ุชุนุฏุงุฏ ุนููุงุช ููุฒูุงู ุฑุง ูุญุฏูุฏ ฺฉูู ุชุง ุจุด ุงุฒ n ุนููุงุช ููุฒูุงู ุฑุฎ ูุฏูุฏ.

ูุซุงู: ฺฉ ูุฑูุฑฺฏุฑ ูุจ ููฺฉู ุงุณุช ูุงุฒ ุฏุงุดุชู ุจุงุดุฏ ุชุง ุฏุงูููุฏูุง ุฑุง ุจูโุตูุฑุช ุขุณูฺฉุฑูู ู ููุฒูุงู ุงูุฌุงู ุฏูุฏุ ุงูุง ุจุฎูุงูุฏ ูุญุฏูุฏุช ุญุฏุงฺฉุซุฑ ฑฐ ุฏุงูููุฏ ููุฒูุงู ุฑุง ุงุนูุงู ฺฉูุฏ. ุงู ฺฉุงุฑ ุฑุง ูโุชูุงู ุจุง **SemaphoreSlim** ุงูุฌุงู ุฏุงุฏ:

```csharp
SemaphoreSlim _semaphore = new SemaphoreSlim(10);

async Task<byte[]> DownloadWithSemaphoreAsync(string uri)
{
    await _semaphore.WaitAsync();
    try
    {
        return await new WebClient().DownloadDataTaskAsync(uri);
    }
    finally
    {
        _semaphore.Release();
    }
}
```

* ุงฺฏุฑ `initialCount` Semaphore ุฑุง ุจู ฑ ฺฉุงูุด ุฏููุ ุญุฏุงฺฉุซุฑ ููโุฒูุงู ุจู ฑ ูุญุฏูุฏ ูโุดูุฏ ู ุนููุงู ฺฉ **ููู ุขุณูฺฉุฑูู** ุงุฌุงุฏ ูโฺฉูุฏ.

---

### ููุดุชู ฺฉ ูุชุฏ extension ุจู ูุงู `EnterAsync`

ูุชุฏ extension ุฒุฑ ุงุณุชูุงุฏู ุขุณูฺฉุฑูู ุงุฒ **SemaphoreSlim** ุฑุง ุณุงุฏูโุชุฑ ูโฺฉูุฏุ ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉูุงุณ **Disposable** ฺฉู ุฏุฑ ุจุฎุด โAnonymous Disposalโ ูุนุฑู ุดุฏ:

```csharp
public static async Task<IDisposable> EnterAsync(this SemaphoreSlim ss)
{
    await ss.WaitAsync().ConfigureAwait(false);
    return Disposable.Create(() => ss.Release());
}
```

ุจุง ุงู ูุชุฏ ูโุชูุงูู ุฑูุด ูุจู ุฏุงูููุฏ ุฑุง ุจู ุดฺฉู ุณุงุฏูโุชุฑ ุจุงุฒููุณ ฺฉูู:

```csharp
async Task<byte[]> DownloadWithSemaphoreAsync(string uri)
{
    using (await _semaphore.EnterAsync())
        return await new WebClient().DownloadDataTaskAsync(uri);
}
```

---

### Parallel.ForEachAsync

ุงุฒ **.NET 6**ุ ุฑูุด ุฏฺฏุฑ ุจุฑุง ูุญุฏูุฏ ฺฉุฑุฏู ููโุฒูุงู ุขุณูฺฉุฑูู ูุฌูุฏ ุฏุงุฑุฏ: **Parallel.ForEachAsync**.

ูุฑุถ ฺฉูุฏ ุขุฑุงูโุง ุงุฒ URIูุง ุฏุงุฑู ฺฉู ูโุฎูุงูู ุฏุงูููุฏ ฺฉูู. ูโุชูุงูู ุขููุง ุฑุง ุจูโุตูุฑุช ููุฒูุงู ุฏุงูููุฏ ฺฉูู ู ููโุฒูุงู ุฑุง ุจู ุญุฏุงฺฉุซุฑ ฑฐ ุนููุงุช ูุญุฏูุฏ ฺฉูู:

```csharp
await Parallel.ForEachAsync(
    uris,
    new ParallelOptions { MaxDegreeOfParallelism = 10 },
    async (uri, cancelToken) =>
    {
        var download = await new HttpClient().GetByteArrayAsync(uri);
        Console.WriteLine($"Downloaded {download.Length} bytes");
    });
```

* ุณุงุฑ ูุชุฏูุง ฺฉูุงุณ **Parallel** ุจุดุชุฑ ุจุฑุง ุณูุงุฑููุง ุจุฑูุงููโููุณ ููุงุฒ ูุญุงุณุจุงุช (**compute-bound**) ุงุณุชูุงุฏู ูโุดููุฏุ ฺฉู ุฏุฑ ูุตู ฒฒ ุจุฑุฑุณ ุดุฏูโุงูุฏ.

### ูููโูุง ุฎูุงูุฏู/ููุดุชู (Reader/Writer Locks) ๐

ุงุบูุจ ุงููุงุชุ ูููููโูุง ฺฉ ููุน ุฏุงุฏู **ุจุฑุง ุฎูุงูุฏู ููุฒูุงู ุงูู ูุณุชูุฏ**ุ ุงูุง **ุจุฑุง ุจูโุฑูุฒุฑุณุงู ููุฒูุงู ุง ุชุฑฺฉุจ ุงุฒ ุฎูุงูุฏู ู ููุดุชู ุงูู ูุณุชูุฏ**.
ุงู ููุถูุน ูโุชูุงูุฏ ุฏุฑ ููุฑุฏ ููุงุจุน ูุงููุฏ ูุงูโูุง ูู ุตุงุฏู ุจุงุดุฏ.

* ุงุณุชูุงุฏู ุงุฒ ฺฉ **ููู ุงูุญุตุงุฑ ุณุงุฏู** (exclusive lock) ูุนูููุงู ูุดฺฉู ุฑุง ุญู ูโฺฉูุฏุ
* ุงูุง ุงฺฏุฑ ุชุนุฏุงุฏ ุฒุงุฏ ุฎูุงููุฏู ู ููุท ุจูโุฑูุฒุฑุณุงูโูุง ฺฏุงูโุจูโฺฏุงู ุฏุงุดุชู ุจุงุดูุ ุงู ฺฉุงุฑ **ูุญุฏูุฏุช ุฒุงุฏ ุฑู ููุฒูุงู ุงุฌุงุฏ ูโฺฉูุฏ**.

ูุซุงู ุงุฒ ฺูู ุณูุงุฑู ุฏุฑ **ุณุฑูุฑูุง ุชุฌุงุฑ** ุงุณุช ฺฉู ุฏุงุฏูโูุง ูพุฑฺฉุงุฑุจุฑุฏ ุฑุง ุฏุฑ **ููุฏูุง static** ุจุฑุง ุฏุณุชุฑุณ ุณุฑุน ฺฉุด ูโฺฉููุฏ.

---

### ฺฉูุงุณ `ReaderWriterLockSlim`

ุงู ฺฉูุงุณ ุจุฑุง **ุญุฏุงฺฉุซุฑ ุฏุณุชุฑุณ ููุฒูุงู** ุฏุฑ ฺูู ุดุฑุงุท ุทุฑุงุญ ุดุฏู ุงุณุช ู ุฌุงฺฏุฒู ฺฉูุงุณ ูุฏูโุชุฑ ู โฺุงูโ **ReaderWriterLock** ุงุณุช:

* ฺฉูุงุณ ูุฏู ฺูุฏู ุจุงุฑ ฺฉูุฏุชุฑ ุจูุฏ ู ฺฉ ูุดฺฉู ุทุฑุงุญ ุฏุฑ ุงุฑุชูุง ููู ุฏุงุดุช.
* ุฏุฑ ููุงุณู ุจุง ฺฉ ููู ูุนููู (`Monitor.Enter/Exit`) ูููุฒ ุฏู ุจุฑุงุจุฑ ฺฉูุฏุชุฑ ุงุณุชุ ุงูุง **ูุฒุช ุขู ฺฉุงูุด ุฑูุงุจุช (contention) ููฺฏุงู ุฎูุงูุฏู ุฒุงุฏ ู ููุดุชู ฺฉู ุงุณุช**.

---

### ุงููุงุน ููู

ุฏู ููุน ุงุตู ููู ุฏุงุฑู:

* **Write lock (ููู ููุดุชู)**: ฺฉุงููุงู ุงูุญุตุงุฑ ุงุณุช.
* **Read lock (ููู ุฎูุงูุฏู)**: ุจุง ุณุงุฑ read lockูุง ุณุงุฒฺฏุงุฑ ุงุณุช.

> ุงฺฏุฑ ฺฉ ูุฎ write lock ุฏุงุดุชู ุจุงุดุฏุ ุชูุงู ูุฎโูุง ุฏฺฏุฑ ฺฉู ูุตุฏ read ุง write ุฏุงุฑูุฏุ ูุณุฏูุฏ ูโุดููุฏ. ุงูุง ุงฺฏุฑ ูฺ write lock ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏุ ูุฑ ุชุนุฏุงุฏ ูุฎ ูโุชูุงูุฏ ููุฒูุงู read lock ุจฺฏุฑุฏ.

---

### ูุชุฏูุง ููู `ReaderWriterLockSlim`

```csharp
public void EnterReadLock();
public void ExitReadLock();
public void EnterWriteLock();
public void ExitWriteLock();
```

* ูุณุฎูโูุง **Try** ูู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู timeout ูโูพุฐุฑูุฏ (ูุดุงุจู `Monitor.TryEnter`)
* ฺฉูุงุณ ูุฏู ReaderWriterLock ุฑูุดโูุง ูุดุงุจู ุจู ูุงูโูุง `AcquireXXX` ู `ReleaseXXX` ุฏุงุฑุฏ ฺฉู ุฏุฑ ุตูุฑุช timeout **ApplicationException** ูพุฑุชุงุจ ูโฺฉูุฏ.

---

### ูุซุงู ุนูู

ุณู ูุฎ ูุฑุชุจุงู ฺฉ ูุณุช ุฑุง ูโุฎูุงููุฏ ู ุฏู ูุฎ ุฏฺฏุฑ ูุฑ ฑฐฐ ููโุซุงูู ฺฉ ุนุฏุฏ ุชุตุงุฏู ุจู ูุณุช ุงุถุงูู ูโฺฉููุฏ:

```csharp
class SlimDemo
{
    static ReaderWriterLockSlim _rw = new ReaderWriterLockSlim();
    static List<int> _items = new List<int>();
    static Random _rand = new Random();

    static void Main()
    {
        new Thread(Read).Start();
        new Thread(Read).Start();
        new Thread(Read).Start();
        new Thread(Write).Start("A");
        new Thread(Write).Start("B");
    }

    static void Read()
    {
        while (true)
        {
            _rw.EnterReadLock();
            foreach (int i in _items) Thread.Sleep(10);
            _rw.ExitReadLock();
        }
    }

    static void Write(object threadID)
    {
        while (true)
        {
            int newNumber = GetRandNum(100);
            _rw.EnterWriteLock();
            _items.Add(newNumber);
            _rw.ExitWriteLock();
            Console.WriteLine("Thread " + threadID + " added " + newNumber);
            Thread.Sleep(100);
        }
    }

    static int GetRandNum(int max) { lock (_rand) return _rand.Next(max); }
}
```

* ุฏุฑ ฺฉุฏ ุชููุฏ ูุงูุนุ ูุนูููุงู ุงุฒ **try/finally** ุจุฑุง ุงุทููุงู ุงุฒ ุขุฒุงุฏ ุดุฏู ูููโูุง ุฏุฑ ุตูุฑุช ุจุฑูุฒ ุงุณุชุซูุง ุงุณุชูุงุฏู ูโฺฉูู.
* ุฎุฑูุฌ ููููู:

```
Thread B added 61
Thread A added 83
Thread B added 55
Thread A added 33
...
```

---

### ูุฒุช ุงุตู

`ReaderWriterLockSlim` **ุงูฺฉุงู ุฎูุงูุฏู ููุฒูุงู ุจุดุชุฑ ูุณุจุช ุจู ููู ุณุงุฏู ูุฑุงูู ูโฺฉูุฏ**.

* ุจุฑุง ูุดุงูุฏู ุชุนุฏุงุฏ ูุฎโูุง concurrent ุฎูุงููุฏู ูโุชูุงูู ุฏุฑ ูุชุฏ Write ุจููุณู:

```csharp
Console.WriteLine(_rw.CurrentReadCount + " concurrent readers");
```

* ุงุบูุจ ุงููุงุช ุงู ููุฏุงุฑ ณ concurrent readers ุฎูุงูุฏ ุจูุฏุ ุฒุฑุง ูุชุฏูุง Read ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุฏุฑ ุญููู `foreach` ูโฺฏุฐุฑุงููุฏ.

---

### ูฺฺฏโูุง ู ูพุฑููพุฑุชโูุง ูุงูุชูุฑูฺฏ

```csharp
public bool IsReadLockHeld            { get; }
public bool IsUpgradeableReadLockHeld { get; }
public bool IsWriteLockHeld           { get; }
public int  WaitingReadCount          { get; }
public int  WaitingUpgradeCount       { get; }
public int  WaitingWriteCount         { get; }
public int  RecursiveReadCount        { get; }
public int  RecursiveUpgradeCount     { get; }
public int  RecursiveWriteCount       { get; }
```

ุงู ูฺฺฏโูุง ุจู ุจุฑูุงููโููุณ ุงูฺฉุงู **ูุงูุชูุฑ ฺฉุฑุฏู ูุถุนุช ูููโูุง** ู ุจูููโุณุงุฒ ุนููฺฉุฑุฏ ุฑุง ูโุฏูุฏ.

### ูููโูุง ูุงุจู ุงุฑุชูุง (Upgradeable Locks) ๐

ฺฏุงู ูุงุฒู ุงุณุช ฺฉู **ฺฉ read lock ุฑุง ุจู write lock ุชุจุฏู ฺฉูู** ุจู ุตูุฑุช **ุงุชู** (atomic).
ูุซูุงู ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ฺฉ ุขุชู ุจู ูุณุช ุงุถุงูู ฺฉูู **ููุท ุฏุฑ ุตูุฑุช ฺฉู ูุจูุงู ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ**.

ุงุฏู ุงู ุงุณุช ฺฉู ุฒูุงู ูฺฏู ุฏุงุดุชู write lock ุฑุง **ุจู ุญุฏุงูู ุจุฑุณุงูู**ุ ู ูุนูููุงู ูุฑุงุญู ุฒุฑ ุฑุง ุฏูุจุงู ูโฺฉูู:

1. ฺฏุฑูุชู ฺฉ **read lock**.
2. ุจุฑุฑุณ ุงูฺฉู ุขุง ุขุชู ูุจูุงู ุฏุฑ ูุณุช ูุณุช ุง ููุ ุงฺฏุฑ ูุณุชุ ููู ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู ุจุงุฒ ูโฺฏุฑุฏู.
3. ุขุฒุงุฏ ฺฉุฑุฏู read lock.
4. ฺฏุฑูุชู **write lock**.
5. ุงุถุงูู ฺฉุฑุฏู ุขุชู ุจู ูุณุช.

๐ก ูุดฺฉู: ุจู ูุฑุงุญู ณ ู ดุ **ฺฉ ูุฎ ุฏฺฏุฑ ููฺฉู ุงุณุช ูุงุฑุฏ ุดุฏู ู ูุณุช ุฑุง ุชุบุฑ ุฏูุฏ** (ูุซูุงู ููุงู ุขุชู ุฑุง ุงุถุงูู ฺฉูุฏ).

---

### ุฑุงูโุญู `ReaderWriterLockSlim`

ฺฉูุงุณ `ReaderWriterLockSlim` ุจุฑุง ุงู ูุดฺฉูุ **ููุน ุณูู ุงุฒ ููู** ุงุฑุงุฆู ูโุฏูุฏ: **upgradeable lock**.

* ุงู ููู ุดุจู read lock ุงุณุชุ ุงูุง ูโุชูุงู ุขู ุฑุง **ุจุนุฏุงู ุจู write lock ุงุฑุชูุง ุฏุงุฏ** ุจู ุตูุฑุช ุงุชู.

ูุฑุงุญู ุงุณุชูุงุฏู ุงุฒ Upgradeable Lock:

1. ูุฑุงุฎูุงู `EnterUpgradeableReadLock()`
2. ุงูุฌุงู ุนููุงุช ูุจุชู ุจุฑ ุฎูุงูุฏู (ูุซูุงู ุจุฑุฑุณ ูุฌูุฏ ุขุชู)
3. ูุฑุงุฎูุงู `EnterWriteLock()` โ ุงู ูุฑุญูู **ููู ูุงุจู ุงุฑุชูุง ุฑุง ุจู write lock ุชุจุฏู ูโฺฉูุฏ**
4. ุงูุฌุงู ุนููุงุช ููุดุชู (ูุซูุงู ุงุถุงูู ฺฉุฑุฏู ุขุชู ุจู ูุณุช)
5. ูุฑุงุฎูุงู `ExitWriteLock()` โ write lock ุจู upgradeable lock ุจุงุฒ ูโฺฏุฑุฏุฏ
6. ุงูุฌุงู ูุฑ ุนููุงุช ุฎูุงูุฏู ุฏฺฏุฑ
7. ูุฑุงุฎูุงู `ExitUpgradeableReadLock()`

> ุงุฒ ุฏุฏ ุจุฑูุงููโููุณุ ุงู ูุงููุฏ **ูููโูุง ุชู ุฏุฑ ุชู ุง ุจุงุฒฺฏุดุช (nested/recursive)** ุงุณุช.
> ุงุฒ ูุธุฑ ุนููฺฉุฑุฏุ ุฏุฑ ูุฑุญูู ณุ `ReaderWriterLockSlim` **read lock ูุจู ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู write lock ุฌุฏุฏ ูโฺฏุฑุฏ ุจู ุตูุฑุช ุงุชู**.

---

### ุชูุงูุช ููู ุจุง read lock

* ฺฉ upgradeable lock ูโุชูุงูุฏ **ููุฒูุงู ุจุง ุชุนุฏุงุฏ ุฒุงุฏ read lock** ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.
* ุงูุง **ุชููุง ฺฉ upgradeable lock ูโุชูุงูุฏ ููุฒูุงู ฺฏุฑูุชู ุดูุฏ**.
* ุงู ูุญุฏูุฏุช **ุงุฒ deadlock ููฺฏุงู ุชุจุฏู ุฌููฺฏุฑ ูโฺฉูุฏ**ุ ูุดุงุจู ฺฉุงุฑ ฺฉู **update lock ุฏุฑ SQL Server** ุงูุฌุงู ูโุฏูุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/21/Table-21-1.jpeg)
</div>

### ูุซุงู ุนูู ุงุฒ Upgradeable Lock ู ููู ุจุงุฒฺฏุดุช ๐

ูโุชูุงูู **Upgradeable Lock** ุฑุง ุจุง ุชุบุฑ ูุชุฏ `Write` ุฏุฑ ูุซุงู ูุจู ูุดุงู ุฏููุ ุจู ุทูุฑ ฺฉู **ฺฉ ุนุฏุฏ ุจู ูุณุช ุงุถุงูู ุดูุฏ ููุท ุงฺฏุฑ ูุจูุงู ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ**:

```csharp
while (true)
{
    int newNumber = GetRandNum(100);
    _rw.EnterUpgradeableReadLock();

    if (!_items.Contains(newNumber))
    {
        _rw.EnterWriteLock();
        _items.Add(newNumber);
        _rw.ExitWriteLock();
        Console.WriteLine("Thread " + threadID + " added " + newNumber);
    }

    _rw.ExitUpgradeableReadLock();
    Thread.Sleep(100);
}
```

---

### ููู ุจุงุฒฺฏุดุช (Lock Recursion) ๐

* `ReaderWriterLock` ูุฏู ูโุชูุงูุฏ ุชุจุฏู ูููโูุง ุฑุง ุงูุฌุงู ุฏูุฏุ ุงูุง **ุบุฑูุงุจู ุงุนุชูุงุฏ** ุงุณุช ู ููููู **upgradeable lock** ุฑุง ูุฏุงุฑุฏ.
* `ReaderWriterLockSlim` ุจู ุทูุฑ ูพุดโูุฑุถ **ูููโูุง ุจุงุฒฺฏุดุช ุง ุชู ุฏุฑ ุชู ุฑุง ูุฌุงุฒ ููโุฏุงูุฏ**.

ูุซุงู ุฎุทุงโุฏููุฏู:

```csharp
var rw = new ReaderWriterLockSlim();
rw.EnterReadLock();
rw.EnterReadLock();  // Exception!
rw.ExitReadLock();
rw.ExitReadLock();
```

ุจุฑุง ูพุดุชุจุงู ุงุฒ ููู ุจุงุฒฺฏุดุชุ ุจุงุฏ ููฺฏุงู ุณุงุฎุช ฺฉูุงุณ ูุดุฎุต ฺฉูู:

```csharp
var rw = new ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion);
```

๐ก ูุงููู ุงุตู ุจุฑุง ูููโูุง ุจุงุฒฺฏุดุช: ูพุณ ุงุฒ ฺฏุฑูุชู ฺฉ ูููุ **ูููโูุง ุจุนุฏ ูโุชูุงููุฏ ฺฉูุชุฑ ุงูุง ูู ุจุดุชุฑ ุงุฒ ููุน ุงููู ุจุงุดูุฏ**:

```
Read Lock โ Upgradeable Lock โ Write Lock
```

* ุงุฑุชูุงุก upgradeable lock ุจู write lock ููุดู ูุฌุงุฒ ุงุณุช.

ูุซุงู ุชุฑฺฉุจ:

```csharp
rw.EnterWriteLock();
rw.EnterReadLock();
Console.WriteLine(rw.IsReadLockHeld);   // True
Console.WriteLine(rw.IsWriteLockHeld);  // True
rw.ExitReadLock();
rw.ExitWriteLock();
```

---

### ุณฺฏูุงูโุฏู ุจุง Event Wait Handles ๐

**Event Wait Handle** ุณุงุฏูโุชุฑู ุงุจุฒุงุฑ ุจุฑุง ุณฺฏูุงูโุฏู ุจู ูุฎโูุง ุงุณุช ู **ูุฑุชุจุท ุจุง C# events ูุณุช**.
ุงููุงุน ุงุตู:

* `AutoResetEvent`
* `ManualResetEvent` / `ManualResetEventSlim`
* `CountdownEvent`

ุชูุงู ุงูโูุง ุงุฒ ฺฉูุงุณ ูพุงู `EventWaitHandle` ูุดุชู ุดุฏูโุงูุฏ.

---

#### AutoResetEvent ๐๏ธ

* ุดุจู **ฺฏุฐุฑฺฏุงู ุจูุช (turnstile)** ุงุณุช: ูุฑูุฏ ุจูุช ููุท ฺฉ ููุฑ ุฑุง ุนุจูุฑ ูโุฏูุฏ.
* ูพุณ ุงุฒ ุนุจูุฑุ ฺฏุฐุฑฺฏุงู ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ **reset** ูโุดูุฏ.
* ฺฉ ูุฎ ุจุง `WaitOne()` ููุชุธุฑ ูโูุงูุฏ ู ฺฉ ูุฎ ุฏฺฏุฑ ุจุง `Set()` ุขู ุฑุง ุขุฒุงุฏ ูโฺฉูุฏ.

ุณุงุฎุช AutoResetEvent:

```csharp
var auto = new AutoResetEvent(false);  
// ุง
var auto = new EventWaitHandle(false, EventResetMode.AutoReset);
```

ูุซุงู ุณุงุฏู:

```csharp
class BasicWaitHandle
{
    static EventWaitHandle _waitHandle = new AutoResetEvent(false);

    static void Main()
    {
        new Thread(Waiter).Start();
        Thread.Sleep(1000);       // ูฺฉุซ ฺฉ ุซุงูู
        _waitHandle.Set();        // ูุนุงู ฺฉุฑุฏู Waiter
    }

    static void Waiter()
    {
        Console.WriteLine("Waiting...");
        _waitHandle.WaitOne();    // ุงูุชุธุงุฑ ุจุฑุง ุณฺฏูุงู
        Console.WriteLine("Notified");
    }
}
```

**ุฎุฑูุฌ:**

```
Waiting... (pause) Notified
```

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/21/Table-21-2.jpeg)
</div>

### ุฑูุชุงุฑ `Set` ููุช ูฺ ูุฎ ููุชุธุฑ ูุณุช โ๏ธ

* ุงฺฏุฑ `Set()` ูุฑุงุฎูุงู ุดูุฏ ู ูฺ ูุฎ ููุชุธุฑ ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏุ **handle ุจุงุฒ ูโูุงูุฏ** ุชุง ุฒูุงู ฺฉู ฺฉ ูุฎ `WaitOne()` ูุฑุงุฎูุงู ฺฉูุฏ.
* ุงู ุฑูุชุงุฑ ุงุฒ **ุฑูุงุจุช ุจู ูุฎโูุง ุฌููฺฏุฑ ูโฺฉูุฏ**: ูุฎ ูโุฎูุงูุฏ ูุงุฑุฏ ฺฏุฐุฑฺฏุงู ุดูุฏ ู ูุฎ ุฏฺฏุฑ ุฒูุฏุชุฑ `Set()` ุฒุฏู ุจุงุดุฏ.
* ุงูุงุ **ูุฑุงุฎูุงู ูฺฉุฑุฑ `Set()` ููุช ูฺโฺฉุณ ููุชุธุฑ ูุณุชุ ุจุงุนุซ ุนุจูุฑ ฺูุฏ ููุฑ ููโุดูุฏ**ุ ููุท ููุฑ ุจุนุฏ ุนุจูุฑ ูโฺฉูุฏ ู ุจูุชโูุง ุงุถุงู ยซูุฏุฑ ูโุฑููุฏยป.

---

### ุขุฒุงุฏุณุงุฒ Wait Handle โป๏ธ

* ูพุณ ุงุฒ ูพุงุงู ุงุณุชูุงุฏู ุงุฒ wait handleุ ูโุชูุงู `Close()` ุฑุง ุตุฏุง ุฒุฏ ุชุง ููุจุน ุณุณุชู ุนุงูู ุขุฒุงุฏ ุดูุฏ.
* ุง ูโุชูุงู ุชูุงู ุงุฑุฌุงุนุงุช ุจู ุขู ุฑุง ุฑูุง ฺฉุฑุฏ ู ุงุฌุงุฒู ุฏุงุฏ **garbage collector** ุจุนุฏุงู ุขู ุฑุง ุฌูุนโุขูุฑ ฺฉูุฏ (wait handleูุง ุงุฒ ุงูฺฏู disposal ูพุฑู ูโฺฉููุฏ ู finalizer ุขูโูุง `Close()` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ).
* Wait handleูุง ููฺฏุงู ุฎุฑูุฌ process ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุขุฒุงุฏ ูโุดููุฏ.

#### ูฺฉุงุช ููู

* `Reset()` ุฑู AutoResetEventุ ฺฏุฐุฑฺฏุงู ุฑุง ูโุจูุฏุฏ (ุงฺฏุฑ ุจุงุฒ ุจุงุดุฏ) ุจุฏูู ุงูุชุธุงุฑ ุง ุจูุงฺฉ ฺฉุฑุฏู.
* `WaitOne(timeout)` ูโุชูุงูุฏ **ูุฏุช ุงูุชุธุงุฑ ุฑุง ูุญุฏูุฏ** ฺฉูุฏ ู ุงฺฏุฑ timeout ุฑุฎ ุฏูุฏุ `false` ุจุฑูโฺฏุฑุฏุงูุฏ.
* `WaitOne(0)` ูโุชูุงูุฏ ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง wait handle ยซุจุงุฒยป ุงุณุช ุจุฏูู ุจูุงฺฉ ฺฉุฑุฏู ูุฎ ูุฑุงุฎูุงููุฏู.

> โ๏ธ ุชูุฌู: ุงู ฺฉุงุฑ ุจุงุนุซ **reset ุดุฏู AutoResetEvent** ุงฺฏุฑ ุจุงุฒ ุจุงุดุฏุ ูโุดูุฏ.

---

### ุณฺฏูุงูโุฏู ุฏูุทุฑูู โ๏ธ

ุงฺฏุฑ ุจุฎูุงูู ูุฎ ุงุตู (main thread) ุจู ฺฉ ูุฎ worker ุณู ุจุงุฑ ูุชูุงู ุณฺฏูุงู ุจุฏูุฏ:

* ูุฑุงุฎูุงู ุณุงุฏู `Set()` ฺูุฏ ุจุงุฑ ูพุดุช ุณุฑ ูู ููฺฉู ุงุณุช ุจุงุนุซ **ุงุฒ ุฏุณุช ุฑูุชู ุณฺฏูุงูโูุง** ุดูุฏุ ุฒุฑุง worker ููฺฉู ุงุณุช ุฒูุงู ุจุจุฑุฏ ุชุง ูุฑ ุณฺฏูุงู ุฑุง ูพุฑุฏุงุฒุด ฺฉูุฏ.
* ุฑุงูโุญู: ูุฎ ุงุตู **ุตุจุฑ ฺฉูุฏ ุชุง worker ุขูุงุฏู ุดูุฏ** ูุจู ุงุฒ ุงุฑุณุงู ุณฺฏูุงู. ุงู ฺฉุงุฑ ุจุง ฺฉ `AutoResetEvent` ุฏฺฏุฑ ุงูุฌุงู ูโุดูุฏ.

ูุซุงู ฺฉุงูู:

```csharp
class TwoWaySignaling
{
    static EventWaitHandle _ready = new AutoResetEvent(false);
    static EventWaitHandle _go = new AutoResetEvent(false);
    static readonly object _locker = new object();
    static string _message;

    static void Main()
    {
        new Thread(Work).Start();

        _ready.WaitOne();       // ููุชุธุฑ ูโูุงูุฏ ุชุง worker ุขูุงุฏู ุดูุฏ
        lock (_locker) _message = "ooo";
        _go.Set();              // ุณฺฏูุงู ุจู worker

        _ready.WaitOne();       // ููุชุธุฑ ูโูุงูุฏ ุชุง worker ุฏูุจุงุฑู ุขูุงุฏู ุดูุฏ
        lock (_locker) _message = "ahhh";
        _go.Set();

        _ready.WaitOne();
        lock (_locker) _message = null; // ุณฺฏูุงู ูพุงุงู
        _go.Set();
    }

    static void Work()
    {
        while (true)
        {
            _ready.Set();       // ุงุนูุงู ุขูุงุฏฺฏ
            _go.WaitOne();      // ููุชุธุฑ ุณฺฏูุงู

            lock (_locker)
            {
                if (_message == null) return;  // ุฎุฑูุฌ ฺฉูุชุฑูโุดุฏู
                Console.WriteLine(_message);
            }
        }
    }
}
```

**ุฎุฑูุฌ:**

```
ooo
ahhh
```

* ุฏุฑ ุดฺฉู 21-2 ูุฑุขูุฏ ุขูุงุฏู ุดุฏู ู ุณฺฏูุงูโุฏู ุฏูุทุฑูู ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/21/Table-21-3.jpeg)
</div>

### ุงุณุชูุงุฏู ุงุฒ ูพุงู null ุจุฑุง ูพุงุงู ุฏุงุฏู ุจู worker ๐

* ุฏุฑ ูุซุงู ูุจูุ ุงุฒ ฺฉ ูพุงู `null` ุจุฑุง ูุดุฎุต ฺฉุฑุฏู ูพุงุงู ฺฉุงุฑ worker ุงุณุชูุงุฏู ุดุฏ.
* ุจุฑุง ูุฎโูุง ฺฉู **ุจูโุตูุฑุช ูุงูุญุฏูุฏ ุงุฌุฑุง ูโุดููุฏ**ุ ุฏุงุดุชู ฺฉ ุงุณุชุฑุงุชฺ ุฎุฑูุฌ ุถุฑูุฑ ุงุณุช.

---

### ManualResetEvent ๐๏ธ

* ููุงูโุทูุฑ ฺฉู ุฏุฑ ูุตู ฑด ุชูุถุญ ุฏุงุฏู ุดุฏุ `ManualResetEvent` ูุงููุฏ ฺฉ **ุฏุฑูุงุฒู ุณุงุฏู** ุนูู ูโฺฉูุฏ:

  * ูุฑุงุฎูุงู `Set()` ุฏุฑูุงุฒู ุฑุง ุจุงุฒ ูโฺฉูุฏ ู **ูุฑ ุชุนุฏุงุฏ ูุฎ** ฺฉู `WaitOne()` ูุฑุงุฎูุงู ฺฉุฑุฏูโุงูุฏุ ุนุจูุฑ ูโุฏููุฏ.
  * ูุฑุงุฎูุงู `Reset()` ุฏุฑูุงุฒู ุฑุง ูโุจูุฏุฏ. ูุฎโูุง ฺฉู `WaitOne()` ุฑู ุฏุฑูุงุฒู ุจุณุชู ุตุฏุง ูโุฒููุฏุ **ุจูุงฺฉ ูโุดููุฏ** ุชุง ุฏุฑูุงุฒู ุจุงุฒ ุดูุฏ.
* ุนููฺฉุฑุฏ ฺฉู ูุดุงุจู `AutoResetEvent` ุงุณุช.

#### ุณุงุฎุช ManualResetEvent

```csharp
var manual1 = new ManualResetEvent(false);
var manual2 = new EventWaitHandle(false, EventResetMode.ManualReset);
```

* ูุณุฎู ุจูููโุชุฑ ุจู ูุงู `ManualResetEventSlim` ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุจุฑุง **ุฒูุงู ุงูุชุธุงุฑ ฺฉูุชุงู** ุจููู ุดุฏู ู ุงูฺฉุงู **ุงุณุชูุงุฏู ุงุฒ CancellationToken** ุฑุง ุฏุงุฑุฏ.
* `ManualResetEventSlim` subclass ุงุฒ `WaitHandle` ูุณุช ุงูุง ุฏุงุฑุง ูฺฺฏ `WaitHandle` ุงุณุช ฺฉู ฺฉ **object ูุจุชู ุจุฑ WaitHandle** ุจุฑูโฺฏุฑุฏุงูุฏ.

---

### ุนููฺฉุฑุฏ ู ฺฉุงุฑุง โฑ๏ธ

* ุงูุชุธุงุฑ ุง ุณฺฏูุงู ุฏุงุฏู ุจุง `AutoResetEvent` ุง `ManualResetEvent` ุญุฏูุฏ **ฺฉ ูฺฉุฑูุซุงูู** ุทูู ูโฺฉุดุฏ (ุงฺฏุฑ ุจูุงฺฉ ูุดูุฏ).
* `ManualResetEventSlim` ู `CountdownEvent` ูโุชูุงููุฏ **ุชุง ตฐ ุจุฑุงุจุฑ ุณุฑุนโุชุฑ** ุฏุฑ ุฒูุงู ุงูุชุธุงุฑ ฺฉูุชุงู ุนูู ฺฉููุฏุ ุจู ุฏูู ุนุฏู ูุงุจุณุชฺฏ ุจู OS ู ุงุณุชูุงุฏู ุงุฒ **spinning constructs**.
* ุจุง ุงู ุญุงูุ ุฏุฑ ุงฺฉุซุฑ ุณูุงุฑููุงุ overhead ุงู ฺฉูุงุณโูุง ูุนูููุงู **ฺฏููฺฏุงู ุงุฌุงุฏ ููโฺฉูุฏ**.

---

### ฺฉุงุฑุจุฑุฏ ManualResetEvent ู CountdownEvent

* `ManualResetEvent`: ุจุฑุง **ุจุงุฒ ฺฉุฑุฏู ฺฉ ูุฎ ุจุฑุง ฺูุฏ ูุฎ ุฏฺฏุฑ** ููุฏ ุงุณุช.
* `CountdownEvent`: ุจุฑุง **ููุชุธุฑ ูุงูุฏู ุฑู ฺูุฏ ูุฎ** ุงุณุชูุงุฏู ูโุดูุฏ.

#### CountdownEvent

```csharp
var countdown = new CountdownEvent(3); // ููุฏุงุฑ ุงููู ณ ูุฎ

new Thread(SaySomething).Start("I am thread 1");
new Thread(SaySomething).Start("I am thread 2");
new Thread(SaySomething).Start("I am thread 3");

countdown.Wait(); // ุจููฺฉ ุชุง ณ ุจุงุฑ Signal ูุฑุงุฎูุงู ุดูุฏ
Console.WriteLine("All threads have finished speaking!");

void SaySomething(object thing)
{
    Thread.Sleep(1000);
    Console.WriteLine(thing);
    countdown.Signal(); // ฺฉุงูุด count
}
```

* ูโุชูุงู count ุฑุง ุจุง `AddCount` ุงูุฒุงุด ุฏุงุฏุ ุงูุง ุงฺฏุฑ ุดูุงุฑุด ุจู ุตูุฑ ุฑุณุฏู ุจุงุดุฏุ **ุงุณุชุซูุง ุงุฌุงุฏ ูโฺฉูุฏ**.
* ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฎุทุงุ ุงุฒ `TryAddCount` ุงุณุชูุงุฏู ูโฺฉูู ฺฉู **false** ุจุฑูโฺฏุฑุฏุงูุฏ ุงฺฏุฑ ุดูุงุฑุด ุตูุฑ ุจุงุดุฏ.
* ุจุฑุง โunsignalโ ฺฉุฑุฏู ฺฉ CountdownEvent ุงุฒ `Reset()` ุงุณุชูุงุฏู ูโฺฉูู ฺฉู **count ุฑุง ุจู ููุฏุงุฑ ุงููู ุจุงุฒูุดุงู ูโฺฉูุฏ**.
* ูุดุงุจู `ManualResetEventSlim`ุ CountdownEvent ุฏุงุฑุง ูฺฺฏ `WaitHandle` ุจุฑุง ุชุนุงูู ุจุง ฺฉูุงุณโูุง ฺฉู **WaitHandle ุงูุชุธุงุฑ ุฏุงุฑูุฏ**ุ ุงุณุช.

---

### ุงุฌุงุฏ EventWaitHandle ูุงู ูพุฑุฏุงุฒุด ๐

* ูโุชูุงู ฺฉ EventWaitHandle **ูุงูโุฏุงุฑ** ุงุฌุงุฏ ฺฉุฑุฏ ฺฉู ุจู ฺูุฏ ูพุฑุฏุงุฒุด ฺฉุงุฑ ฺฉูุฏ.
* ูุงู ุชููุง ฺฉ ุฑุดุชู ุงุณุช ู ุจุงุฏ **ููุญุตุฑุจูโูุฑุฏ ุจุงุดุฏ** ุชุง ุจุง ุณุงุฑ ููุงุจุน ุชุฏุงุฎู ูฺฉูุฏ.

```csharp
EventWaitHandle wh = new EventWaitHandle(
    false,
    EventResetMode.AutoReset,
    @"Global\MyCompany.MyApp.SomeName"
);
```

* ุงฺฏุฑ ุฏู ุจุฑูุงูู ุงู ฺฉุฏ ุฑุง ุงุฌุฑุง ฺฉููุฏุ ูโุชูุงููุฏ **ุจู ูู ุณฺฏูุงู ุฏููุฏ**: wait handle ุฏุฑ ููู ูุฎโูุง ู ูพุฑุฏุงุฒุดโูุง ฺฉุงุฑ ูโฺฉูุฏ.
* ุชูุฌู: **Named EventWaitHandle ููุท ุฏุฑ Windows ููุฌูุฏ ุงุณุช**.

### Wait Handles ู Continuations ๐

ุจู ุฌุง **ููุชุธุฑ ูุงูุฏู ุฑู ฺฉ wait handle** ู ุจูุงฺฉ ฺฉุฑุฏู ูุฎุ ูโุชูุงู ฺฉ **continuation** ุจู ุขู ุถููู ฺฉุฑุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ `ThreadPool.RegisterWaitForSingleObject`.

#### ูุซุงู

```csharp
var starter = new ManualResetEvent(false);

RegisteredWaitHandle reg = ThreadPool.RegisterWaitForSingleObject(
    starter, Go, "Some Data", -1, true);

Thread.Sleep(5000);
Console.WriteLine("Signaling worker...");
starter.Set();
Console.ReadLine();

reg.Unregister(starter); // ูพุงฺฉโุณุงุฒ ูพุณ ุงุฒ ุงุชูุงู

void Go(object data, bool timedOut)
{
    Console.WriteLine("Started - " + data);
    // ุงูุฌุงู ฺฉุงุฑ...
}
```

* ุฒูุงู ฺฉู wait handle **signaled** ูโุดูุฏ (ุง timeout ุฑุฎ ูโุฏูุฏ)ุ delegate ุฑู ฺฉ ูุฎ ุงุฒ ThreadPool ุงุฌุฑุง ูโุดูุฏ.
* ูพุณ ุงุฒ ุขู ุจุงุฏ `Unregister` ูุฑุงุฎูุงู ุดูุฏ ุชุง **handle ุบุฑูุฏุฑุชโุดุฏู** ุขุฒุงุฏ ุดูุฏ.
* ุงู ูุชุฏ ููฺูู ฺฉ **object โblack boxโ** ูโฺฏุฑุฏ ฺฉู ุจู delegate ููุชูู ูโุดูุฏุ ฺฉ **timeout** (ููโุซุงููุ `-1` ุนู ุจุฏูู timeout) ู ฺฉ **Boolean** ฺฉู ูุดุฎุต ูโฺฉูุฏ ุขุง ูุฑุงุฎูุงู ฺฉโุจุงุฑู ุงุณุช ุง ูฺฉุฑุฑ.

โ๏ธ ูฺฉุชู:

* ูโุชูุงู `RegisterWaitForSingleObject` ุฑุง **ููุท ฺฉ ุจุงุฑ ุจุฑุง ูุฑ wait handle** ูุฑุงุฎูุงู ฺฉุฑุฏ.
* ูุฑุงุฎูุงู ุฏูุจุงุฑู ุฑู ููุงู wait handle ููฺฉู ุงุณุช ุจุงุนุซ ุดูุฏ callback ุญุช ููุช handle signaled ูุดุฏูุ ุงุฌุฑุง ุดูุฏ.
* ุจู ููู ุฏููุ wait handles ุบุฑ-Slim ุจุฑุง ุจุฑูุงููโููุณ asynchronous ููุงุณุจ ูุณุชูุฏ.

---

### WaitAnyุ WaitAll ู SignalAndWait โณ๐

ุนูุงูู ุจุฑ ูุชุฏูุง **Set**ุ **WaitOne** ู **Reset**ุ ฺฉูุงุณ **WaitHandle** ุฏุงุฑุง ูุชุฏูุง ุงุณุชุงุชฺฉ ุฏฺฏุฑ ุงุณุช ฺฉู ุจุฑุง ุญู ูุณุงุฆู ูพฺุฏูโุชุฑ ููุฒูุงูโุณุงุฒ ฺฉุงุฑุจุฑุฏ ุฏุงุฑูุฏ. ูุชุฏูุง **WaitAny**ุ **WaitAll** ู **SignalAndWait** ุนููุงุชโูุง ุณฺฏูุงูโุฏู ู ุงูุชุธุงุฑ ุฑุง ุฑู ฺูุฏู **wait handle** ุงูุฌุงู ูโุฏููุฏ. ุงู **wait handle**ูุง ูโุชูุงููุฏ ุงุฒ ุงููุงุน ูุฎุชูู ุจุงุดูุฏ (ุงุฒ ุฌููู **Mutex** ู **Semaphore**ุ ุฒุฑุง ุงูโูุง ูุฒ ุงุฒ ฺฉูุงุณ ุงูุชุฒุงุน **WaitHandle** ูุดุชู ุดุฏูโุงูุฏ).

ููฺููุ **ManualResetEventSlim** ู **CountdownEvent** ูโุชูุงููุฏ ุงุฒ ุทุฑู ูฺฺฏโูุง **WaitHandle** ุฎูุฏ ุฏุฑ ุงู ูุชุฏูุง ุดุฑฺฉุช ฺฉููุฏ.

ูุชุฏูุง **WaitAll** ู **SignalAndWait** ุงุฑุชุจุงุท ุนุฌุจ ุจุง ูุนูุงุฑ ูุฏู **COM** ุฏุงุฑูุฏ: ุงู ูุชุฏูุง ูุงุฒููุฏ ุขู ูุณุชูุฏ ฺฉู ูุฑุงุฎูุงููุฏู ุฏุฑ ฺฉ **multithreaded apartment** ุจุงุดุฏุ ูุฏู ฺฉู ุจุฑุง ุชุนุงูู ุจุง ุฏฺฏุฑ ุณุณุชูโูุง ฺูุฏุงู ููุงุณุจ ูุณุช. ุจูโุนููุงู ูุซุงูุ **thread ุงุตู** ฺฉ ุจุฑูุงูู **WPF** ุง **Windows Forms** ุฏุฑ ุงู ุญุงูุช ููโุชูุงูุฏ ุจุง **clipboard** ุชุนุงูู ฺฉูุฏ. ุฌุงฺฏุฒูโูุง ุฑุง ุฏุฑ ุงุฏุงูู ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.

* **WaitHandle.WaitAny** ููุชุธุฑ ูโูุงูุฏ ุชุง ูุฑ ฺฉ ุงุฒ ุขุฑุงูโุง ุงุฒ **wait handle**ูุง ุณฺฏูุงู ุจฺฏุฑูุฏ.
* **WaitHandle.WaitAll** ููุชุธุฑ ูโูุงูุฏ ุชุง ููู **wait handle**ูุง ุฏุงุฏูโุดุฏู ุจูโุตูุฑุช **ุงุชู** ุณฺฏูุงู ุจฺฏุฑูุฏ.

ุงู ุจุฏุงู ูุนูุงุณุช ฺฉู ุงฺฏุฑ ุฑู ุฏู **AutoResetEvent** ููุชุธุฑ ุจุงุดุฏ:

* **WaitAny** ูุฑฺฏุฒ ุจุงุนุซ ููโุดูุฏ ฺฉู ูุฑ ุฏู ุฑูุฏุงุฏ ุจูโุทูุฑ ููุฒูุงู "ููู" ุดููุฏ.
* **WaitAll** ูุฑฺฏุฒ ุจุงุนุซ ููโุดูุฏ ฺฉู ุชููุง ฺฉ ุงุฒ ุฑูุฏุงุฏูุง "ููู" ุดูุฏ.

**SignalAndWait** ุงุจุชุฏุง **Set** ุฑุง ุฑู ฺฉ **WaitHandle** ูุฑุงุฎูุงู ูโฺฉูุฏ ู ุณูพุณ **WaitOne** ุฑุง ุฑู **WaitHandle** ุฏฺฏุฑ ุตุฏุง ูโุฒูุฏ. ูพุณ ุงุฒ ุณฺฏูุงูโุฏู ุจู **handle** ุงููุ ุจู ุงุจุชุฏุง ุตู ุงูุชุธุงุฑ ุจุฑุง **handle** ุฏูู ูโุฑูุฏุ ุงู ฺฉุงุฑ ฺฉูฺฉ ูโฺฉูุฏ ุชุง ุนููุงุช ูููู ุดูุฏ (ูุฑฺูุฏ ฺฉู ุนููุงุช ูุงูุนุงู ุงุชู ูุณุช). ูโุชูุงู ุงู ูุชุฏ ุฑุง ุจูโุนููุงู ยซุชุจุงุฏู ฺฉ ุณฺฏูุงู ุจุง ุณฺฏูุงู ุฏฺฏุฑยป ุชุตูุฑ ฺฉุฑุฏ ู ุขู ุฑุง ุฑู ฺฉ ุฌูุช **EventWaitHandle** ุงุณุชูุงุฏู ฺฉุฑุฏ ุชุง ุฏู **thread** ุฏุฑ ฺฉ ููุทู ุฒูุงู ุจุง ูู ููุงูุงุช ุง **rendezvous** ุฏุงุดุชู ุจุงุดูุฏ. ูู **AutoResetEvent** ู ูู **ManualResetEvent** ููุงุณุจ ุงู ฺฉุงุฑ ูุณุชูุฏ.

* **Thread ุงูู** ุงุฌุฑุง ูโฺฉูุฏ:

```csharp
WaitHandle.SignalAndWait (wh1, wh2);
```

* **Thread ุฏูู** ฺฉุงุฑ ูุนฺฉูุณ ุฑุง ุงูุฌุงู ูโุฏูุฏ:

```csharp
WaitHandle.SignalAndWait (wh2, wh1);
```

---

### ุฌุงฺฏุฒูโูุง ุจุฑุง WaitAll ู SignalAndWait ๐

ูุชุฏูุง **WaitAll** ู **SignalAndWait** ุฏุฑ ฺฉ **single-threaded apartment** ฺฉุงุฑ ููโฺฉููุฏ. ุฎูุดุจุฎุชุงูู ุฌุงฺฏุฒูโูุง ูุฌูุฏ ุฏุงุฑูุฏ. ุฏุฑ ููุฑุฏ **SignalAndWait**ุ ุจู ูุฏุฑุช ูุงุฒ ุจู ูฺฺฏโูุง **queue-jumping** ุขู ุงุณุช: ุจุฑุง ูุซุงู ุฏุฑ ูุซุงู **rendezvous** ูุงุ ฺฉุงู ุงุณุช ฺฉู ุงุจุชุฏุง **Set** ุฑุง ุฑู **wait handle** ุงูู ุตุฏุง ุจุฒูุฏ ู ุณูพุณ **WaitOne** ุฑุง ุฑู ุฏฺฏุฑ ูุฑุงุฎูุงู ฺฉูุฏุ ุงฺฏุฑ ุงุฒ **wait handle**ูุง ุตุฑูุงู ุจุฑุง ููุงู ููุงูุงุช ุงุณุชูุงุฏู ูโฺฉูุฏ. ุฏุฑ ุจุฎุด ุจุนุฏุ ฺฉ ฺฏุฒูู ุฏฺฏุฑ ุจุฑุง ูพุงุฏูโุณุงุฒ **thread rendezvous** ุจุฑุฑุณ ูโฺฉูู.

ุฏุฑ ููุฑุฏ **WaitAny** ู **WaitAll**ุ ุงฺฏุฑ ุจู ุงุชู ุจูุฏู ูุงุฒ ูุฏุงุฑุฏุ ูโุชูุงูุฏ ุงุฒ ฺฉุฏ ฺฉู ุฏุฑ ุจุฎุด ูุจู ููุดุชู ุงุณุชูุงุฏู ฺฉูุฏ ุชุง **wait handle**ูุง ุฑุง ุจู **Task** ุชุจุฏู ฺฉุฑุฏู ู ุณูพุณ ุงุฒ **Task.WhenAny** ู **Task.WhenAll** ุงุณุชูุงุฏู ฺฉูุฏ (ูุตู ฑด).

ุงฺฏุฑ ุจู ุงุชู ุจูุฏู ูุงุฒ ุฏุงุฑุฏุ ูโุชูุงูุฏ ุงุฒ ุณุทุญ ูพุงูโุชุฑ ุดุฑูุน ฺฉูุฏ ู ููุทู ุณฺฏูุงูโุฏู ุฑุง ุฎูุฏุชุงู ุจุง ูุชุฏูุง **Monitor.Wait** ู **Monitor.Pulse** ุจููุณุฏ. ูุง **Wait** ู **Pulse** ุฑุง ุจูโุตูุฑุช ููุตู ุฏุฑ [ุงู ููฺฉ](http://albahari.com/threading) ุชูุถุญ ุฏุงุฏูโุงู. โ

### ฺฉูุงุณ Barrier ๐๐งต

ฺฉูุงุณ **Barrier** ฺฉ **ูุงูุน ุงุฌุฑุง thread** ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ ฺฉู ุงุฌุงุฒู ูโุฏูุฏ ฺูุฏู **thread** ุฏุฑ ฺฉ ููุทู ุฒูุงู ุจุง ูู **rendezvous** ุฏุงุดุชู ุจุงุดูุฏ (ุงู ุจุง **Thread.MemoryBarrier** ูุชูุงูุช ุงุณุช).

ุงู ฺฉูุงุณ ุจุณุงุฑ ุณุฑุน ู ฺฉุงุฑุขูุฏ ุงุณุช ู ุจุฑ ุงุณุงุณ ูุชุฏูุง **Wait**ุ **Pulse** ู **spinlock** ุณุงุฎุชู ุดุฏู ุงุณุช.

#### ูุญูู ุงุณุชูุงุฏู

1. ฺฉ ููููู ุงุฒ ฺฉูุงุณ ุงุฌุงุฏ ฺฉูุฏ ู ูุดุฎุต ฺฉูุฏ ฺฉู ฺูุฏ **thread** ุจุงุฏ ุฏุฑ **rendezvous** ุดุฑฺฉุช ฺฉููุฏ (ูโุชูุงูุฏ ุจุนุฏุงู ุจุง ูุชุฏูุง **AddParticipants** ุง **RemoveParticipants** ุงู ุชุนุฏุงุฏ ุฑุง ุชุบุฑ ุฏูุฏ).
2. ูุฑ **thread** ุฒูุงู ฺฉู ูโุฎูุงูุฏ ุฏุฑ **rendezvous** ุดุฑฺฉุช ฺฉูุฏุ ูุชุฏ **SignalAndWait** ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.

ุงฺฏุฑ ฺฉูุงุณ **Barrier** ุฑุง ุจุง ููุฏุงุฑ ณ ุงุฌุงุฏ ฺฉูุฏุ ูุฑุงุฎูุงู **SignalAndWait** ุชุง ุฒูุงู ฺฉู ุงู ูุชุฏ ุณู ุจุงุฑ ูุฑุงุฎูุงู ูุดุฏู ุจุงุดุฏุ **ุจููฺฉ** ูโุดูุฏ. ุณูพุณ ุฏูุจุงุฑู ฺุฑุฎู ุดุฑูุน ูโุดูุฏ: ูุฑุงุฎูุงู ุจุนุฏ **SignalAndWait** ุฏูุจุงุฑู ุชุง ุณู ุจุงุฑ ุตุฏุง ุฒุฏู ูุชุฏ **ุจููฺฉ** ูโุดูุฏ. ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ูุฑ **thread** ููุฒูุงู ุจุง ุฏฺฏุฑ **thread**ูุง ุญุฑฺฉุช ฺฉูุฏ.

#### ูุซุงู ุนูู

ุฏุฑ ุงู ูุซุงูุ ูุฑ ฺฉ ุงุฒ ุณู **thread** ุงุนุฏุงุฏ ฐ ุชุง ด ุฑุง ฺุงูพ ูโฺฉููุฏ ู ููโุฒูุงู ุจุง ุฏฺฏุฑ **thread**ูุง ุฌูู ูโุฑููุฏ:

```csharp
var barrier = new Barrier(3);
new Thread(Speak).Start();
new Thread(Speak).Start();
new Thread(Speak).Start();

void Speak()
{
    for (int i = 0; i < 5; i++)
    {
        Console.Write(i + " ");
        barrier.SignalAndWait();
    }
}
```

**ุฎุฑูุฌ:**

```
0 0 0 1 1 1 2 2 2 3 3 3 4 4 4
```

ฺฉ ูฺฺฏ ุจุณุงุฑ ููุฏ **Barrier** ุงู ุงุณุช ฺฉู ูโุชูุงูุฏ **post-phase action** ุฑุง ููฺฏุงู ุงุฌุงุฏ ุขู ูุดุฎุต ฺฉูุฏ. ุงู ฺฉ **delegate** ุงุณุช ฺฉู ุจุนุฏ ุงุฒ ุขูฺฉู **SignalAndWait** ุจู ุชุนุฏุงุฏ ูุดุฎุต ูุฑุงุฎูุงู ุดุฏ ุงุฌุฑุง ูโุดูุฏุ ุงูุง ูุจู ุงุฒ ุงูฺฉู **threads** ุขุฒุงุฏ ุดููุฏ.

ุฏุฑ ูุซุงู ูุงุ ุงฺฏุฑ **Barrier** ุฑุง ุจู ุงู ุตูุฑุช ุงุฌุงุฏ ฺฉูู:

```csharp
static Barrier _barrier = new Barrier(3, barrier => Console.WriteLine());
```

ุฎุฑูุฌ ุจู ุตูุฑุช ุฎุท ุจู ุฎุท ุฎูุงูุฏ ุจูุฏ:

```
0 0 0 
1 1 1 
2 2 2 
3 3 3 
4 4 4
```

ุงู ูฺฺฏ ุจุงุนุซ ูโุดูุฏ ููุงููฺฏ **threads** ุจุณุงุฑ ููุธู ู ุฎูุงูุง ุจุงุดุฏ. โ

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/21/Table-21-4.jpeg)
</div>

### ุนููุงุช ูพุณโูุงุฒ (Post-Phase Action) ู ุฌูุนโุขูุฑ ุฏุงุฏูโูุง ๐

ฺฉ **Post-Phase Action** ูโุชูุงูุฏ ุจุฑุง **ุงุฏุบุงู ุฏุงุฏูโูุง ุงุฒ ูุฑ ฺฉ ุงุฒ worker threadโูุง** ููุฏ ุจุงุดุฏ. ุฏุฑ ุงู ุญุงูุชุ ูฺฏุฑุงูโุง ุงุฒ ุจุงุจุช **preemption** ูุฌูุฏ ูุฏุงุฑุฏุ ุฒุฑุง ุชูุงู **workerูุง** ุฏุฑ ุญู ุงุฌุฑุง ุงู ุนููุงุช **ูุณุฏูุฏ** ูุณุชูุฏ.

---

### ููุฏุงุฑุฏู ุชูุจู (Lazy Initialization) ๐ข๐ก

ฺฉ ุงุฒ ูุดฺฉูุงุช ุฑุงุฌ ุฏุฑ **threading** ุงู ุงุณุช ฺฉู ฺฺฏููู ฺฉ **ููุฏ ูุดุชุฑฺฉ** ุฑุง ุจู ุตูุฑุช **ุชูุจู ู thread-safe** ููุฏุงุฑุฏู ฺฉูู. ุงู ูุงุฒ ุฒูุงู ุงุฌุงุฏ ูโุดูุฏ ฺฉู ฺฉ ููุฏ ุงุฒ ููุน ุฏุงุดุชู ุจุงุดู ฺฉู **ุณุงุฎุช ุขู ูุฒููโุจุฑ ุจุงุดุฏ**:

```csharp
class Foo
{
    public readonly Expensive Expensive = new Expensive();
    ...
}
class Expensive { /* ูุฑุถ ฺฉูุฏ ุณุงุฎุช ุงู ฺฉูุงุณ ูพุฑูุฒูู ุงุณุช */ }
```

ูุดฺฉู ุงู ฺฉุฏ ุงู ุงุณุช ฺฉู **ุณุงุฎุช Foo** ูุฒููโ **ุณุงุฎุช Expensive** ุฑุง ูุฒ ูุชุญูู ูโุดูุฏุ ุญุช ุงฺฏุฑ ููุฏ **Expensive** ูฺโููุช ุฏุณุชุฑุณ ูพุฏุง ูฺฉูุฏ.

ุฑุงู ุญู ูุงุถุญ ุงู ุงุณุช ฺฉู **ููููู ุฑุง ููุท ุฏุฑ ุตูุฑุช ูุงุฒ ุงุฌุงุฏ ฺฉูู**:

```csharp
class Foo
{
    Expensive _expensive;
    public Expensive Expensive   // ููุฏุงุฑุฏู ุชูุจู Expensive
    {
        get
        {
            if (_expensive == null) _expensive = new Expensive();
            return _expensive;
        }
    }
    ...
}
```

ุงูุง ุณูุงู ุงูุฌุงุณุช: ุขุง ุงู **thread-safe** ุงุณุชุ
ุงฺฏุฑ ุฏู **thread** ููุฒูุงู ุจู ุงู property ุฏุณุชุฑุณ ูพุฏุง ฺฉููุฏุ ููฺฉู ุงุณุช ูุฑ ุฏู ุดุฑุท **if** ุฑุง ุจุฑุขูุฑุฏู ฺฉููุฏ ู ูุฑ thread ฺฉ ูููููโ ูุชูุงูุช ุงุฒ **Expensive** ุงุฌุงุฏ ฺฉูุฏ. ุงู ูโุชูุงูุฏ ููุฌุฑ ุจู ุฎุทุงูุง ุธุฑู ุดูุฏุ ุจูุงุจุฑุงู ุจู ุทูุฑ ฺฉูุ ุงู ฺฉุฏ **ุงูู ุจุฑุง thread ูุณุช**.

ุฑุงู ุญู **ุงูู ุจุฑุง thread** ุงู ุงุณุช ฺฉู **ฺฺฉ ฺฉุฑุฏู ู ููุฏุงุฑุฏู ุฑุง ุฏุงุฎู ฺฉ lock** ุงูุฌุงู ุฏูู:

```csharp
Expensive _expensive;
readonly object _expenseLock = new object();

public Expensive Expensive
{
    get
    {
        lock (_expenseLock)
        {
            if (_expensive == null) _expensive = new Expensive();
            return _expensive;
        }
    }
}
```

---

### ฺฉูุงุณ Lazy<T> โก

ฺฉูุงุณ **Lazy<T>** ุจุฑุง ฺฉูฺฉ ุจู **ููุฏุงุฑุฏู ุชูุจู** ุฏุฑ ุฏุณุชุฑุณ ุงุณุช. ุงฺฏุฑ ุขู ุฑุง ุจุง ุขุฑฺฏููุงู **true** ุจุณุงุฒุฏุ **ุงูฺฏู ููุฏุงุฑุฏู thread-safe** ฺฉู ุจุงูุงุชุฑ ุชูุถุญ ุฏุงุฏู ุดุฏ ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ.

**Lazy<T>** ุฏุฑ ูุงูุน ฺฉ ูุณุฎูโ **micro-optimized** ุงุฒ ุงู ุงูฺฏูุ ุจู ูุงู **double-checked locking** ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ.
ุงู ุงูฺฏู ฺฉ **ุฎูุงูุฏู volatile ุงุถุงู** ุงูุฌุงู ูโุฏูุฏ ุชุง ุงฺฏุฑ ุดุก ุงุฒ ูุจู ููุฏุงุฑุฏู ุดุฏู ุจูุฏุ ูุฒููโ ฺฏุฑูุชู lock ุฑุง ูุฏุงุดุชู ุจุงุดู.

#### ูุญูู ุงุณุชูุงุฏู ุงุฒ Lazy<T>

```csharp
Lazy<Expensive> _expensive = new Lazy<Expensive>(
    () => new Expensive(), true);

public Expensive Expensive { get { return _expensive.Value; } }
```

ุงฺฏุฑ **false** ุจู ุณุงุฒูุฏูโ **Lazy<T>** ุจุฏูุฏุ ุงูฺฏู **ุบุฑ ุงูู ุจุฑุง thread** ุงุฌุงุฏ ูโฺฉูุฏุ ููุงููุฏ ุงูฺฏู ฺฉู ุฏุฑ ุงุจุชุฏุง ุงู ุจุฎุด ุชูุถุญ ุฏุงุฏู ุดุฏโฺฉู ุฏุฑ ูุญุทโูุง **single-threaded** ููุงุณุจ ุงุณุช. โ

### ฺฉูุงุณ LazyInitializer โก

ฺฉูุงุณ **LazyInitializer** ฺฉ ฺฉูุงุณ **static** ุงุณุช ฺฉู ุฏููุงู ูุงููุฏ **Lazy<T>** ุนูู ูโฺฉูุฏุ ุจุง ุงู ุชูุงูุชโูุง:

* ุนููฺฉุฑุฏ ุขู ุงุฒ ุทุฑู ฺฉ **ูุชุฏ static** ุงุฑุงุฆู ูโุดูุฏ ฺฉู ูุณุชูู ุฑู **ููุฏ ุฎูุฏุชุงู** ุนูู ูโฺฉูุฏ. ุงู ุจุงุนุซ ูโุดูุฏ ฺฉ ุณุทุญ **indirection** ุญุฐู ุดูุฏ ู ุฏุฑ ุณูุงุฑููุง ฺฉู ุจู **ุจูููโุณุงุฒ ุดุฏุฏ** ูุงุฒ ุฏุงุฑุฏุ ุนููฺฉุฑุฏ ุจูุชุฑ ุดูุฏ.
* ฺฉ **ุญุงูุช ููุฏุงุฑุฏู ุฏฺฏุฑ** ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุฏุฑ ุขู **ฺูุฏู thread ูโุชูุงููุฏ ุจุฑุง ููุฏุงุฑุฏู ุฑูุงุจุช ฺฉููุฏ**.

ุจุฑุง ุงุณุชูุงุฏู ุงุฒ **LazyInitializer**ุ ูุจู ุงุฒ ุฏุณุชุฑุณ ุจู ููุฏุ **EnsureInitialized** ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ู **ุงุฑุฌุงุน ููุฏ ู delegate ฺฉุงุฑุฎุงูู** ุฑุง ูพุงุณ ุฏูุฏ:

```csharp
Expensive _expensive;
public Expensive Expensive
{ 
    get          // ูพุงุฏูโุณุงุฒ double-checked locking
    { 
        LazyInitializer.EnsureInitialized(ref _expensive,
                                         () => new Expensive());
        return _expensive;
    }
}
```

ููฺูู ูโุชูุงูุฏ ฺฉ ุขุฑฺฏููุงู ุงุถุงู ูพุงุณ ุฏูุฏ ุชุง **ฺูุฏ thread ุฑูุจ ุจุฑุง ููุฏุงุฑุฏู ุฑูุงุจุช ฺฉููุฏ**. ุงู ุดุจู ูุซุงู thread-unsafe ุงููู ูุง ุงุณุชุ ุงูุง **ุงููู thread ฺฉู ุชูุงู ูโุดูุฏ ููุดู ุจุฑูุฏู ุงุณุช** ู ุฏุฑ ููุงุช ุชููุง ฺฉ ููููู ุฎูุงูุฏ ุฏุงุดุช.

ูุฒุช ุงู ุชฺฉูฺฉ ุงู ุงุณุช ฺฉู ุฏุฑ ุณุณุชูโูุง **ฺูุฏ ูุณุชูโุง** ุญุช ุณุฑุนโุชุฑ ุงุฒ **double-checked locking** ุงุณุชุ ุฒุฑุง ูโุชูุงูุฏ **ฺฉุงููุงู ุจุฏูู lock** ูพุงุฏูโุณุงุฒ ุดูุฏุ ุจุง ุงุณุชูุงุฏู ุงุฒ ุชฺฉูฺฉโูุง ูพุดุฑูุชูโุง ฺฉู ุฏุฑ ุจุฎุดโูุง ยซNonblocking Synchronizationยป ู ยซLazy Initializationยป ุฏุฑ [albahari.com/threading](http://albahari.com/threading) ุชูุถุญ ุฏุงุฏู ุดุฏู ุงุณุช.

ุงู ฺฉ ุจูููโุณุงุฒ **extreme ู ุจู ูุฏุฑุช ููุฑุฏ ูุงุฒ** ุงุณุช ฺฉู ูุฒููโูุง ุฏุงุฑุฏ:

* ููุช ุชุนุฏุงุฏ threadูุง ุฑูุงุจุชโฺฉููุฏู ุจุฑุง ููุฏุงุฑุฏู ุงุฒ ุชุนุฏุงุฏ ูุณุชูโูุง ุจุดุชุฑ ุจุงุดุฏุ **ฺฉูุฏุชุฑ ุงุณุช**.
* ููฺฉู ุงุณุช ููุงุจุน CPU ุตุฑู ุงูุฌุงู **ููุฏุงุฑุฏู ุชฺฉุฑุงุฑ** ุดูุฏ.
* ููุทู ููุฏุงุฑุฏู ุจุงุฏ **thread-safe** ุจุงุดุฏ (ูุซูุงู ุงฺฏุฑ constructor ฺฉูุงุณ **Expensive** ุฏุงุฏูโุง ุฑุง ุจู ููุฏูุง static ูโููุดุช).
* ุงฺฏุฑ initializer ุดุฆ ุงุฌุงุฏ ฺฉูุฏ ฺฉู ูุงุฒ ุจู **disposal** ุฏุงุฑุฏุ ุดุก ยซุงุถุงูยป ุจุฏูู ููุทู ุงุถุงูู **dispose** ููโุดูุฏ.

---

### ุฐุฎุฑูโุณุงุฒ ูุญู ุจุฑุง Threadโูุง (Thread-Local Storage) ๐งต

ุจุฎุด ุฒุงุฏ ุงุฒ ุงู ูุตู ุฑู **ุณูฺฉุฑููุฒุดู ู ูุดฺฉูุงุช ฺฉู ููฺฏุงู ุฏุณุชุฑุณ ููุฒูุงู threadูุง ุจู ฺฉ ุฏุงุฏู ุงุฌุงุฏ ูโุดูุฏ** ุชูุฑฺฉุฒ ุฏุงุดุช.
ฺฏุงู ุงููุงุชุ ูโุฎูุงูุฏ ุฏุงุฏูโูุง ุฑุง **ุงุฒููู ูฺฏู ุฏุงุฑุฏ** ู ูุทูุฆู ุดูุฏ ฺฉู **ูุฑ thread ูุณุฎูโ ุฌุฏุงฺฏุงููโุง ุฏุงุฑุฏ**.

* ูุชุบุฑูุง ูุญู ุฏููุงู ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏููุฏุ ุงูุง ููุท ุจุฑุง ุฏุงุฏูโูุง **ูููุช** ููุฏ ูุณุชูุฏ.
* **ุฑุงู ุญู:** **Thread-local storage**.

ูุนูููุงู ุฏุงุฏูโูุง ฺฉู ูโุฎูุงูุฏ ุจู ฺฉ thread ุงุฎุชุตุงุต ุฏูุฏ **ุจู ุทูุฑ ุทุจุน ูููุช** ูุณุชูุฏ. ฺฉุงุฑุจุฑุฏ ุงุตู ุขูโูุง **ุฐุฎุฑูโุณุงุฒ ุฏุงุฏูโูุง ยซุฎุงุฑุฌ ุงุฒ ูุณุฑ ุงุตูยป** ุงุณุชโูุซู **messagingุ transaction ู security tokens**.
ูพุงุณ ุฏุงุฏู ฺูู ุฏุงุฏูโูุง ุงุฒ ุทุฑู ูพุงุฑุงูุชุฑูุง ูุชุฏ ูโุชูุงูุฏ **ุฏุณุช ู ูพุง ฺฏุฑ** ุจุงุดุฏ ู ุฐุฎุฑู ุขูโูุง ุฏุฑ ููุฏูุง static ูุนููู ุจุงุนุซ **ุจู ุงุดุชุฑุงฺฉ ฺฏุฐุงุดุชู ุฏุงุฏู ูุงู ููู threadูุง** ูโุดูุฏ.

**Thread-local storage** ููฺูู ุฏุฑ **ุจูููโุณุงุฒ ฺฉุฏ ููุงุฒ** ููุฏ ุงุณุชุ ุฒุฑุง ุจู ูุฑ thread ุงุฌุงุฒู ูโุฏูุฏ **ูุณุฎูโ ุฎูุฏุด ุงุฒ ฺฉ ุดุก thread-unsafe** ุฑุง ุจุฏูู lock ู ุจุฏูู ูุงุฒ ุจู ุจุงุฒุณุงุฒ ุจู ูุฑุงุฎูุงูโูุง ูุชุฏ ุฏุงุดุชู ุจุงุดุฏ.

---

#### ุฑูุดโูุง ูพุงุฏูโุณุงุฒ Thread-Local Storage

ฑ. **\[ThreadStatic]**

ุณุงุฏูโุชุฑู ุฑูุดุ ุนูุงูุชโฺฏุฐุงุฑ ฺฉ **ููุฏ static** ุจุง **ThreadStatic** ุงุณุช:

```csharp
[ThreadStatic] static int _x;
```

ูุฑ thread ูุณุฎูโ ุฌุฏุงฺฏุงููโุง ุงุฒ `_x` ุฎูุงูุฏ ุฏุฏ.

โ๏ธ ูุญุฏูุฏุชโูุง:

* \[ThreadStatic] ุจุง **ููุฏูุง instance** ฺฉุงุฑ ููโฺฉูุฏ.
* ุจุง **field initializers** ุฎูุจ ฺฉุงุฑ ููโฺฉูุฏุ ุขูโูุง ุชููุง ฺฉ ุจุงุฑ ุฏุฑ threadโุง ฺฉู static constructor ุงุฌุฑุง ูโุดูุฏุ ุงุฌุฑุง ูโุดููุฏ.

ุงฺฏุฑ ูุงุฒ ุฏุงุฑุฏ ุจุง **ููุฏูุง instance** ฺฉุงุฑ ฺฉูุฏ ุง **ููุฏุงุฑ ุบุฑ ูพุดโูุฑุถ** ุฏุงุดุชู ุจุงุดุฏุ **ThreadLocal<T>** ฺฏุฒูู ุจูุชุฑ ุงุณุช.

---

ฒ. **ThreadLocal<T>**

ฺฉูุงุณ **ThreadLocal<T>** ุงูฺฉุงู **ุฐุฎุฑูโุณุงุฒ ูุญู ุจุฑุง thread** ุฑุง ูู ุจุฑุง ููุฏูุง static ู ูู instance ูุฑุงูู ูโฺฉูุฏ ู ุงุฌุงุฒู ูโุฏูุฏ **ููุฏุงุฑ ูพุดโูุฑุถ** ูุดุฎุต ฺฉูุฏ.

ูุซุงู: ุณุงุฎุช ฺฉ **ThreadLocal<int>** ุจุง ููุฏุงุฑ ูพุดโูุฑุถ ณ ุจุฑุง ูุฑ thread:

```csharp
static ThreadLocal<int> _x = new ThreadLocal<int>(() => 3);
```

ุณูพุณ ุงุฒ property **Value** ุจุฑุง ุฏุฑุงูุช ุง ุชูุธู ููุฏุงุฑ ูุญู ูุฑ thread ุงุณุชูุงุฏู ูโฺฉูุฏ.

โ ูฺฉุชู: **ููุฏุงุฑุฏู ุชูุจู** ุงุณุชโdelegate ฺฉุงุฑุฎุงูู ููุท **ุฏุฑ ุงููู ุฏุณุชุฑุณ ูุฑ thread** ุงุฌุฑุง ูโุดูุฏ.

### ThreadLocal<T> ู ููุฏูุง Instance ๐งต

ฺฉูุงุณ **ThreadLocal<T>** ููฺูู ุจุฑุง **ููุฏูุง instance** ู **local variableูุง capture ุดุฏู** ููุฏ ุงุณุช.
ุจุฑุง ูุซุงูุ ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ุฏุฑ ูุญุท **ฺูุฏ threadโุง** ุงุนุฏุงุฏ ุชุตุงุฏู ุชููุฏ ฺฉูู. ฺฉูุงุณ **Random** **thread-safe ูุณุช**ุ ุจูุงุจุฑุงู ุฏู ุฑุงู ุฏุงุฑู:

1. ุงุณุชูุงุฏู ุงุฒ **lock** ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ Random (ฺฉู **Concurrency** ุฑุง ูุญุฏูุฏ ูโฺฉูุฏ).
2. ุชููุฏ ฺฉ **ุดุก Random ุฌุฏุงฺฏุงูู ุจุฑุง ูุฑ thread**.

ุจุง **ThreadLocal<T>**ุ ฺฏุฒูู ุฏูู ุฎู ุขุณุงู ูโุดูุฏ:

```csharp
var localRandom = new ThreadLocal<Random>(() => new Random());
Console.WriteLine(localRandom.Value.Next());
```

๐น ูฺฉุชู: ุชุงุจุน ฺฉุงุฑุฎุงูู ูุง ุจุฑุง ุงุฌุงุฏ ุดุก **Random** ฺฉู ุณุงุฏู ุงุณุชุ ฺูู ุณุงุฒูุฏู ุจุฏูู ูพุงุฑุงูุชุฑ Random ุงุฒ **ุณุงุนุช ุณุณุชู** ุจุฑุง seed ุงุณุชูุงุฏู ูโฺฉูุฏ. ุงู ููฺฉู ุงุณุช ุจุฑุง ุฏู ุดุก Random ฺฉู ุฏุฑ ุญุฏูุฏ **ฑฐ ููโุซุงูู** ุงุฒ ูู ุงุฌุงุฏ ุดุฏูโุงูุฏุ ฺฉุณุงู ุจุงุดุฏ.

ฺฉ ุฑูุด ุจุฑุง ุฑูุน ุงู ูุดฺฉู:

```csharp
var localRandom = new ThreadLocal<Random>
(() => new Random(Guid.NewGuid().GetHashCode()));
```

ุงู ุฑูุด ุฏุฑ **ูุตู ฒฒ** ุฏุฑ ูุซุงู **parallel spellchecking** (ุฏุฑ ุจุฎุด PLINQ ุตูุญู นณต) ุงุณุชูุงุฏู ุดุฏู ุงุณุช.

---

### GetData ู SetData ๐ฆ

ุฑูุด ุณูู ุงุณุชูุงุฏู ุงุฒ ุฏู ูุชุฏ ุฏุฑ ฺฉูุงุณ **Thread** ุงุณุช: **GetData** ู **SetData**.

* ุงู ูุชุฏูุง ุฏุงุฏูโูุง ุฑุง ุฏุฑ **slotูุง ูุฎุตูุต thread** ุฐุฎุฑู ูโฺฉููุฏ.
* **Thread.GetData** ุฏุงุฏู ุฑุง ุงุฒ **ุฐุฎุฑูโุณุงุฒ ุงุฒููู thread** ูโุฎูุงูุฏ.
* **Thread.SetData** ุฏุงุฏู ุฑุง ุฏุฑ ุขู ูโููุณุฏ.
* ูุฑ ุฏู ูุชุฏ ูุงุฒ ุจู ฺฉ **LocalDataStoreSlot** ุจุฑุง ุดูุงุณุง slot ุฏุงุฑูุฏ.

ูโุชูุงูุฏ ุงุฒ ููุงู slot ุจุฑุง ููู threadูุง ุงุณุชูุงุฏู ฺฉูุฏ ู ูุฑ thread ููฺูุงู **ููุฏุงุฑ ุฌุฏุงฺฏุงููโุง** ุฏุฑุงูุช ูโฺฉูุฏ. ูุซุงู:

```csharp
class Test
{
    // ููุงู LocalDataStoreSlot ูโุชูุงูุฏ ุจุฑุง ููู threadูุง ุงุณุชูุงุฏู ุดูุฏ
    LocalDataStoreSlot _secSlot = Thread.GetNamedDataSlot("securityLevel");

    // ุงู property ุจุฑุง ูุฑ thread ููุฏุงุฑ ุฌุฏุงฺฏุงูู ุฏุงุฑุฏ
    int SecurityLevel
    {
        get
        {
            object data = Thread.GetData(_secSlot);
            return data == null ? 0 : (int)data; // null == ููุฏุงุฑุฏู ูุดุฏู
        }
        set { Thread.SetData(_secSlot, value); }
    }
}
```

ุฏุฑ ุงู ูุซุงูุ ุงุฒ **Thread.GetNamedDataSlot** ุงุณุชูุงุฏู ฺฉุฑุฏู ฺฉู ฺฉ **slot ูุงูโฺฏุฐุงุฑโุดุฏู** ุงุฌุงุฏ ูโฺฉูุฏโุงู ุงุฌุงุฒู ูโุฏูุฏ slot ุจู ููู ุจุฎุดโูุง ุจุฑูุงูู ุจู ุงุดุชุฑุงฺฉ ฺฏุฐุงุดุชู ุดูุฏ.
ุจู ุทูุฑ ุฌุงฺฏุฒูุ ูโุชูุงูุฏ ุจุง ฺฉ slot ุจุฏูู ูุงูุ ฺฉู ุจุง **Thread.AllocateDataSlot** ุงุฌุงุฏ ุดุฏู ุงุณุชุ ฺฉูุชุฑู ูุญุฏูุฏู ุขู ุฑุง ุฎูุฏุชุงู ุฏุงุดุชู ุจุงุดุฏ:

```csharp
LocalDataStoreSlot _secSlot = Thread.AllocateDataSlot();
```

โ๏ธ ูฺฉุชู:

* **Thread.FreeNamedDataSlot** ฺฉ slot ูุงูโฺฏุฐุงุฑโุดุฏู ุฑุง ุฏุฑ ููู threadูุง ุขุฒุงุฏ ูโฺฉูุฏุ ุงูุง ููุท ููุช ฺฉู **ุชูุงู ุงุฑุฌุงุนุงุช ุจู ุขู LocalDataStoreSlot ุงุฒ ูุญุฏูุฏู ุฎุงุฑุฌ ุดุฏู ู garbage collected ุดุฏู ุจุงุดูุฏ**.
* ุงู ุชุถูู ูโฺฉูุฏ ฺฉู threadูุง slotูุง ุฏุงุฏู ุฎูุฏ ุฑุง ุงุฒ ุฏุณุช ูุฏููุฏุ ุชุง ุฒูุงู ฺฉู **ุงุฑุฌุงุน ููุงุณุจ ุจู LocalDataStoreSlot** ุฑุง ูฺฏู ุฏุงุดุชู ุจุงุดูุฏ.

---

### AsyncLocal<T> ๐

ุฑูุดโูุง ูพุดู **Thread-local storage** ุจุง **async functions** ุณุงุฒฺฏุงุฑ ูุณุชูุฏุ ฺูู ุจุนุฏ ุงุฒ **await**ุ ุงุฌุฑุง ฺฉุฏ ูโุชูุงูุฏ ุฑู ฺฉ thread ุฏฺฏุฑ ุงุฏุงูู ูพุฏุง ฺฉูุฏ.

ฺฉูุงุณ **AsyncLocal<T>** ุงู ูุดฺฉู ุฑุง ุญู ูโฺฉูุฏ ู ููุฏุงุฑ ุฎูุฏ ุฑุง **ุจุนุฏ ุงุฒ await ุญูุธ ูโฺฉูุฏ**:

```csharp
static AsyncLocal<string> _asyncLocalTest = new AsyncLocal<string>();

async void Main()
{
    _asyncLocalTest.Value = "test";  
    await Task.Delay(1000);  
    // ุญุช ุงฺฏุฑ ุฑู thread ุฏฺฏุฑ ุงุฏุงูู ูพุฏุง ฺฉููุ ุฏุฑุณุช ฺฉุงุฑ ูโฺฉูุฏ:
    Console.WriteLine(_asyncLocalTest.Value);   // test
}
```

**AsyncLocal<T>** ููฺูู ูโุชูุงูุฏ ุนููุงุช ุดุฑูุนโุดุฏู ุฑู **threadูุง ุฌุฏุงฺฏุงูู** ุฑุง ุงุฒ ูู ุฌุฏุง ูฺฏู ุฏุงุฑุฏุ ฺู ุชูุณุท **Thread.Start** ู ฺู **Task.Run**:

```csharp
static AsyncLocal<string> _asyncLocalTest = new AsyncLocal<string>();

void Main()
{
    // Test ุฑุง ุฑู ุฏู thread ููุฒูุงู ุตุฏุง ุจุฒู
    new Thread(() => Test("one")).Start();
    new Thread(() => Test("two")).Start();
}

async void Test(string value)
{
    _asyncLocalTest.Value = value;
    await Task.Delay(1000);
    Console.WriteLine(value + " " + _asyncLocalTest.Value);
}
// ุฎุฑูุฌ: 
// one one
// two two
```

ฺฉ ูฺฉุชู ุฌุงูุจ ุฏุฑุจุงุฑู **AsyncLocal<T>**:

* ุงฺฏุฑ ฺฉ ุดุก AsyncLocal<T> **ูุจูุงู ููุฏุงุฑ ุฏุงุดุชู ุจุงุดุฏ**ุ ููุช ฺฉ thread ุฌุฏุฏ ุดุฑูุน ุดูุฏุ thread ุฌุฏุฏ **ุขู ููุฏุงุฑ ุฑุง ุจู ุงุฑุซ ูโุจุฑุฏ**:

```csharp
static AsyncLocal<string> _asyncLocalTest = new AsyncLocal<string>();

void Main()
{
    _asyncLocalTest.Value = "test";
    new Thread(AnotherMethod).Start();
}

void AnotherMethod() => Console.WriteLine(_asyncLocalTest.Value);  // test
```

* ุจุง ุงู ุญุงูุ thread ุฌุฏุฏ **ฺฉ ฺฉูพ ุงุฒ ููุฏุงุฑ ุฏุฑุงูุช ูโฺฉูุฏ**ุ ุจูุงุจุฑุงู ูุฑ ุชุบุฑ ฺฉู ุฑู ุขู ุงูุฌุงู ุฏูุฏุ ุฑู ููุฏุงุฑ ุงุตู ุชุฃุซุฑ ููโฺฏุฐุงุฑุฏ:

```csharp
static AsyncLocal<string> _asyncLocalTest = new AsyncLocal<string>();

void Main()
{
    _asyncLocalTest.Value = "test";
    var t = new Thread(AnotherMethod);
    t.Start(); t.Join();
    Console.WriteLine(_asyncLocalTest.Value);   // test
}

void AnotherMethod() => _asyncLocalTest.Value = "ha-ha!";
```

โ๏ธ ุชูุฌู: thread ุฌุฏุฏ **ฺฉ ฺฉูพ ุณุทุญ (shallow copy)** ุงุฒ ููุฏุงุฑ ุฏุฑุงูุช ูโฺฉูุฏ.

* ุจูุงุจุฑุงู ุงฺฏุฑ **Async<string>** ุฑุง ุจุง **Async<StringBuilder>** ุง **Async\<List<string>>** ุฌุงฺฏุฒู ฺฉูุฏุ thread ุฌุฏุฏ ูโุชูุงูุฏ **StringBuilder ุฑุง ูพุงฺฉ ฺฉูุฏ ุง ุขุชูโูุง ุฑุง ุจู List ุงุถุงูู/ุญุฐู ฺฉูุฏ** ู ุงู ุฑู ููุฏุงุฑ ุงุตู ุชุฃุซุฑ ุฎูุงูุฏ ฺฏุฐุงุดุช.

### Timers โฑ๏ธ

ุงฺฏุฑ ูุงุฒ ุฏุงุฑุฏ ฺฉ **ูุชุฏ** ุจู ุตูุฑุช **ุฏูุฑูโุง ู ููุธู** ุงุฌุฑุง ุดูุฏุ ุณุงุฏูโุชุฑู ุฑุงู ุงุณุชูุงุฏู ุงุฒ **timer** ุงุณุช.

**Timerูุง** ูู ุฑุงุญุช ู ูู ุจููู ุงุฒ ูุธุฑ ุญุงูุธู ู ููุงุจุน ูุณุชูุฏุ ูุฎุตูุตุงู ุฏุฑ ููุงุณู ุจุง ุชฺฉูฺฉโูุง ุฒุฑ:

```csharp
new Thread(delegate() {
    while (enabled)
    {
        DoSomeAction();
        Thread.Sleep(TimeSpan.FromHours(24));
    }
}).Start();
```

* ุงู ุฑูุด ฺฉ **thread** ุฑุง ุฏุงุฆูุงู ูุดุบูู ูฺฏู ูโุฏุงุฑุฏ.
* ุจุฏูู ฺฉุฏููุณ ุงุถุงููุ ูุชุฏ **DoSomeAction** ูุฑ ุฑูุฒ ุฏุฑ ุฒูุงู ูุชูุงูุช ุงุฌุฑุง ูโุดูุฏ.
* **Timers** ุงู ูุดฺฉูุงุช ุฑุง ุญู ูโฺฉููุฏ.

---

.NET ูพูุฌ ููุน **timer** ุงุฑุงุฆู ูโุฏูุฏ:

#### ฑ. Timerูุง ฺูุฏthreadโุง ุนููู

* **System.Threading.Timer**
* **System.Timers.Timer**

#### ฒ. Timerูุง ุชฺฉโthreadโุง ูฺู

* **System.Windows.Forms.Timer** (ุจุฑุง Windows Forms)

* **System.Windows.Threading.DispatcherTimer** (ุจุฑุง WPF)

* Timerูุง ฺูุฏthreadโุง **ูุฏุฑุชููุฏุชุฑุ ุฏููโุชุฑ ู ุงูุนุทุงูโูพุฐุฑุชุฑ** ูุณุชูุฏ.

* Timerูุง ุชฺฉโthreadโุง ุจุฑุง **ุงุฌุฑุง ุณุงุฏู** ู ุจูโุฑูุฒุฑุณุงู **ฺฉูุชุฑูโูุง Windows Forms ุง ุนูุงุตุฑ WPF** ุงููโุชุฑ ู ุฑุงุญุชโุชุฑูุฏ.

* ุงุฒ **.NET 6**ุ ฺฉ Timer ุฌุฏุฏ ุจู ูุงู **PeriodicTimer** ุงุถุงูู ุดุฏู ฺฉู ุงุจุชุฏุง ุจู ุขู ูโูพุฑุฏุงุฒู.

---

### PeriodicTimer ๐

**PeriodicTimer** ุฏุฑ ูุงูุน ฺฉ timer ุณูุช ูุณุชุ ุจูฺฉู **ฺฉูุงุณ ุจุฑุง ุณุงุฏูโุณุงุฒ ุญูููโูุง asynchronous** ุงุณุช.

ุจุง ุธููุฑ **async ู await**ุ ูุนูููุงู ุจู timerูุง ุณูุช ูุงุฒ ูุณุช. ุจู ุฌุง ุขูุ ุงูฺฏู ุฒุฑ ุฎูุจ ฺฉุงุฑ ูโฺฉูุฏ:

```csharp
StartPeriodicOperation();

async void StartPeriodicOperation()
{
    while (true)
    {
        await Task.Delay(1000);
        Console.WriteLine("Tick");   // ุงูุฌุงู ฺฉ ุนููุงุช
    }
}
```

* ุงฺฏุฑ ุงู ฺฉุฏ ุฑุง ุงุฒ **UI thread** ูุฑุงุฎูุงู ฺฉูุฏุ ูุงููุฏ ฺฉ **timer ุชฺฉโthreadโุง** ุฑูุชุงุฑ ุฎูุงูุฏ ฺฉุฑุฏุ ฺูู **await** ููุดู ุฑู ููุงู **synchronization context** ุจุฑูโฺฏุฑุฏุฏ.
* ุจุฑุง ุฑูุชุงุฑ ุจู ุตูุฑุช **multi-threaded timer** ฺฉุงู ุงุณุช **.ConfigureAwait(false)** ุจู await ุงุถุงูู ฺฉูุฏ.

**PeriodicTimer** ุงู ุงูฺฏู ุฑุง ุณุงุฏู ูโฺฉูุฏ:

```csharp
var timer = new PeriodicTimer(TimeSpan.FromSeconds(1));
StartPeriodicOperation();

// ุงุฎุชุงุฑ: ููุช ูโุฎูุงูุฏ ุญููู ุฑุง ูุชููู ฺฉูุฏุ timer ุฑุง dispose ฺฉูุฏ.
async void StartPeriodicOperation()
{
    while (await timer.WaitForNextTickAsync())
        Console.WriteLine("Tick");    // ุงูุฌุงู ฺฉ ุนููุงุช
}
```

* ููฺูู ูโุชูุงู ุจุง **dispose ฺฉุฑุฏู** ููููู **PeriodicTimer**ุ timer ุฑุง ูุชููู ฺฉุฑุฏ.
* ุฏุฑ ุงู ุตูุฑุช **WaitForNextTickAsync** ููุฏุงุฑ **false** ุจุฑูโฺฏุฑุฏุงูุฏ ู ุญููู ูพุงุงู ูโุงุจุฏ.

### ุชุงูุฑูุง ฺูุฏโูุฎ โฑ๏ธ๐งต

**System.Threading.Timer** ุณุงุฏูโุชุฑู **timer ฺูุฏโูุฎ** ุงุณุช: ููุท ฺฉ **constructor** ู ุฏู **method** ุฏุงุฑุฏ (ุจุฑุง ูููุงูุณุชโูุง ู ููุณูุฏฺฏุงู ฺฉุชุงุจโูุง ูุงูุนุงู ูุฐุชโุจุฎุด!).

ุฏุฑ ูุซุงู ุฒุฑุ ฺฉ **timer** ูุชุฏ **Tick** ุฑุง ุตุฏุง ูโุฒูุฏุ ฺฉู ุจุนุฏ ุงุฒ ต ุซุงูู `"tick..."` ุฑุง ฺุงูพ ูโฺฉูุฏ ู ุณูพุณ ูุฑ ุซุงูู ฺฉโุจุงุฑ ุงู ฺฉุงุฑ ุฑุง ุชฺฉุฑุงุฑ ูโฺฉูุฏุ ุชุง ุฒูุงู ฺฉู ฺฉุงุฑุจุฑ **Enter** ุฑุง ูุดุงุฑ ุฏูุฏ:

```csharp
using System;
using System.Threading;

// ุงููู ูุงุตูู = 5000msุ ููุงุตู ุจุนุฏ = 1000ms
Timer tmr = new Timer(Tick, "tick...", 5000, 1000);

Console.ReadLine();
tmr.Dispose();  // ูู timer ุฑุง ูุชููู ูโฺฉูุฏ ู ูู ููุงุจุน ุฑุง ุขุฒุงุฏ ูโฺฉูุฏ.

void Tick(object data)
{
    // ุงู ุฑู ฺฉ pooled thread ุงุฌุฑุง ูโุดูุฏ
    Console.WriteLine(data);  // ฺุงูพ "tick..."
}
```

* ุจุฑุง ุชุบุฑ ูุงุตููโ ุงุฌุฑุง timer ุจุนุฏ ุงุฒ ุณุงุฎุช ุขูุ ูโุชูุงู ุงุฒ ูุชุฏ **Change** ุงุณุชูุงุฏู ฺฉุฑุฏ.
* ุงฺฏุฑ ุจุฎูุงูุฏ timer ููุท ฺฉโุจุงุฑ ุงุฌุฑุง ุดูุฏุ ุงุฒ **Timeout.Infinite** ุฏุฑ ุขุฑฺฏููุงู ุขุฎุฑ **constructor** ุงุณุชูุงุฏู ฺฉูุฏ.

---

.NET ฺฉ ฺฉูุงุณ **timer** ุฏฺฏุฑ ุจุง ููุงู ูุงู ุฏุฑ ูุถุง ูุงู **System.Timers** ุฏุงุฑุฏ. ุงู ฺฉูุงุณุ **System.Threading.Timer** ุฑุง wrap ูโฺฉูุฏ ู ุงูฺฉุงูุงุช ุฑุงุญุชโุชุฑ ู ุงุถุงู ุงุฑุงุฆู ูโุฏูุฏุ ุฏุฑ ุญุงู ฺฉู ููุชูุฑ ุงุตู ููุงู ุงุณุช. ูฺฺฏโูุง ุงุถุงูู ุดุฏู ุนุจุงุฑุชโุงูุฏ ุงุฒ:

* ูพุงุฏูโุณุงุฒ **IComponent** ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ **Designer** ูฺูุงู ุงุณุชูุฏู
* **Interval** ุจู ุฌุง ูุชุฏ **Change**
* **Elapsed event** ุจู ุฌุง **callback delegate**
* **Enabled property** ุจุฑุง ุดุฑูุน ู ุชููู timer (ููุฏุงุฑ ูพุดโูุฑุถ = false)
* ูุชุฏูุง **Start** ู **Stop**
* **AutoReset flag** ุจุฑุง ูุดุฎุต ฺฉุฑุฏู ุงุฌุฑุง ุฏูุฑูโุง (ููุฏุงุฑ ูพุดโูุฑุถ = true)
* **SynchronizingObject** ุจุง ูุชุฏูุง **Invoke** ู **BeginInvoke** ุจุฑุง ูุฑุงุฎูุงู ุงูู ูุชุฏูุง ุฑู ุนูุงุตุฑ WPF ู ฺฉูุชุฑูโูุง Windows Forms

ูุซุงู ุงุฒ ุขู:

```csharp
using System;
using System.Timers;  // ูุถุง ูุงู Timers

var tmr = new Timer(); // ุจุฏูู ูุงุฒ ุจู ุขุฑฺฏููุงู
tmr.Interval = 500;
tmr.Elapsed += tmr_Elapsed;  // ุงุณุชูุงุฏู ุงุฒ event ุจู ุฌุง delegate
tmr.Start();                 // ุดุฑูุน timer
Console.ReadLine();
tmr.Stop();                  // ุชููู timer
Console.ReadLine();
tmr.Start();                 // ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ timer
Console.ReadLine();
tmr.Dispose();               // ูุชููู ฺฉุฑุฏู ุฏุงุฆู timer

void tmr_Elapsed(object sender, EventArgs e)
    => Console.WriteLine("Tick");
```

* **Timerูุง ฺูุฏโูุฎ** ุงุฒ **thread pool** ุงุณุชูุงุฏู ูโฺฉููุฏ ุชุง ฺูุฏ thread ุจุชูุงููุฏ ุจู ุชุนุฏุงุฏ ุฒุงุฏ timer ุณุฑูุณ ุจุฏููุฏ.

* ุจูุงุจุฑุงูุ callback ุง event handler ููฺฉู ุงุณุช ูุฑ ุจุงุฑ ุฑู **thread ูุชูุงูุช** ุงุฌุฑุง ุดูุฏ.

* ููฺููุ **Elapsed event** ุชูุฑุจุงู ููุดู ุจู ูููุน ุงุฌุฑุง ูโุดูุฏุ ุญุช ุงฺฏุฑ ุงุฌุฑุง ูุจู ูููุฒ ุชูุงู ูุดุฏู ุจุงุดุฏ.

* ูพุณ callbackูุง ู event handlerูุง ุจุงุฏ **thread-safe** ุจุงุดูุฏ.

* ุฏูุช timerูุง ฺูุฏโูุฎ ุจู ุณุณุชูโุนุงูู ูุงุจุณุชู ุงุณุช ู ูุนูููุงู ุญุฏูุฏ **ฑฐ ุชุง ฒฐ ููโุซุงูู** ุงุณุช.

* ุจุฑุง ุฏูุช ุจุงูุงุชุฑุ ูโุชูุงู ุงุฒ **Windows multimedia timer** ุงุณุชูุงุฏู ฺฉุฑุฏ ฺฉู ุฏูุช ุขู ุชุง **ฺฉ ููโุซุงูู** ุงุณุช ู ุฏุฑ **winmm.dll** ุชุนุฑู ุดุฏู.

---

### ุชุงูุฑูุง ุชฺฉโูุฎ ๐งต๐ฅ๏ธ

.NET ุชุงูุฑูุง ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุจุฑุง **ุญุฐู ูุดฺฉูุงุช thread-safety** ุฏุฑ ุจุฑูุงููโูุง **WPF ู Windows Forms** ุทุฑุงุญ ุดุฏูโุงูุฏ:

* **System.Windows.Threading.DispatcherTimer** (WPF)

* **System.Windows.Forms.Timer** (Windows Forms)

* ุงู ุชุงูุฑูุง ุจุฑุง ูุญุทโูุง ูุฑุจูุทู ุทุฑุงุญ ุดุฏูโุงูุฏ ู ุฎุงุฑุฌ ุงุฒ ุขู ูุญุทโูุง ฺฉุงุฑ ููโฺฉููุฏ.

* ุจู ุนููุงู ูุซุงูุ ุงุณุชูุงุฏู ุงุฒ Windows Forms Timer ุฏุฑ ฺฉ **Windows Service** ุจุงุนุซ ูโุดูุฏ event ุชุงูุฑ ุงุฌุฑุง ูุดูุฏ!

* ุงู ุชุงูุฑูุง ูุดุงุจู **System.Timers.Timer** ุนูู ูโฺฉููุฏ ู **Intervalุ Startุ Stop** ู **Tick** ุฏุงุฑูุฏุ ุงูุง ุฏุฑ ุงุฌุฑุง ุฏุงุฎู ูุชูุงูุช ูุณุชูุฏ:

  * ุจู ุฌุง ุงุฌุฑุง event ุฑู **pooled threads**ุ event ุฑุง ุจู **message loop** ูุญุท WPF ุง Windows Forms ุงุฑุณุงู ูโฺฉููุฏ.
  * ุจูุงุจุฑุงู **Tick** ููุดู ุฑู ููุงู thread ฺฉู timer ุณุงุฎุชู ุดุฏูุ ุงุฌุฑุง ูโุดูุฏ.
  * ุงู thread ูุนูููุงู ููุงู thread ูุฏุฑุช ุชูุงู ุนูุงุตุฑ ู ฺฉูุชุฑูโูุง UI ุงุณุช.

ูุฒุงุง ุงู ุฑูุด:

* ุฏฺฏุฑ ูุงุฒ ุจู ูฺฏุฑุงู ุฏุฑุจุงุฑู **thread safety** ูุณุช.

* ุงุฌุฑุง ุจุนุฏ Tick ุชุง ุฒูุงู ฺฉู Tick ูุจู ุชูุงู ูุดุฏู ุจุงุดุฏุ ุดุฑูุน ููโุดูุฏ.

* ูโุชูุงู ุนูุงุตุฑ ู ฺฉูุชุฑูโูุง UI ุฑุง ูุณุชููุงู ุงุฒ Tick ุจูโุฑูุฒุฑุณุงู ฺฉุฑุฏุ ุจุฏูู ูุงุฒ ุจู **Control.BeginInvoke** ุง **Dispatcher.BeginInvoke**.

* ุจุฑูุงููโูุง ฺฉู ุงุฒ ุงู ุชุงูุฑูุง ุงุณุชูุงุฏู ูโฺฉููุฏุ ูุงูุนุงู **multithreaded** ูุณุชูุฏุ ููุน **pseudo-concurrency** ุดุจู ูุตู ฑด ุจุง asynchronous functions ุฑู UI thread ุฏุงุฑูุฏ.

* ุงู ุชุงูุฑูุง ุจุฑุง **ฺฉุงุฑูุง ฺฉูฺฺฉ** ู ูุนูููุงู ุจูโุฑูุฒุฑุณุงู UI ููุงุณุจโุงูุฏ (ูุซูุงู ููุงุด ุณุงุนุช ุง countdown).

* ุงุฒ ูุธุฑ ุฏูุชุ ุชุงูุฑูุง ุชฺฉโูุฎ ูุดุงุจู ุชุงูุฑูุง ฺูุฏโูุฎ ูุณุชูุฏ (ุฏูโูุง ููโุซุงูู)ุ ุงูุง ูุนูููุงู ฺฉู ฺฉูุชุฑ ุฏููโุงูุฏ ฺูู ููฺฉู ุงุณุช ููฺฏุงู ูพุฑุฏุงุฒุด ุฏุฑุฎูุงุณุชโูุง ุฏฺฏุฑ UI ุง eventูุง ุชุงูุฑ ุชุฃุฎุฑ ุงุฌุงุฏ ุดูุฏ.
