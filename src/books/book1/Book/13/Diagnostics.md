# ูุตู ุณุฒุฏูู: ุชุดุฎุต (Diagnostics)

ููุช ฺุฒ ุงุดุชุจุงู ูพุด ูโุฑูุฏุ ุฎู ููู ุงุณุช ฺฉู ุงุทูุงุนุงุช ูุงุฒู ุจุฑุง ฺฉูฺฉ ุจู **ุชุดุฎุต (diagnosing) ูุดฺฉู** ุฏุฑ ุฏุณุชุฑุณ ุจุงุดุฏ. ฺฉ **ูุญุท ุชูุณุนู ฺฉูพุงุฑฺู (Integrated Development Environment โ IDE)** ุง ฺฉ **ุฏุจุงฺฏุฑ (debugger)** ูโุชูุงูุฏ ุฏุฑ ุงู ุฒููู ุจุณุงุฑ ฺฉูฺฉโฺฉููุฏู ุจุงุดุฏโุงูุง ูุนูููุงู ููุท ุฏุฑ ุทูู ุชูุณุนู ููุฌูุฏ ุงุณุช.
ูพุณ ุงุฒ ุงูุชุดุงุฑ (ship) ฺฉ ุจุฑูุงููุ ุฎูุฏู ุจุฑูุงูู ุจุงุฏ ุงุทูุงุนุงุช ุชุดุฎุต ุฑุง ุฌูุนโุขูุฑ ู ุซุจุช ฺฉูุฏ. ุจุฑุง ุจุฑุขูุฑุฏู ฺฉุฑุฏู ุงู ูุงุฒุ **.NET** ูุฌููุนูโุง ุงุฒ ุงูฺฉุงูุงุช ุฑุง ูุฑุงูู ูโฺฉูุฏ ุชุง ุจุชูุงู ุงุทูุงุนุงุช ุชุดุฎุต ุฑุง ูุงฺฏโฺฏุฑ ฺฉุฑุฏุ ุฑูุชุงุฑ ุจุฑูุงูู ุฑุง ูุงูุชูุฑ ฺฉุฑุฏุ ุฎุทุงูุง ุฒูุงู ุงุฌุฑุง ุฑุง ุดูุงุณุง ฺฉุฑุฏ ู ุฏุฑ ุตูุฑุช ููุฌูุฏ ุจูุฏูุ ุจุง ุงุจุฒุงุฑูุง ุฏุจุงฺฏ ฺฉูพุงุฑฺู ุดุฏ.

ุจุฑุฎ ุงุจุฒุงุฑูุง ู APIูุง ุชุดุฎุตุ ูุฎุตูุต **Windows** ูุณุชูุฏ ุฒุฑุง ุจู ูุงุจูุชโูุง ุณุณุชูโุนุงูู ููุฏูุฒ ูุงุจุณุชูโุงูุฏ. ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุดููุบ ุดุฏู **BCL (.NET Base Class Library)** ุจุง APIูุง ูุฎุชุต ูพูุชูุฑูุ ูุงฺฉุฑูุณุงูุช ุขูโูุง ุฑุง ุฏุฑ ูพฺฉุฌโูุง ุฌุฏุงฺฏุงููโ **NuGet** ุนุฑุถู ฺฉุฑุฏู ุงุณุช ฺฉู ูโุชูุงูุฏ ุจู ุตูุฑุช ุงุฎุชุงุฑ ุจู ุขูโูุง ุงุฑุฌุงุน ุฏูุฏ. ุจุด ุงุฒ ุฏูุงุฒุฏู ูพฺฉุฌ ูุฎุตูุต ููุฏูุฒ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ูโุชูุงูุฏ ูููโ ุขูโูุง ุฑุง ฺฉุฌุง ุจุง ูพฺฉุฌ ุงุตู **Microsoft.Windows.Compatibility** ุงุณุชูุงุฏู ฺฉูุฏ.

ุงููุงุน (types) ูุนุฑูโุดุฏู ุฏุฑ ุงู ูุตูุ ุนูุฏุชุงู ุฏุฑ **namespace ุจู ูุงู System.Diagnostics** ุชุนุฑู ุดุฏูโุงูุฏ.

---

### โ๏ธ ฺฉุงููพุงู ุดุฑุท (Conditional Compilation)

ุดูุง ูโุชูุงูุฏ ูุฑ ุจุฎุด ุงุฒ ฺฉุฏ ุฏุฑ C# ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ **ุฏุณุชูุฑุงุช ูพุดโูพุฑุฏุงุฒูุฏู (preprocessor directives)** ุจู ุตูุฑุช ุดุฑุท ฺฉุงููพุงู ฺฉูุฏ.
ุงู ุฏุณุชูุฑุงุชุ ุฏุณุชูุฑุงูุนููโูุง ุฎุงุต ุจุฑุง ฺฉุงููพุงูุฑ ูุณุชูุฏ ฺฉู ุจุง ููุงุฏ `#` ุดุฑูุน ูโุดููุฏ (ู ุจุฑุฎูุงู ุณุงุฑ ุณุงุฎุชุงุฑูุง C#ุ ุจุงุฏ ุฏุฑ ฺฉ ุฎุท ุฌุฏุงฺฏุงูู ูุฑุงุฑ ฺฏุฑูุฏ). ุงุฒ ูุธุฑ ููุทูุ ุงู ุฏุณุชูุฑุงุช ูุจู ุงุฒ ุงูุฌุงู ฺฉุงููพุงู ุงุตู ุงุฌุฑุง ูโุดููุฏ (ูุฑฺูุฏ ุฏุฑ ุนููุ ฺฉุงููพุงูุฑ ุขูโูุง ุฑุง ุฏุฑ ูุฑุญููโ **lexical parsing** ูพุฑุฏุงุฒุด ูโฺฉูุฏ).

ุฏุณุชูุฑุงุช ูพุดโูพุฑุฏุงุฒูุฏู ุจุฑุง ฺฉุงููพุงู ุดุฑุท ุนุจุงุฑุชโุงูุฏ ุงุฒ:

* `#if`
* `#else`
* `#endif`
* `#elif`

โ ุฏุณุชูุฑ `#if` ุจู ฺฉุงููพุงูุฑ ูโฺฏูุฏ ุจุฎุด ุงุฒ ฺฉุฏ ุฑุง ูุงุฏุฏู ุจฺฏุฑุฏ ูฺฏุฑ ุงูโฺฉู ฺฉ **symbol** ูุดุฎุต ุชุนุฑู ุดุฏู ุจุงุดุฏ.
ูโุชูุงูุฏ ฺฉ symbol ุฑุง ุจู ุฏู ุฑูุด ุชุนุฑู ฺฉูุฏ:

1. ุฏุฑ ุณูุฑุณโฺฉุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏุณุชูุฑ `#define` (ฺฉู ููุท ุจู ููุงู ูุงู ุงุนูุงู ูโุดูุฏ).
2. ุฏุฑ ูุงู **.csproj** ุจุง ุงุณุชูุงุฏู ุงุฒ ุนูุตุฑ `<DefineConstants>` (ฺฉู ุฏุฑ ุงู ุตูุฑุชุ ุจู ฺฉู assembly ุงุนูุงู ูโุดูุฏ).

ูุซุงู:

```csharp
#define TESTMODE
// #define ุจุงุฏ ุฏุฑ ุจุงูุง ูุงู ููุดุชู ุดูุฏ
// ุทุจู ูุฑุงุฑุฏุงุฏุ ูุงู symbol ูุง ุจุง ุญุฑูู ุจุฒุฑฺฏ ููุดุชู ูโุดููุฏ.
using System;
class Program
{
    static void Main()
    {
        #if TESTMODE
        Console.WriteLine("in test mode!");   // OUTPUT: in test mode!
        #endif
    }
}
```

ุงฺฏุฑ ุฎุท ุงูู (ุนู `#define TESTMODE`) ุฑุง ุญุฐู ฺฉููุ ุจุฑูุงูู ุจุฏูู ุฎุท `Console.WriteLine` ฺฉุงููพุงู ุฎูุงูุฏ ุดุฏโุงูฺฏุงุฑ ฺฉู ฺฉูุงู ฺฉุงููุช ุดุฏู ุจุงุดุฏ.

๐ ุฏุณุชูุฑ `#else` ูุดุงุจู ุฏุณุชูุฑ `else` ุฏุฑ C# ุงุณุช ู `#elif` ูู ูุนุงุฏู `#else` ุจู ููุฑุงู ฺฉ `#if` ุงุณุช.
ุนููฺฏุฑูุง `||`, `&&`, ู `!` ูุฒ ุจู ุชุฑุชุจ **or**ุ **and** ู **not** ุนูู ูโฺฉููุฏ:

```csharp
#if TESTMODE && !PLAYMODE      // ุงฺฏุฑ TESTMODE ูุนุงู ุจุงุดุฏ ู PLAYMODE ูุนุงู ูุจุงุดุฏ
   ...
#endif
```

ุงูุง ุงุฏุชุงู ุจุงุดุฏ: ุงู ฺฉ ุนุจุงุฑุช ูุนููู C# ูุณุช ู symbolูุง ฺฉู ุฑู ุขูโูุง ุนูู ูโฺฉูุฏ ูฺ ุงุฑุชุจุงุท ุจู ูุชุบุฑูุงโฺู ุงุณุชุงุชฺฉ ู ฺู ุบุฑ ุงุฒ ุขูโูุฏุงุฑูุฏ.

---

### ๐๏ธ ุชุนุฑู symbolูุง ุฏุฑ ุณุทุญ assembly

ูโุชูุงูุฏ symbolูุง ุฑุง ฺฉู ุฏุฑ ุชูุงู ูุงูโูุง ฺฉ assembly ุงุนูุงู ูโุดููุฏุ ุฏุฑ ูุงู `.csproj` ุชุนุฑู ฺฉูุฏ (ุง ุฏุฑ Visual Studioุ ุงุฒ ุทุฑู ุชุจ **Build** ุฏุฑ ูพูุฌุฑูโ **Project Properties**).

ูุซุงู:

```xml
<PropertyGroup>
   <DefineConstants>TESTMODE;PLAYMODE</DefineConstants>
</PropertyGroup>
```

ุงฺฏุฑ ฺฉ symbol ุฑุง ุฏุฑ ุณุทุญ assembly ุชุนุฑู ฺฉุฑุฏู ุจุงุดุฏ ู ุจุฎูุงูุฏ ุขู ุฑุง ุจุฑุง ฺฉ ูุงู ุฎุงุต **ูุบู (undefine)** ฺฉูุฏุ ูโุชูุงูุฏ ุงุฒ ุฏุณุชูุฑ `#undef` ุงุณุชูุงุฏู ฺฉูุฏ.

---

### โ๏ธ ฺฉุงููพุงู ุดุฑุท ุฏุฑ ุจุฑุงุจุฑ ูพุฑฺูโูุง ูุชุบุฑ ุงุณุชุงุชฺฉ

ุดูุง ูโุชูุงูุฏ ููุงู ูุซุงู ูุจู ุฑุง ุจุง ฺฉ ููุฏ ุงุณุชุงุชฺฉ ุณุงุฏู ูู ูพุงุฏูโุณุงุฒ ฺฉูุฏ:

```csharp
static internal bool TestMode = true;
static void Main()
{
    if (TestMode) Console.WriteLine("in test mode!");
}
```

ุงู ุฑูุด ูุฒุช **ูพฺฉุฑุจูุฏ ุฏุฑ ุฒูุงู ุงุฌุฑุง (runtime configuration)** ุฑุง ุฏุงุฑุฏ.
ูพุณ ฺุฑุง ุจุงุฏ ฺฉุงููพุงู ุดุฑุท ุฑุง ุงูุชุฎุงุจ ฺฉููุ

ุฏูู ุงู ุงุณุช ฺฉู **ฺฉุงููพุงู ุดุฑุท ูโุชูุงูุฏ ฺฉุงุฑูุง ุงูุฌุงู ุฏูุฏ ฺฉู ูพุฑฺูโูุง ูุชุบุฑ ููโุชูุงููุฏ**ุ ูุซู:

* ุฏุฑุฌ ุดุฑุท ฺฉ **attribute**
* ุชุบุฑ ููุน ุงุนูุงูโุดุฏูโ ฺฉ ูุชุบุฑ
* ุชุบุฑ ุจู namespaceูุง ุง type aliasูุง ุฏุฑ ฺฉ ุฏุณุชูุฑ `using`

ูุซุงู:

```csharp
using TestType =
#if V2
    MyCompany.Widgets.GadgetV2;
#else
    MyCompany.Widgets.Gadget;
#endif
```

ุดูุง ุญุช ูโุชูุงูุฏ **ุฑูฺฉุชูุฑูฺฏโูุง ุจุฒุฑฺฏ** ุฑุง ุฒุฑ ฺฉ ุฏุณุชูุฑ ฺฉุงููพุงู ุดุฑุท ูุฑุงุฑ ุฏูุฏุ ุทูุฑ ฺฉู ุจุชูุงูุฏ ุจูุงูุงุตูู ุจู ูุณุฎูโ ูุฏู ู ุฌุฏุฏ ุฌุงุจูโุฌุง ุดูุฏ. ููฺูู ูโุชูุงูุฏ ฺฉุชุงุจุฎุงููโูุง ุจููุณุฏ ฺฉู ุฏุฑ ุจุฑุงุจุฑ ฺูุฏ ูุณุฎูโ ูุฎุชูู runtime ฺฉุงููพุงู ุดููุฏ ู ูุฑ ุฌุง ฺฉู ุงูฺฉุงู ุฏุงุฑุฏุ ุงุฒ ูุงุจูุชโูุง ุฌุฏุฏ ุจูุฑู ุจุจุฑูุฏ.

ฺฉ ุฏฺฏุฑ ุงุฒ ูุฒุงุง ฺฉุงููพุงู ุดุฑุท ุงู ุงุณุช ฺฉู **ฺฉุฏูุง ุฏุจุงฺฏ ูโุชูุงููุฏ ุจู ุงููุงุน (types) ุฏุฑ assemblyูุง ุงุดุงุฑู ฺฉููุฏ ฺฉู ุฏุฑ ูุณุฎูโ ููุง (deployment) ฺฏูุฌุงูุฏู ููโุดููุฏ.** ๐

### ๐ ูฺฺฏ **Conditional Attribute**

ูฺฺฏ **Conditional** ุจู ฺฉุงููพุงูุฑ ุฏุณุชูุฑ ูโุฏูุฏ ฺฉู ุงฺฏุฑ ฺฉ **symbol** ูุดุฎุต ุชุนุฑู ูุดุฏู ุจุงุดุฏุ ูุฑ ูุฑุงุฎูุงู (call) ุจู ฺฉ ฺฉูุงุณ ุง ูุชุฏ ุฎุงุต ุฑุง ูุงุฏุฏู ุจฺฏุฑุฏ.

ุจุฑุง ุฏุฏู ฺฉุงุฑุจุฑุฏ ุงู ูฺฺฏุ ูุฑุถ ฺฉูุฏ ูุชุฏ ุจุฑุง ุซุจุช ูุถุนุช (logging status) ููุดุชูโุงุฏ:

```csharp
static void LogStatus (string msg)
{
    string logFilePath = ...
    System.IO.File.AppendAllText (logFilePath, msg + "\r\n");
}
```

ุญุงูุง ุชุตูุฑ ฺฉูุฏ ูโุฎูุงูุฏ ุงู ูุชุฏ ููุท ุฒูุงู ุงุฌุฑุง ุดูุฏ ฺฉู symbol ุจู ูุงู **LOGGINGMODE** ุชุนุฑู ุดุฏู ุจุงุดุฏ.

ุฑุงูโุญู ุงูู ุงู ุงุณุช ฺฉู ูููโ ูุฑุงุฎูุงูโูุง `LogStatus` ุฑุง ุฏุงุฎู ฺฉ ุฏุณุชูุฑ `#if` ูุฑุงุฑ ุฏูุฏ:

```csharp
#if LOGGINGMODE
LogStatus("Message Headers: " + GetMsgHeaders());
#endif
```

ุงู ฺฉุงุฑ ูุชุฌูโ ุงุฏูโุขู ูโุฏูุฏุ ุงูุง ุฎุณุชูโฺฉููุฏู ู ููุชโฺฏุฑ ุงุณุช.
ุฑุงูโุญู ุฏูู ุงู ุงุณุช ฺฉู ุฏุณุชูุฑ `#if` ุฑุง ุฏุงุฎู ุฎูุฏ ูุชุฏ `LogStatus` ูุฑุงุฑ ุฏูู. ุงูุง ุงู ูุดฺฉู ุฏุงุฑุฏุ ฺุฑุง ฺฉู ุงฺฏุฑ ุงูโุทูุฑ ูุฑุงุฎูุงู ุดูุฏ:

```csharp
LogStatus("Message Headers: " + GetComplexMessageHeaders());
```

ุฏุฑ ุงู ุญุงูุชุ ูุชุฏ `GetComplexMessageHeaders` ููุดู ูุฑุงุฎูุงู ุฎูุงูุฏ ุดุฏโฺฉู ููฺฉู ุงุณุช ุจุงุนุซ ุงูุช ฺฉุงุฑุง (performance hit) ุดูุฏ.

---

### ๐ ุชุฑฺฉุจ ุฏู ุฑุงูโุญู ุจุง **Conditional Attribute**

ูโุชูุงูู ุนููฺฉุฑุฏ ุฑุงูโุญู ุงูู (ูุชุฌูโ ูุทููุจ) ู ุฑุงุญุช ุฑุงูโุญู ุฏูู ุฑุง ุจุง ุงูุฒูุฏู ูฺฺฏ **Conditional** (ฺฉู ุฏุฑ `System.Diagnostics` ุชุนุฑู ุดุฏู) ุจู ูุชุฏ `LogStatus` ุจู ุฏุณุช ุจุงูุฑู:

```csharp
[Conditional("LOGGINGMODE")]
static void LogStatus (string msg)
{
    ...
}
```

ุงู ฺฉุงุฑ ุจู ฺฉุงููพุงูุฑ ุฏุณุชูุฑ ูโุฏูุฏ ฺฉู ุชูุงู ูุฑุงุฎูุงูโูุง `LogStatus` ุฑุง ุทูุฑ ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ ฺฉู ฺฏู ุฏุงุฎู ฺฉ ุฏุณุชูุฑ `#if LOGGINGMODE` ูุฑุงุฑ ุฏุงุฑูุฏ.
ุงฺฏุฑ symbol ุชุนุฑู ูุดุฏู ุจุงุดุฏุ **ูุฑฺฏููู ูุฑุงุฎูุงู ุจู `LogStatus` ฺฉูุงู ุงุฒ ุฎุฑูุฌ ููุง ฺฉุงููพุงู ุญุฐู ุฎูุงูุฏ ุดุฏ**โุงุฒ ุฌููู **evaluation** ุขุฑฺฏููุงูโูุง.
ุจูุงุจุฑุงู ูุฑ ุนุจุงุฑุช ฺฉู ุงุซุฑ ุฌุงูุจ (side effect) ุฏุงุดุชู ุจุงุดุฏ ูุฒ ฺฉูุงู ุงุฌุฑุง ููโุดูุฏ. โจ

ุงู ูฺฺฏ ุญุช ุฒูุงู ฺฉู `LogStatus` ู ูุชุฏ ูุฑุงุฎูุงููุฏู ุฏุฑ ุฏู assembly ูุชูุงูุช ุจุงุดูุฏ ูุฒ ุจู ุฏุฑุณุช ฺฉุงุฑ ูโฺฉูุฏ.

---

### ๐ฆ ฺฉ ูุฒุช ุฏฺฏุฑ

ูุฒุช ุฏฺฏุฑ `[Conditional]` ุงู ุงุณุช ฺฉู ุจุฑุฑุณ ุดุฑุท ุฏุฑ ุฒูุงู **ฺฉุงููพุงู ฺฉุฏ ูุฑุงุฎูุงููุฏู** ุงูุฌุงู ูโุดูุฏุ ูู ุฏุฑ ุฒูุงู ฺฉุงููพุงู ูุชุฏ ููุตุฏ. ุงู ุนู ุดูุง ูโุชูุงูุฏ ฺฉุชุงุจุฎุงููโุง ุญุงู ูุชุฏูุง ูุซู `LogStatus` ุจููุณุฏ ู ููุท **ฺฉ ูุณุฎู ุงุฒ ุขู ฺฉุชุงุจุฎุงูู** ุฑุง ุจุณุงุฒุฏ.

๐ ูฺฺฏ `Conditional` ุฏุฑ ุฒูุงู ุงุฌุฑุง ูฺ ุชุฃุซุฑ ูุฏุงุฑุฏโุงู ููุท ฺฉ ุฏุณุชูุฑุงูุนูู ุจุฑุง ฺฉุงููพุงูุฑ ุงุณุช.

---

### ๐ ุฌุงฺฏุฒูโูุง **Conditional Attribute**

ูฺฺฏ `Conditional` ุฒูุงู ุจโูุงุฏู ุงุณุช ฺฉู ุจุฎูุงูุฏ ุนููฺฉุฑุฏ ุฑุง ุจูโุทูุฑ **ูพูุง (runtime)** ูุนุงู ุง ุบุฑูุนุงู ฺฉูุฏ.
ุฏุฑ ุงู ุญุงูุช ุจุงุฏ ุงุฒ ฺฉ ุฑุงูโุญู ูุจุชู ุจุฑ **ูุชุบุฑ (variable-based)** ุงุณุชูุงุฏู ฺฉูุฏ.

ุณุคุงู ุจุนุฏ ุงู ุงุณุช ฺฉู ฺุทูุฑ ูโุชูุงูู ุงุฒ ุงุฌุฑุง ุขุฑฺฏููุงูโูุง ุฏุฑ ููฺฏุงู ูุฑุงุฎูุงู ูุชุฏูุง ูุงฺฏโฺฏุฑ ุดุฑุท ุฌููฺฏุฑ ฺฉููุ
ุฑุงูโุญู ุชุงุจุน (functional approach) ุงู ูุดฺฉู ุฑุง ุจุฑุทุฑู ูโฺฉูุฏ:

```csharp
using System;
using System.Linq;
class Program
{
    public static bool EnableLogging;
    static void LogStatus (Func<string> message)
    {
        string logFilePath = ...
        if (EnableLogging)
            System.IO.File.AppendAllText (logFilePath, message() + "\r\n");
    }
}
```

ุจุง ุงุณุชูุงุฏู ุงุฒ **lambda expression**ุ ูโุชูุงูู ุงู ูุชุฏ ุฑุง ุจุฏูู ุดููุบ ุงุถุงู ุณูุชฺฉุณ ูุฑุงุฎูุงู ฺฉูู:

```csharp
LogStatus(() => "Message Headers: " + GetComplexMessageHeaders());
```

ุงฺฏุฑ ููุฏุงุฑ `EnableLogging` ุจุฑุงุจุฑ `false` ุจุงุดุฏุ ูุชุฏ `GetComplexMessageHeaders` ูฺโููุช ุงุฌุฑุง ูุฎูุงูุฏ ุดุฏ. ๐

---

### ๐ ฺฉูุงุณโูุง **Debug** ู **Trace**

ฺฉูุงุณโูุง ุงุณุชุงุชฺฉ **Debug** ู **Trace** ูุงุจูุชโูุง ูพุงูโุง ุจุฑุง **logging** ู **assertion** ูุฑุงูู ูโฺฉููุฏ.
ุงู ุฏู ฺฉูุงุณ ุจุณุงุฑ ุดุจู ฺฉุฏฺฏุฑ ูุณุชูุฏุ ุชูุงูุช ุงุตู ุฏุฑ **ูุฏู ุงุณุชูุงุฏู** ุงุณุช:

* ฺฉูุงุณ **Debug** ุจุฑุง **buildูุง ุฏุจุงฺฏ** ุฏุฑ ูุธุฑ ฺฏุฑูุชู ุดุฏู ุงุณุช.
* ฺฉูุงุณ **Trace** ุจุฑุง ูุฑ ุฏู ุญุงูุช **ุฏุจุงฺฏ** ู **release** ุทุฑุงุญ ุดุฏู ุงุณุช.

ุจุฑุง ููู:

* ุชูุงู ูุชุฏูุง ฺฉูุงุณ `Debug` ุจุง `[Conditional("DEBUG")]` ุชุนุฑู ุดุฏูโุงูุฏ.
* ุชูุงู ูุชุฏูุง ฺฉูุงุณ `Trace` ุจุง `[Conditional("TRACE")]` ุชุนุฑู ุดุฏูโุงูุฏ.

ุนู: ุชูุงู ูุฑุงุฎูุงูโูุง ฺฉู ุจู `Debug` ุง `Trace` ุงูุฌุงู ูโุฏูุฏุ ุชูุณุท ฺฉุงููพุงูุฑ ุญุฐู ูโุดููุฏ ูฺฏุฑ ุงูโฺฉู symbolูุง `DEBUG` ุง `TRACE` ุชุนุฑู ุดุฏู ุจุงุดูุฏ.
(ุฏุฑ **Visual Studio** ูโุชูุงูุฏ ุงู symbolูุง ุฑุง ุงุฒ ุทุฑู ุชุจ **Build** ุฏุฑ ูพูุฌุฑูโ **Project Properties** ูุนุงู ฺฉูุฏ. ุฏุฑ ูพุฑูฺูโูุง ุฌุฏุฏุ symbol `TRACE` ุจูโุทูุฑ ูพุดโูุฑุถ ูุนุงู ุงุณุช.)

---

### ๐ ูุชุฏูุง ููู Debug ู Trace

ูุฑ ุฏู ฺฉูุงุณ **Debug** ู **Trace** ูุชุฏูุง ุฒุฑ ุฑุง ุงุฑุงุฆู ูโุฏููุฏ:

* `Write`
* `WriteLine`
* `WriteIf`

ุงู ูุชุฏูุง ุจู ุทูุฑ ูพุดโูุฑุถ ูพุงูโูุง ุฑุง ุจู ูพูุฌุฑูโ **ุฎุฑูุฌ ุฏุจุงฺฏุฑ (debuggerโs output window)** ุงุฑุณุงู ูโฺฉููุฏ:

```csharp
Debug.Write("Data");
Debug.WriteLine(23 * 34);
int x = 5, y = 3;
Debug.WriteIf(x > y, "x is greater than y");
```

ฺฉูุงุณ **Trace** ุนูุงูู ุจุฑ ุงูโูุงุ ูุชุฏูุง ุฒุฑ ุฑุง ูู ุฏุงุฑุฏ:

* `TraceInformation`
* `TraceWarning`
* `TraceError`

ุชูุงูุช ุฑูุชุงุฑ ุงู ูุชุฏูุง ุจุง ูุชุฏูุง `Write` ุจุณุชฺฏ ุจู **TraceListeners ูุนุงู** ุฏุงุฑุฏ (ฺฉู ุฏุฑ ุจุฎุด ยซTraceListenerยป ุฏุฑ ุตูุญูโ ถฑฒ ุชูุถุญ ุฏุงุฏู ุดุฏู ุงุณุช).

### ๐ Fail ู Assert

ฺฉูุงุณโูุง **Debug** ู **Trace** ูุฑ ุฏู ูุชุฏูุง **Fail** ู **Assert** ุฑุง ูุฑุงูู ูโฺฉููุฏ.

* ูุชุฏ **Fail** ูพุงู ุฑุง ุจู ูุฑ **TraceListener** ููุฌูุฏ ุฏุฑ ูุฌููุนูโ **Listeners** ฺฉูุงุณ Debug ุง Trace ุงุฑุณุงู ูโฺฉูุฏ (ุจุฎุด ุจุนุฏ ุฑุง ุจุจูุฏ). ุงู ูุชุฏ ุจูโุทูุฑ ูพุดโูุฑุถ ูพุงู ุฑุง ุฏุฑ ุฎุฑูุฌ ุฏุจุงฺฏุฑ ูโููุณุฏ:

```csharp
Debug.Fail("File data.txt does not exist!");
```

* ูุชุฏ **Assert** ุฏุฑ ุตูุฑุช ฺฉู ุขุฑฺฏููุงู ุจูู ุขู `false` ุจุงุดุฏุ ูุชุฏ Fail ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ. ุงู ุนูู ุฑุง **assertion** ูโูุงููุฏ ู ุงฺฏุฑ ููุถ ุดูุฏุ ูุดุงูโุฏููุฏูโ ูุฌูุฏ **ุจุงฺฏ** ุฏุฑ ฺฉุฏ ุงุณุช. ูุดุฎุต ฺฉุฑุฏู ูพุงู ุฎุทุง ุงุฎุชุงุฑ ุงุณุช:

```csharp
Debug.Assert(File.Exists("data.txt"), "File data.txt does not exist!");
var result = ...
Debug.Assert(result != null);
```

ูุชุฏูุง **Write**ุ **Fail** ู **Assert** ููฺฏ overloadูุง ุฏุงุฑูุฏ ฺฉู ุนูุงูู ุจุฑ ูพุงูุ ฺฉ **category string** ูู ูโูพุฐุฑูุฏโฺุฒ ฺฉู ูโุชูุงูุฏ ุฏุฑ ูพุฑุฏุงุฒุด ุฎุฑูุฌ ููุฏ ุจุงุดุฏ.

---

### โ๏ธ ุฌุงฺฏุฒู assertion ุจุง Exception

ฺฉ ุฌุงฺฏุฒู ุจุฑุง assertion ุงู ุงุณุช ฺฉู ููุช ุดุฑุท ุจุฑุนฺฉุณ ุจุฑูุฑุงุฑ ุจูุฏุ ฺฉ **exception** ูพุฑุชุงุจ ฺฉูุฏ.
ุงู ุฑูุด ุฏุฑ ููฺฏุงู ุงุนุชุจุงุฑุณูุฌ ุขุฑฺฏููุงูโูุง ูุชุฏ ุจุณุงุฑ ุฑุงุฌ ุงุณุช:

```csharp
public void ShowMessage(string message)
{
    if (message == null) throw new ArgumentNullException("message");
    ...
}
```

ุงูุง ุชูุงูุชโูุง:

* ุงู ููุน ยซassertionยป ุจุฏูู ูุฏ ู ุดุฑุท ฺฉุงููพุงู ูโุดูุฏ ู ุงูุนุทุงูโูพุฐุฑ ฺฉูุชุฑ ุฏุงุฑุฏ (ฺูู ูุชุฌูโ ุดฺฉุณุช assertion ุฑุง ููโุชูุงูุฏ ุจุง **TraceListeners** ฺฉูุชุฑู ฺฉูุฏ).
* ุงุฒ ูุธุฑ ููุ ุงู ุงุตูุงู assertion ูุณุช.
* **Assertion** ูุดุงูโุฏููุฏูโ ุจุงฺฏ ุฏุฑ **ฺฉุฏ ูุชุฏ ุฌุงุฑ** ุงุณุช ุงฺฏุฑ ููุถ ุดูุฏ.
* **Exception** ุฏุฑ ููฺฏุงู ุงุนุชุจุงุฑุณูุฌ ุขุฑฺฏููุงูุ ูุดุงูโุฏููุฏูโ ุจุงฺฏ ุฏุฑ **ฺฉุฏ ูุฑุงุฎูุงููุฏู** ุงุณุช.

---

### ๐ก TraceListener

ฺฉูุงุณ **Trace** ฺฉ ูฺฺฏ ุงุณุชุงุชฺฉ ุจู ูุงู **Listeners** ุฏุงุฑุฏ ฺฉู ูุฌููุนูโุง ุงุฒ ูููููโูุง **TraceListener** ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ. ุงู listenerูุง ูุณุฆูู ูพุฑุฏุงุฒุด ูุญุชูุง ุฎุฑูุฌ ูุชุฏูุง **Write**ุ **Fail** ู **Trace** ูุณุชูุฏ.

ุจู ุทูุฑ ูพุดโูุฑุถุ ูุฌููุนูโ **Listeners** ุดุงูู ฺฉ listener ูุงุญุฏ ุงุณุช: **DefaultTraceListener**.

ุงู listener ูพุดโูุฑุถ ุฏู ูฺฺฏ ููู ุฏุงุฑุฏ:

1. ููุช ุจู ุฏุจุงฺฏุฑ ูุซู Visual Studio ูุชุตู ุจุงุดุฏุ ูพุงูโูุง ุจู **ุฎุฑูุฌ ุฏุจุงฺฏุฑ** ููุดุชู ูโุดููุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ูพุงูโูุง ูุงุฏุฏู ฺฏุฑูุชู ูโุดููุฏ.
2. ููุช ูุชุฏ **Fail** ูุฑุงุฎูุงู ุดูุฏ (ุง ฺฉ assertion ุดฺฉุณุช ุจุฎูุฑุฏ)ุ ุจุฑูุงูู ูุชููู ูโุดูุฏ.

---

### ๐ ุชุบุฑ ุฑูุชุงุฑ TraceListener

ูโุชูุงูุฏ ุงู ุฑูุชุงุฑ ุฑุง ุชุบุฑ ุฏูุฏุ ุจู ุงู ุตูุฑุช ฺฉู listener ูพุดโูุฑุถ ุฑุง ุญุฐู ฺฉูุฏ ู listenerูุง ุฏูุฎูุงูุชุงู ุฑุง ุงุถุงูู ฺฉูุฏ.

โ ุดูุง ูโุชูุงูุฏ:

* ุงุฒ ุงุจุชุฏุง ฺฉ listener ุจุณุงุฒุฏ (ุจุง **ุฒุฑฺฉูุงุณโฺฏุฑ ุงุฒ TraceListener**).
* ุง ุงุฒ ฺฉ ุงุฒ ุงููุงุน ุงุฒ ูพุด ุชุนุฑูโุดุฏู ุงุณุชูุงุฏู ฺฉูุฏ:

  * **TextWriterTraceListener** โ ููุดุชู ุฏุฑ ฺฉ **Stream** ุง **TextWriter** ุง ุงุถุงูู ฺฉุฑุฏู ุจู ฺฉ ูุงู.
  * **EventLogTraceListener** โ ููุดุชู ุฏุฑ **Windows Event Log** (ููุท ููุฏูุฒ).
  * **EventProviderTraceListener** โ ููุดุชู ุฏุฑ ุฒุฑุณุณุชู **ETW (Event Tracing for Windows)** (ูพุดุชุจุงู ฺูุฏ ุณฺฉู).

ุนูุงูู ุจุฑ ุงูุ **TextWriterTraceListener** ุฎูุฏ ุจู ฺูุฏ ููุน ุฏฺฏุฑ ุฒุฑฺฉูุงุณ ุดุฏู ุงุณุช:

* **ConsoleTraceListener**
* **DelimitedListTraceListener**
* **XmlWriterTraceListener**
* **EventSchemaTraceListener**

---

### โ๏ธ ูุซุงู: ุงูุฒูุฏู ฺูุฏ Listener

ูุซุงู ุฒุฑ listener ูพุดโูุฑุถ Trace ุฑุง ูพุงฺฉ ูโฺฉูุฏ ู ุณูพุณ ุณู listener ุงุถุงูู ูโฺฉูุฏ:

1. ฺฉ listener ฺฉู ุจู ูุงู ุงุถุงูู ูโฺฉูุฏ.
2. ฺฉ listener ฺฉู ุฑู ฺฉูุณูู ูโููุณุฏ.
3. ฺฉ listener ฺฉู ุฏุฑ Windows Event Log ูโููุณุฏ.

```csharp
// ูพุงฺฉ ฺฉุฑุฏู listener ูพุดโูุฑุถ:
Trace.Listeners.Clear();

// ุงูุฒูุฏู writer ฺฉู ุฏุฑ ูุงู trace.txt ูุงฺฏ ูโููุณุฏ:
Trace.Listeners.Add(new TextWriterTraceListener("trace.txt"));

// ฺฏุฑูุชู ุฎุฑูุฌ ฺฉูุณูู ู ุงูุฒูุฏู ุจู ุนููุงู listener:
System.IO.TextWriter tw = Console.Out;
Trace.Listeners.Add(new TextWriterTraceListener(tw));

// ุชูุธู Windows Event Log ู ุงูุฒูุฏู listener
// ุชูุฌู: CreateEventSource ูุงุฒููุฏ ุฏุณุชุฑุณ admin ุงุณุช
if (!EventLog.SourceExists("DemoApp"))
    EventLog.CreateEventSource("DemoApp", "Application");

Trace.Listeners.Add(new EventLogTraceListener("DemoApp"));
```

๐น ุฏุฑ ููุฑุฏ **Windows Event Log**:

* ูพุงูโูุง ฺฉู ุจุง **Write**ุ **Fail** ุง **Assert** ูโููุณุฏุ ููุดู ุจู ุนููุงู ูพุงู **Information** ุฏุฑ Event Viewer ููุงุด ุฏุงุฏู ูโุดููุฏ.
* ูพุงูโูุง ฺฉู ุจุง **TraceWarning** ุง **TraceError** ูโููุณุฏุ ุจู ุชุฑุชุจ ุจู ุตูุฑุช **warning** ุง **error** ููุงุด ุฏุงุฏู ูโุดููุฏ.

---

### ๐๏ธ ููุชุฑ ู ุชูุธูุงุช TraceListener

ฺฉูุงุณ **TraceListener** ฺฉ ูฺฺฏ ุจู ูุงู **Filter** (ุงุฒ ููุน `TraceFilter`) ุฏุงุฑุฏ ฺฉู ูโุชูุงูุฏ ุจุฑุง ฺฉูุชุฑู ููุดุชู ูพุงูโูุง ุฑู ุขู listener ุงุณุชูุงุฏู ฺฉูุฏ.

ุจุฑุง ุงู ฺฉุงุฑ ูโุชูุงูุฏ:

* ฺฉ ุงุฒ ุฒุฑฺฉูุงุณโูุง ุขูุงุฏูโ `TraceFilter` ูุซู **EventTypeFilter** ุง **SourceFilter** ุฑุง ุงุณุชูุงุฏู ฺฉูุฏ.
* ุง ฺฉ ฺฉูุงุณ ุณูุงุฑุด ุงุฒ `TraceFilter` ุจุณุงุฒุฏ ู ูุชุฏ **ShouldTrace** ุฑุง override ฺฉูุฏ.

(ูุซูุงู ูโุชูุงูุฏ ูพุงูโูุง ุฑุง ุจุฑ ุงุณุงุณ category ููุชุฑ ฺฉูุฏ.)

---

### ๐งฉ ูฺฺฏโูุง ุฏฺฏุฑ TraceListener

* ูฺฺฏโูุง **IndentLevel** ู **IndentSize** โ ุจุฑุง ฺฉูุชุฑู ุชูุฑูุชฺฏ (indentation).
* ูฺฺฏ **TraceOutputOptions** โ ุจุฑุง ููุดุชู ุฏุงุฏูโูุง ุงุถุงูู.

ูุซุงู:

```csharp
TextWriterTraceListener tl = new TextWriterTraceListener(Console.Out);
tl.TraceOutputOptions = TraceOptions.DateTime | TraceOptions.Callstack;

Trace.TraceWarning("Orange alert");
```

ุฎุฑูุฌ:

```
DiagTest.vshost.exe Warning: 0 : Orange alert
    DateTime=2007-03-08T05:57:13.6250000Z
    Callstack=   at System.Environment.GetStackTrace(Exception e, Boolean needFileInfo)
                 at System.Environment.get_StackTrace()
                 at ...
```

### ๐ฆ ูพุงฺฉโุณุงุฒ ู ุจุณุชู Listeners

ุจุฑุฎ ุงุฒ **listeners**โูุง ูุซู `TextWriterTraceListener` ุฏุฑ ููุงุช ุฎุฑูุฌ ุฑุง ุฏุฑูู ฺฉ **stream** ูโููุณูุฏ ฺฉู ุชุญุช **cache** ูุฑุงุฑ ุฏุงุฑุฏ. ุงู ููุถูุน ุฏู ูพุงูุฏ ุฏุงุฑุฏ:

* โ๏ธ ฺฉ ูพุงู ููฺฉู ุงุณุช ุจูุงูุงุตูู ุฏุฑ **ุฎุฑูุฌ stream ุง ูุงู** ุธุงูุฑ ูุดูุฏ.
* ๐๏ธ ุดูุง ุจุงุฏ ูุจู ุงุฒ ูพุงุงู ุจุฑูุงููุ **listener** ุฑุง ุจุจูุฏุฏ ุง ุญุฏุงูู **flush** ฺฉูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุขูฺู ุฏุฑ cache ุงุณุช ุงุฒ ุฏุณุช ูโุฑูุฏ (ุจูโุทูุฑ ูพุดโูุฑุถ ุชุง **ด KB** ุงฺฏุฑ ุฏุฑ ุญุงู ููุดุชู ุฏุฑ ูุงู ุจุงุดุฏ).

ฺฉูุงุณโูุง **Trace** ู **Debug** ูุชุฏูุง ุงุณุชุงุชฺฉ `Close` ู `Flush` ุฑุง ูุฑุงูู ูโฺฉููุฏ ฺฉู ุจูโุชุฑุชุจ ุฑู ูููโ listeners ุงุนูุงู ูโุดููุฏ (ฺฉู ุจู ููุจูโ ุฎูุฏ `Close` ุง `Flush` ุฑุง ุฑู writers ู streams ุฒุฑู ุตุฏุง ูโุฒููุฏ).

* `Close` ุจูโุทูุฑ ุถูู `Flush` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ **file handle**ูุง ุฑุง ูโุจูุฏุฏ ู ุงุฒ ููุดุชู ุฏุงุฏูโ ุจุดุชุฑ ุฌููฺฏุฑ ูโฺฉูุฏ.

๐ ุจูโุทูุฑ ฺฉู:

* ูุจู ุงุฒ ูพุงุงู ุจุฑูุงููุ ุงุฒ `Close` ุงุณุชูุงุฏู ฺฉูุฏ.
* ูุฑ ุฒูุงู ฺฉู ุฎูุงุณุชุฏ ูุทูุฆู ุดูุฏ ุฏุงุฏูโูุง ูุนู ููุดุชู ุดุฏูโุงูุฏุ ุงุฒ `Flush` ุงุณุชูุงุฏู ฺฉูุฏ.

ุงู ููุถูุน ุฒูุงู ุงููุช ุฏุงุฑุฏ ฺฉู ุงุฒ listeners ูุจุชู ุจุฑ **stream** ุง **file** ุงุณุชูุงุฏู ฺฉูุฏ.

ููฺููุ ฺฉูุงุณโูุง **Trace** ู **Debug** ฺฉ ูฺฺฏ ุจู ูุงู `AutoFlush` ุฏุงุฑูุฏ. ุงฺฏุฑ ููุฏุงุฑ ุขู `true` ุจุงุดุฏุ ุจุนุฏ ุงุฒ ูุฑ ูพุงูุ ฺฉ `Flush` ุงูุฌุงู ูโุดูุฏ.

๐ ุชูุตู ููู:
ุงฺฏุฑ ุงุฒ **listeners** ูุจุชู ุจุฑ ูุงู ุง stream ุงุณุชูุงุฏู ูโฺฉูุฏุ ุจูุชุฑ ุงุณุช `AutoFlush` ุฑุง ุฑู `true` ุจฺฏุฐุงุฑุฏ. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุงฺฏุฑ ฺฉ **Unhandled Exception** ุง ุฎุทุง ุจุญุฑุงู ุฑุฎ ุฏูุฏุ ุขุฎุฑู **ด KB ุงุทูุงุนุงุช ุชุดุฎุต** ููฺฉู ุงุณุช ุงุฒ ุฏุณุช ุจุฑูุฏ.

---

### ๐ ฺฉูพุงุฑฺฺฏ ุจุง Debugger

ฺฏุงู ุงููุงุช ููุฏ ุงุณุช ฺฉู ฺฉ ุจุฑูุงูู ุฏุฑ ุตูุฑุช ููุฌูุฏ ุจูุฏูุ ุจุง **Debugger** ุชุนุงูู ุฏุงุดุชู ุจุงุดุฏ.

* ุฏุฑ ุฒูุงู ุชูุณุนูุ Debugger ูุนูููุงู ููุงู IDE ุดูุงุณุช (ูุซูุงู **Visual Studio**).
* ุฏุฑ ุฒูุงู ุงุณุชูุฑุงุฑุ Debugger ุงุญุชูุงูุงู ุงุจุฒุงุฑูุง ุณุทุญ ูพุงูโุชุฑ ูุซู **WinDbg**ุ **Cordbg** ุง **MDbg** ุฎูุงูุฏ ุจูุฏ.

---

#### ๐ Attach ู Break

ฺฉูุงุณ ุงุณุชุงุชฺฉ `Debugger` ุฏุฑ **System.Diagnostics** ุชูุงุจุน ุงุตู ุฒุฑ ุฑุง ุจุฑุง ุชุนุงูู ุจุง Debugger ูุฑุงูู ูโฺฉูุฏ:

* `Break`
* `Launch`
* `Log`
* `IsAttached`

๐น ุจุฑุง ุฏุจุงฺฏ ฺฉุฑุฏู ฺฉ ุจุฑูุงููุ ุงุจุชุฏุง ุจุงุฏ **Debugger ุจู ุขู attach ุดูุฏ**. ุงฺฏุฑ ุจุฑูุงูู ุฑุง ุงุฒ ุฏุงุฎู IDE ุงุฌุฑุง ฺฉูุฏุ ุงู ฺฉุงุฑ ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุดูุฏ (ูฺฏุฑ ุงูฺฉู ุนูุฏุงู ฺฏุฒููโ โStart without debuggingโ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ).

ุงูุง ฺฏุงู ุดุฑูุน ุจุฑูุงูู ุฏุฑ ุญุงูุช ุฏุจุงฺฏ ุงุฒ ุฏุงุฎู IDE ุงูฺฉุงูโูพุฐุฑ ุง ุฑุงุญุช ูุณุช (ูุซูุงู ุฏุฑ **Windows Service** ุง ุญุช ุฏุฑ ฺฉ **Visual Studio Designer**).

๐ ุฑุงูโุญู:

* ุจุฑูุงูู ุฑุง ุจูโุตูุฑุช ุนุงุฏ ุงุฌุฑุง ฺฉูุฏ.
* ุณูพุณ ุงุฒ ุฏุงุฎู IDE ฺฏุฒููโ **Debug Process** ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.

ุงูุจุชู ุงู ุฑูุด ุงุฌุงุฒู ููโุฏูุฏ ุฏุฑ ูุฑุงุญู ุงูููโ ุงุฌุฑุง ุจุฑูุงููุ Breakpoint ุจฺฏุฐุงุฑุฏ.

โ๏ธ ุฑูุด ุฌุงฺฏุฒู: ูุฑุงุฎูุงู `Debugger.Break` ุงุฒ ุฏุงุฎู ุจุฑูุงูู. ุงู ูุชุฏ ุจุงุนุซ ูโุดูุฏ ฺฉ Debugger ุฑุงูโุงูุฏุงุฒ ุดูุฏุ ุจู ุจุฑูุงูู attach ุดูุฏ ู ุงุฌุฑุง ุขู ุฑุง ูุชููู ฺฉูุฏ.

* `Launch` ูุดุงุจู ุงุณุช ุงูุง ุงุฌุฑุง ุจุฑูุงูู ุฑุง ูุชููู ููโฺฉูุฏ.
* ุจุนุฏ ุงุฒ attach ุดุฏูุ ูโุชูุงูุฏ ุจุง ูุชุฏ `Log` ูพุงูโูุง ุฑุง ูุณุชููุงู ุจู **ูพูุฌุฑูโ ุฎุฑูุฌ Debugger** ุจูุฑุณุชุฏ.
* ูุถุนุช attach ุจูุฏู Debugger ุฑุง ูู ูโุชูุงูุฏ ุจุง ูฺฺฏ `IsAttached` ุจุฑุฑุณ ฺฉูุฏ.

---

#### ๐๏ธ ูฺฺฏโูุง Debugger

ุฏู Attribute ููู ูุฌูุฏ ุฏุงุฑูุฏ:

* `DebuggerStepThrough`
* `DebuggerHidden`

ุงูโูุง ุจู Debugger ูพุดููุงุฏ ูโุฏููุฏ ููฺฏุงู **Single-Stepping** (ุงุฌุฑุง ุฎุทโุจูโุฎุท) ุจุง ฺฉ ูุชุฏุ ุณุงุฒูุฏู ุง ฺฉูุงุณ ุฎุงุต ฺฺฏููู ุฑูุชุงุฑ ฺฉูุฏ.

* `DebuggerStepThrough` ุจู Debugger ูโฺฏูุฏ **ุจุฏูู ุชุนุงูู ฺฉุงุฑุจุฑุ ุงุฒ ุฑู ฺฉ ูุชุฏ ุนุจูุฑ ฺฉูุฏ**.
  โก๏ธ ุงู ููุถูุน ุฏุฑ ูุชุฏูุง **ุฎูุฏฺฉุงุฑ ุชููุฏุดุฏู** ู ูุชุฏูุง **Proxy** ฺฉู ฺฉุงุฑ ุงุตู ุฑุง ุจู ุฌุง ุฏฺฏุฑ ูพุงุณ ูโุฏููุฏ ููุฏ ุงุณุช.

* ุงฺฏุฑ ุฏุฑ ูุชุฏ ูุงูุน (real method) Breakpoint ุชูุธู ุดูุฏุ Debugger ููฺูุงู ูุชุฏ Proxy ุฑุง ุฏุฑ Call Stack ูุดุงู ูโุฏูุฏโูฺฏุฑ ุงูฺฉู Attribute `DebuggerHidden` ูู ุงุถุงูู ุดูุฏ.

๐ ุชุฑฺฉุจ ุงู ุฏู Attribute ุฏุฑ Proxyูุง ฺฉูฺฉ ูโฺฉูุฏ ฺฉุงุฑุจุฑ ุชูุฑฺฉุฒ ุจุดุชุฑ ุฑู **ููุทู ุจุฑูุงูู** ุฏุงุดุชู ุจุงุดุฏ ู ฺฉูุชุฑ ุฏุฑฺฏุฑ ุฌุฒุฆุงุช ุดูุฏ:

```csharp
[DebuggerStepThrough, DebuggerHidden]
void DoWorkProxy()
{
  // setup...
  DoWork();
  // teardown...
}

void DoWork() {...}   // ูุชุฏ ุงุตู
```

---

### โ๏ธ ูพุฑุฏุงุฒุดโูุง (Processes) ู Threadูุง ูพุฑุฏุงุฒุด

ุฏุฑ ุจุฎุด ุขุฎุฑ ูุตู ถุ ุชูุถุญ ุฏุงุฏู ฺฉู ฺุทูุฑ ุจุง `Process.Start` ฺฉ ูพุฑุฏุงุฒุด ุฌุฏุฏ ุฑุงูโุงูุฏุงุฒ ฺฉูุฏ.
ฺฉูุงุณ `Process` ููฺูู ุงุฌุงุฒู ูโุฏูุฏ ูพุฑุฏุงุฒุดโูุง ุฏฺฏุฑ ุฑุง ุฑู ููุงู ฺฉุงููพูุชุฑ ุง ฺฉ ฺฉุงููพูุชุฑ ุฏฺฏุฑ **ูพุฑุณโูุฌู ู ูุฏุฑุช ฺฉูุฏ**.

* ฺฉูุงุณ `Process` ุจุฎุด ุงุฒ **.NET Standard 2.0** ุงุณุชุ ูุฑฺูุฏ ูุงุจูุชโูุง ุขู ุฑู **UWP** ูุญุฏูุฏ ูโุดูุฏ.

---

#### ๐ ุจุฑุฑุณ ูพุฑุฏุงุฒุดโูุง ุฏุฑ ุญุงู ุงุฌุฑุง

ูุชุฏูุง `Process.GetProcessXXX` ูพุฑุฏุงุฒุดโูุง ุฑุง ุจุฑ ุงุณุงุณ **ูุงู** ุง **ุดูุงุณูโ ูพุฑุฏุงุฒุด (PID)** ุง ูููโ ูพุฑุฏุงุฒุดโูุง ุฏุฑ ุญุงู ุงุฌุฑุง ุฑู ฺฉ ฺฉุงููพูุชุฑ ุฎุงุต ุจุฑูโฺฏุฑุฏุงููุฏ.

ุงู ุดุงูู ูพุฑุฏุงุฒุดโูุง **Managed** ู **Unmanaged** ูโุดูุฏ.

ูุฑ ูููููโ `Process` ูุฌููุนูโุง ุงุฒ ูฺฺฏโูุง ุฏุงุฑุฏ ฺฉู ุดุงูู ููุงุฑุฏ ุฒุฑ ูุณุชูุฏ:

* ูุงู
* ID
* ุงูููุช
* ูุตุฑู ุญุงูุธู ู ูพุฑุฏุงุฒูุฏู
* Window Handleูุง
* ู โฆ

ููููู ฺฉุฏ ุฒุฑ ูููโ ูพุฑุฏุงุฒุดโูุง ุฏุฑ ุญุงู ุงุฌุฑุง ุฑู ฺฉุงููพูุชุฑ ูุนู ุฑุง ูุณุช ูโฺฉูุฏ:

```csharp
foreach (Process p in Process.GetProcesses())
using (p)
{
    Console.WriteLine(p.ProcessName);
    Console.WriteLine("   PID:      " + p.Id);
    Console.WriteLine("   Memory:   " + p.WorkingSet64);
    Console.WriteLine("   Threads:  " + p.Threads.Count);
}
```

* `Process.GetCurrentProcess` ูพุฑุฏุงุฒุด ูุนู ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ.
* ุจุฑุง ูพุงุงู ุฏุงุฏู ุจู ฺฉ ูพุฑุฏุงุฒุด ูโุชูุงูุฏ ุงุฒ ูุชุฏ `Kill` ุงุณุชูุงุฏู ฺฉูุฏ.

### ๐งต ุจุฑุฑุณ Threadูุง ุฏุฑ ฺฉ Process

ุดูุง ูโุชูุงูุฏ ุจุง ูฺฺฏ **`Process.Threads`**ุ ุฑู Threadูุง ูพุฑุฏุงุฒุดโูุง ุฏฺฏุฑ ูู **enumerate** ฺฉูุฏ.
ุงูุง ุดุกูุง ฺฉู ุฏุฑุงูุช ูโฺฉูุฏุ **`System.Threading.Thread`** ูุณุชูุฏุ ุจูฺฉู ุงุฒ ููุน **`ProcessThread`** ูุณุชูุฏ. ุงู ููุน ุจุฑุง **ูุธุงู ูุฏุฑุช** (Administrative) ุทุฑุงุญ ุดุฏู ุงุณุชุ ูู ุจุฑุง ููฺฏุงูโุณุงุฒ (Synchronization).

๐น ฺฉ **ProcessThread** ุงุทูุงุนุงุช ุชุดุฎุต (Diagnostic) ุฏุฑุจุงุฑูโ Thread ุฒุฑุจูุง ุงุฑุงุฆู ูโุฏูุฏ ู ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุจุฑุฎ ุฌูุจูโูุง ุขู ุฑุง ฺฉูุชุฑู ฺฉูุฏ (ูุซู ุงูููุช ู ูุงุจุณุชฺฏ ุจู ูพุฑุฏุงุฒูุฏู).

ููููู ฺฉุฏ:

```csharp
public void EnumerateThreads (Process p)
{
  foreach (ProcessThread pt in p.Threads)
  {
    Console.WriteLine (pt.Id);
    Console.WriteLine ("   State:    " + pt.ThreadState);
    Console.WriteLine ("   Priority: " + pt.PriorityLevel);
    Console.WriteLine ("   Started:  " + pt.StartTime);
    Console.WriteLine ("   CPU time: " + pt.TotalProcessorTime);
  }
}
```

---

### ๐ StackTrace ู StackFrame

ฺฉูุงุณโูุง **StackTrace** ู **StackFrame** ฺฉ ููุง ููุทโุฎูุงูุฏู ุงุฒ **Call Stack** ุงุฌุฑุง ุจุฑูุงูู ุงุฑุงุฆู ูโุฏููุฏ.

๐ ุดูุง ูโุชูุงูุฏ Stack Trace ุฑุง ุจุฑุง:

* Thread ูุนู
* ุง ฺฉ **Exception**

ุจูโุฏุณุช ุขูุฑุฏ.

ุงู ุงุทูุงุนุงุช ุจุดุชุฑ ุจุฑุง **ุชุดุฎุต ุฎุทุงูุง (Diagnostics)** ููุฏ ูุณุชูุฏุ ูุฑฺูุฏ ฺฏุงู ูู ุฏุฑ ุจุฑูุงููโููุณ (ุญููโูุง ุง Hacks) ุจูโฺฉุงุฑ ูโุฑููุฏ.

* **StackTrace** โ ฺฉ Call Stack ฺฉุงูู ุฑุง ููุงุด ูโุฏูุฏ.
* **StackFrame** โ ฺฉ ูุฑุงุฎูุงู ูุชุฏ ูููุฑุฏ ุฏุฑูู ุขู Stack ุฑุง ููุงุด ูโุฏูุฏ.

๐ก ูฺฉุชู:
ุงฺฏุฑ ููุท ูโุฎูุงูุฏ **ูุงู ู ุดูุงุฑู ุฎุท ูุชุฏ ูุฑุงุฎูุงููุฏู** ุฑุง ุจุฏุงูุฏุ ุงุณุชูุงุฏู ุงุฒ **Caller Info Attributes** ฺฏุฒููโุง ุณุฑุนโุชุฑ ู ุณุงุฏูโุชุฑ ุงุณุช (ุฏุฑ ุตูุญู ฒดถ ุชูุถุญ ุฏุงุฏู ุดุฏู).

---

#### ๐ผ๏ธ ุณุงุฎุชู ฺฉ StackTrace

ุงฺฏุฑ ฺฉ ุดุก **StackTrace** ุจุฏูู ุขุฑฺฏููุงู (ุง ููุฑุงู ุจุง ฺฉ ุขุฑฺฏููุงู bool) ุจุณุงุฒุฏ:

* ุดูุง ฺฉ Snapshot ุงุฒ Call Stack ูุนู ูโฺฏุฑุฏ.
* ุงฺฏุฑ ุขุฑฺฏููุงู `true` ุจุงุดุฏุ **StackTrace** ูุงูโูุง `.pdb` (project debug) ุฑุง ูู ูโุฎูุงูุฏ (ุงฺฏุฑ ููุฌูุฏ ุจุงุดูุฏ) ู ุจู ุดูุง **ูุงู ูุงูุ ุดูุงุฑู ุฎุท ู ุดูุงุฑู ุณุชูู** ุฑุง ูู ูโุฏูุฏ.

๐ง ูุงูโูุง `.pdb` ุฒูุงู ุชููุฏ ูโุดููุฏ ฺฉู ุจุฑูุงูู ุฑุง ุจุง ฺฏุฒููโ `/debug` ฺฉุงููพุงู ฺฉูุฏ. (Visual Studio ุจูโุทูุฑ ูพุดโูุฑุถ ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏุ ูฺฏุฑ ุงูฺฉู ุฏุฑ **Advanced Build Settings** ุฎูุงูุด ุฑุง ุจุฎูุงูุฏ).

ูพุณ ุงุฒ ฺฏุฑูุชู ฺฉ StackTraceุ ูโุชูุงูุฏ:

* ฺฉ Frame ุฎุงุต ุฑุง ุจุง `GetFrame` ุจุฑุฑุณ ฺฉูุฏ.
* ุง ูููโ Frameูุง ุฑุง ุจุง `GetFrames` ุฏุฑุงูุช ฺฉูุฏ.

---

#### ๐จ ููููู ฺฉุฏ

```csharp
static void Main() { A (); }
static void A()    { B (); }
static void B()    { C (); }
static void C()
{
  StackTrace s = new StackTrace(true);
  Console.WriteLine ("Total frames:   " + s.FrameCount);
  Console.WriteLine ("Current method: " + s.GetFrame(0).GetMethod().Name);
  Console.WriteLine ("Calling method: " + s.GetFrame(1).GetMethod().Name);
  Console.WriteLine ("Entry method:   " +
                      s.GetFrame(s.FrameCount-1).GetMethod().Name);

  Console.WriteLine ("Call Stack:");
  foreach (StackFrame f in s.GetFrames())
    Console.WriteLine (
      "  File: "   + f.GetFileName() +
      "  Line: "   + f.GetFileLineNumber() +
      "  Col: "    + f.GetFileColumnNumber() +
      "  Offset: " + f.GetILOffset() +
      "  Method: " + f.GetMethod().Name);
}
```

---

#### ๐ฅ๏ธ ุฎุฑูุฌ

```
Total frames:   4
Current method: C
Calling method: B
Entry method: Main
Call stack:
  File: C:\Test\Program.cs  Line: 15  Col: 4  Offset: 7  Method: C
  File: C:\Test\Program.cs  Line: 12  Col: 22 Offset: 6  Method: B
  File: C:\Test\Program.cs  Line: 11  Col: 22 Offset: 6  Method: A
  File: C:\Test\Program.cs  Line: 10  Col: 25 Offset: 6  Method: Main
```

๐ ูฺฉุชูโูุง:

* **IL Offset** ูุญู ุฏุณุชูุฑ ุจุนุฏ ุฑุง ูุดุงู ูโุฏูุฏุ ูู ุฏุณุชูุฑ ุฏุฑ ุญุงู ุงุฌุฑุง.
* ุงูุง ุดูุงุฑู ุฎุท ู ุณุชูู (ุงฺฏุฑ ูุงู `.pdb` ููุฌูุฏ ุจุงุดุฏ) ูุนูููุงู ููุทูโ ุงุฌุฑุง ูุงูุน ุฑุง ูุดุงู ูโุฏููุฏ.
* CLR ุชูุงุด ูโฺฉูุฏ ุงู ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ IL ุงุณุชูุจุงุท ฺฉูุฏ. ุจุฑุง ููู ฺฉุงููพุงูุฑ ุฏุณุชูุฑูุง **nop** (no-operation) ุฑุง ุฏุฑุฌ ูโฺฉูุฏ.

โ๏ธ ุงูุง ุงฺฏุฑ ุจุง **Optimization** ฺฉุงููพุงู ฺฉูุฏ:

* ุฏุณุชูุฑูุง nop ุฏุฑุฌ ููโุดููุฏ.
* ุจูุงุจุฑุงู StackTrace ููฺฉู ุงุณุช ุดูุงุฑู ุฎุท/ุณุชูู ุฏุณุชูุฑ ุจุนุฏ ุฑุง ูุดุงู ุฏูุฏ.
* Optimization ูโุชูุงูุฏ ุญุช ูุชุฏูุง ุฑุง ุงุฏุบุงู ฺฉูุฏ ู StackTrace ุฑุง ฺฉูุชุฑ ูุงุจูโุงุนุชูุงุฏ ุณุงุฒุฏ.

---

#### ๐ ุฑุงู ูุงูุจุฑ

ูุฑุงุฎูุงู `ToString()` ุฑู ฺฉ StackTrace ููุงู ุงุทูุงุนุงุช ุถุฑูุฑ ุฑุง ุจูโุตูุฑุช ุณุงุฏูโุชุฑ ูโุฏูุฏ:

```
at DebugTest.Program.C() in C:\Test\Program.cs:line 16
at DebugTest.Program.B() in C:\Test\Program.cs:line 12
at DebugTest.Program.A() in C:\Test\Program.cs:line 11
at DebugTest.Program.Main() in C:\Test\Program.cs:line 10
```

---

#### โ๏ธ StackTrace ุฑู Exception

ูโุชูุงูุฏ StackTrace ูุฑุจูุท ุจู ฺฉ Exception ุฑุง ูู ุจฺฏุฑุฏ (ุจุฑุง ุฏุฏู ุงูฺฉู ฺู ฺุฒ ููุฌุฑ ุจู ูพุฑุชุงุจ ุดุฏู Exception ุดุฏ) ุจุง ูพุงุณโุฏุงุฏู ุขู ุจู ุณุงุฒูุฏูโ `StackTrace`.

* ุฎูุฏ **Exception** ฺฉ ูฺฺฏ ุจู ูุงู `StackTrace` ุฏุงุฑุฏุ ุงูุง ุงู ููุท ฺฉ **string ุณุงุฏู** ุจุฑูโฺฏุฑุฏุงูุฏุ ูู ฺฉ ุดุก StackTrace.
* ุฏุงุดุชู ฺฉ ุดุก StackTrace ุฎู ููุฏุชุฑ ุงุณุชุ ูุฎุตูุตุงู ุจุฑุง **Log ฺฉุฑุฏู Exceptionูุง ุจุนุฏ ุงุฒ ุงุณุชูุฑุงุฑ (Deployment)** ฺฉู ูุนูููุงู ูุงูโูุง `.pdb` ููุฌูุฏ ูุณุชูุฏ.

โ ุฏุฑ ุงู ุญุงูุช ูโุชูุงูุฏ ุจูโุฌุง ุดูุงุฑู ุฎุท/ุณุชููุ **IL Offset** ุฑุง Log ฺฉูุฏ.
ู ุจุง ุงุณุชูุงุฏู ุงุฒ **ildasm**ุ ูุญู ุฏูู ุฎุทุง ุฏุฑูู ูุชุฏ ุฑุง ุจุงุจุฏ.

---

### ๐ช Windows Event Logs

ูพูุชูุฑู **Win32** ฺฉ ูฺฉุงูุฒู **Log ูุฑฺฉุฒ** ุจูโูุงู **Windows Event Logs** ูุฑุงูู ูโฺฉูุฏ.

* ฺฉูุงุณโูุง **Debug** ู **Trace** ฺฉู ูุจูุงู ุงุณุชูุงุฏู ฺฉุฑุฏูุ ุฏุฑ ุตูุฑุช ุซุจุช ฺฉ **EventLogTraceListener** ูโุชูุงููุฏ ุฏุฑ Windows Event Log ุจููุณูุฏ.
* ุจุง ฺฉูุงุณ **EventLog**ุ ุดูุง ูโุชูุงูุฏ:

  * ูุณุชููุงู ุฏุฑ Windows Event Log ุจููุณุฏ (ุจุฏูู ูุงุฒ ุจู Trace ุง Debug).
  * ุง ุฏุงุฏูโูุง ุฑูุฏุงุฏ ุฑุง ุจุฎูุงูุฏ ู ูพุงุด ฺฉูุฏ.

๐๏ธ ููุดุชู ุฏุฑ Event Log ุฏุฑ **ุจุฑูุงููโูุง Windows Service** ุจุณุงุฑ ููุทู ุงุณุช. ฺูู ุงฺฏุฑ ุฎุทุง ุฑุฎ ุฏูุฏุ ููโุชูุงูุฏ ฺฉ UI ุจุงุฒ ฺฉูุฏ ู ุจู ฺฉุงุฑุจุฑ ุจฺฏูุฏ ุจู ูุงู ุฎุงุต ุจุฑุง ุงุทูุงุนุงุช ุชุดุฎุต ูุฑุงุฌุนู ฺฉูุฏ. ููฺููุ ฺูู ููุดุชู Serviceูุง ุฏุฑ Event Log ฺฉ **ุฑูู ุงุณุชุงูุฏุงุฑุฏ** ุงุณุชุ ุงู ุงููู ุฌุง ุฎูุงูุฏ ุจูุฏ ฺฉู ฺฉ ูุฏุฑ ุณุณุชู (Administrator) ุจุฑุง ุจุฑุฑุณ ูุดฺฉู ุณุฑูุณ ุดูุง ูฺฏุงู ูโฺฉูุฏ.

---

๐ ุณู Event Log ุงุณุชุงูุฏุงุฑุฏ ุฏุฑ ููุฏูุฒ ูุฌูุฏ ุฏุงุฑุฏ:

* **Application**
* **System**
* **Security**

๐ ูุนูููุงู ุจุฑูุงููโูุง ุฏุฑ **Application Log** ูโููุณูุฏ.

### โ๏ธ ููุดุชู ุฏุฑ **Event Log**

ุจุฑุง ููุดุชู ุฏุฑ **Windows Event Log** ูุฑุงุญู ุฒุฑ ุฑุง ุงูุฌุงู ุฏูุฏ:

1๏ธโฃ ฺฉ ุงุฒ ุณู **event log** ููุฌูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ (ูุนูููุงู **Application**).
2๏ธโฃ ฺฉ **source name** (ูุงู ููุจุน) ูุดุฎุต ฺฉูุฏ ู ุฏุฑ ุตูุฑุช ูุงุฒ ุขู ุฑุง ุจุณุงุฒุฏ (ุณุงุฎุชู ูุงุฒููุฏ ุฏุณุชุฑุณ ูุฏุฑุช ุงุณุช).
3๏ธโฃ ูุชุฏ **EventLog.WriteEntry** ุฑุง ุจุง ูุงู ูุงฺฏุ ูุงู ููุจุน ู ุฏุงุฏูโ ูพุงู ูุฑุงุฎูุงู ฺฉูุฏ.

๐น **Source name** ฺฉ ูุงู ูุดุฎุต ู ูุงุจู ุดูุงุณุง ุจุฑุง ุจุฑูุงููโ ุดูุงุณุช. ูุจู ุงุฒ ุงุณุชูุงุฏู ุจุงุฏ ุขู ุฑุง ุซุจุช ฺฉูุฏ. ุงู ฺฉุงุฑ ุจุง ูุชุฏ **CreateEventSource** ุงูุฌุงู ูโุดูุฏ. ุณูพุณ ูโุชูุงูุฏ ุงุฒ ูุชุฏ **WriteEntry** ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
const string SourceName = "MyCompany.WidgetServer";
// CreateEventSource ูุงุฒููุฏ ุฏุณุชุฑุณ ูุฏุฑุช ุงุณุชุ ุจูุงุจุฑุงู ูุนูููุงู ุฏุฑ ุจุฎุด ูุตุจ ุจุฑูุงูู ุงูุฌุงู ูโุดูุฏ.
if (!EventLog.SourceExists(SourceName))
    EventLog.CreateEventSource(SourceName, "Application");

EventLog.WriteEntry(SourceName,
  "Service started; using configuration file=...",
  EventLogEntryType.Information);
```

๐ธ ููุฏุงุฑ **EventLogEntryType** ูโุชูุงูุฏ ฺฉ ุงุฒ ููุงุฑุฏ ุฒุฑ ุจุงุดุฏ:

* **Information** โน๏ธ
* **Warning** โ๏ธ
* **Error** โ
* **SuccessAudit** โ
* **FailureAudit** ๐ซ

ูุฑฺฉุฏุงู ุฏุฑ **Windows Event Viewer** ุจุง ฺฉ ุขฺฉูู ูุชูุงูุช ููุงุด ุฏุงุฏู ูโุดููุฏ. ููฺูู ูโุชูุงูุฏ ุจูโุทูุฑ ุงุฎุชุงุฑ ฺฉ **Category** ู **Event ID** (ูุฑ ุฏู ุนุฏุฏ ุฏูุฎูุงู) ู ุฏุงุฏูโ ุจุงูุฑ ุงุถุงูู ฺฉูุฏ.

๐ ูุชุฏ **CreateEventSource** ููฺูู ุงุฌุงุฒู ูโุฏูุฏ ูุงู ฺฉ ฺฉุงููพูุชุฑ ุฏฺฏุฑ ุฑุง ูุดุฎุต ฺฉูุฏุ ุฏุฑ ุตูุฑุช ฺฉู ุฏุณุชุฑุณ ฺฉุงู ุฏุงุดุชู ุจุงุดุฏุ ูโุชูุงูุฏ ุฏุฑ **event log** ุขู ุณุณุชู ูู ุจููุณุฏ.

---

### ๐ ุฎูุงูุฏู ุงุฒ **Event Log**

ุจุฑุง ุฎูุงูุฏู ุงุฒ ฺฉ **event log**:
1๏ธโฃ ฺฉูุงุณ **EventLog** ุฑุง ุจุง ูุงู ูุงฺฏ ููุฑุฏูุธุฑ (ู ุฏุฑ ุตูุฑุช ูุงุฒุ ูุงู ฺฉ ฺฉุงููพูุชุฑ ุฏฺฏุฑ) ูููููโุณุงุฒ ฺฉูุฏ.
2๏ธโฃ ูุฑ ูุฑูุฏ ุฑุง ุงุฒ ุทุฑู ูฺฺฏ **Entries** ุจุฎูุงูุฏ:

```csharp
EventLog log = new EventLog("Application");
Console.WriteLine("Total entries: " + log.Entries.Count);

EventLogEntry last = log.Entries[log.Entries.Count - 1];
Console.WriteLine("Index:   " + last.Index);
Console.WriteLine("Source:  " + last.Source);
Console.WriteLine("Type:    " + last.EntryType);
Console.WriteLine("Time:    " + last.TimeWritten);
Console.WriteLine("Message: " + last.Message);
```

๐น ููฺูู ูโุชูุงูุฏ ูููโ ูุงฺฏโูุง ุฑุง ุจุฑุง ฺฉุงููพูุชุฑ ูุนู (ุง ฺฉ ุณุณุชู ุฏฺฏุฑ) ุจุง ูุชุฏ **EventLog.GetEventLogs** ูพูุงุด ฺฉูุฏ (ุจุฑุง ุฏุณุชุฑุณ ฺฉุงูู ูุงุฒ ุจู ุฏุณุชุฑุณ ูุฏุฑุช ุฏุงุฑุฏ):

```csharp
foreach (EventLog log in EventLog.GetEventLogs())
    Console.WriteLine(log.LogDisplayName);
```

ุงู ูุนูููุงู ุญุฏุงูู ุดุงูู **Application**ุ **Security** ู **System** ุฎูุงูุฏ ุจูุฏ.

---

### ๐ ูุงูุชูุฑูฺฏ **Event Log**

ูโุชูุงูุฏ ุจูโูุญุถ ููุดุชูโุดุฏู ฺฉ ูุฑูุฏ ุฌุฏุฏ ุฏุฑ **Windows Event Log** ูุทูุน ุดูุฏ. ุงู ฺฉุงุฑ ุจุง **EntryWritten event** ุงูุฌุงู ูโุดูุฏ. ุงู ุฑูุฏุงุฏ ุจุฑุง ูุงฺฏโูุง ุณุณุชู ูุญู ูุนุงู ูโุดูุฏ ู ูุงุฑุบ ุงุฒ ุงูฺฉู ฺฉุฏุงู ุจุฑูุงูู ูุฑูุฏ ุฑุง ููุดุชู ุงุณุชุ ุฑุฎ ุฎูุงูุฏ ุฏุงุฏ.

ุจุฑุง ูุนุงูโุณุงุฒ ูุงูุชูุฑูฺฏ ูุงฺฏ:
1๏ธโฃ ฺฉ ููููู ุงุฒ **EventLog** ุงุฌุงุฏ ฺฉูุฏ.
2๏ธโฃ ูฺฺฏ **EnableRaisingEvents** ุฑุง ุฑู true ูุฑุงุฑ ุฏูุฏ.
3๏ธโฃ ุฑูุฏุงุฏ **EntryWritten** ุฑุง ููุฏู ฺฉูุฏ.

ููููู ฺฉุฏ:

```csharp
using (var log = new EventLog("Application"))
{
    log.EnableRaisingEvents = true;
    log.EntryWritten += DisplayEntry;
    Console.ReadLine();
}

void DisplayEntry(object sender, EntryWrittenEventArgs e)
{
    EventLogEntry entry = e.Entry;
    Console.WriteLine(entry.Message);
}
```

### โก **Performance Counters**

**Performance Counters** ฺฉ ูุงุจูุช ุงุฎุชุตุงุต **Windows** ุงุณุช ู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุขู ุจุงุฏ ูพฺฉุฌ **NuGet** ุจุง ูุงู
`System.Diagnostics.PerformanceCounter` ูุตุจ ุดูุฏ.
ุงฺฏุฑ ูุฏู ุดูุง **Linux** ุง **macOS** ุจุงุดุฏุ ุจุงุฏ ุจู ุจุฎุด **โCross-Platform Diagnostic Toolsโ** ุฏุฑ ุตูุญูโ 625 ูุฑุงุฌุนู ฺฉูุฏ ุชุง ุงุจุฒุงุฑูุง ุฌุงฺฏุฒู ุฑุง ุจุจูุฏ.

---

#### ๐ ูุฏู ุงุฒ Performance Counters

ูฺฉุงูุฒูโูุง ูุงฺฏโฺฏุฑ ฺฉู ุชุงฺฉููู ุจุฑุฑุณ ฺฉุฑุฏู ุจุดุชุฑ ุจุฑุง **ุชุญููโูุง ุจุนุฏ** ููุฏ ูุณุชูุฏ.
ุงูุง ุงฺฏุฑ ุจุฎูุงูู ุงุฒ ูุถุนุช **ูุนู** ฺฉ ุจุฑูุงูู ุง ฺฉู ุณุณุชู ูุทูุน ุดููุ ูุงุฒ ุจู ุฑูฺฉุฑุฏ **ุจูุงุฏุฑูฺฏ (real-time)** ุฏุงุฑู.

๐น ุฑุงูฺฉุงุฑ **Win32** ุจุฑุง ุงู ูุงุฒุ ุงุณุชูุงุฏู ุงุฒ ุฒุฑุณุงุฎุช **performance-monitoring** ุงุณุช. ุงู ุฒุฑุณุงุฎุช ุดุงูู:

* ูุฌููุนูโุง ุงุฒ **performance counters** ุงุณุช ฺฉู ุชูุณุท ุณุณุชู ู ุจุฑูุงููโูุง ููุชุดุฑ ูโุดููุฏ.
* ุงุจุฒุงุฑูุง ุฏุฑ ูุงูุจ **Microsoft Management Console (MMC) snap-ins** ุจุฑุง ูุงูุชูุฑูฺฏ ุจูุงุฏุฑูฺฏ ุงู ฺฉุงูุชุฑูุง.

---

#### ๐๏ธ ุฏุณุชูโุจูุฏ Performance Counters

ฺฉุงูุชุฑูุง ุนููฺฉุฑุฏ ุฏุฑ ฺฏุฑููโูุง ุจู ูุงู **category** (ุง **performance object** ุฏุฑ ุฑุงุจุทโูุง ฺฏุฑุงูฺฉ) ูุฑุงุฑ ุฏุงุฑูุฏ.
ูุฑ **category** ูุฌููุนูโุง ุงุฒ ฺฉุงูุชุฑูุง ูุฑุชุจุท ุฑุง ุจุฑุง ูุงูุชูุฑูฺฏ ฺฉ ุฌูุจู ุงุฒ ุณุณุชู ุง ุจุฑูุงูู ฺฏุฑุฏ ูู ูโุขูุฑุฏ.

ูุซุงูโูุง:

* **System** โ๏ธ
* **Processor** ๐ฅ๏ธ
* **.NET CLR Memory** ๐พ

ุฏุฑ ุฏุณุชูโ **.NET CLR Memory** ฺฉุงูุชุฑูุง ูุงููุฏ:

* **% Time in GC**
* **# Bytes in All Heaps**
* **Allocated bytes/sec**

ูุฑ **category** ูโุชูุงูุฏ ฺฉ ุง ฺูุฏ **instance** ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุจูโุตูุฑุช ูุณุชูู ูุงุจู ูุงูุชูุฑูฺฏ ูุณุชูุฏ.
ุจุฑุง ููููู:

* ฺฉุงูุชุฑ **% Processor Time** ุฏุฑ ุฏุณุชูโ **Processor** ุงู ุงูฺฉุงู ุฑุง ูโุฏูุฏ ฺฉู **ุงุณุชูุงุฏู ุงุฒ CPU** ุฑุง ูุงูุชูุฑ ฺฉูุฏ.
* ุฏุฑ ฺฉ ุณุณุชู ฺูุฏูพุฑุฏุงุฒูุฏูโุงุ ุงู ฺฉุงูุชุฑ ฺฉ instance ุจุฑุง ูุฑ CPU ุฏุงุฑุฏ ู ุดูุง ูโุชูุงูุฏ ูุตุฑู ูุฑ CPU ุฑุง ุฌุฏุงฺฏุงูู ุจุฑุฑุณ ฺฉูุฏ.

---

#### โ๏ธ ูฺฉุชูโ ููู ุฏุฑุจุงุฑูโ ุฏุณุชุฑุณ

ุฎูุงูุฏู **performance counters** ุง **categories** ููฺฉู ุงุณุช ูุงุฒููุฏ ุฏุณุชุฑุณ **administrator** ุฑู ุณุณุชู ูุญู ุง ููุตุฏ ุจุงุดุฏุ ุจุณุชู ุจู ฺุฒ ฺฉู ูโุฎูุงูุฏ ุจุฑุฑุณ ฺฉูุฏ.

---

### ๐ Enumerating the Available Counters

ฺฉุฏ ุฒุฑ ูููโ **performance counters** ููุฌูุฏ ุฏุฑ ุณุณุชู ุฑุง ูพูุงุด ูโฺฉูุฏ. ุงฺฏุฑ ุฏุณุชูโุง **instance** ุฏุงุดุชู ุจุงุดุฏุ ฺฉุงูุชุฑูุง ูุฑุจูุท ุจู ูุฑ instance ูุฒ ุจุฑุฑุณ ูโุดููุฏ:

```csharp
PerformanceCounterCategory[] cats =
    PerformanceCounterCategory.GetCategories();

foreach (PerformanceCounterCategory cat in cats)
{
    Console.WriteLine("Category: " + cat.CategoryName);
    string[] instances = cat.GetInstanceNames();

    if (instances.Length == 0)
    {
        foreach (PerformanceCounter ctr in cat.GetCounters())
            Console.WriteLine("  Counter: " + ctr.CounterName);
    }
    else   // Dump counters with instances
    {
        foreach (string instance in instances)
        {
            Console.WriteLine("  Instance: " + instance);
            if (cat.InstanceExists(instance))
                foreach (PerformanceCounter ctr in cat.GetCounters(instance))
                    Console.WriteLine("    Counter: " + ctr.CounterName);
        }
    }
}
```

๐ ุฎุฑูุฌ ุงู ฺฉุฏ ุจุด ุงุฒ **ฑฐูฌฐฐฐ ุฎุท** ุฎูุงูุฏ ุจูุฏ!
ููฺูู ุงุฌุฑุง ุขู ฺฉู ุทูู ูโฺฉุดุฏุ ฺูู ูุชุฏ **PerformanceCounterCategory.InstanceExists** ูพุงุฏูโุณุงุฒ ฺฉุงุฑุขูุฏ ูุฏุงุฑุฏ.
ุฏุฑ ฺฉ ุณุณุชู ูุงูุนุ ุจูุชุฑ ุงุณุช ุงุทูุงุนุงุช ุฌุฒุฆโุชุฑ ุฑุง ููุท ุฏุฑ ุตูุฑุช ูุงุฒ ุฏุฑุงูุช ฺฉูุฏ.

---

### ๐ ุงุณุชุฎุฑุงุฌ ููุท Performance Counters ูุฑุจูุท ุจู .NET

ููููู ฺฉุฏ ุฒุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ **LINQ** ููุท ฺฉุงูุชุฑูุง ูุฑุจูุท ุจู **.NET** ุฑุง ูุงฺฉุด ฺฉุฑุฏู ู ูุชุฌู ุฑุง ุฏุฑ ฺฉ ูุงู XML ุฐุฎุฑู ูโฺฉูุฏ:

```csharp
var x =
  new XElement("counters",
    from PerformanceCounterCategory cat in
         PerformanceCounterCategory.GetCategories()
    where cat.CategoryName.StartsWith(".NET")
    let instances = cat.GetInstanceNames()
    select new XElement("category",
      new XAttribute("name", cat.CategoryName),
      instances.Length == 0
        ? from c in cat.GetCounters()
          select new XElement("counter",
            new XAttribute("name", c.CounterName))
        : from i in instances
          select new XElement("instance", new XAttribute("name", i),
            !cat.InstanceExists(i)
              ? null
              : from c in cat.GetCounters(i)
                select new XElement("counter",
                  new XAttribute("name", c.CounterName))
        )
    )
  );

x.Save("counters.xml");
```

### ๐ **ุฎูุงูุฏู ุฏุงุฏูโูุง Performance Counter**

ุจุฑุง ฺฏุฑูุชู ููุฏุงุฑ ฺฉ **performance counter** ุจุงุฏ ฺฉ ุดุก ุงุฒ ฺฉูุงุณ **PerformanceCounter** ุจุณุงุฒุฏ ู ุณูพุณ ฺฉ ุงุฒ ูุชุฏูุง ุฒุฑ ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ:

* **NextValue** โ ฺฉ ููุฏุงุฑ ุณุงุฏู ุงุฒ ููุน `float` ุจุฑูโฺฏุฑุฏุงูุฏ.
* **NextSample** โ ฺฉ ุดุก ุงุฒ ููุน `CounterSample` ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ุดุงูู ูฺฺฏโูุง ูพุดุฑูุชูโุชุฑ ูุซู `CounterFrequency`ุ `TimeStamp`ุ `BaseValue` ู `RawValue` ุงุณุช.

---

#### ๐ฅ๏ธ ููููู: ููุงุด ูุตุฑู CPU

ฺฉุงูุณุชุฑุงฺฉุชูุฑ ฺฉูุงุณ **PerformanceCounter** ุณู ูพุงุฑุงูุชุฑ ูโฺฏุฑุฏ:

* ูุงู **category**
* ูุงู **counter**
* ฺฉ **instance** ุงุฎุชุงุฑ

ุจุฑุง ููุงุด ุฏุฑุตุฏ ุงุณุชูุงุฏูโ ูพุฑุฏุงุฒูุฏู (CPU) ุฑู ูููโ ูุณุชูโูุง:

```csharp
using PerformanceCounter pc = new PerformanceCounter(
    "Processor",
    "% Processor Time",
    "_Total");

Console.WriteLine(pc.NextValue());
```

---

#### ๐พ ููููู: ููุงุด ูุตุฑู ูุงูุน ุญุงูุธูโ ุฎุตูุต ูพุฑุฏุงุฒุด ุฌุงุฑ

```csharp
string procName = Process.GetCurrentProcess().ProcessName;

using PerformanceCounter pc = new PerformanceCounter(
    "Process",
    "Private Bytes",
    procName);

Console.WriteLine(pc.NextValue());
```

---

### ๐ ูุงูุชูุฑูฺฏ ุชุบุฑุงุช (Polling)

ฺฉูุงุณ **PerformanceCounter** ุฑูุฏุงุฏ **ValueChanged** ูุฏุงุฑุฏ. ุจูุงุจุฑุงู ุจุฑุง ูุงูุชูุฑูฺฏ ุชุบุฑุงุช ุจุงุฏ **polling** ุงูุฌุงู ุฏูุฏ.
ุฏุฑ ูุซุงู ุฒุฑุ ูุฑ **ฒฐฐ ููโุซุงูู** ููุฏุงุฑ ุจุฑุฑุณ ูโุดูุฏ ุชุง ุฒูุงู ฺฉู ุจุง **EventWaitHandle** ุณฺฏูุงู ุชููู ุงุฑุณุงู ุดูุฏ:

```csharp
// ูุงุฒููุฏ import ฺฉุฑุฏู System.Threading ู System.Diagnostics
static void Monitor(string category, string counter, string instance,
                   EventWaitHandle stopper)
{
    if (!PerformanceCounterCategory.Exists(category))
        throw new InvalidOperationException("Category does not exist");

    if (!PerformanceCounterCategory.CounterExists(counter, category))
        throw new InvalidOperationException("Counter does not exist");

    if (instance == null) instance = "";   // "" == ุจุฏูู instance (ูู null!)

    if (instance != "" &&
        !PerformanceCounterCategory.InstanceExists(instance, category))
        throw new InvalidOperationException("Instance does not exist");

    float lastValue = 0f;

    using (PerformanceCounter pc = new PerformanceCounter(category, counter, instance))
        while (!stopper.WaitOne(200, false))
        {
            float value = pc.NextValue();
            if (value != lastValue)   // ููุท ุงฺฏุฑ ุชุบุฑ ฺฉูุฏ ููุงุด ุฏุงุฏู ูโุดูุฏ
            {
                Console.WriteLine(value);
                lastValue = value;
            }
        }
}
```

---

#### โ๏ธ ุงุฌุฑุง ููุฒูุงู ุจุฑุง CPU ู ุฏุณฺฉ

```csharp
EventWaitHandle stopper = new ManualResetEvent(false);

new Thread(() =>
    Monitor("Processor", "% Processor Time", "_Total", stopper)
).Start();

new Thread(() =>
    Monitor("LogicalDisk", "% Idle Time", "C:", stopper)
).Start();

Console.WriteLine("Monitoring - press any key to quit");
Console.ReadKey();

stopper.Set();
```

---

### ๐๏ธ ุงุฌุงุฏ ฺฉุงูุชุฑ ู ููุดุชู ุฏุงุฏู ุฏุฑ Performance Counter

ูุจู ุงุฒ ููุดุชู ุฏุงุฏู ุจุงุฏ:

1. ฺฉ **category** ุจุณุงุฒุฏ.
2. ูููโ **counters** ูุฑุจูุท ุจู ุขู ุฏุณุชู ุฑุง **ุฏุฑ ฺฉ ูุฑุญูู** ุชุนุฑู ฺฉูุฏ.

ูุซุงู:

```csharp
string category = "Nutshell Monitoring";
// ุฏู ฺฉุงูุชุฑ ุฏุฑ ุงู ุฏุณุชู ุชุนุฑู ูโฺฉูู
string eatenPerMin = "Macadamias eaten so far";
string tooHard = "Macadamias deemed too hard";

if (!PerformanceCounterCategory.Exists(category))
{
    CounterCreationDataCollection cd = new CounterCreationDataCollection();

    cd.Add(new CounterCreationData(
        eatenPerMin,
        "Number of macadamias consumed, including shelling time",
        PerformanceCounterType.NumberOfItems32));

    cd.Add(new CounterCreationData(
        tooHard,
        "Number of macadamias that will not crack, despite much effort",
        PerformanceCounterType.NumberOfItems32));

    PerformanceCounterCategory.Create(
        category,
        "Test Category",
        PerformanceCounterCategoryType.SingleInstance,
        cd);
}
```

๐ ุงู ฺฉุงูุชุฑูุง ุจุนุฏ ุงุฒ ุงุฌุงุฏุ ุฏุฑ ุงุจุฒุงุฑ ูุงูุชูุฑูฺฏ Windows Performance ุธุงูุฑ ูโุดููุฏ (ฺฏุฒููโ **Add Counters**).
ุงฺฏุฑ ุจุฎูุงูุฏ ุจุนุฏูุง ฺฉุงูุชุฑูุง ุจุดุชุฑ ุงุถุงูู ฺฉูุฏุ ุจุงุฏ ุงูู **ฺฉู category ุฑุง ุญุฐู** ฺฉูุฏ (`PerformanceCounterCategory.Delete`).

โ๏ธ ุงุฌุงุฏ ู ุญุฐู performance counters ูุงุฒููุฏ **ุฏุณุชุฑุณ administrator** ุงุณุชุ ู ูุนูููุงู ุงู ฺฉุงุฑ ุฏุฑ ุฒูุงู ูุตุจ ุจุฑูุงูู ุงูุฌุงู ูโุดูุฏ.

---

### โ๏ธ ููุดุชู ููุฏุงุฑ ุฏุฑ Counter

ุจุนุฏ ุงุฒ ุงุฌุงุฏ ฺฉ ฺฉุงูุชุฑุ ูโุชูุงูุฏ ููุฏุงุฑ ุขู ุฑุง ุชุบุฑ ุฏูุฏ. ฺฉุงู ุงุณุช ฺฉ ุดุก **PerformanceCounter** ุจุณุงุฒุฏุ ูฺฺฏ **ReadOnly** ุฑุง `false` ฺฉูุฏ ู ุณูพุณ ููุฏุงุฑ **RawValue** ุง ูุชุฏูุง **Increment / IncrementBy** ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ:

```csharp
string category = "Nutshell Monitoring";
string eatenPerMin = "Macadamias eaten so far";

using (PerformanceCounter pc = new PerformanceCounter(category, eatenPerMin, ""))
{
    pc.ReadOnly = false;

    pc.RawValue = 1000;
    pc.Increment();
    pc.IncrementBy(10);

    Console.WriteLine(pc.NextValue());    // ุฎุฑูุฌ: 1011
}
```

---

โจ ุจู ุงู ุชุฑุชุจ ูโุชูุงูู ูู ููุงุฏุฑ **performance counters** ุฑุง ุจุฎูุงูู ู ูู ฺฉุงูุชุฑูุง ุงุฎุชุตุงุต ุฎูุฏูุงู ุฑุง ุงุฌุงุฏ ู ููุฏุงุฑุฏู ฺฉูู.

### ฺฉูุงุณ Stopwatch โฑ๏ธ

ฺฉูุงุณ **Stopwatch** ฺฉ ูฺฉุงูุฒู ุฑุงุญุช ุจุฑุง ุงูุฏุงุฒูโฺฏุฑ ุฒูุงู ุงุฌุฑุง ฺฉุฏ ูุฑุงูู ูโฺฉูุฏ. ุงู ฺฉูุงุณ ุงุฒ **ุจุงูุงุชุฑู ุฏูุช** ฺฉู ุณุณุชูโุนุงูู ู ุณุฎุชโุงูุฒุงุฑ ุงุฑุงุฆู ูโุฏููุฏ ุงุณุชูุงุฏู ูโฺฉูุฏ (ูุนูููุงู ฺฉูุชุฑ ุงุฒ ฺฉ ูฺฉุฑูุซุงูู).
๐น ุฏุฑ ููุงุจูุ `DateTime.Now` ู `Environment.TickCount` ุฏูุช ุญุฏูุฏ **ฑต ููโุซุงูู** ุฏุงุฑูุฏ.

ุจุฑุง ุงุณุชูุงุฏู:

* ูโุชูุงูุฏ ุจุง `StartNew` ฺฉ Stopwatch ุงุฌุงุฏ ฺฉุฑุฏู ู ุจูุงูุงุตูู ุดุฑูุน ุจู ฺฉุงุฑ ฺฉูุฏ.
* ุง ุฏุณุช ููููู ุจุณุงุฒุฏ ู ุณูพุณ `Start` ุฑุง ุตุฏุง ุจุฒูุฏ.

ูฺฺฏ `Elapsed` ฺฉ **TimeSpan** ุจุฑูโฺฏุฑุฏุงูุฏ:

```csharp
Stopwatch s = Stopwatch.StartNew();
System.IO.File.WriteAllText("test.txt", new string('*', 30000000));
Console.WriteLine(s.Elapsed);    // 00:00:01.4322661
```

๐น ูฺฺฏโูุง ุฏฺฏุฑ:

* `ElapsedTicks` โ ุชุนุฏุงุฏ ุชฺฉโูุง ฺฏุฐุดุชู (long).
* `ElapsedMilliseconds` โ ุฒูุงู ฺฏุฐุดุชู ุจู ููโุซุงูู (ูุนูููุงู ุฑุงุญุชโุชุฑู).
* ุจุฑุง ุชุจุฏู ุชฺฉโูุง ุจู ุซุงูู: `ticks / Stopwatch.Frequency`.

ูุฑุงุฎูุงู `Stop` ุจุงุนุซ ูุฑุฒ ุดุฏู `Elapsed` ู `ElapsedTicks` ูโุดูุฏ.
โ ุชูุฌู: ุญุช ููุช Stopwatch ุฏุฑ ุญุงู ุงุฌุฑุงุณุชุ ูฺ ูุนุงูุช ูพุณโุฒูููโุง ุงุถุงูู ุงุฌุงุฏ ููโฺฉูุฏุ ูพุณ `Stop` ุงุฎุชุงุฑ ุงุณุช.

---

### ุงุจุฒุงุฑูุง ุชุดุฎุต ฺฉุฑุงุณโูพูุชูุฑู ๐ง๐

ุฏุฑ ุงู ุจุฎุดุ ุงุจุฒุงุฑูุง ุชุดุฎุต ูุงุจู ุงุณุชูุงุฏู ุฏุฑ ููู ูพูุชูุฑูโูุง (.NET) ูุนุฑู ูโุดููุฏ:

* **dotnet-counters** โ ุงุฑุงุฆู ููุง ฺฉู ุงุฒ ูุถุนุช ฺฉ ุงูพูฺฉุดู ุฏุฑ ุญุงู ุงุฌุฑุง (ุญุงูุธู ู CPU).
* **dotnet-trace** โ ูุงูุชูุฑูฺฏ ุฏููโุชุฑ ุนููฺฉุฑุฏ ู ุฑูุฏุงุฏูุง.
* **dotnet-dump** โ ฺฏุฑูุชู *memory dump* ููฺฏุงู ูุงุฒ ุง ุจุนุฏ ุงุฒ ฺฉุฑุด.

๐ ุงู ุงุจุฒุงุฑูุง ูุงุฒ ุจู ุฏุณุชุฑุณ ุงุฏูู ูุฏุงุฑูุฏ ู ูู ุจุฑุง ุชูุณุนู ู ูู ูุญุท ุนููุงุช ููุงุณุจ ูุณุชูุฏ.

---

### ุงุจุฒุงุฑ dotnet-counters ๐

ุงุจุฒุงุฑ **dotnet-counters** ูุตุฑู ุญุงูุธู ู CPU ฺฉ ูพุฑูุณู .NET ุฑุง ูุงูุชูุฑ ฺฉุฑุฏู ู ุฏุงุฏูโูุง ุฑุง ุฏุฑ ฺฉูุณูู (ุง ูุงู) ููุงุด ูโุฏูุฏ.

#### ูุตุจ

```bash
dotnet tool install --global dotnet-counters
```

#### ูุงูุชูุฑ ฺฉุฑุฏู ฺฉ ูพุฑูุณู

```bash
dotnet-counters monitor System.Runtime --process-id <<ProcessID>>
```

* `System.Runtime` ุนู ูููโ ฺฉุงูุชุฑูุง ุฏุณุชู **System.Runtime** ุฑุง ูุงูุชูุฑ ฺฉูู.
* ูโุชูุงูุฏ ุฏุณุชู ุง ูุงู ฺฉุงูุชุฑ ุฎุงุต ุจุฏูุฏ.
* ุฏุณุชูุฑ `dotnet-counters list` ููู ุฏุณุชูโูุง ู ฺฉุงูุชุฑูุง ููุฌูุฏ ุฑุง ูุณุช ูโฺฉูุฏ.

---

### ุฎุฑูุฌ ููููู ๐

(ุจูโุตูุฑุช ูุฏุงูู ุขูพุฏุช ูโุดูุฏ)

```
Press p to pause, r to resume, q to quit.
   Status: Running
[System.Runtime]
   # of Assemblies Loaded                            63
   % Time in GC (since last GC)                       0
   Allocation Rate (Bytes / sec)                244,864
   CPU Usage (%)                                      6
   Exceptions / sec                                   0
   GC Heap Size (MB)                                  8
   Gen 0 GC / sec                                     0
   Gen 0 Size (B)                               265,176
   Gen 1 GC / sec                                     0
   Gen 1 Size (B)                               451,552
   Gen 2 GC / sec                                     0
   Gen 2 Size (B)                                    24
   LOH Size (B)                               3,200,296
   Monitor Lock Contention Count / sec                0
   Number of Active Timers                            0
   ThreadPool Completed Work Items / sec             15
   ThreadPool Queue Length                            0
   ThreadPool Threads Count                           9
   Working Set (MB)                                  52
```

**ูููโ ุฏุณุชูุฑุงุช ููุฌูุฏ:**
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/13/Table-13-1.jpeg)
</div>

ูพุงุฑุงูุชุฑูุง ุฒุฑ ูพุดุชุจุงู ูโุดููุฏ:

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/13/Table-13-2.jpeg)
</div>

dotnet-trace
ุฑุฏุงุจโูุง (Traces) ุณูุงุจู ุฒูุงูโุจูุฏโุดุฏูโุง ุงุฒ ุฑูุฏุงุฏูุง ุฏุฑ ุจุฑูุงูู ุดูุง ูุณุชูุฏุ ูุงููุฏ ูุฑุงุฎูุงู ฺฉ ูุชุฏ ุง ุงุฌุฑุง ฺฉ ูพุฑุณโูุฌู ูพุงฺฏุงู ุฏุงุฏู. ุฑุฏุงุจโูุง ูโุชูุงููุฏ ุดุงูู ูุนุงุฑูุง ุนููฺฉุฑุฏ ู ุฑูุฏุงุฏูุง ุณูุงุฑุด ูุฒ ุจุงุดูุฏ ู ูโุชูุงููุฏ ุงุทูุงุนุงุช ูุญู ูุงููุฏ ููุงุฏุฑ ูุชุบุฑูุง ูุญู ุฑุง ูุฒ ุฏุฑ ุจุฑ ุจฺฏุฑูุฏ. ุจู ุทูุฑ ุณูุชุ .NET Framework ู ูุฑูโูุฑฺฉโูุง ูุงููุฏ ASP.NET ุงุฒ ETW ุงุณุชูุงุฏู ูโฺฉุฑุฏูุฏ. ุฏุฑ .NET 5ุ ุฑุฏุงุจโูุง ุจุฑูุงูู ููฺฏุงู ุงุฌุฑุง ุฑู ููุฏูุฒ ุฏุฑ ETW ู ุฑู ูููฺฉุณ ุฏุฑ LTTng ููุดุชู ูโุดููุฏ.

ุจุฑุง ูุตุจ ุงู ุงุจุฒุงุฑุ ุฏุณุชูุฑ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:

```
dotnet tool install --global dotnet-trace
```

ุจุฑุง ุดุฑูุน ุถุจุท ุฑูุฏุงุฏูุง ฺฉ ุจุฑูุงููุ ุฏุณุชูุฑ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:

```
dotnet-trace collect --process-id <<ProcessId>>
```

ุงู ุฏุณุชูุฑ dotnet-trace ุฑุง ุจุง ูพุฑููุงู ูพุดโูุฑุถ ุงุฌุฑุง ูโฺฉูุฏ ฺฉู ุฑูุฏุงุฏูุง CPU ู ุฒูุงู ุงุฌุฑุง .NET ุฑุง ุฌูุนโุขูุฑ ฺฉุฑุฏู ู ุฏุฑ ูุงู ุจู ูุงู `trace.nettrace` ุฐุฎุฑู ูโฺฉูุฏ. ูโุชูุงูุฏ ุจุง ฺฏุฒูู `--profile` ูพุฑููุงูโูุง ุฏฺฏุฑ ุฑุง ูุดุฎุต ฺฉูุฏ:

* `gc-verbose` ุฑุฏุงุจ ุฌูุนโุขูุฑ ุฒุจุงูู ู ุชุฎุตุต ูููููโุง ุงุดุง ุฑุง ุงูุฌุงู ูโุฏูุฏ.
* `gc-collect` ุฌูุนโุขูุฑ ุฒุจุงูู ุฑุง ุจุง ุณุฑุจุงุฑ ฺฉู ุฑุฏุงุจ ูโฺฉูุฏ.

ฺฏุฒูู `-o` ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ูุงู ูุงู ุฎุฑูุฌ ูุชูุงูุช ูุดุฎุต ฺฉูุฏ.

ุฎุฑูุฌ ูพุดโูุฑุถ ฺฉ ูุงู `.netperf` ุงุณุช ฺฉู ูโุชูุงู ุขู ุฑุง ูุณุชููุงู ุฏุฑ ููุฏูุฒ ุจุง ุงุจุฒุงุฑ **PerfView** ุชุญูู ฺฉุฑุฏ. ููฺูู ูโุชูุงูุฏ dotnet-trace ุฑุง ูุงุฏุงุฑ ฺฉูุฏ ูุงู ุณุงุฒฺฏุงุฑ ุจุง **Speedscope** ุงุฌุงุฏ ฺฉูุฏุ ฺฉู ฺฉ ุณุฑูุณ ุชุญูู ุขููุงู ุฑุงฺฏุงู ุฏุฑ [https://speedscope.app](https://speedscope.app) ุงุณุช. ุจุฑุง ุงุฌุงุฏ ูุงู Speedscope (`.speedscope.json`) ุงุฒ ฺฏุฒูู `--format speedscope` ุงุณุชูุงุฏู ฺฉูุฏ.

ุขุฎุฑู ูุณุฎู PerfView ุฑุง ูโุชูุงูุฏ ุงุฒ [https://github.com/microsoft/perfview](https://github.com/microsoft/perfview) ุฏุงูููุฏ ฺฉูุฏ. ูุณุฎูโุง ฺฉู ุจุง ููุฏูุฒ 10 ุนุฑุถู ูโุดูุฏ ููฺฉู ุงุณุช ุงุฒ ูุงูโูุง `.netperf` ูพุดุชุจุงู ูฺฉูุฏ.

ุฏุณุชูุฑุงุช ุฒุฑ ูพุดุชุจุงู ูโุดููุฏ:
<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/13/Table-13-3.jpeg)
</div>

### ุฑูุฏุงุฏูุง ุณูุงุฑุด Trace ๐ฏ

ุจุฑูุงูู ุดูุง ูโุชูุงูุฏ ุจุง ุชุนุฑู ฺฉ **EventSource** ุณูุงุฑุดุ ุฑูุฏุงุฏูุง ุงุฎุชุตุงุต ุชููุฏ ฺฉูุฏ:

```csharp
[EventSource(Name = "MyTestSource")]
public sealed class MyEventSource : EventSource
{
    public static MyEventSource Instance = new MyEventSource();

    MyEventSource() : base(EventSourceSettings.EtwSelfDescribingEventFormat)
    {
    }

    public void Log(string message, int someNumber)
    {
        WriteEvent(1, message, someNumber);
    }
}
```

ูุชุฏ **WriteEvent** ุฏุงุฑุง ฺูุฏ ูุณุฎู (Overload) ุงุณุช ู ูโุชูุงูุฏ ุชุฑฺฉุจโูุง ูุฎุชูู ุงุฒ ุงููุงุน ุณุงุฏู (ุจูโูฺู ุฑุดุชูโูุง ู ุงุนุฏุงุฏ ุตุญุญ) ุฑุง ุจูพุฐุฑุฏ. ุณูพุณ ูโุชูุงูุฏ ุจู ุงู ุตูุฑุช ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
MyEventSource.Instance.Log("Something", 123);
```

ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ **dotnet-trace**ุ ุจุงุฏ ูุงู ูุฑ ููุจุน ุฑูุฏุงุฏ ุณูุงุฑุด ฺฉู ูโุฎูุงูุฏ ุซุจุช ุดูุฏ ุฑุง ูุดุฎุต ฺฉูุฏ:

```bash
dotnet-trace collect --process-id <<ProcessId>> --providers MyTestSource
```

---

### dotnet-dump ๐พ

ฺฉ **Dump**ุ ฺฉู ฺฏุงู ุจู ุขู **Core Dump** ูู ฺฏูุชู ูโุดูุฏุ ุชุตูุฑ ุงุฒ ูุถุนุช ุญุงูุธู ูุฌุงุฒ ฺฉ ูพุฑุฏุงุฒุด ุงุณุช. ุดูุง ูโุชูุงูุฏ ฺฉ ูพุฑุฏุงุฒุด ุฏุฑ ุญุงู ุงุฌุฑุง ุฑุง ุจูโุตูุฑุช ุฏุณุช Dump ฺฉูุฏ ุง ุณุณุชูโุนุงูู ุฑุง ุชูุธู ฺฉูุฏ ุชุง ููฺฏุงู ฺฉุฑุด ุจุฑูุงููุ ุงู Dump ุชููุฏ ุดูุฏ.

#### ุฏุฑ ุงูุจููุชู ูููฺฉุณ

ุจุฑุง ูุนุงู ฺฉุฑุฏู Core Dump ููฺฏุงู ฺฉุฑุด ุจุฑูุงูู:

```bash
ulimit -c unlimited
```

(ูุฑุงุญู ููฺฉู ุงุณุช ุจุณุชู ุจู ุชูุฒุน ูููฺฉุณ ูุชูุงูุช ุจุงุดุฏ)

#### ุฏุฑ ููุฏูุฒ

ุงุฒ **regedit.exe** ุจุฑุง ุงุฌุงุฏ ุง ูุฑุงุด ฺฉูุฏ ุฒุฑ ุฏุฑ Hive ูุฑุจูุท ุจู Local Machine ุงุณุชูุงุฏู ฺฉูุฏ:

```
SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps
```

ุฒุฑ ุงู ูุณุฑุ ฺฉ ฺฉูุฏ ุจุง ูุงู ููุงู ูุงู ุงุฌุฑุง ุฎูุฏ ุงุถุงูู ฺฉูุฏ (ูุซูุงู `foo.exe`) ู ุณูพุณ ฺฉูุฏูุง ุฒุฑ ุฑุง ุงุถุงูู ููุงุฏ:

* **DumpFolder (REG\_EXPAND\_SZ):** ูุณุฑ ุฐุฎุฑู ูุงูโูุง Dump
* **DumpType (REG\_DWORD):** ููุฏุงุฑ ฒ ุจุฑุง ุฏุฑุฎูุงุณุช Full Dump
* **(ุงุฎุชุงุฑ) DumpCount (REG\_DWORD):** ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ูุงูโูุง Dump ูุจู ุงุฒ ุญุฐู ูุฏูโุชุฑู ุขูโูุง

ุจุฑุง ูุตุจ ุงุจุฒุงุฑุ ุฏุณุชูุฑ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:

```bash
dotnet tool install --global dotnet-dump
```

ูพุณ ุงุฒ ูุตุจุ ูโุชูุงูุฏ ฺฉ Dump ุจูโุตูุฑุช ุฏุณุช ุงุฌุงุฏ ฺฉูุฏ (ุจุฏูู ุชููู ูพุฑุฏุงุฒุด):

```bash
dotnet-dump collect --process-id <<YourProcessId>>
```

ุจุฑุง ุดุฑูุน ฺฉ **Interactive Shell** ุฌูุช ุชุญูู ูุงู Dump:

```bash
dotnet-dump analyze <<dumpfile>>
```

ุงฺฏุฑ ฺฉ Exception ุจุงุนุซ ฺฉุฑุด ุจุฑูุงูู ุดุฏู ุจุงุดุฏุ ูโุชูุงูุฏ ุงุฒ ุฏุณุชูุฑ **printexceptions** (ุง ฺฉูุชุงู ุดุฏู ุขู **pe**) ุจุฑุง ููุงุด ุฌุฒุฆุงุช Exception ุงุณุชูุงุฏู ฺฉูุฏ.
Shell ุงุจุฒุงุฑ **dotnet-dump** ุฏุณุชูุฑุงุช ูุชุนุฏุฏ ุฏุงุฑุฏ ฺฉู ูโุชูุงูุฏ ุจุง ุฏุณุชูุฑ **help** ูุณุช ฺฉุงูู ุขูโูุง ุฑุง ูุดุงูุฏู ฺฉูุฏ.
