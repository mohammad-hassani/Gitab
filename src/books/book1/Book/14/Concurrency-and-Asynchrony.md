---
layout: layout.njk
title: ููโุฒูุงู ู ูุงููโุฒูุงู
---
# ูุตู ฺูุงุฑุฏูู: ููโุฒูุงู ู ูุงููโุฒูุงู

ุจุดุชุฑ ุจุฑูุงููโูุง ูุงุฒ ุฏุงุฑูุฏ ุจุง ุจุด ุงุฒ ฺฉ ุฑูุฏุงุฏ ฺฉู ุจูโุทูุฑ ููโุฒูุงู ุฑุฎ ูโุฏูุฏ ุณุฑูฺฉุงุฑ ุฏุงุดุชู ุจุงุดูุฏ (ููโุฒูุงู ุง **Concurrency**).
ุฏุฑ ุงู ูุตูุ ูุง ุจุง ูพุดโูุงุฒูุง ุถุฑูุฑ ุดุฑูุน ูโฺฉููุ ุนู ูุจุงู **Threading** (ุงุฌุงุฏ ู ูุฏุฑุช ุฑุดุชูโูุง) ู **Tasks** (ูุธุงู)ุ ู ุณูพุณ ุงุตูู **Asynchrony** (ูุงููโุฒูุงู) ู ุชูุงุจุน ูุงููโุฒูุงู ุฏุฑ #C ุฑุง ุจุง ุฌุฒุฆุงุช ุชูุถุญ ูโุฏูู.

ุฏุฑ **ูุตู ฒฑ** ุฏูุจุงุฑู ุจู ููุถูุน **Multithreading** (ฺูุฏโุฑุดุชูโุง) ุจุง ุฌุฒุฆุงุช ุจุดุชุฑ ุจุฑูโฺฏุฑุฏู ู ุฏุฑ **ูุตู ฒฒ** ููุถูุน ูุฑุชุจุท ุนู **Parallel Programming** (ุจุฑูุงููโููุณ ููุงุฒ) ุฑุง ูพูุดุด ูโุฏูู.

---

## ๐น ููุฏูู

ุฏุฑ ุงุฏุงูู ุฑุงุฌโุชุฑู ุณูุงุฑููุง ููโุฒูุงู ุขูุฑุฏู ุดุฏู ุงุณุช:

### ๐ฅ๏ธ ููุดุชู ฺฉ ุฑุงุจุท ฺฉุงุฑุจุฑ ูพุงุณุฎโฺฏู

ุฏุฑ ุจุฑูุงููโูุง **WPF**ุ ููุจุงู ู **Windows Forms** ุจุงุฏ ฺฉุงุฑูุง ุฒูุงูโุจุฑ ุฑุง ุจูโุตูุฑุช ููโุฒูุงู ุจุง ฺฉุฏ ฺฉู ุฑุงุจุท ฺฉุงุฑุจุฑ ุดูุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ุงูุฌุงู ุฏูุฏ ุชุง ุฑุงุจุท ฺฉุงุฑุจุฑ ููฺูุงู ูพุงุณุฎโฺฏู ุจุงู ุจูุงูุฏ.

### ๐ ูพุฑุฏุงุฒุด ููโุฒูุงู ุฏุฑุฎูุงุณุชโูุง

ุฑู ฺฉ ุณุฑูุฑุ ุฏุฑุฎูุงุณุชโูุง ฺฉูุงูุช ูโุชูุงููุฏ ุจูโุทูุฑ ููโุฒูุงู ุจุฑุณูุฏ ู ุจูุงุจุฑุงู ุจุงุฏ ุจูโุตูุฑุช ููุงุฒ ูพุฑุฏุงุฒุด ุดููุฏ ุชุง **Scalability** (ููุงุณโูพุฐุฑ) ุญูุธ ุดูุฏ. ุงฺฏุฑ ุงุฒ **ASP.NET Core** ุง **Web API** ุงุณุชูุงุฏู ฺฉูุฏุ ุฒูุงูโุงุฌุฑุง (Runtime) ุงู ฺฉุงุฑ ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุจุฑุง ุดูุง ุงูุฌุงู ูโุฏูุฏ.
ุจุงุงูโุญุงูุ ููฺูุงู ุจุงุฏ ูุณุจุช ุจู **Shared State** (ูุถุนุช ูุดุชุฑฺฉ) ุขฺฏุงู ุจุงุดุฏ (ุจุฑุง ูููููุ ุงุซุฑ ุงุณุชูุงุฏู ุงุฒ **Static Variables** ุจุฑุง ฺฉุดโฺฉุฑุฏู).

### โก ุจุฑูุงููโููุณ ููุงุฒ

ฺฉุฏ ฺฉู ูุญุงุณุจุงุช ุณูฺฏู ุงูุฌุงู ูโุฏูุฏ ูโุชูุงูุฏ ุฑู ุฑุงุงููโูุง ฺูุฏโูุณุชูโุง ุง ฺูุฏโูพุฑุฏุงุฒูุฏูโุง ุณุฑุนโุชุฑ ุงุฌุฑุง ุดูุฏุ ุงฺฏุฑ ุญุฌู ฺฉุงุฑ ูุงู ูุณุชูโูุง ุชูุณู ุดูุฏ. (ูุตู ฒฒ ุจูโุทูุฑ ฺฉุงูู ุจู ุงู ููุถูุน ุงุฎุชุตุงุต ุฏุงุฑุฏ.)

### ๐ฎ ุงุฌุฑุง ุญุฏุณ (Speculative Execution)

ุฑู ูุงุดูโูุง ฺูุฏโูุณุชูโุงุ ฺฏุงู ูโุชูุงู ุจุง ูพุดโุจู ฺฉุงุฑ ฺฉู ููฺฉู ุงุณุช ูุงุฒ ุจู ุงูุฌุงู ุขู ุจุงุดุฏ ู ุงูุฌุงู ุฏุงุฏู ุขู ุงุฒ ูุจูุ ุนููฺฉุฑุฏ ุฑุง ุจูุจูุฏ ุฏุงุฏ.
ุจุฑูุงูู **LINQPad** ุงุฒ ุงู ุชฺฉูฺฉ ุจุฑุง ุณุฑุนุชโุจุฎุดุฏู ุจู ุงุฌุงุฏ ฺฉูุฆุฑโูุง ุฌุฏุฏ ุงุณุชูุงุฏู ูโฺฉูุฏ.
ููุน ุฏฺฏุฑ ุงุฒ ุงู ุฑูุด ุงู ุงุณุช ฺฉู ฺูุฏ ุงูฺฏูุฑุชู ูุฎุชูู ุฑุง ุจูโุทูุฑ ููุงุฒ ุงุฌุฑุง ฺฉูุฏ ฺฉู ููฺฏ ฺฉ ูุธูู ูุดุงุจู ุฑุง ุญู ูโฺฉููุฏ. ูุฑฺฉุฏุงู ุฒูุฏุชุฑ ุชูุงู ุดูุฏ ยซุจุฑูุฏูยป ุฎูุงูุฏ ุจูุฏ. ุงู ุฑูุด ุฒูุงู ูุคุซุฑ ุงุณุช ฺฉู ุงุฒ ูุจู ูุฏุงูุฏ ฺฉุฏุงู ุงูฺฏูุฑุชู ุณุฑุนโุชุฑ ุนูู ุฎูุงูุฏ ฺฉุฑุฏ.

---

## ๐งต ูฺฉุงูุฒู ุนููู ููโุฒูุงู: Multithreading

ูฺฉุงูุฒู ุนูููโุง ฺฉู ุจู ฺฉ ุจุฑูุงูู ุงุฌุงุฒู ูโุฏูุฏ ุจูโุทูุฑ ููโุฒูุงู ฺฉุฏ ุฑุง ุงุฌุฑุง ฺฉูุฏุ **Multithreading** ูุงู ุฏุงุฑุฏ.
Multithreading ูู ุชูุณุท **CLR** ู ูู ุชูุณุท **ุณุณุชูโุนุงูู** ูพุดุชุจุงู ูโุดูุฏ ู ฺฉ ููููู ุจูุงุฏู ุฏุฑ ููโุฒูุงู ุงุณุช.
ุจูุงุจุฑุงู ุฏุฑฺฉ ูุจุงู **Threading**ุ ู ุจูโูฺู ุชุฃุซุฑ ุฑุดุชูโูุง ุจุฑ **Shared State** (ูุถุนุช ูุดุชุฑฺฉ)ุ ุถุฑูุฑ ุงุณุช.

---

## ๐งฉ Threading

ฺฉ **Thread** ุง ยซุฑุดุชูยปุ ฺฉ ูุณุฑ ุงุฌุฑุง ูุณุชูู ุงุณุช ฺฉู ูโุชูุงูุฏ ุฌุฏุง ุงุฒ ุณุงุฑ ูุณุฑูุง ูพุด ุจุฑูุฏ.

ูุฑ ุฑุดุชู ุฏุฑูู ฺฉ **Process** (ูุฑุงูุฏ) ุณุณุชูโุนุงูู ุงุฌุฑุง ูโุดูุฏ ฺฉู ูุญุท ุงุฒููู ุฑุง ุจุฑุง ุงุฌุฑุง ฺฉ ุจุฑูุงูู ูุฑุงูู ูโฺฉูุฏ.

* ุฏุฑ ฺฉ ุจุฑูุงูู **ุชฺฉโุฑุดุชูโุง** (Single-Threaded)ุ ุชููุง ฺฉ ุฑุดุชู ุฏุฑ ูุญุท ุงุฒููู ูพุฑุฏุงุฒุด ุงุฌุฑุง ูโุดูุฏ ู ุจูุงุจุฑุงู ุขู ุฑุดุชู ุฏุณุชุฑุณ ุงูุญุตุงุฑ ุจู ุขู ุฏุงุฑุฏ.
* ุฏุฑ ฺฉ ุจุฑูุงูู **ฺูุฏโุฑุดุชูโุง** (Multi-Threaded)ุ ฺูุฏ ุฑุดุชู ุฏุฑ ฺฉ ูุฑุงูุฏ ูุงุญุฏ ุงุฌุฑุง ูโุดููุฏ ู ฺฉ ูุญุท ุงุฌุฑุง ูุดุชุฑฺฉ (ุจูโูฺู ุญุงูุธู) ุฑุง ุจุง ูู ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏ.

ุงู ููุถูุน ุฏูู ุงุตู ููุฏ ุจูุฏู Multithreading ุงุณุช:
ุจุฑุง ูููููุ ฺฉ ุฑุดุชู ูโุชูุงูุฏ ุฏุฑ ูพุณโุฒููู ุฏุงุฏูโูุง ุฑุง ูุงฺฉุด ฺฉูุฏุ ุฏุฑุญุงูโฺฉู ุฑุดุชู ุฏฺฏุฑ ููุงู ุฏุงุฏูโูุง ุฑุง ุจูโูุญุถ ุฑุณุฏู ููุงุด ุฏูุฏ. ุงู ุฏุงุฏูโูุง ุจูโุนููุงู **Shared State** ุดูุงุฎุชู ูโุดููุฏ.

---

## ๐๏ธ ุงุฌุงุฏ ฺฉ Thread

ฺฉ ุจุฑูุงูู ฺฉูุงูุช (**Console**ุ **WPF**ุ **UWP** ุง **Windows Forms**) ุฏุฑ ฺฉ ุฑุดุชู ูููุฑุฏ ฺฉู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุชูุณุท ุณุณุชูโุนุงูู ุณุงุฎุชู ูโุดูุฏ (ุฑุดุชูโ ุงุตู ุง **Main Thread**) ุดุฑูุน ุจู ฺฉุงุฑ ูโฺฉูุฏ.
ุงู ุจุฑูุงูู ุชุง ุฒูุงู ฺฉู ุดูุง ฺฉุงุฑ ุฎูุงู ุขู ุงูุฌุงู ูุฏูุฏ (ุนู ุฑุดุชูโูุง ุจุดุชุฑ ุจุณุงุฒุฏุ ฺู ุจูโุทูุฑ ูุณุชูู ู ฺู ุบุฑูุณุชูู) ุจูโุตูุฑุช ุชฺฉโุฑุดุชูโุง ุจุงู ูโูุงูุฏ.ยน

ุจุฑุง ุงุฌุงุฏ ู ุดุฑูุน ฺฉ ุฑุดุชู ุฌุฏุฏุ ุจุงุฏ ฺฉ ุดุก ุงุฒ ููุน **Thread** ุจุณุงุฒุฏ ู ูุชุฏ **Start** ุขู ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.
ุณุงุฏูโุชุฑู ุณุงุฒูุฏู (Constructor) ุจุฑุง Threadุ ฺฉ **ThreadStart Delegate** ูโฺฏุฑุฏ: ูุชุฏ ุจุฏูู ูพุงุฑุงูุชุฑ ฺฉู ูุดุงู ูโุฏูุฏ ุงุฌุฑุง ุฑุดุชู ุงุฒ ฺฉุฌุง ุขุบุงุฒ ุดูุฏ.

### ๐ ูุซุงู

```csharp
// ุชูุฌู: ููู ูููููโูุง ุงู ูุตู ูุฑุถ ูโฺฉููุฏ ฺฉู Namespaceูุง ุฒุฑ Import ุดุฏูโุงูุฏ:
using System;
using System.Threading;

Thread t = new Thread (WriteY);     // ุงุฌุงุฏ ู ุฑุงูโุงูุฏุงุฒ ฺฉ ุฑุดุชู ุฌุฏุฏ
t.Start();                          // ุงุฌุฑุง ูุชุฏ WriteY ุฑู ุฑุดุชู ุฌุฏุฏ

// ููโุฒูุงูุ ุฑู ุฑุดุชู ุงุตู ูู ฺฉุงุฑ ุงูุฌุงู ูโุฏูู.
for (int i = 0; i < 1000; i++) Console.Write ("x");

void WriteY()
{
    for (int i = 0; i < 1000; i++) Console.Write ("y");
}
```

---

### ๐ค ุฎุฑูุฌ ููููู

```
xxxxxxxxxxxxxxxxyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
...
```

---

ุฑุดุชู ุงุตู ฺฉ ุฑุดุชู ุฌุฏุฏ ุจู ูุงู `t` ูโุณุงุฒุฏ ู ุฑู ุขู ูุชุฏ ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ฺฉู ฺฉุงุฑุงฺฉุชุฑ `y` ุฑุง ุจูโุทูุฑ ุชฺฉุฑุงุฑ ฺุงูพ ูโฺฉูุฏ.
ุจูโุทูุฑ ููโุฒูุงูุ ุฑุดุชู ุงุตู ูุฒ ฺฉุงุฑุงฺฉุชุฑ `x` ุฑุง ุจูโุทูุฑ ุชฺฉุฑุงุฑ ฺุงูพ ูโฺฉูุฏุ ููุงูโุทูุฑ ฺฉู ุฏุฑ ุดฺฉู **ฑด-ฑ** ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.

* ุฑู ฺฉ ุฑุงุงูู ุชฺฉโูุณุชูโุงุ ุณุณุชูโุนุงูู ุจุงุฏ ยซุจูุฑุดโูุงยป ุงุฒ ุฒูุงู (ูุนูููุงู ุญุฏูุฏ **ฒฐ ููโุซุงูู** ุฏุฑ ููุฏูุฒ) ุฑุง ุจู ูุฑ ุฑุดุชู ุงุฎุชุตุงุต ุฏูุฏ ุชุง ููโุฒูุงู ุดุจูโุณุงุฒ ุดูุฏ. ูุชุฌู ุงู ฺฉุงุฑุ ุจูุงฺฉโูุง ุชฺฉุฑุงุฑ ุงุฒ `x` ู `y` ุงุณุช.
* ุฑู ฺฉ ูุงุดู ฺูุฏโูุณุชูโุง ุง ฺูุฏโูพุฑุฏุงุฒูุฏูโุงุ ุฏู ุฑุดุชู ูโุชูุงููุฏ ูุงูุนุงู ุจูโุทูุฑ ููุงุฒ ุงุฌุฑุง ุดููุฏ (ุจุง ุงู ุดุฑุท ฺฉู ุฏฺฏุฑ ูพุฑุฏุงุฒูโูุง ูุนุงู ุฑู ุฑุงุงูู ูู ุฏุฑ ุฑูุงุจุช ุจุงุดูุฏ).
  ุจุงุงูโุญุงู ุฏุฑ ุงู ูุซุงู ููฺูุงู ุจูุงฺฉโูุง ุชฺฉุฑุงุฑ ุงุฒ `x` ู `y` ูุดุงูุฏู ูโฺฉูุฏุ ุฒุฑุง ุฌุฒุฆุงุช ุธุฑู ุฏุฑ ูฺฉุงูุฒู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู **Console** ุฏุฑุฎูุงุณุชโูุง ููโุฒูุงู ุฑุง ูุฏุฑุช ูโฺฉูุฏ.

<div align="center">

![Conventions-UsedThis-Book](../../../assets/image/14/Table-14-1.jpeg)
</div>

## ๐ ูพุดโุงูุชุงุฒุฏู (Preemption)

ููุช ุงุฌุฑุง ฺฉ **Thread** ุจุง ุงุฌุฑุง ฺฉุฏ ุฑู ฺฉ **Thread** ุฏฺฏุฑ ุฏุฑ ูู ุขูุฎุชู ูโุดูุฏุ ฺฏูุชู ูโุดูุฏ ฺฉู ุขู Thread **Preempted** (ูพุดโุงูุชุงุฒ ุฏุงุฏู ุดุฏู) ุงุณุช. ุงู ุงุตุทูุงุญ ุงุบูุจ ุฒูุงู ุธุงูุฑ ูโุดูุฏ ฺฉู ุจุฎูุงูู ุชูุถุญ ุฏูู ฺุฑุง ฺุฒ ุจูโุฏุฑุณุช ฺฉุงุฑ ูฺฉุฑุฏู ุงุณุช!

---

## ๐ข ูุถุนุช ุฒูุฏู ุจูุฏู (IsAlive)

ูพุณ ุงุฒ ุดุฑูุน ุดุฏูุ ูฺฺฏ (**Property**) `IsAlive` ุฏุฑ ฺฉ Thread ููุฏุงุฑ **true** ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ ุชุง ุฒูุงู ฺฉู ุขู Thread ูพุงุงู ุงุจุฏ.
ฺฉ Thread ุฒูุงู ูพุงุงู ูโุงุจุฏ ฺฉู **Delegate**ุง ฺฉู ุจู ุณุงุฒูุฏูโ (Constructor) ุขู ุฏุงุฏู ุดุฏูุ ุงุฌุฑุง ุฎูุฏ ุฑุง ุชูุงู ฺฉูุฏ. ูพุณ ุงุฒ ูพุงุงู ุงูุชูุ ฺฉ Thread ุฑุง ููโุชูุงู ุฏูุจุงุฑู ุฑุงูโุงูุฏุงุฒ ฺฉุฑุฏ.

---

## ๐ ูุงูโฺฏุฐุงุฑ Threadูุง

ูุฑ Thread ฺฉ ูฺฺฏ ุจู ูุงู **Name** ุฏุงุฑุฏ ฺฉู ูโุชูุงูุฏ ุขู ุฑุง ุจุฑุง ุงูุฏุงู **Debugging** ุชูุธู ฺฉูุฏ.
ุงู ูฺฺฏ ุฏุฑ **Visual Studio** ุจุณุงุฑ ููุฏ ุงุณุชุ ุฒุฑุง ูุงู Thread ุฏุฑ **Threads Window** ู ููุงุฑ ุงุจุฒุงุฑ **Debug Location** ููุงุด ุฏุงุฏู ูโุดูุฏ.
ุดูุง ุชููุง ฺฉโุจุงุฑ ูโุชูุงูุฏ ูุงู ฺฉ Thread ุฑุง ุชูุธู ฺฉูุฏุ ูุฑ ุชูุงุด ุฏฺฏุฑ ุจุฑุง ุชุบุฑ ูุงูุ ฺฉ **Exception** ุงุฌุงุฏ ุฎูุงูุฏ ฺฉุฑุฏ.

---

## ๐ ุฏุณุชุฑุณ ุจู Thread ูุนู

ูฺฺฏ ุงุณุชุงุชฺฉ `Thread.CurrentThread` ุฑุดุชูโุง ุฑุง ฺฉู ุฏุฑ ุญุงู ุญุงุถุฑ ุฏุฑ ุญุงู ุงุฌุฑุงุณุช ุจุฑูโฺฏุฑุฏุงูุฏ:

```csharp
Console.WriteLine (Thread.CurrentThread.Name);
```

---

## โณ Join ู Sleep

### ๐ Join

ูโุชูุงูุฏ ุจุง ูุฑุงุฎูุงู ูุชุฏ **Join** ููุชุธุฑ ุจูุงูุฏ ุชุง ฺฉ Thread ุฏฺฏุฑ ูพุงุงู ุงุจุฏ:

```csharp
Thread t = new Thread (Go);
t.Start();
t.Join();
Console.WriteLine ("Thread t has ended!");

void Go() 
{ 
    for (int i = 0; i < 1000; i++) Console.Write ("y"); 
}
```

ุงู ฺฉุฏ ุงุจุชุฏุง ฑฐฐฐ ุจุงุฑ `y` ฺุงูพ ูโฺฉูุฏ ู ุจูุงูุงุตูู ูพุณ ุงุฒ ุขู ูุชู `"Thread t has ended!"` ููุงุด ุฏุงุฏู ูโุดูุฏ.

ููฺูู ูโุชูุงูุฏ ููฺฏุงู ูุฑุงุฎูุงู **Join** ฺฉ **Timeout** ูุดุฎุต ฺฉูุฏ (ุจุฑุญุณุจ ููโุซุงูู ุง ฺฉ **TimeSpan**). ุฏุฑ ุงู ุตูุฑุช ูุชุฏ ููุฏุงุฑ **true** ุจุฑูโฺฏุฑุฏุงูุฏ ุงฺฏุฑ Thread ูพุงุงู ุงูุชู ุจุงุดุฏุ ุง **false** ุงฺฏุฑ ุฒูุงู ุชูุงู ุดุฏู ุจุงุดุฏ.

---

### ๐ Sleep

ูุชุฏ **Thread.Sleep** ุงุฌุฑุง Thread ูุนู ุฑุง ุจุฑุง ูุฏุช ูุดุฎุต ูุชููู ูโฺฉูุฏ:

```csharp
Thread.Sleep (TimeSpan.FromHours (1));  // ุชููู ุจุฑุง ฑ ุณุงุนุช
Thread.Sleep (500);                     // ุชููู ุจุฑุง ตฐฐ ููโุซุงูู
```

ูุฑุงุฎูุงู `Thread.Sleep(0)` ุจูุงูุงุตูู **ุจูุฑุด ุฒูุงู** (Time Slice) ูุนู ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู ุฏุงูุทูุจุงูู CPU ุฑุง ุฏุฑ ุงุฎุชุงุฑ ุณุงุฑ Threadูุง ูุฑุงุฑ ูโุฏูุฏ.
ูุชุฏ `Thread.Yield()` ูุฒ ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏุ ุจุง ุงู ุชูุงูุช ฺฉู CPU ุฑุง ุชููุง ุจู Threadูุง ูุงฺฏุฐุงุฑ ูโฺฉูุฏ ฺฉู ุฑู ููุงู ูพุฑุฏุงุฒูุฏู ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชูุฏ.

* ุงุณุชูุงุฏู ุงุฒ `Sleep(0)` ุง `Yield` ฺฏุงู ุฏุฑ ฺฉุฏูุง **Production** ุจุฑุง ุจูููโุณุงุฒโูุง ูพุดุฑูุชูโ ุนููฺฉุฑุฏ ููุฏ ุงุณุช.
* ุงูโูุง ููฺูู ุงุจุฒุงุฑูุง ุนุงู **Diagnostic** (ุนุจโุงุจ) ูุณุชูุฏ: ุงฺฏุฑ ุงุถุงูู ฺฉุฑุฏู `Thread.Yield()` ุฏุฑ ูุฑุฌุง ฺฉุฏ ุดูุง ุจุงุนุซ ุฎุฑุงุจ ุดุฏู ุจุฑูุงูู ุดูุฏุ ุชูุฑุจุงู ูุทูุฆู ุจุงุดุฏ ฺฉู ฺฉ **Bug** ุฏุฑ ฺฉุฏุชุงู ูุฌูุฏ ุฏุงุฑุฏ.

---

## ๐ซ Block ุดุฏู ฺฉ Thread

ููุช ุงุฌุฑุง ฺฉ Thread ุจู ุฏูุงู ูุชููู ุดูุฏุ ฺฏูุชู ูโุดูุฏ ฺฉู ุขู Thread **Blocked** ุงุณุชุ ูุซูุงู ููฺฏุงู ุงุฌุฑุง **Sleep** ุง ููุชุธุฑ ูุงูุฏู ุจุฑุง ูพุงุงู ุงูุชู ฺฉ Thread ุฏฺฏุฑ ุจุง **Join**.

* ฺฉ Thread **Blocked** ุจูุงูุงุตูู ุจูุฑุด ุฒูุงู ูพุฑุฏุงุฒูุฏูโ ุฎูุฏ ุฑุง ุขุฒุงุฏ ูโฺฉูุฏ.
* ุงุฒ ุขู ูุญุธู ุจู ุจุนุฏุ ูฺ ุฒูุงู ุงุฒ CPU ูุตุฑู ููโฺฉูุฏ ุชุง ุฒูุงู ฺฉู ุดุฑุท Block ุดุฏู ุจุฑุทุฑู ุดูุฏ.

ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ุขุง ฺฉ Thread ุฏุฑ ุญุงูุช Block ุงุณุช ูโุชูุงูุฏ ุงุฒ ูฺฺฏ **ThreadState** ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
bool blocked = (someThread.ThreadState & ThreadState.WaitSleepJoin) != 0;
```

---

## โ๏ธ ThreadState

ูฺฺฏ **ThreadState** ฺฉ **Flags Enum** ุงุณุช ฺฉู ุณู ยซูุงูยป ุฏุงุฏู ุฑุง ุจูโุตูุฑุช **Bitwise** ุชุฑฺฉุจ ูโฺฉูุฏ.
ุจุงุงูโุญุงู ุจุดุชุฑ ููุงุฏุฑ ุขู ุฒุงุฆุฏุ ุจูุงุงุณุชูุงุฏู ุง ููุณูุฎ ุดุฏูโุงูุฏ.

ุฑูุด ุชูุณุนูโุงูุชูโ ุฒุฑ ฺฉ ููุฏุงุฑ ThreadState ุฑุง ุจู ฺฉ ุงุฒ ฺูุงุฑ ููุฏุงุฑ ููุฏ ุณุงุฏูโุณุงุฒ ูโฺฉูุฏ:

* **Unstarted**
* **Running**
* **WaitSleepJoin**
* **Stopped**

```csharp
public static ThreadState Simplify (this ThreadState ts)
{
    return ts & (ThreadState.Unstarted |
                 ThreadState.WaitSleepJoin |
                 ThreadState.Stopped);
}
```

๐ ูฺฺฏ ThreadState ุจุฑุง ููุงุตุฏ **Diagnostic** ููุฏ ุงุณุชุ ุงูุง ุจุฑุง **Synchronization** ููุงุณุจ ูุณุชุ ุฒุฑุง ูุถุนุช ฺฉ Thread ูโุชูุงูุฏ ุจู ุจุฑุฑุณ ููุฏุงุฑ ThreadState ู ุนููโฺฉุฑุฏู ุจุฑ ุงุณุงุณ ุขู ุชุบุฑ ฺฉูุฏ.

ููฺฏุงูโฺฉู ฺฉ Thread **Block** ุง **Unblock** ูโุดูุฏุ ุณุณุชูโุนุงูู ฺฉ **Context Switch** ุงูุฌุงู ูโุฏูุฏ. ุงู ุนูู ูุฒููโ ุงูุฏฺฉ ุฏุงุฑุฏ (ูุนูููุงู ฺฉ ุง ุฏู ูฺฉุฑูุซุงูู).

---

## โ๏ธ I/O-bound ุฏุฑ ููุงุจู Compute-bound

* ุนููุงุช ฺฉู ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุฏุฑ ุงูุชุธุงุฑ ุฑุฎโุฏุงุฏู ฺุฒ ูโฺฏุฐุฑุงูุฏุ **I/O-bound** ูุงูุฏู ูโุดูุฏ.
  ููููู: **ุฏุงูููุฏ ฺฉ ุตูุญู ูุจ** ุง ูุฑุงุฎูุงู `Console.ReadLine`.
  (ุนููุงุช I/O-bound ูุนูููุงู ุดุงูู ูุฑูุฏ ุง ุฎุฑูุฌ ูุณุชูุฏุ ุงูุง ุงู ฺฉ ุงูุฒุงู ูุทุน ูุณุช: `Thread.Sleep` ูู I/O-bound ูุญุณูุจ ูโุดูุฏ.)

* ุฏุฑ ููุงุจูุ ุนููุงุช ฺฉู ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุตุฑู ุงูุฌุงู ฺฉุงุฑูุง ุณูฺฏู CPU ูโฺฉูุฏุ **Compute-bound** ูุงู ุฏุงุฑุฏ.

---

## ๐ Blocking ุฏุฑ ููุงุจู Spinning

ฺฉ ุนููุงุช I/O-bound ูโุชูุงูุฏ ุจู ุฏู ุตูุฑุช ุนูู ฺฉูุฏ:

1. **ุงูุชุธุงุฑ ููฺฏุงู (Synchronous)** ุฑู Thread ูุนู ุชุง ูพุงุงู ุนููุงุช (ูุซุงู: `Console.ReadLine`ุ `Thread.Sleep` ุง `Thread.Join`).
2. **ุนูู ูุงููฺฏุงู (Asynchronous)** ฺฉู ุจุง ูพุงุงู ุนููุงุช ุฏุฑ ุขูุฏูุ ฺฉ **Callback** ุงุฌุฑุง ูโฺฉูุฏ (ุจุดุชุฑ ุฏุฑ ุงุฏุงูู ุงู ูุตู ุชูุถุญ ุฏุงุฏู ูโุดูุฏ).

---

### ๐ Blocking ุจุง ุญููู Sleep

ุนููุงุชโูุง I/O-bound ฺฉู ุจูโุตูุฑุช ููฺฏุงู ููุชุธุฑ ูโูุงููุฏ ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุฏุฑ ุญุงูุช Block ุณูพุฑ ูโฺฉููุฏ.
ฺฏุงู ุงู ุงูุชุธุงุฑ ุจู ุดฺฉู ฺฉ ุญูููโ Sleep ูพุงุฏูโุณุงุฒ ูโุดูุฏ:

```csharp
while (DateTime.Now < nextStartTime)
    Thread.Sleep (100);
```

---

### ๐ Spinning (ฺุฑุฎุด ูุฏุงูู)

ฺฏุฒููโ ุฏฺฏุฑ ุงู ุงุณุช ฺฉู ฺฉ Thread ุจูโุทูุฑ ูุฏุงูู ุจฺุฑุฎุฏ:

```csharp
while (DateTime.Now < nextStartTime);
```

ุงู ฺฉุงุฑ ุจูโุดุฏุช ููุช CPU ุฑุง ุชูู ูโฺฉูุฏ. ุงุฒ ุฏุฏ **CLR** ู ุณุณุชูโุนุงููุ Thread ุฏุฑ ุญุงู ุงูุฌุงู ฺฉ ูุญุงุณุจู ููู ุงุณุชุ ุจูุงุจุฑุงู ููุงุจุน ุจู ุขู ุงุฎุชุตุงุต ุฏุงุฏู ูโุดูุฏ. ุฏุฑ ุนููุ ูุง ฺฉ ุนููุงุช I/O-bound ุฑุง ุจู ฺฉ ุนููุงุช **Compute-bound** ุชุจุฏู ฺฉุฑุฏูโุงู.

---

## โจ ูฺฉุงุช ุธุฑู ุฏุฑุจุงุฑู Spinning ุฏุฑ ุจุฑุงุจุฑ Blocking

ฑ. **Spinning ฺฉูุชุงูโูุฏุช** ฺฏุงู ูโุชูุงูุฏ ูุคุซุฑ ุจุงุดุฏุ ุฒูุงู ฺฉู ุงูุชุธุงุฑ ุฏุงุฑุฏ ุดุฑุท ุจูโุฒูุฏ (ูุซูุงู ุฏุฑ ฺูุฏ ูฺฉุฑูุซุงูู) ุจุฑูุฑุงุฑ ุดูุฏ. ุงู ฺฉุงุฑ ุงุฒ ุณุฑุจุงุฑ ู ุชุฃุฎุฑ **Context Switch** ุฌููฺฏุฑ ูโฺฉูุฏ.
๐ ุจุฑุง ุงู ููุธูุฑุ .NET ูุชุฏูุง ู ฺฉูุงุณโูุง ุฎุงุต ูุซู **SpinLock** ู **SpinWait** ุฑุง ุงุฑุงุฆู ูโุฏูุฏ.

ฒ. **Blocking ูู ุจโูุฒูู ูุณุช**. ูุฑ Thread ุญุฏูุฏ **ฑ ูฺฏุงุจุงุช ุญุงูุธู** ุฑุง ุจุฑุง ุชูุงู ูุฏุช ุนูุฑุด ุงุดุบุงู ูโฺฉูุฏ ู ุจุฑุง **CLR** ู ุณุณุชูโุนุงูู ุจุงุฑ ูุฏุฑุช ูุฏุงูู ุงุฌุงุฏ ูโฺฉูุฏ.
ุจู ููู ุฏููุ Blocking ุฏุฑ ุจุฑูุงููโูุง ุจุณุงุฑ I/O-bound ฺฉู ุจุงุฏ ุตุฏูุง ุง ูุฒุงุฑุงู ุนููุงุช ููโุฒูุงู ุฑุง ูุฏุฑุช ฺฉููุฏ ูโุชูุงูุฏ ูุดฺฉูโุณุงุฒ ุดูุฏ.

๐ ุฏุฑ ฺูู ุดุฑุงุทุ ุจุฑูุงููโูุง ุจุงุฏ ุงุฒ ุฑูฺฉุฑุฏ **Callback-based** ุงุณุชูุงุฏู ฺฉููุฏุ ุนู ููฺฏุงู ุงูุชุธุงุฑุ Thread ุฎูุฏ ุฑุง ุจูโุทูุฑ ฺฉุงูู ุขุฒุงุฏ ฺฉููุฏ.
ุงู ุฏููุงู (ุจุฎุด ุงุฒ) ูุฏู ุงูฺฏููุง **Asynchronous** ุงุณุช ฺฉู ุฏุฑ ุงุฏุงูู ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.

## ๐ ูุถุนุช ูุญู ุฏุฑ ููุงุจู ูุถุนุช ูุดุชุฑฺฉ

**CLR** ุจู ูุฑ Thread ูพุดุชูโ ุญุงูุธูโ ูุฎุตูุต ุฎูุฏุด ุฑุง ุงุฎุชุตุงุต ูโุฏูุฏุ ุจูุงุจุฑุงู ูุชุบุฑูุง ูุญู ุงุฒ ูู ุฌุฏุง ูฺฏู ุฏุงุดุชู ูโุดููุฏ.

ุฏุฑ ูุซุงู ุฒุฑุ ูุชุฏ ุจุง ฺฉ ูุชุบุฑ ูุญู ุชุนุฑู ูโฺฉูู ู ุณูพุณ ุขู ูุชุฏ ุฑุง ุจูโุทูุฑ ููโุฒูุงู ุฑู **Thread ุงุตู** ู ฺฉ **Thread ุฌุฏุฏ** ูุฑุงุฎูุงู ูโฺฉูู:

```csharp
new Thread (Go).Start();      // ูุฑุงุฎูุงู Go() ุฑู ฺฉ Thread ุฌุฏุฏ
Go();                         // ูุฑุงุฎูุงู Go() ุฑู Thread ุงุตู

void Go()
{
    // ุชุนุฑู ู ุงุณุชูุงุฏู ุงุฒ ูุชุบุฑ ูุญู - 'cycles'
    for (int cycles = 0; cycles < 5; cycles++) 
        Console.Write ('?');
}
```

ุจุฑุง ูุฑ Thread ฺฉ ูุณุฎู ุฌุฏุงฺฏุงูู ุงุฒ ูุชุบุฑ `cycles` ุฑู ูพุดุชูโ ุญุงูุธูโุงุด ุณุงุฎุชู ูโุดูุฏ. ุจูุงุจุฑุงูุ ุฎุฑูุฌ ุทุจู ุงูุชุธุงุฑ ฑฐ ุนูุงูุช ุณุคุงู ุฎูุงูุฏ ุจูุฏ.

---

## ๐ค ุงุดุชุฑุงฺฉ ุฏุงุฏู ุจู Threadูุง

Threadูุง ุฏุงุฏูโูุง ุฑุง ุฏุฑ ุตูุฑุช ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏ ฺฉู ูุฑุฌุน (Reference) ูุดุชุฑฺฉ ุจู ฺฉ ุดุก ุง ูุชุบุฑ ุฏุงุดุชู ุจุงุดูุฏ:

```csharp
bool _done = false;
new Thread (Go).Start();
Go();

void Go()
{
    if (!_done) 
    { 
        _done = true; 
        Console.WriteLine ("Done"); 
    }
}
```

ุฏุฑ ุงู ูุซุงูุ ูุฑ ุฏู Thread ูุชุบุฑ `_done` ุฑุง ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏุ ูพุณ ุฎุฑูุฌ `"Done"` ููุท ฺฉโุจุงุฑ ฺุงูพ ูโุดูุฏ.

---

### ๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Lambda

ูุชุบุฑูุง ูุญู ฺฉู ุฏุฑ ฺฉ **Lambda Expression** ฺฏุฑูุชู (Capture) ูโุดููุฏ ูุฒ ูโุชูุงููุฏ ูุดุชุฑฺฉ ุจุงุดูุฏ:

```csharp
bool done = false;
ThreadStart action = () =>
{
    if (!done) 
    { 
        done = true; 
        Console.WriteLine ("Done"); 
    }
};

new Thread (action).Start();
action();
```

---

### ๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Fieldูุง

ุจูโุทูุฑ ุฑุงุฌโุชุฑุ **Fieldูุง** ุจุฑุง ุงุดุชุฑุงฺฉ ุฏุงุฏู ูุงู Threadูุง ุงุณุชูุงุฏู ูโุดููุฏ.

```csharp
var tt = new ThreadTest();
new Thread (tt.Go).Start();
tt.Go();

class ThreadTest 
{
    bool _done;
    public void Go()
    {
        if (!_done) 
        { 
            _done = true; 
            Console.WriteLine ("Done"); 
        }
    }
}
```

---

### ๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Static Field

ุฑุงู ุฏฺฏุฑ ุจุฑุง ุงุดุชุฑุงฺฉ ุฏุงุฏูโูุง ูุงู Threadูุง ุงุณุชูุงุฏู ุงุฒ **Static Field**ูุงุณุช:

```csharp
class ThreadTest 
{
    static bool _done;    // Static Fieldูุง ูุงู ููู Threadูุง ุฏุฑ ฺฉ Process ูุดุชุฑฺฉ ูุณุชูุฏ

    static void Main()
    {
        new Thread (Go).Start();
        Go();
    }

    static void Go()
    {
        if (!_done) 
        { 
            _done = true; 
            Console.WriteLine ("Done"); 
        }
    }
}
```

---

## โ๏ธ ูุดฺฉู Thread Safety

ูุฑ ฺูุงุฑ ูุซุงู ุจุงูุง ููููู ฺฉูุฏ ุฏฺฏุฑ ุฑุง ูุดุงู ูโุฏููุฏ: **ุงูู Threadูุง** (ุง ุจูุชุฑ ุจฺฏููุ ูุจูุฏ ุขู!).
ุฏุฑ ุญููุช ุฎุฑูุฌ **ูุงูุนู** ุงุณุช: ุงู ุงูฺฉุงู (ูุฑฺูุฏ ูุงุฏุฑ) ูุฌูุฏ ุฏุงุฑุฏ ฺฉู `"Done"` ุฏูุจุงุฑ ฺุงูพ ุดูุฏ.

ุงฺฏุฑ ุชุฑุชุจ ุฏุณุชูุฑุงุช ุฏุฑ ูุชุฏ `Go` ุฑุง ุนูุถ ฺฉููุ ุงุญุชูุงู ฺุงูพ ุฏูุจุงุฑู `"Done"` ุจูโุดุฏุช ุงูุฒุงุด ูโุงุจุฏ:

```csharp
static void Go()
{
    if (!_done) 
    { 
        Console.WriteLine ("Done"); 
        _done = true; 
    }
}
```

ูุดฺฉู ุงูุฌุงุณุช ฺฉู ฺฉ Thread ููฺฉู ุงุณุช ุฏุฑ ุญุงู ุจุฑุฑุณ ุดุฑุท `if` ุจุงุดุฏ ุฏุฑ ููุงู ูุญุธูโุง ฺฉู Thread ุฏฺฏุฑ ุฏุงุฑุฏ `WriteLine` ุฑุง ุงุฌุฑุง ูโฺฉูุฏโูุจู ุงุฒ ุขูฺฉู ูุฑุตุช ฺฉูุฏ ููุฏุงุฑ `_done` ุฑุง ุจุฑุงุจุฑ **true** ฺฉูุฏ.

ุงู ูุซุงู ฺฉ ุงุฒ ุฑุงูโูุง ูุชุนุฏุฏ ุฑุง ูุดุงู ูโุฏูุฏ ฺฉู ุฏุฑ ุขู **Shared Writable State** (ูุถุนุช ูุดุชุฑฺฉ ูุงุจูโููุดุชู) ูโุชูุงูุฏ ุฎุทุงูุง ูุชูุงูุจ ุงุฌุงุฏ ฺฉูุฏุ ููุงู ุฎุทุงูุง ฺฉู **Multithreading** ุจูโุจุฏูุงู ุจุฑุง ุขูโูุง ูุดููุฑ ุงุณุช.

---

## ๐ ูููโฺฏุฐุงุฑ ู ุงูู Threadูุง

ุจุฑุง ุญู ูุซุงู ูุจู ูโุชูุงูู ููฺฏุงู ุฎูุงูุฏู ู ููุดุชู ุฑู Field ูุดุชุฑฺฉุ ฺฉ **Exclusive Lock** ุจฺฏุฑู.
\#C ุจุฑุง ุงู ููุธูุฑ ุฏุณุชูุฑ `lock` ุฑุง ูุฑุงูู ฺฉุฑุฏู ุงุณุช:

```csharp
class ThreadSafe 
{
    static bool _done;
    static readonly object _locker = new object();

    static void Main()
    {
        new Thread (Go).Start();
        Go();
    }

    static void Go()
    {
        lock (_locker)
        {
            if (!_done) 
            { 
                Console.WriteLine ("Done"); 
                _done = true; 
            }
        }
    }
}
```

ููุช ุฏู Thread ููโุฒูุงู ุจุฑุง ฺฏุฑูุชู ฺฉ Lock (ฺฉู ูโุชูุงูุฏ ุฑู ูุฑ ุดุก ุงุฒ ููุน Reference ุจุงุดุฏุ ุฏุฑ ุงูุฌุง `_locker`) ุฑูุงุจุช ฺฉููุฏุ ฺฉ ุงุฒ ุขูโูุง ููุชุธุฑ ูโูุงูุฏ (Blocked) ุชุง Lock ุขุฒุงุฏ ุดูุฏ.
ุงู ฺฉุงุฑ ุชุถูู ูโฺฉูุฏ ฺฉู ููุท ฺฉ Thread ูโุชูุงูุฏ ููโุฒูุงู ูุงุฑุฏ ุจููฺฉ ฺฉุฏ ุดูุฏุ ู `"Done"` ููุท ฺฉโุจุงุฑ ฺุงูพ ุฎูุงูุฏ ุดุฏ.

ฺฉุฏ ฺฉู ุจู ุงู ุดฺฉู ูุญุงูุธุช ุดุฏู ุจุงุดุฏโุฏุฑ ุจุฑุงุจุฑ ุนุฏู ูุทุนุช ุฏุฑ ฺฉ ูุญุท ฺูุฏโุฑุดุชูโุงโุจู ุขู **Thread Safe** ูโฺฏููุฏ.

---

## โก ุนููุงุช ูุงุงูู ุญุช ุฏุฑ ุณุงุฏูโุชุฑู ุญุงูุงุช

ุญุช ุนูู ุณุงุฏูโ **Auto-increment** ฺฉ ูุชุบุฑ ูู Thread Safe ูุณุช:

ุนุจุงุฑุช `x++` ุฑู ูพุฑุฏุงุฒูุฏู ุจูโุตูุฑุช ฺูุฏ ุนูู ุฌุฏุงฺฏุงูู (ุฎูุงูุฏูุ ุงูุฒุงุด ู ููุดุชู) ุงุฌุฑุง ูโุดูุฏ.
ุจูุงุจุฑุงู ุงฺฏุฑ ุฏู Thread ููโุฒูุงู `x++` ุฑุง ุฎุงุฑุฌ ุงุฒ ฺฉ Lock ุงุฌุฑุง ฺฉููุฏุ ูุชุบุฑ ููฺฉู ุงุณุช ููุท ฺฉโุจุงุฑ ุงูุฒุงุด ุงุจุฏ ุจูโุฌุง ุฏูุจุงุฑ (ุง ุจุฏุชุฑุ ููุฏุงุฑ `x` ููฺฉู ุงุณุช ุฏุฑ ุดุฑุงุท ุฎุงุต ุจูโุดฺฉู ุชฺฉูโุชฺฉู ู ูุงุฏุฑุณุช ุฐุฎุฑู ุดูุฏ).

---

## ๐ซ ูุญุฏูุฏุชโูุง ูููโฺฏุฐุงุฑ

ูููโฺฏุฐุงุฑ **ฺฏูููู ููุฑูโุง** ุจุฑุง ุญู ููู ูุดฺฉูุงุช Thread Safety ูุณุช:

* ููฺฉู ุงุณุช ูุฑุงููุด ฺฉูุฏ ฺฉู ุฏุฑ ุญู ุฏุณุชุฑุณ ุจู ฺฉ Field ุงุฒ Lock ุงุณุชูุงุฏู ฺฉูุฏ.
* ูููโฺฏุฐุงุฑ ุฎูุฏุด ูโุชูุงูุฏ ูุดฺฉูุงุช ูุงููุฏ **Deadlock** ุงุฌุงุฏ ฺฉูุฏ.

ฺฉ ููููู ุฎูุจ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ูููโฺฏุฐุงุฑุ ุฏุณุชุฑุณ ุจู ฺฉ **Cache ุฏุฑ ุญุงูุธู** ุงุณุช ฺฉู ุจุฑุง ูฺฏูุฏุงุฑ ุงุดุง ูพุงฺฏุงู ุฏุงุฏู ุฏุฑ ฺฉ ุจุฑูุงููโ **ASP.NET** ุงุณุชูุงุฏู ูโุดูุฏ.
ุงู ููุน ุจุฑูุงูู ุณุงุฏู ุงุณุช ู ุจูโุฏุฑุณุช ฺฉุงุฑ ูโฺฉูุฏ ู ูฺ ุฎุทุฑ ุจุฑุง Deadlock ูุฌูุฏ ูุฏุงุฑุฏ.
ูููููโุง ุงุฒ ุงู ููุถูุน ุฑุง ุฏุฑ ุจุฎุด **"Thread Safety in Application Servers"** (ุตูุญู นฐฑ) ุฎูุงูู ุฏุฏ.

## ๐ค ุงุฑุณุงู ุฏุงุฏู ุจู ฺฉ Thread

ฺฏุงู ูุงุฒู ุงุณุช ููฺฏุงู ุดุฑูุน ฺฉ **Thread**ุ ุขุฑฺฏููุงูโูุง ุจู ูุชุฏ ูุฑูุฏ ุขู ุงุฑุณุงู ฺฉูุฏ.
ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง ุงู ฺฉุงุฑ ุงุณุชูุงุฏู ุงุฒ **Lambda Expression** ุงุณุช ฺฉู ูุชุฏ ุฑุง ุจุง ุขุฑฺฏููุงูโูุง ููุฑุฏ ูุธุฑ ูุฑุงุฎูุงู ูโฺฉูุฏ:

```csharp
Thread t = new Thread ( () => Print ("Hello from t!") );
t.Start();

void Print (string message) => Console.WriteLine (message);
```

ุจุง ุงู ุฑูุดุ ูโุชูุงูุฏ ูุฑ ุชุนุฏุงุฏ ุขุฑฺฏููุงู ุฑุง ุจู ูุชุฏ ุงุฑุณุงู ฺฉูุฏ.
ุญุช ูโุชูุงูุฏ ฺฉู ูพุงุฏูโุณุงุฒ ุฑุง ุฏุฑ ฺฉ **Lambda ฺูุฏโุฏุณุชูุฑูโุง** ูุฑุงุฑ ุฏูุฏ:

```csharp
new Thread (() =>
{
    Console.WriteLine ("I'm running on another thread!");
    Console.WriteLine ("This is so easy!");
}).Start();
```

---

### ๐ ุฑูุด ุฏฺฏุฑ: ุงุณุชูุงุฏู ุงุฒ `Thread.Start`

ุฑูุด ุฌุงฺฏุฒู (ุงูุง ฺฉูุชุฑ ุงูุนุทุงูโูพุฐุฑ) ุงู ุงุณุช ฺฉู ุขุฑฺฏููุงู ุฑุง ุจู ูุชุฏ `Start` ุงุฑุณุงู ฺฉูู:

```csharp
Thread t = new Thread (Print);
t.Start ("Hello from t!");

void Print (object messageObj)
{
    string message = (string) messageObj;   // ูุงุฒ ุจู Cast ุฏุงุฑู
    Console.WriteLine (message);
}
```

ุงู ุฑูุด ฺฉุงุฑ ูโฺฉูุฏ ฺูู ุณุงุฒูุฏูโ **Thread** ุจุฑุง ุฏู ููุน Delegate **Overload** ุดุฏู ุงุณุช:

```csharp
public delegate void ThreadStart();
public delegate void ParameterizedThreadStart (object obj);
```

---

## ๐งฉ Lambda Expressions ู ูุชุบุฑูุง Captured

ููุงูโุทูุฑ ฺฉู ุฏุฏูุ **Lambda Expression** ุฑุงุญุชโุชุฑู ู ูุฏุฑุชููุฏุชุฑู ุฑูุด ุจุฑุง ุงุฑุณุงู ุฏุงุฏู ุจู ฺฉ Thread ุงุณุช.
ุงูุง ุจุงุฏ ูุฑุงูุจ ุจุงุดุฏ ฺฉู ุจุนุฏ ุงุฒ ุดุฑูุน Threadุ ุจูโุทูุฑ ูุงุฎูุงุณุชู ูุชุบุฑูุง Captured ุฑุง ุชุบุฑ ูุฏูุฏ.

ุจุฑุง ููููู:

```csharp
for (int i = 0; i < 10; i++)
    new Thread (() => Console.Write (i)).Start();
```

ุฎุฑูุฌ **ูุงูุนู** ุงุณุช! ูุซุงู ุงุฒ ุฎุฑูุฌ:

```
0223557799
```

ูุดฺฉู ุงู ุงุณุช ฺฉู ูุชุบุฑ `i` ุฏุฑ ุทูู ุงุฌุฑุง ุญููู ุจู ฺฉ ูุญู ุญุงูุธูโ ูุดุชุฑฺฉ ุงุดุงุฑู ุฏุงุฑุฏ.
ุจูุงุจุฑุงู ูุฑ Threadุ ูุชุฏ ุฑุง ุฑู ูุชุบุฑ ูุฑุงุฎูุงู ูโฺฉูุฏ ฺฉู ููฺฉู ุงุณุช ููโุฒูุงู ุฏุฑ ุญุงู ุชุบุฑ ุจุงุดุฏ!

โ ุฑุงูโุญู: ุงุณุชูุงุฏู ุงุฒ ฺฉ ูุชุบุฑ ูููุช:

```csharp
for (int i = 0; i < 10; i++)
{
    int temp = i;
    new Thread (() => Console.Write (temp)).Start();
}
```

ุญุงูุง ูุฑ ุนุฏุฏ ุงุฒ **ฐ ุชุง น** ุฏููุงู ฺฉโุจุงุฑ ฺุงูพ ูโุดูุฏ.
(ุงูุจุชู ุชุฑุชุจ ูููุฒ ูุดุฎุต ูุณุชุ ฺูู Threadูุง ูโุชูุงููุฏ ุฏุฑ ุฒูุงูโูุง ูุงูุนู ุดุฑูุน ุดููุฏ.)

ุงู ูุดฺฉู ูุดุงุจู ููุถูุน **"Captured Variables"** (ุตูุญู ดณด) ุงุณุชุ
ูุดฺฉู ูู ุจู ููุงูู C# ุฏุฑ Capture ูุชุบุฑูุง ุญููู ูุฑุจูุท ูโุดูุฏ ู ูู ุจู Multithreading.

ุฏุฑ ุงู ุฑูุดุ ูุชุบุฑ `temp` ูุญู ุจู ูุฑ Iteration ุญููู ุงุณุชุ ูพุณ ูุฑ Thread ุญุงูุธูโุง ูุชูุงูุช Capture ูโฺฉูุฏ ู ูุดฺฉู ูพุด ููโุขุฏ.

ฺฉ ูุซุงู ุณุงุฏูโุชุฑ ุจุฑุง ููุงุด ูุดฺฉู:

```csharp
string text = "t1";
Thread t1 = new Thread ( () => Console.WriteLine (text) );
text = "t2";
Thread t2 = new Thread ( () => Console.WriteLine (text) );
t1.Start(); t2.Start();
```

ฺูู ูุฑ ุฏู Lambda ูุชุบุฑ `text` ุฑุง Capture ฺฉุฑุฏูโุงูุฏุ ุฎุฑูุฌ ุฏูุจุงุฑ `"t2"` ุฎูุงูุฏ ุจูุฏ.

---

## โ๏ธ ูุฏุฑุช ุงุณุชุซูุงูุง ุฏุฑ Threadูุง

ุจููฺฉโูุง **try/catch/finally** ฺฉู ููฺฏุงู ุงุฌุงุฏ ฺฉ Thread ุฏุฑ ุฌุฑุงู ูุณุชูุฏุ ูฺ ุชุฃุซุฑ ุฑู ุขู Thread ููฺฏุงู ุงุฌุฑุง ูุฏุงุฑูุฏ.

ูุซุงู:

```csharp
try
{
    new Thread (Go).Start();
}
catch (Exception ex)
{
    // ุงูุฌุง ูฺโููุช ุงุฌุฑุง ููโุดูุฏ!
    Console.WriteLine ("Exception!");
}

void Go() { throw null; }   // ูพุฑุชุงุจ NullReferenceException
```

ุฏุฑ ุงูุฌุงุ Thread ุฌุฏุฏ ุจุง ฺฉ **Unhandled NullReferenceException** ููุงุฌู ูโุดูุฏ.
ุงู ุฑูุชุงุฑ ููุทู ุงุณุชุ ฺูู ูุฑ Thread ูุณุฑ ุงุฌุฑุง ูุณุชูู ุฎูุฏ ุฑุง ุฏุงุฑุฏ.

โ ุฑุงูโุญู ุงู ุงุณุช ฺฉู **Exception Handler** ุฑุง ุฏุงุฎู ูุชุฏ `Go` ูุฑุงุฑ ุฏูู:

```csharp
new Thread (Go).Start();

void Go()
{
    try
    {
        ...
        throw null;    // ุงูุฌุง ุฎุทุง ูพุฑุชุงุจ ูโุดูุฏ
        ...
    }
    catch (Exception ex)
    {
        // ูุนูููุงู Exception ุฑุง Log ูโฺฉูู ุง ุจู ฺฉ Thread ุฏฺฏุฑ ุณฺฏูุงู ูโุฏูู
        ...
    }
}
```

ุฏุฑ ุจุฑูุงููโูุง ูุงูุนุ ุจุงุฏ ุฏุฑ ุชูุงู ูุชุฏูุง ูุฑูุฏ Thread **Exception Handler** ุฏุงุดุชู ุจุงุดุฏโููุงูโุทูุฑ ฺฉู ุฏุฑ Thread ุงุตู ุจุฑูุงูู ูู ูุงุฒ ุฏุงุฑุฏ.
ฺูู ฺฉ Exception ูุฏุฑุชโูุดุฏู ุจุงุนุซ ุจุณุชูโุดุฏู ฺฉู ุจุฑูุงูู ู ููุงุด ฺฉ ูพูุฌุฑูโ ูุงุฎูุดุงูุฏ ูโุดูุฏ.

---

## ๐๏ธ ูุฏุฑุช ูุชูุฑฺฉุฒ ุงุณุชุซูุงูุง

ุฏุฑ ุจุฑูุงููโูุง **WPFุ UWP ู Windows Forms** ูโุชูุงูุฏ ุจุฑุง ูุฏุฑุช ุณุฑุงุณุฑ Exceptionูุง ูุดุชุฑฺฉ ุดูุฏ:

* `Application.DispatcherUnhandledException`
* `Application.ThreadException`

ุงู ุฑูุฏุงุฏูุง ูพุณ ุงุฒ ูููุน ฺฉ Exception ูุฏุฑุชโูุดุฏู ุฏุฑ ูุฑ ุจุฎุด ุจุฑูุงูู ฺฉู ุงุฒ ุทุฑู Message Loop ูุฑุงุฎูุงู ุดุฏู ุงุณุช (ุนู ุชูุงู ฺฉุฏ ฺฉู ุฑู Thread ุงุตู ุฏุฑ ุญุงู ุงุฌุฑุงุณุช) ูุนุงู ูโุดููุฏ.

ุงู ุฑูุด ุจูโุนููุงู ฺฉ ูพุดุชูุงูู ุจุฑุง **Log ฺฉุฑุฏู ู ฺฏุฒุงุฑุด ุจุงฺฏโูุง** ููุฏ ุงุณุช (ูุฑฺูุฏ ุจุฑุง Exceptionูุง ูุฏุฑุชโูุดุฏู ุฑู Worker Threadูุง ูุนุงู ููโุดูุฏ).

ูุฏุฑุช ุงู ุฑูุฏุงุฏูุง ุงุฒ ุจุณุชูโุดุฏู ุจุฑูุงูู ุฌููฺฏุฑ ูโฺฉูุฏุ ุงูุจุชู ููฺฉู ุงุณุช ุชุตูู ุจฺฏุฑุฏ ุจุฑูุงูู ุฑุง ูุฌุฏุฏุงู ุฑุงูโุงูุฏุงุฒ ฺฉูุฏ ุชุง ุงุฒ ุญุงูุช ูุงูพุงุฏุงุฑ ุงุญุชูุงู ุฌููฺฏุฑ ุดูุฏ.

## ๐ Foreground ุฏุฑ ููุงุจู Background Threads

ุจูโุทูุฑ ูพุดโูุฑุถุ Threadูุง ฺฉู ุดูุง ุจูโุทูุฑ ุตุฑุญ ุงุฌุงุฏ ูโฺฉูุฏุ **Foreground** ูุณุชูุฏ.

๐น **Foreground Thread** ุจุงุนุซ ูโุดูุฏ ุจุฑูุงูู ุชุง ุฒูุงู ฺฉู ุญุช ฺฉ ุงุฒ ุขูโูุง ุฏุฑ ุญุงู ุงุฌุฑุงุณุชุ ุฒูุฏู ุจูุงูุฏ.
๐น **Background Thread** ฺูู ุงุซุฑ ูุฏุงุฑุฏุ ุจูโูุญุถ ุงูฺฉู ูููโ Foreground Threadูุง ุชูุงู ุดููุฏุ ุจุฑูุงูู ูพุงุงู ูโุงุจุฏ ู ูุฑ Background Thread ฺฉู ูููุฒ ุฏุฑ ุญุงู ุงุฌุฑุงุณุชุ ูุงฺฏูุงู ูุทุน ูโุดูุฏ.

โ๏ธ ูุถุนุช Foreground ุง Background ูฺ ุงุฑุชุจุงุท ุจุง **Priority** (ุงูููุช ุชุฎุตุต ุฒูุงู ูพุฑุฏุงุฒุด) ูุฏุงุฑุฏ.

ูโุชูุงูุฏ ูุถุนุช ฺฉ Thread ุฑุง ุงุฒ ุทุฑู ูฺฺฏ `IsBackground` ูพุฑุณโูุฌู ุง ุชุบุฑ ุฏูุฏ:

```csharp
static void Main (string[] args)
{
    Thread worker = new Thread ( () => Console.ReadLine() );
    if (args.Length > 0) worker.IsBackground = true;
    worker.Start();
}
```

* ุงฺฏุฑ ุจุฑูุงูู ุจุฏูู ุขุฑฺฏููุงู ุงุฌุฑุง ุดูุฏุ Thread ุจูโุตูุฑุช **Foreground** ุฎูุงูุฏ ุจูุฏ ู ููุชุธุฑ ูโูุงูุฏ ุชุง ฺฉุงุฑุจุฑ Enter ุจุฒูุฏ.
* ุงฺฏุฑ ุจุฑูุงูู ุจุง ุขุฑฺฏููุงู ุงุฌุฑุง ุดูุฏุ Thread ุจูโุตูุฑุช **Background** ุงุณุช ู ุจุฑูุงูู ุชูุฑุจุงู ุจูุงูุงุตูู ุชูุงู ูโุดูุฏ (ู `ReadLine` ูุทุน ูโฺฏุฑุฏุฏ).

โ ุชูุฌู: ููุช ุจุฑูุงูู ุงูโฺฏููู ูพุงุงู ุงุจุฏุ ุจูุงฺฉโูุง `finally` ุฏุฑ ูพุดุชูโ ุงุฌุฑุง Background Thread ุงุฌุฑุง ููโุดููุฏ.
ุจูุงุจุฑุงู ุงฺฏุฑ ุจุฑุง ูพุงฺฉโุณุงุฒ (ูุซู ุญุฐู ูุงูโูุง ูููุช) ุงุฒ `finally` ุง `using` ุงุณุชูุงุฏู ูโฺฉูุฏุ ุจุงุฏ ูุทูุฆู ุดูุฏ ููฺฏุงู ุฎุฑูุฌ ุงุฒ ุจุฑูุงููุ ุงู Threadูุง ุจูโุทูุฑ ุตุญุญ ุจู ูพุงุงู ุจุฑุณูุฏ (ูุซูุงู ุจุง `Join` ุง **Signaling**). ููุดู ูู ุจุงุฏ **Timeout** ุชุนู ฺฉูุฏ ุชุง ุฏุฑ ุตูุฑุช ูุฌุจุงุฒ ฺฉ Threadุ ุจุฑูุงูู ุจุณุชู ูุดูุฏ.

---

## ๐๏ธ ุงูููุช Threads

ูฺฺฏ `Priority` ุชุนู ูโฺฉูุฏ ฺฉ Thread ฺู ูุฒุงู ุฒูุงู ูพุฑุฏุงุฒุด ูุณุจุช ุจู ุณุงุฑ Threadูุง ุฏุฑุงูุช ฺฉูุฏ:

```csharp
enum ThreadPriority { Lowest, BelowNormal, Normal, AboveNormal, Highest }
```

ุงู ููุถูุน ุฒูุงู ุงููุช ุฏุงุฑุฏ ฺฉู ฺูุฏู Thread ููโุฒูุงู ูุนุงู ุจุงุดูุฏ.

* ุจุงูุง ุจุฑุฏู ุงูููุช ูโุชูุงูุฏ ุจุงุนุซ ุดูุฏ Threadูุง ุฏฺฏุฑ **ฺฏุฑุณูู** ุจูุงููุฏ.
* ุงฺฏุฑ ูโุฎูุงูุฏ Thread ุดูุง ุงูููุช ุจุงูุงุชุฑ ุงุฒ ุณุงุฑ Processูุง ุฏุงุดุชู ุจุงุดุฏุ ุจุงุฏ ุงูููุช Process ุฑุง ูู ุจุงูุง ุจุจุฑุฏ:

```csharp
using Process p = Process.GetCurrentProcess();
p.PriorityClass = ProcessPriorityClass.High;
```

ุงู ฺฉุงุฑ ุจุฑุง **ูพุฑุฏุงุฒุดโูุง ุบุฑ-UI ฺฉูฺฺฉ ุจุง ูุงุฒ ุจู ูุงฺฉูุด ุณุฑุน** ููุงุณุจ ุงุณุช. ุงูุง ุฏุฑ ุจุฑูุงููโูุง ูพุฑูุตุฑู (ูุฎุตูุตุงู ุจุง UI)ุ ุงูุฒุงุด ุงูููุช Process ูโุชูุงูุฏ ฺฉู ุณุณุชู ุฑุง ฺฉูุฏ ฺฉูุฏ.

---

## ๐ก Signaling

ฺฏุงู ูุงุฒู ุงุณุช ฺฉ Thread ููุชุธุฑ ุจูุงูุฏ ุชุง ุงุฒ Threadูุง ุฏฺฏุฑ ุณฺฏูุงู ุฏุฑุงูุช ฺฉูุฏ.
ุณุงุฏูโุชุฑู ุณุงุฒู ุจุฑุง ุงู ฺฉุงุฑ **ManualResetEvent** ุงุณุช:

* `WaitOne` โ Thread ูุนู ุฑุง ูุณุฏูุฏ ูโฺฉูุฏ.
* `Set` โ ุณฺฏูุงู ุฑุง ุจุงุฒ ูโฺฉูุฏ ู ููุชุธุฑูุง ุขุฒุงุฏ ูโุดููุฏ.

ูุซุงู:

```csharp
var signal = new ManualResetEvent (false);

new Thread (() =>
{
    Console.WriteLine ("Waiting for signal...");
    signal.WaitOne();
    signal.Dispose();
    Console.WriteLine ("Got signal!");
}).Start();

Thread.Sleep(2000);
signal.Set();  // ุณฺฏูุงู ุจุงุฒ ุดุฏ
```

ุจุนุฏ ุงุฒ ูุฑุงุฎูุงู `Set`ุ ุณฺฏูุงู ุจุงุฒ ูโูุงูุฏ ุชุง ุฒูุงู ฺฉู ุฏูุจุงุฑู `Reset` ุดูุฏ.
CLR ุณุงุฒูโูุง Signaling ูุชููุน ุฏุงุฑุฏ ฺฉู ุฏุฑ ูุตู ฒฑ ุจุฑุฑุณ ูโุดููุฏ.

---

## ๐ฅ๏ธ Threading ุฏุฑ ุจุฑูุงููโูุง Rich Client

ุฏุฑ ุจุฑูุงููโูุง **WPFุ UWP ู Windows Forms**ุ ุงุฌุฑุง ุนููุงุช ุทููุงู ุฑู Thread ุงุตู ุจุงุนุซ **ููฺฏ ฺฉุฑุฏู UI** ูโุดูุฏุ ฺูู ููุงู Thread ูุณุฆูู ูพุฑุฏุงุฒุด ูุฑูุฏโูุง (ฺฉุจูุฑุฏ/ูุงูุณ) ู ุฑูุฏุฑ ุฑุงุจุท ฺฉุงุฑุจุฑ ุงุณุช.

ุฑุงูโุญู:

* ุงุฌุงุฏ **Worker Thread** ุจุฑุง ฺฉุงุฑูุง ุฒูุงูโุจุฑ.
* ุณูพุณ ุงูุชูุงู ูุชุฌู ุจู Thread ุงุตู ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI.

โ๏ธ ูููโ ุงู ูุฑูโูุฑฺฉโูุง ูุฏู Threading ุฏุงุฑูุฏ ฺฉู ููุท ุงุฌุงุฒู ูโุฏูุฏ UI ุชูุณุท ููุงู Thread ุฏุณุชุฑุณ ุงุจุฏ ฺฉู ุขู ุฑุง ุณุงุฎุชู ุงุณุช (ูุนูููุงู Thread ุงุตู). ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุฑูุชุงุฑ ูุงูุดุฎุต ุง Exception ุฑุฎ ูโุฏูุฏ.

ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI ุงุฒ Worker Thread ุจุงุฏ ุฏุฑุฎูุงุณุช ุฑุง ุจู UI Thread **Marshal** ฺฉูุฏ:

* **WPF** โ ุจุง `Dispatcher.BeginInvoke` ุง `Dispatcher.Invoke`
* **UWP** โ ุจุง `Dispatcher.RunAsync` ุง `Dispatcher.Invoke`
* **Windows Forms** โ ุจุง `Control.BeginInvoke` ุง `Control.Invoke`

`BeginInvoke`/`RunAsync` Delegate ุฑุง ุฏุฑ ุตู ูพุงู UI ูโฺฏุฐุงุฑูุฏ (ุบุฑูุณุฏูุฏฺฉููุฏู).
`Invoke` ููุงู ฺฉุงุฑ ุฑุง ูโฺฉูุฏุ ุงูุง ุชุง ูพุฑุฏุงุฒุด Delegate ุชูุณุท UI Thread ุตุจุฑ ูโฺฉูุฏ (ูุณุฏูุฏฺฉููุฏู ู ุจุง ุงูฺฉุงู ุจุงุฒฺฏุดุช ููุฏุงุฑ).

---

## ๐ ูุซุงู ุฏุฑ WPF

ูุฑุถ ฺฉูุฏ ฺฉ ูพูุฌุฑู WPF ุฏุงุฑู ฺฉู ุดุงูู TextBox ุจู ูุงู `txtMessage` ุงุณุช. ูโุฎูุงูู ูพุณ ุงุฒ ฺฉ ฺฉุงุฑ ุฒูุงูโุจุฑุ ูุชู ุขู ุฑุง ุชุบุฑ ุฏูู:

```csharp
partial class MyWindow : Window
{
    public MyWindow()
    {
        InitializeComponent();
        new Thread (Work).Start();
    }

    void Work()
    {
        Thread.Sleep (5000);           // ุดุจูโุณุงุฒ ฺฉุงุฑ ุฒูุงูโุจุฑ
        UpdateMessage ("The answer");
    }

    void UpdateMessage (string message)
    {
        Action action = () => txtMessage.Text = message;
        Dispatcher.BeginInvoke (action);
    }
}
```

๐น ูพูุฌุฑู ููุฑุงู ูพุงุณุฎโฺฏู ุฎูุงูุฏ ุจูุฏ.
๐น ุจุนุฏ ุงุฒ ต ุซุงููุ TextBox ุจูโุฑูุฒุฑุณุงู ูโุดูุฏ.

ุฏุฑ Windows Forms ูู ูุดุงุจู ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู ุจุงุฏ ุงุฒ ูุชุฏ `BeginInvoke` ูุฑู ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
void UpdateMessage (string message)
{
    Action action = () => txtMessage.Text = message;
    this.BeginInvoke (action);
}
```

---

## ๐ช ฺูุฏู UI Thread

ุฏุฑ ฺฉ ุจุฑูุงูู ูโุชูุงู ฺูุฏู UI Thread ุฏุงุดุชุ ูุฑฺฉุฏุงู ูุงูฺฉ ฺฉ **ูพูุฌุฑูโ ูุณุชูู**.
ุงู ูุนูููุงู ุฏุฑ **SDI Applications** (ูุซู Microsoft Word) ุงุณุชูุงุฏู ูโุดูุฏ. ูุฑ ูพูุฌุฑูโ ูุณุชูู ูโุชูุงูุฏ UI Thread ุฎูุฏุด ุฑุง ุฏุงุดุชู ุจุงุดุฏ ุชุง ูพุงุณุฎโฺฏู ุจุดุชุฑ ุจู ฺฉุงุฑุจุฑ ุงุฑุงุฆู ุฏูุฏ.

### ฺฉุงูุชฺฉุณุชโูุง ููฺฏุงูโุณุงุฒ (Synchronization Contexts) ๐

ุฏุฑ ูุถุง ูุงู **System.ComponentModel** ฺฉูุงุณ ุจู ูุงู **SynchronizationContext** ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุงูฺฉุงู **ุนูููุช ุฏุงุฏู ุจู Thread Marshaling** ุฑุง ูุฑุงูู ูโฺฉูุฏ.

๐ฑ๐ป ุฏุฑ APIูุง ูุฑุจูุท ุจู rich-client ุจุฑุง ููุจุงู ู ุฏุณฺฉุชุงูพ (ุนู **UWPุ WPF ู Windows Forms**) ูุฑฺฉุฏุงู ุฒุฑฺฉูุงุณ ุงุฒ **SynchronizationContext** ุชุนุฑู ู ุงุฌุงุฏ ูโฺฉููุฏ. ุดูุง ูโุชูุงูุฏ ุงู ููููู ุฑุง ุงุฒ ุทุฑู ูฺฺฏ (Property) ุงุณุชุง ุจู ูุงู **SynchronizationContext.Current** (ููุช ุฑู ฺฉ UI thread ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชุฏ) ุจูโุฏุณุช ุขูุฑุฏ.

ฺฏุฑูุชู ุงู property ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุจุนุฏุงู ุงุฒ ุฏุงุฎู ฺฉ worker thread ุจู ฺฉูุชุฑูโูุง UI โpostโ ฺฉูุฏ:

```csharp
partial class MyWindow : Window
{
    SynchronizationContext _uiSyncContext;

    public MyWindow()
    {
        InitializeComponent();
        // ฺฏุฑูุชู ฺฉุงูุชฺฉุณุช ููฺฏุงูโุณุงุฒ ุจุฑุง UI thread ุฌุงุฑ:
        _uiSyncContext = SynchronizationContext.Current;
        new Thread(Work).Start();
    }

    void Work()
    {
        Thread.Sleep(5000);   // ุดุจูโุณุงุฒ ฺฉ ฺฉุงุฑ ุฒูุงูโุจุฑ
        UpdateMessage("The answer");
    }

    void UpdateMessage(string message)
    {
        // Marshal ฺฉุฑุฏู delegate ุจู UI thread:
        _uiSyncContext.Post(_ => txtMessage.Text = message, null);
    }
}
```

๐ ุงู ุฑูุด ููุฏ ุงุณุช ฺูู ุฏุฑ ูููโ APIูุง ุฑุงุจุท ฺฉุงุฑุจุฑ rich-client ุจู ฺฉ ุดฺฉู ฺฉุงุฑ ูโฺฉูุฏ.

ูุฑุงุฎูุงู **Post** ูุนุงุฏู ูุฑุงุฎูุงู **BeginInvoke** ุฑู ฺฉ Dispatcher ุง Control ุงุณุช. ููฺูู ูุชุฏ ุจู ูุงู **Send** ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ูุนุงุฏู **Invoke** ุงุณุช.

---

### Thread Pool ๐โโ๏ธ

ููุช ฺฉ thread ุฌุฏุฏ ุงุฌุงุฏ ูโฺฉูุฏุ ฺูุฏ ุตุฏ ูฺฉุฑูุซุงูู ุตุฑู ุขูุงุฏูโุณุงุฒ ฺุฒูุง ูุซู stack ูุชุบุฑูุง ูุญู ูโุดูุฏ. **Thread Pool** ุงู overhead ุฑุง ฺฉุงูุด ูโุฏูุฏ ฺูู ุดุงูู ูุฌููุนูโุง ุงุฒ threadูุง ุงุฒ ูพุด ุณุงุฎุชูโุดุฏู ู ูุงุจู ุจุงุฒุงูุช ุงุณุช.

๐น ุงุณุชูุงุฏู ุงุฒ Thread Pool ุจุฑุง ุจุฑูุงููโููุณ ููุงุฒ ฺฉุงุฑุขูุฏ ู **Concurrency** ุฑุฒุฏุงููโุง ุถุฑูุฑ ุงุณุช. ุงู ฺฉุงุฑ ุงุฌุงุฒู ูโุฏูุฏ ุนููุงุชโูุง ฺฉูุชุงู ุงุฌุฑุง ุดููุฏ ุจุฏูู ุงูฺฉู overhead ุงุฌุงุฏ Thread ุฒุงุฏ ุดูุฏ.

ุงูุง ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ pooled threadูุง ุจุงุฏ ฺูุฏ ูฺฉุชู ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

* ๐ซ ููโุชูุงูุฏ ุฎุงุตุช **Name** ุฑุง ุจุฑุง pooled threadูุง ุชูุธู ฺฉูุฏ (ุงุดฺฉุงูโุฒุฏุง ุณุฎุชโุชุฑ ูโุดูุฏุ ฺฏุฑฺู ุฏุฑ Visual Studio ูโุชูุงูุฏ ฺฉ description ุจู ุขูโูุง ุงุถุงูู ฺฉูุฏ).
* ๐ pooled threadูุง ููุดู **background thread** ูุณุชูุฏ.
* โ ุจูุงฺฉ ฺฉุฑุฏู pooled threadูุง ูโุชูุงูุฏ ุนููฺฉุฑุฏ ุฑุง ฺฉุงูุด ุฏูุฏ (ูฺฏุงู ฺฉูุฏ ุจู ยซHygiene in the thread poolยป).

ูโุชูุงูุฏ **Priority** ฺฉ pooled thread ุฑุง ุชุบุฑ ุฏูุฏุ ููุช thread ุขุฒุงุฏ ุดูุฏ ู ุจู Pool ุจุฑฺฏุฑุฏุฏุ ููุฏุงุฑุด ุฏูุจุงุฑู ุฑู Normal ุชูุธู ูโุดูุฏ.

ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ุขุง ุฏุฑ ุญุงู ุญุงุถุฑ ุฑู ฺฉ pooled thread ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชุฏ ุง ููุ ูโุชูุงูุฏ ุงุฒ ุฎุงุตุช **Thread.CurrentThread.IsThreadPoolThread** ุงุณุชูุงุฏู ฺฉูุฏ.

---

### ูุฑูุฏ ุจู Thread Pool ๐

ุณุงุฏูโุชุฑู ุฑุงู ุงุฌุฑุง ุตุฑุญ ฺฉ ฺฉุงุฑ ุฏุฑ thread pool ุงุณุชูุงุฏู ุงุฒ **Task.Run** ุงุณุช (ุงู ููุถูุน ุฑุง ุฏุฑ ุจุฎุด ุจุนุฏ ฺฉุงููโุชุฑ ุชูุถุญ ูโุฏูู):

```csharp
// Task ุฏุฑ ูุถุง ูุงู System.Threading.Tasks ุงุณุช
Task.Run(() => Console.WriteLine("Hello from the thread pool"));
```

ูุจู ุงุฒ ูุณุฎูโ **.NET Framework 4.0** ฺฉู Task ูุฌูุฏ ูุฏุงุดุชุ ุฑูุด ุฑุงุฌ ุงุณุชูุงุฏู ุงุฒ **ThreadPool.QueueUserWorkItem** ุจูุฏ:

```csharp
ThreadPool.QueueUserWorkItem(notUsed => Console.WriteLine("Hello"));
```

ููฺูู ุงุณุชูุงุฏูโูุง ุฒุฑ ุจูโุทูุฑ ุถูู ุงุฒ thread pool ุจูุฑู ูโุจุฑูุฏ:

* ๐ ุณุฑูุฑูุง ุงูพูฺฉุดู **ASP.NET Core** ู **Web API**
* โฑ๏ธ ฺฉูุงุณโูุง **System.Timers.Timer** ู **System.Threading.Timer**
* ๐ ุณุงุฎุชุงุฑูุง ุจุฑูุงููโููุณ ููุงุฒ (ุชูุถุญ ุฏุฑ ูุตู 22)
* โ๏ธ ฺฉูุงุณ ูุฏู **BackgroundWorker**

---

### ุฑุนุงุช ุจูุฏุงุดุช ุฏุฑ Thread Pool ๐งน

Thread Pool ูุธูู ุฏฺฏุฑ ูู ุฏุงุฑุฏ: ุฌููฺฏุฑ ุงุฒ ุงุฌุงุฏ **oversubscription**.

โ Oversubscription ุนู ุชุนุฏุงุฏ threadูุง ูุนุงู ุจุดุชุฑ ุงุฒ ุชุนุฏุงุฏ ูุณุชูโูุง CPU ุจุงุดุฏ ู ุณุณุชูโุนุงูู ูุฌุจูุฑ ุดูุฏ ุจู ุขูโูุง time-slice ุงูุฌุงู ุฏูุฏ. ุงู ฺฉุงุฑ ฺฉุงุฑุง ุฑุง ฺฉุงูุด ูโุฏูุฏ ฺูู context switch ูพุฑูุฒูู ุงุณุช ู cacheูุง CPU ุฑุง ูู ุจโุงุนุชุจุงุฑ ูโฺฉูุฏ.

โ CLR ุงุฒ oversubscription ุฌููฺฏุฑ ูโฺฉูุฏ ุจุง:

* ุตูโุจูุฏ (queue) ฺฉุฑุฏู ุชุณฺฉโูุง
* ู ฺฉูุชุฑู ุดุฑูุน ุขูโูุง

ุงูู ุจู ุงูุฏุงุฒู ุชุนุฏุงุฏ ูุณุชูโูุง ุณุฎุชโุงูุฒุงุฑ ุชุณฺฉโูุง ุฑุง ุจูโุทูุฑ ููุฒูุงู ุงุฌุฑุง ูโฺฉูุฏุ ุณูพุณ ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ุงูฺฏูุฑุชู hill-climbing ุณุทุญ Concurrency ุฑุง ุชูุธู ูโฺฉูุฏ. ุงฺฏุฑ throughput ุจูุชุฑ ุดูุฏุ ุฏุฑ ููุงู ุฌูุช ุงุฏุงูู ูโุฏูุฏ ูฺฏุฑูู ูุณุฑุด ุฑุง ุนูุถ ูโฺฉูุฏ.

ุงู ุงุณุชุฑุงุชฺ ุฏุฑ ุตูุฑุช ุจูุชุฑู ุนููฺฉุฑุฏ ุฑุง ุฏุงุฑุฏ ฺฉู:

1. ๐ ฺฉุงุฑูุง ฺฉูุชุงูโูุฏุช ุจุงุดูุฏ (ฺฉูุชุฑ ุงุฒ ฒตฐ ููโุซุงููุ ู ุชุฑุฌุญุงู ุฒุฑ ฑฐฐ ููโุซุงูู).
2. ๐ซ ฺฉุงุฑูุง ฺฉู ุจุดุชุฑ ููุชุดุงู ุฑุง ุฏุฑ ุญุงูุช **Blocked** ูุณุชูุฏุ ุบุงูุจ ูุจุงุดูุฏ.

ุจูุงฺฉ ุดุฏู ูุดฺฉูโุณุงุฒ ุงุณุช ฺูู CLR ุชุตูุฑ ูโฺฉูุฏ CPU ุฏุฑฺฏุฑ ุงุณุช. CLR ููุดููุฏ ุงุณุช ู ุจุฑุง ุฌุจุฑุงู threadูุง ุจุดุชุฑ ูุงุฑุฏ Pool ูโฺฉูุฏุ ุงูุง ุงู ฺฉุงุฑ ูโุชูุงูุฏ ุฏูุจุงุฑู ุจู oversubscription ููุฌุฑ ุดูุฏ ู ููฺูู ุจุงุนุซ ุชุฃุฎุฑ (latency) ุดูุฏุ ูุฎุตูุตุงู ุฏุฑ ุงุจุชุฏุง ุงุฌุฑุง ุงูพูฺฉุดู (ุจุดุชุฑ ุฏุฑ ุณุณุชูโุนุงููโูุง client ฺฉู ูุตุฑู ููุงุจุน ูพุงูโุชุฑ ุชุฑุฌุญ ุฏุงุฏู ูโุดูุฏ).

๐ ุฑุนุงุช ุจูุฏุงุดุช ุฏุฑ Thread Pool ููุช ุงููุช ุจุดุชุฑ ุฏุงุฑุฏ ฺฉู ุจุฎูุงูุฏ CPU ุฑุง ุจูโุทูุฑ ฺฉุงูู ุงุณุชูุงุฏู ฺฉูุฏ (ูุซูุงู ุจุง ุงุณุชูุงุฏู ุงุฒ APIูุง ุจุฑูุงููโููุณ ููุงุฒ ุฏุฑ ูุตู 22).

### ุชุณฺฉโูุง (Tasks) โก

๐น ฺฉ **Thread** ุงุจุฒุงุฑ ุณุทุญ ูพุงู ุจุฑุง ุงุฌุงุฏ **Concurrency** ุงุณุช ู ูุญุฏูุฏุชโูุง ุฏุงุฑุฏุ ุงุฒ ุฌููู:

* ๐ฅ ุงฺฏุฑฺู ูุฑุณุชุงุฏู ุฏุงุฏู ุจู ุฏุงุฎู ฺฉ Thread ฺฉู ุงุฌุงุฏ ฺฉุฑุฏูโุงุฏ ุณุงุฏู ุงุณุชุ ฺฏุฑูุชู ฺฉ **ููุฏุงุฑ ุจุงุฒฺฏุดุช (return value)** ุงุฒ Thread ฺฉู Join ฺฉุฑุฏูโุงุฏ ุขุณุงู ูุณุช. ุจุงุฏ ฺฉ **ููุฏ ูุดุชุฑฺฉ** ุชูุธู ฺฉูุฏ. ููฺูู ุงฺฏุฑ ุนููุงุช ฺฉ **Exception** ูพุฑุชุงุจ ฺฉูุฏุ ฺฏุฑูุชู ู ููุชูู ฺฉุฑุฏู ุขู ูู ุฏุฑุฏุณุฑ ุฏุงุฑุฏ.
* ๐ ููโุชูุงูุฏ ุจู Thread ุจฺฏูุฏ ููุช ุชูุงู ุดุฏ ฺุฒ ุฏฺฏุฑ ุฑุง ุดุฑูุน ฺฉูุฏุ ุจูฺฉู ุจุงุฏ ุขู ุฑุง Join ฺฉูุฏ (ฺฉู ุจุงุนุซ ุจูุงฺฉ ุดุฏู Thread ุฎูุฏุชุงู ูโุดูุฏ).

ุงู ูุญุฏูุฏุชโูุง ุจุงุนุซ ูโุดููุฏ **Concurrency ุฑุฒุฏุงููโุง (fine-grained)** ุณุฎุช ุดูุฏุ ุนู ุชุฑฺฉุจ ุนููุงุชโูุง ฺฉูฺฺฉโุชุฑ ุจุฑุง ุณุงุฎุช ุนููุงุชโูุง ููุฒูุงู ุจุฒุฑฺฏโุชุฑ ูุดฺฉู ุงุณุช (ฺฉู ุจุฑุง **ุจุฑูุงููโููุณ Asynchronous** ุญุงุช ุงุณุช). ุฏุฑ ูุชุฌู ูุงุฒ ุจู **synchronization ุฏุณุช** (ูุซู Lockingุ Signaling ู ุบุฑู) ุจุดุชุฑ ูโุดูุฏ ฺฉู ุฎูุฏุด ูุดฺฉูุงุช ุฏฺฏุฑ ุฏุงุฑุฏ.

ููฺูู ุงุณุชูุงุฏู ูุณุชูู ุงุฒ Threadูุง ุงุซุฑุงุช ููู ุฑู **ฺฉุงุฑุง** ุฏุงุฑุฏ (ุชูุถุญ ุฏุฑ ุจุฎุด ยซThread Poolยป). ุงฺฏุฑ ูุงุฒ ุจู ุงุฌุฑุง ุตุฏูุง ุง ูุฒุงุฑุงู ุนููุงุช I/O ููุฒูุงู ุฏุงุดุชู ุจุงุดุฏุ ุฑูฺฉุฑุฏ Threadโูุญูุฑ ุจุงุนุซ ูุตุฑู ุตุฏูุง ุง ูุฒุงุฑุงู ูฺฏุงุจุงุช ุญุงูุธู ุตุฑูุงู ุจุฑุง overhead ูุฑุจูุท ุจู Threadูุง ูโุดูุฏ.

โ ฺฉูุงุณ **Task** ุจู ููู ุงู ูุดฺฉูุงุช ฺฉูฺฉ ูโฺฉูุฏ. **Task** ูุณุจุช ุจู Thread ฺฉ **ุงูุชุฒุงุน ุณุทุญ ุจุงูุงุชุฑ** ุงุณุชุ ุนู ูุดุงูโุฏููุฏู ฺฉ ุนููุงุช ููุฒูุงู ุงุณุช ฺฉู ููฺฉู ุงุณุช ูพุดุชุจุงูโุดุฏู ุชูุณุท Thread ุจุงุดุฏ ุง ูุจุงุดุฏ.

ูฺฺฏโูุง:

* ๐ **Taskูุง ุชุฑฺฉุจโูพุฐุฑ (compositional)** ูุณุชูุฏ (ูโุชูุงูุฏ ุขูโูุง ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ Continuationูุง ุจู ูู ุฒูุฌุฑ ฺฉูุฏ).
* ๐ ูโุชูุงููุฏ ุงุฒ Thread Pool ุงุณุชูุงุฏู ฺฉููุฏ ุชุง ุฒูุงู ุดุฑูุน ุฑุง ฺฉู ฺฉููุฏ.
* ๐ ุจุง ุงุณุชูุงุฏู ุงุฒ **TaskCompletionSource** ูโุชูุงููุฏ ุฑูฺฉุฑุฏ Callback ุฑุง ูพุงุฏูโุณุงุฒ ฺฉููุฏ ฺฉู ุงุตูุงู ูุงุฒ ุจู Threadูุง ูุฏุงุฑุฏ (ููุงุณุจ ุจุฑุง ุนููุงุช I/O-bound).

ฺฉูุงุณโูุง Task ุฏุฑ **.NET Framework 4.0** ุจูโุนููุงู ุจุฎุด ุงุฒ ฺฉุชุงุจุฎุงูู ุจุฑูุงููโููุณ ููุงุฒ ูุนุฑู ุดุฏูุฏุ ู ุจุนุฏุงู ุจุง **awaiters** ุจูุจูุฏ ูพุฏุง ฺฉุฑุฏูุฏ ุชุง ุฏุฑ ุณูุงุฑููุง ุนููู Concurrency ูู ุฎูุจ ฺฉุงุฑ ฺฉููุฏ. ุขูโูุง ููฺูู ูพุงูโ **ุชูุงุจุน Asynchronous ุฏุฑ C#** ูุณุชูุฏ.

(ุฏุฑ ุงู ุจุฎุดุ ูฺฺฏโูุง Task ูุฑุชุจุท ุจุง **ุจุฑูุงููโููุณ ููุงุฒ** ุฑุง ฺฉูุงุฑ ูโฺฏุฐุงุฑู ู ุฏุฑ ูุตู 22 ุจู ุขูโูุง ูโูพุฑุฏุงุฒู.)

---

### ุดุฑูุน ฺฉ Task โถ๏ธ

ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง ุดุฑูุน ฺฉ Task ูพุดุชุจุงูโุดุฏู ุชูุณุท Thread ุงุณุชูุงุฏู ุงุฒ ูุชุฏ ุงุณุชุง **Task.Run** ุงุณุช (ฺฉูุงุณ Task ุฏุฑ ูุถุง ูุงู **System.Threading.Tasks** ุงุณุช):

```csharp
Task.Run(() => Console.WriteLine("Foo"));
```

ุจูโุทูุฑ ูพุดโูุฑุถุ Taskูุง ุฑู **Thread Pool** ุงุฌุฑุง ูโุดููุฏ ฺฉู **background thread** ูุณุชูุฏ.
ุนู ููุช **main thread** ุชูุงู ุดูุฏุ ููู Taskูุง ฺฉู ุณุงุฎุชูโุงุฏ ูู ูุชููู ูโุดููุฏ.

ูพุณ ุฏุฑ ฺฉ **Console Application**ุ ุจุงุฏ main thread ุฑุง ุจุนุฏ ุงุฒ ุดุฑูุน Task ุจูุงฺฉ ฺฉูุฏ (ูุซูุงู ุจุง **Wait** ุฑู Task ุง ุจุง **Console.ReadLine**):

```csharp
Task.Run(() => Console.WriteLine("Foo"));
Console.ReadLine();
```

ุฏุฑ **LINQPad** ูุงุฒ ุจู `Console.ReadLine` ูุณุชุ ฺูู ูพุฑูุณูโ LINQPad ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ background threadูุง ุฑุง ุฒูุฏู ูฺฏู ูโุฏุงุฑุฏ.

ูุฑุงุฎูุงู **Task.Run** ุชูุฑุจุงู ุดุจู ุจู ุงุฌุงุฏ ฺฉ Thread ุงุณุช:

```csharp
new Thread(() => Console.WriteLine("Foo")).Start();
```

ุงูุง `Task.Run` ฺฉ **Task object** ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ูโุชูุงูู ูุถุนุช ูพุดุฑูุช ุขู ุฑุง ูุงูุชูุฑ ฺฉูู (ูุดุงุจู Thread object).
ุชูุฌู ฺฉูุฏ ฺฉู ุจุนุฏ ุงุฒ `Task.Run` ุฏฺฏุฑ **Start** ููโุฒูู ฺูู ุงู ูุชุฏ **Hot Task** ุงุฌุงุฏ ูโฺฉูุฏ. (ูโุชูุงูุฏ ุจุง ุณุงุฒูุฏูโ Task ฺฉ **Cold Task** ุจุณุงุฒุฏุ ุงูุง ุฏุฑ ุนูู ฺฉูโุงุณุชูุงุฏู ุงุณุช.)

ูโุชูุงูุฏ ูุถุนุช ุงุฌุฑุง Task ุฑุง ุงุฒ ุทุฑู ุฎุงุตุช **Status** ุจุฑุฑุณ ฺฉูุฏ.

---

### Wait โณ

ูุฑุงุฎูุงู **Wait** ุฑู ฺฉ Task ุจุงุนุซ ุจูุงฺฉ ุดุฏู ูโุดูุฏ ุชุง Task ฺฉุงูู ุดูุฏ (ูุดุงุจู ูุฑุงุฎูุงู **Join** ุฑู ฺฉ Thread):

```csharp
Task task = Task.Run(() =>
{
    Thread.Sleep(2000);
    Console.WriteLine("Foo");
});
Console.WriteLine(task.IsCompleted);  // False
task.Wait();  // ุชุง ุชฺฉูู Task ุจูุงฺฉ ูโุดูุฏ
```

ูุชุฏ Wait ุงูฺฉุงู ุชุนู **Timeout** ู **CancellationToken** ุฑุง ูู ูโุฏูุฏ (ุชูุถุญ ุฏุฑ ุจุฎุด ยซCancellationยป ุตูุญู 681).

---

### Long-running Tasks ๐ข

ุจูโุทูุฑ ูพุดโูุฑุถุ CLR ุชุณฺฉโูุง ุฑุง ุฑู pooled threads ุงุฌุฑุง ูโฺฉูุฏ ฺฉู ุจุฑุง ฺฉุงุฑูุง **ฺฉูุชุงูโูุฏุช ู compute-bound** ุงุฏูโุขู ุงุณุช.

ุจุฑุง ฺฉุงุฑูุง **ุจููุฏูุฏุช ุง blocking** ูโุชูุงูุฏ ูุงูุน ุงุณุชูุงุฏู ุงุฒ pooled thread ุดูุฏ:

```csharp
Task task = Task.Factory.StartNew(() => ...,
    TaskCreationOptions.LongRunning);
```

ุงุฌุฑุง ฺฉ ุชุณฺฉ ุจููุฏูุฏุช ุฑู ฺฉ pooled thread ูุดฺฉู ูุฏุงุฑุฏุ ุงูุง ุงฺฏุฑ ฺูุฏู ุชุณฺฉ ุจููุฏูุฏุช ููุงุฒ ุงุฌุฑุง ุดููุฏ (ุฎุตูุตุงู ุขูโูุง ฺฉู Block ูโุดููุฏ)ุ ุนููฺฉุฑุฏ ฺฉุงูุด ูโุงุจุฏ.

ุฑุงูฺฉุงุฑูุง ุจูุชุฑ ุฏุฑ ุงู ุญุงูุช:

* ุงฺฏุฑ ุชุณฺฉโูุง **I/O-bound** ูุณุชูุฏ: ุงุฒ **TaskCompletionSource** ู ุชูุงุจุน **Asynchronous** ุจุฑุง ูพุงุฏูโุณุงุฒ Concurrency ุจุง Callbackูุง ุงุณุชูุงุฏู ฺฉูุฏ.
* ุงฺฏุฑ ุชุณฺฉโูุง **Compute-bound** ูุณุชูุฏ: ุงุฒ ฺฉ **Producer/Consumer Queue** ุงุณุชูุงุฏู ฺฉูุฏ ุชุง Concurrency ุฑุง ฺฉูุชุฑู ฺฉุฑุฏู ู ุฌูู ฺฏุฑุณูฺฏ ุณุงุฑ Threadูุง ู ูพุฑูุณูโูุง ุฑุง ุจฺฏุฑุฏ (ุชูุถุญ ุฏุฑ ยซProducer/Consumer Queueยป ุตูุญู 970).

---

### ุจุงุฒฺฏุฑุฏุงูุฏู ููุงุฏุฑ ๐ข

ฺฉูุงุณ Task ฺฉ ุฒุฑฺฉูุงุณ ุฌูุฑฺฉ ุจู ูุงู **Task<TResult>** ุฏุงุฑุฏ ฺฉู ุงุฌุงุฒู ูโุฏูุฏ ฺฉ ููุฏุงุฑ ุจุงุฒฺฏุดุช ุชููุฏ ฺฉูุฏ.

ูโุชูุงูุฏ ุจุง ุฏุงุฏู ฺฉ **Func<TResult>** (ุง lambda expression ุณุงุฒฺฏุงุฑ) ุจู Task.Run ฺฉ Task<TResult> ุจุณุงุฒุฏ:

```csharp
Task<int> task = Task.Run(() => 
{ 
    Console.WriteLine("Foo"); 
    return 3; 
});
int result = task.Result;   // ุจูุงฺฉ ูโุดูุฏ ุชุง Task ุชูุงู ุดูุฏ
Console.WriteLine(result);  // 3
```

ููููู: ูุญุงุณุจู ุชุนุฏุงุฏ ุงุนุฏุงุฏ ุงูู ุฏุฑ ุณู ูููู ุนุฏุฏ ุงูู:

```csharp
Task<int> primeNumberTask = Task.Run(() =>
    Enumerable.Range(2, 3000000)
              .Count(n => Enumerable.Range(2, (int)Math.Sqrt(n)-1)
              .All(i => n % i > 0)));

Console.WriteLine("Task running...");
Console.WriteLine("The answer is " + primeNumberTask.Result);
```

ุฎุฑูุฌ:

```
Task running...
The answer is 216816
```

---

### ูุฏุฑุช Exceptionูุง โ๏ธ

๐ฎ **Task<TResult>** ุดุจู ฺฉ *Future* ุงุณุชุ ุนู ูุชุฌูโุง ุฑุง ุฏุฑ ุขูุฏู ูฺฏู ูโุฏุงุฑุฏ.
ุจุฑุฎูุงู Threadูุงุ ุชุณฺฉโูุง Exceptionูุง ุฑุง ุฑุงุญุช ููุชูู ูโฺฉููุฏ.

ุงฺฏุฑ ฺฉุฏ ุฏุงุฎู Task ฺฉ Exception ูุฏุฑุชโูุดุฏู ูพุฑุชุงุจ ฺฉูุฏ:

* ุงฺฏุฑ Wait ฺฉูุฏ ุง ุจู Result ุฏุณุชุฑุณ ุจุฒูุฏุ Exception ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดูุฏ.

```csharp
// ุดุฑูุน ฺฉ Task ฺฉู NullReferenceException ูพุฑุชุงุจ ูโฺฉูุฏ:
Task task = Task.Run(() => { throw null; });

try
{
    task.Wait();
}
catch (AggregateException aex)
{
    if (aex.InnerException is NullReferenceException)
        Console.WriteLine("Null!");
    else
        throw;
}
```

๐งฉ CLR Exception ุฑุง ุฏุฑ ฺฉ **AggregateException** ุจุณุชูโุจูุฏ ูโฺฉูุฏ ุชุง ุจุง ุณูุงุฑููุง ุจุฑูุงููโููุณ ููุงุฒ ููโุฎูุงู ุฏุงุดุชู ุจุงุดุฏ (ุชูุถุญ ุฏุฑ ูุตู 22).

ูโุชูุงูุฏ ุจุฏูู ูพุฑุชุงุจ Exception ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง Task Faulted ุดุฏู ุง ููุ ุจุง ุงุณุชูุงุฏู ุงุฒ ูฺฺฏโูุง:

* **IsFaulted**
* **IsCanceled**

ุงฺฏุฑ ูุฑ ุฏู `false` ุจุงุดูุฏุ ุฎุทุง ุฑุฎ ูุฏุงุฏู.

* ุงฺฏุฑ `IsCanceled = true` ุจุงุดุฏุ ุนู ฺฉ **OperationCanceledException** ูพุฑุชุงุจ ุดุฏู (ุชูุถุญ ุฏุฑ ุจุฎุด ยซCancellationยป ุตูุญู 941).
* ุงฺฏุฑ `IsFaulted = true` ุจุงุดุฏุ ููุน ุฏฺฏุฑ ุงุฒ Exception ุฑุฎ ุฏุงุฏู ู ุฎุงุตุช **Exception** ุฌุฒุฆุงุช ุฎุทุง ุฑุง ูุดุงู ูโุฏูุฏ.

### ุงุณุชุซูุงูุง ู Taskูุง ูุณุชูู ๐จ

ุฏุฑ ููุฑุฏ Taskูุง ูุณุชูู ุง ููุงู **set-and-forget** (ุนู ุขูโูุง ฺฉู ุดูุง ุฏฺฏุฑ ุจุง `Wait()` ุง `Result` ุง continuation ุจู ุณุฑุงุบุดุงู ููโุฑูุฏ)ุ ฺฉ **ุฑูุด ุฏุฑุณุช** ุงู ุงุณุช ฺฉู ุญุชูุงู ฺฉุฏ Task ุฑุง ุจูโุตูุฑุช ุตุฑุญ ูุฏุฑุช ุงุณุชุซูุง ุจููุณุฏ ุชุง ุงุฒ ุดฺฉุณุชโูุง ุฎุงููุด ุฌููฺฏุฑ ฺฉูุฏุ ุฏููุงู ููุงูโุทูุฑ ฺฉู ุฏุฑ ฺฉ Thread ุนุงุฏ ุนูู ูโฺฉูุฏ.

ูุงุฏุฏู ฺฏุฑูุชู ุงุณุชุซูุงูุง ุฒูุงู ูุดฺฉู ูุฏุงุฑุฏ ฺฉู ุขู ุงุณุชุซูุง ููุท ุจู ูุนู ุดฺฉุณุช ุฏุฑ ฺฏุฑูุชู ูุชุฌูโุง ุจุงุดุฏ ฺฉู ุฏฺฏุฑ ุจู ุขู ุนูุงููโุง ูุฏุงุฑุฏ.
๐ ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏุฑุฎูุงุณุช ุฏุงูููุฏ ฺฉ ุตูุญู ูุจ ุฑุง ูุบู ฺฉูุฏุ ุจุฑุงูุงู ููู ูุณุช ฺฉู ุฏุฑ ุงุฏุงูู ูุดุฎุต ุดูุฏ ุขู ุตูุญู ุงุตูุงู ูุฌูุฏ ูุฏุงุดุชู ุงุณุช.

ุงูุง ูุงุฏุฏู ฺฏุฑูุชู ุงุณุชุซูุง ุฒูุงู ูุดฺฉูโุณุงุฒ ูโุดูุฏ ฺฉู ุขู ุงุณุชุซูุง ูุดุงูโุฏููุฏูโ ฺฉ **ุจุงฺฏ ุฏุฑ ุจุฑูุงูู** ุจุงุดุฏุ ุจู ุฏู ุฏูู:

* ๐ ููฺฉู ุงุณุช ุจุงฺฏ ุจุงุนุซ ุดูุฏ ุจุฑูุงูู ุฏุฑ ฺฉ ูุถุนุช ูุงูุนุชุจุฑ ุจุงู ุจูุงูุฏ.
* ๐งฉ ุงุญุชูุงู ุฏุงุฑุฏ ุงุณุชุซูุงูุง ุจุดุชุฑ ุฏุฑ ุขูุฏู ุฑุฎ ุฏููุฏ ู ุงฺฏุฑ ุฎุทุง ุงููู ุซุจุช (log) ูุดูุฏุ ุชุดุฎุต ูุดฺฉู ุณุฎุช ุฎูุงูุฏ ุดุฏ.

ุดูุง ูโุชูุงูุฏ ุงุณุชุซูุงูุง ูุดุงูุฏูโูุดุฏู ุฑุง ุฏุฑ ุณุทุญ ุณุฑุงุณุฑ ูุฏุฑุช ฺฉูุฏุ ุงุฒ ุทุฑู ุฑูุฏุงุฏ ุงุณุชุงุชฺฉ `TaskScheduler.UnobservedTaskException`. ูุฏุฑุช ุงู ุฑูุฏุงุฏ ู ุซุจุช ุฎุทุง ูโุชูุงูุฏ ุจุณุงุฑ ููุทู ุจุงุดุฏ.

---

### ูฺฉุงุช ุธุฑู ุฏุฑุจุงุฑูโ ุงุณุชุซูุงูุง ูุดุงูุฏูโูุดุฏู ๐ต๏ธโโ๏ธ

ฺูุฏ ูฺฉุชู ุฌุงูุจ ุฏุฑ ููุฑุฏ ุงูฺฉู ฺู ฺุฒ **unobserved** ูุญุณูุจ ูโุดูุฏ ูุฌูุฏ ุฏุงุฑุฏ:

* ุงฺฏุฑ ุฑู ฺฉ Task ุจุง ุฒูุงูโุจูุฏ (timeout) ููุชุธุฑ ุจูุงูุฏ ู ุฎุทุง ุจุนุฏ ุงุฒ ูพุงุงู ุฒูุงู ุฑุฎ ุฏูุฏุ ุขู ุฎุทุง ุจูโุนููุงู ุงุณุชุซูุง ูุดุงูุฏูโูุดุฏู ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ.
* ููู ฺฉู ูฺฺฏ `Exception` ฺฉ Task ุฑุง ุจุนุฏ ุงุฒ fault ุดุฏู ุจุฑุฑุณ ฺฉูุฏุ ุขู ุงุณุชุซูุง ยซobservedยป ูุญุณูุจ ูโุดูุฏ.

---

### Continuations ๐

ฺฉ Continuation ุจู ฺฉ Task ูโฺฏูุฏ: ยซููุช ฺฉุงุฑุช ุชูุงู ุดุฏุ ุงุฏุงูู ุจุฏู ู ฺฉ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุจุฏู.ยป
ูุนูููุงู Continuation ุจูโุตูุฑุช ฺฉ **callback** ูพุงุฏูโุณุงุฒ ูโุดูุฏ ฺฉู ุฏุฑุณุช ูพุณ ุงุฒ ุงุชูุงู ุนููุงุช ุงุฌุฑุง ูโฺฏุฑุฏุฏ.

ุฏู ุฑูุด ุจุฑุง ุงุชุตุงู Continuation ุจู ฺฉ Task ูุฌูุฏ ุฏุงุฑุฏ. ุฑูุด ุงูู ุงููุช ูฺูโุง ุฏุงุฑุฏุ ฺูู ุชูุณุท ุชูุงุจุน **asynchronous ุฏุฑ C#** ุงุณุชูุงุฏู ูโุดูุฏ. ูุซุงู ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ (ููุงู ูุซุงู ุดูุงุฑุด ุงุนุฏุงุฏ ุงูู):

```csharp
Task<int> primeNumberTask = Task.Run(() =>
  Enumerable.Range(2, 3000000).Count(n => 
    Enumerable.Range(2, (int)Math.Sqrt(n) - 1).All(i => n % i > 0)));

var awaiter = primeNumberTask.GetAwaiter();
awaiter.OnCompleted(() =>
{
  int result = awaiter.GetResult();
  Console.WriteLine(result); // ููุงุด ูุชุฌู
});
```

ูุฑุงุฎูุงู `GetAwaiter` ุฑู ฺฉ Taskุ ฺฉ **awaiter object** ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ูุชุฏ `OnCompleted` ุขูุ ุจู Task ูโฺฏูุฏ ูพุณ ุงุฒ ูพุงุงู (ุง ุฎุทุง)ุ ฺฉุฏุงู delegate ุงุฌุฑุง ุดูุฏ.
ุญุช ูโุชูุงูุฏ ฺฉ Continuation ุฑุง ุฑู Task ฺฉู ูุจูุงู ฺฉุงูู ุดุฏู ูุตู ฺฉูุฏุ ุฏุฑ ุงู ุตูุฑุชุ Continuation ุจูุงูุงุตูู ุฒูุงูโุจูุฏ ู ุงุฌุฑุง ูโุดูุฏ.

ฺฉ **awaiter** ูุฑ ุดุฆ ุงุณุช ฺฉู ุฏู ูุชุฏ (`OnCompleted` ู `GetResult`) ู ฺฉ ูฺฺฏ ุจูู (`IsCompleted`) ุฏุงุดุชู ุจุงุดุฏ. ูฺ interface ุง ฺฉูุงุณ ูพุงูโ ูุดุชุฑฺฉ ุจุฑุง ููู ุงู ููุงุฑุฏ ูุฌูุฏ ูุฏุงุฑุฏ (ุงูุจุชู `OnCompleted` ุจุฎุด ุงุฒ ุงูุชุฑูุณ `INotifyCompletion` ุงุณุช).

๐ ุงฺฏุฑ Task ูุงุฏุฑ fault ุดูุฏุ ุงุณุชุซูุง ุฒูุงู ฺฉู continuation ูุฑุงุฎูุงู `GetResult()` ุฑุง ุงูุฌุงู ูโุฏูุฏ ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดูุฏ.
ุจุฑุชุฑ `GetResult` ูุณุจุช ุจู ุฏุณุชุฑุณ ูุณุชูู ุจู `Result` ุงู ุงุณุช ฺฉู ุงุณุชุซูุงูุง ุฑุง ุจุฏูู ุจุณุชูโุจูุฏ ุฏุฑ `AggregateException` ูพุฑุชุงุจ ูโฺฉูุฏุ ฺฉู ุจุงุนุซ ฺฉุฏูุง `catch` ุชูุฒุชุฑ ูโุดูุฏ.

---

### ูฺฉุชู ุฏุฑุจุงุฑูโ Synchronization Context ๐๏ธ

ุงฺฏุฑ ฺฉ **SynchronizationContext** ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ `OnCompleted` ุขู ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ capture ูโฺฉูุฏ ู continuation ุฑุง ุฏุฑ ููุงู context ุงุฌุฑุง ูโฺฉูุฏ. ุงู ุจุฑุง ุงูพูฺฉุดูโูุง ุฑุงุจุท ฺฉุงุฑุจุฑ (UI) ุจุณุงุฑ ููุฏ ุงุณุชุ ฺูู Continuation ุจู ูุฎ UI ุจุงุฒฺฏุฑุฏุงูุฏู ูโุดูุฏ.

ุงูุง ุฏุฑ ฺฉุชุงุจุฎุงููโูุง ูุนูููุงู ูุทููุจ ูุณุชุ ฺูู ุงู ูพุฑุด ุจู ูุฎ UI ูุฒููโุจุฑ ุงุณุช.
ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุขู ูโุชูุงู ุงุฒ ูุชุฏ `ConfigureAwait(false)` ุงุณุชูุงุฏู ฺฉุฑุฏ:

```csharp
var awaiter = primeNumberTask.ConfigureAwait(false).GetAwaiter();
```

ุงฺฏุฑ ูฺ SynchronizationContextุง ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏโุง ุดูุง `ConfigureAwait(false)` ุงุณุชูุงุฏู ฺฉูุฏโContinuation ุจูโุทูุฑ ฺฉู ุฑู ฺฉ **pooled thread** ุงุฌุฑุง ูโุดูุฏ.

---

### ุฑูุด ุฏูู: ContinueWith ๐งฉ

ุฑูุด ุฏฺฏุฑ ุงุชุตุงู Continuationุ ูุฑุงุฎูุงู ูุชุฏ `ContinueWith` ุฑู Task ุงุณุช:

```csharp
primeNumberTask.ContinueWith(antecedent =>
{
  int result = antecedent.Result;
  Console.WriteLine(result); // ููุงุด 123
});
```

๐น `ContinueWith` ุฎูุฏุด ฺฉ Task ุจุฑูโฺฏุฑุฏุงูุฏุ ุจูุงุจุฑุงู ูโุชูุงูุฏ ฺูุฏู Continuation ุฒูุฌุฑูโุง ุจุณุงุฒุฏ.
ุงูุง ุฏุฑ ุงู ุญุงูุช ุจุงุฏ ุจูโุตูุฑุช ูุณุชูู ุจุง `AggregateException` ุณุฑูฺฉุงุฑ ุฏุงุดุชู ุจุงุดุฏ ู ุจุฑุง ุงูพูฺฉุดูโูุง UI ฺฉุฏ ุงุถุงู ุจุฑุง **marshal ฺฉุฑุฏู** Continuation ุจููุณุฏ.
ููฺูู ุฏุฑ ูุญุทโูุง ุบุฑ UIุ ุงฺฏุฑ ุจุฎูุงูุฏ Continuation ุฑู ููุงู ูุฎ ุงุฌุฑุง ุดูุฏุ ุจุงุฏ ฺฏุฒููโ `TaskContinuationOptions.ExecuteSynchronously` ุฑุง ูุดุฎุต ฺฉูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุจู thread pool ูพุฑุด ุฎูุงูุฏ ฺฉุฑุฏ.

๐ `ContinueWith` ุจูโูฺู ุฏุฑ ุณูุงุฑููุง **parallel programming** ููุฏ ุงุณุช (ุฏุฑ ูุตู 22 ุจูโุทูุฑ ฺฉุงูู ุจุฑุฑุณ ุฎูุงูุฏ ุดุฏ).

---

### TaskCompletionSource โก

ุชุง ุงูุฌุง ุฏุฏู ฺฉู `Task.Run` ฺฉ Task ูโุณุงุฒุฏ ฺฉู delegate ุฑุง ุฑู ฺฉ ูุฎ (pooled ุง ุบุฑ pooled) ุงุฌุฑุง ูโฺฉูุฏ. ุงูุง ุฑูุด ุฏฺฏุฑ ุงุณุชูุงุฏู ุงุฒ `TaskCompletionSource` ุงุณุช.

`TaskCompletionSource` ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ฺฉ Task ุจุณุงุฒุฏ ฺฉู ุญุงุตู ูุฑ ุนููุงุช ุจุงุดุฏ ฺฉู ุฏุฑ ุขูุฏู ฺฉุงูู ุฎูุงูุฏ ุดุฏ. ุงู ฺฉุงุฑ ุงุฒ ุทุฑู ุณุงุฎุช ฺฉ Task ยซูุงุจุณุชูยป ุงูุฌุงู ูโุดูุฏ ฺฉู ุดูุง ุจูโุทูุฑ ุฏุณุช ฺฉูุชุฑูุด ูโฺฉูุฏ (ุจุง ูุดุฎุต ฺฉุฑุฏู ุฒูุงู ูพุงุงู ุง fault ุดุฏู ุนููุงุช).

ุงู ุฑูุด ุจุฑุง ุนููุงุชโูุง I/O-bound ุนุงู ุงุณุช: ุดูุง ููู ูุฒุงุง Taskูุง (ุงูุชูุงู ููุงุฏุฑ ุจุงุฒฺฏุดุชุ ุงุณุชุซูุงูุง ู Continuationูุง) ุฑุง ุฏุงุฑุฏุ ุจุฏูู ุงูฺฉู ฺฉ ูุฎ ุจุฑุง ฺฉู ูุฏุช ุงุดุบุงู ุดูุฏ.

ุจุฑุง ุงุณุชูุงุฏูุ ฺฉุงูุณุช ฺฉ ููููู ุงุฒ ฺฉูุงุณ ุจุณุงุฒุฏ. ุงู ฺฉูุงุณ ฺฉ ูฺฺฏ ุจู ูุงู `Task` ุฏุงุฑุฏ ฺฉู ููุงู Task ุงุณุช ฺฉู ูโุชูุงูุฏ ุฑู ุขู ููุชุธุฑ ุจูุงูุฏ ุง Continuation ูุตู ฺฉูุฏ. ฺฉูุชุฑู ฺฉุงูู Task ูู ุจุง ุฎูุฏ `TaskCompletionSource` ุงุณุช ุงุฒ ุทุฑู ูุชุฏูุง ุฒุฑ:

```csharp
public class TaskCompletionSource<TResult>
{
  public void SetResult (TResult result);
  public void SetException (Exception exception);
  public void SetCanceled();
  public bool TrySetResult (TResult result);
  public bool TrySetException (Exception exception);
  public bool TrySetCanceled();
  public bool TrySetCanceled (CancellationToken cancellationToken);
  ...
}
```

ูุฑุงุฎูุงู ูุฑฺฉุฏุงู ุงุฒ ุงู ูุชุฏูุง Task ุฑุง ุณฺฏูุงู ูโุฏูุฏ ู ุขู ุฑุง ุฏุฑ ูุถุนุช **completed**ุ **faulted** ุง **canceled** ูุฑุงุฑ ูโุฏูุฏ.

๐ ุงูุชุธุงุฑ ุงู ุงุณุช ฺฉู ุฏููุงู ฺฉ ุงุฒ ุงู ูุชุฏูุง ฺฉโุจุงุฑ ูุฑุงุฎูุงู ุดูุฏ. ุงฺฏุฑ ุฏูุจุงุฑู `SetResult`, `SetException` ุง `SetCanceled` ุตุฏุง ุฒุฏู ุดููุฏุ ุงุณุชุซูุง ูพุฑุชุงุจ ูโฺฉููุฏ. ุฏุฑุญุงูโฺฉู ูุชุฏูุง `Try*` ููุท ููุฏุงุฑ `false` ุจุฑูโฺฏุฑุฏุงููุฏ.

---

### ููููู ฺฉุฏ: ฺุงูพ ุนุฏุฏ ดฒ ุจุนุฏ ุงุฒ ต ุซุงูู ๐

```csharp
var tcs = new TaskCompletionSource<int>();
new Thread(() => { Thread.Sleep(5000); tcs.SetResult(42); })
{ IsBackground = true }
.Start();
Task<int> task = tcs.Task;         
Console.WriteLine(task.Result);   // 42
```

---

### ููุดุชู ูุชุฏ Run ุงุฎุชุตุงุต ๐

```csharp
Task<TResult> Run<TResult>(Func<TResult> function)
{
  var tcs = new TaskCompletionSource<TResult>();
  new Thread(() =>
  {
    try { tcs.SetResult(function()); }
    catch (Exception ex) { tcs.SetException(ex); }
  }).Start();
  return tcs.Task;
}
...
Task<int> task = Run(() => { Thread.Sleep(5000); return 42; });
```

ุงู ฺฉุงุฑ ูุนุงุฏู ูุฑุงุฎูุงู `Task.Factory.StartNew` ุจุง ฺฏุฒููโ `TaskCreationOptions.LongRunning` ุงุณุช.

---

### ูุฏุฑุช ุงุตู TaskCompletionSource โก

ูุฏุฑุช ูุงูุน ุงู ุฑูุด ุฏุฑ ุณุงุฎุช Taskูุง ุงุณุช ฺฉู **ูุฎ ุฑุง ุงุดุบุงู ููโฺฉููุฏ**. ุจุฑุง ูุซุงู:
ูโุฎูุงูู Task ุจุณุงุฒู ฺฉู ุจุนุฏ ุงุฒ ต ุซุงูู ููุฏุงุฑ ดฒ ุฑุง ุจุฑฺฏุฑุฏุงูุฏ. ูโุชูุงูู ุจุฏูู ุงุณุชูุงุฏู ุงุฒ Thread ู ููุท ุจุง ุงุณุชูุงุฏู ุงุฒ `Timer` ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏูู:

```csharp
Task<int> GetAnswerToLife()
{
  var tcs = new TaskCompletionSource<int>();
  var timer = new System.Timers.Timer(5000) { AutoReset = false };
  timer.Elapsed += delegate { timer.Dispose(); tcs.SetResult(42); };
  timer.Start();
  return tcs.Task;
}
```

ุจุง ูุตู ฺฉุฑุฏู ฺฉ Continuation ุจู ุงู Task:

```csharp
var awaiter = GetAnswerToLife().GetAwaiter();
awaiter.OnCompleted(() => Console.WriteLine(awaiter.GetResult()));
```

---

### ุณุงุฎุช ูุชุฏ Delay ุนููู โฑ๏ธ

ูโุชูุงูู ฺฉุฏ ุจููุณู ฺฉู ููุท ุตุจุฑ ฺฉูุฏ (ุจุฏูู ููุฏุงุฑ ุจุงุฒฺฏุดุช):

```csharp
Task Delay(int milliseconds)
{
  var tcs = new TaskCompletionSource<object>();
  var timer = new System.Timers.Timer(milliseconds) { AutoReset = false };
  timer.Elapsed += delegate { timer.Dispose(); tcs.SetResult(null); };
  timer.Start();
  return tcs.Task;
}
```

๐ ุฏุฑ .NET 5 ุจู ุจุนุฏุ ูุณุฎูโ ุบุฑ generic ุงุฒ TaskCompletionSource ูุนุฑู ุดุฏู ุงุณุชุ ุจูุงุจุฑุงู ูโุชูุงูุฏ ุจูโุฌุง `TaskCompletionSource<object>` ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุฏ.

---

### ุงุฌุฑุง ฑฐ,ฐฐฐ ุนููุงุช ููุฒูุงู ๐

ุงุฒ ุขูุฌุง ฺฉู ุงู ุฑูุด ูุฎโูุง ุฑุง ุงุดุบุงู ููโฺฉูุฏุ ูโุชูุงูู ูุฒุงุฑุงู ุนููุงุช ุฑุง ููุฒูุงู ุงุฌุฑุง ฺฉูู:

```csharp
for (int i = 0; i < 10000; i++)
  Delay(5000).GetAwaiter().OnCompleted(() => Console.WriteLine(42));
```

ุชุงูุฑูุง callbackูุง ุฎูุฏ ุฑุง ุฑู **pooled threads** ุงุฌุฑุง ูโฺฉููุฏ. ุจูุงุจุฑุงู ุจุนุฏ ุงุฒ ต ุซุงููุ thread pool ุฏุฑุฎูุงุณุชโูุง ุฒุงุฏ ุจุฑุง `SetResult(null)` ุฏุฑุงูุช ูโฺฉูุฏ. ุงฺฏุฑ ุฏุฑุฎูุงุณุชโูุง ุณุฑุนโุชุฑ ุงุฒ ุชูุงู ูพุฑุฏุงุฒุด ุจุฑุณูุฏุ thread pool ุขูโูุง ุฑุง ุฏุฑ ุตู ูุฑุงุฑ ูโุฏูุฏ ู ุฏุฑ ุณุทุญ ุจูููโ ููุงุฒโุณุงุฒ ูพุฑุฏุงุฒุด ูโฺฉูุฏ.

ุงุฒ ุขูุฌุง ฺฉู ฺฉุงุฑ ูุฎโูุง ฺฉูุชุงู ุงุณุช (ููุท ูุฑุงุฎูุงู `SetResult` ู ุงุฌุฑุง continuation)ุ ุงู ุฑูุด ุจุณุงุฑ ุจููู ุนูู ูโฺฉูุฏ.

### โณ **Task.Delay**

ูุชุฏ ฺฉู ูพุดโุชุฑ ููุดุชู ุจู ุงูุฏุงุฒูโุง ฺฉุงุฑุจุฑุฏ ุงุณุช ฺฉู ุจูโุตูุฑุช ฺฉ ูุชุฏ ุงุณุชุงุชฺฉ ุฏุฑ ฺฉูุงุณ **Task** ุฏุฑ ุฏุณุชุฑุณ ูุฑุงุฑ ฺฏุฑูุชู ุงุณุช:

```csharp
Task.Delay(5000).GetAwaiter().OnCompleted(() => Console.WriteLine(42));
```

ุง:

```csharp
Task.Delay(5000).ContinueWith(ant => Console.WriteLine(42));
```

**Task.Delay** ูุนุงุฏู asynchronous ุจุฑุง **Thread.Sleep** ุงุณุช.

---

### ๐ **ุงุตูู Asynchrony (ุบุฑููุฒูุงู)**

ุฏุฑ ููฺฏุงู ููุงุด **TaskCompletionSource**ุ ุนููุงู ูุชุฏูุง asynchronous ููุดุชู. ุฏุฑ ุงู ุจุฎุด ุฏููุงู ุชุนุฑู ูโฺฉูู ฺฉู ุนููุงุช asynchronous ฺุณุช ู ุชูุถุญ ูโุฏูู ฺฺฏููู ุงู ููุถูุน ุจู ุจุฑูุงููโููุณ asynchronous ููุฌุฑ ูโุดูุฏ.

---

#### ๐ **ุนููุงุช Synchronous ุฏุฑ ุจุฑุงุจุฑ Asynchronous**

* ฺฉ ุนููุงุช **synchronous** ฺฉุงุฑ ุฎูุฏ ุฑุง **ูุจู ุงุฒ ุจุงุฒฺฏุดุช ุจู ูุฑุงุฎูุงููุฏู** ุงูุฌุงู ูโุฏูุฏ.
* ฺฉ ุนููุงุช **asynchronous** ูโุชูุงูุฏ (ุจุดุชุฑ ุง ุชูุงู) ฺฉุงุฑ ุฎูุฏ ุฑุง **ุจุนุฏ ุงุฒ ุจุงุฒฺฏุดุช ุจู ูุฑุงุฎูุงููุฏู** ุงูุฌุงู ุฏูุฏ.

ุจุดุชุฑ ูุชุฏูุง ฺฉู ูโููุณุฏ ู ุตุฏุง ูโุฒูุฏ synchronous ูุณุชูุฏ. ุจุฑุง ููููู:

* `List<T>.Add`
* `Console.WriteLine`
* `Thread.Sleep`

ุงูุง ูุชุฏูุง asynchronous ฺฉูุชุฑ ุฑุงุฌ ูุณุชูุฏ ู ุจุงุนุซ **ุงุฌุงุฏ concurrency (ููโุฒูุงู)** ูโุดููุฏุ ุฒุฑุง ฺฉุงุฑ ุจู ููุงุฒุงุช ูุฑุงุฎูุงููุฏู ุงุฏุงูู ูพุฏุง ูโฺฉูุฏ. ุงู ูุชุฏูุง ูุนูููุงู ุณุฑุน (ุง ุจูุงูุงุตูู) ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏูุฏุ ุจูุงุจุฑุงู ุจู ุขูโูุง **nonblocking methods** ูุฒ ฺฏูุชู ูโุดูุฏ.

ุจุดุชุฑ ูุชุฏูุง asynchronous ฺฉู ุชุงฺฉููู ุฏุฏูโุงูุ ูุชุฏูุง **general-purpose** ูุณุชูุฏุ ูุซู:

* `Thread.Start`
* `Task.Run`
* ูุชุฏูุง ฺฉู continuation ุจู taskูุง ูุชุตู ูโฺฉููุฏ

ุนูุงูู ุจุฑ ุงูโูุงุ ุจุฑุฎ ูุชุฏูุง ุจุฎุด **Synchronization Contexts** (ูุซู `Dispatcher.BeginInvoke`ุ โ`Control.BeginInvoke` ู โ`SynchronizationContext.Post`) ูุฒ asynchronous ูุณุชูุฏ. ููฺูู ูุชุฏูุง ฺฉู ุฏุฑ ุจุฎุด **TaskCompletionSource** ููุดุชู (ูุซู **Delay**) ูู asynchronous ูโุจุงุดูุฏ.

---

### โ **ุจุฑูุงููโููุณ Asynchronous ฺุณุชุ**

ุงุตู ุจุฑูุงููโููุณ asynchronous ุงู ุงุณุช ฺฉู ุชูุงุจุน **ุทููุงู ุง ุจุงูููู ุทููุงู** ุฑุง ุจูโุตูุฑุช asynchronous ุจููุณุฏ.

ุงู ููุถูุน ุฏุฑ ุชุถุงุฏ ุจุง ุฑูฺฉุฑุฏ ุณูุช ุงุณุช ฺฉู ุชูุงุจุน ุทููุงู ุฑุง ุจูโุตูุฑุช synchronous ููุดุชู ู ุณูพุณ ุขูโูุง ุฑุง ุงุฒ ฺฉ thread ุง task ุฌุฏุฏ ูุฑุงุฎูุงู ูโฺฉูุฏ ุชุง concurrency ูุฑุงูู ุดูุฏ.

ุชูุงูุช ุฏุฑ ุงูุฌุงุณุช ฺฉู ุฏุฑ ุฑูฺฉุฑุฏ asynchronousุ **concurrency ุฏุฑูู ููุงู ุชุงุจุน ุทููุงู** ุขุบุงุฒ ูโุดูุฏุ ูู ุงุฒ ุจุฑูู ุขู.

โ ุงู ุฏู ูุฒุช ุจุฒุฑฺฏ ุฏุงุฑุฏ:

1. **I/O-bound concurrency** ุจุฏูู ุงุดุบุงู thread ูุงุจู ูพุงุฏูโุณุงุฒ ุงุณุช (ููุงูโุทูุฑ ฺฉู ุฏุฑ ุจุฎุด TaskCompletionSource ุฏุฏู)ุ ฺฉู ุจุงุนุซ ุจูุจูุฏ **scalability** ู **efficiency** ูโุดูุฏ.
2. ุฏุฑ ุงูพูฺฉุดูโูุง **rich-client**ุ ฺฉุฏ ฺฉูุชุฑ ุฑู worker thread ุงุฌุฑุง ูโุดูุฏุ ฺฉู **thread-safety** ุฑุง ุณุงุฏูโุชุฑ ูโฺฉูุฏ.

---

### ๐ฏ **ฺฉุงุฑุจุฑุฏูุง Asynchronous Programming**

ุงู ููุฌุฑ ุจู ุฏู ฺฉุงุฑุจุฑุฏ ูุดุฎุต ุจุฑุง ุจุฑูุงููโููุณ asynchronous ูโุดูุฏ:

1. **ุจุฑูุงููโูุง ุณูุช ุณุฑูุฑ (server-side)** ฺฉู ูุงุฒ ุจู ูุฏุฑุช ฺฉุงุฑุขูุฏ ุญุฌู ุจุงูุง ุงุฒ **I/O ููุฒูุงู** ุฏุงุฑูุฏ.

   * ฺุงูุด ุงูุฌุง **thread-safety** ูุณุช (ฺูู ูุนูููุงู shared state ฺฉู ูุฌูุฏ ุฏุงุฑุฏ).
   * ุจูฺฉู ฺุงูุด **ุจูุฑูโูุฑ ุงุฒ thread** ุงุณุชุ ูุซูุงู ูุตุฑู ูฺฉุฑุฏู ฺฉ thread ุจุฑุง ูุฑ ุฏุฑุฎูุงุณุช ุดุจฺฉู.

2. **ุณุงุฏูโุณุงุฒ thread-safety ุฏุฑ ุงูพูฺฉุดูโูุง rich-client.**

   * ููุช ุจุฑูุงูู ุจุฒุฑฺฏ ูโุดูุฏุ ูุนูููุงู ูุชุฏูุง ุจุฒุฑฺฏ ุฑุง ุจู ูุชุฏูุง ฺฉูฺฺฉโุชุฑ refactor ูโฺฉูู.
   * ุงู ููุถูุน ุจุงุนุซ ุงุฌุงุฏ ุฒูุฌุฑูโุง ุงุฒ ูุชุฏูุง (call graph) ูโุดูุฏ ฺฉู ููุฏฺฏุฑ ุฑุง ุตุฏุง ูโุฒููุฏ.
   * ุฏุฑ ุญุงูุช synchronousุ ุงฺฏุฑ ฺฉ ุงุฒ ูุชุฏูุง ุทููุงู ุจุงุดุฏุ ฺฉู ุฒูุฌุฑู ุจุงุฏ ุฑู worker thread ุงุฌุฑุง ุดูุฏ.
   * ุฏุฑ ุญุงูุช asynchronousุ ููุท ููุช thread ูุงุฒู ุจุงุดุฏ ุดุฑูุน ูโฺฉูู (ุง ุญุช ุงุตูุงู ุจุฑุง ุนููุงุช I/O ูุงุฒ ุจู thread ูุณุช).

ุงู ุจุงุนุซ ุงุฌุงุฏ **concurrency ุฏููโุชุฑ (fine-grained)** ูโุดูุฏุ ุนู ูุฌููุนูโุง ุงุฒ ุนููุงุชโูุง ฺฉูฺฺฉ ููุฒูุงู ฺฉู ุจู ุขูโูุง ุงุฌุฑุง ุจุฑูุงูู ุจู UI thread ุจุงุฒูโฺฏุฑุฏุฏ.

---

### โ๏ธ **ฺฉ ูุงููู ุณุฑุงูฺฏุดุช ููู**

ุจุฑุง ุจูุฑูโููุฏ ุงุฒ ูุฒุงุง asynchronyุ ูู ุนููุงุชโูุง **I/O-bound** ู ูู ุนููุงุชโูุง **compute-bound** ุจุงุฏ asynchronous ููุดุชู ุดููุฏ.

* ูุฑ ฺุฒ ฺฉู ุจุดุชุฑ ุงุฒ **ตฐ ููโุซุงูู** ุทูู ุจฺฉุดุฏุ ฺฉุงูุฏุฏ ููุงุณุจ ุจุฑุง asynchronous ุงุณุช.
* ุงูุจุชู ุงฺฏุฑ ุจุด ุงุฒ ุญุฏ ุนููุงุช ฺฉูฺฺฉ ุฑุง asynchronous ฺฉูุฏุ ฺฉุงุฑุง ฺฉุงูุด ูโุงุจุฏ (ุจู ุฏูู overhead ุนููุงุช asynchronous).

---

### ๐ฑ **UWP ู ุชุดูู ุจู Asynchronous**

ูุฑูโูุฑฺฉ **UWP** ุขูโูุฏุฑ ุจุฑูุงููโููุณ asynchronous ุฑุง ุชุดูู ูโฺฉูุฏ ฺฉู ูุณุฎูโูุง synchronous ุจุฑุฎ ูุชุฏูุง ุทููุงู ุงุตูุงู ุงุฑุงุฆู ูุดุฏูโุงูุฏ ุง ุญุช exception ูพุฑุชุงุจ ูโฺฉููุฏ.
ุจูุงุจุฑุงู ุดูุง **ุจุงุฏ** ูุชุฏูุง asynchronous ุฑุง ุตุฏุง ุจุฒูุฏ ฺฉู **task** ุจุงุฒูโฺฏุฑุฏุงููุฏ (ุง ุดุฆโูุง ฺฉู ุจุง ูุชุฏ **AsTask** ูุงุจู ุชุจุฏู ุจู task ูุณุชูุฏ).

---

### ๐ **Asynchronous Programming ู Continuations**

Taskูุง ุจูโุฎูุจ ุจุง ุจุฑูุงููโููุณ asynchronous ุณุงุฒฺฏุงุฑูุฏุ ุฒุฑุง ุงุฒ **continuation** ูพุดุชุจุงู ูโฺฉููุฏ.

* ุจุฑุง ุนููุงุช **I/O-bound** ุงุฒ **TaskCompletionSource** ุงุณุชูุงุฏู ูโฺฉูู (ูุซู ูุชุฏ Delay).
* ุจุฑุง ุนููุงุช **compute-bound** ุงุฒ **Task.Run** ุงุณุชูุงุฏู ูโฺฉูู.

ูฺฺฏ ููู ุงู ุงุณุช ฺฉู ุณุน ูโฺฉูู **ุฏุฑ ุณุทุญ ูพุงู call graph** ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏููุ ุชุง ุฏุฑ ุงูพูฺฉุดูโูุง rich-client ูุชุฏูุง ุณุทุญ ุจุงูุง ุฑู UI thread ุจุงู ุจูุงููุฏ ู ุจุฏูู ูฺฏุฑุงู ุงุฒ thread-safety ุจู ฺฉูุชุฑูโูุง ู shared state ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดูุฏ.

---

### ๐ข **ููููู ฺฉุฏ: ุดูุงุฑุด ุงุนุฏุงุฏ ุงูู**

```csharp
int GetPrimesCount (int start, int count)
{
  return
    ParallelEnumerable.Range (start, count).Count (n => 
      Enumerable.Range (2, (int)Math.Sqrt(n)-1).All (i => n % i > 0));
}
```

ุงู ุชุงุจุน ุงุนุฏุงุฏ ุงูู ุฑุง ูโุดูุงุฑุฏ ู ุงุฒ ููู ูุณุชูโูุง CPU ุงุณุชูุงุฏู ูโฺฉูุฏ. ุงุฌุฑุง ุขู ุทููุงู ุงุณุช.

ฺฉ ูุชุฏ ุจุฑุง ูุฑุงุฎูุงู ุขู:

```csharp
void DisplayPrimeCounts()
{
  for (int i = 0; i < 10; i++)
    Console.WriteLine (GetPrimesCount (i*1000000 + 2, 1000000) +
      " primes between " + (i*1000000) + " and " + ((i+1)*1000000-1));
  Console.WriteLine ("Done!");
}
```

ุฎุฑูุฌ:

```
78498 primes between 0 and 999999
70435 primes between 1000000 and 1999999
67883 primes between 2000000 and 2999999
...
62090 primes between 9000000 and 9999999
```

ุฏุฑ ุงูุฌุง ฺฉ **call graph** ุฏุงุฑู:

* โ`DisplayPrimeCounts` ูุฑุงุฎูุงู ูโฺฉูุฏ โ`GetPrimesCount` ุฑุง.
* ุฏุฑ ุนููุ ุฏุฑ ุงูพูฺฉุดูโูุง rich-clientุ ุงู ูุชุฏ ุงุญุชูุงูุงู UI ุฑุง ุจูโุฑูุฒุฑุณุงู ูโฺฉุฑุฏ.

---

### โก **ุงุฌุฑุง coarse-grained concurrency**

```csharp
Task.Run(() => DisplayPrimeCounts());
```

---

### โ **ุงุฌุฑุง fine-grained concurrency (ูุณุฎู asynchronous)**

```csharp
Task<int> GetPrimesCountAsync (int start, int count)
{
  return Task.Run(() =>
    ParallelEnumerable.Range (start, count).Count (n => 
      Enumerable.Range (2, (int)Math.Sqrt(n)-1).All (i => n % i > 0)));
}
```

### ๐ **ฺุฑุง ูพุดุชุจุงู ุฒุจุงู ููู ุงุณุช**

ุงฺฉููู ุจุงุฏ **DisplayPrimeCounts** ุฑุง ุชุบุฑ ุฏูู ุชุง **GetPrimesCountAsync** ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.
ุงูุฌุงุณุช ฺฉู ฺฉูุฏูุงฺูโูุง **async** ู **await** ุฏุฑ C# ูุงุฑุฏ ูโุดููุฏุ ุฒุฑุง ุจุฏูู ุขูโูุง ฺฉุงุฑ ุณุงุฏู ูุณุช.

ุงฺฏุฑ ููุท ุญููู ุฑุง ุจู ุงู ุดฺฉู ุชุบุฑ ุฏูู:

```csharp
for (int i = 0; i < 10; i++)
{
  var awaiter = GetPrimesCountAsync(i*1000000 + 2, 1000000).GetAwaiter();
  awaiter.OnCompleted(() =>
    Console.WriteLine(awaiter.GetResult() + " primes between... "));
}
Console.WriteLine("Done");
```

* ุญููู ุณุฑุนุงู ฑฐ ุจุงุฑ ุชฺฉุฑุงุฑ ูโุดูุฏ (ุฒุฑุง ูุชุฏูุง nonblocking ูุณุชูุฏ).
* ููู ฑฐ ุนููุงุช **ููุฒูุงู** ุงุฌุฑุง ูโุดููุฏ ู ูพุงู **Done** ูุจู ุงุฒ ุชูุงู ุดุฏู ฺฉุงุฑูุง ฺุงูพ ูโุดูุฏ.

---

### โ๏ธ ูุดฺฉู ุงุฌุฑุง ููุฒูุงู

* ุฏุฑ ุงู ูุซุงูุ ุงุฌุฑุง ููุงุฒ ุนููุงุช ูุทููุจ ูุณุชุ ุฒุฑุง ุฎูุฏ ูุชุฏูุง ุฏุงุฎู parallel ุดุฏูโุงูุฏ ู ููุท ุจุงุนุซ ุทููุงูโุชุฑ ุดุฏู ุฒูุงู ูุดุงูุฏู ุงููู ูุชุฌู ูโุดูุฏ.
* ููฺููุ ููฺฉู ุงุณุช **Task B ุจู ูุชุฌู Task A ูุงุจุณุชู ุจุงุดุฏ** (ูุซูุงู ุฏุฑ ฺฏุฑูุชู ุตูุญู ูุจุ ุงุจุชุฏุง DNS lookup ู ุณูพุณ HTTP request ุงูุฌุงู ูโุดูุฏ).

ุจุฑุง ุงุฌุฑุง **ุชูุงูโุง**ุ ุจุงุฏ iteration ุจุนุฏ ุญููู ุงุฒ continuation ุฎูุฏ ูุชุฏ ุงุฌุฑุง ุดูุฏ:

```csharp
void DisplayPrimeCounts()
{
  DisplayPrimeCountsFrom(0);
}

void DisplayPrimeCountsFrom(int i)
{
  var awaiter = GetPrimesCountAsync(i*1000000 + 2, 1000000).GetAwaiter();
  awaiter.OnCompleted(() => 
  {
    Console.WriteLine(awaiter.GetResult() + " primes between...");
    if (++i < 10) DisplayPrimeCountsFrom(i);
    else Console.WriteLine("Done");
  });
}
```

* ุงฺฏุฑ ุจุฎูุงูู **DisplayPrimeCounts** ุฎูุฏุด asynchronous ุจุงุดุฏ ู ฺฉ Task ุจุงุฒฺฏุฑุฏุงูุฏุ ุจุงุฏ ุงุฒ **TaskCompletionSource** ุงุณุชูุงุฏู ฺฉูู.

---

### โ **ุฑุงู ุญู ุณุงุฏู ุจุง async/await**

C# ุงู ฺฉุงุฑ ุฑุง ุจุฑุง ูุง ุณุงุฏู ฺฉุฑุฏู ุงุณุช:

```csharp
async Task DisplayPrimeCountsAsync()
{
  for (int i = 0; i < 10; i++)
    Console.WriteLine(await GetPrimesCountAsync(i*1000000 + 2, 1000000) +
      " primes between " + (i*1000000) + " and " + ((i+1)*1000000-1));
  Console.WriteLine("Done!");
}
```

* ฺฉูุฏูุงฺูโูุง **async** ู **await** ุงูฺฉุงู ูพุงุฏูโุณุงุฒ asynchronous ุฑุง ุจุฏูู ูพฺุฏฺฏ ุฒุงุฏ ูุฑุงูู ูโฺฉููุฏ.

---

### ๐ **ฺุฑุง ุญูููโูุง imperative ูุดฺฉู ุฏุงุฑูุฏุ**

ุญูููโูุง `for` ู `foreach` ุจุง continuations ุฎูุจ ุชุฑฺฉุจ ููโุดููุฏุ ุฒุฑุง ุฑู **state ูุญู ูุนู ูุชุฏ** ุชฺฉู ุฏุงุฑูุฏ (ูุซูุงู โฺูุฏ ุจุงุฑ ุฏฺฏุฑ ุญููู ุงุฌุฑุง ูโุดูุฏุโ).

* ุงุณุชูุงุฏู ุงุฒ **async/await** ฺฉ ุฑุงู ุญู ุงุณุช.
* ุฑุงู ุฏฺฏุฑุ ุฌุงฺฏุฒู ฺฉุฑุฏู ุญูููโูุง imperative ุจุง ูุนุงุฏู functional ุขูโูุง (ูุซู **LINQ**) ุงุณุชุ ฺฉู ุงุณุงุณ **Reactive Extensions (Rx)** ูโุจุงุดุฏ.
* Rx ุจุฑุง ุฌููฺฏุฑ ุงุฒ blocking ุฑู **push-based sequences** ฺฉุงุฑ ูโฺฉูุฏ ฺฉู ููููู ูพฺุฏู ุฏุงุฑุฏ.

---

### ๐๏ธ **ุชูุงุจุน Asynchronous ุฏุฑ C#**

ฺฉูุฏูุงฺูโูุง **async** ู **await** ุงุฌุงุฒู ูโุฏููุฏ ฺฉุฏ asynchronous ุจุง **ุณุงุฎุชุงุฑ ูุดุงุจู synchronous** ุจููุณูุ ุจุฏูู ูุงุฒ ุจู ููุดุชู ุชูุงู plumbing ุฏุงุฎู asynchronous.

#### Awaiting

```csharp
var result = await expression;
statement(s);
```

* ุชูุณุท ฺฉุงููพุงูุฑ ุจู ฺุฒ ูุดุงุจู ุงู ฺฏุณุชุฑุด ูโุงุจุฏ:

```csharp
var awaiter = expression.GetAwaiter();
awaiter.OnCompleted(() =>
{
  var result = awaiter.GetResult();
  statement(s);
});
```

* ฺฉุงููพุงูุฑ ููฺูู ุจุฑุง **ุณุฑูุณโุฏู ุณุฑุน ุฏุฑ ุตูุฑุช ุชฺฉูู ููุฒูุงู** ู ูุฏุฑุช ุฌุฒุฆุงุช ุฏฺฏุฑุ ฺฉุฏ ุงุถุงูู ูโฺฉูุฏ.

---

### ๐ข **ููููู ฺฉุฏ ุดูุงุฑุด ุงุนุฏุงุฏ ุงูู ุจุง await**

```csharp
Task<int> GetPrimesCountAsync(int start, int count)
{
  return Task.Run(() =>
    ParallelEnumerable.Range(start, count).Count(n =>
      Enumerable.Range(2, (int)Math.Sqrt(n)-1).All(i => n % i > 0)));
}

async void DisplayPrimesCount()
{
  int result = await GetPrimesCountAsync(2, 1000000);
  Console.WriteLine(result);
}
```

* ฺฉูุฏูุงฺู **async** ุจู ฺฉุงููพุงูุฑ ูโฺฏูุฏ ฺฉู `await` ุฏุฑ ุงู ูุชุฏุ ฺฉ keyword ุงุณุช ูู ฺฉ identifier.
* async ููุท ุฑู **ุขูฺู ุฏุงุฎู ูุชุฏ ุฑุฎ ูโุฏูุฏ** ุชุฃุซุฑ ุฏุงุฑุฏ ู ูุดุงุจู `unsafe`ุ ุชุงุซุฑ ุฑู signature ูุชุฏ ูุฏุงุฑุฏ.
* ูโุชูุงูุฏ ุฑู ูุชุฏูุง `void` ุง `Task` ู `Task<TResult>` ุงุนูุงู ุดูุฏ.

---

### ๐ **ฺฺฏููฺฏ ฺฉุงุฑ await**

* ุจุง ุฑุณุฏู ุจู ฺฉ **await expression**ุ ุงุฌุฑุง ูุนูููุงู ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏุ ูุดุงุจู `yield return` ุฏุฑ iteratorูุง.
* ูุจู ุงุฒ ุจุงุฒฺฏุดุชุ runtime ฺฉ **continuation** ุจู task ุถููู ูโฺฉูุฏ.
* ููุช task ุชฺฉูู ุดุฏุ ุงุฌุฑุง ุงุฒ ููุงู ููุทู ุงุฏุงูู ูโุงุจุฏ.
* ุฏุฑ ุตูุฑุช ุฎุทุงุ exception ุจุงุฒุชุงุจ ุฏุงุฏู ูโุดูุฏ ู ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ููุฏุงุฑ ุจุงุฒฺฏุดุช ุจู **await expression** ุงุฎุชุตุงุต ูโุงุจุฏ.

#### ูุนุงุฏู ููุทู

```csharp
void DisplayPrimesCount()
{
  var awaiter = GetPrimesCountAsync(2, 1000000).GetAwaiter();
  awaiter.OnCompleted(() =>
  {
    int result = awaiter.GetResult();
    Console.WriteLine(result);
  });
}
```

* Await ูโุชูุงูุฏ ุฑู taskูุง generic (`Task<TResult>`) ุง nongeneric (`Task`) ุงุณุชูุงุฏู ุดูุฏ.
* ููููู nongeneric:

```csharp
await Task.Delay(5000);
Console.WriteLine("Five seconds passed!");
```

### ๐น **ุญูุธ state ูุญู ุจุง await**

ฺฉ ุงุฒ ูุฏุฑุชโูุง ูุงูุน **await** ุงู ุงุณุช ฺฉู ูโุชูุงูุฏ ุชูุฑุจุงู ุฏุฑ ูุฑ ุฌุง ุงุฒ ฺฉุฏ ุธุงูุฑ ุดูุฏ (ุฏุงุฎู ฺฉ ุชุงุจุน asynchronous)ุ ุจู ุฌุฒ ุฏุฑูู `lock` ุง `unsafe context`.

ูุซุงู ุณุงุฏู ุฏุงุฎู ฺฉ ุญููู:

```csharp
async void DisplayPrimeCounts()
{
  for (int i = 0; i < 10; i++)
    Console.WriteLine(await GetPrimesCountAsync(i*1000000 + 2, 1000000));
}
```

* ุจุง ุงููู ุงุฌุฑุง `GetPrimesCountAsync`ุ ฺฉูุชุฑู ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏ.

* ูพุณ ุงุฒ ุชฺฉูู (ุง ุฎุทุง) ูุชุฏุ ุงุฌุฑุง ฺฉุฏ ุงุฒ ููุงู ููุทู ุงุฏุงูู ูโุงุจุฏ.

* **ููุงุฏุฑ ูุชุบุฑูุง ูุญู ู ุดูุงุฑูุฏูโูุง ุญููู ุญูุธ ูโุดููุฏ**.

* ฺฉุงููพุงูุฑ ุงู ูุชุฏูุง ุฑุง ุจู ฺฉ **state machine** ุชุจุฏู ูโฺฉูุฏ (ูุดุงุจู iteratorูุง).

* continuationูุง ุชุถูู ูโฺฉููุฏ ฺฉู ุจุนุฏ ุงุฒ `await`ุ ุงุฌุฑุง ุฏูุจุงุฑู ุงุฒ ููุงู ููุทู ุงุฏุงูู ุงุจุฏ.

---

### ๐น **Await ุฏุฑ ุฑุงุจุท ฺฉุงุฑุจุฑ (UI)**

ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ฺฉ UI ุณุงุฏู ุฏุงุดุชู ุจุงุดู ฺฉู ููุฒูุงู **ูุญุงุณุจุงุช ุณูฺฏู** ุงูุฌุงู ูโุฏูุฏ ุงูุง ูพุงุณุฎฺฏู ุจูุงูุฏ.

#### ูุณุฎู synchronous (ุบุฑูุงฺฉูุดโฺฏุฑุง)

```csharp
void Go()
{
  for (int i = 1; i < 5; i++)
    _results.Text += GetPrimesCount(i*1000000, 1000000) + " primes between ..." + Environment.NewLine;
}
```

* ุฏุฑ ุงู ุญุงูุชุ ุจุฑูุงูู **ุจุฑุง ูุฏุช ููู ูโุดูุฏ** ู UI ูพุงุณุฎฺฏู ูุณุช.

#### ูุณุฎู asynchronous ุจุง Task.Run ู await

```csharp
async void Go()
{
  _button.IsEnabled = false;
  for (int i = 1; i < 5; i++)
    _results.Text += await GetPrimesCountAsync(i*1000000, 1000000) +
                     " primes between ..." + Environment.NewLine;
  _button.IsEnabled = true;
}
```

* ฺฉุฏ ุฏุงุฎู `Go` ุจุฑ ุฑู **UI thread** ุงุฌุฑุง ูโุดูุฏ ู ุชููุง **GetPrimesCountAsync** ุฑู worker thread.
* ุงุฌุฑุง `Go` ุจู ุตูุฑุช **pseudo-concurrent** ุจุง message loop ุฑุฎ ูโุฏูุฏ.
* **ููุงุท preemption ุชููุง ููฺฏุงู await** ุฑุฎ ูโุฏููุฏุ ุจูุงุจุฑุงู thread safety ุณุงุฏูโุชุฑ ุงุณุช.
* ุจุง Task.Runุ **concurrency ูุงูุน** ูพุงูโุชุฑ ุฏุฑ call stack ุฑุฎ ูโุฏูุฏ.

---

### ๐น ูุซุงู I/O-bound: ุฏุงูููุฏ ุตูุญุงุช ูุจ

```csharp
async void Go()
{
  _button.IsEnabled = false;
  string[] urls = "www.albahari.com www.oreilly.com www.linqpad.net".Split();
  int totalLength = 0;
  try
  {
    foreach (string url in urls)
    {
      var uri = new Uri("http://" + url);
      byte[] data = await new WebClient().DownloadDataTaskAsync(uri);
      _results.Text += "Length of " + url + " is " + data.Length + Environment.NewLine;
      totalLength += data.Length;
    }
    _results.Text += "Total length: " + totalLength;
  }
  catch (WebException ex)
  {
    _results.Text += "Error: " + ex.Message;
  }
  finally
  {
    _button.IsEnabled = true;
  }
}
```

* ฺฉุฏ **ุดุจู ูุณุฎู synchronous** ููุดุชู ุดุฏู ุงุณุช.
* ูพุณ ุงุฒ ุงููู awaitุ ฺฉูุชุฑู ุจู caller ุจุงุฒูโฺฏุฑุฏุฏุ ุงูุง continuation ุชุถูู ูโฺฉูุฏ ฺฉู ุชูุงู ุจูุงฺฉ `finally` ุจุนุฏ ุงุฒ ุชฺฉูู method ุงุฌุฑุง ุดูุฏ.

---

### ๐น **ูุญูู ุนููฺฉุฑุฏ ุฒุฑ ฺฉุงูพูุช**

* UI thread ฺฉ **message loop** ุฏุงุฑุฏ ฺฉู event handlerูุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ.
* ุงุฌุฑุง `Go` ุชุง ุฑุณุฏู ุจู await ุงุฏุงูู ูพุฏุง ูโฺฉูุฏุ ุณูพุณ ฺฉูุชุฑู ุจู message loop ุจุงุฒูโฺฏุฑุฏุฏ.
* ฺฉุงููพุงูุฑ ฺฉ continuation ุถููู ูโฺฉูุฏ ุชุง ูพุณ ุงุฒ ุชฺฉูู taskุ ุงุฌุฑุง ูุชุฏ ุงุฒ ููุงู ููุทู ุงุฏุงูู ุงุจุฏ.
* ฺูู await ุฑู **UI thread** ุงูุฌุงู ุดุฏู ุงุณุชุ continuation ุจู **synchronization context** ุงุฑุณุงู ูโุดูุฏ ู ุฏูุจุงุฑู ุชูุณุท message loop ุงุฌุฑุง ูโุดูุฏ.
* ุงู ูุฏู **pseudo-concurrency** ุฑุง ุฑู UI ูุฑุงูู ูโฺฉูุฏ ู **concurrency ูุงูุน** ุฏุฑ Task.Run ุง I/O-bound method ุฑุฎ ูโุฏูุฏ.

### ๐น **Coarse-Grained Concurrency vs Async/Await**

ูุจู ุงุฒ C# 5ุ ุจุฑูุงููโููุณ **asynchronous** ุฏุดูุงุฑ ุจูุฏ:

* ุฒุจุงู ูฺ ูพุดุชุจุงู ูุณุชูู ูุฏุงุดุช.
* ูุฑููุฑฺฉ .NET ูุชุฏูุง asynchronous ุฑุง ุจุง ุงูฺฏููุง ูพฺุฏูโุง ูุงููุฏ **EAP** ู **APM** ุงุฑุงุฆู ูโฺฉุฑุฏ.
* ุฑุงูโุญู ุฑุงุฌ: **coarse-grained concurrency** ุจุง BackgroundWorker ุง Task.Run.

#### ูุซุงู coarse-grained

```csharp
_button.Click += (sender, args) =>
{
    _button.IsEnabled = false;
    Task.Run(() => Go());
};

void Go()
{
    for (int i = 1; i < 5; i++)
    {
        int result = GetPrimesCount(i * 1000000, 1000000);
        Dispatcher.BeginInvoke(new Action(() =>
            _results.Text += result + " primes between ..." + Environment.NewLine));
    }
    Dispatcher.BeginInvoke(new Action(() => _button.IsEnabled = true));
}
```

โ๏ธ ูุดฺฉูุงุช ุงู ุฑูุด:

* ฺฉู call graph (Go + GetPrimesCount) ุฑู worker thread ุงุฌุฑุง ูโุดูุฏ.
* ุจุฑุง ุฏุณุชุฑุณ ุจู UI ุจุงุฏ ุงุฒ `Dispatcher.BeginInvoke` ุงุณุชูุงุฏู ฺฉุฑุฏ.
* **race conditions** ู ุฎุทุงูุง thread-safety ุจู ุฑุงุญุช ุฑุฎ ูโุฏููุฏุ ุฎุตูุตุงู ุงฺฏุฑ ุฏุงุฏูโูุง ุง ุชูุธูุงุช ุงุฒ ููุงุจุน ุบุฑ thread-safe ุฎูุงูุฏู ุดููุฏ.

---

### ๐น **ููุดุชู ุชูุงุจุน Asynchronous ุจุง async/await**

ูโุชูุงู `void` ุฑุง ุจุง `Task` ุฌุงฺฏุฒู ฺฉุฑุฏ ุชุง ูุชุฏ ุฎูุฏ ุจู ุตูุฑุช **awaitable** ุดูุฏ:

```csharp
async Task PrintAnswerToLife()
{
    await Task.Delay(5000);
    int answer = 21 * 2;
    Console.WriteLine(answer);
}
```

* ูุงุฒ ุจู return ุตุฑุญ Task ูุณุชุ ฺฉุงููพุงูุฑ **Task** ุฑุง ุชููุฏ ูโฺฉูุฏ.
* ุงู ุงูฺฉุงู ุงุฌุงุฏ **chained async calls** ุฑุง ูุฑุงูู ูโฺฉูุฏ:

```csharp
async Task Go()
{
    await PrintAnswerToLife();
    Console.WriteLine("Done");
}
```

---

### ๐น **ุชูุณุนู ูุชุฏ ุจุง TaskCompletionSource**

ูุนุงุฏู ุฏุงุฎู async/await:

```csharp
Task PrintAnswerToLife()
{
    var tcs = new TaskCompletionSource<object>();
    var awaiter = Task.Delay(5000).GetAwaiter();
    awaiter.OnCompleted(() =>
    {
        try
        {
            awaiter.GetResult(); // ูพุฑุชุงุจ ุงุณุชุซูุง ุฏุฑ ุตูุฑุช ูููุน
            int answer = 21 * 2;
            Console.WriteLine(answer);
            tcs.SetResult(null);
        }
        catch (Exception ex) { tcs.SetException(ex); }
    });
    return tcs.Task;
}
```

* ููุช ูุชุฏ asynchronous ุชูุงู ูโุดูุฏุ ุงุฌุฑุง ฺฉุฏ ุจู **continuation** ููุชูู ูโุดูุฏ.
* ุฏุฑ rich-client scenarioุ ุงุฏุงูู ุงุฌุฑุง ุจู **UI thread** ุจุงุฒ ูโฺฏุฑุฏุฏ.

---

### ๐น **Returning Task<TResult>**

```csharp
async Task<int> GetAnswerToLife()
{
    await Task.Delay(5000);
    int answer = 21 * 2;
    return answer; // ูุชุฏ Task<int> ุจุฑูโฺฏุฑุฏุงูุฏ
}

async Task PrintAnswerToLife()
{
    int answer = await GetAnswerToLife();
    Console.WriteLine(answer);
}

async Task Go()
{
    await PrintAnswerToLife();
    Console.WriteLine("Done");
}
```

* ุงู ุงูฺฏู ูุดุงุจู ุจุฑูุงููโููุณ synchronous ุงุณุชุ ุงูุง ุจุฏูู ุจูุงฺฉ ฺฉุฑุฏู thread.

---

### ๐น **ุฑุงูููุง ุทุฑุงุญ ูุชุฏูุง Asynchronous ุฏุฑ C#**

1. ุงุจุชุฏุง ูุชุฏูุง ุฑุง ุจู ุตูุฑุช synchronous ุจููุณุฏ.
2. ูุชุฏูุง synchronous ุฑุง ุจุง **ูุชุฏูุง asynchronous** ุฌุงฺฏุฒู ู `await` ฺฉูุฏ.
3. ุจู ุฌุฒ ูุชุฏูุง **top-level** (ูุซูุงู event handlerูุง)ุ ููุน ุจุงุฒฺฏุดุช ูุชุฏูุง asynchronous ุฑุง ุจู `Task` ุง `Task<TResult>` ุชุบุฑ ุฏูุฏ ุชุง **awaitable** ุดููุฏ.

๐ก ูฺฉุชู: ูุงุฒ ุจู ุงุณุชูุงุฏู ุตุฑุญ ุงุฒ `TaskCompletionSource` ูุณุช ูฺฏุฑ ุฏุฑ **bottom-level methods** ฺฉู I/O-bound concurrency ุฑุง ูุฏุฑุช ูโฺฉููุฏ.

### ุงุฌุฑุง ูููุฏุงุฑ ูุฑุงุฎูุงูโูุง ุบุฑููุฒูุงู โฑ๏ธ

ุจุฑุง ุงูฺฉู ุฏููุงู ุจุจูู ุงู ฺฉุฏ ฺฺฏููู ุงุฌุฑุง ูโุดูุฏุ ููุฏ ุงุณุช ฺฉู ฺฉุฏ ุฎูุฏ ุฑุง ุจู ุดฺฉู ุฒุฑ ุจุงุฒฺู ฺฉูู:

```csharp
async Task Go()
{
    var task = PrintAnswerToLife();
    await task;
    Console.WriteLine("Done");
}

async Task PrintAnswerToLife()
{
    var task = GetAnswerToLife();
    int answer = await task;
    Console.WriteLine(answer);
}

async Task<int> GetAnswerToLife()
{
    var task = Task.Delay(5000);
    await task;
    int answer = 21 * 2;
    return answer;
}
```

ุฏุฑ ุงูุฌุงุ `Go` ูุชุฏ `PrintAnswerToLife` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ฺฉู ุขู ุฎูุฏ `GetAnswerToLife` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ฺฉู ุฏุฑ ููุงุช `Delay` ุฑุง ุตุฏุง ูโุฒูุฏ ู ููุชุธุฑ ูโูุงูุฏ. ุนุจุงุฑุช `await` ุจุงุนุซ ูโุดูุฏ ุงุฌุฑุง ฺฉุฏ ุจู `PrintAnswerToLife` ุจุงุฒฺฏุฑุฏุฏุ ฺฉู ุขู ูุฒ ููุชุธุฑ ุงุณุช ู ุจู `Go` ุจุงุฒูโฺฏุฑุฏุฏ ู ุฏุฑ ููุงุช ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏ. ููู ุงูโูุง ุจู ุตูุฑุช ููุฒูุงู (synchronously) ุฑู ููุงู ูุฎ (thread) ฺฉู `Go` ุฑุง ูุฑุงุฎูุงู ฺฉุฑุฏู ุงุณุช ุงุฌุฑุง ูโุดูุฏุ ุงู ูุงุฒ ฺฉูุชุงู ููุฒูุงู ุงุฌุฑุง ุจุฑูุงูู ุงุณุช.

ูพุณ ุงุฒ ูพูุฌ ุซุงููุ ุงุฏุงููโ ุงุฌุฑุง `Delay` ูุฑุงุฎูุงู ูโุดูุฏ ู ุงุฌุฑุง ฺฉุฏ ุจู `GetAnswerToLife` ุจุฑูโฺฏุฑุฏุฏุ ุฑู ฺฉ ูุฎ ููุฌูุฏ ุฏุฑ pool. (ุงฺฏุฑ ุงุฒ ฺฉ ูุฎ UI ุดุฑูุน ฺฉุฑุฏู ุจุงุดูุ ุงุฌุฑุง ฺฉุฏ ุจู ููุงู ูุฎ ุจุงุฒูโฺฏุฑุฏุฏ.) ุณูพุณ ุจูู ุฏุณุชูุฑุงุช ุฏุฑ `GetAnswerToLife` ุงุฌุฑุง ูโุดููุฏุ ู ูพุณ ุงุฒ ุขู `Task<int>` ุงู ูุชุฏ ุจุง ูุชุฌู ดฒ ุชฺฉูู ูโุดูุฏ ู ุงุฏุงููโ ุงุฌุฑุง `PrintAnswerToLife` ุงุฌุฑุง ูโุดูุฏ ู ุฏุณุชูุฑุงุช ุจุงูโูุงูุฏู ุฏุฑ ุขู ูุชุฏ ุงุฌุฑุง ูโุดููุฏ. ุงู ุฑููุฏ ุชุง ุฒูุงู ฺฉู `Go` ุชฺฉูู ุดูุฏ ุงุฏุงูู ูพุฏุง ูโฺฉูุฏ.

ุฌุฑุงู ุงุฌุฑุง ูุทุงุจู ูููุฏุงุฑ ูุฑุงุฎูุงู ููุฒูุงู ุงุณุช ฺฉู ูพุดโุชุฑ ูุดุงู ุฏุงุฏูุ ุฒุฑุง ุงูฺฏู ูุง ุงู ุงุณุช ฺฉู ุจูุงูุงุตูู ูพุณ ุงุฒ ูุฑุงุฎูุงู ูุฑ ูุชุฏ ุบุฑููุฒูุงูุ ุขู ุฑุง `await` ูโฺฉูู. ุงู ุจุงุนุซ ุงุฌุงุฏ ุฌุฑุงู ุชุฑุชุจ ุจุฏูู ููุงุฒโุณุงุฒ ุง ุงุฌุฑุง ููุฒูุงู ุฏุฑูู ูููุฏุงุฑ ูุฑุงุฎูุงู ูโุดูุฏ. ูุฑ ุนุจุงุฑุช `await` ฺฉ ยซููููยป ุฏุฑ ุงุฌุฑุง ุงุฌุงุฏ ูโฺฉูุฏ ู ูพุณ ุงุฒ ุขู ุจุฑูุงูู ุงุฒ ููุงู ููุทู ุงุฏุงูู ูโุงุจุฏ.

---

### ููุงุฒโุณุงุฒ โก

ูุฑุงุฎูุงู ฺฉ ูุชุฏ ุบุฑููุฒูุงู ุจุฏูู `await` ฺฉุฑุฏู ุขูุ ุงุฌุงุฒู ูโุฏูุฏ ฺฉุฏ ุจุนุฏ ุจู ุตูุฑุช ููุงุฒ ุงุฌุฑุง ุดูุฏ. ููฺฉู ุงุณุช ุฏุฑ ูุซุงูโูุง ูุจู ุฏุฏู ุจุงุดุฏ ฺฉู ฺฉ ุฏฺฉูู ุฏุงุดุชู ฺฉู handler ุขู `Go` ุฑุง ูุฑุงุฎูุงู ูโฺฉุฑุฏ:

```csharp
_button.Click += (sender, args) => Go();
```

ุจุง ูุฌูุฏ ุงูฺฉู `Go` ฺฉ ูุชุฏ ุบุฑููุฒูุงู ุงุณุชุ ูุง ุขู ุฑุง `await` ูฺฉุฑุฏู ู ุงู ููุงู ฺุฒ ุงุณุช ฺฉู ููุฒูุงู ูุงุฒู ุจุฑุง ุญูุธ ูพุงุณุฎฺฏู UI ุฑุง ูุฑุงูู ูโฺฉูุฏ.

ูโุชูุงูู ุงุฒ ููู ุงุตู ุจุฑุง ุงุฌุฑุง ุฏู ุนููุงุช ุบุฑููุฒูุงู ุจู ุตูุฑุช ููุงุฒ ุงุณุชูุงุฏู ฺฉูู:

```csharp
var task1 = PrintAnswerToLife();
var task2 = PrintAnswerToLife();
await task1;
await task2;
```

(ุจุง `await` ฺฉุฑุฏู ูุฑ ุฏู ุนููุงุช ุจุนุฏุงูุ ุฏุฑ ุขู ููุทู ููุงุฒโุณุงุฒ ยซุจู ูพุงุงู ูโุฑุณุฏยป. ุจุนุฏุงู ุจุง ุชุฑฺฉุจโฺฉููุฏู `WhenAll` ุงู ุงูฺฏู ุฑุง ุชูุถุญ ูโุฏูู.)

ููุฒูุงู ุงุฌุงุฏ ุดุฏู ุจู ุงู ุดฺฉูุ ฺู ุนููุงุช ุฑู ูุฎ UI ุขุบุงุฒ ุดุฏู ุจุงุดุฏ ู ฺู ููุ ุฑุฎ ูโุฏูุฏุ ุงฺฏุฑฺู ุชูุงูุช ุฏุฑ ูุญูู ูููุน ุขู ูุฌูุฏ ุฏุงุฑุฏ. ุฏุฑ ูุฑ ุฏู ุญุงูุชุ ููุงู ููุฒูุงู ูุงูุน ุฏุฑ ุณุทุญ ูพุงู ุงุชูุงู ูโุงูุชุฏ (ูุซู `Task.Delay` ุง ฺฉุฏ ฺฉู ุจู `Task.Run` ุณูพุฑุฏู ุดุฏู ุงุณุช). ูุชุฏูุง ุจุงูุงุชุฑ ุฏุฑ call stack ุชููุง ุฏุฑ ุตูุฑุช ููุฒูุงู ูุงูุน ุฎูุงููุฏ ุฏุงุดุช ฺฉู ุนููุงุช ุจุฏูู ุญุถูุฑ `SynchronizationContext` ุขุบุงุฒ ุดุฏู ุจุงุดุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุจู ููุฒูุงู ุดุจูโูุงูุน (pseudo-concurrency) ู ุงูู ุณุงุฏูโุดุฏู ูุฎโูุง ูุญุฏูุฏ ูโุดููุฏุ ุฌุง ฺฉู ุชููุง ููุทูโุง ฺฉู ูโุชูุงูู ูุชููู ุดููุ ุนุจุงุฑุช `await` ุงุณุช. ุงู ุงุฌุงุฒู ูโุฏูุฏ ฺฉู ุจุฑุง ูุซุงูุ ฺฉ ููุฏ ูุดุชุฑฺฉ `_x` ุชุนุฑู ฺฉุฑุฏู ู ุฏุฑ `GetAnswerToLife` ุจุฏูู ููู ฺฉุฑุฏู ุขู ุฑุง ุงูุฒุงุด ุฏูู:

```csharp
async Task<int> GetAnswerToLife()
{
    _x++;
    await Task.Delay(5000);
    return 21 * 2;
}
```

(ุจุง ุงู ุญุงูุ ููโุชูุงูู ูุฑุถ ฺฉูู ฺฉู `_x` ูุจู ู ุจุนุฏ ุงุฒ `await` ููุฏุงุฑ ฺฉุณุงู ุฏุงุฑุฏ.)

---

### ุนุจุงุฑุชโูุง Lambda ุบุฑููุฒูุงู ๐น

ููุงูุทูุฑ ฺฉู ูุชุฏูุง ูุนููู ูุงูโุฏุงุฑ ูโุชูุงููุฏ ุบุฑููุฒูุงู ุจุงุดูุฏ:

```csharp
async Task NamedMethod()
{
    await Task.Delay(1000);
    Console.WriteLine("Foo");
}
```

ูููโุทูุฑ ูโุชูุงู ูุชุฏูุง ุจุฏูู ูุงู (lambda ู anonymous) ุฑุง ุจุง ูพุดููุฏ `async` ููุดุช:

```csharp
Func<Task> unnamed = async () =>
{
    await Task.Delay(1000);
    Console.WriteLine("Foo");
};
```

ูโุชูุงูู ุขููุง ุฑุง ูุฑุงุฎูุงู ู `await` ฺฉูู:

```csharp
await NamedMethod();
await unnamed();
```

ููฺูู ูโุชูุงู ุงุฒ Lambda ุบุฑููุฒูุงู ููฺฏุงู attach ฺฉุฑุฏู event handler ุงุณุชูุงุฏู ฺฉุฑุฏ:

```csharp
myButton.Click += async (sender, args) =>
{
    await Task.Delay(1000);
    myButton.Content = "Done";
};
```

ุงู ฺฉูุชุงูโุชุฑ ุงุฒ ุฑูุด ุฒุฑ ุงุณุช ฺฉู ููุงู ุงุซุฑ ุฑุง ุฏุงุฑุฏ:

```csharp
myButton.Click += ButtonHandler;
...
async void ButtonHandler(object sender, EventArgs args)
{
    await Task.Delay(1000);
    myButton.Content = "Done";
};
```

Lambda ุบุฑููุฒูุงู ูโุชูุงูุฏ `Task<TResult>` ูุฒ ุจุงุฒฺฏุฑุฏุงูุฏ:

```csharp
Func<Task<int>> unnamed = async () =>
{
    await Task.Delay(1000);
    return 123;
};
int answer = await unnamed();
```

---

### ุฌุฑุงูโูุง ุบุฑููุฒูุงู ๐

ุจุง `yield return` ูโุชูุงู ฺฉ iterator ููุดุชุ ุจุง `await` ูโุชูุงู ฺฉ ูุชุฏ ุบุฑููุฒูุงู ููุดุช. **ุฌุฑุงูโูุง ุบุฑููุฒูุงู** (ุงุฒ C# 8) ุงู ุฏู ููููู ุฑุง ุชุฑฺฉุจ ูโฺฉููุฏ ู ุจู ุดูุง ุงูฺฉุงู ูโุฏููุฏ ฺฉ iterator ุจููุณุฏ ฺฉู ุฏุฑ ุทูู ุงุฌุฑุง ุขู ููุชุธุฑ ุจูุงูุฏ ู ุนูุงุตุฑ ุฑุง ุจู ุตูุฑุช ุบุฑููุฒูุงู ุจุฑฺฏุฑุฏุงูุฏ. ุงู ูฺฺฏ ุจุฑ ุงุณุงุณ ุฏู ุงูุชุฑูุณ ุฒุฑ ุณุงุฎุชู ุดุฏู ุงุณุช ฺฉู ูุณุฎูโูุง ุบุฑููุฒูุงู ุงูุชุฑูุณโูุง ุดูุงุฑุด ูุณุชูุฏ:

```csharp
public interface IAsyncEnumerable<out T>
{
    IAsyncEnumerator<T> GetAsyncEnumerator(...);
}

public interface IAsyncEnumerator<out T> : IAsyncDisposable
{
    T Current { get; }
    ValueTask<bool> MoveNextAsync();
}
```

`ValueTask<T>` ฺฉ struct ุงุณุช ฺฉู `Task<T>` ุฑุง ุจุณุชูโุจูุฏ ูโฺฉูุฏ ู ุงุฒ ูุธุฑ ุฑูุชุงุฑ ูุดุงุจู ุขู ุงุณุช ู ุฏุฑ ุนู ุญุงู ุงุฌุฑุง ฺฉุงุฑุขูุฏุชุฑ ุฒูุงู ฺฉู ุชุณฺฉ ุจู ุตูุฑุช ููุฒูุงู ฺฉุงูู ุดูุฏุ ุงุฑุงุฆู ูโุฏูุฏ. `IAsyncDisposable` ูุณุฎู ุบุฑููุฒูุงู `IDisposable` ุงุณุช ู ุงูฺฉุงู cleanup ุบุฑููุฒูุงู ุฑุง ูุฑุงูู ูโฺฉูุฏ:

```csharp
public interface IAsyncDisposable
{
    ValueTask DisposeAsync();
}
```

ุงูุฏุงู ุจู ฺฏุฑูุชู ูุฑ ุนูุตุฑ ุงุฒ ุชูุงู (`MoveNextAsync`) ฺฉ ุนููุงุช ุบุฑููุฒูุงู ุงุณุชุ ุจูุงุจุฑุงู ุฌุฑุงูโูุง ุบุฑููุฒูุงู ููุงุณุจ ุฒูุงู ูุณุชูุฏ ฺฉู ุนูุงุตุฑ ุจู ุตูุฑุช ุชุฏุฑุฌ (ูุซูุงู ุงุฒ ฺฉ ูุฏู ุงุณุชุฑู) ูโุฑุณูุฏ.

ุฏุฑ ููุงุจูุ ููุน ุฒุฑ ุฒูุงู ููุงุณุจ ุงุณุช ฺฉู ฺฉู ุชูุงู ุชุฃุฎุฑ ุฏุงุดุชู ุจุงุดุฏ ุงูุง ุนูุงุตุฑ ููฺฏุงู ุฑุณุฏู ููู ุจุง ูู ุงุฑุงุฆู ุดููุฏ:

```csharp
Task<IEnumerable<T>>
```

ุจุฑุง ุงุฌุงุฏ ุฌุฑุงู ุบุฑููุฒูุงูุ ุจุงุฏ ูุชุฏ ููุดุช ฺฉู ุงุตูู iterator ู ูุชุฏูุง ุบุฑููุฒูุงู ุฑุง ุชุฑฺฉุจ ฺฉูุฏ. ุนู ูุชุฏ ุจุงุฏ ูู `yield return` ู ูู `await` ุฏุงุดุชู ุจุงุดุฏ ู ููุน ุจุงุฒฺฏุดุช ุขู `IAsyncEnumerable<T>` ุจุงุดุฏ:

```csharp
async IAsyncEnumerable<int> RangeAsync(int start, int count, int delay)
{
    for (int i = start; i < start + count; i++)
    {
        await Task.Delay(delay);
        yield return i;
    }
}
```

ุจุฑุง ูุตุฑู ฺฉ ุฌุฑุงู ุบุฑููุฒูุงูุ ุงุฒ `await foreach` ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
await foreach (var number in RangeAsync(0, 10, 500))
    Console.WriteLine(number);
```

ุชูุฌู ฺฉูุฏ ฺฉู ุฏุงุฏูโูุง ุจู ุตูุฑุช ูพูุณุชู ูุฑ ตฐฐ ููโุซุงูู (ุง ุฏุฑ ูุงูุนุชุ ุจู ูุญุถ ุขูุงุฏู ุดุฏู) ูโุฑุณูุฏ. ุฏุฑ ููุงุณู ุจุง ููุงู ุณุงุฎุชุงุฑ ุจุง `Task<IEnumerable<T>>`ุ ูฺ ุฏุงุฏูโุง ุจุงุฒฺฏุฑุฏุงูุฏู ููโุดูุฏ ุชุง ุขุฎุฑู ุนูุตุฑ ุขูุงุฏู ุดูุฏ:

```csharp
static async Task<IEnumerable<int>> RangeTaskAsync(int start, int count, int delay)
{
    List<int> data = new List<int>();
    for (int i = start; i < start + count; i++)
    {
        await Task.Delay(delay);
        data.Add(i);
    }
    return data;
}
```

ุจุฑุง ูุตุฑู ุขู ุจุง `foreach`:

```csharp
foreach (var data in await RangeTaskAsync(0, 10, 500))
    Console.WriteLine(data);
```

### ูพุฑุณโูุฌู ุฑู IAsyncEnumerable<T> ๐

ูพฺฉุฌ **System.Linq.Async**ุ ุนููฺฏุฑูุง LINQ ุฑุง ุจุฑุง **IAsyncEnumerable<T>** ุชุนุฑู ูโฺฉูุฏุ ฺฉู ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ฺฉูุฆุฑโูุง ุฑุง ุชูุฑุจุงู ููุงููุฏ **IEnumerable<T>** ุจููุณุฏ.

ุจุฑุง ูุซุงูุ ูโุชูุงูู ฺฉ ฺฉูุฆุฑ LINQ ุฑู ูุชุฏ **RangeAsync** ฺฉู ุฏุฑ ุจุฎุด ูุจู ุชุนุฑู ฺฉุฑุฏู ุจููุณู:

```csharp
IAsyncEnumerable<int> query =
    from i in RangeAsync(0, 10, 500)
    where i % 2 == 0      // ููุท ุงุนุฏุงุฏ ุฒูุฌ
    select i * 10;        // ุถุฑุจ ุฏุฑ ฑฐ

await foreach (var number in query)
    Console.WriteLine(number);
```

ุงู ฺฉุฏ ุฎุฑูุฌโูุง ูุงููุฏ `0, 20, 40, ...` ุชููุฏ ูโฺฉูุฏ.

ุงฺฏุฑ ุจุง **Rx** ุขุดูุง ูุณุชุฏุ ูโุชูุงูุฏ ุงุฒ ุนููฺฏุฑูุง ููโุชุฑ ุขู ูุฒ ุจูุฑู ุจุจุฑุฏุ ุจุง ูุฑุงุฎูุงู ูุชุฏ **ToObservable** ฺฉู ฺฉ **IAsyncEnumerable<T>** ุฑุง ุจู **IObservable<T>** ุชุจุฏู ูโฺฉูุฏ. ููฺูู ูุชุฏ **ToAsyncEnumerable** ุจุฑุง ุชุจุฏู ุฏุฑ ุฌูุช ูุนฺฉูุณ ูุฒ ูุฌูุฏ ุฏุงุฑุฏ.

---

### IAsyncEnumerable<T> ุฏุฑ ASP.Net Core ๐

ุงฺฉุดูโูุง Controller ุฏุฑ **ASP.Net Core** ุงฺฉููู ูโุชูุงููุฏ **IAsyncEnumerable<T>** ุจุงุฒฺฏุฑุฏุงููุฏ. ฺูู ูุชุฏูุง ุจุงุฏ ุจุง ฺฉููู ฺฉูุฏ `async` ูุดุฎุต ุดููุฏ. ูุซุงู:

```csharp
[HttpGet]
public async IAsyncEnumerable<string> Get()
{
    using var dbContext = new BookContext();
    await foreach (var title in dbContext.Books
                                         .Select(b => b.Title)
                                         .AsAsyncEnumerable())
        yield return title;
}
```

---

### ูุชุฏูุง ุบุฑููุฒูุงู ุฏุฑ WinRT โก

ุงฺฏุฑ ุฏุฑ ุญุงู ุชูุณุนู ุจุฑูุงููโูุง **UWP** ูุณุชุฏุ ุจุงุฏ ุจุง ุงููุงุน **WinRT** ฺฉู ุฏุฑ ุณุณุชูโุนุงูู ุชุนุฑู ุดุฏูโุงูุฏ ฺฉุงุฑ ฺฉูุฏ. ูุนุงุฏู **Task** ุฏุฑ WinRTุ **IAsyncAction** ู ูุนุงุฏู **Task<TResult>**ุ **IAsyncOperation<TResult>** ุงุณุช. ุจุฑุง ุนููุงุชโูุง ฺฉู ูพุดุฑูุช (Progress) ฺฏุฒุงุฑุด ูโุฏููุฏุ ูุนุงุฏูโูุง ุนุจุงุฑุชโุงูุฏ ุงุฒ: **IAsyncActionWithProgress<TProgress>** ู **IAsyncOperationWithProgress\<TResult, TProgress>**. ููู ุงูโูุง ุฏุฑ namespace **Windows.Foundation** ุชุนุฑู ุดุฏูโุงูุฏ.

ูโุชูุงูุฏ ุขููุง ุฑุง ุจู **Task** ุง **Task<TResult>** ุชุจุฏู ฺฉูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ **AsTask**:

```csharp
Task<StorageFile> fileTask = KnownFolders.DocumentsLibrary
                                     .CreateFileAsync("test.txt")
                                     .AsTask();
```

ุง ูุณุชููุงู `await` ฺฉูุฏ:

```csharp
StorageFile file = await KnownFolders.DocumentsLibrary
                                .CreateFileAsync("test.txt");
```

ุจู ุฏูู ูุญุฏูุฏุชโูุง ุณุณุชู ููุน COMุ **IAsyncActionWithProgress<TProgress>** ู **IAsyncOperationWithProgress\<TResult, TProgress>** ุจุฑ ุงุณุงุณ **IAsyncAction** ูุณุชูุฏุ ุจูฺฉู ูุฑ ุฏู ุงุฒ ููุน ูพุงู ูุดุชุฑฺฉ ุจู ูุงู **IAsyncInfo** ุงุฑุซโุจุฑ ูโฺฉููุฏ.

ูุชุฏ **AsTask** ููฺูู ูโุชูุงูุฏ ฺฉ **cancellation token** ุฏุฑุงูุช ฺฉูุฏ ู ูโุชูุงูุฏ ุจุง ููุน **IProgress<T>** ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ูุณุฎูโูุง WithProgress ุชุฑฺฉุจ ุดูุฏ.

---

### ุบุฑููุฒูุงู ู Synchronization Context โณ

ููุงูโุทูุฑ ฺฉู ูุจูุงู ุฏุฏูุ ูุฌูุฏ **SynchronizationContext** ุฏุฑ ุงุฑุณุงู ุงุฏุงููโูุง ุงุฌุฑุง (continuations) ููู ุงุณุช. ฺูุฏ ูฺฉุชู ุธุฑู ุฏฺฏุฑ ูุฒ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุงู contexts ุจุง ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช `void` ุงุฌุงุฏ ูโฺฉููุฏ. ุงูโูุง ูุชุฌู ูุณุชูู ฺฉุงููพุงูุฑ C# ูุณุชุ ุจูฺฉู ูุงุด ุงุฒ ููุนโูุง **Async\*MethodBuilder** ุฏุฑ namespace **System.CompilerServices** ุงุณุช ฺฉู ฺฉุงููพุงูุฑ ููฺฏุงู ฺฏุณุชุฑุด ูุชุฏูุง ุบุฑููุฒูุงู ุงุณุชูุงุฏู ูโฺฉูุฏ.

#### ุงุฑุณุงู Exception โ๏ธ

ุฏุฑ ุจุฑูุงููโูุง Rich-Client ูุนููู ุงุณุช ฺฉู ุงุฒ ุฑูุฏุงุฏ ูุฑฺฉุฒ ูุฏุฑุช ุงุณุชุซูุง (**Application.DispatcherUnhandledException** ุฏุฑ WPF) ุจุฑุง ูพุฑุฏุงุฒุด ุงุณุชุซูุงูุง ุจุฏูู ฺฉูุชุฑู ุฑู ูุฎ UI ุงุณุชูุงุฏู ุดูุฏ. ุฏุฑ ุจุฑูุงููโูุง **ASP.NET Core** ูุฒุ ฺฉ **ExceptionFilterAttribute** ุณูุงุฑุด ุฏุฑ **ConfigureServices** ุฏุฑ **Startup.cs** ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ. ุฏุฑ ูพุดุช ุตุญููุ ุงูโูุง ุจุง ูุฑุงุฎูุงู eventูุง (ุง pipeline ูุชุฏูุง ูพุฑุฏุงุฒุด ุตูุญุงุช ุฏุฑ ASP.NET Core) ุฏุฑ ุจููฺฉ try/catch ุฎูุฏุดุงู ฺฉุงุฑ ูโฺฉููุฏ.

ูุชุฏูุง ุบุฑููุฒูุงู ุณุทุญ ุจุงูุง ุงู ููุถูุน ุฑุง ูพฺุฏู ูโฺฉููุฏ. ุจู ูุซุงู ุฒุฑ ุชูุฌู ฺฉูุฏ:

```csharp
async void ButtonClick(object sender, RoutedEventArgs args)
{
    await Task.Delay(1000);
    throw new Exception("Will this be ignored?");
}
```

ููุช ุฏฺฉูู ฺฉูฺฉ ูโุดูุฏ ู handler ุงุฌุฑุง ูโุดูุฏุ ูพุณ ุงุฒ `await` ุงุฌุฑุง ุจุฑูุงูู ุจู message loop ุจุงุฒูโฺฏุฑุฏุฏุ ู ุงุณุชุซูุง ฺฉู ฺฉ ุซุงูู ุจุนุฏ ูพุฑุชุงุจ ูโุดูุฏุ ุชูุณุท catch ุจููฺฉ ุฏุฑ message loop ฺฏุฑูุชู ููโุดูุฏ.

ุจุฑุง ุญู ุงู ูุดฺฉูุ **AsyncVoidMethodBuilder** ุงุณุชุซูุงูุง ุจุฏูู ฺฉูุชุฑู (ุฏุฑ ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช `void`) ุฑุง ูโฺฏุฑุฏ ู ุขููุง ุฑุง ุฏุฑ ุตูุฑุช ูุฌูุฏุ ุจู **SynchronizationContext** ุงุฑุณุงู ูโฺฉูุฏ ุชุง ุฑูุฏุงุฏูุง ูุฏุฑุช ุงุณุชุซูุง ุฌูุงู ููฺูุงู ุงุฌุฑุง ุดููุฏ.

ฺฉุงููพุงูุฑ ุงู ููุทู ุฑุง ุชููุง ุฑู ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช `void` ุงุนูุงู ูโฺฉูุฏ. ุจูุงุจุฑุงู ุงฺฏุฑ **ButtonClick** ุฑุง ุจู ุจุงุฒฺฏุดุช **Task** ุชุบุฑ ุฏููุ ุงุณุชุซูุง ุจุฏูู ฺฉูุชุฑู Task ุฑุง Fault ูโฺฉูุฏ ู ูฺ ูุณุฑ ุฏฺฏุฑ ุจุฑุง ุฑุณุฏู ุจู ุขู ูุฌูุฏ ูุฏุงุฑุฏ (ููุฌุฑ ุจู unobserved exception ูโุดูุฏ).

ฺฉ ูฺฉุชู ุฌุงูุจ: ูุฑู ููโฺฉูุฏ ฺฉู ุงุณุชุซูุง ูุจู ุง ุจุนุฏ ุงุฒ `await` ูพุฑุชุงุจ ุดูุฏ. ุจุฑุง ูุซุงู:

```csharp
async void Foo() { throw null; await Task.Delay(1000); }
```

ุงุณุชุซูุง ุจู SynchronizationContext (ุงฺฏุฑ ููุฌูุฏ ุจุงุดุฏ) ุงุฑุณุงู ูโุดูุฏ ู ูุฑฺฏุฒ ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒููโฺฏุฑุฏุฏ. ุงฺฏุฑ SynchronizationContext ููุฌูุฏ ูุจุงุดุฏุ ุงุณุชุซูุง ุฑู Thread Pool ฺฏุณุชุฑุด ูโุงุจุฏ ู ุจุฑูุงูู ุฎุงุชูู ูโุงุจุฏ.

ุงู ุฑูุชุงุฑ ุจุฑุง ุงุทููุงู ุงุฒ ูพุดโุจูโูพุฐุฑ ู ุณุงุฒฺฏุงุฑ ุงุณุช. ูุดุงุจู ุงูุ **InvalidOperationException** ููุดู ุจุงุนุซ Fault ุดุฏู Task ูโุดูุฏุ ุจุฏูู ุชูุฌู ุจู ุดุฑุทโูุง:

```csharp
async Task Foo()
{
    if (someCondition) await Task.Delay(100);
    throw new InvalidOperationException();
}
```

Iteratorูุง ูุฒ ุจู ููู ุดฺฉู ฺฉุงุฑ ูโฺฉููุฏ:

```csharp
IEnumerable<int> Foo() { throw null; yield return 123; }
```

ุฏุฑ ุงู ูุซุงูุ ุงุณุชุซูุง ุชุง ุฒูุงู enumerating ุชูุงู ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒููโฺฏุฑุฏุฏ.

---

### OperationStarted ู OperationCompleted โ๏ธ

ุงฺฏุฑ SynchronizationContext ููุฌูุฏ ุจุงุดุฏุ ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช `void` ููฺฏุงู ูุฑูุฏ ุจู ูุชุฏ **OperationStarted** ู ููฺฏุงู ูพุงุงู **OperationCompleted** ุขู ุฑุง ูุฑุงุฎูุงู ูโฺฉููุฏ.

Override ฺฉุฑุฏู ุงู ูุชุฏูุง ููฺฏุงู ููุดุชู ฺฉ SynchronizationContext ุณูุงุฑุด ุจุฑุง ุชุณุช ูุงุญุฏ ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช `void` ููุฏ ุงุณุช. ุงู ููุถูุน ุฏุฑ **Microsoft Parallel Programming blog** ุชูุถุญ ุฏุงุฏู ุดุฏู ุงุณุช.

### ุจูููโุณุงุฒโูุง โก

#### ุชฺฉูู ููุฒูุงู (Completing synchronously) โฑ๏ธ

ฺฉ ูุชุฏ ุบุฑููุฒูุงู ูโุชูุงูุฏ ูุจู ุงุฒ `await` ุจุงุฒฺฏุฑุฏุฏ. ุจู ูุซุงู ุฒุฑ ฺฉู ุฏุงูููุฏ ุตูุญุงุช ูุจ ุฑุง **ฺฉุด** ูโฺฉูุฏ ุชูุฌู ฺฉูุฏ:

```csharp
static Dictionary<string,string> _cache = new Dictionary<string,string>();

async Task<string> GetWebPageAsync(string uri)
{
    string html;
    if (_cache.TryGetValue(uri, out html)) return html;
    return _cache[uri] = await new WebClient().DownloadStringTaskAsync(uri);
}
```

ุงฺฏุฑ URI ุงุฒ ูุจู ุฏุฑ ฺฉุด ููุฌูุฏ ุจุงุดุฏุ ุงุฌุฑุง ุจุฑูุงูู ุจุฏูู ูฺ `await` ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏ ู ูุชุฏ ฺฉ **Task** ุงุฒ ูพุด ุชฺฉููโุดุฏู ุจุฑูโฺฏุฑุฏุงูุฏ. ุจู ุงู ุญุงูุช **ุชฺฉูู ููุฒูุงู (synchronous completion)** ฺฏูุชู ูโุดูุฏ.

ููุช ฺฉ **Task** ฺฉู ููุฒูุงู ุชฺฉูู ุดุฏู ุฑุง `await` ูโฺฉูุฏุ ุงุฌุฑุง ุจู ุฌุง ุจุงุฒฺฏุดุช ุจู ูุฑุงุฎูุงููุฏู ู ุงุฏุงูู ุงุฒ ุทุฑู continuationุ ูุณุชูู ุจู ุฏุณุชูุฑ ุจุนุฏ ูโุฑูุฏ. ฺฉุงููพุงูุฑ ุงู ุจูููโุณุงุฒ ุฑุง ุจุง ุจุฑุฑุณ ุฎุงุตุช `IsCompleted` ุฑู **awaiter** ุงูุฌุงู ูโุฏูุฏ:

```csharp
var awaiter = GetWebPageAsync().GetAwaiter();
if (awaiter.IsCompleted)
    Console.WriteLine(awaiter.GetResult());
else
    awaiter.OnCompleted(() => Console.WriteLine(awaiter.GetResult()));
```

`await` ฺฉุฑุฏู ฺฉ ูุชุฏ ฺฉู ููุฒูุงู ุชฺฉูู ุดุฏูุ ุชููุง ุจุงุฑ ฺฉูฺฺฉ ุฏุงุฑุฏโูุซูุงู ุญุฏูุฏ ฒฐ ูุงููุซุงูู ุฑู ฺฉ ฺฉุงููพูุชุฑ ฒฐฑน. ุฏุฑ ููุงุจูุ ุฑูุชู ุจู **Thread Pool** ูุฒูู ฺฉ **Context Switch** ุฏุงุฑุฏโุญุฏูุฏ ฑ ุชุง ฒ ูฺฉุฑูุซุงููุ ู ุฑูุชู ุจู **UI Message Loop** ุญุฏุงูู ฑฐ ุจุฑุงุจุฑ ุจุดุชุฑ (ุจุณุงุฑ ุจุดุชุฑ ุงฺฏุฑ ูุฎ UI ุดููุบ ุจุงุดุฏ).

---

#### ูุชุฏูุง ุบุฑููุฒูุงู ุจุฏูู `await` โ๏ธ

ูุงูููุงู ูโุชูุงูุฏ ูุชุฏูุง ุบุฑููุฒูุงู ุจููุณุฏ ฺฉู ูุฑฺฏุฒ `await` ูุฏุงุดุชู ุจุงุดูุฏุ ฺฏุฑฺู ฺฉุงููพุงูุฑ ูุดุฏุงุฑ ูโุฏูุฏ:

```csharp
async Task<string> Foo() { return "abc"; }
```

ุงู ูุชุฏูุง ุจุฑุง **Override ฺฉุฑุฏู ูุชุฏูุง virtual/abstract** ููุฏูุฏุ ุญุช ุงฺฏุฑ ูุงุฒ ุจู ุบุฑููุฒูุงู ูุฏุงุดุชู ุจุงุดุฏ. ุฑูุด ุฏฺฏุฑ ุงุณุชูุงุฏู ุงุฒ **Task.FromResult** ุงุณุชุ ฺฉู ฺฉ **Task** ุงุฒ ูพุด ุชฺฉููโุดุฏู ุจุฑูโฺฏุฑุฏุงูุฏ:

```csharp
Task<string> Foo() { return Task.FromResult("abc"); }
```

ูุชุฏ **GetWebPageAsync** ุงฺฏุฑ ุงุฒ ูุฎ UI ูุฑุงุฎูุงู ุดูุฏุ ุจู ุทูุฑ ุถูู **Thread-Safe** ุงุณุชุ ุฒุฑุง ูโุชูุงู ฺูุฏ ุจุงุฑ ูพุดุช ุณุฑ ูู ุขู ุฑุง ูุฑุงุฎูุงู ฺฉุฑุฏ ุจุฏูู ูุงุฒ ุจู ููู ฺฉุฑุฏู. ุงูุง ุงฺฏุฑ ฺูุฏ ูุฑุงุฎูุงู ุจุฑุง ููุงู URI ุงูุฌุงู ุดูุฏุ ฺูุฏ ุฏุงูููุฏ ุชฺฉุฑุงุฑ ุฑุฎ ูโุฏูุฏ ฺฉู ุฏุฑ ููุงุช ุขุฎุฑู ุฏุงูููุฏ ฺฉุด ุฑุง ุจุฑูุฒุฑุณุงู ูโฺฉูุฏ.

ุฑุงู ุญู ุจููู: ุจู ุฌุง ุฐุฎุฑู ุฑุดุชูโูุงุ **ฺฉุด โfuturesโ** (ุนู Task<string>) ุงุฌุงุฏ ฺฉูุฏ:

```csharp
static Dictionary<string,Task<string>> _cache = new Dictionary<string,Task<string>>();

Task<string> GetWebPageAsync(string uri)
{
    if (_cache.TryGetValue(uri, out var downloadTask)) return downloadTask;
    return _cache[uri] = new WebClient().DownloadStringTaskAsync(uri);
}
```

ุชูุฌู ฺฉูุฏ ฺฉู ูุชุฏ ุฑุง `async` ูฺฉุฑุฏูุ ุฒุฑุง ูุณุชููุงู **Task** ุจุฏุณุช ุขูุฏู ุงุฒ **WebClient** ุฑุง ุจุฑูโฺฏุฑุฏุงูู.

ุงฺฏุฑ ฺูุฏ ุจุงุฑ ููุงู URI ุฑุง ูุฑุงุฎูุงู ฺฉููุ ููุงู **Task<string>** ุจุฑูโฺฏุฑุฏุฏ ู ุญุช ุงฺฏุฑ Task ฺฉุงูู ุดุฏู ุจุงุดุฏุ `await` ฺฉุฑุฏู ุขู ุงุฑุฒุงู ุงุณุช.

ุจุฑุง ุงููโุณุงุฒ ฺฉุงููุ ูโุชูุงูู ุจู ฺฉู ุจุฏูู ูุชุฏ **Lock** ุงุถุงูู ฺฉูู:

```csharp
lock(_cache)
{
    if (_cache.TryGetValue(uri, out var downloadTask))
        return downloadTask;
    else
        return _cache[uri] = new WebClient().DownloadStringTaskAsync(uri);
}
```

ููู ููุท ุจุฑุง ุจุฑุฑุณ ฺฉุด ู ุงุฌุงุฏ Task ุฌุฏุฏ ุงุณุชุ ูู ุจุฑุง ุทูู ุฒูุงู ุฏุงูููุฏุ ุชุง ููุฒูุงู ุญูุธ ุดูุฏ.

---

#### ValueTask<T> ๐

**ValueTask<T>** ุจุฑุง **ูุฑูุจูููโุณุงุฒ** ุทุฑุงุญ ุดุฏู ู ููฺฉู ุงุณุช ูุงุฒ ุจู ุงุณุชูุงุฏู ุงุฒ ุขู ูุฏุงุดุชู ุจุงุดุฏุ ุงูุง ุจุฑุฎ ูุชุฏูุง .NET ู **IAsyncEnumerable<T>** ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉููุฏ.

ููุงูโุทูุฑ ฺฉู ุฏุฏูุ ฺฉุงููพุงูุฑ ููฺฏุงู `await` ุฑู ฺฉ Task ุชฺฉููโุดุฏู ููุฒูุงูุ continuation ุฑุง ฺฉูุชุงูโฺฉุฑุฏู ู ูุณุชูู ุจู ุฏุณุชูุฑ ุจุนุฏ ูโุฑูุฏ. ุงฺฏุฑ ุชฺฉูู ููุฒูุงู ุจู ุฏูู **ฺฉุด** ุจุงุดุฏุ ูโุชูุงู ฺฉุด Task ุฑุง ุฐุฎุฑู ฺฉุฑุฏ ุชุง ุจููู ู ุดฺฉ ุจุงุดุฏ.

ุงูุง ุฏุฑ ููู ุญุงูุงุช ุนูู ูุณุช ู ฺฏุงู ูุงุฒ ุจู ุณุงุฎุช Task ุฌุฏุฏ ุงุณุช. ฺูู Task ู Task<T> **Reference Type** ูุณุชูุฏุ ุงุฌุงุฏ ุขูโูุง ูุงุฒ ุจู ุญุงูุธู ุฑู Heap ุฏุงุฑุฏ ู ุฏุฑ ููุงุช ุฌูุนโุขูุฑ ุฒุจุงูู ุฑุฎ ูโุฏูุฏ.

ุจุฑุง **ุจูููโุณุงุฒ ุจุฏูู ุชุฎุตุต ุญุงูุธู**ุ ุงุฒ **ValueTask** ู **ValueTask<T>** ุงุณุชูุงุฏู ูโฺฉูู:

```csharp
async ValueTask<int> Foo() { ... }
int answer = await Foo();   // (ุงุญุชูุงูุงู) ุจุฏูู ุชุฎุตุต
```

ุงฺฏุฑ ุนููุงุช ููุฒูุงู ฺฉุงูู ูุดูุฏุ **ValueTask<T>** ฺฉ Task<T> ูุนููู ูโุณุงุฒุฏ ู await ุฑุง ุจู ุขู ููุชูู ูโฺฉูุฏ. ูโุชูุงู ValueTask<T> ุฑุง ุจู Task<T> ุจุง **AsTask** ุชุจุฏู ฺฉุฑุฏ. ูุณุฎู ุบุฑุฌูุฑฺฉ ุขู ูุฒ ูุฌูุฏ ุฏุงุฑุฏุ ูุดุงุจู Task.

---

#### ูฺฉุงุช ุงุญุชุงุท ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ValueTask<T> โ๏ธ

ValueTask<T> ุจู ุฏูู ุงูฺฉู struct ุงุณุชุ ุฑูุชุงุฑ ููุน ููุฏุงุฑ (Value Type) ุฏุงุฑุฏ ู ููฺฉู ุงุณุช ุจุงุนุซ ุงุดุชุจุงู ุดูุฏ. ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฑูุชุงุฑ ูุงุฏุฑุณุชุ ุงุฒ ฺฉุงุฑูุง ุฒุฑ ูพุฑูุฒ ฺฉูุฏ:

* `await` ฺฉุฑุฏู ููุงู ValueTask<T> ฺูุฏ ุจุงุฑ
* ูุฑุงุฎูุงู `.GetAwaiter().GetResult()` ูุจู ุงุฒ ุชฺฉูู ุนููุงุช

ุงฺฏุฑ ูุงุฒ ุจู ุงู ฺฉุงุฑูุง ุฏุงุฑุฏุ ุงุจุชุฏุง ุจุง **.AsTask()** ุจู Task ุชุจุฏู ฺฉุฑุฏู ู ุฑู ุขู ฺฉุงุฑ ฺฉูุฏ:

```csharp
await Foo();              // ุงูู
ValueTask<int> valueTask = Foo();  // ุฎุทุฑูุงฺฉ!
Task<int> task = Foo().AsTask();   // ุงูู
```

---

#### ุฌููฺฏุฑ ุงุฒ Bounce ุฒุงุฏ ๐

ุจุฑุง ูุชุฏูุง ฺฉู ุฏุฑ ฺฉ ุญููู ูุฑุงุฎูุงู ูโุดููุฏุ ูโุชูุงูุฏ ูุฒูู ุฑูุช ู ุจุฑฺฏุดุช ุจู UI message loop ุฑุง ุจุง **ConfigureAwait(false)** ฺฉุงูุด ุฏูุฏ. ุงู ุจุงุนุซ ูโุดูุฏ continuation ุจู **SynchronizationContext** ุจุงุฒูฺฏุฑุฏุฏ ู ุจุงุฑ ฺฉูุชุฑ ุดูุฏ:

```csharp
async void A() { ... await B(); ... }

async Task B()
{
    for (int i = 0; i < 1000; i++)
        await C().ConfigureAwait(false);
}

async Task C() { ... }
```

ุฏุฑ ุงู ุญุงูุชุ ูุฏู ุณุงุฏู thread-safety ุฏุฑ ุงูพโูุง UI ุงุฒ ุจู ูโุฑูุฏุ ุงูุง ูุชุฏ A ุงฺฏุฑ ุฑู ูุฎ UI ุดุฑูุน ุดุฏู ุจุงุดุฏุ ุฑู ููุงู ูุฎ ุจุงู ูโูุงูุฏ.

ุงู ุจูููโุณุงุฒ ุจุฑุง **ฺฉุชุงุจุฎุงููโูุง** ุจุณุงุฑ ููุฏ ุงุณุชุ ุฌุง ฺฉู ูุนูููุงู ุจุง state ูุดุชุฑฺฉ ูุฑุงุฎูุงููุฏู ฺฉุงุฑ ููโฺฉูุฏ ู ุจู ฺฉูุชุฑูโูุง UI ุฏุณุชุฑุณ ูุฏุงุฑุฏ. ููฺูู ูุชุฏูุง ฺฉู ุณุฑุน ุงุฌุฑุง ูโุดููุฏุ ูโุชูุงููุฏ ุจุฏูู ุชุฎุตุต Task ฺฉุงูู ุดููุฏ.

### ุงูฺฏููุง ุบุฑููุฒูุงู (Asynchronous Patterns) โก

#### ูุบู ุนููุงุช (Cancellation) โ

ฺฏุงู ุงููุงุช ููู ุงุณุช ฺฉู ุจุชูุงู ฺฉ ุนููุงุช ููุฒูุงู ุฑุง ุจุนุฏ ุงุฒ ุดุฑูุนุ **ูุบู** ฺฉุฑุฏโูุซูุงู ุฏุฑ ูพุงุณุฎ ุจู ุฏุฑุฎูุงุณุช ฺฉุงุฑุจุฑ. ฺฉ ุฑุงู ุณุงุฏู ุจุฑุง ุงู ฺฉุงุฑ ุงุณุชูุงุฏู ุงุฒ **ููฺฏ ูุบู (cancellation flag)** ุงุณุชุ ฺฉู ูโุชูุงู ุจุง ููุดุชู ฺฉูุงุณ ุฒุฑ ุขู ุฑุง ฺฉูพุณููู ฺฉุฑุฏ:

```csharp
class CancellationToken
{
    public bool IsCancellationRequested { get; private set; }
    public void Cancel() { IsCancellationRequested = true; }
    public void ThrowIfCancellationRequested()
    {
        if (IsCancellationRequested)
            throw new OperationCanceledException();
    }
}
```

ุณูพุณ ูโุชูุงูู ฺฉ ูุชุฏ ุบุฑููุฒูุงู ูุงุจู ูุบู ุจููุณู:

```csharp
async Task Foo(CancellationToken cancellationToken)
{
    for (int i = 0; i < 10; i++)
    {
        Console.WriteLine(i);
        await Task.Delay(1000);
        cancellationToken.ThrowIfCancellationRequested();
    }
}
```

ููุช ูุฑุงุฎูุงููุฏู ุจุฎูุงูุฏ ุนููุงุช ุฑุง ูุบู ฺฉูุฏุ ูุชุฏ `Cancel` ุฑุง ุฑู **cancellation token** ูุฑุงุฎูุงู ูโฺฉูุฏ. ุงู ุจุงุนุซ ูโุดูุฏ `IsCancellationRequested` ุจุฑุงุจุฑ ุจุง true ุดูุฏ ู ูุชุฏ Foo ุจุง ฺฉ **OperationCanceledException** ูุชููู ุดูุฏ.

CLR ฺฉ ููุน ูุดุงุจู ุจู ูุงู **CancellationToken** ุฏุงุฑุฏุ ูู **ูุชุฏ Cancel** ูุฏุงุฑุฏุ ุงู ูุชุฏ ุฑู **CancellationTokenSource** ุงุฑุงุฆู ุดุฏู ุงุณุช. ุงู ุชูฺฉฺฉ ุจุงุนุซ ุงููุช ุจุดุชุฑ ูโุดูุฏ: ูุชุฏ ฺฉู ููุท ุฏุณุชุฑุณ ุจู CancellationToken ุฏุงุฑุฏุ ูโุชูุงูุฏ ูุบู ุฑุง ฺฺฉ ฺฉูุฏ ูู ุขู ุฑุง ุขุบุงุฒ ูฺฉูุฏ.

ุจุฑุง ฺฏุฑูุชู ฺฉ **cancellation token** ุงุจุชุฏุง ฺฉ **CancellationTokenSource** ุงุฌุงุฏ ูโฺฉูู:

```csharp
var cancelSource = new CancellationTokenSource();
Task foo = Foo(cancelSource.Token);
...
cancelSource.Cancel();
```

ุงฺฉุซุฑ ูุชุฏูุง ุบุฑููุฒูุงู ุฏุฑ CLR ุงุฒ **cancellation token** ูพุดุชุจุงู ูโฺฉููุฏุ ุงุฒ ุฌููู **Task.Delay**. ุงฺฏุฑ ูุชุฏ Foo **ุชูฺฉู** ุฎูุฏ ุฑุง ุจู Delay ุจุฏูุฏุ Task ุจูุงูุงุตูู ูพุณ ุงุฒ ุฏุฑุฎูุงุณุช ูุบู ูุชููู ูโุดูุฏ:

```csharp
async Task Foo(CancellationToken cancellationToken)
{
    for (int i = 0; i < 10; i++)
    {
        Console.WriteLine(i);
        await Task.Delay(1000, cancellationToken);
    }
}
```

ุฏฺฏุฑ ูุงุฒ ุจู `ThrowIfCancellationRequested` ูุณุชุ ุฒุฑุง **Task.Delay** ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ. **Cancellation tokens** ุจู ุฎูุจ ุฏุฑ ุทูู call stack ููุชูู ูโุดููุฏ.

---

#### ฺฏุฒุงุฑุด ูพุดุฑูุช (Progress Reporting) ๐

ฺฏุงู ูุงุฒู ุงุณุช ฺฉ ุนููุงุช ุบุฑููุฒูุงู **ูพุดุฑูุช** ุฎูุฏ ุฑุง ฺฏุฒุงุฑุด ุฏูุฏ. ฺฉ ุฑุงู ุณุงุฏู ุงุณุชูุงุฏู ุงุฒ **Action delegate** ุงุณุช:

```csharp
Task Foo(Action<int> onProgressPercentChanged)
{
    return Task.Run(() =>
    {
        for (int i = 0; i < 1000; i++)
        {
            if (i % 10 == 0) onProgressPercentChanged(i / 10);
            // ุงูุฌุงู ฺฉุงุฑ ฺฉู ุฒูุงูโุจุฑ ุงุณุช...
        }
    });
}

Action<int> progress = i => Console.WriteLine(i + " %");
await Foo(progress);
```

ุงู ุฑูุด ุฏุฑ **Console App** ุฎูุจ ฺฉุงุฑ ูโฺฉูุฏุ ูู ุฏุฑ **rich-client** ูุดฺฉูุงุช **thread-safety** ุงุฌุงุฏ ูโฺฉูุฏุ ฺูู ูพุดุฑูุช ุงุฒ ฺฉ **worker thread** ฺฏุฒุงุฑุด ูโุดูุฏ.

CLR ฺฉ ุฑุงู ุญู ุจูุชุฑ ุงุฑุงุฆู ูโุฏูุฏ: **IProgress<T>** ู ฺฉูุงุณ **Progress<T>**. ุงู ฺฉูุงุณโูุง **delegate** ุฑุง ฺฉูพุณููู ูโฺฉููุฏ ุชุง ุงูพูฺฉุดูโูุง UI ุจุชูุงููุฏ ูพุดุฑูุช ุฑุง ุจู ุตูุฑุช ุงูู ุงุฒ ุทุฑู **SynchronizationContext** ฺฏุฒุงุฑุด ฺฉููุฏ.

```csharp
public interface IProgress<in T>
{
    void Report(T value);
}
```

ุงุณุชูุงุฏู ุงุฒ IProgress<T> ุขุณุงู ุงุณุช:

```csharp
Task Foo(IProgress<int> onProgressPercentChanged)
{
    return Task.Run(() =>
    {
        for (int i = 0; i < 1000; i++)
        {
            if (i % 10 == 0) onProgressPercentChanged.Report(i / 10);
            // ุงูุฌุงู ฺฉุงุฑ ฺฉู ุฒูุงูโุจุฑ ุงุณุช...
        }
    });
}

var progress = new Progress<int>(i => Console.WriteLine(i + " %"));
await Foo(progress);
```

ฺฉูุงุณ **Progress<T>** ููฺฏุงู ุงุฌุงุฏุ **SynchronizationContext** ุฑุง ุฐุฎุฑู ูโฺฉูุฏ. ููุช **Report** ูุฑุงุฎูุงู ุดูุฏุ delegate ุงุฒ ุทุฑู ููุงู context ุงุฌุฑุง ูโุดูุฏ.

---

#### ููุงุณู ุจุง Rx

ุงฺฏุฑ ุจุง **Rx** ุขุดูุง ุจุงุดุฏุ ูุชูุฌู ูโุดูุฏ ฺฉู **IProgress<T>** ููุฑุงู ุจุง **Task** ุฎุฑูุฌุ ูุฌููุนู ูุงุจูุช ูุดุงุจู **IObserver<T>** ุฑุง ุงุฑุงุฆู ูโุฏูุฏ. ุชูุงูุช ุงู ุงุณุช ฺฉู Task ูโุชูุงูุฏ **ููุฏุงุฑ ููุง** ุจุฑฺฏุฑุฏุงูุฏุ ุฏุฑ ุญุงู ฺฉู IProgress<T> ููุงุฏุฑ ูุงู (ูุซูุงู ุฏุฑุตุฏ ุชฺฉูู ุง ุจุงุชโูุง ุฏุงูููุฏ ุดุฏู) ุฑุง ฺฏุฒุงุฑุด ูโฺฉูุฏ.

---

#### WinRT ู ฺฏุฒุงุฑุด ูพุดุฑูุช

ุฏุฑ WinRTุ ูุชุฏูุง ุบุฑููุฒูุงู ฺฉู ูพุดุฑูุช ุฑุง ฺฏุฒุงุฑุด ูโุฏููุฏุ ุจู ุฌุง IProgress<T>ุ ฺฉ ุงุฒ ุงู ุฑุงุจุทโูุง ุฑุง ุจุฑูโฺฏุฑุฏุงููุฏ:

* `IAsyncActionWithProgress<TProgress>`
* `IAsyncOperationWithProgress<TResult, TProgress>`

ูุฑ ุฏู ุงุฒ `IAsyncInfo` ูุดุชู ุดุฏูโุงูุฏ. ุจุง ุงุณุชูุงุฏู ุงุฒ **AsTask**ุ ูโุชูุงู ุขูโูุง ุฑุง ุจู Task ูุนููู ุจุง **IProgress<T>** ุชุจุฏู ฺฉุฑุฏ:

```csharp
var progress = new Progress<int>(i => Console.WriteLine(i + " %"));
CancellationToken cancelToken = ...
var task = someWinRTobject.FooAsync().AsTask(cancelToken, progress);
```

ุงู ุฑูุด ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ุชุง ุงุฒ **ุฑุงุจุทโูุง COM ูพฺุฏู** ุตุฑูโูุธุฑ ฺฉูุฏ ู ุจู ุณุงุฏฺฏ ุงุฒ **.NET API** ุจุฑุง ูุบู ู ฺฏุฒุงุฑุด ูพุดุฑูุช ุงุณุชูุงุฏู ููุงุฏ.

### ุงูฺฏู ุบุฑููุฒูุงู ูุจุชู ุจุฑ Task (Task-Based Asynchronous Pattern โ TAP) โก

ุฏุฑ .NET ุตุฏูุง ูุชุฏ ุบุฑููุฒูุงู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู **Task** ุง **Task<TResult>** ุจุฑูโฺฏุฑุฏุงููุฏ ู ูโุชูุงูุฏ ุฑู ุขูโูุง **await** ฺฉูุฏ (ุจุดุชุฑ ูุฑุจูุท ุจู ุนููุงุช I/O). ุจุดุชุฑ ุงู ูุชุฏูุง ุญุฏุงูู ุชุง ุญุฏ ุงุฒ ุงูฺฏู ุจู ูุงู **Task-Based Asynchronous Pattern (TAP)** ูพุฑู ูโฺฉููุฏ ฺฉู ฺฉ **ุณุงุฎุชุงุฑ ููุทู ู ุงุณุชุงูุฏุงุฑุฏ** ุจุฑุง ฺฉุงุฑ ุจุง Taskูุง ุงุฑุงุฆู ูโุฏูุฏ. ฺฉ ูุชุฏ TAP ูุนูููุงู ูฺฺฏโูุง ุฒุฑ ุฑุง ุฏุงุฑุฏ:

* ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉ **Task ุง Task<TResult> ูุนุงู (hot)**
* ูุงู ุขู ุจุง ูพุณููุฏ **Async** ุฎุชู ูโุดูุฏ (ุจู ุฌุฒ ููุงุฑุฏ ุฎุงุต ูุซู task combinatorูุง)
* ุฏุฑ ุตูุฑุช ูพุดุชุจุงู ุงุฒ ูุบู ุง ฺฏุฒุงุฑุด ูพุดุฑูุชุ **overload**ูุง ูโูพุฐุฑุฏ ฺฉู **cancellation token** ู/ุง **IProgress<T>** ุฑุง ุฏุฑุงูุช ูโฺฉููุฏ
* ุณุฑุน ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏ (ููุท ฺฉ ูุงุฒ ููุฒูุงู ฺฉูุชุงู ุฏุงุฑุฏ)
* ุงฺฏุฑ ุนููุงุช I/O ูุญูุฑ ุจุงุดุฏุ ฺฉ Thread ุฑุง ุฏุฑฺฏุฑ ููโฺฉูุฏ

ููุงูโุทูุฑ ฺฉู ุฏุฏูุ ููุดุชู ูุชุฏูุง TAP ุจุง **async/await** ุฏุฑ C# ุจุณุงุฑ ุณุงุฏู ุงุณุช.

---

### ุชุฑฺฉุจโฺฉููุฏูโูุง Task (Task Combinators) ๐

ฺฉ ุงุฒ ูุฒุงุง ุฏุงุดุชู ฺฉ ูพุฑูุชฺฉู ฺฉููุงุฎุช ุจุฑุง ูุชุฏูุง ุบุฑููุฒูุงู ุงู ุงุณุช ฺฉู ูโุชูุงู **task combinator** ููุดุช ู ุงุณุชูุงุฏู ฺฉุฑุฏโุนู ุชูุงุจุน ฺฉู ฺูุฏ Task ุฑุง ุจุง ูู ุชุฑฺฉุจ ูโฺฉููุฏุ ุจุฏูู ุชูุฌู ุจู ุงูฺฉู ูุฑ Task ุฏููุงู ฺู ฺฉุงุฑ ุงูุฌุงู ูโุฏูุฏ.

CLR ุฏู ุชุฑฺฉุจโฺฉููุฏู Task ุงุฑุงุฆู ูโุฏูุฏ: **Task.WhenAny** ู **Task.WhenAll**. ุจุฑุง ุชูุถุญ ุขูโูุงุ ูุฑุถ ูโฺฉูู ูุชุฏูุง ุฒุฑ ุชุนุฑู ุดุฏูโุงูุฏ:

```csharp
async Task<int> Delay1() { await Task.Delay(1000); return 1; }
async Task<int> Delay2() { await Task.Delay(2000); return 2; }
async Task<int> Delay3() { await Task.Delay(3000); return 3; }
```

---

#### Task.WhenAny ๐

**Task.WhenAny** ฺฉ Task ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ููุช **ูุฑ ฺฉ ุงุฒ Taskูุง ฺฉุงูู ุดุฏ**ุ ุชูุงู ูโุดูุฏ. ูุซุงู ุฒุฑ ูพุณ ุงุฒ ฑ ุซุงูู ุชฺฉูู ูโุดูุฏ:

```csharp
Task<int> winningTask = await Task.WhenAny(Delay1(), Delay2(), Delay3());
Console.WriteLine("Done");
Console.WriteLine(winningTask.Result);   // 1
```

ุจูุชุฑ ุงุณุช **winningTask** ุฑุง ูุฒ await ฺฉูู ุชุง ูุฑฺฏููู Exception ุจุฏูู AggregateException ุจุงุฒูุดุงู ุดูุฏ:

```csharp
Console.WriteLine(await winningTask);   // 1
```

ูโุชูุงู ุงู ุฑุง ุฏุฑ ฺฉ ุฎุท ูู ููุดุช:

```csharp
int answer = await await Task.WhenAny(Delay1(), Delay2(), Delay3());
```

**ฺฉุงุฑุจุฑุฏ:** ุงุนูุงู **Timeout** ุง ูุบู ุฑู ุนููุงุช ฺฉู ูพุดุชุจุงู ููโฺฉููุฏ:

```csharp
Task<string> task = SomeAsyncFunc();
Task winner = await Task.WhenAny(task, Task.Delay(5000));
if (winner != task) throw new TimeoutException();
string result = await task;   // ุจุงุฒฺฉุฑุฏู ูุชุฌู ู ูพุฑุชุงุจ ูุฌุฏุฏ
```

---

#### Task.WhenAll ๐ฆ

**Task.WhenAll** ฺฉ Task ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ููุช **ุชูุงู Taskูุง ุชฺฉูู ุดุฏูุฏ**ุ ุชูุงู ูโุดูุฏ. ูุซุงู ุฒุฑ ูพุณ ุงุฒ ณ ุซุงูู ุชฺฉูู ูโุดูุฏ ู ุงูฺฏู **fork/join** ุฑุง ูุดุงู ูโุฏูุฏ:

```csharp
await Task.WhenAll(Delay1(), Delay2(), Delay3());
```

ุชูุงูุช ุจุง await ฺฉุฑุฏู Taskูุง ฺฉโฺฉ ุงู ุงุณุช ฺฉู ุงฺฏุฑ task1 ุจุง ุฎุทุง ููุงุฌู ุดูุฏุ ุฏฺฏุฑ task2 ู task3 ุงุฌุฑุง ููโุดููุฏ ู Exceptionูุง ุขูโูุง ูุงุฏุฏู ฺฏุฑูุชู ูโุดููุฏ. ุงูุง **Task.WhenAll** ููุชุธุฑ ูโูุงูุฏ ุชุง ููู Taskูุง ุชฺฉูู ุดููุฏ ู ุงฺฏุฑ ฺูุฏ ุฎุทุง ุฑุฎ ุฏูุฏุ ููู Exceptionูุง ุฏุฑ **AggregateException** ุชุฑฺฉุจ ูโุดููุฏ.

ุงุณุชูุงุฏู ุงุฒ Task<TResult> ุจุง WhenAll ูุชุฌูโุง ุงุฒ ููุน **Task\<TResult\[]>** ุจุฑูโฺฏุฑุฏุงูุฏ:

```csharp
Task<int> task1 = Task.Run(() => 1);
Task<int> task2 = Task.Run(() => 2);
int[] results = await Task.WhenAll(task1, task2);   // {1, 2}
```

**ูุซุงู ุนูู:** ุฏุงูููุฏ ฺูุฏ URI ุจู ุตูุฑุช ููุงุฒ ู ุฌูุน ุทูู ฺฉู ูุญุชูุง:

```csharp
async Task<int> GetTotalSize(string[] uris)
{
    IEnumerable<Task<int>> downloadTasks = uris.Select(async uri =>
        (await new WebClient().DownloadDataTaskAsync(uri)).Length);
    int[] contentLengths = await Task.WhenAll(downloadTasks);
    return contentLengths.Sum();
}
```

---

### ุชุฑฺฉุจโฺฉููุฏูโูุง ุณูุงุฑุด ๐๏ธ

ูโุชูุงู ุชุฑฺฉุจโฺฉููุฏู Task ุฎูุฏ ุฑุง ููุดุชุ ูุซูุงู ุจุฑุง await ฺฉุฑุฏู ฺฉ Task ุจุง **Timeout**:

```csharp
async static Task<TResult> WithTimeout<TResult>(this Task<TResult> task, TimeSpan timeout)
{
    var cancelSource = new CancellationTokenSource();
    var delay = Task.Delay(timeout, cancelSource.Token);
    Task winner = await Task.WhenAny(task, delay).ConfigureAwait(false);
    if (winner == task)
        cancelSource.Cancel();
    else
        throw new TimeoutException();
    return await task.ConfigureAwait(false);   // ุจุงุฒฺฉุฑุฏู ูุชุฌู ู ูพุฑุชุงุจ ูุฌุฏุฏ
}
```

ููฺูู ูโุชูุงู Task ุฑุง ุจุง **CancellationToken** ุชุฑฺฉ ฺฉุฑุฏ:

```csharp
static Task<TResult> WithCancellation<TResult>(this Task<TResult> task, CancellationToken cancelToken)
{
    var tcs = new TaskCompletionSource<TResult>();
    var reg = cancelToken.Register(() => tcs.TrySetCanceled());
    task.ContinueWith(ant => 
    {
        reg.Dispose();
        if (ant.IsCanceled)
            tcs.TrySetCanceled();
        else if (ant.IsFaulted)
            tcs.TrySetException(ant.Exception.InnerExceptions);
        else
            tcs.TrySetResult(ant.Result);
    });
    return tcs.Task;
}
```

**ูุฒุช:** ูพฺุฏฺฏ ูุฑุจูุท ุจู concurrency ุงุฒ ููุทู ุงุตู ุจุฑูุงูู ุฌุฏุง ูโุดูุฏ ู ุฏุฑ ูุชุฏูุง ูุงุจู ุงุณุชูุงุฏู ูุฌุฏุฏ ูฺฏูุฏุงุฑ ูโุดูุฏ.

---

#### TaskCompletionSource ู ฺฉูุชุฑู ุฎุทุง

ูโุชูุงู ุชุฑฺฉุจโฺฉููุฏูโุง ููุดุช ฺฉู ุดุจู **WhenAll** ุนูู ฺฉูุฏุ ุงูุง ุงฺฏุฑ ูุฑ Task ุฎุทุง ุฏูุฏุ Task ุญุงุตู ููุฑุงู ุฎุทุง ฺฉูุฏ:

```csharp
async Task<TResult[]> WhenAllOrError<TResult>(params Task<TResult>[] tasks)
{
    var killJoy = new TaskCompletionSource<TResult[]>();
    foreach (var task in tasks)
        task.ContinueWith(ant =>
        {
            if (ant.IsCanceled) 
                killJoy.TrySetCanceled();
            else if (ant.IsFaulted)
                killJoy.TrySetException(ant.Exception.InnerExceptions);
        });
    return await await Task.WhenAny(killJoy.Task, Task.WhenAll(tasks))
                           .ConfigureAwait(false);
}
```

---

### ููู ุบุฑููุฒูุงู (Asynchronous Locking) ๐

ุฏุฑ ุจุฎุด **Asynchronous semaphores and locks** (ุตูุญู 906) ุชูุถุญ ุฏุงุฏูโุงู ฺฉู ฺฺฏููู ูโุชูุงู ุจุง **SemaphoreSlim** ููู ุง ูุญุฏูุฏุช ููุฒูุงู ุฑุง ุจู ุตูุฑุช ุบุฑููุฒูุงู ุงุนูุงู ฺฉุฑุฏ.

### ุงูฺฏููุง ูุฏู ุบุฑููุฒูุงู (Obsolete Patterns) โณ

ูุจู ุงุฒ ุธููุฑ **Task** ู **async/await**ุ ุฏุฑ .NET ุฑูุดโูุง ุฏฺฏุฑ ุจุฑุง ุจุฑูุงููโููุณ ุบุฑููุฒูุงู ูุฌูุฏ ุฏุงุดุช ฺฉู ุงูุฑูุฒู ุจู ูุฏุฑุช ููุฑุฏ ูุงุฒ ูุณุชูุฏ. ุฏู ุงูฺฏู ููู ุนุจุงุฑุชโุงูุฏ ุงุฒ **APM** ู **EAP**.

---

## ฑ. ุงูฺฏู ุจุฑูุงููโููุณ ุบุฑููุฒูุงู (Asynchronous Programming Model โ APM) ๐๏ธ

APM ูุฏูโุชุฑู ุงูฺฏู ุงุณุช ู ุจุฑ ุงุณุงุณ **ุฒูุฌ ูุชุฏูุง Begin*/End*\*\* ู **IAsyncResult** ฺฉุงุฑ ูโฺฉูุฏ.

ูุซุงู ุจุง ฺฉูุงุณ `Stream` ุฏุฑ **System.IO**:

* ูุณุฎู ููุฒูุงู:

```csharp
public int Read(byte[] buffer, int offset, int size);
```

* ูุณุฎู ุบุฑููุฒูุงู ูุจุชู ุจุฑ Task:

```csharp
public Task<int> ReadAsync(byte[] buffer, int offset, int size);
```

* ูุณุฎู APM:

```csharp
public IAsyncResult BeginRead(byte[] buffer, int offset, int size,
                              AsyncCallback callback, object state);
public int EndRead(IAsyncResult asyncResult);
```

**ูุญูู ฺฉุงุฑ:**

1. ูุฑุงุฎูุงู `BeginRead` ุนููุงุช ุฑุง ุดุฑูุน ูโฺฉูุฏ ู ฺฉ **IAsyncResult** ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ูุงููุฏ ฺฉ **ุชูฺฉู** ุนูู ูโฺฉูุฏ.
2. ููุช ุนููุงุช ุชฺฉูู ุดุฏ ุง ุฎุทุง ุฏุงุฏุ **AsyncCallback** ูุฑุงุฎูุงู ูโุดูุฏ.
3. ุฏุฑ callbackุ `EndRead` ุตุฏุง ุฒุฏู ูโุดูุฏ ุชุง ููุฏุงุฑ ุจุงุฒฺฏุดุช ู Exception ุฏุฑ ุตูุฑุช ูุฌูุฏ ุงุฑุงุฆู ุดูุฏ.

**ูพฺุฏฺฏ:** ุงุณุชูุงุฏู ุงุฒ APM ุฏุดูุงุฑ ู ูพุงุฏูโุณุงุฒ ุขู ุญุช ุณุฎุชโุชุฑ ุงุณุช.

**ุฑุงู ุญู ูุฏุฑู:** ุงุณุชูุงุฏู ุงุฒ **Task.Factory.FromAsync** ุจุฑุง ุชุจุฏู ุฒูุฌ ูุชุฏ APM ุจู Task:

```csharp
Task<int> readChunk = Task<int>.Factory.FromAsync(
    stream.BeginRead, stream.EndRead, buffer, 0, 1000, null);
```

---

## ฒ. ุงูฺฏู ุบุฑููุฒูุงู ูุจุชู ุจุฑ ุฑูุฏุงุฏ (Event-Based Asynchronous Pattern โ EAP) ๐

EAP ุฏุฑ ุณุงู ฒฐฐต ูุนุฑู ุดุฏ ุชุง ุฌุงฺฏุฒู ุณุงุฏูโุชุฑ ุจุฑุง APM ุจุงุดุฏุ ุจู ูฺู ุฏุฑ ุณูุงุฑููุง UI.

**ููููู ฺฉูุงุณ WebClient:**

```csharp
public byte[] DownloadData(Uri address);           // ูุณุฎู ููุฒูุงู
public void DownloadDataAsync(Uri address);        // ูุณุฎู ุบุฑููุฒูุงู
public void DownloadDataAsync(Uri address, object userToken);
public event DownloadDataCompletedEventHandler DownloadDataCompleted;
public void CancelAsync(object userState);         // ูุบู ุนููุงุช
public bool IsBusy { get; }                        // ูุถุนุช ุฏุฑ ุญุงู ุงุฌุฑุง
public event DownloadProgressChangedEventHandler DownloadProgressChanged;
```

**ูุญูู ฺฉุงุฑ:**

* ูุชุฏูุง `*Async` ุนููุงุช ุฑุง ุดุฑูุน ูโฺฉููุฏ.
* ููุช ุนููุงุช ุชฺฉูู ุดุฏุ **ุฑูุฏุงุฏ `*Completed`** ูุฑุงุฎูุงู ูโุดูุฏ ู ูุชุฌูุ Exception ุง ูุถุนุช ูุบู ุฑุง ุงุฑุงุฆู ูโุฏูุฏ.
* ฺฏุฒุงุฑุด ูพุดุฑูุช ูโุชูุงูุฏ ุงุฒ ุทุฑู ุฑูุฏุงุฏ `DownloadProgressChanged` ุงูุฌุงู ุดูุฏ.
* ุงฺฏุฑ **SynchronizationContext** ููุฌูุฏ ุจุงุดุฏุ ุฑูุฏุงุฏูุง ุจู ุตูุฑุช ุงูู ุจู thread UI ุงุฑุณุงู ูโุดููุฏ.

**ูุดฺฉู:** ูพุงุฏูโุณุงุฒ EAP ูุงุฒููุฏ ฺฉุฏ boilerplate ุฒุงุฏ ุงุณุช ู ุงูฺฏู ุจู ุณุฎุช ุชุฑฺฉุจโูพุฐุฑ ุงุณุช.

---

### ณ. BackgroundWorker ๐๏ธ

ฺฉูุงุณ **BackgroundWorker** ุฏุฑ **System.ComponentModel** ฺฉ ูพุงุฏูโุณุงุฒ ุนููู ุงุฒ EAP ุงุณุช ฺฉู ุจู ุจุฑูุงููโูุง rich-client ุงุฌุงุฒู ูโุฏูุฏ:

* ุงุฌุฑุง **worker thread** ุจุฑุง ุนููุงุช ุบุฑููุฒูุงู
* ฺฏุฒุงุฑุด ุฏุฑุตุฏ ูพุดุฑูุช
* ุงุทูุงุน ุงุฒ ุงุชูุงู ุนููุงุช ุง ุฎุทุง

ูุซุงู:

```csharp
var worker = new BackgroundWorker { WorkerSupportsCancellation = true };

worker.DoWork += (sender, args) => 
{
    if (args.Cancel) return;
    Thread.Sleep(1000); 
    args.Result = 123;
};

worker.RunWorkerCompleted += (sender, args) =>
{
    if (args.Cancelled)
        Console.WriteLine("Cancelled");
    else if (args.Error != null)
        Console.WriteLine("Error: " + args.Error.Message);
    else
        Console.WriteLine("Result is: " + args.Result);
};

worker.RunWorkerAsync();   // ุดุฑูุน ุนููุงุช ู capture synchronization context
```

**ูฺฺฏโูุง:**

* `DoWork` ุฑู **worker thread** ุงุฌุฑุง ูโุดูุฏ.
* `RunWorkerCompleted` ุฑู **UI thread** ุงุฌุฑุง ูโุดูุฏ (ุงฺฏุฑ SynchronizationContext ููุฌูุฏ ุจุงุดุฏ).
* ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI ุฏุฑ `DoWork` ุจุงุฏ ุงุฒ `Dispatcher.BeginInvoke` ุงุณุชูุงุฏู ุดูุฏ.

---

๐ **ุฌูุนโุจูุฏ:**

* **APM ู EAP** ุงูฺฏููุง ูุฏู ูุณุชูุฏ ู ุงูุฑูุฒู ุจู ูุฏุฑุช ููุฑุฏ ุงุณุชูุงุฏูโุงูุฏ.
* **TAP (Task + async/await)** ุฌุงฺฏุฒู ูุฏุฑูุ ุณุงุฏู ู ุงูุนุทุงูโูพุฐุฑ ุงุณุช ู ุชูุฑุจุง ููู ูุชุฏูุง ุฌุฏุฏ .NET ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉููุฏ.
