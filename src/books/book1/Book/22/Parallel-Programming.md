---
layout: layout.njk
title: ุจุฑูุงููโููุณ ููุงุฒ (Parallel Programming)
---
# ูุตู ุจุณุช ู ุฏูู:  ุจุฑูุงููโููุณ ููุงุฒ (Parallel Programming)

ุฏุฑ ุงู ูุตูุ ูุง ุจู **APIูุง** ู ุณุงุฎุชุงุฑูุง ฺูุฏูุฎ (multithreading) ูโูพุฑุฏุงุฒู ฺฉู ุจุง ูุฏู ุจูุฑูโุจุฑุฏุงุฑ ุงุฒ ูพุฑุฏุงุฒูุฏูโูุง ฺูุฏโูุณุชูโุง ุทุฑุงุญ ุดุฏูโุงูุฏ:

* **Parallel LINQ (PLINQ)**
* **ฺฉูุงุณ Parallel**
* **ุณุงุฎุชุงุฑูุง task parallelism**
* **ูุฌููุนูโูุง concurrent**

ุงู ุณุงุฎุชุงุฑูุง ุฏุฑ ูุฌููุน (ุจูโุตูุฑุช ุบุฑุฑุณู) ุจุง ุนููุงู **Parallel Framework (PFX)** ุดูุงุฎุชู ูโุดููุฏ.
ฺฉูุงุณ **Parallel** ููุฑุงู ุจุง ุณุงุฎุชุงุฑูุง **task parallelism** ุชุญุช ุนููุงู **Task Parallel Library (TPL)** ูุงูุฏู ูโุดููุฏ.

ูพุด ุงุฒ ูุทุงูุนูโ ุงู ูุตูุ ูุงุฒู ุงุณุช ุจุง ููุงูู ูพุงูโุง ุฏุฑ ูุตู ฑด ุขุดูุง ุจุงุดุฏโุจูโูฺู **locking**ุ **ุงูู ูุฎโูุง (thread safety)** ู ฺฉูุงุณ **Task**.

๐ง ุนูุงูู ุจุฑ ุงูโูุงุ .NET ูุฌููุนูโุง ุงุฒ APIูุง ุชุฎุตุต ุฏฺฏุฑ ุฑุง ุจุฑุง ฺฉูฺฉ ุจู ุจุฑูุงููโููุณ ููุงุฒ ู ูุงููฺฏุงู ุงุฑุงุฆู ูโุฏูุฏ:

* **System.Threading.Channels.Channel** โ ฺฉ ุตู ุชููุฏฺฉููุฏู/ูุตุฑูโฺฉููุฏู ูุงููฺฏุงู ุจุง ฺฉุงุฑุง ุจุงูุงุ ฺฉู ุฏุฑ **.NET Core 3** ูุนุฑู ุดุฏ.
* **Microsoft Dataflow** (ุฏุฑ ูุถุง ูุงู System.Threading.Tasks.Dataflow) โ ฺฉ API ูพุดุฑูุชู ุจุฑุง ุงุฌุงุฏ ุดุจฺฉูโุง ุงุฒ ุจููฺฉโูุง ุจุงูุฑ ุดุฏู (buffered blocks) ฺฉู ุนููุงุช ุง ุชุจุฏู ุฏุงุฏูโูุง ุฑุง ุจูโุตูุฑุช ููุงุฒ ุงุฌุฑุง ูโฺฉููุฏ ู ุดุจุงูุช ุฒุงุฏ ุจู ุจุฑูุงููโููุณ actor/agent ุฏุงุฑูุฏ.
* **Reactive Extensions** โ ูพุงุฏูโุณุงุฒ LINQ ุฑู **IObservable** (ุฌุงฺฏุฒู ุจุฑุง **IAsyncEnumerable**) ฺฉู ุฏุฑ ุชุฑฺฉุจ ุฌุฑุงูโูุง ูุงููฺฏุงู ุจุณุงุฑ ูุฏุฑุชููุฏ ุงุณุช. ุงู ูุงุจูุช ุงุฒ ุทุฑู ุจุณุชูโ **System.Reactive NuGet** ุนุฑุถู ูโุดูุฏ.

---

## ฺุฑุง PFXุ ๐ค

ุฏุฑ ฑต ุณุงู ฺฏุฐุดุชูุ ุณุงุฒูุฏฺฏุงู CPU ุงุฒ ูพุฑุฏุงุฒูุฏูโูุง ุชฺฉโูุณุชูโุง ุจู ฺูุฏโูุณุชูโุง ููุงุฌุฑุช ฺฉุฑุฏูโุงูุฏ. ุงู ููุถูุน ุจุฑุง ูุง ุจุฑูุงููโููุณุงู ูุดฺฉูโุณุงุฒ ุงุณุชุ ุฒุฑุง ฺฉุฏูุง ุชฺฉโูุฎ ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงุฒ ูุณุชูโูุง ุจุดุชุฑ ุณุฑุนโุชุฑ ุงุฌุฑุง ููโุดููุฏ.

ุงุณุชูุงุฏู ุงุฒ ฺูุฏโูุณุชู ุฏุฑ ุจุณุงุฑ ุงุฒ ุจุฑูุงููโูุง ุณูุช ุณุฑูุฑ ุณุงุฏู ุงุณุชุ ฺูู ูุฑ ูุฎ ูโุชูุงูุฏ ฺฉ ุฏุฑุฎูุงุณุช ูุดุชุฑ ุฌุฏุงฺฏุงูู ุฑุง ุจูโุทูุฑ ูุณุชูู ูพุฑุฏุงุฒุด ฺฉูุฏ. ุงูุง ุฑู ุฏุณฺฉุชุงูพ ุงู ููุถูุน ุฏุดูุงุฑุชุฑ ุงุณุชุ ฺูู ูุนูููุงู ูุงุฒ ุฏุงุฑุฏ ฺฉุฏ ุฑุง ฺฉู ูุญุงุณุจุงุช ุณูฺฏู ุฏุงุฑุฏ ุจู ุงู ุตูุฑุช ุชุบุฑ ุฏูุฏ:

1. ุชูุณู ุขู ุจู ูุทุนูโูุง ฺฉูฺฺฉโุชุฑ.
2. ุงุฌุฑุง ุงู ูุทุนูโูุง ุจูโุตูุฑุช ููุงุฒ ุจุง ฺูุฏูุฎ.
3. ุฌูุนโุขูุฑ ูุชุงุฌ ุฏุฑ ุฒูุงู ฺฉู ุขูุงุฏู ูโุดููุฏุ ุจู ุดฺฉู **ุงูู ุงุฒ ูุธุฑ ูุฎโูุง** ู ฺฉุงุฑุง.

ุงูุจุชู ุงูุฌุงู ูููโ ุงู ูุฑุงุญู ุจุง ุณุงุฎุชุงุฑูุง ฺฉูุงุณฺฉ ฺูุฏูุฎ ููฺฉู ุงุณุชุ ุงูุง ุฏุณุชโููพุงฺฏุฑ ุงุณุชโุจูโุฎุตูุต ูุฑุงุญู ุชูุณูโุจูุฏ ู ุฌูุนโุขูุฑ ูุชุงุฌ. ูุดฺฉู ุฏฺฏุฑ ุงู ุงุณุช ฺฉู ุงุณุชุฑุงุชฺ ุฑุงุฌ **locking ุจุฑุง ุงูู ูุฎโูุง**ุ ููฺฏุงู ฺฉุงุฑ ููโุฒูุงู ฺูุฏ ูุฎ ุฑู ุฏุงุฏูโูุง ูุดุชุฑฺฉุ ุจุงุนุซ ุงุฌุงุฏ ุฑูุงุจุช (contention) ุฒุงุฏ ูโุดูุฏ.

ฺฉุชุงุจุฎุงููโูุง **PFX** ุฏููุงู ุจุฑุง ุญู ุงู ุณูุงุฑููุง ุทุฑุงุญ ุดุฏูโุงูุฏ.

---

## ููุงูู PFX ๐งฉ

ุจุฑูุงููโููุณ ุจุฑุง ุจูุฑูโุจุฑุฏุงุฑ ุงุฒ ฺูุฏโูุณุชู ุง ฺูุฏ ูพุฑุฏุงุฒูุฏูุ **parallel programming** ูุงู ุฏุงุฑุฏ. ุงู ููุถูุน ฺฉ ุฒุฑูุฌููุนู ุงุฒ ููููู ฺฏุณุชุฑุฏูโุชุฑ **multithreading** ุงุณุช.

ุฏู ุงุณุชุฑุงุชฺ ุงุตู ุจุฑุง ุชูุณู ฺฉุงุฑ ุจู ูุฎโูุง ูุฌูุฏ ุฏุงุฑุฏ:

* **Data Parallelism (ููุงุฒโุณุงุฒ ุฏุงุฏูโูุง)**
* **Task Parallelism (ููุงุฒโุณุงุฒ ูุธุงู)**

๐น ุฏุฑ **data parallelism**ุ ููุช ูุฌููุนูโุง ุงุฒ ูุธุงู ุจุงุฏ ุฑู ุฏุงุฏูโูุง ุฒุงุฏ ุงุฌุฑุง ุดููุฏุ ูุฑ ูุฎ ููุงู ูุฌููุนู ูุธุงู ุฑุง ุฑู ุจุฎุด ุงุฒ ุฏุงุฏูโูุง ุงุฌุฑุง ูโฺฉูุฏ. ุฏุฑ ูุงูุน ุฏุงุฏูโูุง ุจู ูุฎโูุง ุชูุณู ูโุดููุฏ.

๐น ุฏุฑ **task parallelism**ุ ูุง ูุธุงู ุฑุง ุชูุณู ูโฺฉููุ ุจู ุงู ูุนูุง ฺฉู ูุฑ ูุฎ ูุธููโุง ูุชูุงูุช ุฑุง ุงุฌุฑุง ูโฺฉูุฏ.

ุจูโุทูุฑ ฺฉูุ **data parallelism** ุณุงุฏูโุชุฑ ุงุณุช ู ุฑู ุณุฎุชโุงูุฒุงุฑูุง ุจุง ูุงุจูุช ููุงุฒโุณุงุฒ ุจุงูุง ุจูุชุฑ ููุงุณโูพุฐุฑ ุงุณุชุ ุฒุฑุง ุฏุงุฏูโูุง ูุดุชุฑฺฉ ุฑุง ฺฉุงูุด ูโุฏูุฏ ุง ุญุฐู ูโฺฉูุฏ (ุฏุฑ ูุชุฌู ูุดฺฉูุงุช ุฑูุงุจุช ู ุงูู ูุฎโูุง ูุฒ ฺฉูุชุฑ ูโุดูุฏ). ุนูุงููโุจุฑ ุงูุ ูุนูููุงู ุฏุงุฏูโูุง ุจุด ุงุฒ ูุธุงู ุฌุฏุงฺฏุงูู ูุณุชูุฏุ ู ุงู ุงูุฑ ูพุชุงูุณู ููุงุฒโุณุงุฒ ุฑุง ุงูุฒุงุด ูโุฏูุฏ.

**Data parallelism** ููฺูู ุฒูููโุณุงุฒ **structured parallelism** ุงุณุชุ ุจู ุงู ูุนูุง ฺฉู ฺฉุงุฑูุง ููุงุฒ ุฏุฑ ฺฉ ููุทู ุงุฒ ุจุฑูุงูู ุดุฑูุน ู ุฏุฑ ููุงูโุฌุง ูุฒ ูพุงุงู ูโุงุจูุฏ. ุฏุฑ ููุงุจูุ **task parallelism** ูุนูููุงู **unstructured** ุงุณุชุ ุนู ฺฉุงุฑูุง ููุงุฒ ููฺฉู ุงุณุช ุฏุฑ ุจุฎุดโูุง ูพุฑุงฺฉูุฏูโุง ุงุฒ ุจุฑูุงูู ุดุฑูุน ู ูพุงุงู ุงุจูุฏ.

๐ **Structured parallelism** ุณุงุฏูโุชุฑุ ฺฉูโุฎุทุงุชุฑุ ู ุงูฺฉุงู ูุงฺฏุฐุงุฑ ฺฉุงุฑูุง ุฏุดูุงุฑ ูุงููุฏ ุชูุณูโุจูุฏุ ููุงููฺฏ ูุฎโูุง ู ุญุช ุฌูุนโุขูุฑ ูุชุงุฌ ุฑุง ุจู ฺฉุชุงุจุฎุงููโูุง ูุฑุงูู ูโฺฉูุฏ.

---

## ุงุฌุฒุง PFX ๐๏ธ

ฺฉุชุงุจุฎุงููโ **PFX** ุงุฒ ุฏู ูุงูโ ุงุตู ุชุดฺฉู ุดุฏู ุงุณุช (ูุทุงุจู ุดฺฉู 22-1):

* **ูุงู ุจุงูุงุชุฑ** โ ุดุงูู ุฏู API ุจุฑุง data parallelism ุณุงุฎุชุงุฑุงูุชู:

  * **PLINQ**
  * **ฺฉูุงุณ Parallel**

* **ูุงู ูพุงูโุชุฑ** โ ุดุงูู ฺฉูุงุณโูุง task parallelism ุจูโุนูุงูู ูุฌููุนูโุง ุงุฒ ุณุงุฎุชุงุฑูุง ฺฉูฺฉ ุจุฑุง ูุนุงูุชโูุง ุจุฑูุงููโููุณ ููุงุฒ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-1.jpeg)
</div>

### PLINQ โจ

**PLINQ** ุบูโุชุฑู ูุงุจูุชโูุง ุฑุง ุงุฑุงุฆู ูโุฏูุฏ: ุงู ุงุจุฒุงุฑ ุชูุงู ูุฑุงุญู ููุงุฒโุณุงุฒ ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุฏูุฏโุงุฒ ุฌููู:

* ุชูุณู ฺฉุงุฑ ุจู ูุธุงู (tasks)
* ุงุฌุฑุง ุงู ูุธุงู ุฑู ูุฎโูุง (threads)
* ุฌูุนโุขูุฑ ูุชุงุฌ ุฏุฑ ฺฉ ุชูุงู ุฎุฑูุฌ ูุงุญุฏ

ุจู ููู ุฏูู ุขู ุฑุง **Declarative** ูโูุงููุฏโฺูู ุดูุง ููุท ุงุนูุงู ูโฺฉูุฏ ฺฉู ูโุฎูุงูุฏ ฺฉุงุฑุชุงู ููุงุฒโุณุงุฒ ุดูุฏ (ุจูโุตูุฑุช ฺฉ ูพุฑุณโูโุฌู LINQ ุณุงุฎุชุงุฑุจูุฏโุดุฏู) ู ุฎูุฏู **runtime** ุฌุฒุฆุงุช ูพุงุฏูโุณุงุฒ ุฑุง ูุฏุฑุช ูโฺฉูุฏ.

ุฏุฑ ููุงุจูุ ุฑูฺฉุฑุฏูุง ุฏฺฏุฑ **Imperative** ูุณุชูุฏุ ุนู ุดูุง ุจุงุฏ ุจูโุทูุฑ ุตุฑุญ ฺฉุฏ ุจููุณุฏ ุชุง ฺฉุงุฑ ุฑุง ุชูุณู ุง ูุชุงุฌ ุฑุง ุฌูุนโุขูุฑ ฺฉูุฏ.

ููุงูโุทูุฑ ฺฉู ุฎูุงุตูโ ุฒุฑ ูุดุงู ูโุฏูุฏ:

* ุฏุฑ ููุฑุฏ **ฺฉูุงุณ Parallel** โ ุดูุง ุจุงุฏ ูุชุงุฌ ุฑุง ุฎูุฏุชุงู ุฌูุนโุขูุฑ ฺฉูุฏ.
* ุฏุฑ ููุฑุฏ **ุณุงุฎุชุงุฑูุง task parallelism** โ ุดูุง ุจุงุฏ ุนูุงูู ุจุฑ ุฌูุนโุขูุฑ ูุชุงุฌุ ุชูุณู ฺฉุงุฑ ุฑุง ูุฒ ุฎูุฏุชุงู ุงูุฌุงู ุฏูุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-2.jpeg)
</div>

### ูุฌููุนูโูุง Concurrent ู Spinning Primitives โ๏ธ

**ูุฌููุนูโูุง concurrent** ู **spinning primitives** ุจู ุดูุง ุฏุฑ ูุนุงูุชโูุง ุณุทุญ ูพุงูโุชุฑ ุจุฑูุงููโููุณ ููุงุฒ ฺฉูฺฉ ูโฺฉููุฏ. ุงููุช ุงู ุงุจุฒุงุฑูุง ุงุฒ ุขูุฌุงุณุช ฺฉู **PFX** ููโุชููุง ุจุฑุง ุณุฎุชโุงูุฒุงุฑ ุงูุฑูุฒ ุจูฺฉู ุจุฑุง ูุณูโูุง ุขูุฏูโ ูพุฑุฏุงุฒูุฏูโูุง ุจุง ุชุนุฏุงุฏ ูุณุชูโูุง ุจุณุงุฑ ุจุดุชุฑ ุทุฑุงุญ ุดุฏู ุงุณุช.

ูุฑุถ ฺฉูุฏ ุจุงุฏ ฺฉ ุชูุฏู ฺูุจ ุฎุฑุฏุดุฏู ุฑุง ุฌุงุจูโุฌุง ฺฉูุฏ ู ณฒ ฺฉุงุฑฺฏุฑ ุฏุฑ ุงุฎุชุงุฑ ุฏุงุฑุฏุ ุจุฒุฑฺฏโุชุฑู ฺุงูุด ุงู ุงุณุช ฺฉู ฺฉุงุฑฺฏุฑุงู ุจุฏูู ูุฒุงุญูุช ุจุฑุง ฺฉุฏฺฏุฑ ุจุชูุงููุฏ ฺฉุงุฑ ฺฉููุฏ. ุฏููุง ููู ููุถูุน ุฏุฑ ุชูุณู ฺฉ ุงูฺฏูุฑุชู ุจู ณฒ ูุณุชู ุฑุฎ ูโุฏูุฏ: ุงฺฏุฑ ุงุฒ **lockูุง ูุนููู** ุจุฑุง ูุญุงูุธุช ุงุฒ ููุงุจุน ูุดุชุฑฺฉ ุงุณุชูุงุฏู ุดูุฏุ ููู ุดุฏูโูุง (blocking) ุจุงุนุซ ูโุดููุฏ ุชููุง ุจุฎุด ุงุฒ ูุณุชูโูุง ูุงูุนุงู ูุนุงู ุจุงุดูุฏ.

๐ ูุฌููุนูโูุง concurrent ุจูโุทูุฑ ุฎุงุต ุจุฑุง ุฏุณุชุฑุณโูุง ุจุณุงุฑ ููโุฒูุงู ุชูุธู ุดุฏูโุงูุฏุ ุจุง ุชูุฑฺฉุฒ ุจุฑ **ุญุฏุงููโุณุงุฒ ุง ุญุฐู ููู ุดุฏู**.
ฺฉูุงุณ **Parallel** ู ููฺูู **PLINQ** ุฎูุฏุดุงู ุจุฑุง ูุฏุฑุช ฺฉุงุฑ ุจูโุตูุฑุช ฺฉุงุฑุขูุฏุ ูุชฺฉ ุจุฑ ููู ูุฌููุนูโูุง ู **spinning primitives** ูุณุชูุฏ.

---

## ฺฉุงุฑุจุฑุฏูุง ุฏฺฏุฑ PFX ๐๏ธ

ุณุงุฎุชุงุฑูุง ุจุฑูุงููโููุณ ููุงุฒ ุชููุง ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ฺูุฏโูุณุชู ูุณุชูุฏุ ุจูฺฉู ุฏุฑ ุณูุงุฑููุง ุฏฺฏุฑ ูู ููุฏ ูุงูุน ูโุดููุฏ:

* ููุช ุจู ฺฉ **queue**ุ **stack** ุง **dictionary** ุงูู ุงุฒ ูุธุฑ ูุฎโูุง (thread-safe) ูุงุฒ ุฏุงุฑุฏ.
* **BlockingCollection** ุฑุงู ุณุงุฏู ุจุฑุง ูพุงุฏูโุณุงุฒ ุณุงุฎุชุงุฑูุง ุชููุฏฺฉููุฏู/ูุตุฑูโฺฉููุฏู ูุฑุงูู ูโฺฉูุฏ ู ููฺูู ุฑูุด ููุงุณุจ ุจุฑุง ูุญุฏูุฏุณุงุฒ ููโุฒูุงู ุงุณุช.
* **Tasks** ูพุงูโ ุงุตู ุจุฑูุงููโููุณ ูุงููฺฏุงู ูุณุชูุฏ (ููุงูโุทูุฑ ฺฉู ุฏุฑ ูุตู ฑด ุฏุฏู).

---

## ฺู ุฒูุงู ุจุงุฏ ุงุฒ PFX ุงุณุชูุงุฏู ฺฉุฑุฏุ โฑ๏ธ

ููุฑุฏ ุงุตู ุงุณุชูุงุฏู ุงุฒ **PFX**ุ **ุจุฑูุงููโููุณ ููุงุฒ** ุงุณุช: ุนู ุจูุฑูโุจุฑุฏุงุฑ ุงุฒ ฺูุฏโูุณุชู ุจุฑุง ุณุฑุนุชโุจุฎุดุฏู ุจู ฺฉุฏูุง ูุญุงุณุจุงุช ุณูฺฏู.

ฺฉ ุงุฒ ฺุงูุดโูุง ููู ุฏุฑ ุจุฑูุงููโููุณ ููุงุฒุ **ูุงููู Amdahl** ุงุณุช. ุงู ูุงููู ูโฺฏูุฏ ุจุดุชุฑู ุจูุจูุฏ ฺฉุงุฑุง ุงุฒ ููุงุฒโุณุงุฒุ ุชูุณุท ุจุฎุด ุงุฒ ฺฉุฏ ฺฉู ุจุงุฏ ุจูโุตูุฑุช ุชุฑุชุจ (sequential) ุงุฌุฑุง ุดูุฏ ูุญุฏูุฏ ูโฺฏุฑุฏุฏ.

๐ ูุซุงู: ุงฺฏุฑ ุชููุง ุฏูุณูู ุฒูุงู ุงุฌุฑุง ฺฉ ุงูฺฏูุฑุชู ูุงุจู ููุงุฒโุณุงุฒ ุจุงุดุฏุ ุญุช ุจุง ุจโููุงุช ูุณุชู ููโุชูุงูุฏ ุจุด ุงุฒ ุณู ุจุฑุงุจุฑ ุงูุฒุงุด ฺฉุงุฑุง ุฏุงุดุชู ุจุงุดุฏ.

ุจูุงุจุฑุงูุ ูพุด ุงุฒ ุงุฏุงูู ุจุงุฏ ูุทูุฆู ุดูุฏ ฺฉู ฺฏููฺฏุงู ูุงูุนุงู ุฏุฑ ุจุฎุด ุงุฒ ฺฉุฏ ุงุณุช ฺฉู ูุงุจูุช ููุงุฒโุณุงุฒ ุฏุงุฑุฏ. ููฺูู ุจุงุฏ ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง ุงุตูุงู ฺฉุฏ ุดูุง ูุงุฒ ุจู ูุญุงุณุจุงุช ุณูฺฏู ุฏุงุฑุฏ ุง ุฎุฑโุฒุฑุง **ุจูููโุณุงุฒ** ุงุบูุจ ุณุงุฏูโุชุฑู ู ูุคุซุฑุชุฑู ุฑุงูฺฉุงุฑ ุงุณุช.
ุงูุจุชู ุงู ููุถูุน ฺฉ ูุนุงููู ุฏุงุฑุฏุ ฺูู ุจุฑุฎ ุฑูุดโูุง ุจูููโุณุงุฒ ูโุชูุงููุฏ ููุงุฒโุณุงุฒ ฺฉุฏ ุฑุง ุณุฎุชโุชุฑ ฺฉููุฏ.

ุจุดุชุฑู ุณูุฏ ุฏุฑ ููุงุฑุฏ ุจูโุฏุณุช ูโุขุฏ ฺฉู ุจู ุขูโูุง **embarrassingly parallel problems** ูโฺฏููุฏโุนู ุฒูุงู ฺฉู ฺฉ ฺฉุงุฑ ุจูโุฑุงุญุช ูโุชูุงูุฏ ุจู ูุธุงู ุฌุฏุงฺฏุงูู ุชูุณู ุดูุฏ ู ูุฑฺฉุฏุงู ุจูโุทูุฑ ูุณุชูู ู ฺฉุงุฑุขูุฏ ุงุฌุฑุง ุดููุฏ.

๐ท ูููููโูุง:

* ุจุณุงุฑ ุงุฒ ูุธุงู ูพุฑุฏุงุฒุด ุชุตูุฑ
* ray tracing
* ุฑูุดโูุง brute-force ุฏุฑ ุฑุงุถุงุช ุง ุฑูุฒูฺฏุงุฑ

ูููููโ ฺฉ **ูุดฺฉู ุบุฑ embarrassingly parallel**ุ ูพุงุฏูโุณุงุฒ ฺฉ ูุณุฎูโ ุจููู ุงุฒ ุงูฺฏูุฑุชู **quicksort** ุงุณุชโฺฉู ุจุฑุง ุฑุณุฏู ุจู ูุชุฌู ุฎูุจ ูุงุฒููุฏ ูฺฉุฑ ุจุดุชุฑ ุงุณุช ู ุดุงุฏ ุจู **unstructured parallelism** ูุงุฒ ุฏุงุดุชู ุจุงุดุฏ.

---

## PLINQ โก

**PLINQ** ูพุฑุณโูโุฌููุง LINQ ูุญู ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ููุงุฒโุณุงุฒ ูโฺฉูุฏ.
ูุฒุช ุจุฒุฑฺฏ ุขู ุงู ุงุณุช ฺฉู ุจุงุฑ ุชูุณู ฺฉุงุฑ ู ุฌูุนโุขูุฑ ูุชุงุฌ ุฑุง ุจูโุทูุฑ ฺฉุงูู ุจู **.NET** ูุงฺฏุฐุงุฑ ูโฺฉูุฏ.

ุจุฑุง ุงุณุชูุงุฏู ุงุฒ PLINQุ ฺฉุงูุณุช ุฑู ุชูุงู ูุฑูุฏุ ูุชุฏ **AsParallel()** ุฑุง ูุฑุงุฎูุงู ฺฉุฑุฏู ู ุณูพุณ ูพุฑุณโูุฌู LINQ ุฑุง ูุซู ููุดู ุงุฏุงูู ุฏูุฏ.

ูููููโ ุฒุฑ ุนุฏุฏูุง ุงูู ุจู ณ ุชุง ฑฐฐ,ฐฐฐ ุฑุง ุจุง ุงุณุชูุงุฏู ฺฉุงูู ุงุฒ ุชูุงู ูุณุชูโูุง ูุงุดู ูุญุงุณุจู ูโฺฉูุฏ:

```csharp
// ูุญุงุณุจู ุงุนุฏุงุฏ ุงูู ุจุง ฺฉ ุงูฺฏูุฑุชู ุณุงุฏู (ุบุฑุจููู).
IEnumerable<int> numbers = Enumerable.Range (3, 100000 - 3);

var parallelQuery =
    from n in numbers.AsParallel()
    where Enumerable.Range (2, (int) Math.Sqrt(n)).All (i => n % i > 0)
    select n;

int[] primes = parallelQuery.ToArray();
```

๐ ูุชุฏ **AsParallel** ฺฉ **extension method** ุฏุฑ **System.Linq.ParallelEnumerable** ุงุณุช. ุงู ูุชุฏ ูุฑูุฏ ุฑุง ุฏุฑ ฺฉ ุชูุงู ุจุฑ ูพุงูโ **ParallelQuery<TSource>** ูโูพฺุฏ. ููู ููุถูุน ุจุงุนุซ ูโุดูุฏ ุนููฺฏุฑูุง ูพุฑุณโูุฌู LINQ ฺฉู ุฏุฑ ุงุฏุงูู ูุฑุงุฎูุงู ูโฺฉูุฏุ ุจู ูุฌููุนูโุง ุฌุงฺฏุฒู ุงุฒ ูุชุฏูุง ุชูุณุนูโุงูุชู ุฏุฑ **ParallelEnumerable** ูุชุตู ุดููุฏ.

ุงู ูุชุฏูุง ูพุงุฏูโุณุงุฒโูุง ููุงุฒ ุงุฒ ูุฑ ฺฉ ุงุฒ ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ ูพุฑุณโูุฌู ุฑุง ูุฑุงูู ูโฺฉููุฏ. ุงุณุงุณ ฺฉุงุฑ ุขูโูุง ุงู ุงุณุช ฺฉู ุชูุงู ูุฑูุฏ ุฑุง ุจู ุจุฎุดโูุง ุชูุณู ูโฺฉููุฏ ุชุง ุฑู ูุฎโูุง ูุฎุชูู ุงุฌุฑุง ุดููุฏ ู ุณูพุณ ูุชุงุฌ ุฑุง ุฏูุจุงุฑู ุฏุฑ ฺฉ ุชูุงู ุฎุฑูุฌ ูุงุญุฏ ฺฏุฑุฏุขูุฑ ฺฉููุฏ (ูุทุงุจู ุดฺฉู 22-2).

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-3.jpeg)
</div>

### ุงุณุชูุงุฏู ุงุฒ AsSequential() ๐

ูุฑุงุฎูุงู **AsSequential()** ุจุงุนุซ ูโุดูุฏ ฺฉู ฺฉ ุชูุงู **ParallelQuery** ุจุงุฒ (unwrap) ุดูุฏุ ุจูโุทูุฑโฺฉู ุนููฺฏุฑูุง ูพุฑุณโูโุฌู (query operators) ุจุนุฏ ุจู ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ LINQ ูุชุตู ุดุฏู ู ุจูโุตูุฑุช ุชุฑุชุจ (sequential) ุงุฌุฑุง ุดููุฏ.

ุงู ููุถูุน ุฒูุงู ุถุฑูุฑ ุงุณุช ฺฉู:

* ุจุฎูุงูุฏ ูุชุฏ ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ฺฉู ุฏุงุฑุง **ุงุซุฑ ุฌุงูุจ (side effect)** ุจุงุดุฏ.
* ุง ูุชุฏ ููุฑุฏ ูุธุฑ **thread-safe** ูุจุงุดุฏ.

ุจุฑุง ุนููฺฏุฑูุง ูพุฑุณโูโุฌู ฺฉู **ุฏู ุชูุงู ูุฑูุฏ** ุฏุฑุงูุช ูโฺฉููุฏ (ูุซู **Join, GroupJoin, Concat, Union, Intersect, Except ู Zip**) ุจุงุฏ ุฑู ูุฑ ุฏู ุชูุงู ูุฑูุฏุ ูุชุฏ **AsParallel()** ุงุนูุงู ุดูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุฎุทุง (exception) ูพุฑุชุงุจ ุฎูุงูุฏ ุดุฏ.

ูฺฉุชู: ูุงุฒ ูุณุช ุฏุฑ ุทูู ูพุดุฑูุช ฺฉ ูพุฑุณโูโุฌู ูุฏุงู **AsParallel()** ุฑุง ุงุนูุงู ฺฉูุฏุ ุฒุฑุง ุนููฺฏุฑูุง ูพุฑุณโูโุฌู PLINQ ุฎูุฏุดุงู ฺฉ **ParallelQuery** ุฏฺฏุฑ ุจุฑูโฺฏุฑุฏุงููุฏ. ุฏุฑ ูุงูุนุ ูุฑุงุฎูุงู ุฏูุจุงุฑูโ AsParallel ูุงฺฉุงุฑุขูุฏ ุงุณุชุ ฺูู ุจุงุนุซ ุงุฏุบุงู (merge) ู ุชูุณูโุจูุฏ ูุฌุฏุฏ ูพุฑุณโูโุฌู ูโุดูุฏ:

```csharp
mySequence.AsParallel()           // ุชูุงู ุฑุง ุจู ParallelQuery<int> ูโูพฺุฏ
          .Where (n => n > 100)   // ฺฉ ParallelQuery<int> ุฏฺฏุฑ ุชููุฏ ูโฺฉูุฏ
          .AsParallel()           // ุบุฑุถุฑูุฑ ู ูุงฺฉุงุฑุขูุฏ!
          .Select (n => n * n);
```

---

### ูุญุฏูุฏุชโูุง ู ูฺฉุงุช PLINQ โ๏ธ

* ูููโ ุนููฺฏุฑูุง ูพุฑุณโูโุฌู ุจูโุทูุฑ ูุคุซุฑ ูุงุจู ููุงุฒโุณุงุฒ ูุณุชูุฏ. ุจุฑุง ุงู ููุงุฑุฏ (ุจุฎุด โPLINQ Limitationsโ ุฏุฑ ุตูุญู นณธ)ุ **PLINQ** ุนููฺฏุฑ ุฑุง ุจูโุตูุฑุช ุชุฑุชุจ ุงุฌุฑุง ูโฺฉูุฏ.
* ุงฺฏุฑ PLINQ ุชุดุฎุต ุฏูุฏ ุณุฑุจุงุฑ ููุงุฒโุณุงุฒ ุจุดุชุฑ ุงุฒ ุณูุฏ ุขู ุงุณุชุ ูพุฑุณโูโุฌู ุฑุง ุจูโุตูุฑุช ุชุฑุชุจ ุงุฌุฑุง ุฎูุงูุฏ ฺฉุฑุฏ.
* **PLINQ ููุท ุฑู ูุฌููุนูโูุง ูุญู ฺฉุงุฑ ูโฺฉูุฏ**ุ ูุซูุงู ุจุง **Entity Framework** ุณุงุฒฺฏุงุฑ ูุณุชุ ฺูู ุฏุฑ ุขู ุญุงูุช LINQ ุจู SQL ุชุฑุฌูู ูโุดูุฏ ู ุฑู ุณุฑูุฑ ูพุงฺฏุงู ุฏุงุฏู ุงุฌุฑุง ุฎูุงูุฏ ุดุฏ. ุจุง ุงู ุญุงู ูโุชูุงูุฏ PLINQ ุฑุง ุจุฑุง ูพุฑุณโูโุฌููุง ูุญู ุฑู ูุชุงุฌ ุญุงุตู ุงุฒ ุฏุชุงุจุณ ุจูโฺฉุงุฑ ุจุจุฑุฏ.
* ุงฺฏุฑ ฺฉ ูพุฑุณโูโุฌู PLINQ ุงุณุชุซูุง ูพุฑุชุงุจ ฺฉูุฏุ ุงู ุฎุทุง ุจูโุดฺฉู **AggregateException** ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดูุฏุ ฺฉู ุฎุงุตุช **InnerExceptions** ุขู ุฎุทุง ุง ุฎุทุงูุง ูุงูุน ุฑุง ุฏุฑ ุฎูุฏ ูฺฏู ูโุฏุงุฑุฏ (ุจุฑุง ุฌุฒุฆุงุชุ ุจู โWorking with AggregateExceptionโ ุฏุฑ ุตูุญู นถด ูุฑุงุฌุนู ฺฉูุฏ).

---

### ฺุฑุง AsParallel ุจูโุตูุฑุช ูพุดโูุฑุถ ูุนุงู ูุณุชุ ๐ค

ุจุง ุชูุฌู ุจู ุงูฺฉู **AsParallel** ูพุฑุณโูโุฌููุง LINQ ุฑุง ุจูโุทูุฑ ุดูุงู ููุงุฒโุณุงุฒ ูโฺฉูุฏุ ุงู ูพุฑุณุด ูพุด ูโุขุฏ: ฺุฑุง ูุงฺฉุฑูุณุงูุช ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ LINQ ุฑุง ุจูโุทูุฑ ูพุดโูุฑุถ ููุงุฒ ูฺฉุฑุฏ ู PLINQ ุฑุง ุจู ุญุงูุช ูพุดโูุฑุถ ุชุจุฏู ูฺฉุฑุฏุ

ุฏูุงู ุงู ุฑูฺฉุฑุฏ opt-in ุนุจุงุฑุชูุฏ ุงุฒ:

1. ุจุฑุง ุงูฺฉู PLINQ ููุฏ ุจุงุดุฏุ ุจุงุฏ ุญุฌู ูุงุจูโุชูุฌู ุงุฒ ฺฉุงุฑ ูุญุงุณุจุงุช ุณูฺฏู ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.
   ุงฺฉุซุฑ ูพุฑุณโูโุฌููุง LINQ-to-Objects ุฎู ุณุฑุน ุงุฌุฑุง ูโุดููุฏุ ุฏุฑ ุงู ุญุงูุช ููโุชููุง ููุงุฒโุณุงุฒ ุบุฑุถุฑูุฑ ุงุณุชุ ุจูฺฉู ุณุฑุจุงุฑ ุชูุณูโุจูุฏุ ุฌูุนโุขูุฑ ู ููุงููฺฏ ูุฎโูุง ุงุถุงู ูโุชูุงูุฏ ุงุฌุฑุง ฺฉุฏ ุฑุง ฺฉูุฏุชุฑ ฺฉูุฏ.

2. ุชูุงูุชโูุง ุฑูุชุงุฑ:

   * ุฎุฑูุฌ ฺฉ ูพุฑุณโูโุฌู PLINQ (ุจูโุทูุฑ ูพุดโูุฑุถ) ูโุชูุงูุฏ ุงุฒ ูุธุฑ **ุชุฑุชุจ ุนูุงุตุฑ** ุจุง LINQ ุนุงุฏ ูุชูุงูุช ุจุงุดุฏ (ุจุฎุด โPLINQ and Orderingโ ุฏุฑ ุตูุญู นณท).
   * PLINQ ุงุณุชุซูุงูุง ุฑุง ุฏุฑูู ฺฉ **AggregateException** ูโูพฺุฏ (ฺูู ููฺฉู ุงุณุช ฺูุฏ ุงุณุชุซูุง ุจูโุทูุฑ ููโุฒูุงู ุฑุฎ ุฏููุฏ).
   * ุงฺฏุฑ ูพุฑุณโูโุฌู ูุชุฏูุง ุบุฑ thread-safe ุฑุง ูุฑุงุฎูุงู ฺฉูุฏุ ูุชุงุฌ PLINQ ูุงุจูโุงุนุชูุงุฏ ูุฎูุงููุฏ ุจูุฏ.

3. PLINQ ูุงุจูุชโูุง ูุชุนุฏุฏ ุจุฑุง **ุชูุธู ู ุจูููโุณุงุฒ** ุฏุงุฑุฏ. ุงูุฒูุฏู ุงู ูพฺุฏฺฏโูุง ุจู API ุงุณุชุงูุฏุงุฑุฏ LINQ-to-Objects ุจุงุนุซ ุดููุบ ู ุญูุงุณโูพุฑุช ูโุดุฏ.

---

### ุฑูุชุงุฑ ุงุฌุฑุง ููุงุฒ (Parallel Execution Ballistics) ๐ฏ

ูุงููุฏ ูพุฑุณโูโุฌููุง ุนุงุฏ LINQุ ูพุฑุณโูโุฌููุง **PLINQ** ูุฒ **lazy evaluation** ุฏุงุฑูุฏ. ุนู ุงุฌุฑุง ููุท ุฒูุงู ุขุบุงุฒ ูโุดูุฏ ฺฉู ุดุฑูุน ุจู ูุตุฑู ูุชุงุฌ ฺฉูุฏโูุนูููุงู ุจุง ฺฉ ุญูููโ **foreach** (ุง ุจุง ฺฉ ุนููฺฏุฑ ุชุจุฏู ูุซู **ToArray** ุง ุนููฺฏุฑ ฺฉู ฺฉ ุนูุตุฑ/ููุฏุงุฑ ูููุฑุฏ ุจุฑูโฺฏุฑุฏุงูุฏ).

ุงูุง ููฺฏุงู ุดูุงุฑุด ูุชุงุฌุ ูุญููโ ุงุฌุฑุง ุจุง ูพุฑุณโูโุฌููุง ุชุฑุชุจ ูุนููู ูุชูุงูุช ุงุณุช:

* ุฏุฑ ูพุฑุณโูโุฌู ุชุฑุชุจุ ูููโฺุฒ ฺฉุงููุงู ุชูุณุท ูุตุฑูโฺฉููุฏู ู ุจูโุตูุฑุช **pull** ุงูุฌุงู ูโุดูุฏุ ุนู ูุฑ ุนูุตุฑ ุฏููุงู ุฒูุงู ูุงฺฉุด ูโุดูุฏ ฺฉู ูุตุฑูโฺฉููุฏู ุจู ุขู ูุงุฒ ุฏุงุฑุฏ.
* ุฏุฑ ูพุฑุณโูโุฌู ููุงุฒุ ูุฎโูุง ูุณุชูู ุนูุงุตุฑ ูุฑูุฏ ุฑุง ฺฉู ุฒูุฏุชุฑ ุงุฒ ุฒูุงู ูุงุฒ ูุตุฑูโฺฉููุฏู ูุงฺฉุด ูโฺฉููุฏ (ูุซู ุชููโูพุฑููุชุฑ ุจุฑุง ูุฌุฑุงู ุงุฎุจุงุฑ ๐บ). ุณูพุณ ุงู ุนูุงุตุฑ ุฏุฑ ุทูู ุฒูุฌุฑูโ ูพุฑุณโูโุฌู ุจูโุตูุฑุช ููุงุฒ ูพุฑุฏุงุฒุด ูโุดููุฏ. ูุชุงุฌ ุฏุฑ ฺฉ ุจุงูุฑ ฺฉูฺฺฉ ูฺฏูโุฏุงุฑ ูโุดููุฏ ุชุง ุฏุฑ ูุญุธู ุจุฑุง ูุตุฑูโฺฉููุฏู ุขูุงุฏู ุจุงุดูุฏ.
* ุงฺฏุฑ ูุตุฑูโฺฉููุฏู ูฺฉุซ ฺฉูุฏ ุง ุฒูุฏุชุฑ ุงุฒ ุดูุงุฑุด ฺฉุงูู ุฎุงุฑุฌ ุดูุฏุ ูพุฑุฏุงุฒุดฺฏุฑ ูพุฑุณโูโุฌู ูู ูุชููู ุง ูฺฉุซ ูโฺฉูุฏ ุชุง ุงุฒ ูุฏุฑ ุฑูุชู CPU ู ุญุงูุธู ุฌููฺฏุฑ ุดูุฏ.

---

### ุชูุธู ุจุงูุฑ ุฏุฑ PLINQ ๐ฆ

ูโุชูุงูุฏ ุฑูุชุงุฑ ุจุงูุฑ PLINQ ุฑุง ุจุง ูุฑุงุฎูุงู **WithMergeOptions** ุจุนุฏ ุงุฒ **AsParallel** ุชุบุฑ ุฏูุฏ:

* **AutoBuffered (ูพุดโูุฑุถ)** โ ูุนูููุงู ุจูุชุฑู ฺฉุงุฑุง ฺฉู ุฑุง ูโุฏูุฏ.
* **NotBuffered** โ ุจุงูุฑ ุฑุง ุบุฑูุนุงู ูโฺฉูุฏ ู ุจุฑุง ููุงูุน ููุงุณุจ ุงุณุช ฺฉู ูโุฎูุงูุฏ ูุชุงุฌ ุฑุง ุณุฑุนโุชุฑ ู ุจูุงูุงุตูู ุจุจูุฏ.
* **FullyBuffered** โ ฺฉู ูุฌููุนู ูุชุงุฌ ุฑุง ูุจู ุงุฒ ุงุฑุงุฆู ุจู ูุตุฑูโฺฉููุฏู ุฐุฎุฑู ูโฺฉูุฏ (ุนููฺฏุฑูุง ูุงููุฏ **OrderBy** ู **Reverse** ู ููฺูู ุนููฺฏุฑูุง ูุฑุจูุท ุจู **element**ุ **aggregation** ู **conversion** ุฐุงุชุงู ูููโฺฏููู ุนูู ูโฺฉููุฏ).

### ๐ PLINQ ู ุชุฑุชุจ (Ordering)

ฺฉ ุงุฒ ุนูุงุฑุถ ุฌุงูุจ ููุงุฒโุณุงุฒ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุงู ุงุณุช ฺฉู ููฺฏุงู ุฌูุนโุขูุฑ ูุชุงุฌุ **ูุฒูู ูุฏุงุฑุฏ ุชุฑุชุจ ุนูุงุตุฑ ูุซู ุญุงูุช ุงููู ุจุงู ุจูุงูุฏ** (ุจู ุดฺฉู 22-2 ูุฑุงุฌุนู ฺฉูุฏ).
ุจู ุจุงู ุฏฺฏุฑุ ุชุถูู **ุญูุธ ุชุฑุชุจ** ุฏุฑ LINQ ุจุฑุง ุชูุงูโูุง ุฏุฑ PLINQ ุจุฑูุฑุงุฑ ูุณุช.

ุงฺฏุฑ ุจู **ุญูุธ ุชุฑุชุจ** ูุงุฒ ุฏุงุดุชู ุจุงุดุฏุ ูโุชูุงูุฏ ูพุณ ุงุฒ `AsParallel()` ุงุฒ `AsOrdered()` ุงุณุชูุงุฏู ฺฉูุฏ:

```csharp
myCollection.AsParallel().AsOrdered()...
```

ุงุณุชูุงุฏู ุงุฒ `AsOrdered` ููฺฏุงู ฺฉุงุฑ ุจุง ูุฌููุนูโูุง ุจุฒุฑฺฏ ุจุงุนุซ ฺฉุงูุด ฺฉุงุฑุง ูโุดูุฏุ ฺูู PLINQ ุจุงุฏ ูููุนุช ุงุตู ูุฑ ุนูุตุฑ ุฑุง ุฏูุจุงู ฺฉูุฏ.

ูโุชูุงูุฏ ุงุซุฑ `AsOrdered` ุฑุง ุฏุฑ ุงุฏุงููโ ูพุฑุณโูุฌู ุจุง ุงุณุชูุงุฏู ุงุฒ `AsUnordered` ุฎูุซ ฺฉูุฏ. ุงู ฺฉุงุฑ ฺฉ โููุทูโ ุชุตุงุฏู ุฏุฑ ุชุฑุชุจโ ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู ุจู ูพุฑุณโูุฌู ุงุฌุงุฒู ูโุฏูุฏ ุงุฒ ุขู ููุทู ุจู ุจุนุฏ ฺฉุงุฑุง ุจูุชุฑ ุฏุงุดุชู ุจุงุดุฏ.
ุจุฑุง ูุซุงูุ ุงฺฏุฑ ุจุฎูุงูุฏ ุชุฑุชุจ ูุฑูุฏ ููุท ุจุฑุง ุฏู ุนููฺฏุฑ ุงูู ุญูุธ ุดูุฏ:

```csharp
inputSequence.AsParallel().AsOrdered()
  .QueryOperator1()
  .QueryOperator2()
  .AsUnordered()
      // ุงุฒ ุงูุฌุง ุจู ุจุนุฏ ุชุฑุชุจ ุงููุช ูุฏุงุฑุฏ
  .QueryOperator3()
  ...
```

๐น ุฏูู ุงูฺฉู `AsOrdered` ูพุดโูุฑุถ ูุณุช ุงู ุงุณุช ฺฉู ุฏุฑ ุจุดุชุฑ ูพุฑุณโูุฌููุงุ ุชุฑุชุจ ุงููู ุงููุช ูุฏุงุฑุฏ. ุงฺฏุฑ ูุฑุงุฑ ุจูุฏ `AsOrdered` ูพุดโูุฑุถ ุจุงุดุฏุ ุจุฑุง ุงฺฉุซุฑ ูพุฑุณโูุฌููุง ููุงุฒ ุจุงุฏ `AsUnordered` ุงุถุงูู ูโฺฉุฑุฏุฏ ุชุง ุจูุชุฑู ฺฉุงุฑุง ุญุงุตู ุดูุฏุ ู ุงู ุจุงุนุซ ูพฺุฏฺฏ ู ุจุงุฑ ุงุถุงู ูโุดุฏ.

---

### โ๏ธ ูุญุฏูุฏุชโูุง PLINQ

ูููโ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุฑุง ููโุชูุงู ุจูโุทูุฑ ูุคุซุฑ ููุงุฒโุณุงุฒ ฺฉุฑุฏ. ููุงุฑุฏ ุฒุฑ ูุญุฏูุฏุช ุฏุงุฑูุฏ:

* ูุณุฎูโูุง ุงูุฏุณโุฏุงุฑ `Select`ุ `SelectMany` ู `ElementAt` ููุท ุฒูุงู ููุงุฒโุณุงุฒ ูโุดููุฏ ฺฉู ุนูุงุตุฑ ููุจุน ุฏุฑ ูููุนุช ุงูุฏุณ ุงุตู ุฎูุฏ ุจุงู ูุงูุฏู ุจุงุดูุฏ.

  > ุจุดุชุฑ ุนููฺฏุฑูุง ูููุนุช ุงูุฏุณ ุฑุง ุชุบุฑ ูโุฏููุฏ (ูุซู `Where` ฺฉู ุนูุงุตุฑ ุฑุง ุญุฐู ูโฺฉูุฏ). ุจูุงุจุฑุงู ุงฺฏุฑ ูโุฎูุงูุฏ ุงุฒ ุนููฺฏุฑูุง ุงูุฏุณโุฏุงุฑ ุงุณุชูุงุฏู ฺฉูุฏุ ูุนูููุงู ุจุงุฏ ุขููุง ุฏุฑ ุงุจุชุฏุง ูพุฑุณโูุฌู ุจุงุดูุฏ.

* ุนููฺฏุฑูุง ุฒุฑ ูุงุจู ููุงุฒโุณุงุฒ ูุณุชูุฏุ ุงูุง ุงุฒ ุงุณุชุฑุงุชฺ ุชูุณูโุจูุฏ ูพุฑูุฒููโุง ุงุณุชูุงุฏู ูโฺฉููุฏ ฺฉู ฺฏุงู ุญุช ุงุฒ ูพุฑุฏุงุฒุด ุชุฑุชุจ ฺฉูุฏุชุฑ ุงุณุช:
  `Join`, `GroupBy`, `GroupJoin`, `Distinct`, `Union`, `Intersect`, `Except`

* ูุณุฎูโูุง **Seeded** ุงุฒ ุนููฺฏุฑ `Aggregate` ุฏุฑ ุญุงูุช ุนุงุฏ ูุงุจู ููุงุฒโุณุงุฒ ูุณุชูุฏ. PLINQ ุจุฑุง ุงู ููุฑุฏ ูุณุฎูโูุง ุฎุงุต ุงุฑุงุฆู ูโุฏูุฏ (ุจุฎุด *Optimizing PLINQ* ุฏุฑ ุตูุญู 942).

* ูููโ ุนููฺฏุฑูุง ุฏฺฏุฑ ููุงุฒโุณุงุฒ ูโุดููุฏุ ุงูุง ุงู ุชุถูู ููโฺฉูุฏ ฺฉู ูพุฑุณโูุฌู ุดูุง **ุญุชูุงู** ููุงุฒ ุดูุฏ. ุงฺฏุฑ PLINQ ุชุดุฎุต ุฏูุฏ ุณุฑุจุงุฑ ููุงุฒโุณุงุฒ ูพุฑุณโูุฌู ุฑุง ฺฉูุฏ ูโฺฉูุฏุ ููฺฉู ุงุณุช ุขู ุฑุง ุชุฑุชุจ ุงุฌุฑุง ฺฉูุฏ.
  โ ูโุชูุงูุฏ ุจุง ุงู ฺฉุฏ ุฑูุชุงุฑ ุฑุง ูุฌุจูุฑ ุจู ููุงุฒโุณุงุฒ ฺฉูุฏ:

```csharp
.WithExecutionMode(ParallelExecutionMode.ForceParallelism)
```

---

### ๐ ูุซุงู: ุจุฑุฑุณ ุงููุง (Spellchecker) ููุงุฒ

ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ฺฉ **ุจุฑุฑุณโฺฉููุฏูโ ุงููุง ุณุฑุน** ุจุฑุง ุงุณูุงุฏ ุจุฒุฑฺฏ ุจููุณู ฺฉู ุงุฒ ุชูุงู ูุณุชูโูุง CPU ุงุณุชูุงุฏู ฺฉูุฏ. ุจุง ุชุจุฏู ุงูฺฏูุฑุชู ุจู ฺฉ ูพุฑุณโูุฌู LINQุ ูโุชูุงูู ุจูโุฑุงุญุช ุขู ุฑุง ููุงุฒ ฺฉูู.

๐น ูุฑุญููโ ุงูู: ุฏุงูููุฏ ฺฉ **ุฏฺฉุดูุฑ ุงุฒ ฺฉููุงุช ุงูฺฏูุณ** ู ุฐุฎุฑู ุฏุฑ `HashSet` ุจุฑุง ุฌุณุชโูุฌู ุณุฑุน:

```csharp
if (!File.Exists("WordLookup.txt"))    // ุญุฏูุฏ 150,000 ฺฉููู
    File.WriteAllText("WordLookup.txt",
        await new HttpClient().GetStringAsync(
            "http://www.albahari.com/ispell/allwords.txt"));

var wordLookup = new HashSet<string>(
    File.ReadAllLines("WordLookup.txt"),
    StringComparer.InvariantCultureIgnoreCase);
```

๐น ูุฑุญููโ ุฏูู: ุงุฌุงุฏ ฺฉ โุณูุฏ ุขุฒูุงุดโ ุดุงูู ฺฉ ูููู ฺฉูููโ ุชุตุงุฏูุ ุณูพุณ ุงุฌุงุฏ ฺูุฏ ุบูุท ุงููุง ุนูุฏ:

```csharp
var random = new Random();
string[] wordList = wordLookup.ToArray();

string[] wordsToTest = Enumerable.Range(0, 1000000)
    .Select(i => wordList[random.Next(0, wordList.Length)])
    .ToArray();

wordsToTest[12345] = "woozsh";   // ฺูุฏ ุบูุท ุงููุง
wordsToTest[23456] = "wubsie";
```

๐น ูุฑุญููโ ุณูู: ุงุฌุฑุง ุจุฑุฑุณ ููุงุฒ ุจุง PLINQ:

```csharp
var query = wordsToTest
    .AsParallel()
    .Select((word, index) => (word, index))
    .Where(iword => !wordLookup.Contains(iword.word))
    .OrderBy(iword => iword.index);

foreach (var mistake in query)
    Console.WriteLine(mistake.word + " - index = " + mistake.index);

// ุฎุฑูุฌ:
// woozsh - index = 12345
// wubsie - index = 23456
```

ูุชุฏ `wordLookup.Contains` ุฏุฑ predicate ุจู ูพุฑุณโูุฌู **ุญุฌู ูพุฑุฏุงุฒุด ููุงุณุจ** ูโุฏูุฏ ู ุงุฑุฒุด ููุงุฒโุณุงุฒ ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ.

---

### ๐ฆ ูฺฉุชู ุฏุฑุจุงุฑูโ ฺฉุงุฑุง ู ุญุงูุธู

ุฏุฑ ูพุฑุณโูุฌู ุงุฒ **Tuple**โูุง `(word, index)` ุจูโุฌุง **ููุน ูุงุดูุงุณ (anonymous types)** ุงุณุชูุงุฏู ุดุฏู ุงุณุช.
ฺูู Tupleูุง ุจูโุตูุฑุช **Value Type** ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏ (ูู Reference Type):

* ูุตุฑู ุญุงูุธู ุฏุฑ ุงูุฌ ฺฉุงูุด ูโุงุจุฏ โ
* ฺฉุงุฑุง ุจูุชุฑ ูโุดูุฏ โ
* ุชุฎุตุตโูุง heap ู ุฌูุนโุขูุฑ ุฒุจุงูู (Garbage Collection) ฺฉูุชุฑ ูโุดูุฏ โ

๐ ุงูุจุชู ุจูฺูุงุฑฺฉโูุง ูุดุงู ูโุฏููุฏ ุงู ูุฒุงุง ุฏุฑ ุนูู **ูุชูุณุท** ูุณุชูุฏุ ฺูู ูุฏุฑ ุญุงูุธู ุจุณุงุฑ ฺฉุงุฑุขูุฏ ุงุณุช ู ุงู ุชุฎุตุตโูุง ูุนูููุงู ุจุด ุงุฒ **Generation 0** ุฏูุงู ููโุขูุฑูุฏ.

### ๐งต ุงุณุชูุงุฏู ุงุฒ `ThreadLocal<T>`

ุจุงุฏ ูุซุงู ุฎูุฏูุงู ุฑุง ฺฏุณุชุฑุด ุฏูู ู **ุงุฌุงุฏ ูุณุช ุชุตุงุฏู ฺฉููุงุช ุขุฒูุงุด** ุฑุง ูุฒ ููุงุฒโุณุงุฒ ฺฉูู.
ูุง ุขู ุฑุง ุจูโุตูุฑุช ฺฉ ูพุฑุณโูุฌู LINQ ุณุงุฎุชุงุฑุจูุฏ ฺฉุฑุฏูุ ูพุณ ุจุงุฏ ุณุงุฏู ุจุงุดุฏ.

๐น ูุณุฎูโ ุชุฑุชุจ:

```csharp
string[] wordsToTest = Enumerable.Range(0, 1000000)
    .Select(i => wordList[random.Next(0, wordList.Length)])
    .ToArray();
```

ุงูุง ูุดฺฉู ุงูุฌุงุณุช ฺฉู ูุฑุงุฎูุงู `random.Next` **Thread-Safe** ูุณุชุ ุจูุงุจุฑุงู ุจูโุณุงุฏฺฏ ููโุชูุงูู `AsParallel()` ุฑุง ุฏุฑ ูพุฑุณโูุฌู ูุงุฑุฏ ฺฉูู.

ุฑุงูโุญู ุงุญุชูุงู ุงู ุงุณุช ฺฉู ูุชุฏ ุจููุณู ฺฉู ุฏูุฑ `random.Next` ููู ุจฺฏุฐุงุฑุฏุ ุงูุง ุงู ุจุงุนุซ ูุญุฏูุฏ ุดุฏู ููโุฒูุงู (Concurrency) ูโุดูุฏ.
โ ุฑุงูโุญู ุจูุชุฑ ุงู ุงุณุช ฺฉู ุงุฒ `ThreadLocal<Random>` (ุจุฎุด *Thread-Local Storage* ุตูุญู 923) ุงุณุชูุงุฏู ฺฉูู ุชุง ุจุฑุง ูุฑ ูุฎ ฺฉ ุดุก `Random` ุฌุฏุงฺฏุงูู ุณุงุฎุชู ุดูุฏ.

๐น ูุณุฎูโ ููุงุฒ:

```csharp
var localRandom = new ThreadLocal<Random>(
    () => new Random(Guid.NewGuid().GetHashCode()));

string[] wordsToTest = Enumerable.Range(0, 1000000).AsParallel()
    .Select(i => wordList[localRandom.Value.Next(0, wordList.Length)])
    .ToArray();
```

ุฏุฑ ุชุงุจุน ฺฉุงุฑุฎุงููโุง ฺฉู ุจุฑุง ุงุฌุงุฏ ฺฉ ุดุก `Random` ููุดุชูุ ุงุฒ ูุด (`HashCode`) ฺฉ `Guid` ุงุณุชูุงุฏู ฺฉุฑุฏู ุชุง ูุทูุฆู ุดูู ุงฺฏุฑ ุฏู ุดุก `Random` ุฏุฑ ฺฉ ุจุงุฒูโ ุฒูุงู ฺฉูุชุงู ุณุงุฎุชู ุดููุฏุ ุฏูุจุงููโ ุงุนุฏุงุฏ ุชุตุงุฏูโุดุงู ูุชูุงูุช ุฎูุงูุฏ ุจูุฏ. ๐ฒ

---

### ๐ค ฺู ุฒูุงู ุงุฒ PLINQ ุงุณุชูุงุฏู ฺฉููุ

ููฺฉู ุงุณุช ูุณูุณู ุดูุฏ ุฏุฑ ุจุฑูุงููโูุง ููุฌูุฏ ุฎูุฏ ุจูโุฏูุจุงู ูพุฑุณโูุฌููุง LINQ ุจฺฏุฑุฏุฏ ู ุขููุง ุฑุง ููุงุฒโุณุงุฒ ฺฉูุฏ.
ุงูุง ุงู ูุนูููุงู ุจโูุงุฏู ุงุณุชุ ฺูู ูุณุงุฆู ฺฉู LINQ ุจูุชุฑู ุฑุงูโุญู ุจุฑุงุดุงู ูุญุณูุจ ูโุดูุฏุ ุฎู ุณุฑุน ุงุฌุฑุง ูโุดููุฏ ู ููุงุฒโุณุงุฒ ฺฉูฺฉ ููโฺฉูุฏ.

โ ุฑูฺฉุฑุฏ ุจูุชุฑ:

* ูพุฏุง ฺฉุฑุฏู ฺฉ **ฺฏููฺฏุงู CPU-ูุญูุฑ**
* ุณูพุณ ุจุฑุฑุณ ุงูฺฉู ุขุง ูโุชูุงู ุขู ุฑุง ุจูโุตูุฑุช ฺฉ ูพุฑุณโูุฌู LINQ ุจุงู ฺฉุฑุฏ

๐น ฺฉ ุงุซุฑ ุฌุงูุจ ุฎูุดุงูุฏ ุงู ุจุงุฒููุณ ุงู ุงุณุช ฺฉู ฺฉุฏ **ฺฉูฺฺฉโุชุฑ ู ุฎูุงูุงุชุฑ** ูโุดูุฏ.

๐ PLINQ ุจุฑุง ูุณุงุฆู ฺฉู ุจูโุทูุฑ ูุงุถุญ **Embarrassingly Parallel** ูุณุชูุฏ ุนุงู ุงุณุช.
ุงูุง ุจุฑุง ูพุฑุฏุงุฒุด ุชุตูุฑ (Imaging) ุงูุชุฎุงุจ ุฎูุจ ูุณุชุ ฺูู ุฌูุนโุขูุฑ ููููโูุง ูพฺฉุณู ุฏุฑ ฺฉ ุชูุงู ุฎุฑูุฌ ุฎูุฏุด ุชุจุฏู ุจู ฺฏููฺฏุงู ูโุดูุฏ.
ุฑุงู ุจูุชุฑ ุงู ุงุณุช ฺฉู ูพฺฉุณูโูุง ุฑุง ูุณุชููุงู ุฏุฑ ฺฉ ุขุฑุงู ุง ุจููฺฉ ุญุงูุธูโ unmanaged ุจููุณู ู ุงุฒ **ฺฉูุงุณ Parallel** ุง **task parallelism** ุจุฑุง ูุฏุฑุช ฺูุฏุฑุณูุงู ุงุณุชูุงุฏู ฺฉูู.

(ุจุง ุงู ุญุงู ูโุชูุงู ุจุง ูุชุฏ `ForAll` ุฌูุนโุขูุฑ ูุชุงุฌ ุฑุง ุญุฐู ฺฉุฑุฏโุจุฎุด *Optimizing PLINQ* ุตูุญู 942 ุชูุถุญ ูโุฏูุฏ. ุงู ฺฉุงุฑ ููุช ููุทู ุงุณุช ฺฉู ุงูฺฏูุฑุชู ูพุฑุฏุงุฒุด ุชุตูุฑ ุฐุงุชุงู ููุงุณุจ LINQ ุจุงุดุฏ.)

---

### ๐งผ ุฎููุต ุชุงุจุน (Functional Purity)

ฺูู PLINQ ูพุฑุณโูุฌู ุดูุง ุฑุง ุฑู ูุฎโูุง ููุงุฒ ุงุฌุฑุง ูโฺฉูุฏุ ุจุงุฏ ูุฑุงูุจ ุจุงุดุฏ ุนููุงุช ุงูุฌุงู ูุฏูุฏ ฺฉู **Thread-Safe** ูุณุชูุฏ.

ุจูโูฺูุ ููุดุชู ุฏุฑ ูุชุบุฑูุง ุงุซุฑ ุฌุงูุจ ุฏุงุฑุฏ ู ุจูุงุจุฑุงู ูุงุงูู ุงุณุช:

```csharp
// ูพุฑุณโูุฌู ุฒุฑ ูุฑ ุนูุตุฑ ุฑุง ุฏุฑ ูููุนุชุด ุถุฑุจ ูโฺฉูุฏ.
// ุจุง ูุฑูุฏ Enumerable.Range(0,999) ุจุงุฏ ูุฑุจุนโูุง ุฑุง ุจุฏูุฏ.
int i = 0;
var query = from n in Enumerable.Range(0,999).AsParallel()
            select n * i++;
```

ุญุช ุงฺฏุฑ ุงูุฒุงุด `i` ุฑุง ุจุง ููู ุงูู ฺฉููุ ุจุงุฒ ูู ูุดฺฉู ุจุงู ูโูุงูุฏ ฺูู `i` ูุฒููุงู ุจุง ูููุนุช ุนูุตุฑ ูุฑูุฏ ุชุทุงุจู ูุฏุงุฑุฏ.
ุงูุฒูุฏู `AsOrdered` ูู ูุดฺฉู ุฑุง ุญู ููโฺฉูุฏุ ฺูู ููุท ุชุถูู ูโฺฉูุฏ ุฎุฑูุฌ ุจูโุชุฑุชุจ ุนูุงุตุฑ ูพุฑุฏุงุฒุดโุดุฏู ุจุงุดุฏุ ูู ุงูฺฉู ูุงูุนุงู ูพุฑุฏุงุฒุด ุชุฑุชุจ ุงูุฌุงู ุดูุฏ.

โ ุฑุงูโุญู ุฏุฑุณุช: ุงุณุชูุงุฏู ุงุฒ ูุณุฎูโ ุงูุฏุณโุฏุงุฑ `Select`:

```csharp
var query = Enumerable.Range(0,999).AsParallel()
                      .Select((n, i) => n * i);
```

๐น ุจุฑุง ุจูุชุฑู ฺฉุงุฑุงุ ูุชุฏูุง ฺฉู ุฏุฑ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ูุฑุงุฎูุงู ูโุดููุฏ ุจุงุฏ **Thread-Safe** ุจุงุดูุฏุ

* ุง ุจูโุฏูู ูุฏุงุดุชู ุงุซุฑ ุฌุงูุจ (ุฎุงูุต ุจูุฏู ุชุงุจุน)
* ุง ุงฺฏุฑ ุจูโูุณููโ ููู ุงูู ุดุฏูโุงูุฏุ ุจุงุฏ ุจุฏุงูุฏ ฺฉู ูพุชุงูุณู ููุงุฒโุณุงุฒ ูุญุฏูุฏ ุจู ุงุซุฑุงุช ุฑูุงุจุช ุฎูุงูุฏ ุจูุฏ.

---

### โ๏ธ ุชูุธู ุฏุฑุฌูโ ููุงุฒโุณุงุฒ (Degree of Parallelism)

ุจูโุทูุฑ ูพุดโูุฑุถุ PLINQ ุฏุฑุฌูโ ููุงุฒโุณุงุฒ ุจููู ุจุฑุง ูพุฑุฏุงุฒูุฏู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ.
ูโุชูุงูุฏ ุขู ุฑุง ุจุง ูุชุฏ `WithDegreeOfParallelism` ุชุบุฑ ุฏูุฏ:

```csharp
...AsParallel().WithDegreeOfParallelism(4)...
```

๐น ููููู: ุดุงุฏ ุจุฎูุงูุฏ ุฏุฑุฌูโ ููุงุฒโุณุงุฒ ุฑุง ุจุงูุงุชุฑ ุงุฒ ุชุนุฏุงุฏ ูุณุชูโูุง ุงูุฒุงุด ุฏูุฏุ ููุช ฺฉุงุฑ **I/O-Bound** ุฏุงุฑุฏ (ูุซูุงู ุฏุงูููุฏ ููโุฒูุงู ุตูุญุงุช ูุจ).
ุจุงุงูโุญุงูุ **Task combinators** ู **ุชูุงุจุน Asynchronous** ุฑุงูโุญู ูุดุงุจู ุงูุง ฺฉุงุฑุขูุฏุชุฑ ุงุฑุงุฆู ูโุฏููุฏ.

๐ซ ุจุฑุฎูุงู Tasksุ PLINQ ููโุชูุงูุฏ ฺฉุงุฑูุง I/O-Bound ุฑุง ุจุฏูู ูุณุฏูุฏ ฺฉุฑุฏู ูุฎโูุง ุงูุฌุงู ุฏูุฏ (ู ุงู ุจุฏุชุฑ ุจุงุนุซ ููู ุดุฏู ูุฎโูุง pool ูโุดูุฏ).

๐ ุชูุฌู:
`WithDegreeOfParallelism` ุฑุง ููุท **ฺฉโุจุงุฑ** ูโุชูุงู ุฏุฑ ฺฉ ูพุฑุณโูุฌู PLINQ ูุฑุงุฎูุงู ฺฉุฑุฏ.
ุงฺฏุฑ ูุงุฒ ุฏุงุฑุฏ ุฏูุจุงุฑู ุตุฏุง ุจุฒูุฏุ ุจุงุฏ ูพุฑุณโูุฌู ุฑุง merge ู ุฏูุจุงุฑู partition ฺฉูุฏ (ุจุง ุตุฏุง ุฒุฏู ุฏูุจุงุฑูโ `AsParallel`).

ูุซุงู:

```csharp
"The Quick Brown Fox"
    .AsParallel().WithDegreeOfParallelism(2)
    .Where(c => !char.IsWhiteSpace(c))
    .AsParallel().WithDegreeOfParallelism(3)   // Merge + Partition ุฏูุจุงุฑู
    .Select(c => char.ToUpper(c));
```

---

### โน ูุบู (Cancellation)

ูุบู ฺฉุฑุฏู ฺฉ ูพุฑุณโูุฌู PLINQ ฺฉู ุฏุฑ ุญุงู ูุตุฑู ูุชุงุฌุด ุฏุฑ `foreach` ูุณุชุฏ ุณุงุฏู ุงุณุช:
ฺฉุงู ุงุณุช ุงุฒ ุญููู ุฎุงุฑุฌ ุดูุฏ (`break`) ู ูพุฑุณโูุฌู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ูุบู ูโุดูุฏุ ฺูู enumerator ุจูโุทูุฑ ุถูู Dispose ูโุดูุฏ.

ุงูุง ุงฺฏุฑ ูพุฑุณโูุฌู ุจุง ฺฉ ุนููฺฏุฑ ุชุจุฏูุ ุชฺฉโุนูุตุฑ ุง ุชุฌูุน ุฎุงุชูู ุงุจุฏุ ุจุงุฏ ุขู ุฑุง ุงุฒ ฺฉ ูุฎ ุฏฺฏุฑ ุจุง **CancellationToken** ูุบู ฺฉูุฏ.

ุจุฑุง ุฏุฑุฌ ุชูฺฉูุ ุจุนุฏ ุงุฒ `AsParallel` ุงุฒ `WithCancellation` ุงุณุชูุงุฏู ฺฉูุฏ ู ุฎุงุตุช `Token` ุงุฒ ฺฉ `CancellationTokenSource` ุฑุง ูพุงุณ ุฏูุฏ.

ูุซุงู:

```csharp
IEnumerable<int> tenMillion = Enumerable.Range(3, 10_000_000);

var cancelSource = new CancellationTokenSource();
cancelSource.CancelAfter(100);   // ูุบู ุจุนุฏ ุงุฒ 100 ููโุซุงูู

var primeNumberQuery =
    from n in tenMillion.AsParallel().WithCancellation(cancelSource.Token)
    where Enumerable.Range(2, (int)Math.Sqrt(n)).All(i => n % i > 0)
    select n;

try
{
    int[] primes = primeNumberQuery.ToArray();
    // ูุฑฺฏุฒ ุจู ุงู ุฎุท ููโุฑุณู ฺูู ูุฎ ุฏฺฏุฑ ูุง ุฑุง ูุบู ูโฺฉูุฏ
}
catch (OperationCanceledException)
{
    Console.WriteLine("Query canceled");
}
```

๐น ููฺฏุงู ูุบูุ PLINQ ููุชุธุฑ ูโูุงูุฏ ูุฑ ูุฎ ฺฉุงุฑ ุฑู ุนูุตุฑ ุฌุงุฑโุงุด ุชูุงู ฺฉูุฏุ ุณูพุณ ูพุฑุณโูุฌู ูพุงุงู ูโุงุจุฏ.
ุงู ุนู ูุฑ ูุชุฏ ุฎุงุฑุฌ ฺฉู ูพุฑุณโูุฌู ูุฑุงุฎูุงู ฺฉุฑุฏู ุจุงุดุฏุ ุชุง ุงูุชูุง ุงุฌุฑุง ุฎูุงูุฏ ุดุฏ.

### ุจูููโุณุงุฒ PLINQ ๐

#### ุจูููโุณุงุฒ ุฏุฑ ุณูุช ุฎุฑูุฌ

ฺฉ ุงุฒ ูุฒุชโูุง **PLINQ** ุงู ุงุณุช ฺฉู ูุชุงุฌ ูพุฑุฏุงุฒุด ููุงุฒ ุฑุง ุจูโุทูุฑ ูุฑุชุจ ุฏุฑ ฺฉ ุฏูุจุงููโ ุฎุฑูุฌ ูุงุญุฏ ุฌูุนโุขูุฑ (collate) ูโฺฉูุฏ.
ุงูุง ฺฏุงู ูููโ ฺฉุงุฑ ฺฉู ุฏุฑ ููุงุช ุงูุฌุงู ูโุฏูุฏ ุงู ุงุณุช ฺฉู ุฑู ูุฑ ุนูุตุฑ ููุท ฺฉ ุชุงุจุน ุฑุง ุงุฌุฑุง ฺฉูุฏ:

```csharp
foreach (int n in parallelQuery)
    DoSomething(n);
```

ุงฺฏุฑ ฺูู ุดุฑุงุท ุฏุงุดุชู ุจุงุดุฏโู ุจุฑุงุชุงู ููู ูุจุงุดุฏ ฺฉู ุนูุงุตุฑ ุจู ฺู ุชุฑุชุจ ูพุฑุฏุงุฒุด ูโุดููุฏโูโุชูุงูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ูุชุฏ **ForAll** ุฏุฑ PLINQ ฺฉุงุฑุง ุฑุง ุจูุจูุฏ ุจุฏูุฏ โ.

---

#### ูุชุฏ ForAll

ูุชุฏ **ForAll** ฺฉ delegate ุฑุง ุฑู ูุฑ ุนูุตุฑ ุฎุฑูุฌ ฺฉ `ParallelQuery` ุงุฌุฑุง ูโฺฉูุฏ. ุงู ูุชุฏ ูุณุชููุงู ุจู ูุณุชูโ ุฏุงุฎู PLINQ ูุตู ูโุดูุฏ ู ูุฑุงุญู ุฌูุนโุขูุฑ ู ูพูุงุด ูุชุงุฌ (collating ู enumerating) ุฑุง ุฏูุฑ ูโุฒูุฏ.

๐น ูุซุงู ุณุงุฏู:

```csharp
"abcdef"
    .AsParallel()
    .Select(c => char.ToUpper(c))
    .ForAll(Console.Write);
```

---

๐ **ุดฺฉู 22-3** ุงู ูุฑุขูุฏ ุฑุง ูุดุงู ูโุฏูุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-4.jpeg)
</div>

### ุจูููโุณุงุฒ PLINQ ๐

#### ุฌูุนโุขูุฑ ู ูพูุงุด ูุชุงุฌ (Collating & Enumerating)

ุนููุงุช ุฌูุนโุขูุฑ (collating) ู ูพูุงุด (enumerating) ูุชุงุฌุ ุฐุงุชุงู **ุฎู ูพุฑูุฒูู ูุณุชูุฏ**.
ุจู ููู ุฏููุ ุจูููโุณุงุฒ ุจุง ุงุณุชูุงุฏู ุงุฒ ูุชุฏ **ForAll** ุจุดุชุฑู ุณูุฏ ุฑุง ุฒูุงู ุจู ููุฑุงู ุฏุงุฑุฏ ฺฉู:

* ุชุนุฏุงุฏ ุนูุงุตุฑ ูุฑูุฏ ุฎู ุฒุงุฏ ุจุงุดุฏ ๐ข
* ู ูุฑ ุนูุตุฑ ุจูโุณุฑุนุช ูพุฑุฏุงุฒุด ุดูุฏ โก

---

#### ุจูููโุณุงุฒ ุฏุฑ ุณูุช ูุฑูุฏ (Input-side Optimization)

ุจุฑุง ุงูฺฉู ุฏุงุฏูโูุง ุฑุง ุจู ุฑุดุชูโูุง (threads) ุชูุณู ฺฉูุฏุ **PLINQ** ุงุฒ **ุณู ุงุณุชุฑุงุชฺ ูพุงุฑุชุดูโุจูุฏ (Partitioning Strategies)** ุงุณุชูุงุฏู ูโฺฉูุฏ:

1. **Range Partitioning (ูพุงุฑุชุดูโุจูุฏ ุจุงุฒูโุง)**

   * ุจุฑุง ุฏูุจุงููโูุง ุนุฏุฏ ุง ุฏุงุฏูโูุง ุงูุฏฺฉุณโุฏุงุฑ ููุงุณุจ ุงุณุช.
   * ูุฑูุฏ ุจู ุจุงุฒูโูุง ูพูุณุชู ุชูุณู ูโุดูุฏ ู ูุฑ ุจุงุฒู ุจู ฺฉ thread ุงุฎุชุตุงุต ุฏุงุฏู ูโุดูุฏ.

2. **Chunk Partitioning (ูพุงุฑุชุดูโุจูุฏ ูุทุนูโุง / ุชฺฉูโุง)**

   * ุฏุงุฏูโูุง ุฏุฑ ูุทุนุงุช (chunks) ฺฉูฺฺฉ ุชูุณู ูโุดููุฏ.
   * ุงู ุฑูุด ุจุงุนุซ ุจุงูุงูุณ ุจูุชุฑ ุจู threadูุง ูโุดูุฏุ ูุฎุตูุตุงู ููุช ุฒูุงู ูพุฑุฏุงุฒุด ุนูุงุตุฑ **ูุงูุชูุงุฒู** ุจุงุดุฏ.

3. **Hash Partitioning (ูพุงุฑุชุดูโุจูุฏ ูุด)**

   * ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ **ฺฉูุฏ ูุด**ุ ุนูุงุตุฑ ุจู threadูุง ูุฎุชูู ุงุฎุชุตุงุต ุฏุงุฏู ูโุดููุฏ.
   * ุจุฑุง ุณูุงุฑููุง ฺฉู ุฏุงุฏูโูุง ุณุงุฎุชุงุฑ ุฎุงุต ุฏุงุฑูุฏ ููุฏ ุงุณุช.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-5.jpeg)
</div>

### ุจูููโุณุงุฒ PLINQ ุฏุฑ ูพุงุฑุชุดูโุจูุฏ โก

#### ุนููฺฏุฑูุง ฺฉู ูุงุฒ ุจู ููุงุณู ุฏุงุฑูุฏ

ุจุฑุง ุนููฺฏุฑูุง LINQ ฺฉู ูุงุฒููุฏ **ููุงุณู ุนูุงุตุฑ** ูุณุชูุฏ (ูุงููุฏ:
`GroupBy`ุ `Join`ุ `GroupJoin`ุ `Intersect`ุ `Except`ุ `Union` ู `Distinct`) โ
ูฺ ุงูุชุฎุงุจ ูุฌูุฏ ูุฏุงุฑุฏ: **PLINQ ููุดู ุงุฒ Hash Partitioning ุงุณุชูุงุฏู ูโฺฉูุฏ**.

* ุฏุฑ ุงู ุญุงูุช PLINQ ุจุงุฏ ุงุฒ ูุจู **hashcode** ููู ุนูุงุตุฑ ุฑุง ูุญุงุณุจู ฺฉูุฏ ุชุง ุงุทููุงู ุงุจุฏ ุนูุงุตุฑ ุจุง hashcode ูุดุงุจู ุฑู ููุงู thread ูพุฑุฏุงุฒุด ูโุดููุฏ.
* ุงู ุฑูุด ูโุชูุงูุฏ ูุณุจุชุงู **ฺฉูุฏ** ุจุงุดุฏ.
* ุงฺฏุฑ ุณุฑุนุช ุจุฑุงุชุงู ูุณุฆููโุณุงุฒ ุดุฏุ ุชููุง ฺฏุฒูู ุงู ุงุณุช ฺฉู ุจุง **AsSequential** ููุงุฒโุณุงุฒ ุฑุง ุบุฑูุนุงู ฺฉูุฏ.

---

#### ุณุงุฑ ุนููฺฏุฑูุง ฺฉูุฆุฑ

ุจุฑุง ุฏฺฏุฑ ุนููฺฏุฑูุงุ ุดูุง ูโุชูุงูุฏ ุงูุชุฎุงุจ ฺฉูุฏ ุจู:

* **Range Partitioning** ๐ฆ
* **Chunk Partitioning** ๐ฉ

ุจูโุตูุฑุช ูพุดโูุฑุถ:

* ุงฺฏุฑ ุฏูุจุงูู ูุฑูุฏ **ุงูุฏฺฉุณโูพุฐุฑ** ุจุงุดุฏ (ูุซู ุขุฑุงูโูุง ุง ฺุฒ ฺฉู `IList<T>` ูพุงุฏูโุณุงุฒ ฺฉุฑุฏู)ุ
  โ **PLINQ ุงุฒ Range Partitioning ุงุณุชูุงุฏู ูโฺฉูุฏ**.
* ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ
  โ **Chunk Partitioning ุงูุชุฎุงุจ ูโุดูุฏ**.

---

#### ููุงุณู ฺฉู ๐

* **Range Partitioning** โ ุณุฑุนโุชุฑ ุงุณุช ุจุฑุง ุฏูุจุงููโูุง ุทููุงู ฺฉู ูพุฑุฏุงุฒุด ูุฑ ุนูุตุฑ ุชูุฑุจุงู **ฺฉุณุงู** ุฒูุงู ูโุจุฑุฏ.
* **Chunk Partitioning** โ ุฏุฑ ุณุงุฑ ููุงูุน ูุนูููุงู ุณุฑุนโุชุฑ ุงุณุชุ ุจูโูฺู ููุช ูพุฑุฏุงุฒุด ุนูุงุตุฑ **ูุงูุชูุงุฒู** ุจุงุดุฏ.

---

#### ุงุฌุจุงุฑ ุจู Range Partitioning

1. ุงฺฏุฑ ฺฉูุฆุฑ ุจุง `Enumerable.Range` ุดุฑูุน ูโุดูุฏุ ุขู ุฑุง ุจุง `ParallelEnumerable.Range` ุฌุงฺฏุฒู ฺฉูุฏ.
2. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ฺฉุงู ุงุณุช ุฑู ูุฑูุฏ `ToList` ุง `ToArray` ุตุฏุง ุจุฒูุฏ (ุงูุจุชู ุงู ุฎูุฏุด ูุฒููโ ฺฉุงุฑุง ุฏุงุฑุฏ).

๐ ูฺฉุชู ููู:
`ParallelEnumerable.Range` ููุท ฺฉ ุดูุฑุชฺฉุงุช ุจุฑุง `Enumerable.Range(...).AsParallel()` ูุณุชุ ุจูฺฉู ูุงูุนุงู ุจุงุนุซ **ูุนุงู ุดุฏู Range Partitioning** ูโุดูุฏ ู ุฑูุชุงุฑ ฺฉูุฆุฑ ุฑุง ุชุบุฑ ูโุฏูุฏ.

---

#### ุงุฌุจุงุฑ ุจู Chunk Partitioning

ุจุฑุง ุงู ฺฉุงุฑ ุจุงุฏ ุฏูุจุงูู ูุฑูุฏ ุฑุง ุจุง `Partitioner.Create` (ุงุฒ ูุถุง ูุงู `System.Collections.Concurrent`) ุจูพฺุฏ:

```csharp
int[] numbers = { 3, 4, 5, 6, 7, 8, 9 };
var parallelQuery =
    Partitioner.Create(numbers, true).AsParallel()
              .Where(...);
```

* ุขุฑฺฏููุงู ุฏูู (`true`) ูุดุฎุต ูโฺฉูุฏ ฺฉู ูโุฎูุงูุฏ **load balancing** ูุนุงู ุจุงุดุฏุ ุนู Chunk Partitioning ุงุณุชูุงุฏู ุดูุฏ.

---

#### ูุญูู ฺฉุงุฑ Chunk Partitioning โ๏ธ

* ูุฑ thread ุจูโุทูุฑ ุฏูุฑูโุง ฺูุฏ ุนูุตุฑ (ฺฉ "chunk") ุฑุง ุจุฑูโุฏุงุฑุฏ.
* ุฏุฑ ุงุจุชุฏุง chunkูุง ุฎู ฺฉูฺฺฉ ูุณุชูุฏ (ฑ ุง ฒ ุนูุตุฑ).
* ุจุง ูพุดุฑูุช ฺฉูุฆุฑุ ุงูุฏุงุฒู chunkูุง ุจุดุชุฑ ูโุดูุฏ.
* ุงู ุฑูุด ุจุงุนุซ ูโุดูุฏ:

  * ุฏูุจุงููโูุง ฺฉูฺฺฉ ุจูโุฎูุจ ููุงุฒ ุดููุฏ โ
  * ู ุฏูุจุงููโูุง ุจุฒุฑฺฏ ุจุงุนุซ **ุฑูุชโูุจุฑฺฏุดุช ุจุดโุงุฒุญุฏ (round-tripping)** ูุดููุฏ.
* ุงฺฏุฑ ฺฉ thread ุนูุงุตุฑ "ุณุงุฏูโุชุฑ" ุจฺฏุฑุฏุ ุณุฑุนโุชุฑ ุขุฒุงุฏ ูโุดูุฏ ู chunks ุจุดุชุฑ ูพุฑุฏุงุฒุด ูโฺฉูุฏ.
* ูุชุฌู โ ููู threads ูุดุบูู ู **ูุชุนุงุฏู** ูโูุงููุฏ.
* ุชููุง ูุดฺฉู โ ูุงุฒ ุจู **synchronization** (ูุซู lock ุงุฎุชุตุงุต) ุจุฑุง ุฏุณุชุฑุณ ุจู ุฏูุจุงูู ูุฑูุฏ ุงุณุช ฺฉู ูโุชูุงูุฏ ฺฉู overhead ุงุฌุงุฏ ฺฉูุฏ.

---

#### ูุญูู ฺฉุงุฑ Range Partitioning ๐งฎ

* ุฏุฑ Range Partitioningุ ูุฑูุฏ ุงุฒ ููุงู ุงุจุชุฏุง ุจู threads ุชูุณู ูโุดูุฏ.
* ูุฑ thread ุจุฎุด **ุซุงุจุช** ุงุฒ ุฏุงุฏู ุฑุง ูโฺฏุฑุฏ โ ุจุฏูู ูุงุฒ ุจู lock.
* ูุดฺฉู: ุงฺฏุฑ ุจุนุถ threads ุนูุงุตุฑ "ุณุงุฏูโุชุฑ" ุจฺฏุฑูุฏ ู ุฒูุฏุชุฑ ุชูุงู ฺฉููุฏุ ุจูู ูููุฒ ุฏุฑ ุญุงู ฺฉุงุฑ ุฎูุงููุฏ ุจูุฏ โ ู ุงู ุจุงุนุซ idle ุดุฏู threadูุง ูโุดูุฏ.

๐ ูุซุงู: ูุญุงุณุจู ุงุนุฏุงุฏ ุงูู ุจุง Range Partitioning ููฺฉู ุงุณุช ุนููฺฉุฑุฏ ุถุนู ุฏุงุดุชู ุจุงุดุฏ.
๐ ุงูุง ูุญุงุณุจู ุฑุดู ุฏูู ฑฐ ูููู ุนุฏุฏ ุงูู (ฺฉู ุฒูุงู ูพุฑุฏุงุฒุด ูุฑ ุนูุตุฑ ฺฉุณุงู ุงุณุช) ุจุณุงุฑ ุฎูุจ ุนูู ูโฺฉูุฏ:

```csharp
ParallelEnumerable.Range(1, 10_000_000).Sum(i => Math.Sqrt(i));
```

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-6.jpeg)
</div>

### ุจูููโุณุงุฒ Aggregation ุฏุฑ PLINQ โ๏ธ

#### ParallelEnumerable.Range

ูุชุฏ `ParallelEnumerable.Range` ฺฉ `ParallelQuery<T>` ุจุฑูโฺฏุฑุฏุงูุฏุ ุจูุงุจุฑุงู ูุงุฒ ุจู ูุฑุงุฎูุงู ุจุนุฏ **AsParallel** ูุณุช.

* ูพุงุฑุชุดูโุจูุฏ Range ูุฒููุงู ุนูุงุตุฑ ุฑุง ุฏุฑ ุจููฺฉโูุง ูุชูุงู ุชุฎุตุต ููโุฏูุฏุ ููฺฉู ุงุณุช ุงุฒ ุงุณุชุฑุงุชฺ **Striping** ุงุณุชูุงุฏู ฺฉูุฏ.
* ูุซุงู: ุงฺฏุฑ ุฏู worker ุฏุงุดุชู ุจุงุดูุ ฺฉ ุนูุงุตุฑ **ูุฑุฏ** ู ุฏฺฏุฑ ุนูุงุตุฑ **ุฒูุฌ** ุฑุง ูพุฑุฏุงุฒุด ูโฺฉูุฏ.
* ุนููฺฏุฑ `TakeWhile` ุชูุฑุจุงู ููุดู ุงุฒ ุงู ุงุณุชุฑุงุชฺ ุงุณุชูุงุฏู ูโฺฉูุฏ ุชุง ุงุฒ ูพุฑุฏุงุฒุด ุงุถุงู ุนูุงุตุฑ ุฏุฑ ุงูุชูุง ุฏูุจุงูู ุฌููฺฏุฑ ฺฉูุฏ.

---

#### ุจูููโุณุงุฒ Aggregation ุณูุงุฑุด

PLINQ ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ ูุงููุฏ `Sum`ุ `Average`ุ `Min` ู `Max` ุฑุง ุจูโุตูุฑุช ููุงุฒ ู ุจููู ูุฏุฑุช ูโฺฉูุฏ.
ุงูุง **Aggregate** ฺุงูุดโูุง ุฎุงุต ุฏุงุฑุฏ.

ูุซุงู ุณุงุฏู ุงุฒ Aggregate (ุฌูุน ฺฉุฑุฏู ฺฉ ุฏูุจุงูู ุงุนุฏุงุฏ):

```csharp
int[] numbers = { 1, 2, 3 };
int sum = numbers.Aggregate(0, (total, n) => total + n); // 6
```

* ุจุฑุง **aggregation ุจุฏูู seed**ุ delegate ุงุฑุงุฆูโุดุฏู ุจุงุฏ **associative** ู **commutative** ุจุงุดุฏ.
* ุงฺฏุฑ ุงู ูุงููู ุฑุนุงุช ูุดูุฏุ PLINQ ููฺฉู ุงุณุช ูุชุงุฌ ุงุดุชุจุงู ุจุฏูุฏุ ุฒุฑุง ฺูุฏ seed ุงุฒ ุฏูุจุงูู ุจุฑุง ุฌูุนโุจูุฏ ฺูุฏ ูพุงุฑุชุดู ุงุณุชูุงุฏู ูโฺฉูุฏ.

---

#### Aggregate ุจุง seed ฺูุฏฺฏุงูู

* Aggregate ุจุง seed ุตุฑุญ ูุนูููุงู ุจูโุตูุฑุช **ุณุฑุงู** ุงุฌุฑุง ูโุดูุฏ ุฒุฑุง ููุท ฺฉ seed ุฏุงุฑุฏ.
* PLINQ ฺฉ overload ุฎุงุต ุงุฑุงุฆู ูโุฏูุฏ ฺฉู **seed factory** ูโฺฏุฑุฏ.

  * ุจุฑุง ูุฑ threadุ ุงู ุชุงุจุน ฺฉ seed ูุญู ุงุฌุงุฏ ูโฺฉูุฏ โ **accumulator ูุญู**
  * ุณูพุณ ููุงุฏุฑ ูุญู ุจุง accumulator ุงุตู ุชุฑฺฉุจ ูโุดููุฏ.
* ุงู overload ููฺูู ฺฉ delegate ุจุฑุง **ุชุจุฏู ููุง** ูุชุงุฌ ูโฺฏุฑุฏ.

ฺูุงุฑ delegate ุจู ุชุฑุชุจ:

1. `seedFactory` โ ุงุฌุงุฏ accumulator ูุญู
2. `updateAccumulatorFunc` โ ุงุถุงูู ฺฉุฑุฏู ฺฉ ุนูุตุฑ ุจู accumulator ูุญู
3. `combineAccumulatorFunc` โ ุชุฑฺฉุจ accumulator ูุญู ุจุง ุงุตู
4. `resultSelector` โ ุชุจุฏู ููุง ูุชุฌู

ูุซุงู ุณุงุฏู ุฌูุน ุงุนุฏุงุฏ ุจุง PLINQ:

```csharp
numbers.AsParallel().Aggregate(
    () => 0,                           // seedFactory
    (localTotal, n) => localTotal + n, // updateAccumulatorFunc
    (mainTot, localTot) => mainTot + localTot, // combineAccumulatorFunc
    finalResult => finalResult          // resultSelector
);
```

---

#### ูุซุงู ูุงูุนโุชุฑ: ุดูุงุฑุด ูุฑฺฉุงูุณ ุญุฑูู ุฏุฑ ูุชู

ูุชู:

```csharp
string text = "Letโs suppose this is a really long string";
var letterFrequencies = new int[26];
foreach (char c in text)
{
    int index = char.ToUpper(c) - 'A';
    if (index >= 0 && index < 26) letterFrequencies[index]++;
}
```

* ุจุฑุง ูุชูโูุง ุทููุงู (ูุซู **gene sequencing**) ุงู ุฑูุด ูโุชูุงูุฏ ุฒูุงูโุจุฑ ุจุงุดุฏ.
* ููุงุฒโุณุงุฒ ุจุง `Parallel.ForEach` ูุงุฒููุฏ ูุฏุฑุช ููุฒูุงู ุฑู ุขุฑุงู ูุดุชุฑฺฉ ุงุณุชุ ู ููู ฺฉุฑุฏู ูโุชูุงูุฏ **ูพุชุงูุณู ููุงุฒโุณุงุฒ** ุฑุง ุงุฒ ุจู ุจุจุฑุฏ.

PLINQ ุจุง Aggregate ุฑุงูโุญู ุชูุฒ ุงุฑุงุฆู ูโุฏูุฏ:

```csharp
int[] result = text.AsParallel().Aggregate(
    () => new int[26],               // accumulator ูุญู
    (localFrequencies, c) =>        // ุฌูุนโุจูุฏ ุฏุฑ accumulator ูุญู
    {
        int index = char.ToUpper(c) - 'A';
        if (index >= 0 && index < 26) localFrequencies[index]++;
        return localFrequencies;
    },
    (mainFreq, localFreq) =>         // ุชุฑฺฉุจ local -> main
        mainFreq.Zip(localFreq, (f1, f2) => f1 + f2).ToArray(),
    finalResult => finalResult        // ุชุจุฏู ููุง
);
```

* ุชูุฌู: ุชุงุจุน ูุญู `localFrequencies` ุนูุงุตุฑ ุฑุง ุชุบุฑ ูโุฏูุฏ.
* ุงู ุจูููโุณุงุฒ ุงูฺฉุงูโูพุฐุฑ ุงุณุช ฺูู ูุฑ accumulator ูุญู **ูุฎุชุต ูุฑ thread** ุงุณุช.

### ฺฉูุงุณ Parallel ๐ข

ฺฉุชุงุจุฎุงูู PFX ฺฉ ุดฺฉู ูพุงู ุงุฒ **Structured Parallelism** ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุงุฒ ุทุฑู ุณู ูุชุฏ **static** ุฏุฑ ฺฉูุงุณ `Parallel` ูุงุจู ุงุณุชูุงุฏู ุงุณุช:

* `Parallel.Invoke`
  ุงุฌุฑุง ฺฉ ุขุฑุงู ุงุฒ delegateูุง ุจูโุตูุฑุช ููุงุฒ

* `Parallel.For`
  ูุนุงุฏู ููุงุฒ ุญููู `for` ุฏุฑ C#

* `Parallel.ForEach`
  ูุนุงุฏู ููุงุฒ ุญููู `foreach` ุฏุฑ C#

> ูุฑ ุณู ูุชุฏ ุชุง ุชฺฉูู ูููโ ฺฉุงุฑูุงุ ุจูุงฺฉ ูโุดููุฏ. ูุดุงุจู PLINQุ ุฏุฑ ุตูุฑุช ุจุฑูุฒ **exception** ฺฉู ูุฏุฑุช ูุดุฏู ุจุงุดุฏุ ุณุงุฑ workerูุง ุจุนุฏ ุงุฒ ุงุชูุงู iteration ูุนู ูุชููู ูโุดููุฏ ู exceptionูุง ุจู caller ุจุฑูโฺฏุฑุฏูุฏโฺฉู ุฏุฑ ฺฉ `AggregateException` ุจุณุชูโุจูุฏ ุดุฏูโุงูุฏ.

---

#### Parallel.Invoke

`Parallel.Invoke` ฺฉ ุขุฑุงู ุงุฒ delegateูุง **Action** ุฑุง ููุงุฒ ุงุฌุฑุง ฺฉุฑุฏู ู ููุชุธุฑ ุงุชูุงู ุขูโูุง ูโูุงูุฏ. ุณุงุฏูโุชุฑู ุงูุถุง ูุชุฏ:

```csharp
public static void Invoke(params Action[] actions);
```

* ูุดุงุจู PLINQุ ูุชุฏูุง `Parallel.*` ุจุฑุง ฺฉุงุฑูุง **compute-bound** ุจููู ุดุฏูโุงูุฏุ ูู I/O-bound.
* ูุซุงู ุณุงุฏู ุจุง ุฏุงูููุฏ ุฏู ุตูุญู ูุจ ุจู ุตูุฑุช ููุงุฒ:

```csharp
Parallel.Invoke(
    () => new WebClient().DownloadFile("http://www.linqpad.net", "lp.html"),
    () => new WebClient().DownloadFile("http://microsoft.com", "ms.html")
);
```

**ูฺฉุชู ููู:**
`Parallel.Invoke` ุญุช ุจุง ฺฉ ูููู delegate ูู ุจูโุตูุฑุช ูุคุซุฑ ฺฉุงุฑ ูโฺฉูุฏุ ุฒุฑุง ุนูุงุตุฑ ุฑุง ุจู **batch** ุชูุณู ูโฺฉูุฏ ู ุจู ฺูุฏ Task ุงุตู ุงุฎุชุตุงุต ูโุฏูุฏุ ุจู ุฌุง ุงุฌุงุฏ ฺฉ Task ุจุฑุง ูุฑ delegate.

> ูุณุฆููุช collating ูุชุงุฌ ุจุฑ ุนูุฏู ุดูุงุณุชุ ุจูุงุจุฑุงู ุจุงุฏ ุจู **Thread Safety** ุชูุฌู ฺฉูุฏ:

```csharp
var data = new List<string>();
Parallel.Invoke(
    () => data.Add(new WebClient().DownloadString("http://www.foo.com")),
    () => data.Add(new WebClient().DownloadString("http://www.far.com"))
);
```

* ุจุฑุง ุญู ูุดฺฉู thread-unsafeุ ูโุชูุงู ุงุฒ **locking** ุงุณุชูุงุฏู ฺฉุฑุฏุ ุงูุง ุงู ฺฉุงุฑ ุฏุฑ ุขุฑุงูโูุง ุจุฒุฑฺฏ delegate ุจุงุนุซ **bottleneck** ูโุดูุฏ.
* ุฑุงู ุจูุชุฑ: ุงุณุชูุงุฏู ุงุฒ **Thread-Safe Collections**ุ ูุงููุฏ `ConcurrentBag`.

ููฺูู `Parallel.Invoke` ฺฉ overload ุฏุงุฑุฏ ฺฉู **ParallelOptions** ูโฺฏุฑุฏ:

```csharp
public static void Invoke(ParallelOptions options, params Action[] actions);
```

* ุจุง `ParallelOptions` ูโุชูุงู **CancellationToken** ูุงุฑุฏ ฺฉุฑุฏุ ุญุฏุงฺฉุซุฑ concurrency ุฑุง ูุญุฏูุฏ ฺฉุฑุฏุ ุง ฺฉ **task scheduler** ุณูุงุฑุด ูุดุฎุต ฺฉุฑุฏ.

---

#### Parallel.For ู Parallel.ForEach

ุงู ูุชุฏูุง ูุนุงุฏู ููุงุฒ ุญูููโูุง `for` ู `foreach` ูุณุชูุฏุ ุจู ุงู ูุนูุง ฺฉู ูุฑ iteration ุจูโุตูุฑุช ููุงุฒ ุงุฌุฑุง ูโุดูุฏ.

ุณุงุฏูโุชุฑู ุงูุถุงูุง:

```csharp
public static ParallelLoopResult For(int fromInclusive, int toExclusive, Action<int> body);
public static ParallelLoopResult ForEach<TSource>(IEnumerable<TSource> source, Action<TSource> body);
```

ูุซุงู:

ุญููู `for` ูุนููู:

```csharp
for (int i = 0; i < 100; i++)
    Foo(i);
```

ูุนุงุฏู ููุงุฒ:

```csharp
Parallel.For(0, 100, i => Foo(i));
// ุง ุณุงุฏูโุชุฑ
Parallel.For(0, 100, Foo);
```

ุญููู `foreach` ูุนููู:

```csharp
foreach (char c in "Hello, world")
    Foo(c);
```

ูุนุงุฏู ููุงุฒ:

```csharp
Parallel.ForEach("Hello, world", Foo);
```

ูุซุงู ุนูู ุจุง ุฑูุฒูฺฏุงุฑ (`System.Security.Cryptography`):

```csharp
var keyPairs = new string[6];
Parallel.For(0, keyPairs.Length,
    i => keyPairs[i] = RSA.Create().ToXmlString(true));
```

* ูุดุงุจู `Parallel.Invoke`ุ ูโุชูุงู ุชุนุฏุงุฏ ุฒุงุฏ work item ุจู `Parallel.For` ู `Parallel.ForEach` ุฏุงุฏ ู ุขูโูุง ุจูโุตูุฑุช ูุคุซุฑ ุฑู ฺูุฏ Task ุชูุณู ูโุดููุฏ.
* ููุงู ฺฉุงุฑ ุฑุง ูโุชูุงู ุจุง PLINQ ุงูุฌุงู ุฏุงุฏ:

```csharp
string[] keyPairs = ParallelEnumerable.Range(0, 6)
    .Select(i => RSA.Create().ToXmlString(true))
    .ToArray();
```

---

#### ุญูููโูุง ุฏุงุฎู ู ุฎุงุฑุฌ

* `Parallel.For` ู `Parallel.ForEach` ูุนูููุงู ุฑู **ุญูููโูุง ุฎุงุฑุฌ** ุจูุชุฑ ุนูู ูโฺฉููุฏุ ุฒุฑุง chunkูุง ุจุฒุฑฺฏุชุฑ ุจุฑุง ููุงุฒโุณุงุฒ ุงุฑุงุฆู ูโุฏููุฏ ู overhead ูุฏุฑุช ฺฉูุชุฑ ูโุดูุฏ.
* ููุงุฒโุณุงุฒ ูุฑ ุฏู ุญููู ุฏุงุฎู ู ุฎุงุฑุฌ ูุนูููุงู ุบุฑุถุฑูุฑ ุงุณุช.

ูุซุงู:

```csharp
Parallel.For(0, 100, i =>
{
    Parallel.For(0, 50, j => Foo(i, j));   // ุญููู ุฏุงุฎู: ูุนูููุงู sequential ุจูุชุฑ ุงุณุช
});
```

### Parallel.ForEach ุจุง ุงูุฏุณ ู ูุฏุฑุช ุชููู ุญููู ๐ข

ฺฏุงู ุงููุงุช ุฏุฑ **ุญูููโูุง ููุงุฒ** ูุงุฒู ุงุณุช ฺฉู **ุงูุฏุณ iteration** ุฑุง ุจุฏุงูู.

#### ุงูุฏุณ ุฏุฑ ุญูููโูุง ููุงุฒ

ุฏุฑ ุญููู sequential ูุนููู:

```csharp
int i = 0;
foreach (char c in "Hello, world")
    Console.WriteLine(c.ToString() + i++);
```

ุงูุง ุฏุฑ ูุญุท ููุงุฒุ **ุงูุฒุงุด ฺฉ ูุชุบุฑ ูุดุชุฑฺฉ thread-safe ูุณุช**.
ุฑุงู ุญู: ุงุณุชูุงุฏู ุงุฒ overload ุง ุงุฒ `Parallel.ForEach` ฺฉู ุงูุฏุณ loop ุฑุง ุงุฑุงุฆู ูโุฏูุฏ:

```csharp
public static ParallelLoopResult ForEach<TSource>(
    IEnumerable<TSource> source, Action<TSource, ParallelLoopState, long> body)
```

* ูพุงุฑุงูุชุฑ ุณูู ุงุฒ ููุน `long` ุงูุฏุณ ูุฑ ุนูุตุฑ ุฑุง ูุดุงู ูโุฏูุฏ.
* ูุซุงู:

```csharp
Parallel.ForEach("Hello, world", (c, state, i) =>
{
    Console.WriteLine(c.ToString() + i);
});
```

---

#### ูุซุงู ุนูู: Spellchecker ููุงุฒ

```csharp
var wordLookup = new HashSet<string>(
    File.ReadAllLines("WordLookup.txt"),
    StringComparer.InvariantCultureIgnoreCase
);

var random = new Random();
string[] wordList = wordLookup.ToArray();
string[] wordsToTest = Enumerable.Range(0, 1000000)
    .Select(i => wordList[random.Next(0, wordList.Length)])
    .ToArray();

wordsToTest[12345] = "woozsh";
wordsToTest[23456] = "wubsie";

var misspellings = new ConcurrentBag<Tuple<int,string>>();

Parallel.ForEach(wordsToTest, (word, state, i) =>
{
    if (!wordLookup.Contains(word))
        misspellings.Add(Tuple.Create((int)i, word));
});
```

> ูฺฉุชู: ุจุงุฏ ูุชุงุฌ ุฑุง ุฏุฑ ฺฉ **collection ุงูู ุจุฑุง Thread** ุฌูุนโุขูุฑ ฺฉูุฏ.
> ูุฒุช ุงุณุชูุงุฏู ุงุฒ indexed `ForEach` ูุณุจุช ุจู PLINQ: ุงุฌุฑุง **ูุณุชูู ุจุฏูู ุงุนูุงู Select ุจุง ุงูุฏุณ** ฺฉู ฺฉุงุฑุง ุจุดุชุฑ ุฏุงุฑุฏ.

---

#### ParallelLoopState: ุชููู ุฒูุฏููฺฏุงู ุญููู

ุฏุฑ ุญููู ููุงุฒ ููโุชูุงู ุงุฒ `break` ูุนููู ุงุณุชูุงุฏู ฺฉุฑุฏ.
ุจุงุฏ ุงุฒ ูุชุฏูุง `Break()` ุง `Stop()` ุฏุฑ ุด `ParallelLoopState` ุงุณุชูุงุฏู ฺฉูุฏ.

```csharp
Parallel.ForEach("Hello, world", (c, loopState) =>
{
    if (c == ',')
        loopState.Break();  // ูพุงุงู ุญููู ุจุนุฏ ุงุฒ iteration ุฌุงุฑ
    else
        Console.Write(c);
});
```

**ุชูุงูุช Break ู Stop:**

* `Break()` โ ุญููู ุจุนุฏ ุงุฒ iteration ูุนู ูพุงุงู ูโุงุจุฏุ ุญุฏุงูู ุนูุงุตุฑ ูุจู ุงุฒ ุชููู ุงุฌุฑุง ูโุดููุฏ.
* `Stop()` โ ุญููู ุจูุงูุงุตูู ุจุฑุง ุชูุงู threadูุง ูพุงุงู ูโุงุจุฏุ ููฺฉู ุงุณุช ุชููุง ุฒุฑูุฌููุนูโุง ุงุฒ ุนูุงุตุฑ ูพุฑุฏุงุฒุด ุดููุฏ.

---

#### ParallelLoopResult

ูุชุฏูุง `Parallel.For` ู `Parallel.ForEach` ฺฉ **ParallelLoopResult** ุจุงุฒูโฺฏุฑุฏุงููุฏ:

* `IsCompleted` โ ุขุง ุญููู ุชุง ุงูุชูุง ุงุฌุฑุง ุดุฏูุ
* `LowestBreakIteration` โ ุงูุฏุณ iteration ฺฉู ุญููู ุจุง `Break()` ูพุงุงู ุงูุชู ุงุณุช (ุงฺฏุฑ `Stop()` ุจุงุดุฏุ null ุจุฑูโฺฏุฑุฏุงูุฏ).

---

#### ูุฏุฑุช ุทูู ุญููู ู ุชููู ุฌุฒุฆ

* ุงฺฏุฑ ุจุฏูู ุญููู ุทููุงู ุงุณุชุ ูโุชูุงู ุฏุฑ ููุงุท ูุฎุชูู ฺฉุฏุ **poll** ุฑู `ShouldExitCurrentIteration` ุงูุฌุงู ุฏุงุฏ.
* ุงู property ุจูุงูุงุตูู ุจุนุฏ ุงุฒ `Stop()` ุง ฺฉู ุจุนุฏ ุงุฒ `Break()` ุฏุฑุณุช ูโุดูุฏ.
* ููฺูู ุจุนุฏ ุงุฒ ุฏุฑุฎูุงุณุช **cancellation** ุง ุฑุฎุฏุงุฏ **exception** ุฏุฑ ุญูููุ `ShouldExitCurrentIteration` ุจุฑุงุจุฑ true ูโุดูุฏ.
* `IsExceptional` โ ุงุทูุงุน ุงุฒ ุจุฑูุฒ exception ุฏุฑ ุณุงุฑ threadูุง.

> ูฺฉุชู: ูุฑ exception ูุฏุฑุช ูุดุฏู ุจุงุนุซ ุชููู ุญููู ุจุนุฏ ุงุฒ iteration ุฌุงุฑ ูุฑ thread ูโุดูุฏุ ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ฺฉุงุฑุ ุจุงุฏ **exceptionูุง ุฑุง ูุฏุฑุช ฺฉูุฏ**.
>
### ุจูููโุณุงุฒ ุจุง ููุงุฏุฑ ูุญู ุฏุฑ Parallel.For / Parallel.ForEach ๐ข

ฺฏุงู ุญูููโูุง ููุงุฒ ูุงุฒ ุจู **ุฌูุนโุขูุฑ ุฏุงุฏูโูุง ุฏุฑ ุญู iteration** ุฏุงุฑูุฏุ ูุฎุตูุตุงู ููุช ุชุนุฏุงุฏ ุชฺฉุฑุงุฑูุง ุฒุงุฏ ุงุณุช.

---

#### ูุดฺฉู ููููู: ุฌูุน ุฒุฏู ุฑุดู ุฏูู ฑฐ ูููู ุนุฏุฏ

```csharp
object locker = new object();
double total = 0;

Parallel.For(1, 10000000, i =>
{
    lock (locker)
        total += Math.Sqrt(i);
});
```

* ูุฑ iteration ูุงุฒ ุจู **lock** ุฏุงุฑุฏ.
* ฑฐ ูููู lock ุจุงุนุซ **ุงูุช ุดุฏุฏ ฺฉุงุฑุง** ูโุดูุฏ.

**ุชุดุจู:**
ูุฑุถ ฺฉูุฏ ฑฐ ููุฑ ุฒุจุงูู ุฌูุน ูโฺฉููุฏ ู ููู ฺฉ ุณุทู ูุดุชุฑฺฉ ุฏุงุฑูุฏุ ุฒูุงู ุชูู ุดุฏู ุจุฑุง ุตูโุจูุฏ ู contention ุจุณุงุฑ ุฒุงุฏ ุงุณุช.

---

#### ุฑุงู ุญู: **Local Value** (ููุฏุงุฑ ูุญู)

* ูุฑ thread ฺฉ **ููุฏุงุฑ ูุญู** ุฏุงุฑุฏ (ูุซู ุณุทู ุฒุจุงูู ุฎุตูุต).
* ุฏุฑ ูพุงุงู iterationโูุงุ ููุงุฏุฑ ูุญู ุจู ููุฏุงุฑ ุงุตู ุงุถุงูู ูโุดููุฏ.

```csharp
object locker = new object();
double grandTotal = 0;

Parallel.For(
    1, 10000000,
    () => 0.0,  // ููุฏุงุฑ ูุญู ุฌุฏุฏ ุจุฑุง ูุฑ thread
    (i, state, localTotal) => localTotal + Math.Sqrt(i),  // ุจุฏูู ุญููู: ุฌูุน ุจู local
    localTotal => { lock (locker) grandTotal += localTotal; }  // ุฌูุน local ุจู ููุฏุงุฑ ุงุตู
);
```

* ุชููุง lock ุจุง ููุฏุงุฑ ูุญู ุงูุฌุงู ูโุดูุฏุ ูู ุจุฑุง ูุฑ iteration.
* **ฺฉุงุฑุง ุจุณุงุฑ ุจูุชุฑ ุงุฒ ูุณุฎู ูุจู**.

---

#### ูฺฉุชู

* **PLINQ** ุงุบูุจ ุฌุงฺฏุฒู ููุงุณุจ ุงุณุช:

```csharp
ParallelEnumerable.Range(1, 10000000)
                  .Sum(i => Math.Sqrt(i));
```

* ุงุณุชูุงุฏู ุงุฒ `ParallelEnumerable.Range` ุจุงุนุซ **range partitioning** ูโุดูุฏุ ฺฉู ุจุฑุง ุชูุงูโูุง ุจุง ุฒูุงู ูพุฑุฏุงุฒุด ุจุฑุงุจุฑ ุจุณุงุฑ ุจููู ุงุณุช.
* ุจุฑุง ุงูฺฏูุฑุชูโูุง ูพฺุฏูโุชุฑุ ูโุชูุงู ุงุฒ LINQโs `Aggregate` ุจุง seed factory ูุญู ุงุณุชูุงุฏู ฺฉุฑุฏ ฺฉู ูุดุงุจู ููู ููููู Local Value ุฏุฑ Parallel.For ุนูู ูโฺฉูุฏ.

---

#### ุฌูุนโุจูุฏ

* ูุณุฎูโูุง `TLocal` ุฏุฑ `Parallel.For` ู `Parallel.ForEach` ุจุฑุง **ุจูููโุณุงุฒ ุฌูุนโุขูุฑ ุฏุงุฏูโูุง ุฏุฑ ุญูููโูุง ุจุฒุฑฺฏ ู ูพุฑุชฺฉุฑุงุฑ** ุทุฑุงุญ ุดุฏูโุงูุฏ.
* ุงู ุฑูุด ุจุงุนุซ ฺฉุงูุด contention ู overhead ูุฑุจูุท ุจู lockูุง ูโุดูุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-7.jpeg)
</div>

### Task Parallelism ูพุดุฑูุชู ุฏุฑ PFX โก

ุงู ุจุฎุด ุจู **ูฺฺฏโูุง ูพุดุฑูุชู Task Parallel Library (TPL)** ูโูพุฑุฏุงุฒุฏ ฺฉู ุจู ุจุฑูุงููโููุณ ููุงุฒ ฺฉูฺฉ ูโฺฉููุฏ:

* **ุชูุธู ุจุฑูุงููโุฑุฒ (scheduling)** task
* **ุงุฌุงุฏ ุฑุงุจุทู ูุงูุฏ/ูุฑุฒูุฏ** ุจู taskูุง
* **ุงุณุชูุงุฏู ูพุดุฑูุชู ุงุฒ Continuations**
* **TaskFactory**

---

#### ฺฉุงุฑ ุจุง ุชุนุฏุงุฏ ุฒุงุฏ taskูุง

* TPL ุงุฌุงุฒู ูโุฏูุฏ ุตุฏูุง ุง ูุฒุงุฑุงู task ุจุง overhead ฺฉู ุงุฌุงุฏ ฺฉูุฏ.
* ุจุฑุง ููููโูุง taskุ ุจุงุฏ ุขูโูุง ุฑุง ุจู ูุงุญุฏูุง ฺฉุงุฑ ุจุฒุฑฺฏโุชุฑ ุชูุณู ฺฉูุฏ.
* `Parallel` ู `PLINQ` ุงู ฺฉุงุฑ ุฑุง ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุฏููุฏ.

---

#### ุงุฌุงุฏ ู ุดุฑูุน task

* `Task.Run` ฺฉ task ุง `Task<TResult>` ุงุฌุงุฏ ู ุงุฌุฑุง ูโฺฉูุฏ.
* Shortcut ุจุฑุง `Task.Factory.StartNew` ฺฉู **ฺฏุฒููโูุง ุจุดุชุฑ** ุจุฑุง ฺฉูุชุฑู ุฏุงุฑุฏ.

##### ูุซุงู: ุงุฑุณุงู state ุจู task

```csharp
var task = Task.Factory.StartNew(Greet, "Hello");
task.Wait();  // ููุชุธุฑ ุชฺฉูู task
void Greet(object state) { Console.Write(state); }  // ุฎุฑูุฌ: Hello
```

* ููฺูู ูโุชูุงู **ูุงู ูุนูโุฏุงุฑ** ุจุฑุง task ุงุฎุชุตุงุต ุฏุงุฏ:

```csharp
var task = Task.Factory.StartNew(state => Greet("Hello"), "Greeting");
Console.WriteLine(task.AsyncState);  // Greeting
task.Wait();
void Greet(string message) { Console.Write(message); }
```

---

#### TaskCreationOptions

ุจุง ุงู enum ูโุชูุงู **ุฑูุชุงุฑ ุงุฌุฑุง task ุฑุง ุชูุธู ฺฉุฑุฏ**:

* **LongRunning** โ ุงุฎุชุตุงุต ฺฉ thread ูฺู ุจู task (ุจุฑุง taskูุง I/O ุง ุทููุงู ููุฏ).
* **PreferFairness** โ ุชูุงุด ุจุฑุง ุงุฌุฑุง taskูุง ุจู ุชุฑุชุจ ุงุฌุงุฏ.
* **AttachedToParent** โ ุงุฌุงุฏ task ุจู ุนููุงู child ฺฉ task ุฏฺฏุฑ.

---

#### Child Tasks

* ููุช ฺฉ task ุฏฺฏุฑ ุฑุง ุงุฌุงุฏ ูโฺฉูุฏุ ูโุชูุงู ุฑุงุจุทู ูุงูุฏ/ูุฑุฒูุฏ ุงุฌุงุฏ ฺฉุฑุฏ.
* ูุซุงู:

```csharp
Task parent = Task.Factory.StartNew(() =>
{
    Console.WriteLine("I am a parent");
    Task.Factory.StartNew(() => Console.WriteLine("I am detached"));  // Detached
    Task.Factory.StartNew(() => Console.WriteLine("I am a child"), TaskCreationOptions.AttachedToParent);
});
```

* **ูฺฺฏ ููู:** ููฺฏุงู `Wait` ุฑู parentุ taskูุง child ูู ููุชุธุฑ ูโูุงููุฏ ู **ุงุณุชุซูุงูุง child ุจู parent ููุชูู ูโุดููุฏ**.

```csharp
TaskCreationOptions atp = TaskCreationOptions.AttachedToParent;
var parent = Task.Factory.StartNew(() =>
{
    Task.Factory.StartNew(() => 
        Task.Factory.StartNew(() => { throw null; }, atp), atp);
});

parent.Wait();  // NullReferenceException wrapped ุฏุฑ AggregateException
```

---

#### ุงูุชุธุงุฑ ุจุฑุง ฺูุฏ task

* **Task.WaitAll** โ ููุชุธุฑ ุชูุงู taskูุง ูโูุงูุฏ.

* **Task.WaitAny** โ ููุชุธุฑ ุงููู task ุชฺฉููโุดุฏู ูโูุงูุฏ.

* `WaitAll` ุจูููโุชุฑ ุงุฒ ุงูุชุธุงุฑ ฺฉโฺฉ ุงุณุช ู AggregateException ุฑุง ุจุฑุง ููู taskูุง ุฎุทุงุฏุงุฑ ุชููุฏ ูโฺฉูุฏ.

* ููฺูู ูโุชูุงู **timeout** ู **cancellation token** ุจู `Wait` ุฏุงุฏ:

  * ุงู ุจุงุนุซ ูุบู ุงูุชุธุงุฑ ูโุดูุฏุ ูู ุฎูุฏ task.

### ูุบู ู ุงุฏุงูู Taskูุง ุฏุฑ TPL โน๏ธโก๏ธโก๏ธ

#### ูุบู Task ุจุง CancellationToken

* ููฺฏุงู ุดุฑูุน ฺฉ task ูโุชูุงูุฏ ฺฉ **cancellation token** ุจู ุขู ุจุฏูุฏ.
* ุงฺฏุฑ ุจุง `Cancel` ุฑู token ูุฑุงุฎูุงู ุดูุฏุ task ูุงุฑุฏ ุญุงูุช **Canceled** ูโุดูุฏ.

##### ูุซุงู

```csharp
var cts = new CancellationTokenSource();
CancellationToken token = cts.Token;
cts.CancelAfter(500);  // ูุบู ุฎูุฏฺฉุงุฑ ูพุณ ุงุฒ 500ms

Task task = Task.Factory.StartNew(() =>
{
    Thread.Sleep(1000);
    token.ThrowIfCancellationRequested(); // ุจุฑุฑุณ ูุบู
}, token);

try { task.Wait(); }
catch (AggregateException ex)
{
    Console.WriteLine(ex.InnerException is TaskCanceledException); // True
    Console.WriteLine(task.IsCanceled);                             // True
    Console.WriteLine(task.Status);                                 // Canceled
}
```

* `TaskCanceledException` ุงุฒ `OperationCanceledException` ูุดุชู ุดุฏู ุงุณุช.
* ุงฺฏุฑ ุจุฎูุงูุฏ ุฎูุฏุชุงู ฺฉ `OperationCanceledException` ูพุฑุชุงุจ ฺฉูุฏุ **ุญุชูุงู token ุฑุง ุจู ุณุงุฒูุฏู ุจุฏูุฏ** ุชุง ูุถุนุช task ุจู Canceled ุชุบุฑ ฺฉูุฏ ู continuations ุจุง `OnlyOnCanceled` ุงุฌุฑุง ุดููุฏ.
* ุงฺฏุฑ task ูุจู ุงุฒ ุดุฑูุน ูุบู ุดูุฏุ **ููุฑ ฺฉ OperationCanceledException** ุชููุฏ ูโุดูุฏ ู task ุจุฑูุงููโุฑุฒ ููโุดูุฏ.

---

#### ุงูุชุดุงุฑ ูุบู ุจู ุณุงุฑ APIูุง

* ุจุณุงุฑ ุงุฒ APIูุง ูุงููุฏ PLINQ ุงุฒ cancellation token ูพุดุชุจุงู ูโฺฉููุฏ.
* ูุซุงู:

```csharp
var cancelSource = new CancellationTokenSource();
CancellationToken token = cancelSource.Token;

Task task = Task.Factory.StartNew(() =>
{
    var query = someSequence.AsParallel().WithCancellation(token);
    foreach(var item in query) { ... }
});
```

* ูุฑุงุฎูุงู `cancelSource.Cancel()` โ ูุบู query ู task.

---

#### Continuations (ุงุฏุงูู taskูุง) ๐

* `ContinueWith` ฺฉ delegate ุฑุง **ุจูุงูุงุตูู ุจุนุฏ ุงุฒ ูพุงุงู ฺฉ task** ุงุฌุฑุง ูโฺฉูุฏ.
* ูุซุงู ุณุงุฏู:

```csharp
Task task1 = Task.Factory.StartNew(() => Console.Write("antecedent.."));
Task task2 = task1.ContinueWith(ant => Console.Write("..continuation"));
```

* `ant` โ ุงุฑุฌุงุน ุจู task ุงุตู.
* `ContinueWith` ุฎูุฏ task ุฌุฏุฏ ุจุฑูโฺฏุฑุฏุงูุฏ ู ูโุชูุงู **ฺูุฏ continuation ุฒูุฌุฑูโุง** ุงุฌุงุฏ ฺฉุฑุฏ.

##### ุงุฌุฑุง Continuation ุฑู ููุงู thread

```csharp
task1.ContinueWith(ant => ..., TaskContinuationOptions.ExecuteSynchronously);
```

---

#### Continuations ุจุง Task<TResult>

* Continuation ูโุชูุงูุฏ **ููุฏุงุฑ ุจุงุฒฺฏุฑุฏุงูุฏ** ู ุฏุงุฏูโูุง ุฑุง ูพุฑุฏุงุฒุด ฺฉูุฏ:

```csharp
Task.Factory.StartNew<int>(() => 8)
    .ContinueWith(ant => ant.Result * 2)
    .ContinueWith(ant => Math.Sqrt(ant.Result))
    .ContinueWith(ant => Console.WriteLine(ant.Result));  // 4
```

---

#### Continuations ู Exception

* Continuation ูโุชูุงูุฏ ุจุฑุฑุณ ฺฉูุฏ ุขุง antecedent ุฎุทุง ุฏุงุฏู (`ant.Exception`) ุง ุงุฒ `Result/Wait` ุงุณุชูุงุฏู ฺฉูุฏ.
* ุงฺฏุฑ continuation exception ุฑุง ูุจูุฏุ **UnobservedTaskException** ุฑุฎ ูโุฏูุฏ.
* ุงูฺฏู ุงูู:

```csharp
Task continuation = Task.Factory.StartNew(() => { throw null; })
    .ContinueWith(ant => { ant.Wait(); /* ุงุฏุงูู ูพุฑุฏุงุฒุด */ });
continuation.Wait();  // exception ูพุฑุชุงุจ ูโุดูุฏ
```

* ูโุชูุงู continuations ูุฎุชูู ุจุฑุง **ููุงุฑุฏ ุฎุทุง ู ุบุฑุฎุทุง** ุชุนุฑู ฺฉุฑุฏ:

```csharp
Task task1 = Task.Factory.StartNew(() => { throw null; });
Task error = task1.ContinueWith(ant => Console.Write(ant.Exception),
                                TaskContinuationOptions.OnlyOnFaulted);
Task ok = task1.ContinueWith(ant => Console.Write("Success!"),
                             TaskContinuationOptions.NotOnFaulted);
```

* ุจุฑุง ุตุฑู ูุธุฑ ุงุฒ ุงุณุชุซูุงูุง:

```csharp
public static void IgnoreExceptions(this Task task)
{
    task.ContinueWith(t => { var ignore = t.Exception; },
                      TaskContinuationOptions.OnlyOnFaulted);
}

Task.Factory.StartNew(() => { throw null; }).IgnoreExceptions();
```

---

#### Continuations ู Child Tasks ๐ถ

* Continuation **ุชููุง ุฒูุงู ุงุฌุฑุง ูโุดูุฏ ฺฉู ุชูุงู child taskูุง ฺฉุงูู ุดููุฏ**.
* ุงุณุชุซูุงูุง childูุง ุจู continuation ููุชูู ูโุดููุฏ:

```csharp
TaskCreationOptions atp = TaskCreationOptions.AttachedToParent;

Task.Factory.StartNew(() =>
{
    Task.Factory.StartNew(() => { throw null; }, atp);
    Task.Factory.StartNew(() => { throw null; }, atp);
    Task.Factory.StartNew(() => { throw null; }, atp);
})
.ContinueWith(p => Console.WriteLine(p.Exception),
              TaskContinuationOptions.OnlyOnFaulted);
```

* ุงู ุงูฺฉุงู ุฑุง ูโุฏูุฏ ฺฉู **ฺูุฏ ุฎุทุง ููุฒูุงู ุฑุง ฺฉุฌุง ูุฏุฑุช** ฺฉูุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-8.jpeg)
</div>

### ุงุฏุงููโูุง ุดุฑุท ุฏุฑ Taskูุง (Conditional Continuations) โก

* ุจู ุทูุฑ ูพุดโูุฑุถุ ฺฉ **continuation** ุจุฏูู ุดุฑุท ุจุฑูุงููโุฑุฒ ูโุดูุฏุ ฺู task ุงุตู (antecedent) ูููู ุจุงุดุฏุ ฺู ุฎุทุง ุฏูุฏ ุง ูุบู ุดูุฏ.
* ูโุชูุงู ุฑูุชุงุฑ ุงุฌุฑุง continuation ุฑุง ุจุง **TaskContinuationOptions** ุชุบุฑ ุฏุงุฏ.

#### ุณู ููฺฏ ุงุตู

| ููฺฏ                    | ุชูุถุญ                                      |
| ---------------------- | ------------------------------------------ |
| `NotOnRanToCompletion` | ุงุฌุฑุง ูุดูุฏ ุงฺฏุฑ antecedent ุจุง ููููุช ฺฉุงูู ุดุฏ |
| `NotOnFaulted`         | ุงุฌุฑุง ูุดูุฏ ุงฺฏุฑ antecedent ุฎุทุง ุฏุงุฏ           |
| `NotOnCanceled`        | ุงุฌุฑุง ูุดูุฏ ุงฺฏุฑ antecedent ูุบู ุดุฏ            |

* ุงู ููฺฏโูุง **ุญุฐูโฺฉููุฏู** ูุณุชูุฏ: ูุฑ ฺู ุจุดุชุฑ ุงุนูุงู ฺฉูุฏุ ุงุญุชูุงู ุงุฌุฑุง continuation ฺฉูุชุฑ ูโุดูุฏ.

#### ููุงุฏุฑ ุชุฑฺฉุจ ุฑุงุฌ

| ููุฏุงุฑ                   | ุชุฑฺฉุจ ููฺฏโูุง          |                |
| ----------------------- | --------------------- | -------------- |
| `OnlyOnRanToCompletion` | `NotOnFaulted         | NotOnCanceled` |
| `OnlyOnFaulted`         | `NotOnRanToCompletion | NotOnCanceled` |
| `OnlyOnCanceled`        | `NotOnRanToCompletion | NotOnFaulted`  |

* ุชุฑฺฉุจ ูููโ Not*โูุง ููุทู ูุณุชุ ุฒุฑุง ููุฌุฑ ุจู **ูุบู ุฏุงุฆู continuation** ูโุดูุฏ.

---

#### ูุนุงู ูุถุนุช antecedent

| ูุถุนุช             | ุชูุถุญ                                                   |
| ----------------- | ------------------------------------------------------- |
| `RanToCompletion` | ููููุช ุจุฏูู ูุบู ุง exception                            |
| `Faulted`         | ฺฉ ุงุณุชุซูุง ุฑุฎ ุฏุงุฏู ุงุณุช                                   |
| `Canceled`        | antecedent ุจุง token ูุบู ุดุฏู ุง ุงุฏุงูู ุดุฑุท ุงุฌุฑุง ูุดุฏู ุงุณุช |

> ููู: ุงฺฏุฑ continuation ุจู ุฏูู ุงู ููฺฏโูุง ุงุฌุฑุง ูุดูุฏุ **ูุบู ูโุดูุฏ** ูู ูุฑุงููุด ููโุดูุฏ. ุจูุงุจุฑุงู ูุฑ continuation ุฑู ุขู continuation ูโุชูุงูุฏ ุงุฌุฑุง ุดูุฏ ูฺฏุฑ ุงูฺฉู ุดุฑุท `NotOnCanceled` ุงุนูุงู ุดุฏู ุจุงุดุฏ.

---

#### ูุซุงู ุนูู

```csharp
Task t1 = Task.Factory.StartNew(() => { /* ฺฉุงุฑ ุงุตู */ });

// ุงุฏุงูู ููุท ุฏุฑ ุตูุฑุช ุฎุทุง
Task fault = t1.ContinueWith(
    ant => Console.WriteLine("fault"),
    TaskContinuationOptions.OnlyOnFaulted
);

// ุงุฏุงูู ุฑู continuation ูุจู
Task t3 = fault.ContinueWith(
    ant => Console.WriteLine("t3")  // ุงู ููุดู ุงุฌุฑุง ูโุดูุฏ!
);

// ุงฺฏุฑ ุจุฎูุงูู t3 ุชููุง ููุช ุงุฌุฑุง ุดูุฏ ฺฉู fault ุงุฌุฑุง ุดุฏู:
Task t3_conditional = fault.ContinueWith(
    ant => Console.WriteLine("t3"),
    TaskContinuationOptions.NotOnCanceled
);
```

* ูฺฉุชู ฺฉูุฏ: **t3_conditional** ุชููุง ููุช ุงุฌุฑุง ูโุดูุฏ ฺฉู `fault` ูุงูุนุงู ุงุฌุฑุง ุดุฏู ุจุงุดุฏ.
* ุจุฏูู ุดุฑุท `NotOnCanceled`ุ ุญุช ุงฺฏุฑ `fault` ุงุฌุฑุง ูุดูุฏ (ูุบู ุดูุฏ)ุ `t3` ุงุฌุฑุง ูโุดูุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-9.jpeg)
</div>

### Continuations ุจุง ฺูุฏ antecedent ู TaskFactory ๐๏ธ

#### 1๏ธโฃ Continuations ุจุง ฺูุฏ antecedent

* ูโุชูุงู ฺฉ continuation ุฑุง ุทูุฑ ุจุฑูุงููโุฑุฒ ฺฉุฑุฏ ฺฉู ุจุนุฏ ุงุฒ ุงุชูุงู **ฺูุฏ task** ุงุฌุฑุง ุดูุฏ.
* ุฏู ุฑูุด ุงุตู ุฏุฑ **TaskFactory** ูุฌูุฏ ุฏุงุฑุฏ:

| ุฑูุด               | ุชูุถุญ                                                      |
| ----------------- | ---------------------------------------------------------- |
| `ContinueWhenAll` | continuation ูพุณ ุงุฒ ุงุชูุงู ููู antecedentูุง ุงุฌุฑุง ูโุดูุฏ      |
| `ContinueWhenAny` | continuation ูพุณ ุงุฒ ุงุชูุงู ูุฑ ฺฉ ุงุฒ antecedentูุง ุงุฌุฑุง ูโุดูุฏ |

> ูุซุงู ุจุง `ContinueWhenAll`:

```csharp
var task1 = Task.Run(() => Console.Write("X"));
var task2 = Task.Run(() => Console.Write("Y"));

var continuation = Task.Factory.ContinueWhenAll(
    new[] { task1, task2 },
    tasks => Console.WriteLine("Done")
);
```

* ููุงู ูุชุฌู ุจุง **task combinator** `WhenAll`:

```csharp
var continuation = Task.WhenAll(task1, task2)
                       .ContinueWith(ant => Console.WriteLine("Done"));
```

---

#### 2๏ธโฃ ฺูุฏ continuation ุฑู ฺฉ antecedent

* ูโุชูุงู ฺูุฏ `ContinueWith` ุฑู ฺฉ task ูุงุญุฏ ุตุฏุง ุฒุฏ.
* ููู continuationูุง ูพุณ ุงุฒ ูพุงุงู antecedent ุดุฑูุน ูโุดููุฏ (ูฺฏุฑ ฺฏุฒูู `ExecuteSynchronously` ูุดุฎุต ุดูุฏ).

```csharp
var t = Task.Factory.StartNew(() => Thread.Sleep(1000));
t.ContinueWith(ant => Console.Write("X"));
t.ContinueWith(ant => Console.Write("Y"));
// ุฎุฑูุฌ ูโุชูุงูุฏ XY ุง YX ุจุงุดุฏ
```

---

#### 3๏ธโฃ Task Schedulers ๐๏ธ

* **TaskScheduler** ฺฉุงุฑ ุชุฎุตุต task ุจู threadูุง ุฑุง ุงูุฌุงู ูโุฏูุฏ.
* ุฏู ูพุงุฏูโุณุงุฒ ุงุณุชุงูุฏุงุฑุฏ:

  1. **Default scheduler:** ุจุง CLR thread pool ฺฉุงุฑ ูโฺฉูุฏ.
  2. **Synchronization context scheduler:** ุจุฑุง UI ูุซู WPF ุง Windows Formsุ ุชุง ููุท thread ุงุฌุงุฏฺฉููุฏู ฺฉูุชุฑูโูุง ุจู ุขููุง ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดุฏ.

> ูุซุงู: ุงุฌุฑุง ฺฉ continuation ุฑู UI thread:

```csharp
_uiScheduler = TaskScheduler.FromCurrentSynchronizationContext();
Task.Run(() => Foo())
    .ContinueWith(ant => lblResult.Content = ant.Result, _uiScheduler);
```

* ููฺูู ุงูฺฉุงู ููุดุชู TaskScheduler ุณูุงุฑุด ุจุง subclassing ูุฌูุฏ ุฏุงุฑุฏุ ูู ุจุดุชุฑ ุฏุฑ ุณูุงุฑููุง ุฎุงุต ฺฉุงุฑุจุฑุฏ ุฏุงุฑุฏ.

---

#### 4๏ธโฃ TaskFactory ๐ญ

* `Task.Factory` ฺฉ **TaskFactory ูพุดโูุฑุถ** ุจุงุฒูโฺฏุฑุฏุงูุฏ.

* ฺฉุงุฑฺฉุฑุฏ ุงุตู: ุงุฌุงุฏ ุณู ููุน task:

  1. Ordinary tasks (`StartNew`)
  2. Continuations ุจุง ฺูุฏ antecedent (`ContinueWhenAll`, `ContinueWhenAny`)
  3. Tasks ฺฉู ูุชุฏูุง ูุฏู APM ุฑุง wrap ูโฺฉููุฏ (`FromAsync`)

* ูโุชูุงู TaskFactory ุฎูุฏ ุฑุง ุจุง ููุงุฏุฑ ูพุดโูุฑุถ ุณูุงุฑุด ุณุงุฎุช:

```csharp
var factory = new TaskFactory(
    TaskCreationOptions.LongRunning | TaskCreationOptions.AttachedToParent,
    TaskContinuationOptions.None
);

// ุงุณุชูุงุฏู ุงุฒ factory ุจุฑุง ุงุฌุงุฏ taskูุง
Task task1 = factory.StartNew(Method1);
Task task2 = factory.StartNew(Method2);
```

* ูุฒุช: ุงุฏุงููโูุง ู taskูุง ุจู ุตูุฑุช ฺฉูพุงุฑฺู ุจุง ููุงู ุชูุธูุงุช ุณูุงุฑุด ุงุฌุฑุง ูโุดููุฏ.

### ฺฉุงุฑ ุจุง AggregateException โ๏ธ

ููุงูโุทูุฑ ฺฉู ุฏุฏูุ **PLINQ**ุ ฺฉูุงุณ **Parallel** ู **Tasks** ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุงุณุชุซูุงูุง ุฑุง ุจู ูุตุฑูโฺฉููุฏู ููุชูู ูโฺฉููุฏ. ุจุฑุง ุฏุฑฺฉ ุงููุช ุงู ููุถูุนุ ูุฑุถ ฺฉูุฏ ฺฉูุฆุฑ LINQ ุฒุฑ ุฑุง ุฏุงุฑู ฺฉู ุฏุฑ ุงููู ุชฺฉุฑุงุฑุ ฺฉ **DivideByZeroException** ุงุฌุงุฏ ูโฺฉูุฏ:

```csharp
try
{
    var query = from i in Enumerable.Range(0, 1000000)
                select 100 / i;
    ...
}
catch (DivideByZeroException)
{
    ...
}
```

ุงฺฏุฑ ุงุฒ PLINQ ุจุฎูุงูู ุงู ฺฉูุฆุฑ ุฑุง ููุงุฒโุณุงุฒ ฺฉูุฏ ู ุฑุณุฏฺฏ ุจู ุงุณุชุซูุงูุง ุฑุง ูุงุฏุฏู ุจฺฏุฑุฏุ ุงุญุชูุงูุงู **DivideByZeroException** ุฏุฑ ฺฉ ูุฎ (Thread) ุฌุฏุงฺฏุงูู ุฑุฎ ุฎูุงูุฏ ุฏุงุฏุ ุจุฏูู ุขู ฺฉู ุจูุงฺฉ `catch` ูุง ุงุฌุฑุง ุดูุฏ ู ุจุงุนุซ ฺฉุฑุด ฺฉุฑุฏู ุจุฑูุงูู ุฎูุงูุฏ ุดุฏ.

ุจูุงุจุฑุงูุ ุงุณุชุซูุงูุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ฺฏุฑูุชู ุดุฏู ู ุฏูุจุงุฑู ุจู ูุฑุงุฎูุงููุฏู ูพุฑุชุงุจ ูโุดููุฏ. ุงูุง ูุชุฃุณูุงูู ููุถูุน ุจู ุณุงุฏฺฏ ฺฏุฑูุชู ฺฉ **DivideByZeroException** ูุณุช. ฺูู ุงู ฺฉุชุงุจุฎุงููโูุง ุงุฒ ฺูุฏู ูุฎ ุงุณุชูุงุฏู ูโฺฉููุฏุ ููฺฉู ุงุณุช ุฏู ุง ฺูุฏ ุงุณุชุซูุง ููุฒูุงู ูพุฑุชุงุจ ุดููุฏ. ุจุฑุง ุงุทููุงู ุงุฒ ฺฏุฒุงุฑุด ููู ุงุณุชุซูุงูุงุ ุขูโูุง ุฏุงุฎู ฺฉ **AggregateException** ูุฑุงุฑ ูโฺฏุฑูุฏ ฺฉู ูพุฑุงูพุฑุช **InnerExceptions** ุขู ุดุงูู ููู ุงุณุชุซูุงูุง ฺฏุฑูุชู ุดุฏู ุงุณุช:

```csharp
try
{
    var query = from i in ParallelEnumerable.Range(0, 1000000)
                select 100 / i;
    // ุงุฌุฑุง ฺฉูุฆุฑ
    ...
}
catch (AggregateException aex)
{
    foreach (Exception ex in aex.InnerExceptions)
        Console.WriteLine(ex.Message);
}
```

ูุฑ ุฏู **PLINQ** ู ฺฉูุงุณ **Parallel** ุงุฌุฑุง ฺฉูุฆุฑ ุง ุญููู ุฑุง ุจุง ุงููู ุงุณุชุซูุง ุฎุงุชูู ูโุฏููุฏ ู ุนูุงุตุฑ ุง ุจุฏูู ุญูููโูุง ุจุนุฏ ูพุฑุฏุงุฒุด ููโุดููุฏ. ููฺฉู ุงุณุช ูุจู ุงุฒ ูพุงุงู ฺุฑุฎู ุฌุงุฑุ ุงุณุชุซูุงูุง ุฏฺฏุฑ ูู ูพุฑุชุงุจ ุดููุฏ. ุงููู ุงุณุชุซูุง ุฏุฑ **AggregateException** ุงุฒ ุทุฑู ูพุฑุงูพุฑุช **InnerException** ุฏุฑ ุฏุณุชุฑุณ ุงุณุช.

---

### Flatten ู Handle ๐๏ธ

ฺฉูุงุณ **AggregateException** ุฏู ุฑูุด ุจุฑุง ุณุงุฏูโุณุงุฒ ูุฏุฑุช ุงุณุชุซูุง ุงุฑุงุฆู ูโุฏูุฏ: **Flatten** ู **Handle**.

#### Flatten

ุงุบูุจ **AggregateException** ุดุงูู **AggregateException**ูุง ุฏฺฏุฑ ูุฒ ูโุดูุฏ. ุงู ุญุงูุช ูุนูููุงู ุฒูุงู ุฑุฎ ูโุฏูุฏ ฺฉู ฺฉ **Child Task** ุงุณุชุซูุง ูพุฑุชุงุจ ฺฉูุฏ. ุจุง ุงุณุชูุงุฏู ุงุฒ **Flatten** ูโุชูุงู ูุฑ ุณุทุญ ุงุฒ ุชูุฏุฑุชู ุฑุง ุญุฐู ฺฉุฑุฏ ุชุง ูุฏุฑุช ุณุงุฏูโุชุฑ ุดูุฏ. ุงู ูุชุฏ ฺฉ **AggregateException** ุฌุฏุฏ ุจุง ูุณุช ูุณุทุญ ุงุฒ ุงุณุชุซูุงูุง ุฏุงุฎู ุจุฑูโฺฏุฑุฏุงูุฏ:

```csharp
catch (AggregateException aex)
{
    foreach (Exception ex in aex.Flatten().InnerExceptions)
        myLogWriter.LogException(ex);
}
```

#### Handle

ฺฏุงู ูุงุฒู ุงุณุช ููุท ููุน ุฎุงุต ุงุฒ ุงุณุชุซูุงูุง ฺฏุฑูุชู ุดููุฏ ู ุจูู ุฏูุจุงุฑู ูพุฑุชุงุจ ุดููุฏ. ูุชุฏ **Handle** ุงู ฺฉุงุฑ ุฑุง ุณุงุฏู ูโฺฉูุฏ. ุงู ูุชุฏ ฺฉ **predicate** ุงุฒ ููุน `Func<Exception, bool>` ูโฺฏุฑุฏ ู ุฑู ูุฑ ุงุณุชุซูุง ุฏุงุฎู ุงุฌุฑุง ูโฺฉูุฏ:

```csharp
public void Handle(Func<Exception, bool> predicate)
```

ุงฺฏุฑ **predicate** ููุฏุงุฑ `true` ุจุฑฺฏุฑุฏุงูุฏุ ุขู ุงุณุชุซูุง "ูุฏุฑุช ุดุฏู" ูุญุณูุจ ูโุดูุฏ. ูพุณ ุงุฒ ุงุฌุฑุง delegate ุฑู ููู ุงุณุชุซูุงูุง:

* ุงฺฏุฑ ููู ุงุณุชุซูุงูุง ูุฏุฑุช ุดุฏู ุจุงุดูุฏุ ุฏูุจุงุฑู ูพุฑุชุงุจ ููโุดููุฏ.
* ุงฺฏุฑ ุงุณุชุซูุง ูุฏุฑุช ูุดุฏู ุจุงุดุฏ (`false`)ุ ฺฉ **AggregateException** ุฌุฏุฏ ุดุงูู ุขู ุงุณุชุซูุงูุง ุงุฌุงุฏ ุดุฏู ู ูพุฑุชุงุจ ูโุดูุฏ.

ูุซุงู ุฒุฑ ฺฉ **AggregateException** ุฏฺฏุฑ ุดุงูู ฺฉ **NullReferenceException** ุงุฌุงุฏ ูโฺฉูุฏ:

```csharp
var parent = Task.Factory.StartNew(() => 
{
    int[] numbers = { 0 };
    var childFactory = new TaskFactory(TaskCreationOptions.AttachedToParent, TaskContinuationOptions.None);
    childFactory.StartNew(() => 5 / numbers[0]);   // ุชูุณู ุจุฑ ุตูุฑ
    childFactory.StartNew(() => numbers[1]);       // ุฎุงุฑุฌ ุงุฒ ูุญุฏูุฏู
    childFactory.StartNew(() => { throw null; });  // ุงุฑุฌุงุน null
});

try { parent.Wait(); }
catch (AggregateException aex)
{
    aex.Flatten().Handle(ex => // ูุงุฒ ุจู Flatten ุฏุงุฑู
    {
        if (ex is DivideByZeroException)
        {
            Console.WriteLine("Divide by zero");
            return true; // ูุฏุฑุช ุดุฏ
        }
        if (ex is IndexOutOfRangeException)
        {
            Console.WriteLine("Index out of range");
            return true; // ูุฏุฑุช ุดุฏ
        }
        return false; // ุณุงุฑ ุงุณุชุซูุงูุง ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดููุฏ
    });
}
```

---

### ูุฌููุนูโูุง ููุฒูุงู (Concurrent Collections) ๐๏ธ

.NET ูุฌููุนูโูุง **Thread-Safe** ุฑุง ุฏุฑ ูุถุง ูุงู **System.Collections.Concurrent** ุงุฑุงุฆู ูโุฏูุฏุ ฺฉู ุจุฑุง ูุฏุฑุช ุฏุงุฏูโูุง ุฏุฑ ูุญุทโูุง ฺูุฏูุฎ ุจุณุงุฑ ููุฏ ูุณุชูุฏ.

 <div align="center">

![Conventions-UsedThis-Book](../../../assets/image/22/Table-22-10.jpeg)
</div>

### ูุฌููุนูโูุง ููุฒูุงู (Concurrent Collections) ๐๏ธ

ูุฌููุนูโูุง **ููุฒูุงู** ุจุฑุง ุณูุงุฑููุง **ุจุง ููโุฒูุงู ุจุงูุง** ุจูููโุณุงุฒ ุดุฏูโุงูุฏุ ุจุง ุงู ุญุงูุ ูุฑ ุฒูุงู ฺฉู ุจู ฺฉ **ูุฌููุนู Thread-Safe** ูุงุฒ ุฏุงุดุชู ุจุงุดุฏ (ุจู ุฌุง ุงุณุชูุงุฏู ุงุฒ ููู ุฑู ฺฉ ูุฌููุนู ุนุงุฏ) ูู ูโุชูุงููุฏ ููุฏ ุจุงุดูุฏ. ุจุง ุงู ุญุงูุ ฺูุฏ ูฺฉุชู ููู ูุฌูุฏ ุฏุงุฑุฏ:

* ูุฌููุนูโูุง **ุณูุช** ุฏุฑ ููู ุณูุงุฑููุง ุจู ุฌุฒ ููุงุฑุฏ ุจุง **ููโุฒูุงู ุจุณุงุฑ ุจุงูุง** ุนููฺฉุฑุฏ ุจูุชุฑ ุฏุงุฑูุฏ.
* ฺฉ ูุฌููุนู **Thread-Safe** ุชุถูู ููโฺฉูุฏ ฺฉู ฺฉุฏ ฺฉู ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉูุฏ ูุฒ **Thread-Safe** ุจุงุดุฏ (ุจู ูุตู ยซLocking and Thread Safetyยป ุตูุญู 898 ูุฑุงุฌุนู ฺฉูุฏ).
* ุงฺฏุฑ ุฑู ฺฉ ูุฌููุนู ููุฒูุงู ุฏุฑ ุญุงู ฺฉู ูุฎ ุฏฺฏุฑ ุฏุฑ ุญุงู ุชุบุฑ ุขู ุงุณุชุ **Enumeration** ุงูุฌุงู ุฏูุฏุ ูฺ ุงุณุชุซูุง ูพุฑุชุงุจ ููโุดูุฏุ ุจูฺฉู ุชุฑฺฉุจ ุงุฒ ูุญุชูุง ูุฏู ู ุฌุฏุฏ ูุดุงูุฏู ุฎูุงูุฏ ฺฉุฑุฏ.
* ูุณุฎู ููุฒูุงู ุงุฒ **List<T>** ูุฌูุฏ ูุฏุงุฑุฏ.
* ฺฉูุงุณโูุง **ConcurrentStack**ุ **ConcurrentQueue** ู **ConcurrentBag** ุจูโุตูุฑุช ุฏุงุฎู ุจุง **ูุณุชโูุง ูพููุฏ** ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏ. ุงู ุจุงุนุซ ูโุดูุฏ ฺฉู ูุตุฑู ุญุงูุธู ุขูโูุง ูุณุจุช ุจู **Stack** ู **Queue** ุบุฑููุฒูุงู ุจุดุชุฑ ุจุงุดุฏุ ุงูุง ุฏุณุชุฑุณ ููุฒูุงู ุฑุง ุจููู ูโฺฉูุฏุ ุฒุฑุง ูุณุชโูุง ูพููุฏ ุจุฑุง ูพุงุฏูโุณุงุฒโูุง ุจุฏูู ููู ุง ฺฉูโููู ููุงุณุจโุงูุฏ. (ฺุฑุง ฺฉู ุงุถุงูู ฺฉุฑุฏู ฺฉ ฺฏุฑู ุจู ูุณุช ูพููุฏ ุชููุง ูุงุฒููุฏ ุจูโุฑูุฒุฑุณุงู ฺูุฏ ูุฑุฌุน ุงุณุชุ ุฏุฑ ุญุงู ฺฉู ุงุถุงูู ฺฉุฑุฏู ฺฉ ุนูุตุฑ ุจู ุณุงุฎุชุงุฑ ุดุจู **List<T>** ููฺฉู ุงุณุช ูุงุฒ ุจู ุฌุงุจูโุฌุง ูุฒุงุฑุงู ุนูุตุฑ ุฏุงุดุชู ุจุงุดุฏ.)

ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุงู ูุฌููุนูโูุง ุตุฑูุงู ุฌุงฺฏุฒู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ **ฺฉ ูุฌููุนู ุนุงุฏ ุจุง ููู** ูุณุชูุฏ. ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉุฏ ุฒุฑ ุฑุง ุฑู ฺฉ ูุฎ ุงุฌุฑุง ฺฉูู:

```csharp
var d = new ConcurrentDictionary<int,int>();
for (int i = 0; i < 1000000; i++) d[i] = 123;
```

ุงู ฺฉุฏ **ุณู ุจุฑุงุจุฑ ฺฉูุฏุชุฑ** ุงุฒ ุญุงูุช ุฒุฑ ุงุฌุฑุง ูโุดูุฏ:

```csharp
var d = new Dictionary<int,int>();
for (int i = 0; i < 1000000; i++) lock (d) d[i] = 123;
```

(ุจุง ุงู ุญุงูุ **ุฎูุงูุฏู ุงุฒ ConcurrentDictionary** ุณุฑุน ุงุณุชุ ุฒุฑุง ุจุฏูู ููู ุงูุฌุงู ูโุดูุฏ.)

---

ูุฌููุนูโูุง ููุฒูุงู ููฺูู ุจุง ูุฌููุนูโูุง ูุนููู ูุชูุงูุชโุงูุฏุ ุฒุฑุง **ูุชุฏูุง ูฺูโุง ุจุฑุง ุงูุฌุงู ุนููุงุชโูุง ุงุชูฺฉ Test-and-Act** ุงุฑุงุฆู ูโฺฉููุฏุ ูุงููุฏ **TryPop**. ุงฺฉุซุฑ ุงู ูุชุฏูุง ุงุฒ ุทุฑู **ุฑุงุจุท IProducerConsumerCollection<T>** ฺฉูพุงุฑฺู ุดุฏูโุงูุฏ.

---

### IProducerConsumerCollection<T> โ๏ธ

ฺฉ **ูุฌููุนู Producer/Consumer** ูุฌููุนูโุง ุงุณุช ฺฉู ุฏู ฺฉุงุฑุจุฑุฏ ุงุตู ุฏุงุฑุฏ:

* **ุงุถุงูู ฺฉุฑุฏู ฺฉ ุนูุตุฑ ("Producing")**
* **ุฏุฑุงูุช ู ุญุฐู ฺฉ ุนูุตุฑ ("Consuming")**

ูุซุงูโูุง ฺฉูุงุณฺฉ ุงู ููุน ูุฌููุนูโูุงุ **Stack** ู **Queue** ูุณุชูุฏ. ุงู ูุฌููุนูโูุง ุฏุฑ ุจุฑูุงููโููุณ ููุงุฒ ุงููุช ุฏุงุฑูุฏ ุฒุฑุง ุจุฑุง ูพุงุฏูโุณุงุฒโูุง **lock-free** ุจูููโุงูุฏ.

ุฑุงุจุท **IProducerConsumerCollection<T>** ููุงุงูฺฏุฑ ฺฉ **ูุฌููุนู Producer/Consumer ุงูู ุจุฑุง ูุฎโูุง** ุงุณุช. ฺฉูุงุณโูุง ุฒุฑ ุงู ุฑุงุจุท ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉููุฏ:

* **ConcurrentStack<T>**
* **ConcurrentQueue<T>**
* **ConcurrentBag<T>**

ุงู ุฑุงุจุท ุงุฒ **ICollection** ุงุฑุซโุจุฑ ูโฺฉูุฏ ู ูุชุฏูุง ุฒุฑ ุฑุง ุงุถุงูู ูโฺฉูุฏ:

```csharp
void CopyTo(T[] array, int index);
T[] ToArray();
bool TryAdd(T item);
bool TryTake(out T item);
```

* **TryAdd** ู **TryTake** ุจุฑุฑุณ ูโฺฉููุฏ ฺฉู ุขุง ูโุชูุงู ุนููุงุช ุงูุฒูุฏู ุง ุญุฐู ุฑุง ุงูุฌุงู ุฏุงุฏุ ุงฺฏุฑ ููฺฉู ุจุงุดุฏุ ุขู ุฑุง ุงูุฌุงู ูโุฏููุฏ. ุชุณุช ู ุนูู ุจูโุตูุฑุช **ุงุชูฺฉ** ุงูุฌุงู ูโุดูุฏุ ุจูุงุจุฑุงู ูุงุฒ ุจู ููู ูุงููุฏ ูุฌููุนูโูุง ูุนููู ูุณุช:

```csharp
int result;
lock (myStack) if (myStack.Count > 0) result = myStack.Pop();
```

* **TryTake** ุงฺฏุฑ ูุฌููุนู ุฎุงู ุจุงุดุฏุ ููุฏุงุฑ `false` ุจุฑูโฺฏุฑุฏุงูุฏ.
* **TryAdd** ุฏุฑ ุณู ูพุงุฏูโุณุงุฒ ุงุฑุงุฆูโุดุฏู ููุดู ูููู ุงุณุช ู `true` ุจุฑูโฺฏุฑุฏุงูุฏ.
* ุงฺฏุฑ ุดูุง ูุฌููุนู ููุฒูุงู ุฎูุฏ ุฑุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ ฺฉู ุนูุงุตุฑ ุชฺฉุฑุงุฑ ุฑุง ุงุฌุงุฒู ูุฏูุฏุ ูโุชูุงูุฏ **TryAdd** ุฑุง ุทูุฑ ูพุงุฏูโุณุงุฒ ฺฉูุฏ ฺฉู ุฏุฑ ุตูุฑุช ูุฌูุฏ ุนูุตุฑุ `false` ุจุฑฺฏุฑุฏุงูุฏ (ูุซูุงู ฺฉ **Concurrent Set**).

ุนูุตุฑ ฺฉู **TryTake** ุญุฐู ูโฺฉูุฏุ ุชูุณุท ุฒุฑฺฉูุงุณ ุชุนู ูโุดูุฏ:

* ุฏุฑ **Stack**ุ ุขุฎุฑู ุนูุตุฑ ุงุถุงููโุดุฏู ุญุฐู ูโุดูุฏ.
* ุฏุฑ **Queue**ุ ุงููู ุนูุตุฑ ุงุถุงููโุดุฏู ุญุฐู ูโุดูุฏ.
* ุฏุฑ **Bag**ุ ูุฑ ุนูุตุฑ ฺฉู ุจุชูุงูุฏ ุจูโุตูุฑุช ุจููู ุญุฐู ุดูุฏุ ุญุฐู ูโุดูุฏ.

ุณู ฺฉูุงุณ ุงุตู ูุนูููุงู **TryTake** ู **TryAdd** ุฑุง ุจูโุตูุฑุช ุตุฑุญ ูพุงุฏูโุณุงุฒ ูโฺฉููุฏ ู ููุงู ุนููฺฉุฑุฏ ุฑุง ุงุฒ ุทุฑู ูุชุฏูุง ุนููู ุจุง ูุงูโูุง ุฎุงุตโุชุฑ ูุงููุฏ **TryDequeue** ู **TryPop** ุฏุฑ ุงุฎุชุงุฑ ูุฑุงุฑ ูโุฏููุฏ.

### ConcurrentBag<T> ๐

ฺฉูุงุณ **ConcurrentBag<T>** ฺฉ ูุฌููุนู **ุจุฏูู ุชุฑุชุจ** ุงุฒ ุงุดุงุก ุฐุฎุฑู ูโฺฉูุฏ ู **ุชฺฉุฑุงุฑ ุจูุฏู ุนูุงุตุฑ ูุฌุงุฒ ุงุณุช**. ุงู ฺฉูุงุณ ุจุฑุง ููุงูุน ููุงุณุจ ุงุณุช ฺฉู **ุจุฑุงุชุงู ููู ูุณุช ฺู ุนูุตุฑ ููฺฏุงู ูุฑุงุฎูุงู Take ุง TryTake ุฏุฑุงูุช ูโฺฉูุฏ**.

ูุฒุช **ConcurrentBag<T>** ูุณุจุช ุจู **ConcurrentQueue** ุง **ConcurrentStack** ุงู ุงุณุช ฺฉู ูุชุฏ **Add** ุขู ุชูุฑุจุงู ูฺ **ููโุฒูุงู (contention)** ุงุฌุงุฏ ููโฺฉูุฏ ุญุช ููุช ุชูุณุท ฺูุฏู ูุฎ ุจูโุทูุฑ ููุฒูุงู ูุฑุงุฎูุงู ุดูุฏ.

ุฏุฑ ููุงุจูุ ูุฑุงุฎูุงู **Add** ุจูโุตูุฑุช ููุงุฒ ุฑู **Queue** ุง **Stack** ฺฉู ููโุฒูุงู ุงุฌุงุฏ ูโฺฉูุฏ (ูุฑฺูุฏ ุจุณุงุฑ ฺฉูุชุฑ ุงุฒ ูููโฺฏุฐุงุฑ ุฑู ฺฉ ูุฌููุนู ุบุฑููุฒูุงู). ูุฑุงุฎูุงู **Take** ุฑู ฺฉ **ConcurrentBag** ูุฒ ุจุณุงุฑ ุจููู ุงุณุชุ ุจู ุดุฑุท ุขู ฺฉู ูุฑ ูุฎ ุจุดุชุฑ ุงุฒ ุชุนุฏุงุฏ ุนูุงุตุฑ ฺฉู ุงุถุงูู ฺฉุฑุฏูุ ุนูุตุฑ ูฺฏุฑุฏ.

ุฏุฑ ุฏุงุฎู **ConcurrentBag**ุ ูุฑ ูุฎ **ูุณุช ูพููุฏ ุฎุตูุต ุฎูุฏ** ุฑุง ุฏุงุฑุฏ. ุนูุงุตุฑ ุจู ูุณุช ุฎุตูุต ููุงู ูุฎ ุงุถุงูู ูโุดููุฏ ฺฉู **Add** ุฑุง ูุฑุงุฎูุงู ฺฉุฑุฏู ุงุณุช ู ุงู ุจุงุนุซ ุญุฐู **ููโุฒูุงู** ูโุดูุฏ. ููุช ุฑู bag **Enumeration** ุงูุฌุงู ูโุฏูุฏุ Enumerator ุจู ุชุฑุชุจ ุงุฒ ูุฑ ูุณุช ุฎุตูุต ูุฎโูุง ุนุจูุฑ ูโฺฉูุฏ ู ุนูุงุตุฑ ุขูโูุง ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ.

ููุช **Take** ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ุงุจุชุฏุง ุจู **ูุณุช ุฎุตูุต ูุฎ ุฌุงุฑ** ูฺฏุงู ูโฺฉูุฏ. ุงฺฏุฑ ุญุฏุงูู ฺฉ ุนูุตุฑ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ุนููุงุช ุจูโุฑุงุญุช ู ุจุฏูู ููโุฒูุงู ุงูุฌุงู ูโุดูุฏ. ุงูุง ุงฺฏุฑ ูุณุช ุฎุงู ุจุงุดุฏุ ุจุงุฏ ุนูุตุฑ ุฑุง ุงุฒ ูุณุช ุฎุตูุต ูุฎ ุฏฺฏุฑ **"ุณุฑูุช"** ฺฉูุฏ ู ุงุญุชูุงู ุงุฌุงุฏ ููโุฒูุงู ูุฌูุฏ ุฏุงุฑุฏ.

ุจูุงุจุฑุงูุ ุฏููุงู ูโุชูุงู ฺฏูุช ฺฉู **Take** ุนูุตุฑ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ุงุฎุฑุงู ุชูุณุท ููุงู ูุฎ ุงุถุงูู ุดุฏู ุงุณุชุ ุงฺฏุฑ ุฏุฑ ุขู ูุฎ ุนูุตุฑ ูุจุงุดุฏุ ุนูุตุฑ ุงุฒ ูุฎ ุฏฺฏุฑ ุจูโุตูุฑุช ุชุตุงุฏู ุจุงุฒฺฏุฑุฏุงูุฏู ูโุดูุฏ.

**ConcurrentBag** ุจุฑุง ููุงูุน ุงุฏูโุขู ุงุณุช ฺฉู ุนููุงุช ููุงุฒ ุฑู ูุฌููุนู ุดูุง ุนูุฏุชุงู ุดุงูู **ุงูุฒูุฏู ุนูุงุตุฑ** ุจุงุดุฏุ ุง ุฒูุงู ฺฉู **ุงูุฒูุฏู ู ุจุฑุฏุงุดุชู ุนูุงุตุฑ ุฑู ูุฑ ูุฎ ูุชุนุงุฏู** ุงุณุช. ูุซุงู ูุจู ุงุฒ ุงุณุชูุงุฏู ุงุฒ **Parallel.ForEach** ุจุฑุง ูพุงุฏูโุณุงุฒ **SpellChecker ููุงุฒ** ุฑุง ุจู ุงุฏ ุจุงูุฑุฏ:

```csharp
var misspellings = new ConcurrentBag<Tuple<int,string>>();
Parallel.ForEach(wordsToTest, (word, state, i) =>
{
  if (!wordLookup.Contains(word))
    misspellings.Add(Tuple.Create((int)i, word));
});
```

ุงูุง ุงุณุชูุงุฏู ุงุฒ **ConcurrentBag** ุจุฑุง ฺฉ **ุตู Producer/Consumer** ููุงุณุจ ูุณุชุ ุฒุฑุง ุนูุงุตุฑ ุชูุณุท ูุฎโูุง ูุฎุชูู ุงุถุงูู ู ุญุฐู ูโุดููุฏ.

---

### BlockingCollection<T> โ

ุงฺฏุฑ ุฑู ูุฑ ฺฉ ุงุฒ ูุฌููุนูโูุง Producer/Consumer ูุงููุฏ **ConcurrentStack<T>**ุ **ConcurrentQueue<T>** ู **ConcurrentBag<T>** ูุชุฏ **TryTake** ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ู ูุฌููุนู ุฎุงู ุจุงุดุฏุ ูุชุฏ ููุฏุงุฑ `false` ุจุฑูโฺฏุฑุฏุงูุฏ. ฺฏุงู ููุฏ ุงุณุช ฺฉู **ุชุง ุฒูุงู ฺฉู ฺฉ ุนูุตุฑ ููุฌูุฏ ุดูุฏุ ููุชุธุฑ ุจูุงูู**.

ุจู ุฌุง ุงุถุงูู ฺฉุฑุฏู ุงู ูุงุจูุช ุจู **TryTake** (ฺฉู ุจุงุนุซ ูพฺุฏฺฏ ุฒุงุฏ ุงุนุถุง ูโุดุฏ ู ุจุฑุง ูพุดุชุจุงู ุงุฒ **CancellationToken** ู **Timeout** ููุงุณุจ ูุจูุฏ)ุ ุทุฑุงุญุงู **PFX** ุงู ูุงุจูุช ุฑุง ุฏุฑ ฺฉูุงุณ **BlockingCollection<T>** ูุฑุงุฑ ุฏุงุฏูุฏ.

**BlockingCollection<T>** ูุฑ ูุฌููุนูโุง ฺฉู **IProducerConsumerCollection<T>** ุฑุง ูพุงุฏูโุณุงุฒ ฺฉุฑุฏู ุจุงุดุฏุ ุฏุฑ ุฎูุฏ ูโูพฺุงูุฏ ู ุงุฌุงุฒู ูโุฏูุฏ ุงุฒ ุขู **Take** ุงูุฌุงู ุฏูุฏโู ุงฺฏุฑ ุนูุตุฑ ููุฌูุฏ ูุจุงุดุฏุ ุนููุงุช **Block** ูโุดูุฏ.

ููฺููุ **BlockingCollection** ูโุชูุงูุฏ ุงูุฏุงุฒู ฺฉู ูุฌููุนู ุฑุง ูุญุฏูุฏ ฺฉูุฏ ู ุงฺฏุฑ ุงู ุงูุฏุงุฒู ุฑุนุงุช ูุดูุฏุ ุชููุฏฺฉููุฏู **Block** ูโุดูุฏ. ฺูู ูุฌููุนูโุง ุจู ูุงู **Bounded Blocking Collection** ุดูุงุฎุชู ูโุดูุฏ.

---

#### ูุญูู ุงุณุชูุงุฏู ุงุฒ BlockingCollection<T> ๐

1. ูููููโุง ุงุฒ ฺฉูุงุณ ุจุณุงุฒุฏ ู ุงุฎุชุงุฑ **IProducerConsumerCollection<T>** ุจุฑุง wrap ฺฉุฑุฏู ู ุญุฏุงฺฉุซุฑ ุงูุฏุงุฒู (Bound) ุฑุง ูุดุฎุต ฺฉูุฏ.
2. ุจุง **Add** ุง **TryAdd** ุนูุงุตุฑ ุฑุง ุจู ูุฌููุนู ุฏุงุฎู ุงุถุงูู ฺฉูุฏ.
3. ุจุง **Take** ุง **TryTake** ุนูุงุตุฑ ุฑุง ุงุฒ ูุฌููุนู ุฏุงุฎู ุญุฐู ุง ูุตุฑู ฺฉูุฏ.

ุงฺฏุฑ ุณุงุฒูุฏู ุจุฏูู ูุฌููุนู ุฏุงุฎู ูุฑุงุฎูุงู ุดูุฏุ ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉ **ConcurrentQueue<T>** ุณุงุฎุชู ูโุดูุฏ. ูุชุฏูุง ุชููุฏ ู ูุตุฑู ุงุฌุงุฒู ุงุณุชูุงุฏู ุงุฒ **CancellationToken** ู **Timeout** ุฑุง ูโุฏููุฏ. **Add** ู **TryAdd** ููฺฉู ุงุณุช Block ุดููุฏ ุงฺฏุฑ ุงูุฏุงุฒู ูุฌููุนู ูุญุฏูุฏ ุจุงุดุฏุ **Take** ู **TryTake** ููฺฏุงู ุฎุงู ุจูุฏู ูุฌููุนู Block ูโุดููุฏ.

ุฑูุด ุฏฺฏุฑ ุจุฑุง ูุตุฑู ุนูุงุตุฑุ ูุฑุงุฎูุงู **GetConsumingEnumerable** ุงุณุช ฺฉู ฺฉ **ุฏูุจุงูู (sequence) ุจุงูููู ูุงูุญุฏูุฏ** ุจุฑูโฺฏุฑุฏุงูุฏ ู ุนูุงุตุฑ ุฑุง ุจู ูุญุถ ุฏุฑ ุฏุณุชุฑุณ ุดุฏู ุงุฑุงุฆู ูโุฏูุฏ. ูโุชูุงูุฏ ุจุง ูุฑุงุฎูุงู **CompleteAdding** ุฏูุจุงูู ุฑุง ุฎุงุชูู ุฏูุฏุ ุงู ูุชุฏ ููฺูู ุงุฌุงุฒู enqueue ฺฉุฑุฏู ุนูุงุตุฑ ุฌุฏุฏ ุฑุง ููโุฏูุฏ.

**BlockingCollection** ูุชุฏูุง ุงุณุชุงุชฺฉ **AddToAny** ู **TakeFromAny** ูุฒ ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุงุฌุงุฒู ูโุฏูุฏ ฺฉ ุนูุตุฑ ุฑุง ุจู ฺูุฏ ูุฌููุนู ููุฒูุงู ุงุถุงูู ุง ุงุฒ ุขูโูุง ุจุฑุฏุงุฑุฏ ู ุงููู ูุฌููุนูโุง ฺฉู ุชูุงูุณุช ุงู ุฏุฑุฎูุงุณุช ุฑุง ุงูุฌุงู ุฏูุฏุ ุนููุงุช ุฑุง ุงูุฌุงู ูโุฏูุฏ.

### ููุดุชู ฺฉ ุตู Producer/Consumer ๐ญ๐ฅ

ฺฉ **ุตู Producer/Consumer** ุณุงุฎุชุงุฑ ุจุณุงุฑ ููุฏ ุงุณุชุ ูู ุฏุฑ **ุจุฑูุงููโููุณ ููุงุฒ** ู ูู ุฏุฑ **ุณูุงุฑููุง ุนููู ููโุฒูุงู**. ุนููฺฉุฑุฏ ุขู ุจู ุงู ุตูุฑุช ุงุณุช:

* ฺฉ **Queue** ุจุฑุง ูฺฏูุฏุงุฑ ุขุชูโูุง ฺฉุงุฑ ุง ุฏุงุฏูโูุง ฺฉู ุนููุงุช ุฑู ุขูโูุง ุงูุฌุงู ูโุดูุฏุ ุงุฌุงุฏ ูโฺฉูู.
* ูุฑฺฏุงู ฺฉ ฺฉุงุฑ ูุงุฒ ุจู ุงุฌุฑุง ุฏุงุดุชู ุจุงุดุฏุ ุฏุฑ ุตู ูุฑุงุฑ ูโฺฏุฑุฏ (**Enqueue**) ู ูุฑุงุฎูุงููุฏู ูโุชูุงูุฏ ุจู ฺฉุงุฑูุง ุฏฺฏุฑ ุจูพุฑุฏุงุฒุฏ.
* ฺฉ ุง ฺูุฏ **ูุฎ Worker** ุฏุฑ ูพุณโุฒููู ูุนุงูุช ูโฺฉููุฏ ู ุขุชูโูุง ุตู ุฑุง ุจุฑุฏุงุดุชู ู ุงุฌุฑุง ูโฺฉููุฏ.

ฺฉ **ุตู Producer/Consumer** ฺฉูุชุฑู ุฏูู ุฑู ุชุนุฏุงุฏ ูุฎโูุง ฺฉู ููโุฒูุงู ุงุฌุฑุง ูโุดููุฏ ูุฑุงูู ูโฺฉูุฏ. ุงู ูุงุจูุช ูู ุชููุง ุจุฑุง ูุญุฏูุฏ ฺฉุฑุฏู ูุตุฑู CPU ุจูฺฉู ุจุฑุง ูุฏุฑุช ููุงุจุน ุฏฺฏุฑ ูุฒ ููุฏ ุงุณุช. ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉุงุฑูุง ุนููุงุชโูุง ุณูฺฏู I/O ุฑู ุฏุณฺฉ ุงูุฌุงู ุฏููุฏุ ูโุชูุงู **Concurrency** ุฑุง ูุญุฏูุฏ ฺฉุฑุฏ ุชุง ุณุณุชูโุนุงูู ู ุณุงุฑ ุจุฑูุงููโูุง ุฏฺุงุฑ ูุดฺฉู ูุดููุฏ. ููฺูู ูโุชูุงู ุฏุฑ ุทูู ุนูุฑ ุตูุ **Workers** ุฑุง ุจูโุตูุฑุช ุฏูุงูฺฉ ุงุถุงูู ุง ุญุฐู ฺฉุฑุฏ.

ุฎูุฏ **Thread Pool** ุฏุฑ CLR ููุน ุตู **Producer/Consumer** ุงุณุช ฺฉู ุจุฑุง **ฺฉุงุฑูุง ฺฉูุชุงู ูุฏุช ู Compute-bound** ุจููู ุดุฏู ุงุณุช.

ฺฉ **ุตู Producer/Consumer** ูุนูููุงู ุดุงูู ุขุชูโูุง ุงุณุช ฺฉู ููุงู **ฺฉุงุฑ** ุฑู ุขูโูุง ุงูุฌุงู ูโุดูุฏ. ุจุฑุง ูุซุงูุ ุขุชูโูุง ููฺฉู ุงุณุช ูุงู ูุงูโูุง ุจุงุดูุฏ ู ฺฉุงุฑุ ุฑูุฒฺฏุฐุงุฑ ุขูโูุง ุจุงุดุฏ. ุงูุง ุงฺฏุฑ ุขุชู ุฑุง ุจู ุดฺฉู ฺฉ **Delegate** ุฏุฑ ูุธุฑ ุจฺฏุฑูุ ูโุชูุงู ฺฉ **ุตู Producer/Consumer ุนูููโุชุฑ** ููุดุช ฺฉู ูุฑ ุขุชู ูุงุฏุฑ ุจู ุงูุฌุงู ูุฑ ุนูู ุจุงุดุฏ.

ุฏุฑ [albahari.com/threading](http://albahari.com/threading) ูุดุงู ุฏุงุฏู ุดุฏู ฺฉู ฺฺฏููู ูโุชูุงู ฺฉ **Producer/Consumer Queue** ุงุฒ ุตูุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ **AutoResetEvent** (ู ุจุนุฏุงู ุจุง **Monitor.Wait/Pulse**) ููุดุช.

ุจุง ุงู ุญุงูุ ููุดุชู ฺฉ ุตู ุงุฒ ุตูุฑ **ุถุฑูุฑ ูุณุช**ุ ุฒุฑุง ุงฺฉุซุฑ ูุงุจูุชโูุง ุชูุณุท **BlockingCollection<T>** ูุฑุงูู ุดุฏูโุงูุฏ.

---

#### ูุซุงู ุงุณุชูุงุฏู ุงุฒ BlockingCollection ุจุฑุง ุตู PCQueue ๐๏ธ

```csharp
public class PCQueue : IDisposable
{
  BlockingCollection<Action> _taskQ = new BlockingCollection<Action>();

  public PCQueue(int workerCount)
  {
    // ุงุฌุงุฏ ู ุดุฑูุน ฺฉ Task ุฌุฏุงฺฏุงูู ุจุฑุง ูุฑ ูุตุฑูโฺฉููุฏู:
    for (int i = 0; i < workerCount; i++)
      Task.Factory.StartNew(Consume);
  }

  public void Enqueue(Action action) { _taskQ.Add(action); }

  void Consume()
  {
    // ุงู ุฏูุจุงูู ููฺฏุงู ูุจูุฏ ุนูุตุฑ Block ูโุดูุฏ
    // ู ุจุง ูุฑุงุฎูุงู CompleteAdding ุฎุงุชูู ูโุงุจุฏ.
    foreach (Action action in _taskQ.GetConsumingEnumerable())
      action();  // ุงุฌุฑุง ฺฉุงุฑ
  }

  public void Dispose() { _taskQ.CompleteAdding(); }
}
```

ฺูู ฺุฒ ุจู ุณุงุฒูุฏู **BlockingCollection** ุงุฑุณุงู ูฺฉุฑุฏูโุงูุ ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉ **ConcurrentQueue** ุงุฌุงุฏ ูโุดูุฏ. ุงฺฏุฑ ฺฉ **ConcurrentStack** ูโุฏุงุฏูุ ุตู ุจู ฺฉ **Producer/Consumer Stack** ุชุจุฏู ูโุดุฏ.

---

### ุงุณุชูุงุฏู ุงุฒ Tasks ุฏุฑ ุตู Producer/Consumer ๐

ุตู ฺฉู ููุดุชู ฺฉู **ุบุฑ ููุนุทู** ุงุณุชุ ุฒุฑุง ุจุนุฏ ุงุฒ ูุฑุงุฑ ุฏุงุฏู ฺฉุงุฑูุง ุฏุฑ ุตู ููโุชูุงูู ูุถุนุช ุขูโูุง ุฑุง ุฏูุจุงู ฺฉูู. ูุซูุงู ุฎูุจ ุงุณุช ุงฺฏุฑ ุจุชูุงูู:

* ุจุฏุงูู ฺฉ ฺฉุงุฑ **ุชูุงู ุดุฏู ุงุณุช** (ู ุจุชูุงูู await ฺฉูู)
* ฺฉ ฺฉุงุฑ ุฑุง **ูุบู ฺฉูู**
* ุจู ุดฺฉู ุฒุจุง ุจุง **ุงุณุชุซูุงูุง** ูพุฑุชุงุจ ุดุฏู ุชูุณุท ฺฉุงุฑ ุจุฑุฎูุฑุฏ ฺฉูู

ุฑุงู ุญู ุงุฏูโุขู ุงู ุงุณุช ฺฉู ูุชุฏ **Enqueue** ฺฉ **Task** ุจุฑฺฏุฑุฏุงูุฏ ุชุง ุจุชูุงูู ููู ุงู ูุงุจูุชโูุง ุฑุง ุฏุงุดุชู ุจุงุดู. ุฎูุดุจุฎุชุงูู ฺฉูุงุณ **Task** ุฏููุงู ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ ู ูโุชูุงู ุขู ุฑุง ุจุง **TaskCompletionSource** ุง ุจุง **ุงุฌุงุฏ ูุณุชูู** ฺฉ Task (Cold/Unstarted) ุชููุฏ ฺฉุฑุฏ.

---

#### ูุซุงู PCQueue ุจุง Task ๐ฏ

```csharp
public class PCQueue : IDisposable
{
  BlockingCollection<Task> _taskQ = new BlockingCollection<Task>();

  public PCQueue(int workerCount)
  {
    for (int i = 0; i < workerCount; i++)
      Task.Factory.StartNew(Consume);
  }

  public Task Enqueue(Action action, CancellationToken cancelToken = default)
  {
    var task = new Task(action, cancelToken);
    _taskQ.Add(task);
    return task;
  }

  public Task<TResult> Enqueue<TResult>(Func<TResult> func, CancellationToken cancelToken = default)
  {
    var task = new Task<TResult>(func, cancelToken);
    _taskQ.Add(task);
    return task;
  }

  void Consume()
  {
    foreach (var task in _taskQ.GetConsumingEnumerable())
      try 
      {
          if (!task.IsCanceled) task.RunSynchronously();
      } 
      catch (InvalidOperationException) { }  // ุดุฑุงุท ูุงุฏุฑ Race Condition
  }

  public void Dispose() { _taskQ.CompleteAdding(); }
}
```

ุฏุฑ ูุชุฏ **Enqueue**ุ ฺฉ **Task** ุงุฌุงุฏ ูโฺฉููุ ุขู ุฑุง ุฏุฑ ุตู ูุฑุงุฑ ูโุฏูู ู ุจู ูุฑุงุฎูุงููุฏู ุจุฑูโฺฏุฑุฏุงูู ุจุฏูู ุงูฺฉู ุงุฌุฑุง ุดูุฏ. ุฏุฑ ูุชุฏ **Consume**ุ **Task** ุฑู ูุฎ ูุตุฑูโฺฉููุฏู **ุจูโุตูุฑุช ููโุฒูุงู ุงุฌุฑุง** ูโุดูุฏ. ุจุง ฺฏุฑูุชู **InvalidOperationException**ุ ุดุฑุงุท ูุงุฏุฑ ูุบู ููโุฒูุงู Task ูุฏุฑุช ูโุดูุฏ.

---

#### ููููู ุงุณุชูุงุฏู

```csharp
var pcQ = new PCQueue(2);    // ุญุฏุงฺฉุซุฑ concurrency ุจุฑุงุจุฑ ฒ
string result = await pcQ.Enqueue(() => "That was easy!");
```

ุจุง ุงู ุฑูุดุ **ุชูุงู ูุฒุงุง Task** ุงุฒ ุฌููู **ุงูุชุดุงุฑ ุงุณุชุซูุงูุงุ ุจุงุฒฺฏุดุช ููุงุฏุฑ ู ูุบู** ุฑุง ุฏุงุฑูุ ุฏุฑ ุญุงู ฺฉู **ฺฉูุชุฑู ฺฉุงูู ุฑู ุฒูุงูโุจูุฏ ุงุฌุฑุง ฺฉุงุฑูุง** ูุฒ ุฏุฑ ุงุฎุชุงุฑูุงู ุงุณุช.
