---
layout: layout.njk
title: ุถููู A
---
# ๐ ุถููู A

# ๐งต ููโุฑููุฏ (Concurrency) โ ุจุฎุด ุฏูู

โ๏ธ ููุดุชู: **Brett L. Schuchert**

ุงู ุถููู ุจู ูุตู ยซููโุฑููุฏยป ุฏุฑ ุตูุญู 177 ฺฉุชุงุจ ๐งผ *Clean Code* ฺฉูฺฉ ูโฺฉูุฏ ู ุขู ุฑุง ฺฏุณุชุฑุด ูโุฏูุฏ. ุงู ุจุฎุด ุจูโุตูุฑุช ูุฌููุนูโุง ุงุฒ ููุถูุนุงุช ูุณุชูู ููุดุชู ุดุฏู ุงุณุช ู ูุนูููุงู ูโุชูุงู ุขูโูุง ุฑุง ุจู ูุฑ ุชุฑุชุจ ูุทุงูุนู ฺฉุฑุฏ. ุจุฑุง ุงูฺฉู ุงู ููุน ูุทุงูุนู ุงูฺฉุงูโูพุฐุฑ ุจุงุดุฏุ ุฏุฑ ุจุฎุดโูุง ูุฎุชูู ููุฏุงุฑ ุชฺฉุฑุงุฑ ุฏุฏู ูโุดูุฏ.

---

## ๐ป ูุซุงู Client/Server (ฺฉุงุฑุจุฑ / ุณุฑูุฑ)

ูุฑุถ ฺฉูุฏ ฺฉ ุจุฑูุงูู ุณุงุฏูโ **Client/Server** ุฏุงุฑู.
๐ธ ฺฉ **ุณุฑูุฑ (Server)** ุฑู ฺฉ *ุณูฺฉุช (Socket)* ููุชุธุฑ ูโูุงูุฏ ุชุง ฺฉ **ฺฉูุงูุช (Client)** ุจู ุขู ูุตู ุดูุฏ.
๐ธ ฺฉ **ฺฉูุงูุช** ูุตู ุดุฏู ู ฺฉ ุฏุฑุฎูุงุณุช ุงุฑุณุงู ูโฺฉูุฏ.

---

## ๐ฅ๏ธ ุณุฑูุฑ (The Server)

ุฏุฑ ุงุฏุงูู ูุณุฎูโ ุณุงุฏูโุดุฏูโุง ุงุฒ ฺฉ ุจุฑูุงููโ ุณุฑูุฑ ุฑุง ูโุจูุฏ.
๐ ูุณุฎู ฺฉุงูู ฺฉุฏ ุงู ูุซุงู ุฏุฑ ุตูุญู 343 ุจุง ุนููุงู **Client/Server Nonthreaded** ุขูุฏู ุงุณุช:

```java
ServerSocket serverSocket = new ServerSocket(8009);
while (keepProcessing) {
    try {
        Socket socket = serverSocket.accept();
        process(socket);
    } catch (Exception e) {
        handle(e);
    }
}
```

ุงู ุจุฑูุงูู ุณุงุฏู ููุชุธุฑ ฺฉ ุงุชุตุงู ูโูุงูุฏุ ูพุงู ูุฑูุฏ ุฑุง ูพุฑุฏุงุฒุด ูโฺฉูุฏ ู ุณูพุณ ุฏูุจุงุฑู ููุชุธุฑ ุฏุฑุฎูุงุณุช ุจุนุฏ ุงุฒ ฺฉูุงูุช ูโูุดูุฏ.
ุฏุฑ ุงุฏุงููุ ฺฉุฏ ูุฑุจูุท ุจู **ฺฉูุงูุช** ุฑุง ูโุจูุฏ ฺฉู ุจู ุงู ุณุฑูุฑ ูุตู ูโุดูุฏ:

```java
private void connectSendReceive(int i) {
    try {
        Socket socket = new Socket("localhost", PORT);
        MessageUtils.sendMessage(socket, Integer.toString(i));
        MessageUtils.getMessage(socket);
        socket.close();
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

---

## ๐ ุจุฑุฑุณ ุนููฺฉุฑุฏ (Performance)

ุนููฺฉุฑุฏ ุงู ุฌูุช Client/Server ฺุทูุฑ ุงุณุชุ
ฺุทูุฑ ูโุชูุงูู ุงู ุนููฺฉุฑุฏ ุฑุง ุจูโุตูุฑุช ุฑุณู ุชูุตู ฺฉููุ
ุฏุฑ ุงูุฌุง ฺฉ ุชุณุช ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุจุฑุฑุณ ูโฺฉูุฏ ุขุง ุนููฺฉุฑุฏ ุณุณุชู ยซูุงุจู ูุจููยป ุงุณุช ุง ูู:

```java
@Test(timeout = 10000)
public void shouldRunInUnder10Seconds() throws Exception {
    Thread[] threads = createThreads();
    startAllThreadsw(threads);
    waitForAllThreadsToFinish(threads);
}
```

๐ ุชูุธูุงุช ุงููู ุงู ุชุณุช ุจุฑุง ุณุงุฏฺฏ ุญุฐู ุดุฏู ุงุณุช (ุจู ูุงู **ClientTest.java** ุฏุฑ ุตูุญู 344 ูุฑุงุฌุนู ฺฉูุฏ).
ุงู ุชุณุช ุงูุชุธุงุฑ ุฏุงุฑุฏ ฺฉู ุงุฌุฑุง ฺฉู ุนููุงุช ุฏุฑ ฺฉูุชุฑ ุงุฒ **ฑฐูฌฐฐฐ ููโุซุงูู** (ฑฐ ุซุงูู) ุงูุฌุงู ุดูุฏ โฑ๏ธ

---

## ๐ ุจุฑุฑุณ ุชูุงู ุนููุงุช (Throughput)

ุงู ฺฉ ูุซุงู ฺฉูุงุณฺฉ ุงุฒ ุงุนุชุจุงุฑุณูุฌ **Throughput** ุณุณุชู ุงุณุช.
ุฏุฑ ุงู ุณุณุชูุ ุจุงุฏ ูุฌููุนูโุง ุงุฒ ุฏุฑุฎูุงุณุชโูุง ฺฉูุงูุช ุฏุฑ ฑฐ ุซุงูู ุชฺฉูู ุดููุฏ.
ุชุง ุฒูุงู ฺฉู ุณุฑูุฑ ุจุชูุงูุฏ ูุฑ ุฏุฑุฎูุงุณุช ุฑุง ุจูโูููุน ูพุฑุฏุงุฒุด ฺฉูุฏุ ุชุณุช ุจุง ููููุช ูพุงุณ ูโุดูุฏ โ

ุงูุง ุงฺฏุฑ ุชุณุช ุดฺฉุณุช ุจุฎูุฑุฏ ฺูุ ๐ค
ุฏุฑ ุตูุฑุช ฺฉู ููุน **Event Polling Loop** (ุญููู ุจุฑุฑุณ ุฑูุฏุงุฏูุง) ุทุฑุงุญ ูฺฉููุ ุฏุฑ ฺฉ **ุชฺฉโุฑุดุชู (Single Thread)** ฺฉุงุฑ ุฎุงุต ููโุชูุงู ุจุฑุง ุณุฑุนโุชุฑ ฺฉุฑุฏู ุงู ฺฉุฏ ุงูุฌุงู ุฏุงุฏ.

ุขุง ุงุณุชูุงุฏู ุงุฒ ฺูุฏ ุฑุดุชู (Multiple Threads) ูโุชูุงูุฏ ูุดฺฉู ุฑุง ุญู ฺฉูุฏุ
ุดุงุฏุ ุงูุง ุงุจุชุฏุง ุจุงุฏ ุจุฏุงูู ุฒูุงู ุฏููุงู ฺฉุฌุง ุตุฑู ูโุดูุฏ. ุฏู ุญุงูุช ฺฉู ูุฌูุฏ ุฏุงุฑุฏ:

* ๐ **I/O** (ูุฑูุฏ/ุฎุฑูุฌ): ูุซู ุงุณุชูุงุฏู ุงุฒ ุณูฺฉุชุ ุงุชุตุงู ุจู ุฏุชุงุจุณุ ุงูุชุธุงุฑ ุจุฑุง Swap ุดุฏู ุญุงูุธู ูุฌุงุฒ ู ููุงุฑุฏ ูุดุงุจู.
* ๐งฎ **Processor** (ูพุฑุฏุงุฒูุฏู): ูุซู ุงูุฌุงู ูุญุงุณุจุงุช ุนุฏุฏุ ูพุฑุฏุงุฒุด Regular Expressionูุงุ Garbage Collection ู ููุงุฑุฏ ูุดุงุจู.

ุจูโุทูุฑ ูุนููู ุณุณุชูโูุง ููุฏุงุฑ ุงุฒ ูุฑ ุฏู ููุฑุฏ ุฑุง ุฏุงุฑูุฏุ ุงูุง ุฏุฑ ูุฑ ุนููุงุช ฺฉ ุงุฒ ุขูโูุง ุบุงูุจ ุงุณุช.

ุงฺฏุฑ ฺฉุฏ **Processor-bound** ุจุงุดุฏุ ุงูุฒูุฏู ุณุฎุชโุงูุฒุงุฑ ูพุฑุฏุงุฒุด ุจุดุชุฑ ูโุชูุงูุฏ Throughput ุฑุง ุงูุฒุงุด ุฏูุฏ ู ุจุงุนุซ ููููุช ุชุณุช ุดูุฏ.
ุงูุง ฺูู ฺุฑุฎูโูุง CPU ูุญุฏูุฏูุฏุ ุงูุฒูุฏู Thread ุจู ฺฉ ูุณุฆูู Processor-bound ุจุงุนุซ ุงูุฒุงุด ุณุฑุนุช ููโุดูุฏ โ๏ธ

ุงุฒ ุทุฑู ุฏฺฏุฑุ ุงฺฏุฑ ูุฑุขูุฏ **I/O-bound** ุจุงุดุฏุ ุงุณุชูุงุฏู ุงุฒ ููโุฑููุฏ (Concurrency) ูโุชูุงูุฏ ุจุงุฒุฏู ุฑุง ุงูุฒุงุด ุฏูุฏ โ
ุฏุฑ ุงู ุญุงูุชุ ุฒูุงู ฺฉู ฺฉ ุจุฎุด ุงุฒ ุณุณุชู ููุชุธุฑ I/O ุงุณุชุ ุจุฎุด ุฏฺฏุฑ ูโุชูุงูุฏ ุงุฒ ููุงู ุฒูุงู ุจุฑุง ูพุฑุฏุงุฒุด ฺฉุงุฑ ุฏฺฏุฑ ุงุณุชูุงุฏู ฺฉูุฏ ู ุงุฒ CPU ุจูุฑูโูุฑ ุจูุชุฑ ุจฺฏุฑุฏ ๐ก

---

## ๐งต ุงูุฒูุฏู ฺูุฏุฑุณูุงู (Adding Threading)

ูุฑุถ ฺฉูู ุชุณุช ุนููฺฉุฑุฏ ุดฺฉุณุช ุฎูุฑุฏู ุงุณุช.
ฺุทูุฑ ูโุชูุงูู **Throughput** ุฑุง ุจูุจูุฏ ุฏูู ุชุง ุชุณุช ุจุง ููููุช ูพุงุณ ุดูุฏุ

ุงฺฏุฑ ูุชุฏ `process` ุณุฑูุฑ **I/O-bound** ุจุงุดุฏุ ฺฉ ุฑูุด ุงู ุงุณุช ฺฉู ุณุฑูุฑ ุฑุง ุจู ุดฺฉู ฺูุฏุฑุณูุงู (Threaded) ุชุบุฑ ุฏูู.
ฺฉุงู ุงุณุช ููุท ูุญููโ ูพุฑุฏุงุฒุด ูพุงู ุฑุง ุนูุถ ฺฉูู:

```java
void process(final Socket socket) {
    if (socket == null)
        return;
    Runnable clientHandler = new Runnable() {
        public void run() {
            try {
                String message = MessageUtils.getMessage(socket);
                MessageUtils.sendMessage(socket, "Processed: " + message);
                closeIgnoringException(socket);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    };
    Thread clientConnection = new Thread(clientHandler);
    clientConnection.start();
}
```

ูุฑุถ ฺฉูุฏ ุงู ุชุบุฑ ุจุงุนุซ ุดุฏู ุชุณุช ุนููฺฉุฑุฏ ูพุงุณ ุดูุฏ โ
ฺฉุฏ ฺฉุงูู ุดุฏู ุงุณุชุ ุฏุฑุณุช ุงุณุชุ ๐ค

## ๐ ูุดุงูุฏุงุช ูุฑุจูุท ุจู ุณุฑูุฑ (Server Observations) ๐ฅ๏ธ

ูุณุฎู ุจูโุฑูุฒุดุฏูโ ุณุฑูุฑุ ุชุณุช ุนููฺฉุฑุฏ ุฑุง ุฏุฑ ฺฉู ุจุด ุงุฒ **ฑ ุซุงูู** ุจุง ููููุช ุจู ูพุงุงู ูโุฑุณุงูุฏ โฑ๏ธโ
ุงูุง ูุชุฃุณูุงูู ุงู ุฑุงูโุญู ฺฉู ุณุงุฏูโุงูฺฏุงุฑุงูู ุงุณุช ู ูุดฺฉูุงุช ุฌุฏุฏ ุฑุง ุจู ููุฑุงู ูโุขูุฑุฏ โ๏ธ

โ **ุณุฑูุฑ ูุง ููฺฉู ุงุณุช ฺูุฏ ุชุง Thread ุงุฌุงุฏ ฺฉูุฏุ**
ฺฉุฏ ฺฉู ููุดุชู ูฺ ูุญุฏูุฏุช ุจุฑุง ุชุนุฏุงุฏ Threadูุง ุชุนู ูฺฉุฑุฏู ุงุณุช. ุจูุงุจุฑุงู ููฺฉู ุงุณุช ุจู ุณูู ุชุนุฏุงุฏ Threadูุง ุจุฑุณู ฺฉู **JVM (Java Virtual Machine)** ุงุฌุงุฒู ูโุฏูุฏ.
ุจุฑุง ุจุณุงุฑ ุงุฒ ุณุณุชูโูุง ุณุงุฏูุ ุงู ููุฏุงุฑ ฺฉุงู ุงุณุช.
ุงูุง ุงฺฏุฑ ุณุณุชู ูุง ูุฑุงุฑ ุจุงุดุฏ ุงุฒ ฺฉุงุฑุจุฑุงู ุฒุงุฏ ุฏุฑ ุงูุชุฑูุช ุนููู ูพุดุชุจุงู ฺฉูุฏุ ฺูุ ๐
ุงฺฏุฑ ุชุนุฏุงุฏ ุฒุงุฏ ฺฉุงุฑุจุฑ ููโุฒูุงู ูุชุตู ุดููุฏุ ููฺฉู ุงุณุช ุณุณุชู ุนููุงู ุงุฒ ฺฉุงุฑ ุจูุชุฏ ุง ุจู ุดุฏุช ฺฉูุฏ ุดูุฏ ๐ข๐ฅ

ูุนูุงู ูุดฺฉูุงุช ุฑูุชุงุฑ ุฑุง ฺฉูุงุฑ ุจฺฏุฐุงุฑู. ุฑุงูโุญู ุงุฑุงุฆูโุดุฏูุ ุงุฒ ูุธุฑ **ูพุงฺฉ (Cleanliness)** ู **ุณุงุฎุชุงุฑ (Structure)** ูุฒ ูุดฺฉูุงุช ุฏุงุฑุฏ.
โ ฺฉุฏ ุณุฑูุฑ ฺู ุชุนุฏุงุฏ ยซูุณุฆููุชยป ุฏุงุฑุฏุ

* ๐ธ ูุฏุฑุช ุงุชุตุงูโูุง Socket
* ๐ธ ูพุฑุฏุงุฒุด ฺฉูุงูุช
* ๐ธ ุณุงุณุช Threading (Threading Policy)
* ๐ธ ุณุงุณุช ุฎุงููุด ฺฉุฑุฏู ุณุฑูุฑ (Server Shutdown Policy)

ูุชุฃุณูุงูู ูููโ ุงู ูุณุฆููุชโูุง ุฏุงุฎู ุชุงุจุน `process` ูุฑุงุฑ ุฏุงุฑูุฏ.
ุนูุงูู ุจุฑ ุขูุ ุงู ฺฉุฏ ุณุทูุญ ูุฎุชูู ุงุฒ **ุงูุชุฒุงุน (Abstraction)** ุฑุง ุจุง ูู ูุฎููุท ูโฺฉูุฏ.
ุจูุงุจุฑุงู ุจุง ูุฌูุฏ ฺฉูฺฺฉ ุจูุฏู ุชุงุจุน `process`ุ ูุงุฒู ุงุณุช ุงู ฺฉุฏ ุฏูุจุงุฑู ุณุงุฎุชุงุฑุจูุฏ ุดูุฏ โ๏ธ๐

> ๐ (ูโุชูุงูุฏ ุฎูุฏุชุงู ุจุง ุจุฑุฑุณ ฺฉุฏ ูุจู ู ุจุนุฏ ุงุฒ ุชุบุฑ ุงู ููุถูุน ุฑุง ุจุจูุฏ.
> ฺฉุฏ ุจุฏูู Thread ุงุฒ ุตูุญู 343 ุดุฑูุน ูโุดูุฏ ู ูุณุฎู Threaded ุงุฒ ุตูุญู 346.)

---

## ๐งญ ุงุตู ุชฺฉโูุณุฆููุช (Single Responsibility Principle)

ุณุฑูุฑ ุจู ุฏูุงู ูุชุนุฏุฏ ูุงุฒ ุจู ุชุบุฑ ุฏุงุฑุฏุ ุจูุงุจุฑุงู ุงู ฺฉุฏ ุงุตู **Single Responsibility Principle (SRP)** ุฑุง ููุถ ูโฺฉูุฏ โ

ุจุฑุง ุญูุธ ุชูุฒ ุณุณุชูโูุง ููโุฑููุฏ (Concurrent Systems)ุ ูุฏุฑุช Threadูุง ุจุงุฏ ููุท ุฏุฑ ฺูุฏ ูฺฉุงู ูุญุฏูุฏ ู ฺฉุงููุงู ฺฉูุชุฑูโุดุฏู ุงูุฌุงู ุดูุฏ โ
ุนูุงูู ุจุฑ ุงูุ ูุฑ ุจุฎุด ุงุฒ ฺฉุฏ ฺฉู ูุณุฆูู Threadูุงุณุช ุจุงุฏ ููุท ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏูุฏ ู ูู ูฺ ฺุฒ ุฏฺฏุฑ.

ฺุฑุงุ
ุฒุฑุง ูพุฏุง ฺฉุฑุฏู ู ุฑูุน ูุดฺฉูุงุช ููโุฑููุฏ (Concurrency Bugs) ุจูโุฎูุฏโุฎูุฏ ฺฉุงุฑ ุจุณุงุฑ ุฏุดูุงุฑ ุงุณุช ๐ตโ๐ซ
ุญุงูุง ุชุตูุฑ ฺฉูุฏ ูุฌุจูุฑ ุจุงุดุฏ ููโุฒูุงู ุจุง ุขูุ ูุดฺฉูุงุช ุฏฺฏุฑ ุฑุง ูู ุฑูุน ฺฉูุฏ! ๐ฌ

---

## ๐งฑ ุฌุฏุงุณุงุฒ ูุณุฆููุชโูุง

ุงฺฏุฑ ุจุฑุง ูุฑฺฉุฏุงู ุงุฒ ูุณุฆููุชโูุง ุจุงูุง โ ุงุฒ ุฌููู ูุฏุฑุช Thread โ ฺฉ ฺฉูุงุณ ุฌุฏุงฺฏุงูู ุจุณุงุฒูุ ุขูฺฏุงู ุจุง ุชุบุฑ ุงุณุชุฑุงุชฺ ูุฏุฑุช Threadุ ููุท ุจุฎุด ฺฉูฺฺฉ ุงุฒ ฺฉุฏ ุชุบุฑ ูโฺฉูุฏ ู ูุณุฆููุชโูุง ุฏฺฏุฑ ุขููุฏู ููโุดููุฏ ๐

ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ุขุฒูุงุด (Test) ุจุฎุดโูุง ุฏฺฏุฑ ูุฒ ุณุงุฏูโุชุฑ ุดูุฏ ฺูู ูุงุฒ ุจู ุฏุฑฺฏุฑ ุดุฏู ุจุง Threadูุง ูุฎูุงูุฏ ุจูุฏ ๐งชโจ

ุฏุฑ ุงุฏุงูู ูุณุฎูโ ุจูโุฑูุฒุดุฏูโุง ุงุฒ ุณุฑูุฑ ุฑุง ูโุจูุฏ ฺฉู ุฏููุงู ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ:

```java
public void run() {
  while (keepProcessing) {
    try {
      ClientConnection clientConnection = connectionManager.awaitClient();
      ClientRequestProcessor requestProcessor 
        = new ClientRequestProcessor(clientConnection);
      clientScheduler.schedule(requestProcessor);
    } catch (Exception e) {
      e.printStackTrace();
    }
  }
  connectionManager.shutdown();
}
```

ุฏุฑ ุงู ูุณุฎูุ ูููโ ุจุฎุดโูุง ูุฑุจูุท ุจู Thread ุฏุฑ ฺฉ ูฺฉุงู ูุชูุฑฺฉุฒ ุดุฏูโุงูุฏ:
๐ `clientScheduler`
ุงฺฏุฑ ูุดฺฉู ุฏุฑ ููโุฑููุฏ ูพุด ุจุงุฏุ ููุท ููู ููุทู ุฑุง ุจุงุฏ ุจุฑุฑุณ ฺฉูู ๐ต๏ธโโ๏ธ

```java
public interface ClientScheduler {
    void schedule(ClientRequestProcessor requestProcessor);
}
```

---

## ๐งญ ุณุงุณุช ูุนู (Current Policy)

ูพุงุฏูโุณุงุฒ ุณุงุณุช ูุนู ุจุณุงุฑ ุณุงุฏู ุงุณุช:

```java
public class ThreadPerRequestScheduler implements ClientScheduler {
    public void schedule(final ClientRequestProcessor requestProcessor) {
        Runnable runnable = new Runnable() {
            public void run() {
                requestProcessor.process();
            }
        };
        Thread thread = new Thread(runnable);
        thread.start();
    }
}
```

ุจุง ุฌุฏุง ฺฉุฑุฏู ฺฉุงูู ูุฏุฑุช Threadูุง ุฏุฑ ฺฉ ูฺฉุงูุ ุชุบุฑ ูุญููโ ฺฉูุชุฑู Threadูุง ุจุณุงุฑ ุขุณุงูโุชุฑ ูโุดูุฏ ๐โจ

ูุซูุงู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ **Java 5 Executor Framework** ููุท ฺฉุงู ุงุณุช ฺฉ ฺฉูุงุณ ุฌุฏุฏ ุจููุณู ู ุขู ุฑุง ุฏุฑ ุณุณุชู ูุฑุงุฑ ุฏูู:

---

## ๐ Listing A-1 โ `ExecutorClientScheduler.java` ๐งต

```java
import java.util.concurrent.Executor;
import java.util.concurrent.Executors;

public class ExecutorClientScheduler implements ClientScheduler {
    Executor executor;
    public ExecutorClientScheduler(int availableThreads) {
        executor = Executors.newFixedThreadPool(availableThreads);
    }
    public void schedule(final ClientRequestProcessor requestProcessor) {
        Runnable runnable = new Runnable() {
            public void run() {
                requestProcessor.process();
            }
        };
        executor.execute(runnable);
    }
}
```

---

## ๐ฉ ูุชุฌูโฺฏุฑ (Conclusion) โ

ุงูุฒูุฏู ููโุฑููุฏ (Concurrency) ุฏุฑ ุงู ูุซุงู ุฎุงุตุ ุฑูุด ุจุฑุง **ุงูุฒุงุด ุชูุงู ุนููุงุช (Throughput)** ุณุณุชู ุฑุง ูุดุงู ูโุฏูุฏ ู ููฺูู ูุญููโ ุงุนุชุจุงุฑุณูุฌ ุงู ุชูุงู ุนููุงุช ุงุฒ ุทุฑู ุชุณุช ุฑุง ุขููุฒุด ูโุฏูุฏ ๐งช๐

ูุชูุฑฺฉุฒ ฺฉุฑุฏู ุชูุงู ฺฉุฏูุง ููโุฑููุฏ ุฏุฑ ฺูุฏ ฺฉูุงุณ ูุดุฎุตุ ูููููโุง ุงุฒ ุจูโฺฉุงุฑฺฏุฑ ุงุตู **Single Responsibility Principle** ุงุณุช.
ุฏุฑ ุจุฑูุงููโููุณ ููโุฑููุฏุ ุงู ููุถูุน ุงููุช ูฺูโุง ุฏุงุฑุฏ ุฒุฑุง ุงู ููุน ฺฉุฏููุณ ุฐุงุชุงู ูพฺุฏู ุงุณุช ๐งโก

---

## ๐งญ ูุณุฑูุง ููฺฉู ุงุฌุฑุง ฺฉุฏ (Possible Paths of Execution)

ุจุงุฏ ูุชุฏ ุฒุฑ ุฑุง ุจุฑุฑุณ ฺฉูู ๐

```java
public class IdGenerator {
  int lastIdUsed;
  public int incrementValue() {
    return ++lastIdUsed;
  }
}
```

ูุฑุถ ฺฉูุฏ **Overflow ุนุฏุฏ** ุฑุง ูุงุฏุฏู ุจฺฏุฑู ู ููุท ฺฉ Thread ุจู ฺฉ ูููููโ ูุงุญุฏ ุงุฒ `IdGenerator` ุฏุณุชุฑุณ ุฏุงุฑุฏ.
ุฏุฑ ุงู ุญุงูุช ููุท ฺฉ ูุณุฑ ุงุฌุฑุง ููฺฉู ู ฺฉ ูุชุฌูโ ุชุถููโุดุฏู ูุฌูุฏ ุฏุงุฑุฏ โ

* ููุฏุงุฑ ุจุฑฺฏุดุช ุจุฑุงุจุฑ ุจุง ููุฏุงุฑ `lastIdUsed` ุฎูุงูุฏ ุจูุฏ ู ูุฑ ุฏู ููุฏุงุฑ **ฑ ูุงุญุฏ ุจุดุชุฑ ุงุฒ ููุฏุงุฑ ูุจู ุงุฒ ูุฑุงุฎูุงู ูุชุฏ** ูุณุชูุฏ.

---

ุงูุง ุงฺฏุฑ ุฏู Thread ุจูโุทูุฑ ููโุฒูุงู ุงุฒ ุงู ูุชุฏ ุงุณุชูุงุฏู ฺฉููุฏ ู ุขู ุฑุง ุชุบุฑ ูุฏูู ฺู ุงุชูุงู ูโุงูุชุฏุ ๐ค
ูุชุงุฌ ููฺฉู ุฏุฑ ุตูุฑุช ฺฉู ูุฑ Thread ููุท ฺฉ ุจุงุฑ `incrementValue` ุฑุง ุตุฏุง ุจุฒูุฏุ ฺู ุฎูุงููุฏ ุจูุฏุ
(ูุฑุถ ฺฉูุฏ ููุฏุงุฑ ุงูููโ `lastIdUsed` ุจุฑุงุจุฑ ุจุง **93** ุจุงุดุฏ):

* ๐งต Thread 1 ููุฏุงุฑ **94** ูโฺฏุฑุฏุ Thread 2 ููุฏุงุฑ **95** ูโฺฏุฑุฏุ ู ููุฏุงุฑ ููุง `lastIdUsed` ุจุฑุงุจุฑ ุจุง **95** ูโุดูุฏ.
* ๐งต Thread 1 ููุฏุงุฑ **95** ูโฺฏุฑุฏุ Thread 2 ููุฏุงุฑ **94** ูโฺฏุฑุฏุ ู ููุฏุงุฑ ููุง `lastIdUsed` ุจุฑุงุจุฑ ุจุง **95** ูโุดูุฏ.
* ๐งต ูุฑ ุฏู Thread ููุฏุงุฑ **94** ุฑุง ูโฺฏุฑูุฏุ ู ููุฏุงุฑ ููุง `lastIdUsed` ุจุฑุงุจุฑ ุจุง **94** ูโุดูุฏ โ๏ธ

ูุชุฌูโ ููุง ููฺฉู ุงุณุช **ุดฺฏูุชโุงูฺฏุฒ** ุจุงุดุฏ ๐ณ ุงูุง ูุงูุนุงู ุงูฺฉุงูโูพุฐุฑ ุงุณุช.
ุจุฑุง ุฏุฑฺฉ ุฏูู ูููุน ุงู ูุชุงุฌ ูุชูุงูุชุ ุจุงุฏ ุชุนุฏุงุฏ ูุณุฑูุง ููฺฉู ุงุฌุฑุง ฺฉุฏ ู ูุญููโ ุงุฌุฑุง ุขู ุชูุณุท **JVM (Java Virtual Machine)** ุฑุง ุฏุฑฺฉ ฺฉูู ๐ง๐
ุนุงู! ุญุงูุง ุชุฑุฌูู ุฏูู ู ุฑูุงู ุจุฎุด ุฌุฏุฏ ุฏุฑุจุงุฑู **ุชุนุฏุงุฏ ูุณุฑูุง ุงุฌุฑุง ููฺฉู** ู ููุงูู Atomic ู Byte-code ุฑุง ุจุฑุงุช ุขูุงุฏู ฺฉุฑุฏู ๐๐

---

## ๐ค๏ธ ุชุนุฏุงุฏ ูุณุฑูุง ุงุฌุฑุง ููฺฉู (Number of Paths) ๐

ุจุฑุง ูุญุงุณุจูโ ุชุนุฏุงุฏ ูุณุฑูุง ููฺฉู ุงุฌุฑุง ฺฉุฏุ ุงุจุชุฏุง ุจุงุฏ **Byte-code ุชููุฏุดุฏู** ุฑุง ุจุฑุฑุณ ฺฉูู ๐ป

ฺฉ ุฎุท ฺฉุฏ ุฌุงูุง:

```java
return ++lastIdUsed;
```

ุจู **ูุดุช ุฏุณุชูุฑ Byte-code** ุชุจุฏู ูโุดูุฏ.

ุฏู Thread ูโุชูุงููุฏ ุงุฌุฑุง ุงู ูุดุช ุฏุณุชูุฑ ุฑุง ุจูโฺฏูููโุง ุฏุฑ ูู ุขูุฎุชู (Interleave) ฺฉููุฏุ ูุซู ุงูโฺฉู ฺฉ ฺฉุงุฑุชโุฏููุฏู ฺฉุงุฑุชโูุง ุฑุง ููฺฏุงู ุดููู ฺฉุฑุฏู ฺฉุงุฑุชโูุง ุฏุฑ ูู ูโุฑุฒุฏ ๐

ุญุช ุจุง ููุท ูุดุช ุฏุณุชูุฑ ุจุฑุง ูุฑ Threadุ ุชุนุฏุงุฏ ุจุณุงุฑ ุฒุงุฏ ุชุฑุชุจ ูุฎุชูู (Shuffled Outcomes) ููฺฉู ุงุณุช ุฑุฎ ุฏูุฏ ๐ฒ

---

### ๐น ุญุงูุช ุณุงุฏู

ุจุฑุง **N ุฏุณุชูุฑ ูพุดุช ุณุฑ ูู**ุ ุจุฏูู ุญููู ุง ุดุฑุทุ ู **T Thread**ุ ุชุนุฏุงุฏ ฺฉู ูุณุฑูุง ุงุฌุฑุง ููฺฉู ุจู ุตูุฑุช ุฒุฑ ุงุณุช:

[
\text{ุชุนุฏุงุฏ ูุณุฑูุง ููฺฉู} = \frac{(N*T)!}{(N!)^T}
]

---

### ๐น ูุญุงุณุจู ุชุฑุชุจโูุง ููฺฉู (Calculating the Possible Orderings)

ุงู ุชูุถุญ ุงุฒ ุงูู Uncle Bob ุจู Brett ุขูุฏู ุงุณุช ๐ง:

* ุจุง **N ูุฑุญูู ู T Thread**ุ ูุฌููุน ูุฑุงุญู ุจุฑุงุจุฑ ุจุง (T \times N) ุงุณุช.
* ูุจู ุงุฒ ูุฑ ูุฑุญูู ฺฉ **Context Switch** ุฑุฎ ูโุฏูุฏ ฺฉู ุจู Threadูุง ุงูุชุฎุงุจ ูโฺฉูุฏ.
* ุจูุงุจุฑุงู ูุฑ ูุณุฑ ุฑุง ูโุชูุงู ุจู ุตูุฑุช ุฑุดุชูโุง ุงุฒ ุงุนุฏุงุฏ ูุดุงู ุฏุงุฏ ฺฉู **ููุงุงูฺฏุฑ Context Switchูุง** ุงุณุช.

#### ูุซุงู ุจุง ุฏู ูุฑุญูู (A ู B) ู ุฏู Thread (1 ู 2)

ุดุด ูุณุฑ ููฺฉู:

```
1122, 1212, 1221, 2112, 2121, 2211
```

ุง ุจู ุดฺฉู ูุฑุงุญู:

```
A1B1A2B2, A1A2B1B2, A1A2B2B1, A2A1B1B2, A2A1B2B1, A2B2A1B1
```

ุจุฑุง **ุณู Thread**ุ ุชุฑุชุจโูุง ูุดุงุจู ุฒุฑ ูุณุชูุฏ:

```
112233, 112323, 113223, ...
```

โ๏ธ ูฺฉุชู: ุฏุฑ ุงู ุฑุดุชูโูุงุ ููุดู ุจุงุฏ N ููููู ุงุฒ ูุฑ Thread ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.
ุจุฑุง ูุซุงูุ ุฑุดุชู `111111` **ุบุฑูุนุชุจุฑ** ุงุณุช ุฒุฑุง ูฺ ูููููโุง ุงุฒ Threadูุง 2 ู 3 ูุฏุงุฑุฏ.

> โ๏ธ ุงู ูุฏู ฺฉู ุณุงุฏูโุณุงุฒ ุดุฏู ุงุณุชุ ุงูุง ุจุฑุง ููู ููุถูุน ฺฉุงู ุงุณุช.

---

### ๐น ุชุนุฏุงุฏ ูุณุฑูุง ุบุฑุชฺฉุฑุงุฑ

ุจุฑุง ูุซุงู ุฏู ูุฑุญูู ู ุฏู Thread:

* ุฑุดุชูโูุง ฺูุงุฑ ุฑูู ุฏุงุฑู: ุฏู 1 ู ุฏู 2
* ูโุชูุงู 1ูุง ุง 2ูุง ุฑุง ุจุฏูู ุชุบุฑ ูุนูุง ุจุง ูู ุฌุงุจุฌุง ฺฉุฑุฏ
* ุจูุงุจุฑุงู **ฺูุงุฑ ุงุฒูููุฑู (Isomorph)** ุจุฑุง ูุฑ ุฑุดุชู ุฏุงุฑูุ ุนู ุณู ูุณุฑ ุชฺฉุฑุงุฑ ู ฺฉ ูุณุฑ ุบุฑุชฺฉุฑุงุฑ

[
4! \times 0.25 = 6
]

ููู ููุทู ุฏุฑ ุญุงูุชโูุง ุฏฺฏุฑ ูู ุตุงุฏู ุงุณุช.

#### ูุฑููู ฺฉู

[
\text{ุชุนุฏุงุฏ ูุณุฑูุง ููฺฉู} = \frac{(T*N)!}{(N!)^T}
]

* ุจุฑุง (T = 2, N = 2) ุฏุงุฑู (6 = 24/4)
* ุจุฑุง (T = 3, N = 2) ุฏุงุฑู (90 = 720/8)
* ุจุฑุง (T = 3, N = 3) ุฏุงุฑู (1680 = 9!/6^3)

ุจุฑุง ูุซุงู ูุง (ฺฉ ุฎุท ุฌุงูุง = ธ ุฎุท Byte-code ู ุฏู Thread)ุ **ุชุนุฏุงุฏ ฺฉู ูุณุฑูุง ููฺฉู = 12,870**
ุงฺฏุฑ ููุน `lastIdUsed` **long** ุจุงุดุฏุ ูุฑ Read/Write ุจู ุฏู ุนููุงุช ุชุจุฏู ูโุดูุฏ ู ุชุนุฏุงุฏ ูุณุฑูุง ุจู **2,704,156** ูโุฑุณุฏ.

---

### ๐น ุงูุฒูุฏู `synchronized`

ุงฺฏุฑ ูุชุฏ ุฑุง ุงูโุทูุฑ ุชุบุฑ ุฏูู:

```java
public synchronized void incrementValue() {
    ++lastIdUsed;
}
```

* ุชุนุฏุงุฏ ูุณุฑูุง ููฺฉู ุจุฑุง ุฏู Thread ุจู **ฒ** ฺฉุงูุด ูโุงุจุฏ
* ุฏุฑ ุญุงูุช ฺฉู ุจุฑุงุจุฑ ุจุง (N!) ุฎูุงูุฏ ุจูุฏ โ

---

## ๐ ุจุฑุฑุณ ุฏููโุชุฑ (Digging Deeper)

ฺุฑุง ุฏู Thread ูโุชูุงูุณุชูุฏ ูุจู ุงุฒ ุงูุฒูุฏู `synchronized` ููุงู ููุฏุงุฑ ุฑุง ุฏุฑุงูุช ฺฉููุฏุ ๐ค
ุงุจุชุฏุง ุจุงุฏ ุจุง ููููู **ุนููุงุช ุงุชูฺฉ (Atomic Operation)** ุขุดูุง ุดูู.

### ๐น ุนููุงุช ุงุชูฺฉ (Atomic Operation)

ฺฉ ุนููุงุช ุงุชูฺฉุ ุนููุงุช ุงุณุช ฺฉู **ูุงุจู ูุทุน ุดุฏู ูุณุช** ๐ซโ๏ธ

ูุซุงู:

```java
01: public class Example {
02:    int lastId;
03:
04:    public void resetId() {
05:        value = 0;  // ุงู ุฎุท ุงุชูฺฉ ุงุณุช
06:    }
07:
08:    public int getNextId() {
09:        ++value;    // ุงู ุฎุท ุงุชูฺฉ ูุณุช
10:    }
11:}
```

* ุฏุฑ ุฎุท ตุ ููุฏุงุฑ ฐ ุจู `lastId` ุงุฎุชุตุงุต ุฏุงุฏู ูโุดูุฏ
* ุทุจู **Java Memory Model**ุ ุงุฎุชุตุงุต ููุฏุงุฑ ุจู ฺฉ ูุชุบุฑ ณฒ ุจุช **ุงุชูฺฉ ุงุณุช** โ

โ ุงฺฏุฑ ููุน `lastId` ุฑุง ุจู `long` ุชุบุฑ ุฏููุ ุฎุท ต ุฏฺฏุฑ ุงุชูฺฉ ูุฎูุงูุฏ ุจูุฏ.

* ุทุจู JVMุ ุงุฎุชุตุงุต ุจู ฺฉ ููุฏุงุฑ ถด ุจุช ูุงุฒ ุจู **ุฏู ุนููุงุช ณฒ ุจุช** ุฏุงุฑุฏ
* ุฏุฑ ุงู ูุงุตููุ ููฺฉู ุงุณุช Thread ุฏฺฏุฑ ูุงุฑุฏ ุดุฏู ู ฺฉ ุงุฒ ููุงุฏุฑ ุฑุง ุชุบุฑ ุฏูุฏ โ๏ธ

---

### ๐น ุนููฺฏุฑ ูพุดโุงูุฒุงุด `++` (Pre-increment)

* ุงู ุนููฺฏุฑ **ูุงุจู ูุทุน ุดุฏู ุงุณุช**
* ุจูุงุจุฑุงู ุงุชูฺฉ ูุณุช
* ุจุฑุง ุฏุฑฺฉ ุฏููุ ุจุงุฏ **Byte-code** ุชููุฏุดุฏู ุฑุง ุจุฑุฑุณ ฺฉูู ๐

---

### ๐น ุชุนุงุฑู ููู ูุจู ุงุฒ ุงุฏุงูู

1. **Frame** โ ูุฑ ูุฑุงุฎูุงู ูุชุฏ ฺฉ Frame ูุงุฒ ุฏุงุฑุฏ.

   * ุดุงูู ุขุฏุฑุณ ุจุฑฺฏุดุช (Return Address)ุ ูพุงุฑุงูุชุฑูุง ู ูุชุบุฑูุง ูุญู ุงุณุช.
   * ุงู ุชฺฉูฺฉ ุจุฑุง ุชุนุฑู **Call Stack** ุงุณุชูุงุฏู ูโุดูุฏ ู ุฏุฑ ุฒุจุงูโูุง ูุฏุฑู ุจุฑุง ูุฑุงุฎูุงู ุชุงุจุน ู ุจุงุฒฺฏุดุช ุถุฑูุฑ ุงุณุช.

2. **Local Variable** โ ูุฑ ูุชุบุฑ ฺฉู ุฏุฑ ุฏุงููู ูุชุฏ ุชุนุฑู ุดุฏู ุงุณุช.

   * ุชูุงู ูุชุฏูุง ุบุฑ ุงุณุชุงุชฺฉ ุญุฏุงูู ฺฉ ูุชุบุฑ `this` ุฏุงุฑูุฏ ฺฉู ุจู **ุดุก ุฌุงุฑ** ุงุดุงุฑู ูโฺฉูุฏุ ุดุฆ ฺฉู ูพุงู ุงุฎุฑ ุฑุง ุฏุฑุงูุช ฺฉุฑุฏู ู ุจุงุนุซ ูุฑุงุฎูุงู ูุชุฏ ุดุฏู ุงุณุช.

3. **Operand Stack** โ ุจุดุชุฑ ุฏุณุชูุฑูุง ุฏุฑ JVM ูพุงุฑุงูุชุฑ ูโฺฏุฑูุฏ.

   * Operand Stack ุฌุง ุงุณุช ฺฉู ุงู ูพุงุฑุงูุชุฑูุง ูุฑุงุฑ ูโฺฏุฑูุฏ.
   * ุณุงุฎุชุงุฑ LIFO (Last-In, First-Out) ุฏุงุฑุฏ.

## ๐งฉ Byte-code ูุชุฏ resetId() ู ุฑูุชุงุฑ ุงุชูฺฉ ุขู ๐น

### Byte-code ุชููุฏุดุฏู ุจุฑุง `resetId()`

| Mnemonic        | Description                                                                                   | Operand Stack After |
| --------------- | --------------------------------------------------------------------------------------------- | ------------------- |
| ALOAD 0         | ุจุงุฑฺฏุฐุงุฑ ูุชุบุฑ ฐ ุฑู Operand Stack. ูุชุบุฑ ฐ ููุงู `this` ุงุณุชุ ุดุก ุฌุงุฑ ฺฉู ูพุงู ุฑุง ุฏุฑุงูุช ฺฉุฑุฏู. | this                |
| ICONST_0        | ูุฑุงุฑ ุฏุงุฏู ููุฏุงุฑ ุซุงุจุช ฐ ุฑู Operand Stack                                                      | this, 0             |
| PUTFIELD lastId | ุฐุฎุฑู ููุฏุงุฑ ุจุงูุง Stack (ฐ) ุฏุฑ ููุฏ lastId ุดุก ุฌุงุฑ (`this`)                                  | <empty>             |

โก ุงู ุณู ุฏุณุชูุฑ **ุงุชูฺฉ ูุณุชูุฏ**ุ ุนู ุญุช ุงฺฏุฑ Thread ููฺฏุงู ุงุฌุฑุง ูุฑ ฺฉุฏุงู ูุชููู ุดูุฏุ ุฏุงุฏูโูุง ููุฑุฏ ูุงุฒ PUTFIELD ุชูุณุท Thread ุฏฺฏุฑ ูุงุจู ุฏุณุชุฑุณ ูุณุชูุฏ.

* ูุชุฌู: ููุฏุงุฑ ฐ ุจู ุทูุฑ ูุทูุฆู ุฏุฑ ููุฏ ุฐุฎุฑู ูโุดูุฏ โ
* ููู ุฏุงุฏูโูุง ูุญู ูุณุชูุฏุ ุจูุงุจุฑุงู **ุชุฏุงุฎู ุจู Threadูุง ูุฌูุฏ ูุฏุงุฑุฏ**.

๐ก ุงฺฏุฑ ุงู ุณู ุฏุณุชูุฑ ุชูุณุท ุฏู Thread ููุฒูุงู ุงุฌุฑุง ุดูุฏุ ุชุนุฏุงุฏ ุชุฑุชุจโูุง ููฺฉู **4.38679733629e+24** ุฎูุงูุฏ ุจูุฏุ ุงูุง **ุชููุง ฺฉ ูุชุฌู ููุง** ูุฌูุฏ ุฏุงุฑุฏ.

* ุญุช ุงฺฏุฑ ููุน `lastId` ุงุฒ int ุจู long ุชุบุฑ ฺฉูุฏุ ูุชุฌู ููุงู ุฎูุงูุฏ ุจูุฏ ุฒุฑุง ููู Threadูุง ููุฏุงุฑ ุซุงุจุช ุฑุง ุงุฎุชุตุงุต ูโุฏููุฏ.

---

## โ๏ธ ูุดฺฉู `++` ุฏุฑ getNextId()

Byte-code ูุชุฏ `getNextId()` (ูุฑุถ ููุฏุงุฑ ุงููู `lastId = 42`):

| Mnemonic        | Description                              | Operand Stack After |
| --------------- | ---------------------------------------- | ------------------- |
| ALOAD 0         | ุจุงุฑฺฏุฐุงุฑ `this` ุฑู Operand Stack        | this                |
| DUP             | ฺฉูพ ุจุงูุง Stack                          | this, this          |
| GETFIELD lastId | ฺฏุฑูุชู ููุฏุงุฑ lastId ู ูุฑุงุฑ ุฏุงุฏู ุฑู Stack | this, 42            |
| ICONST_1        | ูุฑุงุฑุฏุงุฏู ฑ ุฑู Stack                     | this, 42, 1         |
| IADD            | ุฌูุน ุฏู ููุฏุงุฑ ุจุงูุง Stack                 | this, 43            |
| DUP_X1          | ฺฉูพ ู ูุฑุงุฑ ุฏุงุฏู ูุจู ุงุฒ this              | 43, this, 43        |
| PUTFIELD value  | ุฐุฎุฑู ููุฏุงุฑ 43 ุฏุฑ ููุฏ value ุดุก ุฌุงุฑ    | 43                  |
| IRETURN         | ุจุงุฒฺฏุฑุฏุงูุฏู ููุฏุงุฑ ุจุงูุง Stack             | <empty>             |

โ๏ธ ูุซุงู ุชุฏุงุฎู Threadูุง:

* Thread ุงูู ุจุนุฏ ุงุฒ GETFIELD ูุชููู ูโุดูุฏ (`lastId = 42`)
* Thread ุฏูู ฺฉู ูุชุฏ ุฑุง ุงุฌุฑุง ฺฉุฑุฏู ู ููุฏุงุฑ ุฑุง ุจู 43 ูโุฑุณุงูุฏ
* Thread ุงูู ุงุฏุงูู ูโุฏูุฏ ู ููุฏุงุฑ 42 ุฑู Stack ุฑุง +1 ูโฺฉูุฏ โ ุฏูุจุงุฑู 43 ูโุดูุฏ
* ูุชุฌู: **ฺฉ ุงูุฒุงุด ุงุฒ ุฏุณุช ูโุฑูุฏ** โ

๐ก ุจุง ุงูุฒูุฏู `synchronized` ุจู ูุชุฏ `getNextId()`, ุงู ูุดฺฉู ุฑูุน ูโุดูุฏ.

---

## ๐น ูุชุฌูโฺฏุฑ ุฏุฑุจุงุฑู Byte-code ู Atomic

* ูุงุฒ ุจู ุฏุฑฺฉ ฺฉุงูู Byte-code ูุณุช
* ฺฉุงู ุงุณุช ุจุฏุงูู **Threadูุง ูโุชูุงููุฏ ุฑู ูู ุชุงุซุฑ ุจฺฏุฐุงุฑูุฏ**
* ูฺฉุชู ููู: ++ **ุงุชูฺฉ ูุณุช**

ุจุฑุง ุจุฑูุงููโููุณ ููุฒูุงู ุจุงุฏ ุจุฏุงูู:

1. ฺฉุฌุงูุง ุงุดุงุก ุง ููุงุฏุฑ ูุดุชุฑฺฉ ูุณุชูุฏ
2. ฺฉุฏูุง ฺฉู ููฺฉู ุงุณุช ุจุงุนุซ **ุฎูุงูุฏู/ููุดุชู ููุฒูุงู** ุดููุฏ
3. ฺฺฏููู ุงุฒ ุจุฑูุฒ ูุดฺฉูุงุช ููุฒูุงู ุฌููฺฏุฑ ฺฉูู โก

---

## ๐๏ธ ุขุดูุง ุจุง ฺฉุชุงุจุฎุงููโูุง (Knowing Your Library)

### Executor Framework

* ุงุฒ Java 5 ุจู ุจุนุฏุ **Executor Framework** ุจุฑุง ูุฏุฑุช ูพุดุฑูุชู Threadูุง ุงุฑุงุฆู ุดุฏ
* ุจุณุชู `java.util.concurrent` ุดุงูู ุงู ฺฉูุงุณโูุงุณุช
* ุงุณุชูุงุฏู ุงุฒ **Thread Pool** ุฏุฑ ุงู Framework ุจุงุนุซ **ฺฉุฏ ุชูุฒุชุฑุ ฺฉูฺฺฉโุชุฑ ู ูุงุจู ูุฏุฑุชโุชุฑ** ูโุดูุฏ

โ ูฺฺฏโูุง:

* ูุฏุฑุช Threadูุง
* ุชุบุฑ ุงูุฏุงุฒู ุฎูุฏฺฉุงุฑ
* ุจุงุฒุณุงุฒ Thread ุฏุฑ ุตูุฑุช ูุงุฒ
* ูพุดุชุจุงู ุงุฒ **Futures** ุจุฑุง ูพุฑุฏุงุฒุด ููุฒูุงู

---

### ูุซุงู ุงุณุชูุงุฏู ุงุฒ Future

```java
public String processRequest(String message) throws Exception {
    Callable<String> makeExternalCall = new Callable<String>() {
        public String call() throws Exception {
            String result = "";
            // ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุฎุงุฑุฌ
            return result;
        }
    };
    Future<String> result = executorService.submit(makeExternalCall);
    String partialResult = doSomeLocalProcessing();
    return result.get() + partialResult;
}
```

* `makeExternalCall` ุงุฌุฑุง ูโุดูุฏ
* ูพุฑุฏุงุฒุด ูุญู ุงุฏุงูู ูโุงุจุฏ
* `result.get()` **ููุชุธุฑ ุชฺฉูู Future** ูโูุงูุฏ โณ

---

## โก ุฑุงูฺฉุงุฑูุง Nonblocking

### ูุซุงู ูุฏู ุจุง `synchronized`

```java
public class ObjectWithValue {
    private int value;
    public synchronized void incrementValue() { ++value; }
    public int getValue() { return value; }
}
```

### ูุณุฎู ุฌุฏุฏ Nonblocking ุจุง AtomicInteger

```java
public class ObjectWithValue {
    private AtomicInteger value = new AtomicInteger(0);
    public void incrementValue() {
        value.incrementAndGet();
    }
    public int getValue() {
        return value.get();
    }
}
```

* ุจุง ุงุณุชูุงุฏู ุงุฒ **Compare-And-Swap (CAS)**
* ุนููฺฉุฑุฏ ูุนูููุงู **ุจูุชุฑ ุงุฒ ูุณุฎู ูุฏู** ุงุณุช
* ูุฑุถ ูโฺฉูุฏ **ฺูุฏ Thread ุจู ูุฏุฑุช ููุฏุงุฑ ูุดุชุฑฺฉ ุฑุง ุชุบุฑ ูโุฏููุฏ**
* ุงฺฏุฑ ููุฏุงุฑ ุชุบุฑ ูฺฉุฑุฏู ุจุงุดุฏุ ุชุบุฑ ุงูุฌุงู ูโุดูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุฏูุจุงุฑู ุชูุงุด ูโฺฉูุฏ ๐

### ุดุจูโุณุงุฒ CAS

```java
int variableBeingSet;
void simulateNonBlockingSet(int newValue) {
    int currentValue;
    do {
        currentValue = variableBeingSet;
    } while(currentValue != compareAndSwap(currentValue, newValue));
}
int synchronized compareAndSwap(int currentValue, int newValue) {
    if(variableBeingSet == currentValue) {
        variableBeingSet = newValue;
        return currentValue;
    }
    return variableBeingSet;    
}
```

* CAS **ุงุชูฺฉ ุงุณุช**
* ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ููุฏุงุฑ ูููุฒ ููุงู ููุฏุงุฑ ูุจู ุงุณุช
* ุงฺฏุฑ ุจูู โ ุชุบุฑ ุงูุฌุงู ูโุดูุฏ
* ุงฺฏุฑ ูู โ ุฏูุจุงุฑู ุชูุงุด ูโฺฉูุฏ ุชุง ูููู ุดูุฏ

## โ๏ธ ฺฉูุงุณโูุง ุบุฑููุฒูุงู (Nonthread-Safe Classes) ๐น

ุจุฑุฎ ฺฉูุงุณโูุง ุฐุงุชุงู **thread-safe ูุณุชูุฏ**. ูุซุงูโูุง:

* `SimpleDateFormat`
* ุงุฑุชุจุงุท ุจุง ุฏุชุงุจุณ (Database Connections)
* Containers ุฏุฑ `java.util`
* `Servlets`

๐ ุจุฑุฎ Collectionูุง ูุชุฏูุง thread-safe ุฏุงุฑูุฏุ ุงูุง ูุฑ ุนููุงุช ฺฉู **ฺูุฏ ูุชุฏ ุฑุง ูพุดุช ุณุฑ ูู ูุฑุงุฎูุงู ฺฉูุฏ** ุงูู ูุณุช.
ูุซุงู:

```java
if(!hashTable.containsKey(someKey)) {
    hashTable.put(someKey, new SomeValue());
}
```

* ูุฑ ูุชุฏ ุจู ุชููุง thread-safe ุงุณุช โ
* ุงูุง Thread ุฏฺฏุฑ ููฺฉู ุงุณุช **ุจู containsKey ู put** ููุฏุงุฑ ุงุถุงูู ฺฉูุฏ โ๏ธ

---

## ๐ ุฑูุดโูุง ุญู ูุดฺฉู ููุฒูุงู ุฏุฑ Collectionูุง

### ฑ. ููู ฺฉุฑุฏู ุงุฒ ุณูุช ฺฉูุงูุช (Client-based Locking)

```java
synchronized(map) {
    if(!map.containsKey(key))
        map.put(key,value);
}
```

* ููู ฺฉุงุฑุจุฑุงู ุจุงุฏ ููู ุงูฺฏู ุฑุง ุฑุนุงุช ฺฉููุฏ
* ูุฑ Thread ูุจู ุงุฒ ุงุณุชูุงุฏู ุงุฒ Map ุจุงุฏ ุขู ุฑุง ููู ฺฉูุฏ ู ุจุนุฏ ุขุฒุงุฏ ฺฉูุฏ

### ฒ. ุงุณุชูุงุฏู ุงุฒ Wrapper ู Adapter (Server-based Locking)

```java
public class WrappedHashtable<K, V> {
    private Map<K, V> map = new Hashtable<K, V>();
    public synchronized void putIfAbsent(K key, V value) {
        if (!map.containsKey(key))
            map.put(key, value);
    }
}
```

### ณ. ุงุณุชูุงุฏู ุงุฒ Collectionูุง thread-safe

```java
ConcurrentHashMap<Integer, String> map = new ConcurrentHashMap<>();
map.putIfAbsent(key, value);
```

* ฺฉูุงุณโูุง `java.util.concurrent` ูุชุฏูุง ูุงููุฏ `putIfAbsent()` ุงุฑุงุฆู ูโุฏููุฏ ๐น

---

## ๐ ูุงุจุณุชฺฏ ุจู ูุชุฏูุง ู ูุดฺฉูุงุช ููุฒูุงู

ูุซุงู ุณุงุฏู: ฺฉ `IntegerIterator` ฺฉู ูุชุฏูุง `hasNext()`, `next()`, `getNextValue()` ุฏุงุฑุฏ.

```java
public class IntegerIterator implements Iterator<Integer> {
    private Integer nextValue = 0;

    public synchronized boolean hasNext() {
        return nextValue < 100000;
    }

    public synchronized Integer next() {
        if (nextValue == 100000)
            throw new IteratorPastEndException();
        return nextValue++;
    }

    public synchronized Integer getNextValue() {
        return nextValue;
    }
}
```

* ุงฺฏุฑ **ฺฉ Thread** ุงู Iterator ุฑุง ุงุฌุฑุง ฺฉูุฏุ ูุดฺฉู ูุณุช
* ุงูุง ุงฺฏุฑ **ุฏู Thread ูุดุชุฑฺฉ ุฏุงุดุชู ุจุงุดูุฏ**ุ ุงุญุชูุงู ุฑุฎ ุฏุงุฏู **ุงุณุชุซูุง ุฏุฑ ุขุฎุฑู ุนูุตุฑ** ูุฌูุฏ ุฏุงุฑุฏ
* ูุดฺฉู: Thread1 ูุฑุงุฎูุงู `hasNext()` ฺฉุฑุฏู ู ูุจู ุงุฒ `next()` ูุชููู ูโุดูุฏ

  * Thread2 ููุงู ูุชุฏูุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ู ูุถุนุช ุชุบุฑ ูโฺฉูุฏ
  * Thread1 ุฏูุจุงุฑู ุงุฏุงูู ูโุฏูุฏ ู **ููฺฉู ุงุณุช ุงุฒ ุงูุชูุง Iterator ุนุจูุฑ ฺฉูุฏ** โ๏ธ

---

## ๐ ุณู ุฑุงูโุญู ุจุฑุง ุงู ูุดฺฉู

### ฑ. ุชุญูู ุฎุทุง (Tolerate the Failure)

* ููฺฉู ุงุณุช ุฎุทุง **ุขุณุจ ูุฑุณุงูุฏ**
* ูุซู ูุซุงูุ ฺฉูุงูุช ูโุชูุงูุฏ Exception ุฑุง ฺฏุฑูุชู ู ูพุงฺฉุณุงุฒ ฺฉูุฏ
* โ๏ธ ุงู ุฑูุด **ฺฉู ุดูุฎุชู ุงุณุช**ุ ุดุจู ูพุงฺฉ ฺฉุฑุฏู Memory Leak ุจุง ุฑุณุชุงุฑุช ุดุจุงูู

---

### ฒ. ููู ฺฏุฐุงุฑ ุงุฒ ุณูุช ฺฉูุงูุช (Client-Based Locking)

```java
IntegerIterator iterator = new IntegerIterator();
while (true) {
    int nextValue;
    synchronized (iterator) {
        if (!iterator.hasNext())
            break;
        nextValue = iterator.next();
    }
    doSomethingWith(nextValue);
}
```

* ูุฑ ฺฉูุงูุช ุจุง `synchronized` ููู ุงุฌุงุฏ ูโฺฉูุฏ
* ุงู ฺฉุงุฑ **ุชฺฉุฑุงุฑ ฺฉุฏ** ุงุณุช ู **ุงุตู DRY ุฑุง ููุถ ูโฺฉูุฏ**
* ุงูุง ุจุฑุง ุงุจุฒุงุฑูุง ุบุฑ thread-safe ุดุฎุต ุซุงูุซ ุถุฑูุฑ ุงุณุช โ๏ธ

๐ก ุฎุทุฑ: ููู ุจุฑูุงููโููุณุงู ุจุงุฏ ุจู **ูููโฺฏุฐุงุฑ ุตุญุญ** ุฏูุช ฺฉููุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช ูุดฺฉูุงุช ูพููุงู ู ุฏุดูุงุฑ ุจุฑุง ุฑุฏุงุจ ุงุฌุงุฏ ูโุดูุฏ.

---

### ณ. ูููโฺฏุฐุงุฑ ุงุฒ ุณูุช ุณุฑูุฑ (Server-Based Locking)

* ุณุฑูุฑ ูุณุฆูู ูุฏุฑุช ุฏุณุชุฑุณ ููุฒูุงู ุงุณุช
* ฺฉูุงูุชโูุง ุจุฏูู ุชุบุฑ ฺฉุฏ ุงุตู ูโุชูุงููุฏ ุงุฒ ููุงุจุน ุจู ุตูุฑุช ุงูู ุงุณุชูุงุฏู ฺฉููุฏ
* **ุฑุงูฺฉุงุฑ ุจูุชุฑ ู ูุทูุฆูโุชุฑ ูุณุจุช ุจู ูููโฺฏุฐุงุฑ ุงุฒ ุณูุช ฺฉูุงูุช**

---

### ๐ ุฏุงุณุชุงู ูุงูุน ุงุฒ ูููโฺฏุฐุงุฑ ุณูุช ฺฉูุงูุช

* ุณุณุชู **Multi-terminal Time-Sharing** ุจุฑุง ุญุณุงุจุฏุงุฑ ฺฉ ุงุชุญุงุฏู
* ุงุณุชูุงุฏู ุงุฒ **Client-based Locking** ุจุฑุง ููุงุจุน ูุดุชุฑฺฉ
* ฺฉ ุจุฑูุงููโููุณ ูุฑุงููุด ูโฺฉูุฏ ูููโฺฏุฐุงุฑ ฺฉูุฏ
* ูุชุฌู: ฺฉ ุงุฒ ุชุฑููุงูโูุง ฺฏุงู โlock upโ ูโฺฉูุฏ
* ูุดฺฉู: **Ring-buffer counter** ุงุฒ ููุงููฺฏ ุจุง pointer ุฎุงุฑุฌ ุดุฏู ุจูุฏ
* ุฑุงูโุญู: ฺฉ **hack** ุจุฑุง ุฑุณุช ุฎูุฏฺฉุงุฑ buffer
* ุชุฌุฑุจู: **Client-based Locking ูโุชูุงูุฏ ุจุณุงุฑ ุฎุทุฑูุงฺฉ ุจุงุดุฏ** โ
* ุฏุฑุณ ููู: ููุดู ุชุง ุญุฏ ุงูฺฉุงู **ูุฏุฑุช ููุฒูุงู ุฑุง ุจู ุณุฑูุฑ ุจุณูพุงุฑุฏ**

## ูููโฺฏุฐุงุฑ ุณูุช ุณุฑูุฑ (Server-Based Locking) ๐

ุชฺฉุฑุงุฑ ฺฉุฏ ุฑุง ูโุชูุงู ุจุง ุงุนูุงู ุชุบุฑุงุช ุฒุฑ ุฑู `IntegerIterator` ุญุฐู ฺฉุฑุฏ:

```java
public class IntegerIteratorServerLocked {
    private Integer nextValue = 0;

    public synchronized Integer getNextOrNull() {
        if (nextValue < 100000)
            return nextValue++;
        else
            return null;
    }
}
```

ู ฺฉุฏ ฺฉูุงูุช ูู ุชุบุฑ ูโฺฉูุฏ:

```java
while (true) {
    Integer nextValue = iterator.getNextOrNull();
    if (nextValue == null)
        break;
    // do something with nextValue
}
```

ุฏุฑ ุงู ุญุงูุชุ ูุง **API ฺฉูุงุณ ุฎูุฏ ุฑุง ุจุฑุง ุขฺฏุงู ุงุฒ ฺูุฏ Thread ุจูุฏู ุชุบุฑ ุฏุงุฏูโุงู**. ฺฉูุงูุช ุจุงุฏ ุจุฑุฑุณ ฺฉูุฏ ฺฉู ููุฏุงุฑ null ูุณุชุ ุจู ุฌุง ฺฺฉ ฺฉุฑุฏู `hasNext()`.

ุจู ุทูุฑ ฺฉูุ ุจุงุฏ **ูููโฺฏุฐุงุฑ ุณูุช ุณุฑูุฑ** ุฑุง ุชุฑุฌุญ ุฏูุฏ ุจู ุฏูุงู ุฒุฑ:

* ฺฉุงูุด ฺฉุฏ ุชฺฉุฑุงุฑโูููโฺฏุฐุงุฑ ุณูุช ฺฉูุงูุช ูุฑ ฺฉูุงูุช ุฑุง ูุฌุจูุฑ ูโฺฉูุฏ ุชุง ุณุฑูุฑ ุฑุง ุฏุฑุณุช ููู ฺฉูุฏ. ุจุง ูุฑุงุฑ ุฏุงุฏู ฺฉุฏ ููู ุฏุฑ ุณุฑูุฑุ ฺฉูุงูุชโูุง ุขุฒุงุฏ ูุณุชูุฏ ุชุง ุงุฒ ุดุก ุงุณุชูุงุฏู ฺฉููุฏ ุจุฏูู ูฺฏุฑุงู ุงุฒ ููุดุชู ฺฉุฏ ููู ุงุถุงู.
* ุงูุฒุงุด ฺฉุงุฑุงโูโุชูุงู ฺฉ ุณุฑูุฑ thread-safe ุฑุง ุจุง ฺฉ ุณุฑูุฑ ุบุฑ thread-safe ุฏุฑ ุญุงูุช single-threaded ุฌุงฺฏุฒู ฺฉุฑุฏ ู ุชูุงู overhead ุงุถุงู ุฑุง ุญุฐู ฺฉุฑุฏ.
* ฺฉุงูุด ุงุญุชูุงู ุฎุทุงโููุท ฺฉุงู ุงุณุช ฺฉ ุจุฑูุงููโููุณ ููู ุฑุง ูุฑุงููุด ฺฉูุฏ.
* ุงุนูุงู ฺฉ ุณุงุณุช ูุงุญุฏโุณุงุณุช ุฏุฑ ฺฉ ูฺฉุงู ุงุณุชุ ุณุฑูุฑุ ุจู ุฌุง ุงูฺฉู ุฏุฑ ฺูุฏ ูฺฉุงู ูุฎุชููุ ูุฑ ฺฉูุงูุชุ ุจุงุดุฏ.
* ฺฉุงูุด ุฏุงููู ูุชุบุฑูุง ูุดุชุฑฺฉโฺฉูุงูุช ุงุฒ ุขููุง ู ูุญูู ููู ุดุฏู ุขููุง ุขฺฏุงู ูุณุช. ููู ฺุฒ ุฏุฑ ุณุฑูุฑ ูพููุงู ุงุณุช. ููุช ูุดฺฉู ูพุด ูโุขุฏุ ุชุนุฏุงุฏ ูฺฉุงูโูุง ุจุฑุฑุณ ฺฉูุชุฑ ุงุณุช.

ุงฺฏุฑ ฺฉุฏ ุณุฑูุฑ ุฑุง ุฏุฑ ุงุฎุชุงุฑ ูุฏุงุฑุฏ:

* ุงุฒ **ADAPTER** ุจุฑุง ุชุบุฑ API ู ุงุถุงูู ฺฉุฑุฏู ููู ุงุณุชูุงุฏู ฺฉูุฏ:

```java
public class ThreadSafeIntegerIterator {
    private IntegerIterator iterator = new IntegerIterator();

    public synchronized Integer getNextOrNull() {
        if(iterator.hasNext())
            return iterator.next();
        return null;
    }
}
```

* ุง ุจูุชุฑ ุงุณุชุ ุงุฒ **Collectionโูุง thread-safe ุจุง ุงูุชุฑูุณโูุง ฺฏุณุชุฑุด ุงูุชู** ุงุณุชูุงุฏู ฺฉูุฏ.

---

## ุงูุฒุงุด Throughput โก

ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ุจู ุงูุชุฑูุช ุจุฑูู ู ูุญุชูุง ูุฌููุนูโุง ุงุฒ ุตูุญุงุช ุฑุง ุงุฒ ูุณุช ุงุฒ URLูุง ุจุฎูุงูู. ุจุง ูุฑ ุตูุญู ุฎูุงูุฏู ุดุฏูุ ุขู ุฑุง ูพุฑุฏุงุฒุด ูโฺฉูู ุชุง ุขูุงุฑ ุฌูุนโุขูุฑ ุดูุฏ. ุจุนุฏ ุงุฒ ุฎูุงูุฏู ููู ุตูุญุงุชุ ฺฉ ฺฏุฒุงุฑุด ุฎูุงุตู ฺุงูพ ูโฺฉูู.

ฺฉูุงุณ ุฒุฑ ูุญุชูุง ฺฉ ุตูุญู ุฑุง ุจุง ุชูุฌู ุจู URL ุจุงุฒูโฺฏุฑุฏุงูุฏ:

```java
public class PageReader {
    //...
    public String getPageFor(String url) {
        HttpMethod method = new GetMethod(url);
        try {
            httpClient.executeMethod(method);
            String response = method.getResponseBodyAsString();
            return response;
        } catch (Exception e) {
            handle(e);
        } finally {
            method.releaseConnection();
        }
    }
}
```

ฺฉูุงุณ ุจุนุฏุ Iterator ุงุณุช ฺฉู ูุญุชูุง ุตูุญุงุช ุฑุง ุจุฑ ุงุณุงุณ Iterator ุงุฒ URLูุง ูุฑุงูู ูโฺฉูุฏ:

```java
public class PageIterator {
    private PageReader reader;
    private URLIterator urls;

    public PageIterator(PageReader reader, URLIterator urls) {
        this.urls = urls;
        this.reader = reader;
    }

    public synchronized String getNextPageOrNull() {
        if (urls.hasNext())
            return getPageFor(urls.next());
        else
            return null;
    }

    public String getPageFor(String url) {
        return reader.getPageFor(url);
    }
}
```

ฺฉ ููููู ุงุฒ `PageIterator` ูโุชูุงูุฏ ุจู ฺูุฏ Thread ูุฎุชูู ุจู ุงุดุชุฑุงฺฉ ฺฏุฐุงุดุชู ุดูุฏุ ูุฑ Thread ุงุฒ ููููู ุฎูุฏุด ุงุฒ `PageReader` ุจุฑุง ุฎูุงูุฏู ู ูพุฑุฏุงุฒุด ุตูุญุงุช ุงุณุชูุงุฏู ูโฺฉูุฏ.

ุชูุฌู ฺฉูุฏ ฺฉู **ุจููฺฉ synchronized ุจุณุงุฑ ฺฉูฺฺฉ ูฺฏู ุฏุงุดุชู ุดุฏู**. ููุท ุจุฎุด ุญุงุช ุฏุงุฎู `PageIterator` ุงุณุช. ููุดู ุจูุชุฑ ุงุณุช **ฺฉูุชุฑู ูุณูุช ููฺฉู ุฑุง ููฺฏุงูโุณุงุฒ ฺฉูุฏ** ุชุง ุจุดุชุฑู ูุณูุช ุฑุง.

---

### ูุญุงุณุจู Throughput ุจุง Single-Thread

ูุฑุถ ฺฉูุฏ ููุงุฏุฑ ุฒุฑ ุจุฑุง ูุญุงุณุจุงุช ุณุงุฏู ุงุนูุงู ุดูุฏ:

* ุฒูุงู I/O ุจุฑุง ุฏุฑุงูุช ฺฉ ุตูุญู (ูุงูฺฏู): ฑ ุซุงูู
* ุฒูุงู ูพุฑุฏุงุฒุด ุจุฑุง ุชุฌุฒู ุตูุญู (ูุงูฺฏู): ฐ.ต ุซุงูู
* I/O ูฺ CPU ูุตุฑู ููโฺฉูุฏุ ูพุฑุฏุงุฒุด ฑฐฐูช CPU ูุงุฒ ุฏุงุฑุฏ.

ุจุฑุง **N ุตูุญู ฺฉู ุชูุณุท ฺฉ Thread ูพุฑุฏุงุฒุด ูโุดููุฏ**ุ ุฒูุงู ฺฉู ุงุฌุฑุง ุจุฑุงุจุฑ ุงุณุช ุจุง:

```
1.5 ุซุงูู * N
```

ุดฺฉู A-1 ฺฉ ููููู ุงุฒ ฑณ ุตูุญู ุฑุง ูุดุงู ูโุฏูุฏ ฺฉู ุญุฏูุฏ ฑน.ต ุซุงูู ุทูู ูโฺฉุดุฏ.

<p align="center">
  <img src=../../../assets/image/Appendix_A/img-A.1.jpeg/>
</p>

## ูุญุงุณุจู Throughput ุจุง ฺูุฏ Thread ๐งตโก

ุงฺฏุฑ ุงูฺฉุงู ุฏุงุฑุฏ ุตูุญุงุช ุฑุง ุจู ูุฑ ุชุฑุชุจ ุฏุฑุงูุช ฺฉูู ู ูพุฑุฏุงุฒุด ุตูุญุงุช ูุณุชูู ุงุฒ ูู ุจุงุดุฏุ ูโุชูุงู ุงุฒ **ฺูุฏ Thread** ุจุฑุง ุงูุฒุงุด throughput ุงุณุชูุงุฏู ฺฉุฑุฏ.

ฺู ุงุชูุงู ูโุงูุชุฏ ุงฺฏุฑ ุงุฒ **ุณู Thread** ุงุณุชูุงุฏู ฺฉููุ ฺูุฏ ุตูุญู ูโุชูุงูู ุฏุฑ ููุงู ุฒูุงู ุฏุฑุงูุช ฺฉููุ

ููุงูโุทูุฑ ฺฉู ุฏุฑ ุดฺฉู A-2 ูุดุงูุฏู ูโฺฉูุฏุ **ุฑุงูโุญู ฺูุฏ Threadู** ุงุฌุงุฒู ูโุฏูุฏ ฺฉู ูพุฑุฏุงุฒุด ุตูุญุงุช ฺฉู ูุงุจุณุชู ุจู CPU ุงุณุชุ ุจุง ุฎูุงูุฏู ุตูุญุงุช ฺฉู ูุงุจุณุชู ุจู I/O ุงุณุช ููโูพูุดุงู ุฏุงุดุชู ุจุงุดุฏ.

ุฏุฑ ฺฉ ุฏูุง ุงุฏูโุขูุ ุงู ุนู **ูพุฑุฏุงุฒูุฏู ุจู ุทูุฑ ฺฉุงูู ููุฑุฏ ุงุณุชูุงุฏู ูุฑุงุฑ ูโฺฏุฑุฏ**. ูุฑ ุฎูุงูุฏู ฺฉโุซุงููโุง ุตูุญู ุจุง ุฏู ูพุฑุฏุงุฒุด ููโูพูุดุงู ุฏุงุฑุฏ. ุจูุงุจุฑุงู ูโุชูุงูู **ุฏู ุตูุญู ุฏุฑ ุซุงูู ูพุฑุฏุงุฒุด ฺฉูู**ุ ฺฉู **ุณู ุจุฑุงุจุฑ throughput ุฑุงูโุญู ุชฺฉโThreadู** ุงุณุช.

<p align="center">
  <img src=../../../assets/image/Appendix_A/img-A.2.jpeg/>
</p>

## ุจูโุจุณุช (Deadlock) โ๏ธ๐

ุชุตูุฑ ฺฉูุฏ ฺฉ **ูุจโุงูพูฺฉุดู** ุจุง ุฏู **ููุจุน ูุดุชุฑฺฉ ูุญุฏูุฏ** ุฏุงุฑู:

* ฺฉ **ูพูู ุงุฒ ุงุชุตุงูโูุง ุฏุชุงุจุณ** ุจุฑุง ุฐุฎุฑูโุณุงุฒ ฺฉุงุฑ ุฏุฑ ุญุงู ุงูุฌุงู ูุญู
* ฺฉ **ูพูู ุงุฒ ุงุชุตุงูโูุง MQ** ุจู ูุฎุฒู ุงุตู

ูุฑุถ ฺฉูุฏ ุฏู ุนููุงุช ุฏุฑ ุงู ุงูพูฺฉุดู ูุฌูุฏ ุฏุงุฑุฏ: **Create** ู **Update**

* **Create** โ ุงุจุชุฏุง ุงุชุตุงู ุจู ูุฎุฒู ุงุตู ู ุฏุชุงุจุณ ฺฏุฑูุชู ูโุดูุฏุ ุณูพุณ ุจุง ุณุฑูุณ ูุฎุฒู ุงุตู ุตุญุจุช ูโฺฉูุฏ ู ุจุนุฏ ฺฉุงุฑ ุฑุง ุฏุฑ ุฏุชุงุจุณ ูุญู ุฐุฎุฑู ูโฺฉูุฏ.
* **Update** โ ุงุจุชุฏุง ุงุชุตุงู ุจู ุฏุชุงุจุณ ู ุณูพุณ ุจู ูุฎุฒู ุงุตู ฺฏุฑูุชู ูโุดูุฏุ ุฏุงุฏูโูุง ุงุฒ ุฏุชุงุจุณ ูุญู ุฎูุงูุฏู ุดุฏู ู ุจู ูุฎุฒู ุงุตู ุงุฑุณุงู ูโุดููุฏ.

ุญุงูุง ฺู ุงุชูุงู ูโุงูุชุฏ ููุช ุชุนุฏุงุฏ ฺฉุงุฑุจุฑุงู ุจุดุชุฑ ุงุฒ ุงูุฏุงุฒู ูุฑ **ูพูู** ุจุงุดุฏุ ูุฑุถ ฺฉูุฏ ูุฑ ูพูู ุงูุฏุงุฒูโุงุด ุฏู ุงุณุช:

1. ุฏู ฺฉุงุฑุจุฑ ุนููุงุช **Create** ุฑุง ุงุฌุฑุง ูโฺฉููุฏุ ุจูุงุจุฑุงู **ุชูุงู ฑฐ ุงุชุตุงู ุฏุชุงุจุณ ฺฏุฑูุชู ูโุดูุฏ** ู ูุฑ Thread ุจุนุฏ ุงุฒ ฺฏุฑูุชู ุงุชุตุงู ุฏุชุงุจุณ ุงูุง ูุจู ุงุฒ ฺฏุฑูุชู ุงุชุตุงู ุจู ูุฎุฒู ุงุตู ูุชููู ูโุดูุฏ.
2. ุฏู ฺฉุงุฑุจุฑ ุนููุงุช **Update** ุฑุง ุงุฌุฑุง ูโฺฉููุฏุ ุจูุงุจุฑุงู **ุชูุงู ฑฐ ุงุชุตุงู ูุฎุฒู ุงุตู ฺฏุฑูุชู ูโุดูุฏ** ู ูุฑ Thread ุจุนุฏ ุงุฒ ฺฏุฑูุชู ุงุชุตุงู ูุฎุฒู ุงุตู ุงูุง ูุจู ุงุฒ ฺฏุฑูุชู ุงุชุตุงู ุฏุชุงุจุณ ูุชููู ูโุดูุฏ.
3. ุญุงูุง ุฏู Thread ูุฑุจูุท ุจู **Create** ุจุงุฏ ููุชุธุฑ ุงุชุตุงู ุจู ูุฎุฒู ุงุตู ุจูุงููุฏุ ู ุฏู Thread ูุฑุจูุท ุจู **Update** ุจุงุฏ ููุชุธุฑ ุงุชุตุงู ุฏุชุงุจุณ ุจุงุดูุฏ.
4. **ุจูโุจุณุช!** ุณุณุชู ุฏฺฏุฑ ูุฑฺฏุฒ ุจุงุฒุงุจ ููโุดูุฏ.

ููฺฉู ุงุณุช ุงู ุณูุงุฑู ุบุฑูุงูุน ุจู ูุธุฑ ุจุฑุณุฏุ ุงูุง ฺู ฺฉุณ ุณุณุชู ุฑุง ูโุฎูุงูุฏ ฺฉู ูุฑ ููุชู ฺฉโุจุงุฑ ฺฉุงููุงู ููู ุดูุฏุ ฺู ฺฉุณ ูโุฎูุงูุฏ ุณุณุชู ุฑุง ุจุง ุนูุงุฆู ุบุฑูุงุจู ุจุงุฒุชููุฏ ุงุดฺฉุงูโุฒุฏุง ฺฉูุฏุ ฺูู ูุดฺฉูุงุช ุฏุฑ ูุญุท ูุงูุน ุงุชูุงู ูโุงูุชูุฏ ู ููุชูโูุง ุทูู ูโฺฉุดุฏ ุชุง ุญู ุดููุฏ.

ฺฉ ยซุฑุงูโุญูยป ูุนูููุ ุงุถุงูู ฺฉุฑุฏู ุฏุณุชูุฑุงุช **debugging** ุงุณุช ุชุง ุจูููู ฺู ุงุชูุงู ูโุงูุชุฏ. ุงูุจุชูุ ฺฉุฏ debug ุขููุฏุฑ ุณุณุชู ุฑุง ุชุบุฑ ูโุฏูุฏ ฺฉู ุจูโุจุณุช ุฏุฑ ุดุฑุงุท ุฏฺฏุฑ ุฑุฎ ุฏูุฏ ู ูุงูโูุง ุจุนุฏ ุฏูุจุงุฑู ุงุชูุงู ุจูุชุฏ.

### ุดุฑุงุท ูุงุฒู ุจุฑุง ูููุน ุจูโุจุณุช

ฑ. **ุงูุญุตุงุฑ ูุชูุงุจู (Mutual Exclusion)**
ุฒูุงู ฺฉู ฺูุฏ Thread ูุงุฒ ุฏุงุฑูุฏ ุงุฒ ฺฉ ููุจุน ูุดุชุฑฺฉ ุงุณุชูุงุฏู ฺฉููุฏ ู ุงู ููุงุจุน:

* ููโุชูุงููุฏ ููุฒูุงู ุชูุณุท ฺูุฏ Thread ุงุณุชูุงุฏู ุดููุฏ
* ุชุนุฏุงุฏุดุงู ูุญุฏูุฏ ุงุณุช
  ูุซุงู ูุนููู: ุงุชุตุงู ุฏุชุงุจุณุ ูุงู ุจุงุฒ ุจุฑุง ููุดุชูุ ููู ุฑฺฉูุฑุฏ ุง Semaphore

ฒ. **ููู ู ุงูุชุธุงุฑ (Lock & Wait)**
ููุช ฺฉ Thread ููุจุน ุฑุง ฺฏุฑูุชุ ุขู ุฑุง ุขุฒุงุฏ ููโฺฉูุฏ ุชุง ุชูุงู ููุงุจุน ุฏฺฏุฑ ููุฑุฏ ูุงุฒุด ุฑุง ูฺฏุฑูุชู ู ฺฉุงุฑุด ุฑุง ฺฉุงูู ูฺฉุฑุฏู ุจุงุดุฏ.

ณ. **ุนุฏู ูพุดโุฏุณุช (No Preemption)**
ฺฉ Thread ููโุชูุงูุฏ ููุงุจุน Thread ุฏฺฏุฑ ุฑุง ุจฺฏุฑุฏ. ุชููุง ุฑุงู ุฏุณุชุฑุณ Thread ุฏฺฏุฑุ ุขุฒุงุฏ ฺฉุฑุฏู ููุจุน ุชูุณุท Thread ูุนู ุงุณุช.

ด. **ุงูุชุธุงุฑ ุฏุงุฑูโุง (Circular Wait)**
ุงู ูุถุนุช ุจู ยซุฏุฑ ุขุบูุด ูุฑฺฏยป ูู ูุนุฑูู ุงุณุช.
ุชุตูุฑ ฺฉูุฏ ุฏู Threadุ **T1 ู T2** ู ุฏู ููุจุน **R1 ู R2** ุฏุงุฑู.

* T1ุ R1 ุฑุง ุฏุงุฑุฏ
* T2ุ R2 ุฑุง ุฏุงุฑุฏ
* T1 ููฺูู ุจู R2 ูุงุฒ ุฏุงุฑุฏ
* T2 ููฺูู ุจู R1 ูุงุฒ ุฏุงุฑุฏ

ุงู ูุถุนุช ุดุจู ุดฺฉู **A-3** ุงุณุช:
<p align="center">
  <img src=../../../assets/image/Appendix_A/img-A.3.jpeg/>
</p>

ุชูุงู ุงู ฺูุงุฑ ุดุฑุท ุจุงุฏ ุจุฑูุฑุงุฑ ุจุงุดูุฏ ุชุง ุจูโุจุณุช ุงุชูุงู ุจูุชุฏ. ุงฺฏุฑ ุญุช ฺฉ ุงุฒ ุงู ุดุฑุงุท ุดฺฉุณุชู ุดูุฏุ ุจูโุจุณุช ุบุฑููฺฉู ุงุณุช.

### ุดฺฉุณุชู ุดุฑุท Mutual Exclusion

ฺฉ ุงุฒ ุฑุงูโูุง ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุจูโุจุณุชุ ุฏูุฑ ุฒุฏู ุดุฑุท **ุงูุญุตุงุฑ ูุชูุงุจู** ุงุณุช. ูโุชูุงู ุงู ฺฉุงุฑ ุฑุง ุจุง:

* ุงุณุชูุงุฏู ุงุฒ ููุงุจุน ฺฉู ุงุฌุงุฒู ุงุณุชูุงุฏู ููุฒูุงู ูโุฏููุฏุ ูุซู **AtomicInteger**
* ุงูุฒุงุด ุชุนุฏุงุฏ ููุงุจุน ุชุง ุจุฑุงุจุฑ ุง ุจุดุชุฑ ุงุฒ ุชุนุฏุงุฏ Threadูุง ุฑูุงุจุช ุดูุฏ
* ุจุฑุฑุณ ุงูฺฉู ุชูุงู ููุงุจุน ุขุฒุงุฏ ูุณุชูุฏ ูุจู ุงุฒ ฺฏุฑูุชู ูุฑ ฺฉุฏุงู

ูุชุฃุณูุงูู ุงฺฉุซุฑ ููุงุจุน ูุญุฏูุฏ ูุณุชูุฏ ู ุงุฌุงุฒู ุงุณุชูุงุฏู ููุฒูุงู ููโุฏููุฏ. ฺฏุงู ูู ููุช ุฏููู ููุจุน ุจู ูุชุฌู ุนููุงุช ุฑู ููุจุน ุงูู ุจุณุชฺฏ ุฏุงุฑุฏ.

### ุดฺฉุณุชู ุดุฑุท Lock & Wait

ุฑุงู ุฏฺฏุฑ ุงู ุงุณุช ฺฉู ุงุฒ ุงูุชุธุงุฑ ุฎูุฏุฏุงุฑ ฺฉูู. ูุจู ุงุฒ ฺฏุฑูุชู ูุฑ ููุจุน ุขู ุฑุง ุจุฑุฑุณ ฺฉุฑุฏู ู ุงฺฏุฑ ูุดุบูู ุจูุฏุ ุชูุงู ููุงุจุน ฺฏุฑูุชู ุดุฏู ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู ุฏูุจุงุฑู ุดุฑูุน ฺฉูู.

ุงู ุฑูุด ูุดฺฉูุงุช ุฏุงุฑุฏ:

* **Starvation** โ ฺฉ Thread ููฺฉู ุงุณุช ููุดู ูุชูุงูุฏ ููุงุจุน ููุฑุฏ ูุงุฒุด ุฑุง ุจฺฏุฑุฏ.
* **Livelock** โ ฺูุฏ Thread ููฺฉู ุงุณุช ููุฒูุงู ฺฉ ููุจุน ุฑุง ุจฺฏุฑูุฏ ู ุขุฒุงุฏ ฺฉููุฏุ ุจุงุฑูุง ู ุจุงุฑูุงุ ูุฎุตูุตุงู ุจุง ุงูฺฏูุฑุชูโูุง ุณุงุฏู ุฒูุงูโุจูุฏ CPU.

ุงฺฏุฑฺู ุงู ุฑูุด ูุงฺฉุงุฑุขูุฏ ุจู ูุธุฑ ูโุฑุณุฏุ ุจูุชุฑ ุงุฒ ูฺ ุงุณุช ู ุชูุฑุจุงู ููุดู ูุงุจู ูพุงุฏูโุณุงุฒ ุงุณุช.

### ุดฺฉุณุชู ุดุฑุท No Preemption

ุฑุงู ุฏฺฏุฑุ ุงุฌุงุฒู ุฏุงุฏู ุจู Threadูุง ุจุฑุง ฺฏุฑูุชู ููุงุจุน ุงุฒ Threadูุง ุฏฺฏุฑ ุงุณุช. ูุนูููุงู ุงุฒ ฺฉ ูฺฉุงูุฒู ุฏุฑุฎูุงุณุช ุณุงุฏู ุงุณุชูุงุฏู ูโุดูุฏ. ููุช ฺฉ Thread ูโุจูุฏ ููุจุน ูุดุบูู ุงุณุชุ ุงุฒ ูุงูฺฉ ุขู ูโุฎูุงูุฏ ุขุฒุงุฏุด ฺฉูุฏ. ุงฺฏุฑ ูุงูฺฉ ูู ููุชุธุฑ ููุจุน ุฏฺฏุฑ ุจุงุดุฏุ ููู ููุงุจุน ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู ุฏูุจุงุฑู ุดุฑูุน ูโฺฉูุฏ.

ุงู ูุดุงุจู ุฑูุด ูุจู ุงุณุช ุงูุง ูุฒุช ุฏุงุฑุฏ ฺฉู Thread ูโุชูุงูุฏ ุจุฑุง ููุจุน ุตุจุฑ ฺฉูุฏ ู ุชุนุฏุงุฏ ุดุฑูุน ูุฌุฏุฏูุง ฺฉูุชุฑ ูโุดูุฏ.

### ุดฺฉุณุชู ุดุฑุท Circular Wait

ุงู ุฑุงุฌโุชุฑู ุฑูุด ุฌููฺฏุฑ ุงุฒ ุจูโุจุณุช ุงุณุช. ุงุบูุจ ุณุณุชูโูุง ุจุง ฺฉ **ูุฑุงุฑุฏุงุฏ ุณุงุฏู** ุจู ููู Threadูุง ฺฉุงุฑ ูโฺฉููุฏ.

ูุซูุงู ุฏุฑ ูุซุงู Thread1 ู Thread2 ู ููุงุจุน R1 ู R2ุ ุงฺฏุฑ ููู Threadูุง ููุงุจุน ุฑุง ุจู ููุงู ุชุฑุชุจ ุชุฎุตุต ุฏููุฏุ ุงูุชุธุงุฑ ุฏุงุฑูโุง ุบุฑููฺฉู ูโุดูุฏ.

ุงูุง ูุดฺฉูุงุช ูู ุฏุงุฑุฏ:

* ุชุฑุชุจ ฺฏุฑูุชู ููุงุจุน ููฺฉู ุงุณุช ุจุง ุชุฑุชุจ ุงุณุชูุงุฏู ุงุฒ ุขูโูุง ููโุฎูุงู ูุฏุงุดุชู ุจุงุดุฏุ ุจูุงุจุฑุงู ููุงุจุน ููฺฉู ุงุณุช ุทููุงูโุชุฑ ุงุฒ ูุงุฒ ููู ุดููุฏ.
* ฺฏุงู ููโุชูุงู ุชุฑุชุจ ููุงุจุน ุฑุง ุงุนูุงู ฺฉุฑุฏุ ูุซูุงู ููุช ID ููุจุน ุฏูู ุงุฒ ูุชุฌู ููุจุน ุงูู ุจุฏุณุช ูโุขุฏ.

### ูฺฉุชู

ุฑุงูโูุง ุฒุงุฏ ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุจูโุจุณุช ูุฌูุฏ ุฏุงุฑุฏุ ุจุนุถ ุจุงุนุซ **starvation** ู ุจุนุถ ูุตุฑู ุจุงูุง CPU ู ฺฉุงูุด ูพุงุณุฎฺฏู ูโุดููุฏ.

ุงุฒููู ฺฉุฑุฏู ุจุฎุด Threadูุง ุจุฑุง **ุชูุธู ู ุขุฒูุงุด** ุฑุงู ูุฏุฑุชููุฏ ุจุฑุง ูพุฏุง ฺฉุฑุฏู ุจูุชุฑู ุงุณุชุฑุงุชฺ ุงุณุช.

---

### ุชุณุช ฺฉุฏ ฺูุฏูุฎ

ฺฺฏููู ูโุชูุงู ุชุณุช ููุดุช ุชุง ูุดุงู ุฏูุฏ ฺฉุฏ ุฒุฑ ุฎุฑุงุจ ุงุณุชุ

```java
01: public class ClassWithThreadingProblem { 
02:    int nextId; 
03: 
04:    public int takeNextId() { 
05:        return nextId++; 
06:    } 
07:} 
```

ุดุฑุญ ุชุณุช:

* ููุฏุงุฑ ูุนู `nextId` ุฑุง ุงุฏุฏุงุดุช ฺฉูุฏ.
* ุฏู Thread ุงุฌุงุฏ ฺฉูุฏ ฺฉู ูุฑฺฉุฏุงู `takeNextId()` ุฑุง ฺฉ ุจุงุฑ ุตุฏุง ุจุฒููุฏ.
* ุจุฑุฑุณ ฺฉูุฏ ฺฉู `nextId` ุฏู ูุงุญุฏ ุจุดุชุฑ ุงุฒ ููุฏุงุฑ ุงููู ุจุงุดุฏ.
* ุงู ฺฉุงุฑ ุฑุง ุชฺฉุฑุงุฑ ฺฉูุฏ ุชุง ุจุจูุฏ `nextId` ุชููุง ฺฉ ูุงุญุฏ ุงูุฒุงุด ุงูุชู ุงุณุช.

### ููููู ุชุณุช (JUnit)

```java
01: package example;
02:
03: import static org.junit.Assert.fail;
04:
05: import org.junit.Test;
06:
07: public class ClassWithThreadingProblemTest {
08:     @Test
09:     public void twoThreadsShouldFailEventually() throws Exception {
10:         final ClassWithThreadingProblem classWithThreadingProblem
                = new ClassWithThreadingProblem();
11:
12:         Runnable runnable = new Runnable() {
13:             public void run() {
14:                 classWithThreadingProblem.takeNextId();
15:             }
16:         };
17:
18:         for (int i = 0; i < 50000; ++i) {
19:             int startingId = classWithThreadingProblem.lastId;
20:             int expectedResult = 2 + startingId;
21:
22:             Thread t1 = new Thread(runnable);
23:             Thread t2 = new Thread(runnable);
24:             t1.start();
25:             t2.start();
26:             t1.join();
27:             t2.join();
28:
29:             int endingId = classWithThreadingProblem.lastId;
30:
31:             if (endingId != expectedResult)
32:                 return;
33:         }
34:
35:         fail("Should have exposed a threading issue but it did not.");
36:     }
37: }
```

| Line  | Description                                                                                                                                                                                                                                               |
| ----- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 10    | ุงุฌุงุฏ ฺฉ ููููู ุงุฒ ฺฉูุงุณ **ClassWithThreadingProblem**. ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุจุงุฏ ุงุฒ ฺฉูุฏูุงฺู `final` ุงุณุชูุงุฏู ฺฉูู ุฒุฑุง ุฏุฑ ุงุฏุงูู ุฏุฑ ฺฉ ฺฉูุงุณ ุฏุงุฎู ูุงุดูุงุณ ุงุณุชูุงุฏู ูโุดูุฏ.                                                                                     |
| 12โ16 | ุงุฌุงุฏ ฺฉ ฺฉูุงุณ ุฏุงุฎู ูุงุดูุงุณ ฺฉู ุงุฒ ููุงู ููููู ุงุณุชูุงุฏู ูโฺฉูุฏ.                                                                                                                                                                                               |
| 18    | ุงู ฺฉุฏ ุฑุง ยซุจู ุงูุฏุงุฒู ฺฉุงูยป ุงุฌุฑุง ูโฺฉูู ุชุง ูุดุงู ุฏูุฏ ฺฉุฏ ุฎุฑุงุจ ุงุณุชุ ุงูุง ูู ุขูโูุฏุฑ ุฒุงุฏ ฺฉู ุชุณุช ุทููุงู ุดูุฏ. ุงู ฺฉ ุชุนุงุฏู ุงุณุชุ ููโุฎูุงูู ุฒูุงู ุฒุงุฏ ููุชุธุฑ ุดฺฉุณุช ุจุงุดู. ุงูุชุฎุงุจ ุงู ุนุฏุฏ ุณุฎุช ุงุณุชโุงฺฏุฑฺู ุจุนุฏุงู ูโุจูู ูโุชูุงูู ุขู ุฑุง ุจู ุทูุฑ ูุงุจู ุชูุฌู ฺฉุงูุด ุฏูู. |
| 19    | ููุฏุงุฑ ุดุฑูุน ุฑุง ุจู ุฎุงุทุฑ ุจุณูพุงุฑุฏ. ุงู ุชุณุช ูุตุฏ ุฏุงุฑุฏ ุซุงุจุช ฺฉูุฏ ฺฉุฏ ุฏุฑ **ClassWithThreadingProblem** ุฎุฑุงุจ ุงุณุช. ุงฺฏุฑ ุชุณุช ูููู ุดูุฏุ ุซุงุจุช ูโฺฉูุฏ ฺฉุฏ ุฎุฑุงุจ ุงุณุช. ุงฺฏุฑ ุชุณุช ุดฺฉุณุช ุจุฎูุฑุฏุ ุชุณุช ูุชูุงูุณุช ุซุงุจุช ฺฉูุฏ ฺฉุฏ ุฎุฑุงุจ ุงุณุช.                                                   |
| 20    | ุงูุชุธุงุฑ ุฏุงุฑู ููุฏุงุฑ ููุง ุฏู ูุงุญุฏ ุจุดุชุฑ ุงุฒ ููุฏุงุฑ ูุนู ุจุงุดุฏ.                                                                                                                                                                                                |
| 22โ23 | ุงุฌุงุฏ ุฏู Thread ฺฉู ูุฑ ุฏู ุงุฒ ููููู ุงุฌุงุฏ ุดุฏู ุฏุฑ ุฎุทูุท 12โ16 ุงุณุชูุงุฏู ูโฺฉููุฏ. ุงู ุงูฺฉุงู ุฑุง ูโุฏูุฏ ฺฉู ุฏู Thread ุณุน ฺฉููุฏ ุงุฒ ููุงู ููููู ุงุณุชูุงุฏู ฺฉุฑุฏู ู ุจุง ูู ุชุฏุงุฎู ุฏุงุดุชู ุจุงุดูุฏ.                                                                                |

| Line  | Description                                                                                                                                                               |
| ----- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 24โ25 | ุงุฌุงุฒู ูโุฏูู ุฏู Thread ูุง ุขูุงุฏู ุงุฌุฑุง ุดููุฏ.                                                                                                                               |
| 26โ27 | ููุชุธุฑ ูโูุงูู ุชุง ูุฑ ุฏู Thread ูุจู ุงุฒ ุจุฑุฑุณ ูุชุงุฌ ุจู ูพุงุงู ุจุฑุณูุฏ.                                                                                                         |
| 29    | ููุฏุงุฑ ููุง ูุงูุน ุฑุง ุซุจุช ูโฺฉูู.                                                                                                                                         |
| 31โ32 | ุขุง ููุฏุงุฑ `endingId` ุจุง ฺุฒ ฺฉู ุงูุชุธุงุฑ ุฏุงุดุชู ูุชูุงูุช ุจูุฏุ ุงฺฏุฑ ุจููุ ุชุณุช ุฑุง ูพุงุงู ูโุฏููโูุง ุซุงุจุช ฺฉุฑุฏู ฺฉุฏ ุฎุฑุงุจ ุงุณุช. ุงฺฏุฑ ููุ ุฏูุจุงุฑู ุชูุงุด ูโฺฉูู.                           |
| 35    | ุงฺฏุฑ ุจู ุงูุฌุง ุฑุณุฏูุ ุชุณุช ูุชูุงูุณุช ุซุงุจุช ฺฉูุฏ ฺฉุฏ ุชููุฏ ุฏุฑ ยซุฒูุงู ูุนูููยป ุฎุฑุงุจ ุงุณุชุ ุชุณุช ุดฺฉุณุช ุฎูุฑุฏู ุงุณุช. ุง ฺฉุฏ ุฎุฑุงุจ ูุณุช ุง ุชุนุฏุงุฏ ุชฺฉุฑุงุฑูุง ุจุฑุง ุฑุฎ ุฏุงุฏู ุดุฑุงุท ุฎุทุง ฺฉุงู ูุจูุฏู ุงุณุช. |

ุงู ุชุณุช ูุทุนุงู ุดุฑุงุท ูุงุฒู ุจุฑุง ฺฉ ูุดฺฉู ุจูโุฑูุฒุฑุณุงู ููโุฒูุงู ุฑุง ูุฑุงูู ูโฺฉูุฏ. ุจุง ุงู ุญุงูุ ูุดฺฉู ุขูโูุฏุฑ ุจู ูุฏุฑุช ุฑุฎ ูโุฏูุฏ ฺฉู ุฏุฑ ุงฺฉุซุฑ ููุงูุน ุงู ุชุณุช ุขู ุฑุง ุชุดุฎุต ููโุฏูุฏ. ุฏุฑ ูุงูุนุ ุจุฑุง ุดูุงุณุง ูุงูุน ูุดฺฉูุ ุจุงุฏ ุชุนุฏุงุฏ ุชฺฉุฑุงุฑูุง ุฑุง ุจุด ุงุฒ ฺฉ ูููู ูุฑุงุฑ ุฏูู. ุญุช ุฏุฑ ุงู ุตูุฑุชุ ุฏุฑ ุฏู ุงุฌุฑุง ูุฎุชูู ุจุง ุดูุงุฑุด ุญููู ฑุฐฐฐุฐฐฐุ ูุดฺฉู ุชููุง ฺฉ ุจุงุฑ ุฑุฎ ุฏุงุฏ. ุงู ุนู ุงุญุชูุงูุงู ุจุงุฏ ุชุนุฏุงุฏ ุชฺฉุฑุงุฑูุง ุฑุง ุจู ุตุฏ ูููู ุง ุจุดุชุฑ ุงูุฒุงุด ุฏูู ุชุง ุดฺฉุณุช ูุงุจู ุงุนุชูุงุฏ ุจู ุฏุณุช ุขูุฑู. ฺูุฏุฑ ุญุงุถุฑ ูุณุชู ุตุจุฑ ฺฉููุ

ุญุช ุงฺฏุฑ ุชุณุช ุฑุง ุทูุฑ ุชูุธู ฺฉูู ฺฉู ุดฺฉุณุช ูุงุจู ุงุนุชูุงุฏ ุฑู ฺฉ ูุงุดู ุญุงุตู ุดูุฏุ ุงุญุชูุงูุงู ุจุงุฏ ุชุณุช ุฑุง ุจุง ููุงุฏุฑ ูุชูุงูุช ุฏูุจุงุฑู ุชูุธู ฺฉูู ุชุง ุดฺฉุณุช ุฑุง ุฑู ูุงุดูุ ุณุณุชูโุนุงูู ุง ูุณุฎู ุฏฺฏุฑ ุงุฒ JVM ูุดุงู ุฏูู.

ู ุงู ฺฉ ูุดฺฉู ุณุงุฏู ุงุณุช. ุงฺฏุฑ ูุชูุงูู ฺฉุฏ ุฎุฑุงุจ ุฑุง ุจู ุฑุงุญุช ุจุง ุงู ูุดฺฉู ูุดุงู ุฏููุ ฺฺฏููู ูโุชูุงูู ูุดฺฉูุงุช ูพฺุฏู ูุงูุน ุฑุง ุชุดุฎุต ุฏููุ

ูพุณ ฺู ุฑูฺฉุฑุฏูุง ูโุชูุงูู ุจุฑุง ูุดุงู ุฏุงุฏู ุงู ุดฺฉุณุช ุณุงุฏู ุงุชุฎุงุฐ ฺฉููุ ู ูููโุชุฑ ุงุฒ ุขูุ ฺฺฏููู ูโุชูุงูู ุชุณุชโูุง ุจููุณู ฺฉู ุดฺฉุณุชโูุง ุฑุง ุฏุฑ ฺฉุฏ ูพฺุฏูโุชุฑ ูุดุงู ุฏููุฏุ ฺฺฏููู ูโุชูุงูู ุจูููู ฺฉุฏ ูุง ุฏุงุฑุง ุฎุทุง ุงุณุช ููุช ููโุฏุงูู ฺฉุฌุง ุจู ุฏูุจุงู ุขู ุจฺฏุฑุฏูุ

ฺูุฏ ุงุฏู ูุฌูุฏ ุฏุงุฑุฏ:

* **ุชุณุช ูููุช ฺฉุงุฑูู (Monte Carlo Testing):** ุชุณุชโูุง ุฑุง ุงูุนุทุงูโูพุฐุฑ ุทุฑุงุญ ฺฉูุฏ ุชุง ูุงุจู ุชูุธู ุจุงุดูุฏ. ุณูพุณ ุชุณุช ุฑุง ุจุงุฑูุง ุงุฌุฑุง ฺฉูุฏโูุซูุงู ุฑู ฺฉ ุณุฑูุฑ ุชุณุชโุจุง ุชุบุฑ ุชุตุงุฏู ููุงุฏุฑ ุชูุธู ุดุฏู. ุงฺฏุฑ ุชุณุชโูุง ุดฺฉุณุช ุฎูุฑุฏูุฏุ ฺฉุฏ ุฎุฑุงุจ ุงุณุช. ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู ููุดุชู ุงู ุชุณุชโูุง ุฑุง ุฒูุฏ ุดุฑูุน ฺฉูุฏ ุชุง ฺฉ ุณุฑูุฑ ุงุฏุบุงู ูุฏุงูู ุขููุง ุฑุง ุจู ุฒูุฏ ุงุฌุฑุง ฺฉูุฏ. ููฺููุ ุดุฑุงุท ฺฉู ุชุณุช ุฏุฑ ุขู ุดฺฉุณุช ุฎูุฑุฏู ุฑุง ุจุง ุฏูุช ุซุจุช ฺฉูุฏ.
* ุชุณุช ุฑุง ุฑู **ุชูุงู ูพูุชูุฑูโูุง ูุฏู** ุงุฌุฑุง ฺฉูุฏ. ุจูโุทูุฑ ูุฏุงูู. ูุฑฺู ุชุณุชโูุง ูุฏุช ุทููุงูโุชุฑ ุจุฏูู ุดฺฉุณุช ุงุฌุฑุง ุดููุฏุ ุงุญุชูุงู ุจุดุชุฑ ุฏุงุฑุฏ ฺฉูโฺฉุฏ ุชููุฏ ุฏุฑุณุช ุงุณุช ุงโุชุณุชโูุง ุจุฑุง ุขุดฺฉุงุฑ ฺฉุฑุฏู ูุดฺฉูุงุช ฺฉุงู ูุณุชูุฏ.
* ุชุณุชโูุง ุฑุง ุฑู ูุงุดู ุจุง **ุจุงุฑูุง ูุฎุชูู** ุงุฌุฑุง ฺฉูุฏ. ุงฺฏุฑ ูโุชูุงูุฏ ุจุงุฑูุง ูุฒุฏฺฉ ุจู ูุญุท ุชููุฏ ุดุจูโุณุงุฒ ฺฉูุฏุ ุงูุฌุงู ุฏูุฏ.

ุจุง ุงู ุญุงูุ ุญุช ุงฺฏุฑ ููู ุงู ฺฉุงุฑูุง ุฑุง ุงูุฌุงู ุฏูุฏุ ูููุฒ ุดุงูุณ ุฒุงุฏ ุจุฑุง ูพุฏุง ฺฉุฑุฏู ูุดฺฉูุงุช ููโุฒูุงู ุฏุฑ ฺฉุฏ ุฎูุฏ ูุฏุงุฑุฏ. ูพฺุฏูโุชุฑู ูุดฺฉูุงุชุ ุขูโูุง ูุณุชูุฏ ฺฉู ฺูุงู ูุงุฏุฑูุฏ ฺฉู ุชููุง ฺฉ ุจุงุฑ ุฏุฑ ูุฑ ููุงุฑุฏ ูุฑุตุช ุฑุฎ ูโุฏููุฏ. ุงู ูุดฺฉูุงุชุ ูุญุดุช ุณุณุชูโูุง ูพฺุฏู ูุณุชูุฏ.

### ูพุดุชุจุงู ุงุจุฒุงุฑ ุจุฑุง ุชุณุช ฺฉุฏ ูุจุชู ุจุฑ Thread

ุดุฑฺฉุช IBM ุงุจุฒุงุฑ ุจู ูุงู **ConTest** ุณุงุฎุชู ุงุณุช. ุงู ุงุจุฒุงุฑ ฺฉูุงุณโูุง ุฑุง ุงุจุฒุงุฑุฏู ูโฺฉูุฏ ุชุง ุงุญุชูุงู ุดฺฉุณุช ฺฉุฏ ุบุฑ ููโุฒูุงู ุงูุฒุงุด ุงุจุฏ.

ูุง ูฺ ุฑุงุจุทู ูุณุชูู ุจุง IBM ุง ุชู ุชูุณุนูโุฏููุฏู ConTest ูุฏุงุฑู. ฺฉ ุงุฒ ููฺฉุงุฑุงู ูุง ุจู ุขู ุงุดุงุฑู ฺฉุฑุฏ ู ูุง ูพุณ ุงุฒ ฺูุฏ ุฏููู ุงุณุชูุงุฏูุ ุจูุจูุฏ ูุงุจู ุชูุฌู ุฏุฑ ุชูุงูุง ุงูุชู ูุดฺฉูุงุช ููโุฒูุงู ูุดุงูุฏู ฺฉุฑุฏู.

ุฑุงูููุง ุงุณุชูุงุฏู ุงุฒ ConTest:

* ุชุณุชโูุง ู ฺฉุฏ ุชููุฏ ุฑุง ุจููุณุฏุ ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู ุชุณุชโูุง ุจูโุทูุฑ ุฎุงุต ุจุฑุง ุดุจูโุณุงุฒ ฺฉุงุฑุจุฑุงู ูุชุนุฏุฏ ุจุง ุจุงุฑูุง ูุชุบุฑ ุทุฑุงุญ ุดุฏูโุงูุฏ.
* ุชุณุช ู ฺฉุฏ ุชููุฏ ุฑุง ุจุง ConTest ุงุจุฒุงุฑุฏู ฺฉูุฏ.
* ุชุณุชโูุง ุฑุง ุงุฌุฑุง ฺฉูุฏ.

ููุช ฺฉุฏ ุฑุง ุจุง ConTest ุงุจุฒุงุฑุฏู ฺฉุฑุฏูุ ูุฑุฎ ููููุช ูุง ุงุฒ ุชูุฑุจุงู ฺฉ ุดฺฉุณุช ุฏุฑ ุฏู ูููู ุชฺฉุฑุงุฑ ุจู ุชูุฑุจุงู ฺฉ ุดฺฉุณุช ุฏุฑ ุณ ุชฺฉุฑุงุฑ ุฑุณุฏ. ููุงุฏุฑ ุญููู ุจุฑุง ฺูุฏ ุงุฌุฑุง ุชุณุช ูพุณ ุงุฒ ุงุจุฒุงุฑุฏู: ฑณุ ฒณุ ฐุ ตดุ ฑถุ ฑดุ ถุ ถนุ ฑฐทุ ดนุ ฒ. ุจูุงุจุฑุงู ูุงุถุญ ุงุณุช ฺฉู ฺฉูุงุณโูุง ุงุจุฒุงุฑุฏู ุดุฏู ุฎู ุฒูุฏุชุฑ ู ุจุง ูุงุจูุช ุงุทููุงู ุจุดุชุฑ ุดฺฉุณุช ุฎูุฑุฏูุฏ.

### ูุชุฌูโฺฏุฑ

ุงู ูุตู ฺฉ ุณูุฑ ุจุณุงุฑ ฺฉูุชุงู ุฏุฑ ูููุฑู ุจุฒุฑฺฏ ู ุฎุทุฑูุงฺฉ ุจุฑูุงููโููุณ ููโุฒูุงู ุจูุฏ. ูุง ููุท ุณุทุญ ุขู ุฑุง ููุณ ฺฉุฑุฏู. ุชูุฑฺฉุฒ ูุง ุจุฑ ุฑู ุงุตูู ุจูุฏ ฺฉู ฺฉูฺฉ ูโฺฉูุฏ ฺฉุฏ ููโุฒูุงู ูพุงฺฉ ุจูุงูุฏุ ุงูุง ฺุฒูุง ุจุดุชุฑ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุจุงุฏ ุงุฏ ุจฺฏุฑุฏ ุงฺฏุฑ ูโุฎูุงูุฏ ุณุณุชูโูุง ููโุฒูุงู ุจููุณุฏ. ูุง ุชูุตู ูโฺฉูู ุจุง ฺฉุชุงุจ ูููโุงูุนุงุฏู **Doug Lea ุจุง ุนููุงู Concurrent Programming in Java: Design Principles and Patterns** ุดุฑูุน ฺฉูุฏ.

ุฏุฑ ุงู ูุตู ุฏุฑุจุงุฑู ุจูโุฑูุฒุฑุณุงู ููโุฒูุงูุ ุงุตูู ููฺฏุงูโุณุงุฒ ู ูููโฺฏุฐุงุฑ ุชูุฒ ฺฉู ูโุชูุงูุฏ ุงุฒ ุขู ุฌููฺฏุฑ ฺฉูุฏ ุตุญุจุช ฺฉุฑุฏู. ุฏุฑุจุงุฑู ุงูฺฉู ฺฺฏููู Threadูุง ูโุชูุงููุฏ ุชูุงู ุนููุงุช ุณุณุชูโูุง I/O ูุญูุฑ ุฑุง ุงูุฒุงุด ุฏููุฏ ู ุชฺฉูฺฉโูุง ุชูุฒ ุจุฑุง ุฏุณุชุงุจ ุจู ุงู ุจูุจูุฏูุง ุตุญุจุช ฺฉุฑุฏู. ุฏุฑุจุงุฑู ุจูโุจุณุช ู ุงุตูู ูพุดฺฏุฑ ุงุฒ ุขู ุจู ุฑูุด ุชูุฒ ุจุญุซ ฺฉุฑุฏู. ุฏุฑ ููุงุชุ ุฏุฑุจุงุฑู ุงุณุชุฑุงุชฺโูุง ุขุดฺฉุงุฑ ฺฉุฑุฏู ูุดฺฉูุงุช ููโุฒูุงู ุจุง ุงุจุฒุงุฑุฏู ฺฉุฏ ุตุญุจุช ฺฉุฑุฏู.

---

### ุขููุฒุด: ูุซุงูโูุง ฺฉุงูู ฺฉุฏ

#### ฺฉูุงูุช/ุณุฑูุฑ ุบุฑููโุฒูุงู (Nonthreaded)

**ูุณุช A-3 โ Server.java**

```java
package com.objectmentor.clientserver.nonthreaded;

import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.SocketException;
import common.MessageUtils;

public class Server implements Runnable {
    ServerSocket serverSocket;
    volatile boolean keepProcessing = true;

    public Server(int port, int millisecondsTimeout) throws IOException {
        serverSocket = new ServerSocket(port);
        serverSocket.setSoTimeout(millisecondsTimeout);
    }

    public void run() {
        System.out.printf("Server Starting\n");
        while (keepProcessing) {
            try {
                System.out.printf("accepting client\n");
                Socket socket = serverSocket.accept();
                System.out.printf("got client\n");
                process(socket);
            } catch (Exception e) {
                handle(e);
            }
        }
    }

    private void handle(Exception e) {
        if (!(e instanceof SocketException)) {
            e.printStackTrace();
        }
    }

    public void stopProcessing() {
        keepProcessing = false;
        closeIgnoringException(serverSocket);
    }

    void process(Socket socket) {
        if (socket == null)
            return;
        try {
            System.out.printf("Server: getting message\n");
            String message = MessageUtils.getMessage(socket);
            System.out.printf("Server: got message: %s\n", message);
            Thread.sleep(1000);
            System.out.printf("Server: sending reply: %s\n", message);
            MessageUtils.sendMessage(socket, "Processed: " + message);
            System.out.printf("Server: sent\n");
            closeIgnoringException(socket);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void closeIgnoringException(Socket socket) {
        if (socket != null)
            try {
                socket.close();
            } catch (IOException ignore) {
            }
    }

    private void closeIgnoringException(ServerSocket serverSocket) {
        if (serverSocket != null)
            try {
                serverSocket.close();
            } catch (IOException ignore) {
            }
    }
}
```

---

**ูุณุช A-4 โ ClientTest.java**
(ุชูุถุญ: ฺฉุฏ ClientTest ุนููุงู ูุดุงุจู Server.java ุงุณุช ู ููุงู ุณุงุฎุชุงุฑ ุฑุง ุฏุงุฑุฏ.)

```java
package com.objectmentor.clientserver.nonthreaded;

import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.SocketException;
import common.MessageUtils;

public class Server implements Runnable {
    ServerSocket serverSocket;
    volatile boolean keepProcessing = true;

    public Server(int port, int millisecondsTimeout) throws IOException {
        serverSocket = new ServerSocket(port);
        serverSocket.setSoTimeout(millisecondsTimeout);
    }

    public void run() {
        System.out.printf("Server Starting\n");
        while (keepProcessing) {
            try {
                System.out.printf("accepting client\n");
                Socket socket = serverSocket.accept();
                System.out.printf("got client\n");
                process(socket);
            } catch (Exception e) {
                handle(e);
            }
        }
    }

    private void handle(Exception e) {
        if (!(e instanceof SocketException)) {
            e.printStackTrace();
        }
    }

    public void stopProcessing() {
        keepProcessing = false;
        closeIgnoringException(serverSocket);
    }

    void process(Socket socket) {
        if (socket == null)
            return;
        try {
            System.out.printf("Server: getting message\n");
            String message = MessageUtils.getMessage(socket);
            System.out.printf("Server: got message: %s\n", message);
            Thread.sleep(1000);
            System.out.printf("Server: sending reply: %s\n", message);
            MessageUtils.sendMessage(socket, "Processed: " + message);
            System.out.printf("Server: sent\n");
            closeIgnoringException(socket);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void closeIgnoringException(Socket socket) {
        if (socket != null)
            try {
                socket.close();
            } catch (IOException ignore) {
            }
    }

    private void closeIgnoringException(ServerSocket serverSocket) {
        if (serverSocket != null)
            try {
                serverSocket.close();
            } catch (IOException ignore) {
            }
    }
}
```

---

**ูุณุช A-5 โ MessageUtils.java**

```java
package common;

import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.net.Socket;

public class MessageUtils {
    public static void sendMessage(Socket socket, String message) throws IOException {
        OutputStream stream = socket.getOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(stream);
        oos.writeUTF(message);
        oos.flush();
    }

    public static String getMessage(Socket socket) throws IOException {
        InputStream stream = socket.getInputStream();
        ObjectInputStream ois = new ObjectInputStream(stream);
        return ois.readUTF();
    }
}
```

---

### ฺฉูุงูุช/ุณุฑูุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ Threads

ุชุบุฑ ุณุฑูุฑ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ threads ููุท ูุงุฒููุฏ ุชุบุฑ ุฏุฑ ูุชุฏ **process** ูพุงู ุงุณุช (ุฎุทูุท ุฌุฏุฏ ุจุฑุฌุณุชู ุดุฏูโุงูุฏ):

```java
void process(final Socket socket) {
    if (socket == null)
        return;

    Runnable clientHandler = new Runnable() {
        public void run() {
            try {
                System.out.printf("Server: getting message\n");
                String message = MessageUtils.getMessage(socket);
                System.out.printf("Server: got message: %s\n", message);
                Thread.sleep(1000);
                System.out.printf("Server: sending reply: %s\n", message);
                MessageUtils.sendMessage(socket, "Processed: " + message);
                System.out.printf("Server: sent\n");
                closeIgnoringException(socket);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    };

    Thread clientConnection = new Thread(clientHandler);
    clientConnection.start();
}
```

ุฏุฑ ุงู ูุณุฎูุ ูุฑ ุงุชุตุงู ฺฉูุงูุช ุฏุฑ ฺฉ **Thread ุฌุฏุงฺฏุงูู** ุงุฌุฑุง ูโุดูุฏ ุชุง ุณุฑูุฑ ุจุชูุงูุฏ ููุฒูุงู ุจุง ฺูุฏู ฺฉูุงูุช ฺฉุงุฑ ฺฉูุฏ.

