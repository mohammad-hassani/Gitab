

<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="/Gitab/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>بهبود تدریجی</title>
  <meta name="description" content="ترجمه‌های فارسی کتاب‌های فنی — سریع، مینیمال و قابل اتکا.">

  <!-- استایل‌ها -->
  <link rel="stylesheet" href="/Gitab/styles/main.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

  <style>
  @font-face {
    font-family: 'Vazir';
    src: url('/Gitab/fonts/Vazir-FD-WOL.ttf') format('truetype');
    font-display: swap;
  }
  body {
    font-family: 'Vazir', sans-serif;
  }
  </style>
</head>

<body>
  <!-- هدر مشترک -->
  <header class="header">
    <div class="container nav-wrap">
      <a href="/Gitab/" class="brand">
        <img src="/Gitab/icone/logo.svg" alt="Gitab logo" width="26" height="26">
        <span>Gitab</span>
      </a>

      <nav class="nav">
        <a href="/Gitab/" aria-current="page">خانه</a>
        <a href="/Gitab/books/list-books">کتاب‌ها</a>
       <a href="/Gitab/translator.html">مترجمین</a>
        <a href="/Gitab/giter.html">گیتر</a>
      </nav>

      <div class="nav-actions">
        <button id="themeToggle" class="icon-btn theme-btn" data-icon="moon" aria-label="تغییر تم">
          <img src="/Gitab/icone/sun.svg" class="icon-sun" alt="روشن">
          <img src="/Gitab/icone/moon.svg" class="icon-moon" alt="تاریک">
        </button>

        <a class="icon-btn" href="https://github.com/hheydarian/Gitab" target="_blank" title="GitHub">
          <img src="/Gitab/icone/github.svg" alt="GitHub">
        </a>

        <!-- دکمه منو برای موبایل -->
        <button class="menu-toggle" aria-label="منو">
          <img src="/Gitab/icone/menu.svg" alt="menu">
        </button>
      </div>
    </div>
  </header>

  
  <main class="site-main book-page">
    <h1>بهبود تدریجی</h1>
<p>Case Study of a Command-Line Argument Parser</p>
<p><img src="../../../assets/image/14/img-14.1.png" alt="image"></p>
<div dir="rtl">
<p>این فصل یک مطالعهٔ موردی در زمینهٔ بهبود تدریجی است. در ابتدا ماژولی را می‌بینید که شروع خوبی داشت، اما به خوبی مقیاس‌پذیر نبود. سپس خواهید دید که این ماژول چگونه  refactor و تمیز شد.</p>
<p>بیشتر ما گاهی مجبور شده‌ایم که آرگومان‌های خط فرمان (command-line arguments) را پردازش کنیم. اگر ابزار مناسبی در دسترس نداشته باشیم، معمولاً آرایه‌ای از رشته‌ها را که به تابع <code>main</code> پاس داده می‌شود، پیمایش می‌کنیم. ابزارهای خوبی از منابع مختلف برای این کار وجود دارد، اما هیچ‌کدام دقیقاً آن کاری را نمی‌کنند که من می‌خواهم. بنابراین، تصمیم گرفتم ابزار خودم را بنویسم. اسمش را گذاشتم: <code>Args</code>.</p>
<p>استفاده از <code>Args</code> بسیار ساده است. کافی است شیئی از کلاس <code>Args</code> را با آرگومان‌های ورودی و یک رشتهٔ قالب (format string) بسازید و سپس از طریق آن شیء، مقادیر آرگومان‌ها را استخراج کنید. به مثال سادهٔ زیر توجه کنید:</p>
</div>
<p>Listing 14-1</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(String[] args)</span>
{
    <span class="hljs-keyword">try</span>
        {
            <span class="hljs-type">Args</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span> (<span class="hljs-string">&quot;l,p#,d*&quot;</span>, args);
            <span class="hljs-type">boolean</span> <span class="hljs-variable">logging</span> <span class="hljs-operator">=</span> arg.getBoolean (<span class="hljs-string">&#x27;l&#x27;</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> arg.getInt (<span class="hljs-string">&#x27;p&#x27;</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">directory</span> <span class="hljs-operator">=</span> arg.getString (<span class="hljs-string">&#x27;d&#x27;</span>);
            executeApplication (logging, port, directory);
        }
    <span class="hljs-keyword">catch</span> (ArgsException e)
        {
            System.out.printf (<span class="hljs-string">&quot;Argument error: %s\n&quot;</span>, e.errorMessage ());
        }
}
</code></pre>
<div dir="rtl">
<p>می‌بینید که استفاده از این ابزار چقدر ساده است. فقط کافی است یک نمونه از کلاس <code>Args</code> با دو پارامتر ایجاد کنیم. پارامتر اول، یک رشتهٔ قالب (یا شِما – schema) است: <code>&quot;l,p#,d*&quot;</code> که سه آرگومان خط فرمان را تعریف می‌کند. اولین آرگومان -l یک آرگومان بولی (<code>boolean</code>) است. دومی -p یک آرگومان عددی (<code>integer</code>) است. سومی -d یک آرگومان رشته‌ای (<code>string</code>) است.</p>
<p>پارامتر دوم سازندهٔ <code>Args</code> همان آرایه‌ای از آرگومان‌های خط فرمان است که به تابع <code>main</code> پاس داده شده.</p>
<p>اگر سازنده بدون پرتاب (<code>throw</code>) کردن یک استثنای <code>ArgsException</code> اجرا شود، یعنی ورودی خط فرمان به‌درستی تجزیه شده و شیء Args آمادهٔ پرس‌وجو است. متدهایی مثل <code>getBoolean،</code> <code>getInteger</code> و <code>getString</code> به ما امکان می‌دهند مقدار آرگومان‌ها را بر اساس نامشان دریافت کنیم.</p>
<p>اگر مشکلی در رشتهٔ قالب یا خود آرگومان‌های خط فرمان وجود داشته باشد، یک استثنای (exception) از نوع <code>ArgsException</code> پرتاب می‌شود. با استفاده از متد errorMessage در این استثنا، می‌توان توضیح دقیقی از خطا دریافت کرد.</p>
<h2>پیاده‌سازی <code>Args</code></h2>
<p>Listing 14-2 پیاده‌سازی کلاس <code>Args</code> را نشان می‌دهد. لطفاً آن را با دقت مطالعه کنید. من برای سبک و ساختار آن تلاش زیادی کرده‌ام و امیدوارم ارزش الگوبرداری داشته باشد.</p>
</div>
<p>Listing 14-2</p>
<pre class="hljs"><code><span class="hljs-keyword">package</span> com.objectmentor.utilities.args;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.*;

<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span>
{
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers;
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; argsFound;
    <span class="hljs-keyword">private</span> ListIterator&lt;String&gt; currentArgument;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Args</span> <span class="hljs-params">(String schema, String[] args)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        marshalers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt; ();
        argsFound = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Character&gt; ();
        parseSchema (schema);
        parseArgumentStrings (Arrays.asList (args));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseSchema</span> <span class="hljs-params">(String schema)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">for</span> (String element : schema.split (<span class="hljs-string">&quot;,&quot;</span>))
            <span class="hljs-keyword">if</span> (element.length () &gt; <span class="hljs-number">0</span>)
                parseSchemaElement (element.trim ());
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseSchemaElement</span> <span class="hljs-params">(String element)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-type">char</span> <span class="hljs-variable">elementId</span> <span class="hljs-operator">=</span> element.charAt (<span class="hljs-number">0</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">elementTail</span> <span class="hljs-operator">=</span> element.substring (<span class="hljs-number">1</span>);
        validateSchemaElementId (elementId);
        <span class="hljs-keyword">if</span> (elementTail.length () == <span class="hljs-number">0</span>)
            marshalers.put (elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span> ());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals (<span class="hljs-string">&quot;*&quot;</span>))
            marshalers.put (elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArgumentMarshaler</span> ());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals (<span class="hljs-string">&quot;#&quot;</span>))
            marshalers.put (elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> ());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals (<span class="hljs-string">&quot;##&quot;</span>))
            marshalers.put (elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleArgumentMarshaler</span> ());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals (<span class="hljs-string">&quot;[*]&quot;</span>))
            marshalers.put (elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArrayArgumentMarshaler</span> ());
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> (INVALID_ARGUMENT_FORMAT, elementId,
                                     elementTail);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">validateSchemaElementId</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">if</span> (!Character.isLetter (elementId))
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> (INVALID_ARGUMENT_NAME, elementId, <span class="hljs-literal">null</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseArgumentStrings</span> <span class="hljs-params">(List&lt;String&gt; argsList)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">for</span> (currentArgument = argsList.listIterator ();
             currentArgument.hasNext ();)
            {
                <span class="hljs-type">String</span> <span class="hljs-variable">argString</span> <span class="hljs-operator">=</span> currentArgument.next ();
                <span class="hljs-keyword">if</span> (argString.startsWith (<span class="hljs-string">&quot;-&quot;</span>))
                    {
                        parseArgumentCharacters (argString.substring (<span class="hljs-number">1</span>));
                    }
                <span class="hljs-keyword">else</span>
                    {
                        currentArgument.previous ();
                        <span class="hljs-keyword">break</span>;
                    }
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseArgumentCharacters</span> <span class="hljs-params">(String argChars)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; argChars.length (); i++)
            parseArgumentCharacter (argChars.charAt (i));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseArgumentCharacter</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get (argChar);
        <span class="hljs-keyword">if</span> (m == <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> (UNEXPECTED_ARGUMENT, argChar, <span class="hljs-literal">null</span>);
            }
        <span class="hljs-keyword">else</span>
            {
                argsFound.add (argChar);
                <span class="hljs-keyword">try</span>
                    {
                        m.set (currentArgument);
                    }
                <span class="hljs-keyword">catch</span> (ArgsException e)
                    {
                        e.setErrorArgumentId (argChar);
                        <span class="hljs-keyword">throw</span> e;
                    }
            }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">has</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> argsFound.contains (arg);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>
    <span class="hljs-title function_">nextArgument</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> currentArgument.nextIndex ();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">getBoolean</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> BooleanArgumentMarshaler.getValue (marshalers.get (arg));
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">getString</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> StringArgumentMarshaler.getValue (marshalers.get (arg));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>
    <span class="hljs-title function_">getInt</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> IntegerArgumentMarshaler.getValue (marshalers.get (arg));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span>
    <span class="hljs-title function_">getDouble</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> DoubleArgumentMarshaler.getValue (marshalers.get (arg));
    }
    <span class="hljs-keyword">public</span> String[]
    getStringArray (<span class="hljs-type">char</span> arg)
    {
        <span class="hljs-keyword">return</span> StringArrayArgumentMarshaler.getValue (marshalers.get (arg));
    }
}
</code></pre>
<div dir="rtl">
<p>توجه کنید که می‌توانید این کد را از بالا به پایین بخوانید، بدون اینکه مجبور شوید زیاد بین بخش‌های مختلف جابه‌جا شوید یا به جلو بپرید. تنها چیزی که شاید نیاز داشته باشید جلوتر ببینید، تعریف <code>ArgumentMarshaler</code> است که عمداً آن را حذف کرده‌ام. اگر این کد را با دقت خوانده باشید، باید متوجه شده باشید که رابط (interface) <code>ArgumentMarshaler</code> چیست و پیاده‌سازی‌های مختلف آن چه کاری انجام می‌دهند.</p>
<p>الان چند نمونه از آن‌ها را به شما نشان می‌دهم.</p>
</div>
<p>Listing 14-3 - ArgumentMarshaler.java</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span> <span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException;
}
</code></pre>
<p>Listing 14-4 - BooleanArgumentMarshaler.java</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">set</span> <span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        booleanValue = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">getValue</span> <span class="hljs-params">(ArgumentMarshaler am)</span>
    {
        <span class="hljs-keyword">if</span> (am != <span class="hljs-literal">null</span> &amp;&amp; am <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
            <span class="hljs-keyword">return</span> ((BooleanArgumentMarshaler)am).booleanValue;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p>Listing 14-5 - StringArgumentMarshaler.java</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.*;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringArgumentMarshaler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">stringValue</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">set</span> <span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">try</span>
            {
                stringValue = currentArgument.next ();
            }
        <span class="hljs-keyword">catch</span> (NoSuchElementException e)
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> (MISSING_STRING);
            }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String
    <span class="hljs-title function_">getValue</span> <span class="hljs-params">(ArgumentMarshaler am)</span>
    {
        <span class="hljs-keyword">if</span> (am != <span class="hljs-literal">null</span> &amp;&amp; am <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
            <span class="hljs-keyword">return</span> ((StringArgumentMarshaler)am).stringValue;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
}
</code></pre>
<p>Listing 14-6 - IntegerArgumentMarshaler.java</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.*;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">intValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">set</span> <span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span>
            {
                parameter = currentArgument.next ();
                intValue = Integer.parseInt (parameter);
            }
        <span class="hljs-keyword">catch</span> (NoSuchElementException e)
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> (MISSING_INTEGER);
            }
        <span class="hljs-keyword">catch</span> (NumberFormatException e)
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> (INVALID_INTEGER, parameter);
            }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>
    <span class="hljs-title function_">getValue</span> <span class="hljs-params">(ArgumentMarshaler am)</span>
    {
        <span class="hljs-keyword">if</span> (am != <span class="hljs-literal">null</span> &amp;&amp; am <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
            <span class="hljs-keyword">return</span> ((IntegerArgumentMarshaler)am).intValue;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
}
</code></pre>
<div dir="rtl">
<p>سایر مشتق‌های <code>ArgumentMarshaler</code> هم به همین سبک برای <code>double</code> ‌ها و آرایه‌های رشته‌ای <code>(String[])</code> پیاده‌سازی شده‌اند و فقط باعث شلوغی این فصل می‌شوند. آن‌ها را به‌عنوان تمرین به شما واگذار می‌کنم.</p>
<p>ممکن است یک نکتهٔ دیگر ذهن شما را مشغول کرده باشد: تعریف ثابت‌های مربوط به کد خطا (error code constants). این موارد در کلاس <code>ArgsException</code> تعریف شده‌اند (Listing 14-7).</p>
</div>
<p>Listing 14-7 - ArgsException.java</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.*;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgsException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-variable">errorArgumentId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\0&#x27;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorParameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> OK;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span> <span class="hljs-params">()</span> {}
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span> <span class="hljs-params">(String message)</span> { <span class="hljs-built_in">super</span> (message); }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span> <span class="hljs-params">(ErrorCode errorCode)</span> { <span class="hljs-built_in">this</span>.errorCode = errorCode; }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span> <span class="hljs-params">(ErrorCode errorCode, String errorParameter)</span>
    {
        <span class="hljs-built_in">this</span>.errorCode = errorCode;
        <span class="hljs-built_in">this</span>.errorParameter = errorParameter;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span> <span class="hljs-params">(ErrorCode errorCode, <span class="hljs-type">char</span> errorArgumentId,
                          String errorParameter)</span>
    {
        <span class="hljs-built_in">this</span>.errorCode = errorCode;
        <span class="hljs-built_in">this</span>.errorParameter = errorParameter;
        <span class="hljs-built_in">this</span>.errorArgumentId = errorArgumentId;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">char</span>
    <span class="hljs-title function_">getErrorArgumentId</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> errorArgumentId;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setErrorArgumentId</span> <span class="hljs-params">(<span class="hljs-type">char</span> errorArgumentId)</span>
    {
        <span class="hljs-built_in">this</span>.errorArgumentId = errorArgumentId;
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">getErrorParameter</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> errorParameter;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setErrorParameter</span> <span class="hljs-params">(String errorParameter)</span>
    {
        <span class="hljs-built_in">this</span>.errorParameter = errorParameter;
    }
    <span class="hljs-keyword">public</span> ErrorCode
    <span class="hljs-title function_">getErrorCode</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> errorCode;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setErrorCode</span> <span class="hljs-params">(ErrorCode errorCode)</span>
    {
        <span class="hljs-built_in">this</span>.errorCode = errorCode;
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">errorMessage</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">switch</span> (errorCode)
            {
            <span class="hljs-keyword">case</span> OK:
                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;TILT: Should not get here.&quot;</span>;
            <span class="hljs-keyword">case</span> UNEXPECTED_ARGUMENT:
                <span class="hljs-keyword">return</span> String.format (<span class="hljs-string">&quot;Argument -%c unexpected.&quot;</span>,
                                      errorArgumentId);
            <span class="hljs-keyword">case</span> MISSING_STRING:
                <span class="hljs-keyword">return</span> String.format (
                    <span class="hljs-string">&quot;Could not find string parameter for -%c.&quot;</span>,
                    errorArgumentId);
            <span class="hljs-keyword">case</span> INVALID_INTEGER:
                <span class="hljs-keyword">return</span> String.format (
                    <span class="hljs-string">&quot;Argument -%c expects an integer but was &#x27;%s&#x27;.&quot;</span>,
                    errorArgumentId, errorParameter);
            <span class="hljs-keyword">case</span> MISSING_INTEGER:
                <span class="hljs-keyword">return</span> String.format (
                    <span class="hljs-string">&quot;Could not find integer parameter for -%c.&quot;</span>,
                    errorArgumentId);
            <span class="hljs-keyword">case</span> INVALID_DOUBLE:
                <span class="hljs-keyword">return</span> String.format (
                    <span class="hljs-string">&quot;Argument -%c expects a double but was &#x27;%s&#x27;.&quot;</span>,
                    errorArgumentId, errorParameter);
            <span class="hljs-keyword">case</span> MISSING_DOUBLE:
                <span class="hljs-keyword">return</span> String.format (
                    <span class="hljs-string">&quot;Could not find double parameter for -%c.&quot;</span>,
                    errorArgumentId);
            <span class="hljs-keyword">case</span> INVALID_ARGUMENT_NAME:
                <span class="hljs-keyword">return</span> String.format (<span class="hljs-string">&quot;&#x27;%c&#x27; is not a valid argument name.&quot;</span>,
                                      errorArgumentId);
            <span class="hljs-keyword">case</span> INVALID_ARGUMENT_FORMAT:
                <span class="hljs-keyword">return</span> String.format (<span class="hljs-string">&quot;&#x27;%s&#x27; is not a valid argument format.&quot;</span>,
                                      errorParameter);
            }
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span>
    {
        OK,
        INVALID_ARGUMENT_FORMAT,
        UNEXPECTED_ARGUMENT,
        INVALID_ARGUMENT_NAME,
        MISSING_STRING,
        MISSING_INTEGER,
        INVALID_INTEGER,
        MISSING_DOUBLE,
        INVALID_DOUBLE
    }
}
</code></pre>
<div dir="rtl">
<p>جالبه که ببینیم برای پیاده‌سازی جزئیات چنین مفهوم ساده‌ای، این‌همه کد لازم شده. یکی از دلایلش اینه که ما از زبانی استفاده می‌کنیم که به‌طور خاص پرحرفه! جاوا، به‌عنوان یک زبان ایستا از نظر نوع‌دهی (statically typed)، مجبورمون می‌کنه که برای راضی کردن سیستم نوع‌دهی، کد زیادی بنویسیم. در زبان‌هایی مثل <code>Ruby،</code> <code>Python</code> یا <code>Smalltalk،</code> این برنامه بسیار جمع‌وجورتر می‌شد.</p>
<p>لطفاً یک بار دیگه این کد رو با دقت بخونید. به نام‌گذاری‌ها، اندازهٔ توابع، و قالب‌بندی کد توجه ویژه‌ای داشته باشید. اگر یک برنامه‌نویس با تجربه باشید، ممکنه به بعضی از سبک‌ها یا ساختارهای استفاده‌شده انتقادهایی داشته باشید. اما در کل، امیدوارم به این نتیجه برسید که این برنامه به‌خوبی نوشته شده و ساختار تمیزی دارد.</p>
<p>برای مثال، باید کاملاً مشخص باشه که چطور می‌تونید یک نوع آرگومان جدید، مثل تاریخ (Date) یا عدد مختلط (Complex Number) اضافه کنید و این کار چقدر ساده خواهد بود. در واقع، برای این کار فقط باید:</p>
<p>یک زیرکلاس جدید از <code>ArgumentMarshaler</code> تعریف کنید،</p>
<p>یک تابع <code>getXXX</code> جدید بنویسید،</p>
<p>و یک case جدید به تابع <code>parseSchemaElement</code> اضافه کنید.<br>
احتمالاً باید یک <code>ArgsException</code>.<code>ErrorCode</code> جدید هم اضافه بشه و یک پیام خطای جدید هم برایش تعریف بشه.</p>
<h2>چطور این کار رو انجام دادم؟</h2>
<p>بذارید خیالتون رو راحت کنم: من این برنامه رو به‌صورت یکجا، از اول تا آخر، توی همین فرم نهایی ننوشتم. مهم‌تر از اون، انتظار ندارم که شما هم بتونید برنامه‌های تمیز و شسته‌رفته‌ای رو در یک‌بار نوشتن تولید کنید.<br>
اگر از چند دهه گذشته چیزی یاد گرفته باشیم، اینه که برنامه‌نویسی بیشتر یک مهارته تا یک علم. برای نوشتن کد تمیز، باید اول کد کثیف بنویسید و بعد اون رو تمیز کنید.</p>
<p>این نباید براتون تعجب‌آور باشه. ما این حقیقت رو توی مدرسه یاد گرفتیم، وقتی معلم‌هامون (معمولاً بی‌نتیجه!) سعی می‌کردن ما رو قانع کنن که پیش‌نویس‌های اولیه بنویسیم.<br>
فرآیندش، همون‌طور که می‌گفتن، این بود که باید یک پیش‌نویس بنویسیم، بعد نسخهٔ دوم، و بعد چند نسخهٔ بعدی، تا برسیم به نسخهٔ نهایی.<br>
اون‌ها سعی داشتن بهمون بگن که نوشتن یک متن تمیز، فرایندی از پالایش گام‌به‌گام (successive refinement) است.</p>
<p>بیشتر برنامه‌نویس‌های تازه‌کار (مثل بیشتر دانش‌آموزها) خیلی خوب این توصیه رو رعایت نمی‌کنن. اون‌ها فکر می‌کنن هدف اصلی اینه که برنامه &quot;کار کنه&quot;. وقتی برنامه &quot;کار کرد&quot;، می‌رن سراغ کار بعدی و برنامه رو همون‌جوری که بالاخره به کار افتاده، رها می‌کنن.<br>
اما بیشتر برنامه‌نویس‌های باتجربه می‌دونن که این کار، خودکشی حرفه‌ایه.</p>
<h2>Args: پیش‌نویس اولیه</h2>
<p>Listing 14-8 نسخه‌ای اولیه از کلاس <code>Args</code> رو نشون می‌ده. این نسخه &quot;کار می‌کنه&quot;، ولی به‌هم‌ریخته است.</p>
</div>
<p>Listing 14-8 - Args.java (first draft)</p>
<pre class="hljs"><code><span class="hljs-keyword">import</span> java.text.ParseException;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span>
{
    <span class="hljs-keyword">private</span> String schema;
    <span class="hljs-keyword">private</span> String[] args;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">valid</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;Character&gt; ();
    <span class="hljs-keyword">private</span> Map&lt;Character, Boolean&gt; booleanArgs
        = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, Boolean&gt; ();
    <span class="hljs-keyword">private</span> Map&lt;Character, String&gt; stringArgs
        = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, String&gt; ();
    <span class="hljs-keyword">private</span> Map&lt;Character, Integer&gt; intArgs
        = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, Integer&gt; ();
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; argsFound = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Character&gt; ();
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> currentArgument;
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-variable">errorArgumentId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\0&#x27;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorParameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TILT&quot;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> ErrorCode.OK;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span>
    {
        OK,
        MISSING_STRING,
        MISSING_INTEGER,
        INVALID_INTEGER,
        UNEXPECTED_ARGUMENT
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Args</span> <span class="hljs-params">(String schema, String[] args)</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-built_in">this</span>.schema = schema;
        <span class="hljs-built_in">this</span>.args = args;
        valid = parse ();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parse</span> <span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-keyword">if</span> (schema.length () == <span class="hljs-number">0</span> &amp;&amp; args.length == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        parseSchema ();
        <span class="hljs-keyword">try</span>
            {
                parseArguments ();
            }
        <span class="hljs-keyword">catch</span> (ArgsException e)
            {
            }
        <span class="hljs-keyword">return</span> valid;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parseSchema</span> <span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-keyword">for</span> (String element : schema.split (<span class="hljs-string">&quot;,&quot;</span>))
            {
                <span class="hljs-keyword">if</span> (element.length () &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-type">String</span> <span class="hljs-variable">trimmedElement</span> <span class="hljs-operator">=</span> element.trim ();
                        parseSchemaElement (trimmedElement);
                    }
            }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseSchemaElement</span> <span class="hljs-params">(String element)</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-type">char</span> <span class="hljs-variable">elementId</span> <span class="hljs-operator">=</span> element.charAt (<span class="hljs-number">0</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">elementTail</span> <span class="hljs-operator">=</span> element.substring (<span class="hljs-number">1</span>);
        validateSchemaElementId (elementId);
        <span class="hljs-keyword">if</span> (isBooleanSchemaElement (elementTail))
            parseBooleanSchemaElement (elementId);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isStringSchemaElement (elementTail))
            parseStringSchemaElement (elementId);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isIntegerSchemaElement (elementTail))
            {
                parseIntegerSchemaElement (elementId);
            }
        <span class="hljs-keyword">else</span>
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span> (
                    String.format (<span class="hljs-string">&quot;Argument: %c has invalid format: %s.&quot;</span>,
                                   elementId, elementTail),
                    <span class="hljs-number">0</span>);
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">validateSchemaElementId</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-keyword">if</span> (!Character.isLetter (elementId))
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span> (<span class="hljs-string">&quot;Bad character:&quot;</span> + elementId
                                              + <span class="hljs-string">&quot;in Args format: &quot;</span> + schema,
                                          <span class="hljs-number">0</span>);
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseBooleanSchemaElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span>
    {
        booleanArgs.put (elementId, <span class="hljs-literal">false</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseIntegerSchemaElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span>
    {
        intArgs.put (elementId, <span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseStringSchemaElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span>
    {
        stringArgs.put (elementId, <span class="hljs-string">&quot;&quot;</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isStringSchemaElement</span> <span class="hljs-params">(String elementTail)</span>
    {
        <span class="hljs-keyword">return</span> elementTail.equals (<span class="hljs-string">&quot;*&quot;</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isBooleanSchemaElement</span> <span class="hljs-params">(String elementTail)</span>
    {
        <span class="hljs-keyword">return</span> elementTail.length () == <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isIntegerSchemaElement</span> <span class="hljs-params">(String elementTail)</span>
    {
        <span class="hljs-keyword">return</span> elementTail.equals (<span class="hljs-string">&quot;#&quot;</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parseArguments</span> <span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">for</span> (currentArgument = <span class="hljs-number">0</span>; currentArgument &lt; args.length;
             currentArgument++)
            {
                <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> args[currentArgument];
                parseArgument (arg);
            }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseArgument</span> <span class="hljs-params">(String arg)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">if</span> (arg.startsWith (<span class="hljs-string">&quot;-&quot;</span>))
            parseElements (arg);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseElements</span> <span class="hljs-params">(String arg)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; arg.length (); i++)
            parseElement (arg.charAt (i));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">if</span> (setArgument (argChar))
            argsFound.add (argChar);
        <span class="hljs-keyword">else</span>
            {
                unexpectedArguments.add (argChar);
                errorCode = ErrorCode.UNEXPECTED_ARGUMENT;
                valid = <span class="hljs-literal">false</span>;
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">setArgument</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        <span class="hljs-keyword">if</span> (isBooleanArg (argChar))
            setBooleanArg (argChar, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isStringArg (argChar))
            setStringArg (argChar);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isIntArg (argChar))
            setIntArg (argChar);
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isIntArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-keyword">return</span> intArgs.containsKey (argChar);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setIntArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        currentArgument++;
        <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span>
            {
                parameter = args[currentArgument];
                intArgs.put (argChar, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span> (parameter));
            }
        <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e)
            {
                valid = <span class="hljs-literal">false</span>;
                errorArgumentId = argChar;
                errorCode = ErrorCode.MISSING_INTEGER;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> ();
            }
        <span class="hljs-keyword">catch</span> (NumberFormatException e)
            {
                valid = <span class="hljs-literal">false</span>;
                errorArgumentId = argChar;
                errorParameter = parameter;
                errorCode = ErrorCode.INVALID_INTEGER;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> ();
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setStringArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException
    {
        currentArgument++;
        <span class="hljs-keyword">try</span>
            {
                stringArgs.put (argChar, args[currentArgument]);
            }
        <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e)
            {
                valid = <span class="hljs-literal">false</span>;
                errorArgumentId = argChar;
                errorCode = ErrorCode.MISSING_STRING;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> ();
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isStringArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-keyword">return</span> stringArgs.containsKey (argChar);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setBooleanArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar, <span class="hljs-type">boolean</span> value)</span>
    {
        booleanArgs.put (argChar, value);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isBooleanArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-keyword">return</span> booleanArgs.containsKey (argChar);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>
    <span class="hljs-title function_">cardinality</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> argsFound.size ();
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">usage</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">if</span> (schema.length () &gt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;-[&quot;</span> + schema + <span class="hljs-string">&quot;]&quot;</span>;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">errorMessage</span> <span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception
    {
        <span class="hljs-keyword">switch</span> (errorCode)
            {
            <span class="hljs-keyword">case</span> OK:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span> (<span class="hljs-string">&quot;TILT: Should not get here.&quot;</span>);
            <span class="hljs-keyword">case</span> UNEXPECTED_ARGUMENT:
                <span class="hljs-keyword">return</span> unexpectedArgumentMessage ();
            <span class="hljs-keyword">case</span> MISSING_STRING:
                <span class="hljs-keyword">return</span> String.format (
                    <span class="hljs-string">&quot;Could not find string parameter for -%c.&quot;</span>,
                    errorArgumentId);
            <span class="hljs-keyword">case</span> INVALID_INTEGER:
                <span class="hljs-keyword">return</span> String.format (
                    <span class="hljs-string">&quot;Argument -%c expects an integer but was &#x27;%s&#x27;.&quot;</span>,
                    errorArgumentId, errorParameter);
            <span class="hljs-keyword">case</span> MISSING_INTEGER:
                <span class="hljs-keyword">return</span> String.format (
                    <span class="hljs-string">&quot;Could not find integer parameter for -%c.&quot;</span>,
                    errorArgumentId);
            }
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">private</span> String
    <span class="hljs-title function_">unexpectedArgumentMessage</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span> (<span class="hljs-string">&quot;Argument(s) -&quot;</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : unexpectedArguments)
            {
                message.append (c);
            }
        message.append (<span class="hljs-string">&quot; unexpected.&quot;</span>);
        <span class="hljs-keyword">return</span> message.toString ();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">falseIfNull</span> <span class="hljs-params">(Boolean b)</span>
    {
        <span class="hljs-keyword">return</span> b != <span class="hljs-literal">null</span> &amp;&amp; b;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>
    <span class="hljs-title function_">zeroIfNull</span> <span class="hljs-params">(Integer i)</span>
    {
        <span class="hljs-keyword">return</span> i == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : i;
    }
    <span class="hljs-keyword">private</span> String
    <span class="hljs-title function_">blankIfNull</span> <span class="hljs-params">(String s)</span>
    {
        <span class="hljs-keyword">return</span> s == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : s;
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">getString</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> blankIfNull (stringArgs.get (arg));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>
    <span class="hljs-title function_">getInt</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> zeroIfNull (intArgs.get (arg));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">getBoolean</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> falseIfNull (booleanArgs.get (arg));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">has</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> argsFound.contains (arg);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isValid</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> valid;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgsException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span>
    {
    }
}
</code></pre>
<div dir="rtl">
<p>امیدوارم واکنش اولیه شما به این حجم کد این باشه که &quot;خوشحالم که اون رو به همین شکل رها نکرده!&quot;. اگر این احساس رو دارید، پس به یاد داشته باشید که دیگران هم همین‌طور در مورد کدی که شما به‌صورت پیش‌نویس رها می‌کنید، احساس خواهند کرد.</p>
<p>در واقع، شاید <code>first draft</code> شاید مهربانانه‌ترین چیزی باشه که می‌تونید در مورد این کد بگید. این کد قطعاً در حال پیشرفت است. تعداد زیاد متغیرهای نمونه (instance variables) نگران‌کننده است. رشته‌های عجیب مثل <code>TILT</code>، <strong>HashSet</strong>‌ ها و <strong>TreeSet</strong>‌ ها، و بلاک‌های try-catch-catch همه با هم جمع شده‌اند و تبدیل به یک پشتهٔ عفونت‌زای (festering pile) شده‌اند.</p>
<p>من قصد نداشتم که یک پشتهٔ عفونت‌زا بنویسم. در واقع، تلاش می‌کردم که همه چیز رو به‌طور نسبتاً سازمان‌دهی‌شده نگه دارم. احتمالاً می‌توانید این رو از انتخاب نام توابع و متغیرها و این حقیقت که برنامه ساختار نسبتاً خامی دارد، متوجه بشید. اما، واضح است که من اجازه دادم مشکل از کنترل من خارج بشه.</p>
<p>این بهم‌ریختگی به‌تدریج ساخته شد. نسخه‌های قبلی اصلاً به این اندازه بد نبودند. برای مثال، Listing 14-9 نسخه‌ای از کد رو نشون می‌ده که تنها آرگومان‌های بولی کار می‌کردند.</p>
</div>
<p>Listing 14-9 - Args.java (Boolean only)</p>
<pre class="hljs"><code><span class="hljs-keyword">package</span> com.objectmentor.utilities.getopts;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span>
{
    <span class="hljs-keyword">private</span> String schema;
    <span class="hljs-keyword">private</span> String[] args;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> valid;
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;Character&gt; ();
    <span class="hljs-keyword">private</span> Map&lt;Character, Boolean&gt; booleanArgs
        = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, Boolean&gt; ();
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">numberOfArguments</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Args</span> <span class="hljs-params">(String schema, String[] args)</span>
    {
        <span class="hljs-built_in">this</span>.schema = schema;
        <span class="hljs-built_in">this</span>.args = args;
        valid = parse ();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isValid</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> valid;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parse</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">if</span> (schema.length () == <span class="hljs-number">0</span> &amp;&amp; args.length == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        parseSchema ();
        parseArguments ();
        <span class="hljs-keyword">return</span> unexpectedArguments.size () == <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parseSchema</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">for</span> (String element : schema.split (<span class="hljs-string">&quot;,&quot;</span>))
            {
                parseSchemaElement (element);
            }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseSchemaElement</span> <span class="hljs-params">(String element)</span>
    {
        <span class="hljs-keyword">if</span> (element.length () == <span class="hljs-number">1</span>)
            {
                parseBooleanSchemaElement (element);
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseBooleanSchemaElement</span> <span class="hljs-params">(String element)</span>
    {
        <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> element.charAt (<span class="hljs-number">0</span>);
        <span class="hljs-keyword">if</span> (Character.isLetter (c))
            {
                booleanArgs.put (c, <span class="hljs-literal">false</span>);
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parseArguments</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">for</span> (String arg : args)
            parseArgument (arg);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseArgument</span> <span class="hljs-params">(String arg)</span>
    {
        <span class="hljs-keyword">if</span> (arg.startsWith (<span class="hljs-string">&quot;-&quot;</span>))
            parseElements (arg);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseElements</span> <span class="hljs-params">(String arg)</span>
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; arg.length (); i++)
            parseElement (arg.charAt (i));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-keyword">if</span> (isBoolean (argChar))
            {
                numberOfArguments++;
                setBooleanArg (argChar, <span class="hljs-literal">true</span>);
            }
        <span class="hljs-keyword">else</span>
            unexpectedArguments.add (argChar);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setBooleanArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar, <span class="hljs-type">boolean</span> value)</span>
    {
        booleanArgs.put (argChar, value);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isBoolean</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-keyword">return</span> booleanArgs.containsKey (argChar);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>
    <span class="hljs-title function_">cardinality</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> numberOfArguments;
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">usage</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">if</span> (schema.length () &gt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;-[&quot;</span> + schema + <span class="hljs-string">&quot;]&quot;</span>;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">errorMessage</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">if</span> (unexpectedArguments.size () &gt; <span class="hljs-number">0</span>)
            {
                <span class="hljs-keyword">return</span> unexpectedArgumentMessage ();
            }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">private</span> String
    <span class="hljs-title function_">unexpectedArgumentMessage</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span> (<span class="hljs-string">&quot;Argument(s) -&quot;</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : unexpectedArguments)
            {
                message.append (c);
            }
        message.append (<span class="hljs-string">&quot; unexpected.&quot;</span>);
        <span class="hljs-keyword">return</span> message.toString ();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">getBoolean</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> booleanArgs.get (arg);
    }
}
</code></pre>
<div dir="rtl">
<p>با اینکه می‌توانید ایرادات زیادی در این کد پیدا کنید، اما واقعاً آنقدرها هم بد نیست. کد فشرده و ساده است و فهمیدنش راحت. با این حال، در دل این کد، به‌راحتی می‌توان بذرهای پشتهٔ عفونت‌زای بعدی را مشاهده کرد. خیلی واضح است که چطور این کد به آن بهم‌ریختگی تبدیل شد.</p>
<p>توجه کنید که آن بهم‌ریختگی تنها دو نوع آرگومان بیشتر از این کد دارد: رشته (<code>String</code>) و عدد (<code>integer</code>). اضافه کردن تنها دو نوع آرگومان دیگر تاثیر منفی عظیمی روی کد داشت. این تغییر کد را از چیزی که می‌توانست به‌طور نسبتاً قابل نگهداری باشد، به چیزی تبدیل کرد که من انتظار دارم به زودی پر از باگ و مشکلات مختلف بشود.</p>
<p>من این دو نوع آرگومان را به‌طور تدریجی اضافه کردم. اول، آرگومان رشته را اضافه کردم که این نتیجه را داد:</p>
</div>
<p>Listing 14-10 - Args.java (Boolean and String)</p>
<pre class="hljs"><code><span class="hljs-keyword">package</span> com.objectmentor.utilities.getopts;
<span class="hljs-keyword">import</span> java.text.ParseException;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span>
{
    <span class="hljs-keyword">private</span> String schema;
    <span class="hljs-keyword">private</span> String[] args;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">valid</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;Character&gt; ();
    <span class="hljs-keyword">private</span> Map&lt;Character, Boolean&gt; booleanArgs
        = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, Boolean&gt; ();
    <span class="hljs-keyword">private</span> Map&lt;Character, String&gt; stringArgs
        = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, String&gt; ();
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; argsFound = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Character&gt; ();
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> currentArgument;
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-variable">errorArgument</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\0&#x27;</span>;
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span>
    {
        OK,
        MISSING_STRING
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> ErrorCode.OK;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Args</span> <span class="hljs-params">(String schema, String[] args)</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-built_in">this</span>.schema = schema;
        <span class="hljs-built_in">this</span>.args = args;
        valid = parse ();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parse</span> <span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-keyword">if</span> (schema.length () == <span class="hljs-number">0</span> &amp;&amp; args.length == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        parseSchema ();
        parseArguments ();
        <span class="hljs-keyword">return</span> valid;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parseSchema</span> <span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-keyword">for</span> (String element : schema.split (<span class="hljs-string">&quot;,&quot;</span>))
            {
                <span class="hljs-keyword">if</span> (element.length () &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-type">String</span> <span class="hljs-variable">trimmedElement</span> <span class="hljs-operator">=</span> element.trim ();
                        parseSchemaElement (trimmedElement);
                    }
            }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseSchemaElement</span> <span class="hljs-params">(String element)</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-type">char</span> <span class="hljs-variable">elementId</span> <span class="hljs-operator">=</span> element.charAt (<span class="hljs-number">0</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">elementTail</span> <span class="hljs-operator">=</span> element.substring (<span class="hljs-number">1</span>);
        validateSchemaElementId (elementId);
        <span class="hljs-keyword">if</span> (isBooleanSchemaElement (elementTail))
            parseBooleanSchemaElement (elementId);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isStringSchemaElement (elementTail))
            parseStringSchemaElement (elementId);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">validateSchemaElementId</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> <span class="hljs-keyword">throws</span> ParseException
    {
        <span class="hljs-keyword">if</span> (!Character.isLetter (elementId))
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span> (<span class="hljs-string">&quot;Bad character:&quot;</span> + elementId
                                              + <span class="hljs-string">&quot;in Args format: &quot;</span> + schema,
                                          <span class="hljs-number">0</span>);
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseStringSchemaElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span>
    {
        stringArgs.put (elementId, <span class="hljs-string">&quot;&quot;</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isStringSchemaElement</span> <span class="hljs-params">(String elementTail)</span>
    {
        <span class="hljs-keyword">return</span> elementTail.equals (<span class="hljs-string">&quot;*&quot;</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isBooleanSchemaElement</span> <span class="hljs-params">(String elementTail)</span>
    {
        <span class="hljs-keyword">return</span> elementTail.length () == <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseBooleanSchemaElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span>
    {
        booleanArgs.put (elementId, <span class="hljs-literal">false</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">parseArguments</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">for</span> (currentArgument = <span class="hljs-number">0</span>; currentArgument &lt; args.length;
             currentArgument++)
            {
                <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> args[currentArgument];
                parseArgument (arg);
            }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseArgument</span> <span class="hljs-params">(String arg)</span>
    {
        <span class="hljs-keyword">if</span> (arg.startsWith (<span class="hljs-string">&quot;-&quot;</span>))
            parseElements (arg);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseElements</span> <span class="hljs-params">(String arg)</span>
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; arg.length (); i++)
            parseElement (arg.charAt (i));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">parseElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-keyword">if</span> (setArgument (argChar))
            argsFound.add (argChar);
        <span class="hljs-keyword">else</span>
            {
                unexpectedArguments.add (argChar);
                valid = <span class="hljs-literal">false</span>;
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">setArgument</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">set</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (isBoolean (argChar))
            setBooleanArg (argChar, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isString (argChar))
            setStringArg (argChar, <span class="hljs-string">&quot;&quot;</span>);
        <span class="hljs-keyword">else</span>
            set = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> set;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setStringArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar, String s)</span>
    {
        currentArgument++;
        <span class="hljs-keyword">try</span>
            {
                stringArgs.put (argChar, args[currentArgument]);
            }
        <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e)
            {
                valid = <span class="hljs-literal">false</span>;
                errorArgument = argChar;
                errorCode = ErrorCode.MISSING_STRING;
            }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isString</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-keyword">return</span> stringArgs.containsKey (argChar);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title function_">setBooleanArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar, <span class="hljs-type">boolean</span> value)</span>
    {
        booleanArgs.put (argChar, value);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isBoolean</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span>
    {
        <span class="hljs-keyword">return</span> booleanArgs.containsKey (argChar);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>
    <span class="hljs-title function_">cardinality</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> argsFound.size ();
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">usage</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">if</span> (schema.length () &gt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;-[&quot;</span> + schema + <span class="hljs-string">&quot;]&quot;</span>;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">errorMessage</span> <span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception
    {
        <span class="hljs-keyword">if</span> (unexpectedArguments.size () &gt; <span class="hljs-number">0</span>)
            {
                <span class="hljs-keyword">return</span> unexpectedArgumentMessage ();
            }
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">switch</span> (errorCode)
                {
                <span class="hljs-keyword">case</span> MISSING_STRING:
                    <span class="hljs-keyword">return</span> String.format (
                        <span class="hljs-string">&quot;Could not find string parameter for -%c.&quot;</span>,
                        errorArgument);
                <span class="hljs-keyword">case</span> OK:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span> (<span class="hljs-string">&quot;TILT: Should not get here.&quot;</span>);
                }
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">private</span> String
    <span class="hljs-title function_">unexpectedArgumentMessage</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span> (<span class="hljs-string">&quot;Argument(s) -&quot;</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : unexpectedArguments)
            {
                message.append (c);
            }
        message.append (<span class="hljs-string">&quot; unexpected.&quot;</span>);
        <span class="hljs-keyword">return</span> message.toString ();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">getBoolean</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> falseIfNull (booleanArgs.get (arg));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">falseIfNull</span> <span class="hljs-params">(Boolean b)</span>
    {
        <span class="hljs-keyword">return</span> b == <span class="hljs-literal">null</span> ? <span class="hljs-literal">false</span> : b;
    }
    <span class="hljs-keyword">public</span> String
    <span class="hljs-title function_">getString</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> blankIfNull (stringArgs.get (arg));
    }
    <span class="hljs-keyword">private</span> String
    <span class="hljs-title function_">blankIfNull</span> <span class="hljs-params">(String s)</span>
    {
        <span class="hljs-keyword">return</span> s == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : s;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">has</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
    {
        <span class="hljs-keyword">return</span> argsFound.contains (arg);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span>
    <span class="hljs-title function_">isValid</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> valid;
    }
}
</code></pre>
<div dir="rtl">
<p>می‌بینید که اوضاع کم‌کم داره از کنترل خارج می‌شه. هنوز فاجعه‌بار نیست، اما بهم‌ریختگی داره کم‌کم رشد می‌کنه. فعلاً فقط یه توده‌ است، اما هنوز عفونت‌زده و فاسد نشده. اضافه شدن نوع آرگومان عددی بود که این توده رو واقعاً وارد مرحلهٔ تخمیر و فساد کرد.</p>
<h2>پس متوقف شدم</h2>
<p>حداقل دو نوع آرگومان دیگه هم داشتم که می‌خواستم اضافه کنم، اما مشخص بود که اوضاع رو خیلی بدتر خواهند کرد. اگر بی‌مهابا جلو می‌رفتم، احتمالاً می‌تونستم کاری کنم که درست کار کنن، اما پشت سرم یه آشوب بزرگی باقی می‌ذاشتم که دیگه قابل اصلاح نبود. اگر قرار بود ساختار این کد واقعاً قابل نگهداری بمونه، الان وقت اصلاحش بود.</p>
<p>پس افزودن قابلیت‌ها رو متوقف کردم و شروع به بازآرایی (Refactoring) کردم. چون تازه آرگومان‌های رشته‌ای و عددی رو اضافه کرده بودم، خوب می‌دونستم که هر نوع آرگومان جدید به کدهای تازه‌ای در سه نقطهٔ اصلی نیاز داره:</p>
<p>ابتدا باید یه راهی برای تحلیل عنصر اسکیمای اون آرگومان تعریف می‌شد تا بتونم <code>HashMap</code> مخصوص اون نوع رو انتخاب کنم.</p>
<p>بعد، اون نوع آرگومان باید در آرگومان‌های خط فرمان تجزیه (parse) می‌شد و به نوع واقعی خودش تبدیل می‌شد.</p>
<p>در نهایت، یه متد <code>getXXX</code> مخصوص لازم بود که مقدار اون آرگومان رو به عنوان نوع واقعی خودش به کاربر برگردونه.</p>
<p>چندین نوع مختلف که همشون متدهایی مشابه دارن — این یعنی وقتشه که یه کلاس جدید تعریف کنیم. و این‌طوری بود که مفهوم <code>ArgumentMarshaler</code> شکل گرفت.</p>
<p>دربارهٔ رویکرد تدریجی (Incrementalism)<br>
یکی از بدترین کارهایی که می‌تونید با یه برنامه بکنید اینه که در نام اصلاح و بهبود، تغییرات عظیم ساختاری در اون ایجاد کنید. بعضی برنامه‌ها هیچ‌وقت از این «بهبودها» جان سالم به در نمی‌برن. مشکل اینجاست که خیلی سخته برنامه‌ای رو که قبل از این تغییرات به‌درستی کار می‌کرد، دوباره دقیقاً به همون وضعیت عملکردی برسونید.</p>
<p>برای جلوگیری از این موضوع، من از روش توسعه مبتنی بر آزمون (<code>TDD</code>) استفاده می‌کنم. یکی از اصول اصلی در این روش اینه که سیستم همیشه باید کار کنه. به‌عبارت دیگه، در <code>TDD</code> من اجازه ندارم تغییری در سیستم بدم که باعث خراب شدنش بشه. هر تغییری که اعمال می‌کنم باید سیستم رو در همون وضعیت قبلی نگه داره.</p>
<p>برای رسیدن به این هدف، باید یه مجموعه تست خودکار داشته باشم که هر لحظه بتونم اجراش کنم تا مطمئن شم که رفتار سیستم تغییر نکرده. برای کلاس <code>Args،</code> من همزمان با ساختن همون پشتهٔ عفونت‌زا، یه مجموعه تست واحد (unit test) و تست پذیرش (acceptance test) ایجاد کرده بودم. تست‌های واحد رو با استفاده از JUnit در جاوا نوشته بودم. تست‌های پذیرش هم به صورت صفحات ویکی در <code>FitNesse</code> نوشته شده بودن.</p>
<p>هر زمان که می‌خواستم، می‌تونستم این تست‌ها رو اجرا کنم و اگر همه‌شون پاس می‌شدن، با اطمینان می‌گفتم که سیستم همون‌طوری که انتظار دارم کار می‌کنه.</p>
<p>پس من جلو رفتم و تعداد زیادی تغییر خیلی کوچک اعمال کردم. هر تغییر، ساختار سیستم رو به سمت مفهوم <code>ArgumentMarshaler</code> هدایت می‌کرد. و در عین حال، هر تغییر سیستم رو سالم نگه می‌داشت.</p>
<p>اولین کاری که کردم، اضافه کردن اسکلت اولیهٔ کلاس <code>ArgumentMarshaler</code> به انتهای همون پشتهٔ عفونت‌زا بود.</p>
</div>
<p>Listing 14-11 - ArgumentMarshaller appended to Args.java</p>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBoolean</span><span class="hljs-params">(<span class="hljs-type">boolean</span> value)</span> { booleanValue = value; }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> booleanValue; }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{}
}
</code></pre>
<div dir="rtl">
<p>بدیهیه که این تغییر قرار نبود چیزی رو خراب کنه. پس قدم بعدی رو برداشتم و ساده‌ترین تغییری رو اعمال کردم که می‌تونستم، طوری که کمترین آسیب ممکن رو وارد کنه. من <code>HashMap</code> مربوط به آرگومان‌های بولی (<code>Boolean</code>) رو تغییر دادم تا به جای نگهداری مقدار نهایی، یک <code>ArgumentMarshaler</code> نگه‌داری کنه.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; booleanArgs = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
</code></pre>
<div dir="rtl">
<p>این تغییر چند خط از کد رو خراب کرد، که من سریعاً اصلاحشون کردم.</p>
</div>
<pre class="hljs"><code>...
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseBooleanSchemaElement</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> 
{
   booleanArgs.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span>());
}
...

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBooleanArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar, <span class="hljs-type">boolean</span> value)</span> {
   booleanArgs.get(argChar).setBoolean(value);
}
...

<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
   <span class="hljs-keyword">return</span> falseIfNull(booleanArgs.get(arg).getBoolean());
}
</code></pre>
<div dir="rtl">
<p>دقت کنید که این تغییرات دقیقاً در همون بخش‌هایی اعمال شدن که قبلاً هم بهشون اشاره کردم: تحلیل (<code>parse</code>)، تنظیم (<code>set</code>) و دریافت (<code>get</code>) مقدار برای نوع آرگومان.<br>
با وجود اینکه این تغییر خیلی کوچک بود، ولی متأسفانه باعث شد بعضی از تست‌ها fail بشن.</p>
<p>اگر به متد <code>getBoolean</code> دقت کنید، می‌بینید که اگه این تابع رو با آرگومانی مثل 'y' صدا بزنید، ولی هیچ آرگومان 'y'ای وجود نداشته باشه، اون‌وقت <code>booleanArgs.get('y')</code> مقدار <code>null</code> برمی‌گردونه و این باعث می‌شه که تابع، یه استثنای <code>NullPointerException</code> بندازه.<br>
قبلاً برای جلوگیری از این اتفاق از تابعی به نام <code>falseIfNull</code> استفاده می‌کردم، ولی با تغییری که دادم، دیگه این تابع کارایی نداشت.</p>
<p>رویکرد تدریجی (Incrementalism) ایجاب می‌کرد که اول همین مشکل رو برطرف کنم، قبل از اینکه تغییرات دیگه‌ای اعمال کنم.<br>
خوشبختانه رفع این مشکل خیلی سخت نبود. فقط کافی بود بررسی null بودن رو جابه‌جا کنم — دیگه لازم نبود بررسی کنم که مقدار بولی null هست یا نه؛ باید بررسی می‌کردم که آیا <code>ArgumentMarshaler</code> موجود هست یا نه.</p>
<p>اول از همه، فراخوانی تابع <code>falseIfNull</code> در <code>getBoolean</code> رو حذف کردم چون دیگه بی‌فایده بود، و بعد خود تابع <code>falseIfNull</code> رو هم کاملاً پاک کردم.<br>
تست‌ها هنوز هم به همون شکل fail می‌شدن، و این یعنی با اطمینان می‌تونستم بگم که اشکال جدیدی ایجاد نکردم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> 
{
    <span class="hljs-keyword">return</span> booleanArgs.get(arg).getBoolean();
}
</code></pre>
<div dir="rtl">
<p>در مرحلهٔ بعد، تابع رو به دو خط تقسیم کردم و نمونهٔ <code>ArgumentMarshaler</code> رو داخل یک متغیر جداگانه به نام <code>argumentMarshaller</code> قرار دادم.<br>
از اسم طولانی این متغیر خوشم نیومد؛ خیلی تکراری و شلوغ‌کننده بود و باعث می‌شد تابع ظاهر نامرتبی داشته باشه.<br>
پس اسمش رو کوتاه کردم و گذاشتم <code>am</code> [یادداشت N5].</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
{
   Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> booleanArgs.get(arg);
   <span class="hljs-keyword">return</span> am.getBoolean();
}
</code></pre>
<div dir="rtl">
<p>و بعدش منطق تشخیص مقدار <code>null</code> رو اضافه کردم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> 
{
   Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> booleanArgs.get(arg);
   <span class="hljs-keyword">return</span> am != <span class="hljs-literal">null</span> &amp;&amp; am.getBoolean();
}
</code></pre>
<div dir="rtl">
<h2>آرگومان‌های رشته‌ای (String Arguments)</h2>
<p>اضافه کردن آرگومان‌های <code>String</code> خیلی شبیه به اضافه کردن آرگومان‌های <code>boolean</code> بود.<br>
باید <code>HashMap</code> مربوطه رو تغییر می‌دادم و مطمئن می‌شدم که توابع <code>parse،</code> <code>set</code> و <code>get</code> به‌درستی کار می‌کنن.</p>
<p>نباید چیز شگفت‌انگیزی در ادامه وجود داشته باشه، مگر اینکه متوجه بشید که من بخش زیادی از پیاده‌سازی <code>marshalling</code> رو در کلاس پایهٔ <code>ArgumentMarshaller</code> قرار دادم،<br>
به‌جای اینکه این منطق رو بین کلاس‌های مشتق‌شده پخش کنم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; stringArgs
    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt; ();
... 

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStringSchemaElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span>
{
    stringArgs.put (elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArgumentMarshaler</span> ());
}
... 

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStringArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException
{
    currentArgument++;
    <span class="hljs-keyword">try</span>
        {
            stringArgs.get (argChar).setString (args[currentArgument]);
        }
    <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e)
        {
            valid = <span class="hljs-literal">false</span>;
            errorArgumentId = argChar;
            errorCode = ErrorCode.MISSING_STRING;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> ();
        }
}
... 

<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getString</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
{
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> stringArgs.get (arg);
    <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : am.getString ();
}
...

<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> String stringValue;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBoolean</span> <span class="hljs-params">(<span class="hljs-type">boolean</span> value)</span>
    {
        booleanValue = value;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> booleanValue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setString</span> <span class="hljs-params">(String s)</span>
    {
        stringValue = s;
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getString</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> stringValue == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : stringValue;
    }
}
</code></pre>
<div dir="rtl">
<p>باز هم، این تغییرات یکی‌یکی و به‌صورت تدریجی انجام شدن، به‌طوری که تست‌ها همچنان قابل اجرا بودن—حتی اگر همه‌شون پاس نمی‌کردن.<br>
هر وقت یکی از تست‌ها <code>fail</code> می‌شد، اول اونو اصلاح می‌کردم و دوباره به حالت پاس‌شده درمی‌آوردم، بعد سراغ تغییر بعدی می‌رفتم.</p>
<p>تا اینجا احتمالاً متوجه هدف کلی من شده‌اید:<br>
می‌خواستم تمام رفتارهای فعلی <code>marshalling</code> رو وارد کلاس پایه‌ی <code>ArgumentMarshaler</code> کنم،<br>
و بعدش به‌تدریج این رفتارها رو به کلاس‌های مشتق‌شده انتقال بدم.<br>
این کار باعث می‌شه برنامه در طول فرایند تغییر ساختار، همچنان کار کنه و نشکنه.</p>
<p>گام بعدی هم مشخص بود: باید قابلیت پردازش آرگومان‌های عدد صحیح (<code>int</code>) رو به <code>ArgumentMarshaler</code> منتقل می‌کردم.<br>
و باز هم، مثل قبل، هیچ شگفتی خاصی در این مرحله وجود نداشت.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; intArgs
    = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt; ();

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseIntegerSchemaElement</span> <span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span>
{
    intArgs.put (elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> ());
}
...

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntArg</span> <span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException
{
    currentArgument++;
    <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span>
        {
            parameter = args[currentArgument];
            intArgs.get (argChar).setInteger (Integer.parseInt (parameter));
        }
    <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e)
        {
            valid = <span class="hljs-literal">false</span>;
            errorArgumentId = argChar;
            errorCode = ErrorCode.MISSING_INTEGER;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> ();
        }
    <span class="hljs-keyword">catch</span> (NumberFormatException e)
        {
            valid = <span class="hljs-literal">false</span>;
            errorArgumentId = argChar;
            errorParameter = parameter;
            errorCode = ErrorCode.INVALID_INTEGER;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span> ();
        }
}
...

<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getInt</span> <span class="hljs-params">(<span class="hljs-type">char</span> arg)</span>
{
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> intArgs.get (arg);
    <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : am.getInteger ();
}
...

<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> String stringValue;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> integerValue;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBoolean</span> <span class="hljs-params">(<span class="hljs-type">boolean</span> value)</span>
    {
        booleanValue = value;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> booleanValue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setString</span> <span class="hljs-params">(String s)</span>
    {
        stringValue = s;
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getString</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> stringValue == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : stringValue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setInteger</span> <span class="hljs-params">(<span class="hljs-type">int</span> i)</span>
    {
        integerValue = i;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getInteger</span> <span class="hljs-params">()</span>
    {
        <span class="hljs-keyword">return</span> integerValue;
    }
}
</code></pre>
<div dir="rtl">
<p>وقتی که تمام منطق <code>marshalling</code> به کلاس پایه‌ی <code>ArgumentMarshaler</code> منتقل شد، شروع کردم به انتقال عملکردها به کلاس‌های مشتق‌شده.<br>
اولین قدم، منتقل کردن تابع <code>setBoolean</code> به کلاس <code>BooleanArgumentMarshaller</code> بود و مطمئن شدم که این تابع به‌درستی فراخوانی می‌شه.<br>
برای این کار، یک متد انتزاعی (<code>abstract</code>) به نام <code>set</code> ایجاد کردم.</p>
<p>این کار پایه‌ای بود برای اینکه هر کلاس مشتق‌شده، رفتار مخصوص به خودش رو در متد <code>set</code> پیاده‌سازی کنه.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> String stringValue;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> integerValue;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBoolean</span><span class="hljs-params">(<span class="hljs-type">boolean</span> value)</span> {
        booleanValue = value;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> booleanValue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setString</span><span class="hljs-params">(String s)</span> {
    stringValue = s;
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stringValue == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : stringValue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setInteger</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> {
        integerValue = i;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getInteger</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> integerValue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span>;
}
</code></pre>
<div dir="rtl">
<p>سپس متد <code>set</code> رو در کلاس <code>BooleanArgumentMarshaller</code> پیاده‌سازی کردم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {
        booleanValue = <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<div dir="rtl">
<p>و در نهایت، فراخوانی تابع <code>setBoolean</code> رو با فراخوانی <code>set</code> جایگزین کردم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBooleanArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar, <span class="hljs-type">boolean</span> value)</span> {
    booleanArgs.get(argChar).set(<span class="hljs-string">&quot;true&quot;</span>);
}
</code></pre>
<div dir="rtl">
<p>تمام تست‌ها همچنان پاس می‌شدن، و چون این تغییر باعث شد که متد set حالا در <code>BooleanArgumentMarshaller</code> پیاده‌سازی شده باشه، متد <code>setBoolean</code> رو از کلاس پایه‌ی <code>ArgumentMarshaler</code> حذف کردم.</p>
<p>به این نکته دقت کن که متد انتزاعی <code>set</code> یک آرگومان از نوع <code>String</code> دریافت می‌کنه،<br>
اما پیاده‌سازی اون در <code>BooleanArgumentMarshaller</code> اصلاً از این آرگومان استفاده نمی‌کنه.<br>
من این آرگومان رو عمداً اضافه کردم، چون می‌دونستم که کلاس‌های <code>StringArgumentMarshaller</code> و <code>IntegerArgumentMarshaller</code> به اون نیاز خواهند داشت.</p>
<p>در ادامه، تصمیم گرفتم تابع <code>get</code> رو هم به <code>BooleanArgumentMarshaler</code> منتقل کنم.<br>
انتقال توابع <code>get</code> معمولاً کمی ناخوشایند هست، چون باید مقدار بازگشتی از نوع <code>Object</code> باشه<br>
و در این مورد، باید به <code>Boolean</code> تبدیل (<code>cast</code>) بشه:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> booleanArgs.get(arg);
    <span class="hljs-keyword">return</span> am != <span class="hljs-literal">null</span> &amp;&amp; (Boolean) am.get();
}
</code></pre>
<div dir="rtl">
<p>برای اینکه کد کامپایل بشه، ابتدا متد <code>get</code> رو به صورت پیش‌فرض در <code>ArgumentMarshaler</code> اضافه کردم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    ...
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<div dir="rtl">
<p>کد کامپایل شد اما تست‌ها شکست خوردن. برای درست کردن تست‌ها،<br>
متد <code>get</code> رو <code>abstract</code> کردم و در <code>BooleanArgumentMarshaler</code> پیاده‌سازی‌اش کردم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    ...
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {
        booleanValue = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> booleanValue;
    }
}

</code></pre>
<div dir="rtl">
<p>و حالا دوباره همه‌ی تست‌ها پاس می‌شن.<br>
با این کار، متدهای <code>set</code> و <code>get</code> به‌طور کامل به کلاس <code>BooleanArgumentMarshaler</code> منتقل شدن.<br>
این اجازه رو بهم داد که:</p>
<p>متد قدیمی <code>getBoolean</code> رو از <code>ArgumentMarshaler</code> حذف کنم</p>
<p>متغیر <code>booleanValue</code> رو از کلاس پایه حذف و در <code>BooleanArgumentMarshaler</code> به صورت <code>private</code> منتقل کنم</p>
<p>بعد از این، دقیقاً همین الگو رو برای آرگومان‌های <code>String</code> هم پیاده‌سازی کردم:<br>
تابع‌های <code>set</code> و <code>get</code> رو منتقل کردم، تابع‌های بلااستفاده رو حذف کردم، و متغیرها رو جابجا کردم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStringArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    currentArgument++;
    <span class="hljs-keyword">try</span> {
        stringArgs.get(argChar).set(args[currentArgument]);
    } <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        errorCode = ErrorCode.MISSING_STRING;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
    }
}
... 
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getString</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> stringArgs.get(arg);
    <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : (String) am.get();
}
... 
<span class="hljs-keyword">private</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> integerValue;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setInteger</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> {
        integerValue = i;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getInteger</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> integerValue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span>;
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {
        booleanValue = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> booleanValue;
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">stringValue</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {
        stringValue = s;
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stringValue;
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {}
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<div dir="rtl">
<p>در نهایت، من همین فرایند را برای اعداد صحیح (<code>integers</code>) تکرار کردم. این کار کمی پیچیده‌تر بود زیرا اعداد صحیح نیاز به تجزیه (<code>parsing</code>) داشتند و عملیات تجزیه می‌تواند استثنا (<code>exception</code>) ایجاد کند. اما نتیجه بهتر شد زیرا کل مفهوم <code>NumberFormatException</code> در داخل کلاس <code>IntegerArgumentMarshaler</code> پنهان شد.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isIntArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> {
    <span class="hljs-keyword">return</span> intArgs.containsKey(argChar);
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    currentArgument++;
    <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        parameter = args[currentArgument];
        intArgs.get(argChar).set(parameter);
    } <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        errorCode = ErrorCode.MISSING_INTEGER;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        errorParameter = parameter;
        errorCode = ErrorCode.INVALID_INTEGER;
        <span class="hljs-keyword">throw</span> e;
    }
}
... <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBooleanArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> {
    <span class="hljs-keyword">try</span> {
        booleanArgs.get(argChar).set(<span class="hljs-string">&quot;true&quot;</span>);
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
    }
}
... <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getInt</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> intArgs.get(arg);
    <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : (Integer) am.get();
}
... <span class="hljs-keyword">private</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> ArgsException;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span>;
}
... <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">intValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">try</span> {
            intValue = Integer.parseInt(s);
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        }
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> intValue;
    }
}
</code></pre>
<div dir="rtl">
<p>مطمئناً، تست‌ها همچنان موفق بودند. سپس، من سه نقشه مختلف (<code>Map</code>) که در ابتدای الگوریتم وجود داشتند را حذف کردم. این کار سیستم را به طور کلی جنریک‌تر کرد. اما نمی‌توانستم آن‌ها را فقط با حذف کردن از سیستم پاک کنم زیرا این کار باعث خراب شدن سیستم می‌شد. در عوض، من یک نقشه جدید برای <code>ArgumentMarshaler</code> اضافه کردم و سپس به طور تدریجی، هر یک از متدها را تغییر دادم تا از این نقشه جدید به جای سه نقشه اصلی استفاده کنند.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span> {
    ... <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; booleanArgs =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; stringArgs =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; intArgs =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    ... <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseBooleanSchemaElement</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span>();
        booleanArgs.put(elementId, m);
        marshalers.put(elementId, m);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseIntegerSchemaElement</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span>();
        intArgs.put(elementId, m);
        marshalers.put(elementId, m);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStringSchemaElement</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArgumentMarshaler</span>();
        stringArgs.put(elementId, m);
        marshalers.put(elementId, m);
    }
}
</code></pre>
<div dir="rtl">
<p>مطمئناً، تمام تست‌ها همچنان موفق بودند. سپس، من متد <code>isBooleanArg</code> را از این حالت تغییر دادم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBooleanArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> {
   <span class="hljs-keyword">return</span> booleanArgs.containsKey(argChar);
}
</code></pre>
<div dir="rtl">
به این :
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBooleanArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">return</span> m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler;
}
</code></pre>
<div dir="rtl">
<p>تست‌ها همچنان موفق بودند. بنابراین، من همین تغییر را برای متدهای <code>isIntArg</code> و <code>isStringArg</code> نیز اعمال کردم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isIntArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">return</span> m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler;
}
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStringArg</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">return</span> m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler;
}
</code></pre>
<div dir="rtl">
<p>تست‌ها همچنان موفق بودند. بنابراین، من تمام تماس‌های تکراری به <code>marshalers.get</code> را به شکل زیر حذف کردم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">if</span> (isBooleanArg(m))
        setBooleanArg(argChar);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isStringArg(m))
        setStringArg(argChar);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isIntArg(m))
        setIntArg(argChar);
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isIntArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> {
    <span class="hljs-keyword">return</span> m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler;
}
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStringArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> {
    <span class="hljs-keyword">return</span> m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler;
}
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBooleanArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> {
    <span class="hljs-keyword">return</span> m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler;
}
</code></pre>
<div dir="rtl">
<p>این کار هیچ دلیلی برای وجود متدهای سه‌گانه <code>isxxxArg</code> باقی نگذاشت. بنابراین، من آن‌ها را به صورت درون‌خطی (inline) تغییر دادم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
        setBooleanArg(argChar);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
        setStringArg(argChar);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
        setIntArg(argChar);
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<div dir="rtl">
<p>سپس، من شروع به استفاده از نقشه <code>marshalers</code> در توابع set کردم و استفاده از سه نقشه دیگر را متوقف کردم. من ابتدا با مقادیر بولی (<code>boolean</code>) شروع کردم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
        setBooleanArg(m);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
        setStringArg(argChar);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
        setIntArg(argChar);
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
...
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBooleanArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> {
    <span class="hljs-keyword">try</span> {
        m.set(<span class="hljs-string">&quot;true&quot;</span>); <span class="hljs-comment">// was: booleanArgs.get(argChar).set(&quot;true&quot;);</span>
    } 
    <span class="hljs-keyword">catch</span> (ArgsException e) {}
}
</code></pre>
<div dir="rtl">
<p>تست‌ها همچنان موفق بودند، بنابراین همین کار را برای رشته‌ها (<code>Strings</code>) و اعداد صحیح (<code>Integers</code>) انجام دادم. این کار به من اجازه داد تا برخی از کدهای پیچیده مدیریت استثناها را درون تابع <code>setArgument</code> ادغام کنم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
            setBooleanArg(m);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
            setStringArg(m);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
            setIntArg(m);
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        <span class="hljs-keyword">throw</span> e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> <span class="hljs-keyword">throws</span> ArgsException {
    currentArgument++;
    <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        parameter = args[currentArgument];
        m.set(parameter);
    } <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e) {
        errorCode = ErrorCode.MISSING_INTEGER;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
        errorParameter = parameter;
        errorCode = ErrorCode.INVALID_INTEGER;
        <span class="hljs-keyword">throw</span> e;
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStringArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> <span class="hljs-keyword">throws</span> ArgsException {
    currentArgument++;
    <span class="hljs-keyword">try</span> {
        m.set(args[currentArgument]);
    } <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e) {
        errorCode = ErrorCode.MISSING_STRING;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
    }
}
</code></pre>
<div dir="rtl">
<p>من نزدیک بودم که بتوانم سه نقشه قدیمی را حذف کنم. اولین کاری که باید می‌کردم این بود که تابع <code>getBoolean</code> را از این حالت تغییر دهم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> booleanArgs.get(arg);
    <span class="hljs-keyword">return</span> am != <span class="hljs-literal">null</span> &amp;&amp; (Boolean) am.get();
}
</code></pre>
<div dir="rtl">
به این :
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
    <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span> {
        b = am != <span class="hljs-literal">null</span> &amp;&amp; (Boolean) am.get();
    } <span class="hljs-keyword">catch</span> (ClassCastException e) {
        b = <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> b;
}
</code></pre>
<div dir="rtl">
<p>این تغییر آخر ممکن است شگفت‌انگیز به نظر برسد. چرا ناگهان تصمیم گرفتم که با <code>ClassCastException</code> برخورد کنم؟ دلیل این است که من یک مجموعه از تست‌های واحد و یک مجموعه جداگانه از تست‌های پذیرش که در <code>FitNesse</code> نوشته شده‌اند، دارم. مشخص شد که تست‌های <code>FitNesse</code> تضمین می‌کنند که اگر از <code>getBoolean</code> برای یک آرگومان غیر بولی استفاده کنید، مقدار <code>false</code> دریافت خواهید کرد، اما تست‌های واحد این کار را انجام نمی‌دهند. تا به این نقطه، من تنها تست‌های واحد را اجرا کرده بودم.</p>
<p>این تغییر آخر به من این امکان را داد که استفاده دیگری از نقشه بولی را حذف کنم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseBooleanSchemaElement</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span>();
    <span class="hljs-comment">//booleanArgs.put(elementId, m);</span>
    marshalers.put(elementId, m);
}
</code></pre>
<div dir="rtl">
<p>و حالا می‌توانیم نقشه‌ی <code>Boolean</code> را حذف کنیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span> {
    ...
    <span class="hljs-comment">//private Map&lt;Character, ArgumentMarshaler&gt; booleanArgs =</span>
        <span class="hljs-comment">//new HashMap&lt;Character, ArgumentMarshaler&gt;();</span>
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; stringArgs =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; intArgs =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    ...
</code></pre>
<div dir="rtl">
<p>سپس آرگومان‌های رشته‌ای و عدد صحیح را به همان شیوه منتقل کردم و کمی پاک‌سازی در بخش <code>boolean</code> ها انجام دادم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseBooleanSchemaElement</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> {
    marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span>());
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseIntegerSchemaElement</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> {
    marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span>());
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStringSchemaElement</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> {
    marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArgumentMarshaler</span>());
}
... 
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getString</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : (String) am.get();
    } <span class="hljs-keyword">catch</span> (ClassCastException e) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getInt</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : (Integer) am.get();
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
}
...
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span> {
    ... 
    <span class="hljs-comment">//private Map&lt;Character, ArgumentMarshaler&gt; stringArgs =</span>
        <span class="hljs-comment">//new HashMap&lt;Character, ArgumentMarshaler&gt;();</span>
    <span class="hljs-comment">//private Map&lt;Character, ArgumentMarshaler&gt; intArgs =</span>
        <span class="hljs-comment">//new HashMap&lt;Character, ArgumentMarshaler&gt;();</span>
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    ...
}
</code></pre>
<div dir="rtl">
<p>سپس سه متد <code>parse</code> را درون‌خطی (inline) کردم چون دیگر کار خاصی انجام نمی‌دادند.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSchemaElement</span><span class="hljs-params">(String element)</span> <span class="hljs-keyword">throws</span> ParseException {
    <span class="hljs-type">char</span> <span class="hljs-variable">elementId</span> <span class="hljs-operator">=</span> element.charAt(<span class="hljs-number">0</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">elementTail</span> <span class="hljs-operator">=</span> element.substring(<span class="hljs-number">1</span>);
    validateSchemaElementId(elementId);
    <span class="hljs-keyword">if</span> (isBooleanSchemaElement(elementTail))
        marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span>());
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isStringSchemaElement(elementTail))
        marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArgumentMarshaler</span>());
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isIntegerSchemaElement(elementTail)) {
        marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span>());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span>(
            String.format(
                <span class="hljs-string">&quot;Argument: %c has invalid format: %s.&quot;</span>, elementId, elementTail),
            <span class="hljs-number">0</span>);
    }
}
</code></pre>
<div dir="rtl">
<p>خُب، حالا بیایید دوباره به تصویر کلی نگاه کنیم. Listing 14-12 نسخه‌ی فعلی کلاس <code>Args</code> را نشان می‌دهد.</p>
</div>
<p>Listing 14-12 - Args.java (After first refactoring)</p>
<pre class="hljs"><code><span class="hljs-keyword">package</span> com.objectmentor.utilities.getopts;
<span class="hljs-keyword">import</span> java.text.ParseException;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span> {
    <span class="hljs-keyword">private</span> String schema;
    <span class="hljs-keyword">private</span> String[] args;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">valid</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;Character&gt;();
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; argsFound = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Character&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> currentArgument;
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-variable">errorArgumentId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\0&#x27;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorParameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TILT&quot;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> ErrorCode.OK;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
        OK,
        MISSING_STRING,
        MISSING_INTEGER,
        INVALID_INTEGER,
        UNEXPECTED_ARGUMENT
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Args</span><span class="hljs-params">(String schema, String[] args)</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-built_in">this</span>.schema = schema;
        <span class="hljs-built_in">this</span>.args = args;
        valid = parse();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-keyword">if</span> (schema.length() == <span class="hljs-number">0</span> &amp;&amp; args.length == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        parseSchema();
        <span class="hljs-keyword">try</span> {
            parseArguments();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
        }
        <span class="hljs-keyword">return</span> valid;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parseSchema</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-keyword">for</span> (String element : schema.split(<span class="hljs-string">&quot;,&quot;</span>)) {
            <span class="hljs-keyword">if</span> (element.length() &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">trimmedElement</span> <span class="hljs-operator">=</span> element.trim();
                parseSchemaElement(trimmedElement);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSchemaElement</span><span class="hljs-params">(String element)</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-type">char</span> <span class="hljs-variable">elementId</span> <span class="hljs-operator">=</span> element.charAt(<span class="hljs-number">0</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">elementTail</span> <span class="hljs-operator">=</span> element.substring(<span class="hljs-number">1</span>);
        validateSchemaElementId(elementId);
        <span class="hljs-keyword">if</span> (isBooleanSchemaElement(elementTail))
            marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span>());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isStringSchemaElement(elementTail))
            marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArgumentMarshaler</span>());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isIntegerSchemaElement(elementTail)) {
            marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span>());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span>(
                String.format(<span class="hljs-string">&quot;Argument: %c has invalid format: %s.&quot;</span>, elementId,
                    elementTail),
                <span class="hljs-number">0</span>);
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateSchemaElementId</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-keyword">if</span> (!Character.isLetter(elementId)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span>(
                <span class="hljs-string">&quot;Bad character:&quot;</span> + elementId + <span class="hljs-string">&quot;in Args format: &quot;</span> + schema, <span class="hljs-number">0</span>);
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStringSchemaElement</span><span class="hljs-params">(String elementTail)</span> {
        <span class="hljs-keyword">return</span> elementTail.equals(<span class="hljs-string">&quot;*&quot;</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBooleanSchemaElement</span><span class="hljs-params">(String elementTail)</span> {
        <span class="hljs-keyword">return</span> elementTail.length() == <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isIntegerSchemaElement</span><span class="hljs-params">(String elementTail)</span> {
        <span class="hljs-keyword">return</span> elementTail.equals(<span class="hljs-string">&quot;#&quot;</span>);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parseArguments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">for</span> (currentArgument = <span class="hljs-number">0</span>; currentArgument &lt; args.length;
             currentArgument++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> args[currentArgument];
            parseArgument(arg);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseArgument</span><span class="hljs-params">(String arg)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">if</span> (arg.startsWith(<span class="hljs-string">&quot;-&quot;</span>))
            parseElements(arg);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseElements</span><span class="hljs-params">(String arg)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; arg.length(); i++) parseElement(arg.charAt(i));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseElement</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">if</span> (setArgument(argChar))
            argsFound.add(argChar);
        <span class="hljs-keyword">else</span> {
            unexpectedArguments.add(argChar);
            errorCode = ErrorCode.UNEXPECTED_ARGUMENT;
            valid = <span class="hljs-literal">false</span>;
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
                setBooleanArg(m);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
                setStringArg(m);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
                setIntArg(m);
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            valid = <span class="hljs-literal">false</span>;
            errorArgumentId = argChar;
            <span class="hljs-keyword">throw</span> e;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> <span class="hljs-keyword">throws</span> ArgsException {
        currentArgument++;
        <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            parameter = args[currentArgument];
            m.set(parameter);
        } <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e) {
            errorCode = ErrorCode.MISSING_INTEGER;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            errorParameter = parameter;
            errorCode = ErrorCode.INVALID_INTEGER;
            <span class="hljs-keyword">throw</span> e;
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStringArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> <span class="hljs-keyword">throws</span> ArgsException {
        currentArgument++;
        <span class="hljs-keyword">try</span> {
            m.set(args[currentArgument]);
        } <span class="hljs-keyword">catch</span> (ArrayIndexOutOfBoundsException e) {
            errorCode = ErrorCode.MISSING_STRING;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBooleanArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> {
        <span class="hljs-keyword">try</span> {
            m.set(<span class="hljs-string">&quot;true&quot;</span>);
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cardinality</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> argsFound.size();
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">usage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (schema.length() &gt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;-[&quot;</span> + schema + <span class="hljs-string">&quot;]&quot;</span>;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">errorMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">switch</span> (errorCode) {
            <span class="hljs-keyword">case</span> OK:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;TILT: Should not get here.&quot;</span>);
            <span class="hljs-keyword">case</span> UNEXPECTED_ARGUMENT:
                <span class="hljs-keyword">return</span> unexpectedArgumentMessage();
            <span class="hljs-keyword">case</span> MISSING_STRING:
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;Could not find string parameter for -%c.&quot;</span>,
                    errorArgumentId);
            <span class="hljs-keyword">case</span> INVALID_INTEGER:
                <span class="hljs-keyword">return</span> String.format(
                    <span class="hljs-string">&quot;Argument -%c expects an integer but was &#x27;%s&#x27;.&quot;</span>,
                    errorArgumentId, errorParameter);
            <span class="hljs-keyword">case</span> MISSING_INTEGER:
                <span class="hljs-keyword">return</span> String.format(
                    <span class="hljs-string">&quot;Could not find integer parameter for -%c.&quot;</span>,
                    errorArgumentId);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">unexpectedArgumentMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(<span class="hljs-string">&quot;Argument(s) -&quot;</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : unexpectedArguments) {
            message.append(c);
        }
        message.append(<span class="hljs-string">&quot; unexpected.&quot;</span>);
        <span class="hljs-keyword">return</span> message.toString();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            b = am != <span class="hljs-literal">null</span> &amp;&amp; (Boolean) am.get();
        } <span class="hljs-keyword">catch</span> (ClassCastException e) {
            b = <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> b;
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getString</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : (String) am.get();
        } <span class="hljs-keyword">catch</span> (ClassCastException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getInt</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : (Integer) am.get();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">has</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        <span class="hljs-keyword">return</span> argsFound.contains(arg);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> valid;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgsException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span> {}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> ArgsException;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {
            booleanValue = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> booleanValue;
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">stringValue</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {
            stringValue = s;
        }
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> stringValue;
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">intValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> ArgsException {
            <span class="hljs-keyword">try</span> {
                intValue = Integer.parseInt(s);
            } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
            }
        }
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> intValue;
        }
    }
}
</code></pre>
<div dir="rtl">
<p>بعد از تمام این کارها، نتیجه کمی ناامیدکننده است. ساختار کمی بهتر شده، اما هنوز تمام آن متغیرها در بالای کلاس هستند؛ هنوز یک بررسی نوع وحشتناک در <code>setArgument</code> داریم؛ و تمام آن توابع <code>set</code> واقعاً زشت هستند. تازه به پردازش خطاها هم اشاره‌ای نکرده‌ایم. هنوز کار زیادی پیش رو داریم.</p>
<p>واقعاً دوست دارم از شر آن بررسی نوع در <code>setArgument</code> خلاص شوم <code>[G23]</code>. چیزی که می‌خواهم، یک فراخوانی واحد به <code>ArgumentMarshaler.set</code> است. این یعنی باید توابع <code>setIntArg،</code> <code>setStringArg</code> و <code>setBooleanArg</code> را به کلاس‌های مشتق‌شده‌ی <code>ArgumentMarshaler</code> منتقل کنم. اما یک مشکل وجود دارد.</p>
<p>اگر دقیق‌تر به <code>setIntArg</code> نگاه کنید، متوجه می‌شوید که از دو متغیر نمونه‌ای استفاده می‌کند: <code>args</code> و <code>currentArg</code>. برای اینکه بتوانم <code>setIntArg</code> را به داخل <code>IntegerArgumentMarshaler</code> منتقل کنم، باید هر دو را به‌عنوان آرگومان به تابع پاس بدهم. این کار ناپسند است <code>[F1]</code>. ترجیح می‌دهم فقط یک آرگومان پاس بدهم نه دو تا. خوشبختانه، یک راه‌حل ساده وجود دارد. می‌توانیم آرایه‌ی <code>args</code> را به یک لیست تبدیل کنیم و یک <code>Iterator</code> را به توابع <code>set</code> پاس بدهیم.</p>
<p>کاری که انجام دادم طی ده مرحله بود و پس از هر مرحله تمام تست‌ها را پاس می‌کردم. اما من فقط نتیجه را به شما نشان می‌دهم. شما باید بتوانید بیشتر مراحل کوچک را خودتان حدس بزنید.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span> {
    <span class="hljs-keyword">private</span> String schema;
    <span class="hljs-comment">//private String[] args;</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">valid</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeSet</span>&lt;Character&gt;();
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; argsFound = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Character&gt;();
    <span class="hljs-keyword">private</span> Iterator&lt;String&gt; currentArgument;
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-variable">errorArgumentId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\0&#x27;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorParameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TILT&quot;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> ErrorCode.OK;
    <span class="hljs-keyword">private</span> List&lt;String&gt; argsList;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
        OK,
        MISSING_STRING,
        MISSING_INTEGER,
        INVALID_INTEGER,
        UNEXPECTED_ARGUMENT
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Args</span><span class="hljs-params">(String schema, String[] args)</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-built_in">this</span>.schema = schema;
        argsList = Arrays.asList(args);
        valid = parse();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-keyword">if</span> (schema.length() == <span class="hljs-number">0</span> &amp;&amp; argsList.size() == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        parseSchema();
        <span class="hljs-keyword">try</span> {
            parseArguments();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
        }
        <span class="hljs-keyword">return</span> valid;
    }
    -- -<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parseArguments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">for</span> (currentArgument = argsList.iterator();
             currentArgument.hasNext();) {
            <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> currentArgument.next();
            parseArgument(arg);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    -- -<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIntArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            parameter = currentArgument.next();
            m.set(parameter);
        } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
            errorCode = ErrorCode.MISSING_INTEGER;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            errorParameter = parameter;
            errorCode = ErrorCode.INVALID_INTEGER;
            <span class="hljs-keyword">throw</span> e;
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStringArg</span><span class="hljs-params">(ArgumentMarshaler m)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">try</span> {
            m.set(currentArgument.next());
        } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
            errorCode = ErrorCode.MISSING_STRING;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        }
    }
}
</code></pre>
<div dir="rtl">
<p>این‌ها تغییرات ساده‌ای بودند که باعث شدند تمام تست‌ها همچنان پاس شوند. حالا می‌توانیم شروع به انتقال توابع <code>set</code> به کلاس‌های مشتق‌شده‌ی مناسب کنیم. ابتدا باید تغییر زیر را در تابع <code>setArgument</code> اعمال کنم:</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">if</span> (m == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
            setBooleanArg(m);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
            setStringArg(m);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
            setIntArg(m);
        <span class="hljs-comment">//else</span>
            <span class="hljs-comment">//return false;</span>
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        <span class="hljs-keyword">throw</span> e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<div dir="rtl">
<p>این تغییر مهم است چون می‌خواهیم زنجیره <code>if-else</code> را به‌طور کامل حذف کنیم. بنابراین، لازم بود شرط خطا را از آن خارج کنیم.<br>
حالا می‌توانیم شروع به انتقال توابع set کنیم. تابع <code>setBooleanArg</code> ساده است، پس ابتدا آن را آماده می‌کنیم. هدف ما این است که تابع <code>setBooleanArg</code> را به‌گونه‌ای تغییر دهیم که فقط عملیات را به کلاس <code>BooleanArgumentMarshaler</code> واگذار کند.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">if</span> (m == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
            setBooleanArg(m, currentArgument);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
            setStringArg(m);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
            setIntArg(m);
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        <span class="hljs-keyword">throw</span> e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
---
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBooleanArg</span><span class="hljs-params">(ArgumentMarshaler m,
    Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-comment">//try {</span>
        m.set(<span class="hljs-string">&quot;true&quot;</span>);
    <span class="hljs-comment">//    catch (ArgsException e) {</span>
    <span class="hljs-comment">//    }</span>
    }
</code></pre>
<div dir="rtl">
<p>مگر همین پردازش استثنا را تازه اضافه نکرده بودیم؟ اضافه کردن چیزهایی برای اینکه بعداً آن‌ها را حذف کنیم، در فرایند بازآرایی (Refactoring) بسیار رایج است. کوچکی گام‌ها و نیاز به حفظ عملکرد صحیح برنامه باعث می‌شود که چیزها را زیاد جابه‌جا کنید. بازآرایی خیلی شبیه حل کردن مکعب روبیک است. برای رسیدن به یک هدف بزرگ، گام‌های کوچکی زیادی لازم است. هر گام، امکان اجرای گام بعدی را فراهم می‌کند.</p>
<p>چرا آن <code>iterator</code> را ارسال کردیم وقتی که <code>setBooleanArg</code> قطعاً به آن نیازی ندارد؟ چون <code>setIntArg</code> و <code>setStringArg</code> نیاز خواهند داشت! و از آنجایی که می‌خواهم هر سه تابع را از طریق یک متد انتزاعی در <code>ArgumentMarshaller</code> پیاده‌سازی کنم، باید آن را به <code>setBooleanArg</code> نیز ارسال کنم.</p>
<p>پس حالا تابع <code>setBooleanArg</code> بی‌استفاده شده است. اگر تابعی به نام <code>set</code> در کلاس <code>ArgumentMarshaler</code> وجود داشت، می‌توانستیم مستقیماً آن را فراخوانی کنیم. بنابراین، زمان آن رسیده که این تابع را اضافه کنیم! اولین گام این است که یک متد انتزاعی (<code>abstract</code>) جدید به کلاس <code>ArgumentMarshaler</code> اضافه کنیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span>
        <span class="hljs-keyword">throws</span> ArgsException;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> ArgsException;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span>;
}
</code></pre>
<div dir="rtl">
<p>مطمئناً این تغییر باعث شکست در همه مشتقات (<code>derivatives</code>) می‌شود. پس بیایید متد جدید را در هر کدام پیاده‌سازی کنیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">booleanValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-comment">// booleanValue = true;</span>
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {
        booleanValue = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> booleanValue;
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">stringValue</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {}
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {
        stringValue = s;
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stringValue;
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">intValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {}
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">try</span> {
            intValue = Integer.parseInt(s);
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        }
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> intValue;
    }
}
</code></pre>
<div dir="rtl">
<p>و حالا می‌توانیم <code>setBooleanArg</code> را حذف کنیم!</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">if</span> (m == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
            m.set(currentArgument);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
            setStringArg(m);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
            setIntArg(m);
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        <span class="hljs-keyword">throw</span> e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<div dir="rtl">
<p>تمام تست‌ها پاس شدند و تابع <code>set</code> به درستی به <code>BooleanArgumentMarshaler</code> منتقل شد! حالا می‌توانیم همین کار را برای رشته‌ها و اعداد صحیح انجام دهیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">if</span> (m == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> BooleanArgumentMarshaler)
            m.set(currentArgument);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> StringArgumentMarshaler)
            m.set(currentArgument);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> IntegerArgumentMarshaler)
            m.set(currentArgument);
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        <span class="hljs-keyword">throw</span> e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
---
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">stringValue</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">try</span> {
            stringValue = currentArgument.next();
        } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
            errorCode = ErrorCode.MISSING_STRING;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> {}
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stringValue;
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">intValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            parameter = currentArgument.next();
            set(parameter);
        } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
            errorCode = ErrorCode.MISSING_INTEGER;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            errorParameter = parameter;
            errorCode = ErrorCode.INVALID_INTEGER;
            <span class="hljs-keyword">throw</span> e;
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String s)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">try</span> {
            intValue = Integer.parseInt(s);
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        }
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> intValue;
    }
}
</code></pre>
<div dir="rtl">
و حالا ضربه نهایی: می‌توانیم نوع‌سازی را حذف کنیم! تبریک!
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
    <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
    <span class="hljs-keyword">if</span> (m == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">try</span> {
        m.set(currentArgument);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> (ArgsException e) {
        valid = <span class="hljs-literal">false</span>;
        errorArgumentId = argChar;
        <span class="hljs-keyword">throw</span> e;
    }
}
</code></pre>
<div dir="rtl">
<p>حالا می‌توانیم برخی از توابع اضافی در <code>IntegerArgumentMarshaler</code> را حذف کرده و کمی آن را تمیز کنیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">intValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span>
        <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            parameter = currentArgument.next();
            intValue = Integer.parseInt(parameter);
        } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
            errorCode = ErrorCode.MISSING_INTEGER;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            errorParameter = parameter;
            errorCode = ErrorCode.INVALID_INTEGER;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        }
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> intValue;
    }
}
</code></pre>
<div dir="rtl">
<p>ما همچنین می‌توانیم <code>ArgumentMarshaler</code> را به یک اینترفیس تبدیل کنیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException;
    Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span>;
}
</code></pre>
<div dir="rtl">
<p>حال ببینیم اضافه کردن یک نوع آرگومان جدید به ساختارمان چقدر آسان است. این کار باید تغییرات بسیار کمی را نیاز داشته باشد و این تغییرات باید مجزا باشند. ابتدا با افزودن یک تست جدید شروع می‌کنیم تا بررسی کنیم که آرگومان نوع <code>double</code> به درستی کار می‌کند.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSimpleDoublePresent</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x##&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>,<span class="hljs-string">&quot;42.3&quot;</span>});
    assertTrue(args.isValid());
    assertEquals(<span class="hljs-number">1</span>, args.cardinality());
    assertTrue(args.has(<span class="hljs-string">&#x27;x&#x27;</span>));
    assertEquals(<span class="hljs-number">42.3</span>, args.getDouble(<span class="hljs-string">&#x27;x&#x27;</span>), <span class="hljs-number">.001</span>);
}
</code></pre>
<div dir="rtl">
<p>حالا کد تجزیه اسکیمای خود را تمیز می‌کنیم و تشخیص <code>##</code> برای نوع آرگومان <code>double</code> را اضافه می‌کنیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSchemaElement</span><span class="hljs-params">(String element)</span> <span class="hljs-keyword">throws</span> ParseException {
    <span class="hljs-type">char</span> <span class="hljs-variable">elementId</span> <span class="hljs-operator">=</span> element.charAt(<span class="hljs-number">0</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">elementTail</span> <span class="hljs-operator">=</span> element.substring(<span class="hljs-number">1</span>);
    validateSchemaElementId(elementId);
    <span class="hljs-keyword">if</span> (elementTail.length() == <span class="hljs-number">0</span>)
        marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span>());
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals(<span class="hljs-string">&quot;*&quot;</span>))
        marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArgumentMarshaler</span>());
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals(<span class="hljs-string">&quot;#&quot;</span>))
        marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span>());
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals(<span class="hljs-string">&quot;##&quot;</span>))
        marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleArgumentMarshaler</span>());
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseException</span>(
            String.format(
                <span class="hljs-string">&quot;Argument: %c has invalid format: %s.&quot;</span>, elementId, elementTail),
            <span class="hljs-number">0</span>);
}
</code></pre>
<div dir="rtl">
<p>سپس کلاس <code>DoubleArgumentMarshaler</code> را مینویسیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoubleArgumentMarshaler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-variable">doubleValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            parameter = currentArgument.next();
            doubleValue = Double.parseDouble(parameter);
        } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
            errorCode = ErrorCode.MISSING_DOUBLE;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            errorParameter = parameter;
            errorCode = ErrorCode.INVALID_DOUBLE;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
        }
    }
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> doubleValue;
    }
}
</code></pre>
<div dir="rtl">
<p>این ما را مجبور می‌کند تا یک <code>ErrorCode</code> جدید اضافه کنیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">private</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
    OK,
    MISSING_STRING,
    MISSING_INTEGER,
    INVALID_INTEGER,
    UNEXPECTED_ARGUMENT,

    MISSING_DOUBLE,
    INVALID_DOUBLE
}
</code></pre>
<div dir="rtl">
<p>و ما نیاز به متد <code>getDouble</code> داریم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getDouble</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
    Args.<span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : (Double) am.get();
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
    }
}
</code></pre>
<div dir="rtl">
<p>و همه تست‌ها موفقیت‌آمیز بودند! این کار نسبتاً بی‌دردسر بود. حالا بیایید مطمئن شویم که پردازش خطا به درستی کار می‌کند. تست بعدی بررسی می‌کند که آیا در صورتی که یک رشته غیرقابل تجزیه به یک آرگومان <code>##</code> داده شود، خطا اعلام می‌شود یا خیر.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInvalidDouble</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x##&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>, <span class="hljs-string">&quot;Forty two&quot;</span>});
    assertFalse(args.isValid());
    assertEquals(<span class="hljs-number">0</span>, args.cardinality());
    assertFalse(args.has(<span class="hljs-string">&#x27;x&#x27;</span>));
    assertEquals(<span class="hljs-number">0</span>, args.getInt(<span class="hljs-string">&#x27;x&#x27;</span>));
    assertEquals(<span class="hljs-string">&quot;Argument -x expects a double but was &#x27;Forty two&#x27;.&quot;</span>,
        args.errorMessage());
}
-- -<span class="hljs-keyword">public</span> String <span class="hljs-title function_">errorMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-keyword">switch</span> (errorCode) {
        <span class="hljs-keyword">case</span> OK:
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;TILT: Should not get here.&quot;</span>);
        <span class="hljs-keyword">case</span> UNEXPECTED_ARGUMENT:
            <span class="hljs-keyword">return</span> unexpectedArgumentMessage();
        <span class="hljs-keyword">case</span> MISSING_STRING:
            <span class="hljs-keyword">return</span> String.format(
                <span class="hljs-string">&quot;Could not find string parameter for -%c.&quot;</span>, errorArgumentId);
        <span class="hljs-keyword">case</span> INVALID_INTEGER:
            <span class="hljs-keyword">return</span> String.format(
                <span class="hljs-string">&quot;Argument -%c expects an integer but was &#x27;%s&#x27;.&quot;</span>,
                errorArgumentId, errorParameter);
        <span class="hljs-keyword">case</span> MISSING_INTEGER:
            <span class="hljs-keyword">return</span> String.format(
                <span class="hljs-string">&quot;Could not find integer parameter for -%c.&quot;</span>, errorArgumentId);
        <span class="hljs-keyword">case</span> INVALID_DOUBLE:
            <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;Argument -%c expects a double but was &#x27;%s&#x27;.&quot;</span>,
                errorArgumentId, errorParameter);
        <span class="hljs-keyword">case</span> MISSING_DOUBLE:
            <span class="hljs-keyword">return</span> String.format(
                <span class="hljs-string">&quot;Could not find double parameter for -%c.&quot;</span>, errorArgumentId);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
}
</code></pre>
<div dir="rtl">
<p>و تست‌ها موفقیت‌آمیز بودند. تست بعدی بررسی می‌کند که آیا آرگومان <code>double</code> گم‌شده به‌درستی تشخیص داده می‌شود</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMissingDouble</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x##&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>});
    assertFalse(args.isValid());
    assertEquals(<span class="hljs-number">0</span>, args.cardinality());
    assertFalse(args.has(<span class="hljs-string">&#x27;x&#x27;</span>));
    assertEquals(<span class="hljs-number">0.0</span>, args.getDouble(<span class="hljs-string">&#x27;x&#x27;</span>), <span class="hljs-number">0.01</span>);
    assertEquals(
        <span class="hljs-string">&quot;Could not find double parameter for -x.&quot;</span>, args.errorMessage());
}
</code></pre>
<div dir="rtl">
<p>این تست همان‌طور که انتظار داشتیم موفقیت‌آمیز بود. ما آن را صرفاً برای تکمیل کار نوشتیم.<br>
کد مربوط به استثنا کمی نامرتب است و واقعاً در کلاس <code>Args</code> جایگاهی ندارد. همچنین ما <code>ParseException</code> را پرتاب می‌کنیم، در حالی که این استثنا به ما تعلق ندارد. بنابراین، بیایید تمام استثناها را در یک کلاس واحد به نام <code>ArgsException</code> ترکیب کنیم و آن را به یک ماژول اختصاصی منتقل کنیم.</p>
</div>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgsException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-variable">errorArgumentId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\0&#x27;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorParameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TILT&quot;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> ErrorCode.OK;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span><span class="hljs-params">()</span> {}
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(message);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
        OK,
        MISSING_STRING,
        MISSING_INTEGER,
        INVALID_INTEGER,
        UNEXPECTED_ARGUMENT,
        MISSING_DOUBLE,
        INVALID_DOUBLE
    }
}
-- -<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span> {
    ... <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-variable">errorArgumentId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\0&#x27;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorParameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TILT&quot;</span>;
    <span class="hljs-keyword">private</span> ArgsException.<span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> ArgsException.ErrorCode.OK;
    <span class="hljs-keyword">private</span> List&lt;String&gt; argsList;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Args</span><span class="hljs-params">(String schema, String[] args)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-built_in">this</span>.schema = schema;
        argsList = Arrays.asList(args);
        valid = parse();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">if</span> (schema.length() == <span class="hljs-number">0</span> &amp;&amp; argsList.size() == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        parseSchema();
        <span class="hljs-keyword">try</span> {
            parseArguments();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
        }
        <span class="hljs-keyword">return</span> valid;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parseSchema</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ArgsException {
        ...
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSchemaElement</span><span class="hljs-params">(String element)</span> <span class="hljs-keyword">throws</span> ArgsException {
        ... <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(String.format(
            <span class="hljs-string">&quot;Argument: %c has invalid format: %s.&quot;</span>, elementId, elementTail));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateSchemaElementId</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">if</span> (!Character.isLetter(elementId)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
                <span class="hljs-string">&quot;Bad character:&quot;</span> + elementId + <span class="hljs-string">&quot;in Args format: &quot;</span> + schema);
        }
    }
    ... <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseElement</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">if</span> (setArgument(argChar))
            argsFound.add(argChar);
        <span class="hljs-keyword">else</span> {
            unexpectedArguments.add(argChar);
            errorCode = ArgsException.ErrorCode.UNEXPECTED_ARGUMENT;
            valid = <span class="hljs-literal">false</span>;
        }
    }
    ... <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringArgumentMarshaler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">stringValue</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {
            <span class="hljs-keyword">try</span> {
                stringValue = currentArgument.next();
            } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
                errorCode = ArgsException.ErrorCode.MISSING_STRING;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
            }
        }
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> stringValue;
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">intValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {
            <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">try</span> {
                parameter = currentArgument.next();
                intValue = Integer.parseInt(parameter);
            } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
                errorCode = ArgsException.ErrorCode.MISSING_INTEGER;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
            } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
                errorParameter = parameter;
                errorCode = ArgsException.ErrorCode.INVALID_INTEGER;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
            }
        }
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> intValue;
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoubleArgumentMarshaler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ArgumentMarshaler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-variable">doubleValue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(Iterator&lt;String&gt; currentArgument)</span> <span class="hljs-keyword">throws</span> ArgsException {
            <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">try</span> {
                parameter = currentArgument.next();
                doubleValue = Double.parseDouble(parameter);
            } <span class="hljs-keyword">catch</span> (NoSuchElementException e) {
                errorCode = ArgsException.ErrorCode.MISSING_DOUBLE;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
            } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
                errorParameter = parameter;
                errorCode = ArgsException.ErrorCode.INVALID_DOUBLE;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>();
            }
        }
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> doubleValue;
        }
    }
}
</code></pre>
<div dir="rtl">
<p>این عالی است! اکنون تنها استثنایی که توسط <code>Args</code> پرتاب می‌شود، <code>ArgsException</code> است. انتقال <code>ArgsException</code> به یک ماژول اختصاصی به ما این امکان را می‌دهد که بسیاری از کدهای پراکنده مربوط به مدیریت خطا را در آن ماژول جای دهیم و <code>Args</code> را از این موارد جدا کنیم.<br>
این کار نه‌تنها مکانی طبیعی و مناسب برای نگهداری این کدها فراهم می‌کند، بلکه باعث مرتب‌تر شدن ماژول <code>Args</code> در آینده می‌شود.<br>
اکنون ما به‌طور کامل کدهای مربوط به مدیریت خطا و استثنا را از ماژول <code>Args</code> تفکیک کرده‌ایم. (به فهرست 14-13 تا 14-16 مراجعه کنید.) این تغییرات طی حدود 30 گام کوچک انجام شده‌اند، در حالی که تمامی تست‌ها در هر مرحله موفقیت‌آمیز باقی مانده‌اند.</p>
</div>
<p>Listing 14-13 - ArgsTest.java</p>
<pre class="hljs"><code><span class="hljs-keyword">package</span> com.objectmentor.utilities.args;
<span class="hljs-keyword">import</span> junit.framework.TestCase;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgsTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TestCase</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateWithNoSchemaOrArguments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);
        assertEquals(<span class="hljs-number">0</span>, args.cardinality());
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWithNoSchemaButWithOneArgument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>});
            fail();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(
                ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;x&#x27;</span>, e.getErrorArgumentId());
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWithNoSchemaButWithMultipleArguments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>, <span class="hljs-string">&quot;-y&quot;</span>});
            fail();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(
                ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;x&#x27;</span>, e.getErrorArgumentId());
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNonLetterSchema</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;*&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {});
            fail(<span class="hljs-string">&quot;Args constructor should have thrown exception&quot;</span>);
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(ArgsException.ErrorCode.INVALID_ARGUMENT_NAME,
                e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;*&#x27;</span>, e.getErrorArgumentId());
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInvalidArgumentFormat</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;f~&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {});
            fail(<span class="hljs-string">&quot;Args constructor should have throws exception&quot;</span>);
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(
                ArgsException.ErrorCode.INVALID_FORMAT, e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;f&#x27;</span>, e.getErrorArgumentId());
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSimpleBooleanPresent</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>});
        assertEquals(<span class="hljs-number">1</span>, args.cardinality());
        assertEquals(<span class="hljs-literal">true</span>, args.getBoolean(<span class="hljs-string">&#x27;x&#x27;</span>));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSimpleStringPresent</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x*&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>, <span class="hljs-string">&quot;param&quot;</span>});
        assertEquals(<span class="hljs-number">1</span>, args.cardinality());
        assertTrue(args.has(<span class="hljs-string">&#x27;x&#x27;</span>));
        assertEquals(<span class="hljs-string">&quot;param&quot;</span>, args.getString(<span class="hljs-string">&#x27;x&#x27;</span>));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMissingStringArgument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x*&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>});
            fail();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(
                ArgsException.ErrorCode.MISSING_STRING, e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;x&#x27;</span>, e.getErrorArgumentId());
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSpacesInFormat</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x, y&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-xy&quot;</span>});
        assertEquals(<span class="hljs-number">2</span>, args.cardinality());
        assertTrue(args.has(<span class="hljs-string">&#x27;x&#x27;</span>));
        assertTrue(args.has(<span class="hljs-string">&#x27;y&#x27;</span>));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSimpleIntPresent</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x#&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>, <span class="hljs-string">&quot;42&quot;</span>});
        assertEquals(<span class="hljs-number">1</span>, args.cardinality());
        assertTrue(args.has(<span class="hljs-string">&#x27;x&#x27;</span>));
        assertEquals(<span class="hljs-number">42</span>, args.getInt(<span class="hljs-string">&#x27;x&#x27;</span>));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInvalidInteger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x#&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>, <span class="hljs-string">&quot;Forty two&quot;</span>});
            fail();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(
                ArgsException.ErrorCode.INVALID_INTEGER, e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;x&#x27;</span>, e.getErrorArgumentId());
            assertEquals(<span class="hljs-string">&quot;Forty two&quot;</span>, e.getErrorParameter());
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMissingInteger</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x#&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>});
            fail();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(
                ArgsException.ErrorCode.MISSING_INTEGER, e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;x&#x27;</span>, e.getErrorArgumentId());
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSimpleDoublePresent</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Args</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x##&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>, <span class="hljs-string">&quot;42.3&quot;</span>});
        assertEquals(<span class="hljs-number">1</span>, args.cardinality());
        assertTrue(args.has(<span class="hljs-string">&#x27;x&#x27;</span>));
        assertEquals(<span class="hljs-number">42.3</span>, args.getDouble(<span class="hljs-string">&#x27;x&#x27;</span>), <span class="hljs-number">.001</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInvalidDouble</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x##&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>, <span class="hljs-string">&quot;Forty two&quot;</span>});
            fail();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(
                ArgsException.ErrorCode.INVALID_DOUBLE, e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;x&#x27;</span>, e.getErrorArgumentId());
            assertEquals(<span class="hljs-string">&quot;Forty two&quot;</span>, e.getErrorParameter());
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMissingDouble</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Args</span>(<span class="hljs-string">&quot;x##&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">&quot;-x&quot;</span>});
            fail();
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            assertEquals(
                ArgsException.ErrorCode.MISSING_DOUBLE, e.getErrorCode());
            assertEquals(<span class="hljs-string">&#x27;x&#x27;</span>, e.getErrorArgumentId());
        }
    }
}
</code></pre>
<p>Listing 14-14 - ArgsExceptionTest.java</p>
<pre class="hljs"><code>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgsExceptionTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TestCase</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUnexpectedMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ArgsException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
            ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-literal">null</span>);
        assertEquals(<span class="hljs-string">&quot;Argument -x unexpected.&quot;</span>, e.errorMessage());
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMissingStringMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ArgsException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
            ArgsException.ErrorCode.MISSING_STRING, <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-literal">null</span>);
        assertEquals(
            <span class="hljs-string">&quot;Could not find string parameter for -x.&quot;</span>, e.errorMessage());
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInvalidIntegerMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ArgsException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
            ArgsException.ErrorCode.INVALID_INTEGER, <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-string">&quot;Forty two&quot;</span>);
        assertEquals(<span class="hljs-string">&quot;Argument -x expects an integer but was &#x27;Forty two&#x27;.&quot;</span>,
            e.errorMessage());
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMissingIntegerMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ArgsException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
            ArgsException.ErrorCode.MISSING_INTEGER, <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-literal">null</span>);
        assertEquals(
            <span class="hljs-string">&quot;Could not find integer parameter for -x.&quot;</span>, e.errorMessage());
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInvalidDoubleMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ArgsException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
            ArgsException.ErrorCode.INVALID_DOUBLE, <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-string">&quot;Forty two&quot;</span>);
        assertEquals(<span class="hljs-string">&quot;Argument -x expects a double but was &#x27;Forty two&#x27;.&quot;</span>,
            e.errorMessage());
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMissingDoubleMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ArgsException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
            ArgsException.ErrorCode.MISSING_DOUBLE, <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-literal">null</span>);
        assertEquals(
            <span class="hljs-string">&quot;Could not find double parameter for -x.&quot;</span>, e.errorMessage());
    }
}

</code></pre>
<p>Listing 14-15 - ArgsException.java</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArgsException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span> <span class="hljs-variable">errorArgumentId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;\0&#x27;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">errorParameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;TILT&quot;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">ErrorCode</span> <span class="hljs-variable">errorCode</span> <span class="hljs-operator">=</span> ErrorCode.OK;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span><span class="hljs-params">()</span> {}
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(message);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span><span class="hljs-params">(ErrorCode errorCode)</span> {
        <span class="hljs-built_in">this</span>.errorCode = errorCode;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span><span class="hljs-params">(ErrorCode errorCode, String errorParameter)</span> {
        <span class="hljs-built_in">this</span>.errorCode = errorCode;
        <span class="hljs-built_in">this</span>.errorParameter = errorParameter;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ArgsException</span><span class="hljs-params">(
        ErrorCode errorCode, <span class="hljs-type">char</span> errorArgumentId, String errorParameter)</span> {
        <span class="hljs-built_in">this</span>.errorCode = errorCode;
        <span class="hljs-built_in">this</span>.errorParameter = errorParameter;
        <span class="hljs-built_in">this</span>.errorArgumentId = errorArgumentId;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">char</span> <span class="hljs-title function_">getErrorArgumentId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> errorArgumentId;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setErrorArgumentId</span><span class="hljs-params">(<span class="hljs-type">char</span> errorArgumentId)</span> {
        <span class="hljs-built_in">this</span>.errorArgumentId = errorArgumentId;
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getErrorParameter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> errorParameter;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setErrorParameter</span><span class="hljs-params">(String errorParameter)</span> {
        <span class="hljs-built_in">this</span>.errorParameter = errorParameter;
    }
    <span class="hljs-keyword">public</span> ErrorCode <span class="hljs-title function_">getErrorCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> errorCode;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setErrorCode</span><span class="hljs-params">(ErrorCode errorCode)</span> {
        <span class="hljs-built_in">this</span>.errorCode = errorCode;
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">errorMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">switch</span> (errorCode) {
            <span class="hljs-keyword">case</span> OK:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;TILT: Should not get here.&quot;</span>);
            <span class="hljs-keyword">case</span> UNEXPECTED_ARGUMENT:
                <span class="hljs-keyword">return</span> String.format(
                    <span class="hljs-string">&quot;Argument -%c unexpected.&quot;</span>, errorArgumentId);
            <span class="hljs-keyword">case</span> MISSING_STRING:
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;Could not find string parameter for -%c.&quot;</span>,
                    errorArgumentId);
            <span class="hljs-keyword">case</span> INVALID_INTEGER:
                <span class="hljs-keyword">return</span> String.format(
                    <span class="hljs-string">&quot;Argument -%c expects an integer but was &#x27;%s&#x27;.&quot;</span>,
                    errorArgumentId, errorParameter);
            <span class="hljs-keyword">case</span> MISSING_INTEGER:
                <span class="hljs-keyword">return</span> String.format(
                    <span class="hljs-string">&quot;Could not find integer parameter for -%c.&quot;</span>,
                    errorArgumentId);
            <span class="hljs-keyword">case</span> INVALID_DOUBLE:
                <span class="hljs-keyword">return</span> String.format(
                    <span class="hljs-string">&quot;Argument -%c expects a double but was &#x27;%s&#x27;.&quot;</span>,
                    errorArgumentId, errorParameter);
            <span class="hljs-keyword">case</span> MISSING_DOUBLE:
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">&quot;Could not find double parameter for -%c.&quot;</span>,
                    errorArgumentId);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
        OK,
        INVALID_FORMAT,
        UNEXPECTED_ARGUMENT,
        INVALID_ARGUMENT_NAME,
        MISSING_STRING,
        MISSING_INTEGER,
        INVALID_INTEGER,
        MISSING_DOUBLE,
        INVALID_DOUBLE
    }
}
</code></pre>
<p>Listing 14-16 - Args.java</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Args</span> {
    <span class="hljs-keyword">private</span> String schema;
    <span class="hljs-keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, ArgumentMarshaler&gt;();
    <span class="hljs-keyword">private</span> Set&lt;Character&gt; argsFound = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Character&gt;();
    <span class="hljs-keyword">private</span> Iterator&lt;String&gt; currentArgument;
    <span class="hljs-keyword">private</span> List&lt;String&gt; argsList;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Args</span><span class="hljs-params">(String schema, String[] args)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-built_in">this</span>.schema = schema;
        argsList = Arrays.asList(args);
        parse();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ArgsException {
        parseSchema();
        parseArguments();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">parseSchema</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">for</span> (String element : schema.split(<span class="hljs-string">&quot;,&quot;</span>)) {
            <span class="hljs-keyword">if</span> (element.length() &gt; <span class="hljs-number">0</span>) {
                parseSchemaElement(element.trim());
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSchemaElement</span><span class="hljs-params">(String element)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-type">char</span> <span class="hljs-variable">elementId</span> <span class="hljs-operator">=</span> element.charAt(<span class="hljs-number">0</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">elementTail</span> <span class="hljs-operator">=</span> element.substring(<span class="hljs-number">1</span>);
        validateSchemaElementId(elementId);
        <span class="hljs-keyword">if</span> (elementTail.length() == <span class="hljs-number">0</span>)
            marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanArgumentMarshaler</span>());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals(<span class="hljs-string">&quot;*&quot;</span>))
            marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringArgumentMarshaler</span>());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals(<span class="hljs-string">&quot;#&quot;</span>))
            marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerArgumentMarshaler</span>());
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (elementTail.equals(<span class="hljs-string">&quot;##&quot;</span>))
            marshalers.put(elementId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleArgumentMarshaler</span>());
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
                ArgsException.ErrorCode.INVALID_FORMAT, elementId, elementTail);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateSchemaElementId</span><span class="hljs-params">(<span class="hljs-type">char</span> elementId)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">if</span> (!Character.isLetter(elementId)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
                ArgsException.ErrorCode.INVALID_ARGUMENT_NAME, elementId, <span class="hljs-literal">null</span>);
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseArguments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">for</span> (currentArgument = argsList.iterator();
             currentArgument.hasNext();) {
            <span class="hljs-type">String</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> currentArgument.next();
            parseArgument(arg);
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseArgument</span><span class="hljs-params">(String arg)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">if</span> (arg.startsWith(<span class="hljs-string">&quot;-&quot;</span>))
            parseElements(arg);
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseElements</span><span class="hljs-params">(String arg)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; arg.length(); i++) parseElement(arg.charAt(i));
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseElement</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-keyword">if</span> (setArgument(argChar))
            argsFound.add(argChar);
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArgsException</span>(
                ArgsException.ErrorCode.UNEXPECTED_ARGUMENT, argChar, <span class="hljs-literal">null</span>);
        }
    }
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setArgument</span><span class="hljs-params">(<span class="hljs-type">char</span> argChar)</span> <span class="hljs-keyword">throws</span> ArgsException {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> marshalers.get(argChar);
        <span class="hljs-keyword">if</span> (m == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            m.set(currentArgument);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (ArgsException e) {
            e.setErrorArgumentId(argChar);
            <span class="hljs-keyword">throw</span> e;
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cardinality</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> argsFound.size();
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">usage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (schema.length() &gt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;-[&quot;</span> + schema + <span class="hljs-string">&quot;]&quot;</span>;
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getBoolean</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            b = am != <span class="hljs-literal">null</span> &amp;&amp; (Boolean) am.get();
        } <span class="hljs-keyword">catch</span> (ClassCastException e) {
            b = <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> b;
    }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getString</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : (String) am.get();
        } <span class="hljs-keyword">catch</span> (ClassCastException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getInt</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : (Integer) am.get();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getDouble</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        <span class="hljs-type">ArgumentMarshaler</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> marshalers.get(arg);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> am == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : (Double) am.get();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
        }
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">has</span><span class="hljs-params">(<span class="hljs-type">char</span> arg)</span> {
        <span class="hljs-keyword">return</span> argsFound.contains(arg);
    }
}
</code></pre>
<div dir="rtl">
<p>کلاس <code>Args</code> بیشتر تغییراتش مربوط به حذف بخش‌هایی از کد بود. بخش زیادی از کد فقط از داخل <code>Args</code> منتقل شد و به <code>ArgsException</code> اضافه گردید. عالی است! همچنین تمام <code>ArgumentMarshallerها</code> به فایل‌های جداگانه منتقل شدند. خیلی بهتر!</p>
<p>بخش زیادی از طراحی خوب نرم‌افزار، در واقع در مورد بخش‌بندی است—ایجاد مکان‌های مناسب برای قرار دادن انواع مختلف کد. این تفکیک مسئولیت‌ها باعث می‌شود کد بسیار ساده‌تر قابل فهم و نگهداری باشد.</p>
<p>نکته جالب توجه، متد <code>errorMessage</code> در <code>ArgsException</code> است. به وضوح، قرار دادن کد فرمت کردن پیام خطا در داخل <code>Args</code> نقض اصل <code>SRP</code> بود. <code>Args</code> باید در مورد پردازش آرگومان‌ها باشد، نه فرمت پیام‌های خطا. اما آیا واقعاً منطقی است که کد فرمت پیام خطا را در داخل <code>ArgsException</code> قرار دهیم؟ به طور صریح، این یک مصالحه است. کاربرانی که از پیام‌های خطا که توسط <code>ArgsException</code> فراهم شده است راضی نیستند، باید پیام‌های خطای خودشان را بنویسند. اما راحتی در داشتن پیام‌های خطای آماده، بی‌اهمیت نیست.</p>
<p>تا به حال باید واضح شده باشد که ما تقریباً به راه‌حل نهایی که در ابتدای این فصل آورده شده، نزدیک شده‌ایم. من باقی‌مانده تغییرات را به شما می‌سپارم تا به عنوان تمرین انجام دهید.</p>
<h2>نتیجه‌گیری</h2>
<p>کافی نیست که کد کار کند. کد کارا اغلب به شدت خراب است. برنامه‌نویس‌هایی که فقط به کارکردن کد اکتفا می‌کنند، به طور غیرحرفه‌ای عمل می‌کنند. آن‌ها ممکن است بترسند که وقت کافی برای بهبود ساختار و طراحی کد خود نداشته باشند، اما من با این نظر مخالفم. هیچ چیز به اندازه کد بد تأثیر مخرب و بلندمدتی بر روی یک پروژه توسعه نمی‌گذارد. برنامه‌نویسی که فقط به کد کارا اکتفا کند، در نهایت به یک کد خراب تبدیل می‌شود که بر پروژه تسلط پیدا می‌کند.</p>
<p>البته که کد بد قابل تمیز کردن است، اما این کار بسیار پرهزینه است. وقتی کد خراب می‌شود، ماژول‌ها به هم می‌پیوندند و وابستگی‌های پنهان و درهم‌تنیده‌ای ایجاد می‌کنند. پیدا کردن و شکستن این وابستگی‌های قدیمی کار زمان‌بر و سختی است. از طرف دیگر، نگهداری کد تمیز نسبتاً راحت است. اگر صبح یک ماژول را خراب کردید، می‌توانید بعدازظهر آن را تمیز کنید. بهتر از آن، اگر پنج دقیقه پیش یک ماژول را خراب کرده‌اید، بسیار آسان است که همین الان آن را تمیز کنید.</p>
<p>بنابراین راه‌حل این است که کد خود را به طور مداوم تمیز و ساده نگه دارید. هرگز اجازه ندهید که فساد کد آغاز شود.</p>
</div>

  </main>

  <!-- فوتر مشترک -->
  <footer class="footer">
    <div class="container">
      <p>
        <img src="/Gitab/icone/copyright.svg" alt="کپی‌رایت" width="14" height="14"
             style="vertical-align:middle;margin-inline:4px">
        <span id="y"></span> Gitab — برای توسعه‌دهندگان
      </p>
    </div>
  </footer>

  <!-- سال و اسکریپت تغییر تم -->
  <script>
  (() => {
    const root = document.documentElement;
    const btn = document.getElementById('themeToggle');
    const KEY = 'gitab-theme';
    const media = window.matchMedia('(prefers-color-scheme: dark)');
    const getEffective = s => (s === 'auto' ? (media.matches ? 'dark' : 'light') : s);

    function updateTheme(s) {
      root.setAttribute('data-theme', s);
      const mode = getEffective(s);
      root.dataset.colorMode = mode;
      btn.dataset.icon = mode === 'dark' ? 'moon' : 'sun';
    }

    let saved = localStorage.getItem(KEY) || 'auto';
    updateTheme(saved);

    btn.addEventListener('click', () => {
      const current = localStorage.getItem(KEY) || 'auto';
      const next = current === 'auto' ? 'dark' : current === 'dark' ? 'light' : 'auto';
      localStorage.setItem(KEY, next);
      updateTheme(next);
    });

    media.addEventListener('change', () => {
      if ((localStorage.getItem(KEY) || 'auto') === 'auto') updateTheme('auto');
    });

    document.addEventListener('DOMContentLoaded', () => {
      updateTheme(localStorage.getItem(KEY) || 'auto');
    });
  })();
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>

  <script>
  document.querySelectorAll('pre code').forEach(block => {
    const btn = document.createElement('button');
    btn.className = 'copy-btn';

    const icon = document.createElement('img');
    icon.src = "/Gitab/icone/copy.svg";
    icon.alt = 'Copy';
    btn.appendChild(icon);

    block.parentNode.insertBefore(btn, block);

    btn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(block.textContent);
      btn.classList.add('copied');
      setTimeout(() => btn.classList.remove('copied'), 1500);
    });
  });
  </script>

  <script>
  document.body.dataset.page = window.location.pathname;

  const menuBtn = document.querySelector(".menu-toggle");
  const nav = document.querySelector(".nav");

  if (menuBtn && nav) {
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      nav.classList.toggle("show");
    });

    document.addEventListener("click", (e) => {
      const clickedInsideNav = nav.contains(e.target);
      const clickedMenuButton = menuBtn.contains(e.target);
      if (!clickedInsideNav && !clickedMenuButton) {
        nav.classList.remove("show");
      }
    });
  }
  </script>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>
</body>
</html>
