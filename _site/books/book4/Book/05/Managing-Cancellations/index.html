<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cancellations</title>
  <meta name="description" content="ุชุฑุฌููโูุง ูุงุฑุณ ฺฉุชุงุจโูุง ูู โ ุณุฑุนุ ูููุงู ู ูุงุจู ุงุชฺฉุง.">
  <link rel="stylesheet" href="/styles/main.css">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
@font-face {
  font-family: 'Vazir';
  src: url('/fonts/Vazir-FD-WOL.ttf') format('truetype');
  font-display: swap;
}
body {
  font-family: 'Vazir', sans-serif;
}
</style>

</head>
<body>
  <!-- ูุฏุฑ ูุดุชุฑฺฉ -->
  <header class="header">
    <div class="container nav-wrap">
      <a class="brand" href="/">
        <img src="/icone/logo.svg" alt="Gitab" width="28" height="28">
        <span>Gitab</span>
      </a>

      <nav class="nav">
        <a href="/">ุฎุงูู</a>
        <a href="/books/list-books">ฺฉุชุงุจโูุง</a>
        <a href="#">ูุชุฑุฌู ูุง</a>
        <a href="#">ููฺฉุงุฑ</a>
        <a href="#">ุฏุฑุจุงุฑูโูุง</a>
      </nav>

     <div class="nav-actions">
  <button id="themeToggle" class="icon-btn theme-btn" aria-label="ุชุบุฑ ุญุงูุช">
    <img class="icon-sun" src="/icone/sun.svg" alt="ุฑูุดู">
    <img class="icon-moon" src="/icone/moon.svg" alt="ุชุงุฑฺฉ">
  </button>

  <a class="icon-btn" href="https://github.com/hheydarian/Gitab" target="_blank" title="GitHub">
    <img src="/icone/github.svg" alt="GitHub">
  </a>
</div>

  </header>


<main class="site-main book-page ">
  <h1>ูุตู ูพูุฌู: ๐ <strong>ูุฏุฑุช ูุบู ุนููุงุช (Cancellations)</strong></h1>
<p>ูุบู ุนููุงุช ฺฉ ูฺฉุงูุฒู ุญุงุช ุฏุฑ ุจุฑูุงููโููุณ ุจุง ุชุณฺฉโูุง ุงุณุช. ุงู ูฺฺฏ ุฏุฑ ููุงุฑุฏ ุฒุฑ ุจุณุงุฑ ููุฏ ุงุณุช:<br>
โข ูุชููู ฺฉุฑุฏู ฺฉ ุชุณฺฉ ุฏุฑ ุญุงู ุงุฌุฑุง ุจูโุทูุฑ ุงูู ููุช ุฏฺฏุฑ ููุฑุฏ ูุงุฒ ูุณุช โน๏ธ<br>
โข ุขุฒุงุฏุณุงุฒ ููุงุจุน ุญุงุช ๐๏ธ<br>
โข ุจูุจูุฏ ูพุงุณุฎโุฏู ุจุฑูุงูู โก</p>
<p>ุจู ููู ุฏููุ ฺฉ ุชุณฺฉ ุทููุงูโูุฏุช ููฺฉู ุงุณุช ุจูโุทูุฑ ูุฑุชุจ ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง ุฏุฑุฎูุงุณุช ูุบู ุงุฑุณุงู ุดุฏู ุงุณุช ุง ุฎุฑ. ุงฺฏุฑ ฺูู ุฏุฑุฎูุงุณุช ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ุชุณฺฉ ุจุงุฏ ูุทุงุจู ุจุง ุขู ูุงฺฉูุด ูุดุงู ุฏูุฏ.</p>
<p>ุจุง ุงู ุญุงูุ ุฏุงุดุชู ูุงุจูุช ูุบู ุชุณฺฉ ุจู ุงู ูุนูุง ูุณุช ฺฉู ุจุงุฏ ุชุณฺฉ ุฑุง ุจูโุทูุฑ ูุงฺฏูุงู ูุชููู ฺฉูุฏุ ุฒุฑุง ุงู ฺฉุงุฑ ูโุชูุงูุฏ ุจุฑูุงูู ุฑุง ุฏุฑ ูุถุนุช ูุงูพุงุฏุงุฑ ูุฑุงุฑ ุฏูุฏ. ุฏุฑ ุนูุถุ ุดูุง ฺฉ ูุฏู <strong>ููฺฉุงุฑโฺฉููุฏู (cooperative)</strong> ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู ุฏุฑ ุขู ุชุณฺฉ ู ฺฉุฏ ฺฉู ูุบู ุฑุง ุขุบุงุฒ ูโฺฉูุฏ ูโุชูุงููุฏ ุจุง ูู ฺฉุงุฑ ฺฉููุฏ.</p>
<p>ุงู ูุตู ุจู ุจุฑุฑุณ ุงู ููุถูุน ูโูพุฑุฏุงุฒุฏ.</p>
<p>ูพุดโูุงุฒูุง ๐</p>
<p>ุจุฑุง ูุฏุฑุช ูุบู ุชุณฺฉโูุง ุฏุฑ C#ุ ุจุงุฏ ุจุง ููุงุฑุฏ ุฒุฑ ุขุดูุง ุจุงุดุฏ:</p>
<p>โข <strong>CancellationTokenSource</strong>: ุงู ฺฉูุงุณ ูุณุฆูู <strong>ุงุนูุงู ุฏุฑุฎูุงุณุช ูุบู</strong> ุงุณุช. ุงู ฺฉูุงุณ ฺฉ <strong>CancellationToken</strong> ุชููุฏ ูโฺฉูุฏ ฺฉู ุจู ุชุณฺฉ ุฏุงุฏู ูโุดูุฏ ุชุง ูุถุนุช ุฏุฑุฎูุงุณุช ูุบู ุฑุง ุจุฑุฑุณ ฺฉูุฏ. โณ</p>
<p>โข <strong>CancellationToken</strong>: ุงู ฺฉ ุณุงุฎุชุงุฑ (struct) ุงุณุช ฺฉู ุจู ุชุณฺฉ ุฏุงุฏู ูโุดูุฏ ู ุฑุงู ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ุขุง ูุบู ุฏุฑุฎูุงุณุช ุดุฏู ูุฌูุฏ ุฏุงุฑุฏ ุง ุฎุฑ ูุฑุงูู ูโฺฉูุฏ. ุงู ุชูฺฉู ุจุฑุง <strong>ุงูุชุดุงุฑ ุงุทูุงุนู ูุบู ุชุณฺฉ</strong> ุงุณุชูุงุฏู ูโุดูุฏ.</p>
<p>ุจุงุฏ ุจุจูู ฺฺฏููู ุงุฒ ุงูโูุง ุฏุฑ ุจุฑูุงูู ุงุณุชูุงุฏู ฺฉูู. ุงุจุชุฏุง ุงุฒ ฺฉุฏ ุฒุฑ ุงุณุชูุงุฏู ูโฺฉูู:</p>
<pre class="hljs"><code>CancellationTokenSource tokenSource = <span class="hljs-keyword">new</span>();
CancellationToken token = tokenSource.Token;
</code></pre>
<p>ุงูุจุชูุ ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉูุฏูุงฺู <code>var</code> ูโุชูุงูุฏ ฺฉุฏ ูุนุงุฏู ุฒุฑ ุฑุง ุจููุณุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> tokenSource = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> token = tokenSource.Token;
</code></pre>
<p>ุณูพุณ ุงู ุชูฺฉู ุฑุง ุจู ุชุณฺฉ ููุฑุฏูุธุฑ ูโุฏูู. ููุงูโุทูุฑ ฺฉู ูุจูุงู ุฏุฑ ูุตู ฒ ู ุดฺฉู ฒ-ฑ ุฏุฏุฏุ ุณุงุฒูุฏู Task ฺูุฏู ูุณุฎู <strong>overload</strong> ุฏุงุฑุฏ ู ุจุฑุฎ ุงุฒ ุขูโูุง ฺฉ ููููู <strong>CancellationToken</strong> ุฑุง ุจูโุนููุงู ูพุงุฑุงูุชุฑ ูโูพุฐุฑูุฏ. ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Task</span>(<span class="hljs-params">Action action, CancellationToken cancellationToken</span>)</span>;
</code></pre>
<p>ููฺููุ ูุชุฏูุง <code>StartNew</code> ุฏุฑ ฺฉูุงุณ <code>TaskFactory</code> ู <code>Run</code> ุฏุฑ ฺฉูุงุณ <code>Task</code> ูุฒ overloadูุง ูุดุงุจู ุฏุงุฑูุฏ. ฺูุฏ ููููู ุฏฺฏุฑ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">StartNew</span>(<span class="hljs-params">Action action, CancellationToken cancellationToken</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Task <span class="hljs-title">Run</span>(<span class="hljs-params">Action action, CancellationToken cancellationToken</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">Task</span>&lt;<span class="hljs-title">TResult</span>&gt; <span class="hljs-title">Run</span>&lt;<span class="hljs-title">TResult</span>&gt;(<span class="hljs-params">Func&lt;TResult&gt; function, CancellationToken cancellationToken</span>)
</span></code></pre>
<p>ุงู ุณุงุฎุชุงุฑูุง ุจู ุดูุง ุงุฏู ูโุฏููุฏ ฺฉู ฺฺฏููู ฺฉ <strong>ุชูฺฉู ูุบู</strong> ุฑุง ุจู ุชุณฺฉ ููุชูู ฺฉูุฏ. ุจุฑุง ูุซุงูุ ฺฉุฏ ุฒุฑ ุฏุฑ ููููู ุจุนุฏ ุงุณุชูุงุฏู ูโุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> printTask = Task.Run(
    () =&gt;
    {
        <span class="hljs-comment">// ุจุฑุฎ ฺฉุฏูุง ฺฉู ูุดุงู ุฏุงุฏู ูุดุฏู</span>
    }, token
);
</code></pre>
<p>ุงูุง ุจุงุฏ ูฺฉุงุช ุฒุฑ ุงุฒ ูุงฺฉุฑูุณุงูุช ุฑุง ุจู ุฎุงุทุฑ ุจุณูพุงุฑุฏ:</p>
<blockquote>
<p><strong>ุฑุดุชู ูุฑุงุฎูุงูโฺฉููุฏู (calling thread)</strong> ุชุณฺฉ ุฑุง ุจูโุตูุฑุช ุงุฌุจุงุฑ ููโุจูุฏุฏุ ุชููุง <strong>ุงุนูุงู ูโฺฉูุฏ ฺฉู ูุบู ุฏุฑุฎูุงุณุช ุดุฏู ุงุณุช</strong>. ุงฺฏุฑ ุชุณฺฉ ุฏุฑ ุญุงู ุงุฌุฑุง ุจุงุดุฏุ ุจุฑ ุนูุฏู ฺฉุงุฑุจุฑ ุงุณุช ฺฉู ุงู ุฏุฑุฎูุงุณุช ุฑุง ูุดุงูุฏู ฺฉุฑุฏู ู ุจู ุขู ูพุงุณุฎ ุฏูุฏ.<br>
ููุจุน: <a href="https://learn.microsoft.com/en-us/dotnet/standard/parallel-programming/how-to-cancel-a-task-and-its-children">Cancel a task and its children</a></p>
</blockquote>
<p>ุงู ูฺฉุชู ูุดุงู ูโุฏูุฏ ฺฉู ููฺฉู ุงุณุช ููุช ุฑุดุชู ูุฑุงุฎูุงูโฺฉููุฏู ุฏุฑุฎูุงุณุช ูุบู ุฑุง ุงุนูุงู ูโฺฉูุฏุ ุชุณฺฉ ุฏุฑ ุญุงู ุงุฌุฑุง ูุจูุงู ุจู ูพุงุงู ุฑุณุฏู ุจุงุดุฏ. ุจูุงุจุฑุงูุ ุงฺฏุฑ ูโุฎูุงูุฏ ฺฉ ุชุณฺฉ ุฏุฑ ุญุงู ุงุฌุฑุง ุฑุง ูุบู ฺฉูุฏุ <strong>ุจุงุฏ ุฏุฑุฎูุงุณุช ูุบู ุฑุง ูุฑ ฺู ุณุฑุนโุชุฑ ุงุฑุณุงู ฺฉูุฏ</strong>. โก</p>
<h3>ูุบู ุชูุณุท ฺฉุงุฑุจุฑ (User-Initiated Cancellations)</h3>
<p>ุฏุฑ ุงุบูุจ ููุงุฑุฏุ <strong>ุฏุฑุฎูุงุณุช ูุบู ุชูุณุท ฺฉุงุฑุจุฑุงู</strong> ุงุฌุงุฏ ูโุดูุฏ. ููฺูู ูโุชูุงู ูุบู ุฑุง ุจูโุตูุฑุช <strong>ุฎูุฏฺฉุงุฑ ุจุนุฏ ุงุฒ ฺฉ ุจุงุฒู ุฒูุงู ูุดุฎุต</strong> ุงูุฌุงู ุฏุงุฏ.<br>
ุจุงุฏ ุจุญุซ ุฑุง ุจุง <strong>ูุบู ุชูุณุท ฺฉุงุฑุจุฑ</strong> ุดุฑูุน ฺฉูู. ๐งโ๐ป<br>
ุฑูฺฉุฑุฏ ุงููู ๐น</p>
<p>ุฏุฑ ุงููู ุฑูฺฉุฑุฏุ ูุจู ุงุฒ ุงุฑุณุงู ุฏุฑุฎูุงุณุช ูุบูุ ฺฉ ุดุฑุท <strong>if</strong> ุจุฑุฑุณ ูโุดูุฏ. ุฏุฑ ุตูุฑุช ูุงุฒุ ูโุชูุงูุฏ ูุจู ุงุฒ ูุบู ุชุณฺฉุ ฺฉุงุฑูุง ุงุถุงู ุงูุฌุงู ุฏูุฏ. ุจุฑุง ูุซุงูุ ูโุชูุงูุฏ ูพุงู ฺุงูพ ฺฉูุฏ ฺฉู ูุดุงู ุฏูุฏ ุงู ุชุณฺฉ ูุฑุงุฑ ุงุณุช ูุบู ุดูุฏ. ููฺูู ูโุชูุงูุฏ ููุงุจุน ูุงุฒู ุฑุง ูุจู ุงุฒ ูุบู ุชุณฺฉ <strong>ูพุงฺฉุณุงุฒ (cleanup)</strong> ฺฉูุฏ. ุฏุฑ ููุงุชุ ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>break</strong> ุง <strong>return</strong> ุงุฒ ุจููฺฉ ฺฉุฏ ูุฑุจูุทู ุฎุงุฑุฌ ูโุดูุฏ. ุงุญุชูุงูุงู ุงฺฉุซุฑ ูุง ุจุง ุงู ููุน ูฺฉุงูุฒู <strong>ุฎุฑูุฌ ูุฑู (soft exit)</strong> ุขุดูุง ูุณุชู. ุจุงุฏ ฺฉ ูุซุงู ุจุจูู. ๐</p>
<h3>ููููู ุนูู โ Demonstration 1 ๐ฅ๏ธ</h3>
<p>ุฏุฑ ุงู ูููููุ ฺฉ ุชุณฺฉ ุงุฌุงุฏ ุดุฏู ฺฉู ูโุชูุงูุฏ ุงุนุฏุงุฏ ฐ ุชุง นน ุฑุง ฺุงูพ ฺฉูุฏ. ุจุฑุง ุงูฺฉู ุงูฺฉุงู ูุบู ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ฺฉ <strong>CancellationTokenSource</strong> ุณุงุฎุชู ุดุฏู ุชุง <strong>ุชูฺฉู ูุบู</strong> ุงุฌุงุฏ ฺฉุฑุฏู ู ุจู ุชุณฺฉ ููุชูู ุดูุฏ ุชุง ุฏุฑ ุตูุฑุช ูุงุฒ ุฏุฑุฎูุงุณุช ูุบู ุงุฑุณุงู ุดูุฏ.</p>
<p><strong>ุชูุฌู:</strong> ุงูุฑูุฒู ูพุฑุฏุงุฒูุฏูโูุง ฺฉุงููพูุชุฑ ุจุณุงุฑ ุณุฑุน ูุณุชูุฏุ ุจูุงุจุฑุงู ุงู ุชุณฺฉ ููฺฉู ุงุณุช ุฎู ุณุฑุน ุงุฌุฑุง ุดูุฏ. ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ููุถูุนุ ูพุณ ุงุฒ ฺุงูพ ูุฑ ุนุฏุฏุ ฺฉ ุชุฃุฎุฑ ฺฉูุชุงู ุงุนูุงู ุดุฏู ุงุณุช.</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> <span class="hljs-keyword">static</span> System.Console;

WriteLine(<span class="hljs-string">&quot;Simple cancellation demonstration.&quot;</span>);

<span class="hljs-keyword">var</span> tokenSource = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> token = tokenSource.Token;

<span class="hljs-keyword">var</span> printTask = Task.Run(
    () =&gt;
    {
        <span class="hljs-comment">// ุญูููโุง ฺฉู 100 ุจุงุฑ ุงุฌุฑุง ูโุดูุฏ</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
        {
            <span class="hljs-comment">// ุฑูฺฉุฑุฏ ุดูุงุฑู 1</span>
            <span class="hljs-keyword">if</span> (token.IsCancellationRequested)
            {
                WriteLine(<span class="hljs-string">&quot;Cancelling the print activity.&quot;</span>);
                <span class="hljs-comment">// ุงูุฌุงู ุจุฑุฎ ูพุงฺฉุณุงุฒโูุงุ ุฏุฑ ุตูุฑุช ูุงุฒ</span>
                <span class="hljs-keyword">return</span>;
            }
            WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">{i}</span>&quot;</span>);
            <span class="hljs-comment">// ุงุฌุงุฏ ุชุฃุฎุฑ ฺฉูุชุงู ุจุนุฏ ุงุฒ ฺุงูพ ูุฑ ุนุฏุฏ</span>
            Thread.Sleep(<span class="hljs-number">500</span>);
        }
    }, token
);

WriteLine(<span class="hljs-string">&quot;Enter c to cancel the task.&quot;</span>);
<span class="hljs-built_in">char</span> ch = ReadKey().KeyChar;

<span class="hljs-keyword">if</span> (ch.Equals(<span class="hljs-string">&#x27;c&#x27;</span>))
{
    WriteLine(<span class="hljs-string">&quot;\nRaising the cancellation request.&quot;</span>);
    tokenSource.Cancel();
}

<span class="hljs-keyword">try</span>
{
    printTask.Wait();
    <span class="hljs-comment">//printTask.Wait(token); // ุงู ุฎุท ุฏุฑ ุงุฏุงูู ุงุณุชูุงุฏู ุฎูุงูุฏ ุดุฏ</span>
}
<span class="hljs-keyword">catch</span> (OperationCanceledException oce)
{
    WriteLine(<span class="hljs-string">$&quot;Operation canceled. Message: <span class="hljs-subst">{oce.Message}</span>&quot;</span>);
}
<span class="hljs-keyword">catch</span> (AggregateException ae)
{
    <span class="hljs-keyword">foreach</span> (Exception e <span class="hljs-keyword">in</span> ae.InnerExceptions)
    {
        WriteLine(<span class="hljs-string">$&quot;Caught: <span class="hljs-subst">{e.GetType()}</span>, Message: <span class="hljs-subst">{e.Message}</span>&quot;</span>);
    }
}

WriteLine(<span class="hljs-string">$&quot;The final status of printTask is: <span class="hljs-subst">{printTask.Status}</span>&quot;</span>);
WriteLine(<span class="hljs-string">&quot;End of the main thread.&quot;</span>);
</code></pre>
<p>ุฏุฑ ุงู ุจุฑูุงููุ ุดูุง ูุดุงูุฏู ูโฺฉูุฏ ฺฉู ุชุณฺฉ ุจูโุตูุฑุช <strong>ููฺฉุงุฑุงูู (cooperative)</strong> ูุบู ูโุดูุฏ ู ูุถุนุช ููุง ุขู ุฏุฑ ูพุงุงู ฺฏุฒุงุฑุด ูโุดูุฏ. โ</p>
<h3>ุชูุถุญ ุฎุฑูุฌ ู Q&amp;A ๐</h3>
<p>ุฏุฑ <strong>Demonstration 1</strong>ุ ุญุช ููุช ุชุณฺฉ ูุบู ุดุฏุ ูุถุนุช ููุง ุขู <strong>RanToCompletion</strong> ุจูุฏ ู ูู <strong>Canceled</strong>. ุงู ุจู ุงู ุฏูู ุงุณุช ฺฉู ูุง ุชุณฺฉ ุฑุง ุจุง <strong>return</strong> ุณุงุฏู ุฎุงุชูู ุฏุงุฏูุ ูู ุจุง ูพุฑุชุงุจ <strong>OperationCanceledException</strong>.</p>
<p>Microsoft ุฏุฑ ูุณุชูุฏุงุช ุฎูุฏ ุชูุถุญ ูโุฏูุฏ:</p>
<ul>
<li><strong>ุฑุงู ุงูู:</strong> ุจุงุฒฺฏุดุช ุงุฒ delegate ฺฉุงู ุงุณุชุ ุงูุง ุฏุฑ ุงู ุญุงูุช ุชุณฺฉ ุจู ูุถุนุช <code>RanToCompletion</code> ูโุฑูุฏ.</li>
<li><strong>ุฑุงู ุฏูู (ุชุฑุฌุญ):</strong> ูพุฑุชุงุจ <strong>OperationCanceledException</strong> ุจุง ูพุงุณ ุฏุงุฏู ุชูฺฉู ูุบู. ุฏุฑ ุงู ุญุงูุช ุชุณฺฉ ุจู ูุถุนุช <strong>Canceled</strong> ูโุฑูุฏ ู ูโุชูุงู ุงุฒ ุขู ุฏุฑ ฺฉุฏ ูุฑุงุฎูุงู ุจุฑุง ุจุฑุฑุณ ูพุงุณุฎโุฏู ุชุณฺฉ ุจู ุฏุฑุฎูุงุณุช ูุบู ุงุณุชูุงุฏู ฺฉุฑุฏ.</li>
</ul>
<h3>Alternative Approach โ Demonstration 2 ๐</h3>
<p>ุฏุฑ ุงู ุฑูุดุ ุฏุงุฎู ุชุณฺฉุ ุจู ุฌุง return ุณุงุฏูุ ฺฉ <strong>OperationCanceledException</strong> ูพุฑุชุงุจ ูโฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> printTask = Task.Run(
    () =&gt;
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
        {
            <span class="hljs-comment">// Approach-2</span>
            <span class="hljs-keyword">if</span> (token.IsCancellationRequested)
            {
                WriteLine(<span class="hljs-string">&quot;Cancelling the print activity.&quot;</span>);
                <span class="hljs-comment">// ุงูุฌุงู ูพุงฺฉุณุงุฒโูุง ูุงุฒู</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OperationCanceledException(token);
            }
            WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">{i}</span>&quot;</span>);
            Thread.Sleep(<span class="hljs-number">500</span>);
        }
    }, token
);
</code></pre>
<h3>ููููู ุฎุฑูุฌ ุจุง ุงู ุฑูฺฉุฑุฏ</h3>
<pre class="hljs"><code>Simple cancellation demonstration.
Enter c to cancel the task.
0
1
2
c
Raising the cancellation request.
Cancelling the print activity.
Caught: System.Threading.Tasks.TaskCanceledException, Message: A task was canceled.
The final status of printTask is: Canceled
End of the main thread.
</code></pre>
<p>โ ููุงูโุทูุฑ ฺฉู ูุดุงูุฏู ูโฺฉูุฏุ ุญุงูุง ูุถุนุช ููุง ุชุณฺฉ <strong>Canceled</strong> ุงุณุช ู ุงุณุชุซูุงุก <code>TaskCanceledException</code> ุฏุฑุงูุช ูโุดูุฏ.</p>
<p>ุงู ุฑูุด ุจุฑุง ููุงูุน ููุงุณุจ ุงุณุช ฺฉู ูโุฎูุงูุฏ ูุทูุฆู ุดูุฏ ุชุณฺฉ ุจู ุตูุฑุช ุฑุณู ุจู ุญุงูุช <strong>ูุบู ุดุฏู</strong> ููุชูู ุดุฏู ู ฺฉุฏ ูุฑุงุฎูุงู ุจุชูุงูุฏ ุขู ุฑุง ุชุดุฎุต ุฏูุฏ.</p>
<h3>ฺฉูุชุงูโุณุงุฒ ฺฉุฏ ุจุง <code>ThrowIfCancellationRequested</code> โฑ๏ธ</h3>
<p>Microsoft ุชูุตู ูโฺฉูุฏ ฺฉู ุจู ุฌุง ููุดุชู ุฏุณุช ุงู ุฎุทูุท:</p>
<pre class="hljs"><code><span class="hljs-keyword">if</span> (token.IsCancellationRequested)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OperationCanceledException(token);
</code></pre>
<p>ูโุชูุงูุฏ ุงุฒ ูุชุฏ <strong><code>ThrowIfCancellationRequested</code></strong> ุงุณุชูุงุฏู ฺฉูุฏ ฺฉู ูุนุงุฏู ุนููฺฉุฑุฏ ุจุงูุง ุงุณุช ู ูู ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุขุง ุฏุฑุฎูุงุณุช ูุบู ุดุฏู ู ูู ุฏุฑ ุตูุฑุช ูุงุฒ ุงุณุชุซูุงุก ููุงุณุจ ุฑุง ูพุฑุชุงุจ ูโฺฉูุฏ.</p>
<h3>ูุซุงู ฺฉูุชุงูโุดุฏู โ Approach-3</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> printTask = Task.Run(
    () =&gt;
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
        {
            <span class="hljs-comment">// Approach-3</span>
            token.ThrowIfCancellationRequested();
            WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">{i}</span>&quot;</span>);
            Thread.Sleep(<span class="hljs-number">500</span>);
        }
    }, token
);
</code></pre>
<p>ุงู ุฑูุด ูู ุชููุง ฺฉูุชุงูโุชุฑ ู ุชูุฒุชุฑ ุงุณุชุ ุจูฺฉู ุงุณุชุงูุฏุงุฑุฏ <strong>ูพุฑฺฉุงุฑุจุฑุฏ</strong> ุฏุฑ ุจุฑูุงููโูุง ูุงูุน ูุญุณูุจ ูโุดูุฏ. โ</p>
<hr>
<h3>ูฺฉุงุช ููู Q&amp;A</h3>
<p><strong>Q5.2 โ ุชูุงูุช RanToCompletion ู Canceled:</strong></p>
<ul>
<li>ุงฺฏุฑ ููุท ุงุฒ <code>return</code> ุจุฑุง ุฎุฑูุฌ ุงุณุชูุงุฏู ฺฉูุฏุ ูุถุนุช ุชุณฺฉ <strong>RanToCompletion</strong> ูโุดูุฏ.</li>
<li>ุงฺฏุฑ <code>OperationCanceledException</code> ูพุฑุชุงุจ ฺฉูุฏ (Approach-2 ุง Approach-3)ุ ูุถุนุช ุชุณฺฉ <strong>Canceled</strong> ูโุดูุฏ.</li>
<li>ุฏุฑ ุจุฑูุงููโูุง ุณุงุฒูุงูุ ุญุงูุช ุฏูู ุชุฑุฌุญ ุฏุงุฏู ูโุดูุฏ ฺูู ุงูฺฉุงู ุจุฑุฑุณ ู ุซุจุช ูุงฺฏ ุชุณฺฉโูุง ูุบู ุดุฏู ูุฑุงูู ูโุดูุฏ.</li>
</ul>
<p><strong>Q5.3 โ ุงูุฌุงู ูพุงฺฉุณุงุฒ ูุจู ุงุฒ ูุบู ุชุณฺฉ:</strong><br>
ูโุชูุงูุฏ ุงุฒ ุชุฑฺฉุจ ุจุฑุฑุณ <code>IsCancellationRequested</code> ู ุณูพุณ <code>ThrowIfCancellationRequested</code> ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">if</span> (token.IsCancellationRequested)
{
    <span class="hljs-comment">// ุงูุฌุงู ูพุงฺฉุณุงุฒโูุง ูุงุฒู</span>
    token.ThrowIfCancellationRequested();
}
</code></pre>
<hr>
<h3>ูฺฉุชู ููุงุจุน ู Dispose ๐ก</h3>
<ul>
<li>ููุดู ูพุณ ุงุฒ ูพุงุงู ฺฉุงุฑ ุจุง <code>CancellationTokenSource</code>ุ ุจุงุฏ <strong><code>Dispose()</code></strong> ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ุชุง ููุงุจุน ุขุฒุงุฏ ุดููุฏ:</li>
</ul>
<pre class="hljs"><code>tokenSource.Dispose();
</code></pre>
<ul>
<li>ุงู ฺฉูุงุณ <code>IDisposable</code> ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ ู ุฏุฑ ุบุฑ ุงู ุตูุฑุช ููุงุจุน ุชุง ูุฑุงุฎูุงู Garbage Collector ุขุฒุงุฏ ููโุดููุฏ.</li>
</ul>
<hr>
<h3>ูููููโูุง ุฏฺฏุฑ <code>OperationCanceledException</code></h3>
<table>
<thead>
<tr>
<th>Constructor</th>
<th>ุชูุถุญ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OperationCanceledException(CancellationToken)</code></td>
<td>ุงุณุชูุงุฏู ููุฑุงู ุจุง ุชูฺฉู ูุบู (ูุซู Demonstration 2)</td>
</tr>
<tr>
<td><code>OperationCanceledException(String)</code></td>
<td>ุงุฌุงุฏ ุงุณุชุซูุงุก ุจุง ูพุงู ุฏูุฎูุงู</td>
</tr>
<tr>
<td><code>OperationCanceledException()</code></td>
<td>ูพุงู ูพุดโูุฑุถ ุณุณุชู</td>
</tr>
</tbody>
</table>
<p>ุงู ุงูุนุทุงู ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ููฺฏุงู ูุบู ุชุณฺฉุ ุฌุฒุฆุงุช ุฏูุฎูุงู ุฑุง ุซุจุช ฺฉูุฏ ู ูุฏุฑุช ุจูุชุฑ ุฑู ุนููุงุช ูุบู ุฏุงุดุชู ุจุงุดุฏ.</p>
<h3>ุจุฑุฑุณ ุชุฃุซุฑ ุชุบุฑ ูุญูู ูพุฑุชุงุจ ู ูุฏุฑุช ุงุณุชุซูุงุก ูุบู</h3>
<hr>
<h3><strong>Case Study 1 โ ุชุบุฑ ุชุนุฑู ุชุณฺฉ</strong></h3>
<p>ุฏุฑ Demonstration 2 (Approach-2)ุ ุงฺฏุฑ <code>OperationCanceledException</code> ุฑุง ุจุฏูู ูพุงุณ ุฏุงุฏู <strong>CancellationToken</strong> ุจุณุงุฒุฏุ ูุงููุฏ ุงู:</p>
<pre class="hljs"><code><span class="hljs-keyword">if</span> (token.IsCancellationRequested)
{
    WriteLine(<span class="hljs-string">&quot;Cancelling the print activity.&quot;</span>);
    <span class="hljs-comment">// Do some cleanups, if required</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OperationCanceledException(<span class="hljs-string">&quot;The operation is canceled.&quot;</span>);
}
</code></pre>
<p><strong>ุฎุฑูุฌ ููููู:</strong></p>
<pre class="hljs"><code>Simple cancellation demonstration.
Enter c to cancel the task.
0
1
2
c
Raising the cancellation request.
Cancelling the print activity.
Caught: System.OperationCanceledException, Message: The operation is canceled.
The final status of printTask is: Faulted
End of the main thread.
</code></pre>
<p>โ <strong>ุชูุถุญ:</strong></p>
<ul>
<li>ููุช <code>OperationCanceledException</code> ุจุฏูู ุชูฺฉู ุงุฌุงุฏ ุดูุฏุ ุง ุชูฺฉู ุขู ุจุง ุชุณฺฉ ูุทุงุจูุช ูุฏุงุดุชู ุจุงุดุฏุ <strong>ุชุณฺฉ ุจู ุฌุง ุญุงูุช Canceledุ ุจู ุญุงูุช Faulted ูโุฑูุฏ</strong>.</li>
<li>ุงู ุฑูุชุงุฑ ุชูุณุท ุทุฑุงุญ .NET ุชุนู ุดุฏู ุงุณุช. ููุจุน ุฑุณู: <a href="https://learn.microsoft.com/en-us/dotnet/standard/parallel-programming/task-cancellation">Task cancellation</a></li>
</ul>
<blockquote>
<p>ุฎูุงุตู: ุจุฑุง ุฏุงุดุชู ูุถุนุช <code>Canceled</code>ุ ุจุงุฏ <strong>ุชูฺฉู ููุงู ุชุณฺฉ</strong> ุจู ุงุณุชุซูุงุก ุฏุงุฏู ุดูุฏ.</p>
</blockquote>
<hr>
<h3><strong>Case Study 2 โ ุชุบุฑ ูุญูู ุตุฏุง ุฒุฏู Wait</strong></h3>
<p>ุงฺฏุฑ ุงุฒ <code>Wait(token)</code> ุจู ุฌุง <code>Wait()</code> ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-comment">// printTask.Wait();</span>
printTask.Wait(token);
</code></pre>
<p><strong>ุชุฃุซุฑ:</strong></p>
<ul>
<li>ุงู ุจุงุฑุ <code>OperationCanceledException</code> ุฏุงุฎู <code>AggregateException</code> ูุฑุงุฑ ููโฺฏุฑุฏ.</li>
<li>ุจูุงุจุฑุงูุ ูุงุฒู ุงุณุช catch ูุฌุฒุง ุจุฑุง <code>OperationCanceledException</code> ุฏุงุดุชู ุจุงุดุฏ ุชุง ุขู ุฑุง ูุฏุฑุช ฺฉูุฏ.</li>
</ul>
<p><strong>ุฎุฑูุฌ ููููู:</strong></p>
<pre class="hljs"><code>Simple cancellation demonstration.
Enter c to cancel the task.
0
1
2
c
Raising the cancellation request.
Operation canceled. Message: The operation was canceled.
The final status of printTask is: Running
End of the main thread.
</code></pre>
<p>โ <strong>ูฺฉุงุช ฺฉูุฏ:</strong></p>
<ol>
<li>ูพุฑุชุงุจ ุงุณุชุซูุงุก ุจุง ุชูฺฉู ููุงุณุจ โ ุชุณฺฉ ูุถุนุช <code>Canceled</code> ูโฺฏุฑุฏ.</li>
<li>ูพุฑุชุงุจ ุงุณุชุซูุงุก ุจุฏูู ุชูฺฉู โ ุชุณฺฉ ูุถุนุช <code>Faulted</code> ูโฺฏุฑุฏ.</li>
<li>ุงุณุชูุงุฏู ุงุฒ <code>Wait(token)</code> โ ุงุณุชุซูุงุก ูุบู ูุณุชููุงู ูุฏุฑุช ูโุดูุฏ ู ุฏุฑ <code>AggregateException</code> ุฌูุนโุขูุฑ ููโุดูุฏ.</li>
</ol>
<hr>
<p>ุงู ุฏู ูุทุงูุนู ููุฑุฏ ูุดุงู ูโุฏูุฏ ฺฉู <strong>ูุญูู ูพุฑุชุงุจ ู ูุฏุฑุช ุงุณุชุซูุงุก ูุบู ู ููฺูู ุชูฺฉู ููุฑุฏ ุงุณุชูุงุฏูุ ุชุฃุซุฑ ูุณุชูู ุฑู ูุถุนุช ููุง ุชุณฺฉ ุฏุงุฑูุฏ</strong>.</p>
<h3><strong>Q5.5 โ ฺุฑุง ูุถุนุช ููุง ุชุณฺฉ Running ูุดุงู ุฏุงุฏู ุดุฏุ</strong></h3>
<p>ุฏุฑ ูุซุงู ูุจู ฺฉู ุงุฒ <code>Wait(token)</code> ุงุณุชูุงุฏู ุดุฏุ ุฎุฑูุฌ ููุง ุชุณฺฉ <code>Running</code> ุจูุฏุ ูู <code>Canceled</code> ุง <code>Faulted</code>.</p>
<p>โ <strong>ุชูุถุญ:</strong></p>
<ul>
<li>ููุช ุงุฒ <code>Wait(token)</code> ุงุณุชูุงุฏู ูโฺฉูุฏุ ุงูุชุธุงุฑ ุงุตู ุชุณฺฉ ุจู ูุณูู <strong>ุชูฺฉู ูุบู</strong> ฺฉูุชุฑู ูโุดูุฏ.</li>
<li>ุงฺฏุฑ ฺฉุงุฑุจุฑ ูุจู ุงุฒ ุงุชูุงู ุชุณฺฉุ ูุบู ุฑุง ุฏุฑุฎูุงุณุช ฺฉูุฏุ <strong>main thread ุณุฑุนุงู ุงุฒ Wait ุฎุงุฑุฌ ูโุดูุฏ</strong> ู ุจูุงุจุฑุงู ูููุฒ ุชุณฺฉ ููฺฉู ุงุณุช ุฏุฑ ุญุงู ุงุฌุฑุง ุจุงุดุฏ.</li>
<li>ุฏุฑ ูุชุฌูุ ุงฺฏุฑ ุจูุงูุงุตูู ูุถุนุช ุชุณฺฉ ุฑุง ุจุฑุฑุณ ฺฉูุฏุ ููุฏุงุฑ <code>Running</code> ุฏุฏู ูโุดูุฏ ฺูู ุชุณฺฉ ูููุฒ ฺฉุงูู ูุดุฏู ุงุณุช.</li>
</ul>
<p>๐ก <strong>ุฑุงู ุญู ุจุฑุง ุฏุฏู ูุถุนุช ูุงูุน ุชุณฺฉ:</strong></p>
<p>ูโุชูุงูุฏ ูุจู ุงุฒ ุจุฑุฑุณ ูุถุนุชุ <strong>ููุชุธุฑ ุดูุฏ ุชุง ุชุณฺฉ ูุงูุนุงู ฺฉุงูู ุดูุฏ</strong>:</p>
<pre class="hljs"><code><span class="hljs-comment">// Wait till the task finishes the execution</span>
<span class="hljs-keyword">while</span> (!printTask.IsCompleted) { }

WriteLine(<span class="hljs-string">$&quot;The final status of printTask is: <span class="hljs-subst">{printTask.Status}</span>&quot;</span>);
</code></pre>
<p><strong>ุฎุฑูุฌ ููููู ูพุณ ุงุฒ ุงู ุชุบุฑ:</strong></p>
<pre class="hljs"><code>Simple cancellation demonstration.
Enter c to cancel the task.
0
1
2
c
Raising the cancellation request.
Operation canceled. Message: The operation was canceled.
Cancelling the print activity.
The final status of printTask is: Faulted
End of the main thread.
</code></pre>
<p>โ <strong>ูฺฉุชู ฺฉูุฏ:</strong></p>
<ul>
<li><code>Wait(token)</code> ุจุงุนุซ ุฎุฑูุฌ ุฒูุฏููฺฏุงู main thread ูโุดูุฏุ ุงูุง ุชุณฺฉ ููฺฉู ุงุณุช ูููุฒ ฺฉุงูู ูุดุฏู ุจุงุดุฏ.</li>
<li>ุจุฑุง ูุดุงูุฏู ูุถุนุช ููุง ุฏููุ ุจุงุฏ ุชุง ุงุชูุงู ุชุณฺฉ ุตุจุฑ ฺฉูุฏ (<code>IsCompleted</code>).</li>
</ul>
<div align="center">
<p><img src="../../../assets/image/05/Table%205-1.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<p>ูฺฉุงุช ููู ๐</p>
<p>ูโุฎูุงูู ุจู ูฺฉุงุช ุฒุฑ ุชูุฌู ฺฉูุฏ:</p>
<p>1๏ธโฃ ุจุง ุจุฑุฑุณ ุฏูู ุฎูุงูุฏ ุฏุฏ ฺฉู ูุชุฏ <code>Wait()</code> ุชููุง ูโุชูุงูุฏ <code>AggregateException</code> ุงุฌุงุฏ ฺฉูุฏุ ุฏุฑ ุญุงู ฺฉู <code>Wait(CancellationToken cancellationToken)</code> ูุงุจู ูุบู ุงุณุช ู ูโุชูุงูุฏ <code>OperationCanceledException</code> ุฑุง ุงุฌุงุฏ ฺฉูุฏ. ุงฺฏุฑ ุนูุงููโููุฏ ูุณุชุฏุ ูโุชูุงูุฏ ุจุญุซ ุขููุงู ูุง ุฏุฑ ุงู ููุฑุฏ ุฑุง ุฏุฑ ููฺฉ ุฒุฑ ูุดุงูุฏู ฺฉูุฏ:<br>
<a href="https://stackoverflow.com/questions/77833724/why-the-catch-block-of-aggregateexception-was-not-sufficient-to-handle-cancellat/77833858#77833858">StackOverflow Discussion</a></p>
<p>2๏ธโฃ ุจุฑุง ูพุงุณุฎ ุจู ุณุคุงู Q5.5ุ ูู ุงุฒ ุฎุท <code>while (!printTask.IsCompleted) { }</code> ุงุณุชูุงุฏู ฺฉุฑุฏู. ุจุง ุงู ุญุงูุ ูุงฺฉุฑูุณุงูุช ุชูุตู ูโฺฉูุฏ (ููฺฉ ุขููุงู: <a href="https://learn.microsoft.com/en-us/dotnet/standard/parallel-programming/exception-handling-task-parallel-library">Microsoft Documentation</a>) ฺฉู ุงุฒ ฺูู polling ุฏุฑ ฺฉุฏูุง ุชููุฏ ุฎูุฏุฏุงุฑ ฺฉูุฏุ ุฒุฑุง ุจุณุงุฑ ูุงฺฉุงุฑุขูุฏ ุงุณุช.</p>
<p>3๏ธโฃ ุฏุฑ ุฎุฑูุฌ ูุจูุ ูุถุนุช ููุง ุชุณฺฉ (<code>task</code>) ุจู ุตูุฑุช <code>Faulted</code> ููุงุด ุฏุงุฏู ุดุฏ. ุฏูู ุขู ุงู ุงุณุช ฺฉู ูู ุฏุฑ ุขู ุฏูู ุงุฒ ุฎุท ุฒุฑ ุงุณุชูุงุฏู ฺฉุฑุฏู:</p>
<pre class="hljs"><code><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OperationCanceledException(<span class="hljs-string">&quot;The operation is canceled.&quot;</span>);
</code></pre>
<p>ุจุง ุงู ุญุงูุ ุงฺฏุฑ ุงู ุฎุท ุฑุง ุจุง</p>
<pre class="hljs"><code><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OperationCanceledException(token);
</code></pre>
<p>ุฌุงฺฏุฒู ฺฉูุฏุ ูุถุนุช ููุง <code>Canceled</code> ุฎูุงูุฏ ุจูุฏ ู ูู <code>Faulted</code>.</p>
<p>โฑ๏ธ ูุบู ุจุง ุชุงูโุงูุช (Timeout Cancellation)</p>
<p>ุดูุง ูโุชูุงูุฏ ฺฉ ุฏุฑุฎูุงุณุช ูุบู ุฑุง ูพุณ ุงุฒ ฺฉ ุจุงุฒู ุฒูุงู ูุดุฎุต ุงุฌุงุฏ ฺฉูุฏ. ุจู ุนููุงู ูุซุงูุ ุฏุฑ ฺฉ ุนููุงุช ุดุจฺฉู ูุนูููุ ููฺฉู ุงุณุช ูุฎูุงูุฏ ุจโููุงุช ููุชุธุฑ ุจูุงูุฏ. ุฏุฑ ฺูู ุญุงูุชุ ุจุฑูุงูู ุดูุง ูโุชูุงูุฏ ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุฏุฑุฎูุงุณุช ูุบู ุฑุง ุตุงุฏุฑ ฺฉูุฏ.</p>
<p>ุจุฑุง ูพุงุฏูโุณุงุฒ ุงู ุงุฏูุ ูโุชูุงูุฏ ุงุฒ ุฎุท ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre class="hljs"><code>tokenSource.CancelAfter(<span class="hljs-number">2000</span>);
</code></pre>
<p>ุฏุฑ ุฏูู ูุจู (Demonstration 2) ุจู ุดฺฉู ุฒุฑ:</p>
<pre class="hljs"><code><span class="hljs-comment">// ูฺ ุชุบุฑ ุฏุฑ ฺฉุฏ ูุจู ูุณุช</span>
<span class="hljs-keyword">var</span> tokenSource = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> token = tokenSource.Token;
tokenSource.CancelAfter(<span class="hljs-number">2000</span>);
<span class="hljs-comment">// ูฺ ุชุบุฑ ุฏฺฏุฑ ุฏุฑ ฺฉุฏ ุจุงูโูุงูุฏู ูุณุช</span>
</code></pre>
<p>ุงฺฉููู ุจุง ุงุฌุฑุง ุจุฑูุงููโ ุงุตูุงุญโุดุฏูุ ุจุฑูุงูู ูโุชูุงูุฏ ูพุณ ุงุฒ ฒฐฐฐ ููโุซุงูู ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุฏุฑุฎูุงุณุช ูุบู ุฑุง ุตุงุฏุฑ ฺฉูุฏ.</p>
<p>๐ก ุชูุฌู: ุงุฒ ุขูุฌุง ฺฉู ูู ุจูู ฺฉุฏ ุฑุง ุชุบุฑ ูุฏุงุฏูโุงูุ ุงู ุจุฑูุงูู ููฺูุงู ูโุชูุงูุฏ ุจู ูุบููุง ุงุฌุงุฏุดุฏู ุชูุณุท ฺฉุงุฑุจุฑ ูุฒ ูพุงุณุฎ ุฏูุฏ. ุฏุฑ ุงู ุญุงูุชุ ฺฉุงุฑุจุฑ ุจุงุฏ ูุจู ุงุฒ ูุนุงู ุดุฏู ูุบู ุฎูุฏฺฉุงุฑุ ุฏุฑุฎูุงุณุช ูุบู ุฑุง ุตุงุฏุฑ ฺฉูุฏ. ุฏุฑ ูุงูุนุ ุจุฑูุงูู ุชุง ุฏุฑุงูุช ูุฑูุฏ ุงุฒ ฺฉุงุฑุจุฑ ููุชุธุฑ ูโูุงูุฏ ูุจู ุงุฒ ุงูฺฉู ุจุณุชู ุดูุฏ. ูโุชูุงูุฏ ูพุฑูฺู <code>Chapter5_TimeoutCancellation</code> ุฑุง ุงุฒ ูุจโุณุงุช Apress ุฏุงูููุฏ ฺฉูุฏ ุชุง ุจุฑูุงูู ฺฉุงูู ุฑุง ุจุจูุฏ.</p>
<p>๐ฅ๏ธ ูุธุงุฑุช ุจุฑ ูุบู ุชุณฺฉ (Monitoring Task Cancellation)</p>
<p>ุฏุฑ ุฎุฑูุฌ ุจุฑุฎ ุงุฒ ุฏูููุง ูุจู (ูุซูุงู ุฎุฑูุฌ Demonstration2ุ Chapter5_Demo2_CaseStudy1ุ ุง ูพุงุณุฎ ุจู Q5.5)ุ ุดูุง ุฎุท ุฒุฑ ุฑุง ูุดุงูุฏู ฺฉุฑุฏุฏ:</p>
<pre class="hljs"><code>Cancelling the print activity.
</code></pre>
<p>ูู ุงุฒ ุงู ุฎุท ุจุฑุง ูุธุงุฑุช ุจุฑ ุชุณฺฉ ูุบู ุดุฏู ูุจู ุงุฒ ุนููุงุช ูุบู ุงุณุชูุงุฏู ฺฉุฑุฏู. ุฌุงูุจ ุงุณุช ฺฉู ุฑูุดโูุง ุฌุงฺฏุฒู ุฏฺฏุฑ ูุฒ ูุฌูุฏ ุฏุงุฑุฏ. ุจุงุฏ ุจุฑุฎ ุงุฒ ุขูโูุง ุฑุง ุจุจูู.</p>
<p>๐ ุงุณุชูุงุฏู ุงุฒ Register</p>
<p>ุดูุง ูโุชูุงูุฏ ุฏุฑ ฺฉ ุฑูุฏุงุฏ ุซุจุชโูุงู ฺฉูุฏ. ุจู ุนููุงู ูุซุงูุ ุฏุฑ ฺฉุฏ ุฒุฑ ฺฉ delegate ุซุจุช ูโฺฉูู ฺฉู ููฺฏุงู ูุบู ุดุฏู token ูุฑุงุฎูุงู ูโุดูุฏ:</p>
<pre class="hljs"><code>token.Register(
    () =&gt;
    {
        WriteLine(<span class="hljs-string">&quot;Cancelling the print activity. [Using event subscription]&quot;</span>);
        <span class="hljs-comment">// ุงฺฏุฑ ุฎูุงุณุชุฏ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุฏูุฏ</span>
    }
);
</code></pre>
<p>ุงุณุชูุงุฏู ุงุฒ <code>WaitHandle.WaitOne</code> โณ</p>
<p>ุงุฌุงุฒู ุฏูุฏ ฺฉ ุฑูุด ุฏฺฏุฑ ุฑุง ูุดุงู ุฏูู ฺฉู ูุณุจุช ุจู ุฑูุด ูุจู ฺฉู ูพฺุฏูโุชุฑ ุงุณุช. ุจุง ุงู ุญุงูุ ุงู ุฑูุด ูุฒ ูโุชูุงูุฏ ุงุฏูโุง ุฏุฑุจุงุฑูโ ูุธุงุฑุช ุจุฑ ูุบู ุชุณฺฉ ุจู ุดูุง ุจุฏูุฏ. ููฺฉ ุขููุงู <a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.waithandle.waitone?view=net-8.0">Microsoft Documentation</a> ูุชุฏ <code>WaitOne</code> ฺฉูุงุณ <code>WaitHandle</code> ุฑุง ุจู ุตูุฑุช ุฒุฑ ุชูุถุญ ูโุฏูุฏ:</p>
<blockquote>
<p>ุจููฺฉ ฺฉุฑุฏู ุชุฑุฏ ูุนู ุชุง ุฒูุงู ฺฉู <code>WaitHandle</code> ูุนู ุณฺฏูุงู ุฏุฑุงูุช ฺฉูุฏ.</p>
</blockquote>
<p>ูุชุฏ <code>WaitOne</code> ฺูุฏู ุงูุฑููุฏ ุฏุงุฑุฏ. ุฏุฑ ุฏูู ูพุดโุฑูุ ุณุงุฏูโุชุฑู ุดฺฉู ุขู ุฑุง ูุดุงู ูโุฏูู ฺฉู ูุงุฒ ุจู ุงุฑุณุงู ูฺ ุขุฑฺฏููุงู ูุฏุงุฑุฏ. ุงุฏู ุงุตู ุงู ุงุณุช ฺฉู ุชุฑุฏ ูุนู ฺฉ token ุฑุง ุฏุฑ ูุธุฑ ูโฺฏุฑุฏ ู ููุชุธุฑ ูโูุงูุฏ ุชุง ฺฉุณ ุงู token ุฑุง ูุบู ฺฉูุฏ. ุจู ูุญุถ ุงูฺฉู ฺฉุณ ุนููุงุช ูุบู ุฑุง ูุฑุงุฎูุงู ฺฉูุฏุ ุชูุงุณ ุจูุงฺฉโุดุฏู ุขุฒุงุฏ ูโุดูุฏ. ุจู ููู ุฏูู ูโุชูุงูู ฺฉ ุชุณฺฉ ุฏฺฏุฑ ุงุฒ ุชุฑุฏ ูุฑุงุฎูุงููุฏู ุจู ุดฺฉู ุฒุฑ ุงุฌุฑุง ฺฉูู:</p>
<pre class="hljs"><code>Task.Run(
    () =&gt;
    {
        token.WaitHandle.WaitOne();
        WriteLine(<span class="hljs-string">&quot;Cancelling the print activity. [Using WaitHandle]&quot;</span>);
        <span class="hljs-comment">// ุงฺฏุฑ ุฎูุงุณุชุฏ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุฏูุฏ</span>
    }
);
</code></pre>
<p>ุชูุฌู ฺฉูุฏ ฺฉู ุงู ุฑูุด ุจุณุงุฑ ุดุจู ุจู ุซุจุช ุฏุฑ ุฑูุฏุงุฏ (event subscription) ุงุณุชุ ุฒุฑุง ุฏุฑ ุงูุฌุง ูุฒ ููุชุธุฑ ูููุน ูุบู ูุณุชุฏ. ุจู ููู ุฏูู ูู ฺฉ ุฏุณุชูุฑ ูุดุงุจู ุฏุฑ ุงู ุจูุงฺฉ ฺฉุฏ ููุดุชู.</p>
<hr>
<p>๐ <strong>Demonstration 3</strong></p>
<p>ููุช ุขู ุงุณุช ฺฉู ุฏูู ุฏฺฏุฑ ุฑุง ุจุจูู ฺฉู ุฏุฑ ุขู ุฑูุดโูุง ุจุญุซโุดุฏู ุจุฑุง ูุธุงุฑุช ุจุฑ ุนููุงุช ูุบู ุฑุง ูุดุงู ูโุฏูุฏ. ุชุบุฑุงุช ฺฉูุฏ ุจุง <strong>ุจููุฏ</strong> ูุดุฎุต ุดุฏูโุงูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> <span class="hljs-keyword">static</span> System.Console;

WriteLine(<span class="hljs-string">&quot;Monitoring the cancellation operation.&quot;</span>);

<span class="hljs-keyword">var</span> tokenSource = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> token = tokenSource.Token;

token.Register(
    () =&gt;
    {
        WriteLine(<span class="hljs-string">&quot;Cancelling the print activity.[Using event subscription]&quot;</span>);
        <span class="hljs-comment">// ุงฺฏุฑ ุฎูุงุณุชุฏ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุฏูุฏ</span>
    }
);

<span class="hljs-keyword">var</span> printTask = Task.Run
(
    () =&gt;
    {
        <span class="hljs-comment">// ุญูููโุง ฺฉู 100 ุจุงุฑ ุงุฌุฑุง ูโุดูุฏ</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
        {
            <span class="hljs-comment">// Approach-3</span>
            token.ThrowIfCancellationRequested();
            WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">{i}</span>&quot;</span>);
            <span class="hljs-comment">// ุงุถุงูู ฺฉุฑุฏู ุชุงุฎุฑ ุจุฑุง ูุดุงูุฏู ุจูุชุฑ</span>
            Thread.Sleep(<span class="hljs-number">500</span>);
        }
    }, token
);

Task.Run(
    () =&gt;
    {
        token.WaitHandle.WaitOne();
        WriteLine(<span class="hljs-string">&quot;Cancelling the print activity.[Using WaitHandle]&quot;</span>);
        <span class="hljs-comment">// ุงฺฏุฑ ุฎูุงุณุชุฏ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุฏูุฏ</span>
    }
);

WriteLine(<span class="hljs-string">&quot;Enter c to cancel the task.&quot;</span>);
<span class="hljs-built_in">char</span> ch = ReadKey().KeyChar;
<span class="hljs-keyword">if</span> (ch.Equals(<span class="hljs-string">&#x27;c&#x27;</span>))
{
    WriteLine(<span class="hljs-string">&quot;\nTask cancellation requested.&quot;</span>);
    tokenSource.Cancel();
}

<span class="hljs-comment">// ุชุง ูพุงุงู ุงุฌุฑุง ุชุณฺฉ ููุชุธุฑ ุจูุงูุฏ</span>
<span class="hljs-keyword">while</span> (!printTask.IsCompleted) { }
WriteLine(<span class="hljs-string">$&quot;The final status of printTask is: <span class="hljs-subst">{printTask.Status}</span>&quot;</span>);
WriteLine(<span class="hljs-string">&quot;End of the main thread.&quot;</span>);
</code></pre>
<hr>
<p>๐ค <strong>ุฎุฑูุฌ ููููู</strong></p>
<p>ุชูุฌู ฺฉูุฏ ุชุบุฑุงุช ุจููุฏ ุดุฏูโุงูุฏ:</p>
<pre class="hljs"><code>Monitoring the cancellation operation.
Enter c to cancel the task.
0
1
2
c
Task cancellation requested.
Cancelling the print activity.[Using WaitHandle]
Cancelling the print activity.[Using event subscription]
The final status of printTask is: Canceled
End of the main thread.
</code></pre>
<hr>
<p>๐ <strong>ุงุณุชูุงุฏู ุงุฒ ฺูุฏู Cancellation Token</strong></p>
<p>ฺฉ ุจุฑูุงูู ูโุชูุงูุฏ ุจู ุฏูุงู ูุฎุชูู ูุบู ุดูุฏ. ุฏุฑ ฺูู ุญุงูุชุ ูโุชูุงูุฏ ุงุฒ ฺูุฏู token ุงุณุชูุงุฏู ฺฉูุฏ ู ููุทู ูุงุฒู ุฑุง ุงุนูุงู ฺฉูุฏ. ุฏุฑ ุงู ุฒููู ูโุชูุงูุฏ ุงุฒ ูุชุฏ <code>CreateLinkedTokenSource</code> ุงุณุชูุงุฏู ฺฉูุฏ.</p>
<p>ุฏุฑ ุฏูู ุฒุฑุ ุฏู token ูุฎุชูู ุงุฌุงุฏ ูโฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> normalCancellation = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> tokenNormal = normalCancellation.Token;

<span class="hljs-keyword">var</span> unexpectedCancellation = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> tokenUnexpected = unexpectedCancellation.Token;
</code></pre>
<p>ูพุณ ุงุฒ ุงุฌุงุฏุ ุขูโูุง ุฑุง ุจู ูุชุฏ <code>CreateLinkedTokenSource</code> ูโุฏูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> compositeToken = CancellationTokenSource.CreateLinkedTokenSource(tokenNormal, tokenUnexpected);
</code></pre>
<p>ุงุฏู ุงู ุงุณุช ฺฉู ุดูุง ูโุชูุงูุฏ ุจุง ูุบู ูุฑ ฺฉ ุงุฒ <code>normalCancellation</code> ุง <code>unexpectedCancellation</code>ุ ุชุณฺฉ ููุง ุฑุง ูุบู ฺฉูุฏ.</p>
<p>ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ูุชุฏ <code>CreateLinkedTokenSource</code> ุงูุฑููุฏูุง ูุฎุชูู ุฏุงุฑุฏ ู ุฏุฑ ุตูุฑุช ูุงุฒ ูโุชูุงูุฏ ุชุนุฏุงุฏ ุจุดุชุฑ token ุงุฑุณุงู ฺฉูุฏ. ูฺฉุชูโ ุงุตู ููุงู ุงุณุช: ูโุชูุงูุฏ ูุฑ ฺฉ ุงุฒ ุงู tokenโูุง ุฑุง ูุบู ฺฉูุฏ ุชุง ูุถุนุช ููุง ุชุณฺฉ <code>Canceled</code> ุดูุฏ.<br>
๐ <strong>Demonstration 4 โ ุฏูู ฺูุงุฑู</strong></p>
<p>ุฏุฑ ุจุฑูุงููโ ุฒุฑุ ฺฉุงุฑุจุฑ ูโุชูุงูุฏ ฺฉ ูุบู ูุนููู (normal cancellation) ุฑุง ูุนุงู ฺฉูุฏ. ุจุง ุงู ุญุงูุ ุดูุง ูโุชูุงูุฏ ฺฉ ูุบู ุบุฑููุชุธุฑู/ุงุถุทุฑุงุฑ (unexpected/emergency cancellation) ุฑุง ูุฒ ูุดุงูุฏู ฺฉูุฏ.</p>
<p>ุจุฑุง ุดุจูโุณุงุฒ ูุบู ุงุถุทุฑุงุฑุ ูู ุงุฒ ฺฉ ุชููุฏฺฉููุฏูโ ุนุฏุฏ ุชุตุงุฏู ุงุณุชูุงุฏู ูโฺฉูู. ุงฺฏุฑ ุนุฏุฏ ุชุตุงุฏู ุจุฑุงุจุฑ ต ุจุงุดุฏุ ูุบู ุงุถุทุฑุงุฑ ูุนุงู ุฎูุงูุฏ ุดุฏ.</p>
<p>ฺฉุฏ ฺฉุงูู ุจุฑูุงูู ุจุฑุง ููุงุด ุงู ุงุฏู ุจู ุดฺฉู ุฒุฑ ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> <span class="hljs-keyword">static</span> System.Console;

WriteLine(<span class="hljs-string">&quot;Monitoring the cancellation operation.&quot;</span>);

<span class="hljs-keyword">var</span> normalCancellation = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> tokenNormal = normalCancellation.Token;

<span class="hljs-keyword">var</span> unexpectedCancellation = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> tokenUnexpected = unexpectedCancellation.Token;

tokenNormal.Register(
    () =&gt;
    {
        WriteLine(<span class="hljs-string">&quot;Processing a normal cancellation.&quot;</span>);
        <span class="hljs-comment">// ุงฺฏุฑ ุฎูุงุณุชุฏ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุฏูุฏ</span>
    }
);

tokenUnexpected.Register(
    () =&gt;
    {
        WriteLine(<span class="hljs-string">&quot;Processing an unexpected cancellation.&quot;</span>);
        <span class="hljs-comment">// ุงฺฏุฑ ุฎูุงุณุชุฏ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุฏูุฏ</span>
    }
);

<span class="hljs-keyword">var</span> compositeToken = CancellationTokenSource.CreateLinkedTokenSource(tokenNormal, tokenUnexpected);

<span class="hljs-keyword">var</span> printTask = Task.Run
(
    () =&gt;
    {
        <span class="hljs-comment">// ุญูููโุง ฺฉู 100 ุจุงุฑ ุงุฌุฑุง ูโุดูุฏ</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)
        {
            compositeToken.Token.ThrowIfCancellationRequested();
            WriteLine(<span class="hljs-string">$&quot;<span class="hljs-subst">{i}</span>&quot;</span>);
            <span class="hljs-comment">// ุงุถุงูู ฺฉุฑุฏู ุชุงุฎุฑ ุจุฑุง ูุดุงูุฏู ุจูุชุฑ</span>
            Thread.Sleep(<span class="hljs-number">500</span>);
        }
    }, compositeToken.Token
);

<span class="hljs-comment">// ููุทู ุณุงุฏู ุจุฑุง ุดุจูโุณุงุฒ ูุบู ุงุถุทุฑุงุฑ</span>
<span class="hljs-built_in">int</span> random = <span class="hljs-keyword">new</span> Random().Next(<span class="hljs-number">1</span>, <span class="hljs-number">6</span>);
<span class="hljs-keyword">if</span> (random == <span class="hljs-number">5</span>)
    unexpectedCancellation.Cancel();

WriteLine(<span class="hljs-string">&quot;Enter a key (type c for a normal cancellation)&quot;</span>);
<span class="hljs-built_in">char</span> ch = ReadKey().KeyChar;
<span class="hljs-keyword">if</span> (ch.Equals(<span class="hljs-string">&#x27;c&#x27;</span>))
{
    WriteLine(<span class="hljs-string">&quot;\nTask cancellation requested.&quot;</span>);
    normalCancellation.Cancel();
}

<span class="hljs-comment">// ุชุง ูพุงุงู ุงุฌุฑุง ุชุณฺฉ ููุชุธุฑ ุจูุงูุฏ</span>
<span class="hljs-keyword">while</span> (!printTask.IsCompleted) { }

WriteLine(<span class="hljs-string">$&quot;The final status of printTask is: <span class="hljs-subst">{printTask.Status}</span>&quot;</span>);
WriteLine(<span class="hljs-string">&quot;End of the main thread.&quot;</span>);
</code></pre>
<hr>
<p>๐ค <strong>ุฎุฑูุฌ ููููู โ ูุบู ูุนููู</strong><br>
ุฒูุงู ฺฉู ฺฉุงุฑุจุฑ โcโ ุฑุง ูุดุงุฑ ูโุฏูุฏ:</p>
<pre class="hljs"><code>Monitoring the cancellation operation.
Enter a key (type c for a normal cancellation)
0
1
2
c
Task cancellation requested.
Processing a normal cancellation.
The final status of printTask is: Canceled
End of the main thread.
</code></pre>
<p>๐ค <strong>ุฎุฑูุฌ ููููู โ ูุบู ุงุถุทุฑุงุฑ</strong><br>
ุฒูุงู ฺฉู ูุบู ุงุถุทุฑุงุฑ ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ูุนุงู ูโุดูุฏ:</p>
<pre class="hljs"><code>Monitoring the cancellation operation.
Processing an unexpected cancellation.
The final status of printTask is: Canceled
End of the main thread.
</code></pre>
<p>๐ <strong>ุฎูุงุตู โ Summary</strong></p>
<p>ูุบู (Cancellation) ฺฉ ูฺฉุงูุฒู ุงุณุงุณ ุฏุฑ ุจุฑูุงููโููุณ Task ุงุณุช. ุจุง ุงู ุญุงูุ ุจู ุฌุง ูุชููู ฺฉุฑุฏู ูุงฺฏูุงู ฺฉ ุชุณฺฉุ ุดูุง ฺฉ ูุฏู ููฺฉุงุฑ ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู ุฏุฑ ุขู ุชุณฺฉ ู ฺฉุฏ ฺฉู ูุบู ุฑุง ุขุบุงุฒ ูโฺฉูุฏ (calling code) ุจุง ูู ฺฉุงุฑ ูโฺฉููุฏ ุชุง ุณูุงูุช ุจุฑูุงูู ุดูุง ุญูุธ ุดูุฏ.</p>
<p>ุงู ูุตู ุจู ุงู ููุถูุน ูพุฑุฏุงุฎุช ู ุจู ุณุคุงูุงุช ุฒุฑ ูพุงุณุฎ ุฏุงุฏ:</p>
<ul>
<li>ฺฺฏููู ูโุชูุงู ูุบููุง ูุจุชู ุจุฑ ฺฉุงุฑุจุฑ (user-initiated cancellations) ุฑุง ูพุดุชุจุงู ฺฉุฑุฏุ ๐ค</li>
<li>ฺฺฏููู ูโุชูุงู ูุบููุง ูุจุชู ุจุฑ ุฒูุงู (timeout cancellations) ุฑุง ูพุดุชุจุงู ฺฉุฑุฏุ โฑ๏ธ</li>
<li>ฺฺฏููู ูโุชูุงู ูุบููุง ุฑุง ุฏุฑ ุจุฑูุงูู ุฎูุฏ ูุงูุชูุฑ ฺฉุฑุฏุ ๐</li>
<li>ฺฺฏููู ูโุชูุงู ุงุฒ ฺูุฏู CancellationToken ุฏุฑ ุจุฑูุงูู ุฎูุฏ ุงุณุชูุงุฏู ฺฉุฑุฏุ ๐</li>
<li></li>
</ul>
<p>๐ <strong>ุชูุฑูโูุง โ Exercises</strong></p>
<p>ุจุฑุง ุณูุฌุด ุฏุฑฺฉ ุฎูุฏุ ุชูุฑูโูุง ุฒุฑ ุฑุง ุงูุฌุงู ุฏูุฏ:</p>
<div align="center">
<p><img src="../../../assets/image/05/Table%205-2.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<p>๐ <strong>ุงุฏุขูุฑ โ Reminder</strong></p>
<p>ููุงูโุทูุฑ ฺฉู ูุจูุงู ฺฏูุชู ุดุฏุ ูโุชูุงูุฏ ุจุง ุงุทููุงู ูุฑุถ ฺฉูุฏ ฺฉู ูููโ namespaceูุง ูุงุฒู ุจุฑุง ุงู ูุทุนูโูุง ฺฉุฏ ุฏุฑ ุฏุณุชุฑุณ ูุณุชูุฏ. ุงู ูฺฉุชู ุจุฑุง ูููโ ุชูุฑูโูุง ฺฉุชุงุจ ูุฒ ุตุงุฏู ุงุณุช.</p>
<hr>
<p>๐ <strong>ุชูุฑูโูุง โ Exercises</strong></p>
<p><strong>E5.1</strong><br>
ุงฺฏุฑ ฺฉุฏ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏุ ุขุง ูโุชูุงูุฏ ุฎุฑูุฌ ุขู ุฑุง ูพุดโุจู ฺฉูุฏุ</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> <span class="hljs-keyword">static</span> System.Console;

<span class="hljs-keyword">var</span> tokenSource = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> token = tokenSource.Token;

<span class="hljs-keyword">var</span> printTask = Task.Run(
    () =&gt;
    {
        <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (i != <span class="hljs-number">10</span>)
        {
            <span class="hljs-keyword">if</span> (token.IsCancellationRequested)
            {
                WriteLine(<span class="hljs-string">&quot;Cancelling the print activity.&quot;</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-comment">// ุฏุฑ ุตูุฑุช ูุงุฒุ ุงูุฌุงู ฺฉุงุฑูุง ุฏฺฏุฑ</span>
            Thread.Sleep(<span class="hljs-number">1000</span>);
            i++;
        }
    }, token
);

Thread.Sleep(<span class="hljs-number">500</span>);
WriteLine(<span class="hljs-string">&quot;The cancellation is initiated.&quot;</span>);
tokenSource.Cancel();

<span class="hljs-comment">// ููุชุธุฑ ุจูุงูุฏ ุชุง Task ฺฉุงูู ุดูุฏ</span>
<span class="hljs-keyword">while</span> (!printTask.IsCompleted) { }

WriteLine(<span class="hljs-string">$&quot;The final status of printTask is: <span class="hljs-subst">{printTask.Status}</span>&quot;</span>);
WriteLine(<span class="hljs-string">&quot;End of the main thread.&quot;</span>);
</code></pre>
<hr>
<p><strong>E5.2</strong><br>
ุฏุฑ ุชูุฑู ูุจูุ ูุทุนู ฺฉุฏ ุฒุฑ:</p>
<pre class="hljs"><code><span class="hljs-keyword">if</span> (token.IsCancellationRequested)
{
    WriteLine(<span class="hljs-string">&quot;Cancelling the print activity.&quot;</span>);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>ุฑุง ุจุง ุงู ุฎุท ุฌุงฺฏุฒู ฺฉูุฏ:</p>
<pre class="hljs"><code>token.ThrowIfCancellationRequested();
</code></pre>
<p>ุขุง ุชุบุฑ ุฎุฑูุฌ ุงุชูุงู ูโุงูุชุฏุ ๐ค</p>
<hr>
<p><strong>E5.3</strong><br>
ุจุฑูุงููโ ุฒุฑ ฺฉ Task ูุงูุฏ ู ฺฉ Task ุชู ุฏุฑ ุชู (nested) ุงุฌุงุฏ ูโฺฉูุฏ. ููฺูู ุงูฺฉุงู ูุบู ุงู Taskูุง ุจุง ูุดุงุฑ ุฏุงุฏู ฺฉูุฏ โcโ ูุฑุงูู ุดุฏู ุงุณุช. ุขุง ูโุชูุงูุฏ ุฎุฑูุฌ ุขู ุฑุง ูพุดโุจู ฺฉูุฏุ</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> <span class="hljs-keyword">static</span> System.Console;
WriteLine(<span class="hljs-string">&quot;Exercise 5.3&quot;</span>);

<span class="hljs-keyword">var</span> tokenSource = <span class="hljs-keyword">new</span> CancellationTokenSource();
<span class="hljs-keyword">var</span> token = tokenSource.Token;
Task child = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">var</span> parent = Task.Factory.StartNew(
    () =&gt;
    {
        Thread.Sleep(<span class="hljs-number">1000</span>);
        <span class="hljs-keyword">if</span> (token.IsCancellationRequested)
        {
            WriteLine(<span class="hljs-string">&quot;The cancellation request is raised too early.&quot;</span>);
            token.ThrowIfCancellationRequested();
        }

        WriteLine(<span class="hljs-string">&quot;The parent task is running.&quot;</span>);
        <span class="hljs-comment">// ุงุฌุงุฏ Task ุชู ุฏุฑ ุชู</span>
        child = Task.Factory.StartNew(
            () =&gt;
            {
                WriteLine(<span class="hljs-string">&quot;The child task has started.&quot;</span>);
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
                {
                    token.ThrowIfCancellationRequested();
                    WriteLine(<span class="hljs-string">$&quot;\tThe nested task prints:<span class="hljs-subst">{i}</span>&quot;</span>);
                    Thread.Sleep(<span class="hljs-number">200</span>);
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;The child task has finished too&quot;</span>;
            },
            token,
            TaskCreationOptions.AttachedToParent,
            TaskScheduler.Default
        );

        child.Wait(token);
    }, token
);

WriteLine(<span class="hljs-string">&quot;Enter c to cancel the nested task.&quot;</span>);
<span class="hljs-built_in">char</span> ch = ReadKey().KeyChar;

<span class="hljs-keyword">if</span> (ch.Equals(<span class="hljs-string">&#x27;c&#x27;</span>))
{
    WriteLine(<span class="hljs-string">&quot;\nTask cancellation requested.&quot;</span>);
    tokenSource.Cancel();
}

<span class="hljs-keyword">try</span>
{
    parent.Wait();
}
<span class="hljs-keyword">catch</span> (AggregateException ae)
{
    <span class="hljs-keyword">foreach</span> (Exception e <span class="hljs-keyword">in</span> ae.InnerExceptions)
    {
        WriteLine(<span class="hljs-string">$&quot;Caught error: <span class="hljs-subst">{e.Message}</span>&quot;</span>);
    }
}

WriteLine(<span class="hljs-string">$&quot;The current state of the parent task: <span class="hljs-subst">{parent.Status}</span>&quot;</span>);
<span class="hljs-built_in">string</span> childStatus = child != <span class="hljs-literal">null</span> ? child.Status.ToString() : <span class="hljs-string">&quot;not created&quot;</span>;
WriteLine(<span class="hljs-string">$&quot;The current state of the child task: <span class="hljs-subst">{childStatus}</span>&quot;</span>);
WriteLine(<span class="hljs-string">&quot;End of the main thread.&quot;</span>);
</code></pre>
<hr>
<p><strong>E5.4</strong> โ ุฏุฑุณุช/ูุงุฏุฑุณุช:<br>
i) ฺฉูุงุณ <code>CancellationTokenSource</code> ฺฉ ฺฉูุงุณ ุงุณุช ฺฉู ุงูุชุฑูุณ <code>IDisposable</code> ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ. โ / โ<br>
ii) ูฺฺฏ <code>Token</code> ุงุฒ ฺฉูุงุณ <code>CancellationTokenSource</code> ุจุฑุง ุงุฌุงุฏ ูููููโ <code>CancellationToken</code> ุงุณุชูุงุฏู ูโุดูุฏ. โ / โ</p>
<hr>
<p><strong>E5.5</strong><br>
ุฏุฑ ูุตู ณุ ุดูุง ุชูุฑู E3.2 ุฑุง ุญู ฺฉุฑุฏูโุงุฏ. ุงฺฉููู ุจุง ุชูุฌู ุจู ุงูฺฉู ุจุง ุณูุงุฑููุง ุงุณุชุซูุง (Exception) ู ูุบู Task (Cancellation) ุขุดูุง ุดุฏูโุงุฏุ ุขุง ูโุชูุงูุฏ ููุงู ุชูุฑู ุฑุง ุฏูุจุงุฑู ุจุง ุฏุฑ ูุธุฑ ฺฏุฑูุชู ุงู ุณูุงุฑููุง ุญู ฺฉูุฏุ ๐ก</p>
<p>๐ก <strong>ุฑุงูโุญู ุชูุฑูโูุง โ Solutions to Exercises</strong></p>
<hr>
<h3><strong>E5.1</strong></h3>
<p>ุจุฑูุงูู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ูุบู (cancellation) ุฑุง ุงุฌุฑุง ูโฺฉูุฏ. ฺฉ ุฎุฑูุฌ ุงุญุชูุงู ุจู ุดฺฉู ุฒุฑ ุงุณุช (ุชูุฌู ฺฉูุฏ ฺฉู ูุถุนุช ููุง Task ุจุฑุงุจุฑ <strong>RanToCompletion</strong> ุงุณุช ู ูู <strong>Canceled</strong>):</p>
<pre class="hljs"><code>The cancellation is initiated.
Cancelling the print activity.
The final status of printTask is: RanToCompletion
End of the main thread.
</code></pre>
<hr>
<h3><strong>E5.2</strong></h3>
<p>ุงู ุจุงุฑ ูุถุนุช ููุง Task ุจุงุฏ ุจู ุตูุฑุช <strong>Canceled</strong> ููุงุด ุฏุงุฏู ุดูุฏ. ููููู ุฎุฑูุฌ:</p>
<pre class="hljs"><code>The cancellation is initiated.
The final status of printTask is: Canceled
End of the main thread.
</code></pre>
<hr>
<h3><strong>E5.3</strong></h3>
<p>ููุงูโุทูุฑ ฺฉู ูโุฏุงูุฏุ ุงู ุจุฑูุงูู ฺฉ Task ูุงูุฏ ู ฺฉ Task ุชู ุฏุฑ ุชู (nested) ุงุฌุงุฏ ูโฺฉูุฏ ู ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุจุง ูุดุงุฑ ุฏุงุฏู ฺฉูุฏ โcโ Task ุชู ุฏุฑ ุชู ุฑุง ูุบู ฺฉูุฏ. ุจูุงุจุฑุงูุ ุจุณุชู ุจู ุฒูุงู ูุบูุ ุฎุฑูุฌ ูุชูุงูุช ุฎูุงูุฏ ุจูุฏ:</p>
<p><strong>ุงฺฏุฑ ูุบู ุงูุฌุงู ูุดูุฏ ู ุฏุฑ ูพุงุงู Enter ุจุฒูุฏุ ุฎุฑูุฌ ููฺฉู ุงุณุช ุจู ุดฺฉู ุฒุฑ ุจุงุดุฏ:</strong></p>
<pre class="hljs"><code>Exercise 5.3
Enter c to cancel the nested task.
The parent task is running.
The child task has started.
The nested task prints:0
The nested task prints:1
The nested task prints:2
The nested task prints:3
The nested task prints:4
The nested task prints:5
The nested task prints:6
The nested task prints:7
The nested task prints:8
The nested task prints:9
The current state of the parent task: RanToCompletion
The current state of the child task: RanToCompletion
End of the main thread.
</code></pre>
<p><strong>ุงฺฏุฑ ฺฉูุฏ โcโ ุชูุฑุจุงู ุฏุฑ ุงุจุชุฏุง ุจุฑูุงูู ูุดุงุฑ ุฏุงุฏู ุดูุฏุ ุฎุฑูุฌ ููฺฉู ุงุณุช ฺูู ุจุงุดุฏ:</strong></p>
<pre class="hljs"><code>Exercise 5.3
Enter c to cancel the nested task.
c
Task cancellation requested.
The cancellation request is raised too early.
Caught error: A task was canceled.
The current state of the parent task: Canceled
The current state of the child task: not created
End of the main thread.
</code></pre>
<p><strong>ู ุง ฺฉ ูุบู ุนุงุฏ ฺฉู ุจู ุดฺฉู ุฒุฑ ุงุณุช:</strong></p>
<pre class="hljs"><code>Exercise 5.3
Enter c to cancel the nested task.
The parent task is running.
The child task has started.
The nested task prints:0
The nested task prints:1
c
Task cancellation requested.
Caught error: A task was canceled.
The current state of the parent task: Canceled
The current state of the child task: Canceled
End of the main thread.
</code></pre>
<hr>
<h3><strong>E5.4</strong> โ ุฏุฑุณุช/ูุงุฏุฑุณุช โโ</h3>
<p>i) ฺฉูุงุณ <code>CancellationTokenSource</code> ฺฉ ฺฉูุงุณ ุงุณุช ฺฉู ุงูุชุฑูุณ <code>IDisposable</code> ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ. <strong>[True โ]</strong><br>
ii) ูฺฺฏ <code>Token</code> ุงุฒ ฺฉูุงุณ <code>CancellationTokenSource</code> ุจุฑุง ุงุฌุงุฏ ูููููโ <code>CancellationToken</code> ุงุณุชูุงุฏู ูโุดูุฏ. <strong>[True โ]</strong></p>
<hr>
<h3><strong>E5.5</strong></h3>
<p>ุงู ุชูุฑู ุฑุง ููโุงฺฉููู ุจู ุฎูุฏุชุงู ูุงฺฏุฐุงุฑ ูโฺฉูู. ูููู ุจุงุดุฏ! ๐</p>
<p>๐ก <strong>ุชูุฌู ุงุถุงู:</strong> ุงุฒ ุงู ุจู ุจุนุฏุ ููฺฏุงู ุญู ุชูุฑูโูุงุ ูโุชูุงูุฏ ูฺฉุงูุฒูโูุง ูุบู (cancellation) ู ูุฏุฑุช ุงุณุชุซูุง (exception) ุฑุง ูู ุงุนูุงู ฺฉูุฏ. ููู ูฺฉุชู ุจุฑุง ุชูุฑูโูุง ฺฉู ุฏุฑ ูุตูโูุง ูุจู ุญู ฺฉุฑุฏูโุงุฏ ูุฒ ุตุงุฏู ุงุณุช.</p>

</main>


 

  <!-- ููุชุฑ ูุดุชุฑฺฉ -->
  <footer class="footer">
    <div class="container">
      <p>
        <img src="/icone/copyright.svg" alt="ฺฉูพโุฑุงุช" width="14" height="14"
             style="vertical-align:middle;margin-inline:4px">
        <span id="y"></span> Gitab โ ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู
      </p>
    </div>
  </footer>

  <!-- ุณุงู + ุงุณฺฉุฑูพุช ุชู -->
  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    (() => {
      const root = document.documentElement;
      const btn = document.getElementById('themeToggle');
      const KEY = 'gitab-theme';
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      const getEffective = s => s === 'auto' ? (media.matches ? 'dark' : 'light') : s;
      function updateTheme(s) {
        root.setAttribute('data-theme', s);
        const mode = getEffective(s);
        root.dataset.colorMode = mode;
        btn.dataset.icon = mode === 'dark' ? 'moon' : 'sun';
      }
      const saved = localStorage.getItem(KEY) || 'auto';
      updateTheme(saved);
      btn.addEventListener('click', () => {
        const curr = localStorage.getItem(KEY) || 'auto';
        const next = curr === 'auto' ? 'dark' : curr === 'dark' ? 'light' : 'auto';
        localStorage.setItem(KEY, next);
        updateTheme(next);
      });
      media.addEventListener('change', () => {
        if ((localStorage.getItem(KEY) || 'auto') === 'auto') updateTheme('auto');
      });
      window.addEventListener('DOMContentLoaded', () => updateTheme(saved));
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<script>
document.querySelectorAll('pre code').forEach(block => {
  const btn = document.createElement('button');
  btn.className = 'copy-btn';

  const icon = document.createElement('img');
  icon.src = '/icone/copy.svg';
  icon.alt = 'Copy';
  btn.appendChild(icon);

  block.parentNode.insertBefore(btn, block);

  btn.addEventListener('click', async () => {
    await navigator.clipboard.writeText(block.textContent);
    btn.classList.add('copied');
    setTimeout(() => btn.classList.remove('copied'), 1500);
  });
});
</script>
<script>
  document.body.dataset.page = window.location.pathname;
</script>

</body>

</html>
