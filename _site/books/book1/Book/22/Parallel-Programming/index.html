<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gitab | ฺฉุชุงุจุฎุงููู ุชุฑุฌููโูุง ุฏุงุชโูุช ู ุณ ุดุงุฑูพ</title>
  <meta name="description" content="ุชุฑุฌููโูุง ูุงุฑุณ ฺฉุชุงุจโูุง ูู โ ุณุฑุนุ ูููุงู ู ูุงุจู ุงุชฺฉุง.">
  <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
  <!-- ูุฏุฑ ูุดุชุฑฺฉ -->
  <header class="header">
    <div class="container nav-wrap">
      <a class="brand" href="/">
        <img src="/icone/logo.svg" alt="Gitab" width="28" height="28">
        <span>Gitab</span>
      </a>

      <nav class="nav">
        <a href="/">ุฎุงูู</a>
        <a href="/books/list-books">ฺฉุชุงุจโูุง</a>
        <a href="#">ููฺฉุงุฑ</a>
        <a href="#">ุฏุฑุจุงุฑูโูุง</a>
      </nav>

     <div class="nav-actions">
  <button id="themeToggle" class="icon-btn theme-btn" aria-label="ุชุบุฑ ุญุงูุช">
    <img class="icon-sun" src="/icone/sun.svg" alt="ุฑูุดู">
    <img class="icon-moon" src="/icone/moon.svg" alt="ุชุงุฑฺฉ">
  </button>

  <a class="icon-btn" href="https://github.com/hheydarian/Gitab" target="_blank" title="GitHub">
    <img src="/icone/github.svg" alt="GitHub">
  </a>
</div>

  </header>

  <!-- ูุญุชูุง ุตูุญู -->
  <main class="site-main">
    <h1>ูุตู ุจุณุช ู ุฏูู:  ุจุฑูุงููโููุณ ููุงุฒ (Parallel Programming)</h1>
<p>ุฏุฑ ุงู ูุตูุ ูุง ุจู <strong>APIูุง</strong> ู ุณุงุฎุชุงุฑูุง ฺูุฏูุฎ (multithreading) ูโูพุฑุฏุงุฒู ฺฉู ุจุง ูุฏู ุจูุฑูโุจุฑุฏุงุฑ ุงุฒ ูพุฑุฏุงุฒูุฏูโูุง ฺูุฏโูุณุชูโุง ุทุฑุงุญ ุดุฏูโุงูุฏ:</p>
<ul>
<li><strong>Parallel LINQ (PLINQ)</strong></li>
<li><strong>ฺฉูุงุณ Parallel</strong></li>
<li><strong>ุณุงุฎุชุงุฑูุง task parallelism</strong></li>
<li><strong>ูุฌููุนูโูุง concurrent</strong></li>
</ul>
<p>ุงู ุณุงุฎุชุงุฑูุง ุฏุฑ ูุฌููุน (ุจูโุตูุฑุช ุบุฑุฑุณู) ุจุง ุนููุงู <strong>Parallel Framework (PFX)</strong> ุดูุงุฎุชู ูโุดููุฏ.
ฺฉูุงุณ <strong>Parallel</strong> ููุฑุงู ุจุง ุณุงุฎุชุงุฑูุง <strong>task parallelism</strong> ุชุญุช ุนููุงู <strong>Task Parallel Library (TPL)</strong> ูุงูุฏู ูโุดููุฏ.</p>
<p>ูพุด ุงุฒ ูุทุงูุนูโ ุงู ูุตูุ ูุงุฒู ุงุณุช ุจุง ููุงูู ูพุงูโุง ุฏุฑ ูุตู ฑด ุขุดูุง ุจุงุดุฏโุจูโูฺู <strong>locking</strong>ุ <strong>ุงูู ูุฎโูุง (thread safety)</strong> ู ฺฉูุงุณ <strong>Task</strong>.</p>
<p>๐ง ุนูุงูู ุจุฑ ุงูโูุงุ .NET ูุฌููุนูโุง ุงุฒ APIูุง ุชุฎุตุต ุฏฺฏุฑ ุฑุง ุจุฑุง ฺฉูฺฉ ุจู ุจุฑูุงููโููุณ ููุงุฒ ู ูุงููฺฏุงู ุงุฑุงุฆู ูโุฏูุฏ:</p>
<ul>
<li><strong>System.Threading.Channels.Channel</strong> โ ฺฉ ุตู ุชููุฏฺฉููุฏู/ูุตุฑูโฺฉููุฏู ูุงููฺฏุงู ุจุง ฺฉุงุฑุง ุจุงูุงุ ฺฉู ุฏุฑ <strong>.NET Core 3</strong> ูุนุฑู ุดุฏ.</li>
<li><strong>Microsoft Dataflow</strong> (ุฏุฑ ูุถุง ูุงู System.Threading.Tasks.Dataflow) โ ฺฉ API ูพุดุฑูุชู ุจุฑุง ุงุฌุงุฏ ุดุจฺฉูโุง ุงุฒ ุจููฺฉโูุง ุจุงูุฑ ุดุฏู (buffered blocks) ฺฉู ุนููุงุช ุง ุชุจุฏู ุฏุงุฏูโูุง ุฑุง ุจูโุตูุฑุช ููุงุฒ ุงุฌุฑุง ูโฺฉููุฏ ู ุดุจุงูุช ุฒุงุฏ ุจู ุจุฑูุงููโููุณ actor/agent ุฏุงุฑูุฏ.</li>
<li><strong>Reactive Extensions</strong> โ ูพุงุฏูโุณุงุฒ LINQ ุฑู <strong>IObservable</strong> (ุฌุงฺฏุฒู ุจุฑุง <strong>IAsyncEnumerable</strong>) ฺฉู ุฏุฑ ุชุฑฺฉุจ ุฌุฑุงูโูุง ูุงููฺฏุงู ุจุณุงุฑ ูุฏุฑุชููุฏ ุงุณุช. ุงู ูุงุจูุช ุงุฒ ุทุฑู ุจุณุชูโ <strong>System.Reactive NuGet</strong> ุนุฑุถู ูโุดูุฏ.</li>
</ul>
<hr>
<h2>ฺุฑุง PFXุ ๐ค</h2>
<p>ุฏุฑ ฑต ุณุงู ฺฏุฐุดุชูุ ุณุงุฒูุฏฺฏุงู CPU ุงุฒ ูพุฑุฏุงุฒูุฏูโูุง ุชฺฉโูุณุชูโุง ุจู ฺูุฏโูุณุชูโุง ููุงุฌุฑุช ฺฉุฑุฏูโุงูุฏ. ุงู ููุถูุน ุจุฑุง ูุง ุจุฑูุงููโููุณุงู ูุดฺฉูโุณุงุฒ ุงุณุชุ ุฒุฑุง ฺฉุฏูุง ุชฺฉโูุฎ ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงุฒ ูุณุชูโูุง ุจุดุชุฑ ุณุฑุนโุชุฑ ุงุฌุฑุง ููโุดููุฏ.</p>
<p>ุงุณุชูุงุฏู ุงุฒ ฺูุฏโูุณุชู ุฏุฑ ุจุณุงุฑ ุงุฒ ุจุฑูุงููโูุง ุณูุช ุณุฑูุฑ ุณุงุฏู ุงุณุชุ ฺูู ูุฑ ูุฎ ูโุชูุงูุฏ ฺฉ ุฏุฑุฎูุงุณุช ูุดุชุฑ ุฌุฏุงฺฏุงูู ุฑุง ุจูโุทูุฑ ูุณุชูู ูพุฑุฏุงุฒุด ฺฉูุฏ. ุงูุง ุฑู ุฏุณฺฉุชุงูพ ุงู ููุถูุน ุฏุดูุงุฑุชุฑ ุงุณุชุ ฺูู ูุนูููุงู ูุงุฒ ุฏุงุฑุฏ ฺฉุฏ ุฑุง ฺฉู ูุญุงุณุจุงุช ุณูฺฏู ุฏุงุฑุฏ ุจู ุงู ุตูุฑุช ุชุบุฑ ุฏูุฏ:</p>
<ol>
<li>ุชูุณู ุขู ุจู ูุทุนูโูุง ฺฉูฺฺฉโุชุฑ.</li>
<li>ุงุฌุฑุง ุงู ูุทุนูโูุง ุจูโุตูุฑุช ููุงุฒ ุจุง ฺูุฏูุฎ.</li>
<li>ุฌูุนโุขูุฑ ูุชุงุฌ ุฏุฑ ุฒูุงู ฺฉู ุขูุงุฏู ูโุดููุฏุ ุจู ุดฺฉู <strong>ุงูู ุงุฒ ูุธุฑ ูุฎโูุง</strong> ู ฺฉุงุฑุง.</li>
</ol>
<p>ุงูุจุชู ุงูุฌุงู ูููโ ุงู ูุฑุงุญู ุจุง ุณุงุฎุชุงุฑูุง ฺฉูุงุณฺฉ ฺูุฏูุฎ ููฺฉู ุงุณุชุ ุงูุง ุฏุณุชโููพุงฺฏุฑ ุงุณุชโุจูโุฎุตูุต ูุฑุงุญู ุชูุณูโุจูุฏ ู ุฌูุนโุขูุฑ ูุชุงุฌ. ูุดฺฉู ุฏฺฏุฑ ุงู ุงุณุช ฺฉู ุงุณุชุฑุงุชฺ ุฑุงุฌ <strong>locking ุจุฑุง ุงูู ูุฎโูุง</strong>ุ ููฺฏุงู ฺฉุงุฑ ููโุฒูุงู ฺูุฏ ูุฎ ุฑู ุฏุงุฏูโูุง ูุดุชุฑฺฉุ ุจุงุนุซ ุงุฌุงุฏ ุฑูุงุจุช (contention) ุฒุงุฏ ูโุดูุฏ.</p>
<p>ฺฉุชุงุจุฎุงููโูุง <strong>PFX</strong> ุฏููุงู ุจุฑุง ุญู ุงู ุณูุงุฑููุง ุทุฑุงุญ ุดุฏูโุงูุฏ.</p>
<hr>
<h2>ููุงูู PFX ๐งฉ</h2>
<p>ุจุฑูุงููโููุณ ุจุฑุง ุจูุฑูโุจุฑุฏุงุฑ ุงุฒ ฺูุฏโูุณุชู ุง ฺูุฏ ูพุฑุฏุงุฒูุฏูุ <strong>parallel programming</strong> ูุงู ุฏุงุฑุฏ. ุงู ููุถูุน ฺฉ ุฒุฑูุฌููุนู ุงุฒ ููููู ฺฏุณุชุฑุฏูโุชุฑ <strong>multithreading</strong> ุงุณุช.</p>
<p>ุฏู ุงุณุชุฑุงุชฺ ุงุตู ุจุฑุง ุชูุณู ฺฉุงุฑ ุจู ูุฎโูุง ูุฌูุฏ ุฏุงุฑุฏ:</p>
<ul>
<li><strong>Data Parallelism (ููุงุฒโุณุงุฒ ุฏุงุฏูโูุง)</strong></li>
<li><strong>Task Parallelism (ููุงุฒโุณุงุฒ ูุธุงู)</strong></li>
</ul>
<p>๐น ุฏุฑ <strong>data parallelism</strong>ุ ููุช ูุฌููุนูโุง ุงุฒ ูุธุงู ุจุงุฏ ุฑู ุฏุงุฏูโูุง ุฒุงุฏ ุงุฌุฑุง ุดููุฏุ ูุฑ ูุฎ ููุงู ูุฌููุนู ูุธุงู ุฑุง ุฑู ุจุฎุด ุงุฒ ุฏุงุฏูโูุง ุงุฌุฑุง ูโฺฉูุฏ. ุฏุฑ ูุงูุน ุฏุงุฏูโูุง ุจู ูุฎโูุง ุชูุณู ูโุดููุฏ.</p>
<p>๐น ุฏุฑ <strong>task parallelism</strong>ุ ูุง ูุธุงู ุฑุง ุชูุณู ูโฺฉููุ ุจู ุงู ูุนูุง ฺฉู ูุฑ ูุฎ ูุธููโุง ูุชูุงูุช ุฑุง ุงุฌุฑุง ูโฺฉูุฏ.</p>
<p>ุจูโุทูุฑ ฺฉูุ <strong>data parallelism</strong> ุณุงุฏูโุชุฑ ุงุณุช ู ุฑู ุณุฎุชโุงูุฒุงุฑูุง ุจุง ูุงุจูุช ููุงุฒโุณุงุฒ ุจุงูุง ุจูุชุฑ ููุงุณโูพุฐุฑ ุงุณุชุ ุฒุฑุง ุฏุงุฏูโูุง ูุดุชุฑฺฉ ุฑุง ฺฉุงูุด ูโุฏูุฏ ุง ุญุฐู ูโฺฉูุฏ (ุฏุฑ ูุชุฌู ูุดฺฉูุงุช ุฑูุงุจุช ู ุงูู ูุฎโูุง ูุฒ ฺฉูุชุฑ ูโุดูุฏ). ุนูุงููโุจุฑ ุงูุ ูุนูููุงู ุฏุงุฏูโูุง ุจุด ุงุฒ ูุธุงู ุฌุฏุงฺฏุงูู ูุณุชูุฏุ ู ุงู ุงูุฑ ูพุชุงูุณู ููุงุฒโุณุงุฒ ุฑุง ุงูุฒุงุด ูโุฏูุฏ.</p>
<p><strong>Data parallelism</strong> ููฺูู ุฒูููโุณุงุฒ <strong>structured parallelism</strong> ุงุณุชุ ุจู ุงู ูุนูุง ฺฉู ฺฉุงุฑูุง ููุงุฒ ุฏุฑ ฺฉ ููุทู ุงุฒ ุจุฑูุงูู ุดุฑูุน ู ุฏุฑ ููุงูโุฌุง ูุฒ ูพุงุงู ูโุงุจูุฏ. ุฏุฑ ููุงุจูุ <strong>task parallelism</strong> ูุนูููุงู <strong>unstructured</strong> ุงุณุชุ ุนู ฺฉุงุฑูุง ููุงุฒ ููฺฉู ุงุณุช ุฏุฑ ุจุฎุดโูุง ูพุฑุงฺฉูุฏูโุง ุงุฒ ุจุฑูุงูู ุดุฑูุน ู ูพุงุงู ุงุจูุฏ.</p>
<p>๐ <strong>Structured parallelism</strong> ุณุงุฏูโุชุฑุ ฺฉูโุฎุทุงุชุฑุ ู ุงูฺฉุงู ูุงฺฏุฐุงุฑ ฺฉุงุฑูุง ุฏุดูุงุฑ ูุงููุฏ ุชูุณูโุจูุฏุ ููุงููฺฏ ูุฎโูุง ู ุญุช ุฌูุนโุขูุฑ ูุชุงุฌ ุฑุง ุจู ฺฉุชุงุจุฎุงููโูุง ูุฑุงูู ูโฺฉูุฏ.</p>
<hr>
<h2>ุงุฌุฒุง PFX ๐๏ธ</h2>
<p>ฺฉุชุงุจุฎุงููโ <strong>PFX</strong> ุงุฒ ุฏู ูุงูโ ุงุตู ุชุดฺฉู ุดุฏู ุงุณุช (ูุทุงุจู ุดฺฉู 22-1):</p>
<ul>
<li>
<p><strong>ูุงู ุจุงูุงุชุฑ</strong> โ ุดุงูู ุฏู API ุจุฑุง data parallelism ุณุงุฎุชุงุฑุงูุชู:</p>
<ul>
<li><strong>PLINQ</strong></li>
<li><strong>ฺฉูุงุณ Parallel</strong></li>
</ul>
</li>
<li>
<p><strong>ูุงู ูพุงูโุชุฑ</strong> โ ุดุงูู ฺฉูุงุณโูุง task parallelism ุจูโุนูุงูู ูุฌููุนูโุง ุงุฒ ุณุงุฎุชุงุฑูุง ฺฉูฺฉ ุจุฑุง ูุนุงูุชโูุง ุจุฑูุงููโููุณ ููุงุฒ.</p>
</li>
</ul>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-1.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>PLINQ โจ</h3>
<p><strong>PLINQ</strong> ุบูโุชุฑู ูุงุจูุชโูุง ุฑุง ุงุฑุงุฆู ูโุฏูุฏ: ุงู ุงุจุฒุงุฑ ุชูุงู ูุฑุงุญู ููุงุฒโุณุงุฒ ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุฏูุฏโุงุฒ ุฌููู:</p>
<ul>
<li>ุชูุณู ฺฉุงุฑ ุจู ูุธุงู (tasks)</li>
<li>ุงุฌุฑุง ุงู ูุธุงู ุฑู ูุฎโูุง (threads)</li>
<li>ุฌูุนโุขูุฑ ูุชุงุฌ ุฏุฑ ฺฉ ุชูุงู ุฎุฑูุฌ ูุงุญุฏ</li>
</ul>
<p>ุจู ููู ุฏูู ุขู ุฑุง <strong>Declarative</strong> ูโูุงููุฏโฺูู ุดูุง ููุท ุงุนูุงู ูโฺฉูุฏ ฺฉู ูโุฎูุงูุฏ ฺฉุงุฑุชุงู ููุงุฒโุณุงุฒ ุดูุฏ (ุจูโุตูุฑุช ฺฉ ูพุฑุณโูโุฌู LINQ ุณุงุฎุชุงุฑุจูุฏโุดุฏู) ู ุฎูุฏู <strong>runtime</strong> ุฌุฒุฆุงุช ูพุงุฏูโุณุงุฒ ุฑุง ูุฏุฑุช ูโฺฉูุฏ.</p>
<p>ุฏุฑ ููุงุจูุ ุฑูฺฉุฑุฏูุง ุฏฺฏุฑ <strong>Imperative</strong> ูุณุชูุฏุ ุนู ุดูุง ุจุงุฏ ุจูโุทูุฑ ุตุฑุญ ฺฉุฏ ุจููุณุฏ ุชุง ฺฉุงุฑ ุฑุง ุชูุณู ุง ูุชุงุฌ ุฑุง ุฌูุนโุขูุฑ ฺฉูุฏ.</p>
<p>ููุงูโุทูุฑ ฺฉู ุฎูุงุตูโ ุฒุฑ ูุดุงู ูโุฏูุฏ:</p>
<ul>
<li>ุฏุฑ ููุฑุฏ <strong>ฺฉูุงุณ Parallel</strong> โ ุดูุง ุจุงุฏ ูุชุงุฌ ุฑุง ุฎูุฏุชุงู ุฌูุนโุขูุฑ ฺฉูุฏ.</li>
<li>ุฏุฑ ููุฑุฏ <strong>ุณุงุฎุชุงุฑูุง task parallelism</strong> โ ุดูุง ุจุงุฏ ุนูุงูู ุจุฑ ุฌูุนโุขูุฑ ูุชุงุฌุ ุชูุณู ฺฉุงุฑ ุฑุง ูุฒ ุฎูุฏุชุงู ุงูุฌุงู ุฏูุฏ.</li>
</ul>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-2.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ูุฌููุนูโูุง Concurrent ู Spinning Primitives โ๏ธ</h3>
<p><strong>ูุฌููุนูโูุง concurrent</strong> ู <strong>spinning primitives</strong> ุจู ุดูุง ุฏุฑ ูุนุงูุชโูุง ุณุทุญ ูพุงูโุชุฑ ุจุฑูุงููโููุณ ููุงุฒ ฺฉูฺฉ ูโฺฉููุฏ. ุงููุช ุงู ุงุจุฒุงุฑูุง ุงุฒ ุขูุฌุงุณุช ฺฉู <strong>PFX</strong> ููโุชููุง ุจุฑุง ุณุฎุชโุงูุฒุงุฑ ุงูุฑูุฒ ุจูฺฉู ุจุฑุง ูุณูโูุง ุขูุฏูโ ูพุฑุฏุงุฒูุฏูโูุง ุจุง ุชุนุฏุงุฏ ูุณุชูโูุง ุจุณุงุฑ ุจุดุชุฑ ุทุฑุงุญ ุดุฏู ุงุณุช.</p>
<p>ูุฑุถ ฺฉูุฏ ุจุงุฏ ฺฉ ุชูุฏู ฺูุจ ุฎุฑุฏุดุฏู ุฑุง ุฌุงุจูโุฌุง ฺฉูุฏ ู ณฒ ฺฉุงุฑฺฏุฑ ุฏุฑ ุงุฎุชุงุฑ ุฏุงุฑุฏุ ุจุฒุฑฺฏโุชุฑู ฺุงูุด ุงู ุงุณุช ฺฉู ฺฉุงุฑฺฏุฑุงู ุจุฏูู ูุฒุงุญูุช ุจุฑุง ฺฉุฏฺฏุฑ ุจุชูุงููุฏ ฺฉุงุฑ ฺฉููุฏ. ุฏููุง ููู ููุถูุน ุฏุฑ ุชูุณู ฺฉ ุงูฺฏูุฑุชู ุจู ณฒ ูุณุชู ุฑุฎ ูโุฏูุฏ: ุงฺฏุฑ ุงุฒ <strong>lockูุง ูุนููู</strong> ุจุฑุง ูุญุงูุธุช ุงุฒ ููุงุจุน ูุดุชุฑฺฉ ุงุณุชูุงุฏู ุดูุฏุ ููู ุดุฏูโูุง (blocking) ุจุงุนุซ ูโุดููุฏ ุชููุง ุจุฎุด ุงุฒ ูุณุชูโูุง ูุงูุนุงู ูุนุงู ุจุงุดูุฏ.</p>
<p>๐ ูุฌููุนูโูุง concurrent ุจูโุทูุฑ ุฎุงุต ุจุฑุง ุฏุณุชุฑุณโูุง ุจุณุงุฑ ููโุฒูุงู ุชูุธู ุดุฏูโุงูุฏุ ุจุง ุชูุฑฺฉุฒ ุจุฑ <strong>ุญุฏุงููโุณุงุฒ ุง ุญุฐู ููู ุดุฏู</strong>.
ฺฉูุงุณ <strong>Parallel</strong> ู ููฺูู <strong>PLINQ</strong> ุฎูุฏุดุงู ุจุฑุง ูุฏุฑุช ฺฉุงุฑ ุจูโุตูุฑุช ฺฉุงุฑุขูุฏุ ูุชฺฉ ุจุฑ ููู ูุฌููุนูโูุง ู <strong>spinning primitives</strong> ูุณุชูุฏ.</p>
<hr>
<h2>ฺฉุงุฑุจุฑุฏูุง ุฏฺฏุฑ PFX ๐๏ธ</h2>
<p>ุณุงุฎุชุงุฑูุง ุจุฑูุงููโููุณ ููุงุฒ ุชููุง ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ฺูุฏโูุณุชู ูุณุชูุฏุ ุจูฺฉู ุฏุฑ ุณูุงุฑููุง ุฏฺฏุฑ ูู ููุฏ ูุงูุน ูโุดููุฏ:</p>
<ul>
<li>ููุช ุจู ฺฉ <strong>queue</strong>ุ <strong>stack</strong> ุง <strong>dictionary</strong> ุงูู ุงุฒ ูุธุฑ ูุฎโูุง (thread-safe) ูุงุฒ ุฏุงุฑุฏ.</li>
<li><strong>BlockingCollection</strong> ุฑุงู ุณุงุฏู ุจุฑุง ูพุงุฏูโุณุงุฒ ุณุงุฎุชุงุฑูุง ุชููุฏฺฉููุฏู/ูุตุฑูโฺฉููุฏู ูุฑุงูู ูโฺฉูุฏ ู ููฺูู ุฑูุด ููุงุณุจ ุจุฑุง ูุญุฏูุฏุณุงุฒ ููโุฒูุงู ุงุณุช.</li>
<li><strong>Tasks</strong> ูพุงูโ ุงุตู ุจุฑูุงููโููุณ ูุงููฺฏุงู ูุณุชูุฏ (ููุงูโุทูุฑ ฺฉู ุฏุฑ ูุตู ฑด ุฏุฏู).</li>
</ul>
<hr>
<h2>ฺู ุฒูุงู ุจุงุฏ ุงุฒ PFX ุงุณุชูุงุฏู ฺฉุฑุฏุ โฑ๏ธ</h2>
<p>ููุฑุฏ ุงุตู ุงุณุชูุงุฏู ุงุฒ <strong>PFX</strong>ุ <strong>ุจุฑูุงููโููุณ ููุงุฒ</strong> ุงุณุช: ุนู ุจูุฑูโุจุฑุฏุงุฑ ุงุฒ ฺูุฏโูุณุชู ุจุฑุง ุณุฑุนุชโุจุฎุดุฏู ุจู ฺฉุฏูุง ูุญุงุณุจุงุช ุณูฺฏู.</p>
<p>ฺฉ ุงุฒ ฺุงูุดโูุง ููู ุฏุฑ ุจุฑูุงููโููุณ ููุงุฒุ <strong>ูุงููู Amdahl</strong> ุงุณุช. ุงู ูุงููู ูโฺฏูุฏ ุจุดุชุฑู ุจูุจูุฏ ฺฉุงุฑุง ุงุฒ ููุงุฒโุณุงุฒุ ุชูุณุท ุจุฎุด ุงุฒ ฺฉุฏ ฺฉู ุจุงุฏ ุจูโุตูุฑุช ุชุฑุชุจ (sequential) ุงุฌุฑุง ุดูุฏ ูุญุฏูุฏ ูโฺฏุฑุฏุฏ.</p>
<p>๐ ูุซุงู: ุงฺฏุฑ ุชููุง ุฏูุณูู ุฒูุงู ุงุฌุฑุง ฺฉ ุงูฺฏูุฑุชู ูุงุจู ููุงุฒโุณุงุฒ ุจุงุดุฏุ ุญุช ุจุง ุจโููุงุช ูุณุชู ููโุชูุงูุฏ ุจุด ุงุฒ ุณู ุจุฑุงุจุฑ ุงูุฒุงุด ฺฉุงุฑุง ุฏุงุดุชู ุจุงุดุฏ.</p>
<p>ุจูุงุจุฑุงูุ ูพุด ุงุฒ ุงุฏุงูู ุจุงุฏ ูุทูุฆู ุดูุฏ ฺฉู ฺฏููฺฏุงู ูุงูุนุงู ุฏุฑ ุจุฎุด ุงุฒ ฺฉุฏ ุงุณุช ฺฉู ูุงุจูุช ููุงุฒโุณุงุฒ ุฏุงุฑุฏ. ููฺูู ุจุงุฏ ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง ุงุตูุงู ฺฉุฏ ุดูุง ูุงุฒ ุจู ูุญุงุณุจุงุช ุณูฺฏู ุฏุงุฑุฏ ุง ุฎุฑโุฒุฑุง <strong>ุจูููโุณุงุฒ</strong> ุงุบูุจ ุณุงุฏูโุชุฑู ู ูุคุซุฑุชุฑู ุฑุงูฺฉุงุฑ ุงุณุช.
ุงูุจุชู ุงู ููุถูุน ฺฉ ูุนุงููู ุฏุงุฑุฏุ ฺูู ุจุฑุฎ ุฑูุดโูุง ุจูููโุณุงุฒ ูโุชูุงููุฏ ููุงุฒโุณุงุฒ ฺฉุฏ ุฑุง ุณุฎุชโุชุฑ ฺฉููุฏ.</p>
<p>ุจุดุชุฑู ุณูุฏ ุฏุฑ ููุงุฑุฏ ุจูโุฏุณุช ูโุขุฏ ฺฉู ุจู ุขูโูุง <strong>embarrassingly parallel problems</strong> ูโฺฏููุฏโุนู ุฒูุงู ฺฉู ฺฉ ฺฉุงุฑ ุจูโุฑุงุญุช ูโุชูุงูุฏ ุจู ูุธุงู ุฌุฏุงฺฏุงูู ุชูุณู ุดูุฏ ู ูุฑฺฉุฏุงู ุจูโุทูุฑ ูุณุชูู ู ฺฉุงุฑุขูุฏ ุงุฌุฑุง ุดููุฏ.</p>
<p>๐ท ูููููโูุง:</p>
<ul>
<li>ุจุณุงุฑ ุงุฒ ูุธุงู ูพุฑุฏุงุฒุด ุชุตูุฑ</li>
<li>ray tracing</li>
<li>ุฑูุดโูุง brute-force ุฏุฑ ุฑุงุถุงุช ุง ุฑูุฒูฺฏุงุฑ</li>
</ul>
<p>ูููููโ ฺฉ <strong>ูุดฺฉู ุบุฑ embarrassingly parallel</strong>ุ ูพุงุฏูโุณุงุฒ ฺฉ ูุณุฎูโ ุจููู ุงุฒ ุงูฺฏูุฑุชู <strong>quicksort</strong> ุงุณุชโฺฉู ุจุฑุง ุฑุณุฏู ุจู ูุชุฌู ุฎูุจ ูุงุฒููุฏ ูฺฉุฑ ุจุดุชุฑ ุงุณุช ู ุดุงุฏ ุจู <strong>unstructured parallelism</strong> ูุงุฒ ุฏุงุดุชู ุจุงุดุฏ.</p>
<hr>
<h2>PLINQ โก</h2>
<p><strong>PLINQ</strong> ูพุฑุณโูโุฌููุง LINQ ูุญู ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ููุงุฒโุณุงุฒ ูโฺฉูุฏ.
ูุฒุช ุจุฒุฑฺฏ ุขู ุงู ุงุณุช ฺฉู ุจุงุฑ ุชูุณู ฺฉุงุฑ ู ุฌูุนโุขูุฑ ูุชุงุฌ ุฑุง ุจูโุทูุฑ ฺฉุงูู ุจู <strong>.NET</strong> ูุงฺฏุฐุงุฑ ูโฺฉูุฏ.</p>
<p>ุจุฑุง ุงุณุชูุงุฏู ุงุฒ PLINQุ ฺฉุงูุณุช ุฑู ุชูุงู ูุฑูุฏุ ูุชุฏ <strong>AsParallel()</strong> ุฑุง ูุฑุงุฎูุงู ฺฉุฑุฏู ู ุณูพุณ ูพุฑุณโูุฌู LINQ ุฑุง ูุซู ููุดู ุงุฏุงูู ุฏูุฏ.</p>
<p>ูููููโ ุฒุฑ ุนุฏุฏูุง ุงูู ุจู ณ ุชุง ฑฐฐ,ฐฐฐ ุฑุง ุจุง ุงุณุชูุงุฏู ฺฉุงูู ุงุฒ ุชูุงู ูุณุชูโูุง ูุงุดู ูุญุงุณุจู ูโฺฉูุฏ:</p>
<pre><code class="language-csharp">// ูุญุงุณุจู ุงุนุฏุงุฏ ุงูู ุจุง ฺฉ ุงูฺฏูุฑุชู ุณุงุฏู (ุบุฑุจููู).
IEnumerable&lt;int&gt; numbers = Enumerable.Range (3, 100000 - 3);

var parallelQuery =
    from n in numbers.AsParallel()
    where Enumerable.Range (2, (int) Math.Sqrt(n)).All (i =&gt; n % i &gt; 0)
    select n;

int[] primes = parallelQuery.ToArray();
</code></pre>
<p>๐ ูุชุฏ <strong>AsParallel</strong> ฺฉ <strong>extension method</strong> ุฏุฑ <strong>System.Linq.ParallelEnumerable</strong> ุงุณุช. ุงู ูุชุฏ ูุฑูุฏ ุฑุง ุฏุฑ ฺฉ ุชูุงู ุจุฑ ูพุงูโ <strong>ParallelQuery<TSource></strong> ูโูพฺุฏ. ููู ููุถูุน ุจุงุนุซ ูโุดูุฏ ุนููฺฏุฑูุง ูพุฑุณโูุฌู LINQ ฺฉู ุฏุฑ ุงุฏุงูู ูุฑุงุฎูุงู ูโฺฉูุฏุ ุจู ูุฌููุนูโุง ุฌุงฺฏุฒู ุงุฒ ูุชุฏูุง ุชูุณุนูโุงูุชู ุฏุฑ <strong>ParallelEnumerable</strong> ูุชุตู ุดููุฏ.</p>
<p>ุงู ูุชุฏูุง ูพุงุฏูโุณุงุฒโูุง ููุงุฒ ุงุฒ ูุฑ ฺฉ ุงุฒ ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ ูพุฑุณโูุฌู ุฑุง ูุฑุงูู ูโฺฉููุฏ. ุงุณุงุณ ฺฉุงุฑ ุขูโูุง ุงู ุงุณุช ฺฉู ุชูุงู ูุฑูุฏ ุฑุง ุจู ุจุฎุดโูุง ุชูุณู ูโฺฉููุฏ ุชุง ุฑู ูุฎโูุง ูุฎุชูู ุงุฌุฑุง ุดููุฏ ู ุณูพุณ ูุชุงุฌ ุฑุง ุฏูุจุงุฑู ุฏุฑ ฺฉ ุชูุงู ุฎุฑูุฌ ูุงุญุฏ ฺฏุฑุฏุขูุฑ ฺฉููุฏ (ูุทุงุจู ุดฺฉู 22-2).</p>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-3.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ุงุณุชูุงุฏู ุงุฒ AsSequential() ๐</h3>
<p>ูุฑุงุฎูุงู <strong>AsSequential()</strong> ุจุงุนุซ ูโุดูุฏ ฺฉู ฺฉ ุชูุงู <strong>ParallelQuery</strong> ุจุงุฒ (unwrap) ุดูุฏุ ุจูโุทูุฑโฺฉู ุนููฺฏุฑูุง ูพุฑุณโูโุฌู (query operators) ุจุนุฏ ุจู ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ LINQ ูุชุตู ุดุฏู ู ุจูโุตูุฑุช ุชุฑุชุจ (sequential) ุงุฌุฑุง ุดููุฏ.</p>
<p>ุงู ููุถูุน ุฒูุงู ุถุฑูุฑ ุงุณุช ฺฉู:</p>
<ul>
<li>ุจุฎูุงูุฏ ูุชุฏ ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ฺฉู ุฏุงุฑุง <strong>ุงุซุฑ ุฌุงูุจ (side effect)</strong> ุจุงุดุฏ.</li>
<li>ุง ูุชุฏ ููุฑุฏ ูุธุฑ <strong>thread-safe</strong> ูุจุงุดุฏ.</li>
</ul>
<p>ุจุฑุง ุนููฺฏุฑูุง ูพุฑุณโูโุฌู ฺฉู <strong>ุฏู ุชูุงู ูุฑูุฏ</strong> ุฏุฑุงูุช ูโฺฉููุฏ (ูุซู <strong>Join, GroupJoin, Concat, Union, Intersect, Except ู Zip</strong>) ุจุงุฏ ุฑู ูุฑ ุฏู ุชูุงู ูุฑูุฏุ ูุชุฏ <strong>AsParallel()</strong> ุงุนูุงู ุดูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุฎุทุง (exception) ูพุฑุชุงุจ ุฎูุงูุฏ ุดุฏ.</p>
<p>ูฺฉุชู: ูุงุฒ ูุณุช ุฏุฑ ุทูู ูพุดุฑูุช ฺฉ ูพุฑุณโูโุฌู ูุฏุงู <strong>AsParallel()</strong> ุฑุง ุงุนูุงู ฺฉูุฏุ ุฒุฑุง ุนููฺฏุฑูุง ูพุฑุณโูโุฌู PLINQ ุฎูุฏุดุงู ฺฉ <strong>ParallelQuery</strong> ุฏฺฏุฑ ุจุฑูโฺฏุฑุฏุงููุฏ. ุฏุฑ ูุงูุนุ ูุฑุงุฎูุงู ุฏูุจุงุฑูโ AsParallel ูุงฺฉุงุฑุขูุฏ ุงุณุชุ ฺูู ุจุงุนุซ ุงุฏุบุงู (merge) ู ุชูุณูโุจูุฏ ูุฌุฏุฏ ูพุฑุณโูโุฌู ูโุดูุฏ:</p>
<pre><code class="language-csharp">mySequence.AsParallel()           // ุชูุงู ุฑุง ุจู ParallelQuery&lt;int&gt; ูโูพฺุฏ
          .Where (n =&gt; n &gt; 100)   // ฺฉ ParallelQuery&lt;int&gt; ุฏฺฏุฑ ุชููุฏ ูโฺฉูุฏ
          .AsParallel()           // ุบุฑุถุฑูุฑ ู ูุงฺฉุงุฑุขูุฏ!
          .Select (n =&gt; n * n);
</code></pre>
<hr>
<h3>ูุญุฏูุฏุชโูุง ู ูฺฉุงุช PLINQ โ๏ธ</h3>
<ul>
<li>ูููโ ุนููฺฏุฑูุง ูพุฑุณโูโุฌู ุจูโุทูุฑ ูุคุซุฑ ูุงุจู ููุงุฒโุณุงุฒ ูุณุชูุฏ. ุจุฑุง ุงู ููุงุฑุฏ (ุจุฎุด โPLINQ Limitationsโ ุฏุฑ ุตูุญู นณธ)ุ <strong>PLINQ</strong> ุนููฺฏุฑ ุฑุง ุจูโุตูุฑุช ุชุฑุชุจ ุงุฌุฑุง ูโฺฉูุฏ.</li>
<li>ุงฺฏุฑ PLINQ ุชุดุฎุต ุฏูุฏ ุณุฑุจุงุฑ ููุงุฒโุณุงุฒ ุจุดุชุฑ ุงุฒ ุณูุฏ ุขู ุงุณุชุ ูพุฑุณโูโุฌู ุฑุง ุจูโุตูุฑุช ุชุฑุชุจ ุงุฌุฑุง ุฎูุงูุฏ ฺฉุฑุฏ.</li>
<li><strong>PLINQ ููุท ุฑู ูุฌููุนูโูุง ูุญู ฺฉุงุฑ ูโฺฉูุฏ</strong>ุ ูุซูุงู ุจุง <strong>Entity Framework</strong> ุณุงุฒฺฏุงุฑ ูุณุชุ ฺูู ุฏุฑ ุขู ุญุงูุช LINQ ุจู SQL ุชุฑุฌูู ูโุดูุฏ ู ุฑู ุณุฑูุฑ ูพุงฺฏุงู ุฏุงุฏู ุงุฌุฑุง ุฎูุงูุฏ ุดุฏ. ุจุง ุงู ุญุงู ูโุชูุงูุฏ PLINQ ุฑุง ุจุฑุง ูพุฑุณโูโุฌููุง ูุญู ุฑู ูุชุงุฌ ุญุงุตู ุงุฒ ุฏุชุงุจุณ ุจูโฺฉุงุฑ ุจุจุฑุฏ.</li>
<li>ุงฺฏุฑ ฺฉ ูพุฑุณโูโุฌู PLINQ ุงุณุชุซูุง ูพุฑุชุงุจ ฺฉูุฏุ ุงู ุฎุทุง ุจูโุดฺฉู <strong>AggregateException</strong> ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดูุฏุ ฺฉู ุฎุงุตุช <strong>InnerExceptions</strong> ุขู ุฎุทุง ุง ุฎุทุงูุง ูุงูุน ุฑุง ุฏุฑ ุฎูุฏ ูฺฏู ูโุฏุงุฑุฏ (ุจุฑุง ุฌุฒุฆุงุชุ ุจู โWorking with AggregateExceptionโ ุฏุฑ ุตูุญู นถด ูุฑุงุฌุนู ฺฉูุฏ).</li>
</ul>
<hr>
<h3>ฺุฑุง AsParallel ุจูโุตูุฑุช ูพุดโูุฑุถ ูุนุงู ูุณุชุ ๐ค</h3>
<p>ุจุง ุชูุฌู ุจู ุงูฺฉู <strong>AsParallel</strong> ูพุฑุณโูโุฌููุง LINQ ุฑุง ุจูโุทูุฑ ุดูุงู ููุงุฒโุณุงุฒ ูโฺฉูุฏุ ุงู ูพุฑุณุด ูพุด ูโุขุฏ: ฺุฑุง ูุงฺฉุฑูุณุงูุช ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ LINQ ุฑุง ุจูโุทูุฑ ูพุดโูุฑุถ ููุงุฒ ูฺฉุฑุฏ ู PLINQ ุฑุง ุจู ุญุงูุช ูพุดโูุฑุถ ุชุจุฏู ูฺฉุฑุฏุ</p>
<p>ุฏูุงู ุงู ุฑูฺฉุฑุฏ opt-in ุนุจุงุฑุชูุฏ ุงุฒ:</p>
<ol>
<li>
<p>ุจุฑุง ุงูฺฉู PLINQ ููุฏ ุจุงุดุฏุ ุจุงุฏ ุญุฌู ูุงุจูโุชูุฌู ุงุฒ ฺฉุงุฑ ูุญุงุณุจุงุช ุณูฺฏู ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.
ุงฺฉุซุฑ ูพุฑุณโูโุฌููุง LINQ-to-Objects ุฎู ุณุฑุน ุงุฌุฑุง ูโุดููุฏุ ุฏุฑ ุงู ุญุงูุช ููโุชููุง ููุงุฒโุณุงุฒ ุบุฑุถุฑูุฑ ุงุณุชุ ุจูฺฉู ุณุฑุจุงุฑ ุชูุณูโุจูุฏุ ุฌูุนโุขูุฑ ู ููุงููฺฏ ูุฎโูุง ุงุถุงู ูโุชูุงูุฏ ุงุฌุฑุง ฺฉุฏ ุฑุง ฺฉูุฏุชุฑ ฺฉูุฏ.</p>
</li>
<li>
<p>ุชูุงูุชโูุง ุฑูุชุงุฑ:</p>
<ul>
<li>ุฎุฑูุฌ ฺฉ ูพุฑุณโูโุฌู PLINQ (ุจูโุทูุฑ ูพุดโูุฑุถ) ูโุชูุงูุฏ ุงุฒ ูุธุฑ <strong>ุชุฑุชุจ ุนูุงุตุฑ</strong> ุจุง LINQ ุนุงุฏ ูุชูุงูุช ุจุงุดุฏ (ุจุฎุด โPLINQ and Orderingโ ุฏุฑ ุตูุญู นณท).</li>
<li>PLINQ ุงุณุชุซูุงูุง ุฑุง ุฏุฑูู ฺฉ <strong>AggregateException</strong> ูโูพฺุฏ (ฺูู ููฺฉู ุงุณุช ฺูุฏ ุงุณุชุซูุง ุจูโุทูุฑ ููโุฒูุงู ุฑุฎ ุฏููุฏ).</li>
<li>ุงฺฏุฑ ูพุฑุณโูโุฌู ูุชุฏูุง ุบุฑ thread-safe ุฑุง ูุฑุงุฎูุงู ฺฉูุฏุ ูุชุงุฌ PLINQ ูุงุจูโุงุนุชูุงุฏ ูุฎูุงููุฏ ุจูุฏ.</li>
</ul>
</li>
<li>
<p>PLINQ ูุงุจูุชโูุง ูุชุนุฏุฏ ุจุฑุง <strong>ุชูุธู ู ุจูููโุณุงุฒ</strong> ุฏุงุฑุฏ. ุงูุฒูุฏู ุงู ูพฺุฏฺฏโูุง ุจู API ุงุณุชุงูุฏุงุฑุฏ LINQ-to-Objects ุจุงุนุซ ุดููุบ ู ุญูุงุณโูพุฑุช ูโุดุฏ.</p>
</li>
</ol>
<hr>
<h3>ุฑูุชุงุฑ ุงุฌุฑุง ููุงุฒ (Parallel Execution Ballistics) ๐ฏ</h3>
<p>ูุงููุฏ ูพุฑุณโูโุฌููุง ุนุงุฏ LINQุ ูพุฑุณโูโุฌููุง <strong>PLINQ</strong> ูุฒ <strong>lazy evaluation</strong> ุฏุงุฑูุฏ. ุนู ุงุฌุฑุง ููุท ุฒูุงู ุขุบุงุฒ ูโุดูุฏ ฺฉู ุดุฑูุน ุจู ูุตุฑู ูุชุงุฌ ฺฉูุฏโูุนูููุงู ุจุง ฺฉ ุญูููโ <strong>foreach</strong> (ุง ุจุง ฺฉ ุนููฺฏุฑ ุชุจุฏู ูุซู <strong>ToArray</strong> ุง ุนููฺฏุฑ ฺฉู ฺฉ ุนูุตุฑ/ููุฏุงุฑ ูููุฑุฏ ุจุฑูโฺฏุฑุฏุงูุฏ).</p>
<p>ุงูุง ููฺฏุงู ุดูุงุฑุด ูุชุงุฌุ ูุญููโ ุงุฌุฑุง ุจุง ูพุฑุณโูโุฌููุง ุชุฑุชุจ ูุนููู ูุชูุงูุช ุงุณุช:</p>
<ul>
<li>ุฏุฑ ูพุฑุณโูโุฌู ุชุฑุชุจุ ูููโฺุฒ ฺฉุงููุงู ุชูุณุท ูุตุฑูโฺฉููุฏู ู ุจูโุตูุฑุช <strong>pull</strong> ุงูุฌุงู ูโุดูุฏุ ุนู ูุฑ ุนูุตุฑ ุฏููุงู ุฒูุงู ูุงฺฉุด ูโุดูุฏ ฺฉู ูุตุฑูโฺฉููุฏู ุจู ุขู ูุงุฒ ุฏุงุฑุฏ.</li>
<li>ุฏุฑ ูพุฑุณโูโุฌู ููุงุฒุ ูุฎโูุง ูุณุชูู ุนูุงุตุฑ ูุฑูุฏ ุฑุง ฺฉู ุฒูุฏุชุฑ ุงุฒ ุฒูุงู ูุงุฒ ูุตุฑูโฺฉููุฏู ูุงฺฉุด ูโฺฉููุฏ (ูุซู ุชููโูพุฑููุชุฑ ุจุฑุง ูุฌุฑุงู ุงุฎุจุงุฑ ๐บ). ุณูพุณ ุงู ุนูุงุตุฑ ุฏุฑ ุทูู ุฒูุฌุฑูโ ูพุฑุณโูโุฌู ุจูโุตูุฑุช ููุงุฒ ูพุฑุฏุงุฒุด ูโุดููุฏ. ูุชุงุฌ ุฏุฑ ฺฉ ุจุงูุฑ ฺฉูฺฺฉ ูฺฏูโุฏุงุฑ ูโุดููุฏ ุชุง ุฏุฑ ูุญุธู ุจุฑุง ูุตุฑูโฺฉููุฏู ุขูุงุฏู ุจุงุดูุฏ.</li>
<li>ุงฺฏุฑ ูุตุฑูโฺฉููุฏู ูฺฉุซ ฺฉูุฏ ุง ุฒูุฏุชุฑ ุงุฒ ุดูุงุฑุด ฺฉุงูู ุฎุงุฑุฌ ุดูุฏุ ูพุฑุฏุงุฒุดฺฏุฑ ูพุฑุณโูโุฌู ูู ูุชููู ุง ูฺฉุซ ูโฺฉูุฏ ุชุง ุงุฒ ูุฏุฑ ุฑูุชู CPU ู ุญุงูุธู ุฌููฺฏุฑ ุดูุฏ.</li>
</ul>
<hr>
<h3>ุชูุธู ุจุงูุฑ ุฏุฑ PLINQ ๐ฆ</h3>
<p>ูโุชูุงูุฏ ุฑูุชุงุฑ ุจุงูุฑ PLINQ ุฑุง ุจุง ูุฑุงุฎูุงู <strong>WithMergeOptions</strong> ุจุนุฏ ุงุฒ <strong>AsParallel</strong> ุชุบุฑ ุฏูุฏ:</p>
<ul>
<li><strong>AutoBuffered (ูพุดโูุฑุถ)</strong> โ ูุนูููุงู ุจูุชุฑู ฺฉุงุฑุง ฺฉู ุฑุง ูโุฏูุฏ.</li>
<li><strong>NotBuffered</strong> โ ุจุงูุฑ ุฑุง ุบุฑูุนุงู ูโฺฉูุฏ ู ุจุฑุง ููุงูุน ููุงุณุจ ุงุณุช ฺฉู ูโุฎูุงูุฏ ูุชุงุฌ ุฑุง ุณุฑุนโุชุฑ ู ุจูุงูุงุตูู ุจุจูุฏ.</li>
<li><strong>FullyBuffered</strong> โ ฺฉู ูุฌููุนู ูุชุงุฌ ุฑุง ูุจู ุงุฒ ุงุฑุงุฆู ุจู ูุตุฑูโฺฉููุฏู ุฐุฎุฑู ูโฺฉูุฏ (ุนููฺฏุฑูุง ูุงููุฏ <strong>OrderBy</strong> ู <strong>Reverse</strong> ู ููฺูู ุนููฺฏุฑูุง ูุฑุจูุท ุจู <strong>element</strong>ุ <strong>aggregation</strong> ู <strong>conversion</strong> ุฐุงุชุงู ูููโฺฏููู ุนูู ูโฺฉููุฏ).</li>
</ul>
<h3>๐ PLINQ ู ุชุฑุชุจ (Ordering)</h3>
<p>ฺฉ ุงุฒ ุนูุงุฑุถ ุฌุงูุจ ููุงุฒโุณุงุฒ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุงู ุงุณุช ฺฉู ููฺฏุงู ุฌูุนโุขูุฑ ูุชุงุฌุ <strong>ูุฒูู ูุฏุงุฑุฏ ุชุฑุชุจ ุนูุงุตุฑ ูุซู ุญุงูุช ุงููู ุจุงู ุจูุงูุฏ</strong> (ุจู ุดฺฉู 22-2 ูุฑุงุฌุนู ฺฉูุฏ).
ุจู ุจุงู ุฏฺฏุฑุ ุชุถูู <strong>ุญูุธ ุชุฑุชุจ</strong> ุฏุฑ LINQ ุจุฑุง ุชูุงูโูุง ุฏุฑ PLINQ ุจุฑูุฑุงุฑ ูุณุช.</p>
<p>ุงฺฏุฑ ุจู <strong>ุญูุธ ุชุฑุชุจ</strong> ูุงุฒ ุฏุงุดุชู ุจุงุดุฏุ ูโุชูุงูุฏ ูพุณ ุงุฒ <code>AsParallel()</code> ุงุฒ <code>AsOrdered()</code> ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre><code class="language-csharp">myCollection.AsParallel().AsOrdered()...
</code></pre>
<p>ุงุณุชูุงุฏู ุงุฒ <code>AsOrdered</code> ููฺฏุงู ฺฉุงุฑ ุจุง ูุฌููุนูโูุง ุจุฒุฑฺฏ ุจุงุนุซ ฺฉุงูุด ฺฉุงุฑุง ูโุดูุฏุ ฺูู PLINQ ุจุงุฏ ูููุนุช ุงุตู ูุฑ ุนูุตุฑ ุฑุง ุฏูุจุงู ฺฉูุฏ.</p>
<p>ูโุชูุงูุฏ ุงุซุฑ <code>AsOrdered</code> ุฑุง ุฏุฑ ุงุฏุงููโ ูพุฑุณโูุฌู ุจุง ุงุณุชูุงุฏู ุงุฒ <code>AsUnordered</code> ุฎูุซ ฺฉูุฏ. ุงู ฺฉุงุฑ ฺฉ โููุทูโ ุชุตุงุฏู ุฏุฑ ุชุฑุชุจโ ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู ุจู ูพุฑุณโูุฌู ุงุฌุงุฒู ูโุฏูุฏ ุงุฒ ุขู ููุทู ุจู ุจุนุฏ ฺฉุงุฑุง ุจูุชุฑ ุฏุงุดุชู ุจุงุดุฏ.
ุจุฑุง ูุซุงูุ ุงฺฏุฑ ุจุฎูุงูุฏ ุชุฑุชุจ ูุฑูุฏ ููุท ุจุฑุง ุฏู ุนููฺฏุฑ ุงูู ุญูุธ ุดูุฏ:</p>
<pre><code class="language-csharp">inputSequence.AsParallel().AsOrdered()
  .QueryOperator1()
  .QueryOperator2()
  .AsUnordered()
      // ุงุฒ ุงูุฌุง ุจู ุจุนุฏ ุชุฑุชุจ ุงููุช ูุฏุงุฑุฏ
  .QueryOperator3()
  ...
</code></pre>
<p>๐น ุฏูู ุงูฺฉู <code>AsOrdered</code> ูพุดโูุฑุถ ูุณุช ุงู ุงุณุช ฺฉู ุฏุฑ ุจุดุชุฑ ูพุฑุณโูุฌููุงุ ุชุฑุชุจ ุงููู ุงููุช ูุฏุงุฑุฏ. ุงฺฏุฑ ูุฑุงุฑ ุจูุฏ <code>AsOrdered</code> ูพุดโูุฑุถ ุจุงุดุฏุ ุจุฑุง ุงฺฉุซุฑ ูพุฑุณโูุฌููุง ููุงุฒ ุจุงุฏ <code>AsUnordered</code> ุงุถุงูู ูโฺฉุฑุฏุฏ ุชุง ุจูุชุฑู ฺฉุงุฑุง ุญุงุตู ุดูุฏุ ู ุงู ุจุงุนุซ ูพฺุฏฺฏ ู ุจุงุฑ ุงุถุงู ูโุดุฏ.</p>
<hr>
<h3>โ๏ธ ูุญุฏูุฏุชโูุง PLINQ</h3>
<p>ูููโ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ุฑุง ููโุชูุงู ุจูโุทูุฑ ูุคุซุฑ ููุงุฒโุณุงุฒ ฺฉุฑุฏ. ููุงุฑุฏ ุฒุฑ ูุญุฏูุฏุช ุฏุงุฑูุฏ:</p>
<ul>
<li>
<p>ูุณุฎูโูุง ุงูุฏุณโุฏุงุฑ <code>Select</code>ุ <code>SelectMany</code> ู <code>ElementAt</code> ููุท ุฒูุงู ููุงุฒโุณุงุฒ ูโุดููุฏ ฺฉู ุนูุงุตุฑ ููุจุน ุฏุฑ ูููุนุช ุงูุฏุณ ุงุตู ุฎูุฏ ุจุงู ูุงูุฏู ุจุงุดูุฏ.</p>
<blockquote>
<p>ุจุดุชุฑ ุนููฺฏุฑูุง ูููุนุช ุงูุฏุณ ุฑุง ุชุบุฑ ูโุฏููุฏ (ูุซู <code>Where</code> ฺฉู ุนูุงุตุฑ ุฑุง ุญุฐู ูโฺฉูุฏ). ุจูุงุจุฑุงู ุงฺฏุฑ ูโุฎูุงูุฏ ุงุฒ ุนููฺฏุฑูุง ุงูุฏุณโุฏุงุฑ ุงุณุชูุงุฏู ฺฉูุฏุ ูุนูููุงู ุจุงุฏ ุขููุง ุฏุฑ ุงุจุชุฏุง ูพุฑุณโูุฌู ุจุงุดูุฏ.</p>
</blockquote>
</li>
<li>
<p>ุนููฺฏุฑูุง ุฒุฑ ูุงุจู ููุงุฒโุณุงุฒ ูุณุชูุฏุ ุงูุง ุงุฒ ุงุณุชุฑุงุชฺ ุชูุณูโุจูุฏ ูพุฑูุฒููโุง ุงุณุชูุงุฏู ูโฺฉููุฏ ฺฉู ฺฏุงู ุญุช ุงุฒ ูพุฑุฏุงุฒุด ุชุฑุชุจ ฺฉูุฏุชุฑ ุงุณุช:
<code>Join</code>, <code>GroupBy</code>, <code>GroupJoin</code>, <code>Distinct</code>, <code>Union</code>, <code>Intersect</code>, <code>Except</code></p>
</li>
<li>
<p>ูุณุฎูโูุง <strong>Seeded</strong> ุงุฒ ุนููฺฏุฑ <code>Aggregate</code> ุฏุฑ ุญุงูุช ุนุงุฏ ูุงุจู ููุงุฒโุณุงุฒ ูุณุชูุฏ. PLINQ ุจุฑุง ุงู ููุฑุฏ ูุณุฎูโูุง ุฎุงุต ุงุฑุงุฆู ูโุฏูุฏ (ุจุฎุด <em>Optimizing PLINQ</em> ุฏุฑ ุตูุญู 942).</p>
</li>
<li>
<p>ูููโ ุนููฺฏุฑูุง ุฏฺฏุฑ ููุงุฒโุณุงุฒ ูโุดููุฏุ ุงูุง ุงู ุชุถูู ููโฺฉูุฏ ฺฉู ูพุฑุณโูุฌู ุดูุง <strong>ุญุชูุงู</strong> ููุงุฒ ุดูุฏ. ุงฺฏุฑ PLINQ ุชุดุฎุต ุฏูุฏ ุณุฑุจุงุฑ ููุงุฒโุณุงุฒ ูพุฑุณโูุฌู ุฑุง ฺฉูุฏ ูโฺฉูุฏุ ููฺฉู ุงุณุช ุขู ุฑุง ุชุฑุชุจ ุงุฌุฑุง ฺฉูุฏ.
โ ูโุชูุงูุฏ ุจุง ุงู ฺฉุฏ ุฑูุชุงุฑ ุฑุง ูุฌุจูุฑ ุจู ููุงุฒโุณุงุฒ ฺฉูุฏ:</p>
</li>
</ul>
<pre><code class="language-csharp">.WithExecutionMode(ParallelExecutionMode.ForceParallelism)
</code></pre>
<hr>
<h3>๐ ูุซุงู: ุจุฑุฑุณ ุงููุง (Spellchecker) ููุงุฒ</h3>
<p>ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ฺฉ <strong>ุจุฑุฑุณโฺฉููุฏูโ ุงููุง ุณุฑุน</strong> ุจุฑุง ุงุณูุงุฏ ุจุฒุฑฺฏ ุจููุณู ฺฉู ุงุฒ ุชูุงู ูุณุชูโูุง CPU ุงุณุชูุงุฏู ฺฉูุฏ. ุจุง ุชุจุฏู ุงูฺฏูุฑุชู ุจู ฺฉ ูพุฑุณโูุฌู LINQุ ูโุชูุงูู ุจูโุฑุงุญุช ุขู ุฑุง ููุงุฒ ฺฉูู.</p>
<p>๐น ูุฑุญููโ ุงูู: ุฏุงูููุฏ ฺฉ <strong>ุฏฺฉุดูุฑ ุงุฒ ฺฉููุงุช ุงูฺฏูุณ</strong> ู ุฐุฎุฑู ุฏุฑ <code>HashSet</code> ุจุฑุง ุฌุณุชโูุฌู ุณุฑุน:</p>
<pre><code class="language-csharp">if (!File.Exists(&quot;WordLookup.txt&quot;))    // ุญุฏูุฏ 150,000 ฺฉููู
    File.WriteAllText(&quot;WordLookup.txt&quot;,
        await new HttpClient().GetStringAsync(
            &quot;http://www.albahari.com/ispell/allwords.txt&quot;));

var wordLookup = new HashSet&lt;string&gt;(
    File.ReadAllLines(&quot;WordLookup.txt&quot;),
    StringComparer.InvariantCultureIgnoreCase);
</code></pre>
<p>๐น ูุฑุญููโ ุฏูู: ุงุฌุงุฏ ฺฉ โุณูุฏ ุขุฒูุงุดโ ุดุงูู ฺฉ ูููู ฺฉูููโ ุชุตุงุฏูุ ุณูพุณ ุงุฌุงุฏ ฺูุฏ ุบูุท ุงููุง ุนูุฏ:</p>
<pre><code class="language-csharp">var random = new Random();
string[] wordList = wordLookup.ToArray();

string[] wordsToTest = Enumerable.Range(0, 1000000)
    .Select(i =&gt; wordList[random.Next(0, wordList.Length)])
    .ToArray();

wordsToTest[12345] = &quot;woozsh&quot;;   // ฺูุฏ ุบูุท ุงููุง
wordsToTest[23456] = &quot;wubsie&quot;;
</code></pre>
<p>๐น ูุฑุญููโ ุณูู: ุงุฌุฑุง ุจุฑุฑุณ ููุงุฒ ุจุง PLINQ:</p>
<pre><code class="language-csharp">var query = wordsToTest
    .AsParallel()
    .Select((word, index) =&gt; (word, index))
    .Where(iword =&gt; !wordLookup.Contains(iword.word))
    .OrderBy(iword =&gt; iword.index);

foreach (var mistake in query)
    Console.WriteLine(mistake.word + &quot; - index = &quot; + mistake.index);

// ุฎุฑูุฌ:
// woozsh - index = 12345
// wubsie - index = 23456
</code></pre>
<p>ูุชุฏ <code>wordLookup.Contains</code> ุฏุฑ predicate ุจู ูพุฑุณโูุฌู <strong>ุญุฌู ูพุฑุฏุงุฒุด ููุงุณุจ</strong> ูโุฏูุฏ ู ุงุฑุฒุด ููุงุฒโุณุงุฒ ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ.</p>
<hr>
<h3>๐ฆ ูฺฉุชู ุฏุฑุจุงุฑูโ ฺฉุงุฑุง ู ุญุงูุธู</h3>
<p>ุฏุฑ ูพุฑุณโูุฌู ุงุฒ <strong>Tuple</strong>โูุง <code>(word, index)</code> ุจูโุฌุง <strong>ููุน ูุงุดูุงุณ (anonymous types)</strong> ุงุณุชูุงุฏู ุดุฏู ุงุณุช.
ฺูู Tupleูุง ุจูโุตูุฑุช <strong>Value Type</strong> ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏ (ูู Reference Type):</p>
<ul>
<li>ูุตุฑู ุญุงูุธู ุฏุฑ ุงูุฌ ฺฉุงูุด ูโุงุจุฏ โ</li>
<li>ฺฉุงุฑุง ุจูุชุฑ ูโุดูุฏ โ</li>
<li>ุชุฎุตุตโูุง heap ู ุฌูุนโุขูุฑ ุฒุจุงูู (Garbage Collection) ฺฉูุชุฑ ูโุดูุฏ โ</li>
</ul>
<p>๐ ุงูุจุชู ุจูฺูุงุฑฺฉโูุง ูุดุงู ูโุฏููุฏ ุงู ูุฒุงุง ุฏุฑ ุนูู <strong>ูุชูุณุท</strong> ูุณุชูุฏุ ฺูู ูุฏุฑ ุญุงูุธู ุจุณุงุฑ ฺฉุงุฑุขูุฏ ุงุณุช ู ุงู ุชุฎุตุตโูุง ูุนูููุงู ุจุด ุงุฒ <strong>Generation 0</strong> ุฏูุงู ููโุขูุฑูุฏ.</p>
<h3>๐งต ุงุณุชูุงุฏู ุงุฒ <code>ThreadLocal&lt;T&gt;</code></h3>
<p>ุจุงุฏ ูุซุงู ุฎูุฏูุงู ุฑุง ฺฏุณุชุฑุด ุฏูู ู <strong>ุงุฌุงุฏ ูุณุช ุชุตุงุฏู ฺฉููุงุช ุขุฒูุงุด</strong> ุฑุง ูุฒ ููุงุฒโุณุงุฒ ฺฉูู.
ูุง ุขู ุฑุง ุจูโุตูุฑุช ฺฉ ูพุฑุณโูุฌู LINQ ุณุงุฎุชุงุฑุจูุฏ ฺฉุฑุฏูุ ูพุณ ุจุงุฏ ุณุงุฏู ุจุงุดุฏ.</p>
<p>๐น ูุณุฎูโ ุชุฑุชุจ:</p>
<pre><code class="language-csharp">string[] wordsToTest = Enumerable.Range(0, 1000000)
    .Select(i =&gt; wordList[random.Next(0, wordList.Length)])
    .ToArray();
</code></pre>
<p>ุงูุง ูุดฺฉู ุงูุฌุงุณุช ฺฉู ูุฑุงุฎูุงู <code>random.Next</code> <strong>Thread-Safe</strong> ูุณุชุ ุจูุงุจุฑุงู ุจูโุณุงุฏฺฏ ููโุชูุงูู <code>AsParallel()</code> ุฑุง ุฏุฑ ูพุฑุณโูุฌู ูุงุฑุฏ ฺฉูู.</p>
<p>ุฑุงูโุญู ุงุญุชูุงู ุงู ุงุณุช ฺฉู ูุชุฏ ุจููุณู ฺฉู ุฏูุฑ <code>random.Next</code> ููู ุจฺฏุฐุงุฑุฏุ ุงูุง ุงู ุจุงุนุซ ูุญุฏูุฏ ุดุฏู ููโุฒูุงู (Concurrency) ูโุดูุฏ.
โ ุฑุงูโุญู ุจูุชุฑ ุงู ุงุณุช ฺฉู ุงุฒ <code>ThreadLocal&lt;Random&gt;</code> (ุจุฎุด <em>Thread-Local Storage</em> ุตูุญู 923) ุงุณุชูุงุฏู ฺฉูู ุชุง ุจุฑุง ูุฑ ูุฎ ฺฉ ุดุก <code>Random</code> ุฌุฏุงฺฏุงูู ุณุงุฎุชู ุดูุฏ.</p>
<p>๐น ูุณุฎูโ ููุงุฒ:</p>
<pre><code class="language-csharp">var localRandom = new ThreadLocal&lt;Random&gt;(
    () =&gt; new Random(Guid.NewGuid().GetHashCode()));

string[] wordsToTest = Enumerable.Range(0, 1000000).AsParallel()
    .Select(i =&gt; wordList[localRandom.Value.Next(0, wordList.Length)])
    .ToArray();
</code></pre>
<p>ุฏุฑ ุชุงุจุน ฺฉุงุฑุฎุงููโุง ฺฉู ุจุฑุง ุงุฌุงุฏ ฺฉ ุดุก <code>Random</code> ููุดุชูุ ุงุฒ ูุด (<code>HashCode</code>) ฺฉ <code>Guid</code> ุงุณุชูุงุฏู ฺฉุฑุฏู ุชุง ูุทูุฆู ุดูู ุงฺฏุฑ ุฏู ุดุก <code>Random</code> ุฏุฑ ฺฉ ุจุงุฒูโ ุฒูุงู ฺฉูุชุงู ุณุงุฎุชู ุดููุฏุ ุฏูุจุงููโ ุงุนุฏุงุฏ ุชุตุงุฏูโุดุงู ูุชูุงูุช ุฎูุงูุฏ ุจูุฏ. ๐ฒ</p>
<hr>
<h3>๐ค ฺู ุฒูุงู ุงุฒ PLINQ ุงุณุชูุงุฏู ฺฉููุ</h3>
<p>ููฺฉู ุงุณุช ูุณูุณู ุดูุฏ ุฏุฑ ุจุฑูุงููโูุง ููุฌูุฏ ุฎูุฏ ุจูโุฏูุจุงู ูพุฑุณโูุฌููุง LINQ ุจฺฏุฑุฏุฏ ู ุขููุง ุฑุง ููุงุฒโุณุงุฒ ฺฉูุฏ.
ุงูุง ุงู ูุนูููุงู ุจโูุงุฏู ุงุณุชุ ฺูู ูุณุงุฆู ฺฉู LINQ ุจูุชุฑู ุฑุงูโุญู ุจุฑุงุดุงู ูุญุณูุจ ูโุดูุฏุ ุฎู ุณุฑุน ุงุฌุฑุง ูโุดููุฏ ู ููุงุฒโุณุงุฒ ฺฉูฺฉ ููโฺฉูุฏ.</p>
<p>โ ุฑูฺฉุฑุฏ ุจูุชุฑ:</p>
<ul>
<li>ูพุฏุง ฺฉุฑุฏู ฺฉ <strong>ฺฏููฺฏุงู CPU-ูุญูุฑ</strong></li>
<li>ุณูพุณ ุจุฑุฑุณ ุงูฺฉู ุขุง ูโุชูุงู ุขู ุฑุง ุจูโุตูุฑุช ฺฉ ูพุฑุณโูุฌู LINQ ุจุงู ฺฉุฑุฏ</li>
</ul>
<p>๐น ฺฉ ุงุซุฑ ุฌุงูุจ ุฎูุดุงูุฏ ุงู ุจุงุฒููุณ ุงู ุงุณุช ฺฉู ฺฉุฏ <strong>ฺฉูฺฺฉโุชุฑ ู ุฎูุงูุงุชุฑ</strong> ูโุดูุฏ.</p>
<p>๐ PLINQ ุจุฑุง ูุณุงุฆู ฺฉู ุจูโุทูุฑ ูุงุถุญ <strong>Embarrassingly Parallel</strong> ูุณุชูุฏ ุนุงู ุงุณุช.
ุงูุง ุจุฑุง ูพุฑุฏุงุฒุด ุชุตูุฑ (Imaging) ุงูุชุฎุงุจ ุฎูุจ ูุณุชุ ฺูู ุฌูุนโุขูุฑ ููููโูุง ูพฺฉุณู ุฏุฑ ฺฉ ุชูุงู ุฎุฑูุฌ ุฎูุฏุด ุชุจุฏู ุจู ฺฏููฺฏุงู ูโุดูุฏ.
ุฑุงู ุจูุชุฑ ุงู ุงุณุช ฺฉู ูพฺฉุณูโูุง ุฑุง ูุณุชููุงู ุฏุฑ ฺฉ ุขุฑุงู ุง ุจููฺฉ ุญุงูุธูโ unmanaged ุจููุณู ู ุงุฒ <strong>ฺฉูุงุณ Parallel</strong> ุง <strong>task parallelism</strong> ุจุฑุง ูุฏุฑุช ฺูุฏุฑุณูุงู ุงุณุชูุงุฏู ฺฉูู.</p>
<p>(ุจุง ุงู ุญุงู ูโุชูุงู ุจุง ูุชุฏ <code>ForAll</code> ุฌูุนโุขูุฑ ูุชุงุฌ ุฑุง ุญุฐู ฺฉุฑุฏโุจุฎุด <em>Optimizing PLINQ</em> ุตูุญู 942 ุชูุถุญ ูโุฏูุฏ. ุงู ฺฉุงุฑ ููุช ููุทู ุงุณุช ฺฉู ุงูฺฏูุฑุชู ูพุฑุฏุงุฒุด ุชุตูุฑ ุฐุงุชุงู ููุงุณุจ LINQ ุจุงุดุฏ.)</p>
<hr>
<h3>๐งผ ุฎููุต ุชุงุจุน (Functional Purity)</h3>
<p>ฺูู PLINQ ูพุฑุณโูุฌู ุดูุง ุฑุง ุฑู ูุฎโูุง ููุงุฒ ุงุฌุฑุง ูโฺฉูุฏุ ุจุงุฏ ูุฑุงูุจ ุจุงุดุฏ ุนููุงุช ุงูุฌุงู ูุฏูุฏ ฺฉู <strong>Thread-Safe</strong> ูุณุชูุฏ.</p>
<p>ุจูโูฺูุ ููุดุชู ุฏุฑ ูุชุบุฑูุง ุงุซุฑ ุฌุงูุจ ุฏุงุฑุฏ ู ุจูุงุจุฑุงู ูุงุงูู ุงุณุช:</p>
<pre><code class="language-csharp">// ูพุฑุณโูุฌู ุฒุฑ ูุฑ ุนูุตุฑ ุฑุง ุฏุฑ ูููุนุชุด ุถุฑุจ ูโฺฉูุฏ.
// ุจุง ูุฑูุฏ Enumerable.Range(0,999) ุจุงุฏ ูุฑุจุนโูุง ุฑุง ุจุฏูุฏ.
int i = 0;
var query = from n in Enumerable.Range(0,999).AsParallel()
            select n * i++;
</code></pre>
<p>ุญุช ุงฺฏุฑ ุงูุฒุงุด <code>i</code> ุฑุง ุจุง ููู ุงูู ฺฉููุ ุจุงุฒ ูู ูุดฺฉู ุจุงู ูโูุงูุฏ ฺูู <code>i</code> ูุฒููุงู ุจุง ูููุนุช ุนูุตุฑ ูุฑูุฏ ุชุทุงุจู ูุฏุงุฑุฏ.
ุงูุฒูุฏู <code>AsOrdered</code> ูู ูุดฺฉู ุฑุง ุญู ููโฺฉูุฏุ ฺูู ููุท ุชุถูู ูโฺฉูุฏ ุฎุฑูุฌ ุจูโุชุฑุชุจ ุนูุงุตุฑ ูพุฑุฏุงุฒุดโุดุฏู ุจุงุดุฏุ ูู ุงูฺฉู ูุงูุนุงู ูพุฑุฏุงุฒุด ุชุฑุชุจ ุงูุฌุงู ุดูุฏ.</p>
<p>โ ุฑุงูโุญู ุฏุฑุณุช: ุงุณุชูุงุฏู ุงุฒ ูุณุฎูโ ุงูุฏุณโุฏุงุฑ <code>Select</code>:</p>
<pre><code class="language-csharp">var query = Enumerable.Range(0,999).AsParallel()
                      .Select((n, i) =&gt; n * i);
</code></pre>
<p>๐น ุจุฑุง ุจูุชุฑู ฺฉุงุฑุงุ ูุชุฏูุง ฺฉู ุฏุฑ ุนููฺฏุฑูุง ูพุฑุณโูุฌู ูุฑุงุฎูุงู ูโุดููุฏ ุจุงุฏ <strong>Thread-Safe</strong> ุจุงุดูุฏุ</p>
<ul>
<li>ุง ุจูโุฏูู ูุฏุงุดุชู ุงุซุฑ ุฌุงูุจ (ุฎุงูุต ุจูุฏู ุชุงุจุน)</li>
<li>ุง ุงฺฏุฑ ุจูโูุณููโ ููู ุงูู ุดุฏูโุงูุฏุ ุจุงุฏ ุจุฏุงูุฏ ฺฉู ูพุชุงูุณู ููุงุฒโุณุงุฒ ูุญุฏูุฏ ุจู ุงุซุฑุงุช ุฑูุงุจุช ุฎูุงูุฏ ุจูุฏ.</li>
</ul>
<hr>
<h3>โ๏ธ ุชูุธู ุฏุฑุฌูโ ููุงุฒโุณุงุฒ (Degree of Parallelism)</h3>
<p>ุจูโุทูุฑ ูพุดโูุฑุถุ PLINQ ุฏุฑุฌูโ ููุงุฒโุณุงุฒ ุจููู ุจุฑุง ูพุฑุฏุงุฒูุฏู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ.
ูโุชูุงูุฏ ุขู ุฑุง ุจุง ูุชุฏ <code>WithDegreeOfParallelism</code> ุชุบุฑ ุฏูุฏ:</p>
<pre><code class="language-csharp">...AsParallel().WithDegreeOfParallelism(4)...
</code></pre>
<p>๐น ููููู: ุดุงุฏ ุจุฎูุงูุฏ ุฏุฑุฌูโ ููุงุฒโุณุงุฒ ุฑุง ุจุงูุงุชุฑ ุงุฒ ุชุนุฏุงุฏ ูุณุชูโูุง ุงูุฒุงุด ุฏูุฏุ ููุช ฺฉุงุฑ <strong>I/O-Bound</strong> ุฏุงุฑุฏ (ูุซูุงู ุฏุงูููุฏ ููโุฒูุงู ุตูุญุงุช ูุจ).
ุจุงุงูโุญุงูุ <strong>Task combinators</strong> ู <strong>ุชูุงุจุน Asynchronous</strong> ุฑุงูโุญู ูุดุงุจู ุงูุง ฺฉุงุฑุขูุฏุชุฑ ุงุฑุงุฆู ูโุฏููุฏ.</p>
<p>๐ซ ุจุฑุฎูุงู Tasksุ PLINQ ููโุชูุงูุฏ ฺฉุงุฑูุง I/O-Bound ุฑุง ุจุฏูู ูุณุฏูุฏ ฺฉุฑุฏู ูุฎโูุง ุงูุฌุงู ุฏูุฏ (ู ุงู ุจุฏุชุฑ ุจุงุนุซ ููู ุดุฏู ูุฎโูุง pool ูโุดูุฏ).</p>
<p>๐ ุชูุฌู:
<code>WithDegreeOfParallelism</code> ุฑุง ููุท <strong>ฺฉโุจุงุฑ</strong> ูโุชูุงู ุฏุฑ ฺฉ ูพุฑุณโูุฌู PLINQ ูุฑุงุฎูุงู ฺฉุฑุฏ.
ุงฺฏุฑ ูุงุฒ ุฏุงุฑุฏ ุฏูุจุงุฑู ุตุฏุง ุจุฒูุฏุ ุจุงุฏ ูพุฑุณโูุฌู ุฑุง merge ู ุฏูุจุงุฑู partition ฺฉูุฏ (ุจุง ุตุฏุง ุฒุฏู ุฏูุจุงุฑูโ <code>AsParallel</code>).</p>
<p>ูุซุงู:</p>
<pre><code class="language-csharp">&quot;The Quick Brown Fox&quot;
    .AsParallel().WithDegreeOfParallelism(2)
    .Where(c =&gt; !char.IsWhiteSpace(c))
    .AsParallel().WithDegreeOfParallelism(3)   // Merge + Partition ุฏูุจุงุฑู
    .Select(c =&gt; char.ToUpper(c));
</code></pre>
<hr>
<h3>โน ูุบู (Cancellation)</h3>
<p>ูุบู ฺฉุฑุฏู ฺฉ ูพุฑุณโูุฌู PLINQ ฺฉู ุฏุฑ ุญุงู ูุตุฑู ูุชุงุฌุด ุฏุฑ <code>foreach</code> ูุณุชุฏ ุณุงุฏู ุงุณุช:
ฺฉุงู ุงุณุช ุงุฒ ุญููู ุฎุงุฑุฌ ุดูุฏ (<code>break</code>) ู ูพุฑุณโูุฌู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ูุบู ูโุดูุฏุ ฺูู enumerator ุจูโุทูุฑ ุถูู Dispose ูโุดูุฏ.</p>
<p>ุงูุง ุงฺฏุฑ ูพุฑุณโูุฌู ุจุง ฺฉ ุนููฺฏุฑ ุชุจุฏูุ ุชฺฉโุนูุตุฑ ุง ุชุฌูุน ุฎุงุชูู ุงุจุฏุ ุจุงุฏ ุขู ุฑุง ุงุฒ ฺฉ ูุฎ ุฏฺฏุฑ ุจุง <strong>CancellationToken</strong> ูุบู ฺฉูุฏ.</p>
<p>ุจุฑุง ุฏุฑุฌ ุชูฺฉูุ ุจุนุฏ ุงุฒ <code>AsParallel</code> ุงุฒ <code>WithCancellation</code> ุงุณุชูุงุฏู ฺฉูุฏ ู ุฎุงุตุช <code>Token</code> ุงุฒ ฺฉ <code>CancellationTokenSource</code> ุฑุง ูพุงุณ ุฏูุฏ.</p>
<p>ูุซุงู:</p>
<pre><code class="language-csharp">IEnumerable&lt;int&gt; tenMillion = Enumerable.Range(3, 10_000_000);

var cancelSource = new CancellationTokenSource();
cancelSource.CancelAfter(100);   // ูุบู ุจุนุฏ ุงุฒ 100 ููโุซุงูู

var primeNumberQuery =
    from n in tenMillion.AsParallel().WithCancellation(cancelSource.Token)
    where Enumerable.Range(2, (int)Math.Sqrt(n)).All(i =&gt; n % i &gt; 0)
    select n;

try
{
    int[] primes = primeNumberQuery.ToArray();
    // ูุฑฺฏุฒ ุจู ุงู ุฎุท ููโุฑุณู ฺูู ูุฎ ุฏฺฏุฑ ูุง ุฑุง ูุบู ูโฺฉูุฏ
}
catch (OperationCanceledException)
{
    Console.WriteLine(&quot;Query canceled&quot;);
}
</code></pre>
<p>๐น ููฺฏุงู ูุบูุ PLINQ ููุชุธุฑ ูโูุงูุฏ ูุฑ ูุฎ ฺฉุงุฑ ุฑู ุนูุตุฑ ุฌุงุฑโุงุด ุชูุงู ฺฉูุฏุ ุณูพุณ ูพุฑุณโูุฌู ูพุงุงู ูโุงุจุฏ.
ุงู ุนู ูุฑ ูุชุฏ ุฎุงุฑุฌ ฺฉู ูพุฑุณโูุฌู ูุฑุงุฎูุงู ฺฉุฑุฏู ุจุงุดุฏุ ุชุง ุงูุชูุง ุงุฌุฑุง ุฎูุงูุฏ ุดุฏ.</p>
<h3>ุจูููโุณุงุฒ PLINQ ๐</h3>
<h4>ุจูููโุณุงุฒ ุฏุฑ ุณูุช ุฎุฑูุฌ</h4>
<p>ฺฉ ุงุฒ ูุฒุชโูุง <strong>PLINQ</strong> ุงู ุงุณุช ฺฉู ูุชุงุฌ ูพุฑุฏุงุฒุด ููุงุฒ ุฑุง ุจูโุทูุฑ ูุฑุชุจ ุฏุฑ ฺฉ ุฏูุจุงููโ ุฎุฑูุฌ ูุงุญุฏ ุฌูุนโุขูุฑ (collate) ูโฺฉูุฏ.
ุงูุง ฺฏุงู ูููโ ฺฉุงุฑ ฺฉู ุฏุฑ ููุงุช ุงูุฌุงู ูโุฏูุฏ ุงู ุงุณุช ฺฉู ุฑู ูุฑ ุนูุตุฑ ููุท ฺฉ ุชุงุจุน ุฑุง ุงุฌุฑุง ฺฉูุฏ:</p>
<pre><code class="language-csharp">foreach (int n in parallelQuery)
    DoSomething(n);
</code></pre>
<p>ุงฺฏุฑ ฺูู ุดุฑุงุท ุฏุงุดุชู ุจุงุดุฏโู ุจุฑุงุชุงู ููู ูุจุงุดุฏ ฺฉู ุนูุงุตุฑ ุจู ฺู ุชุฑุชุจ ูพุฑุฏุงุฒุด ูโุดููุฏโูโุชูุงูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ูุชุฏ <strong>ForAll</strong> ุฏุฑ PLINQ ฺฉุงุฑุง ุฑุง ุจูุจูุฏ ุจุฏูุฏ โ.</p>
<hr>
<h4>ูุชุฏ ForAll</h4>
<p>ูุชุฏ <strong>ForAll</strong> ฺฉ delegate ุฑุง ุฑู ูุฑ ุนูุตุฑ ุฎุฑูุฌ ฺฉ <code>ParallelQuery</code> ุงุฌุฑุง ูโฺฉูุฏ. ุงู ูุชุฏ ูุณุชููุงู ุจู ูุณุชูโ ุฏุงุฎู PLINQ ูุตู ูโุดูุฏ ู ูุฑุงุญู ุฌูุนโุขูุฑ ู ูพูุงุด ูุชุงุฌ (collating ู enumerating) ุฑุง ุฏูุฑ ูโุฒูุฏ.</p>
<p>๐น ูุซุงู ุณุงุฏู:</p>
<pre><code class="language-csharp">&quot;abcdef&quot;
    .AsParallel()
    .Select(c =&gt; char.ToUpper(c))
    .ForAll(Console.Write);
</code></pre>
<hr>
<p>๐ <strong>ุดฺฉู 22-3</strong> ุงู ูุฑุขูุฏ ุฑุง ูุดุงู ูโุฏูุฏ.</p>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-4.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ุจูููโุณุงุฒ PLINQ ๐</h3>
<h4>ุฌูุนโุขูุฑ ู ูพูุงุด ูุชุงุฌ (Collating &amp; Enumerating)</h4>
<p>ุนููุงุช ุฌูุนโุขูุฑ (collating) ู ูพูุงุด (enumerating) ูุชุงุฌุ ุฐุงุชุงู <strong>ุฎู ูพุฑูุฒูู ูุณุชูุฏ</strong>.
ุจู ููู ุฏููุ ุจูููโุณุงุฒ ุจุง ุงุณุชูุงุฏู ุงุฒ ูุชุฏ <strong>ForAll</strong> ุจุดุชุฑู ุณูุฏ ุฑุง ุฒูุงู ุจู ููุฑุงู ุฏุงุฑุฏ ฺฉู:</p>
<ul>
<li>ุชุนุฏุงุฏ ุนูุงุตุฑ ูุฑูุฏ ุฎู ุฒุงุฏ ุจุงุดุฏ ๐ข</li>
<li>ู ูุฑ ุนูุตุฑ ุจูโุณุฑุนุช ูพุฑุฏุงุฒุด ุดูุฏ โก</li>
</ul>
<hr>
<h4>ุจูููโุณุงุฒ ุฏุฑ ุณูุช ูุฑูุฏ (Input-side Optimization)</h4>
<p>ุจุฑุง ุงูฺฉู ุฏุงุฏูโูุง ุฑุง ุจู ุฑุดุชูโูุง (threads) ุชูุณู ฺฉูุฏุ <strong>PLINQ</strong> ุงุฒ <strong>ุณู ุงุณุชุฑุงุชฺ ูพุงุฑุชุดูโุจูุฏ (Partitioning Strategies)</strong> ุงุณุชูุงุฏู ูโฺฉูุฏ:</p>
<ol>
<li>
<p><strong>Range Partitioning (ูพุงุฑุชุดูโุจูุฏ ุจุงุฒูโุง)</strong></p>
<ul>
<li>ุจุฑุง ุฏูุจุงููโูุง ุนุฏุฏ ุง ุฏุงุฏูโูุง ุงูุฏฺฉุณโุฏุงุฑ ููุงุณุจ ุงุณุช.</li>
<li>ูุฑูุฏ ุจู ุจุงุฒูโูุง ูพูุณุชู ุชูุณู ูโุดูุฏ ู ูุฑ ุจุงุฒู ุจู ฺฉ thread ุงุฎุชุตุงุต ุฏุงุฏู ูโุดูุฏ.</li>
</ul>
</li>
<li>
<p><strong>Chunk Partitioning (ูพุงุฑุชุดูโุจูุฏ ูุทุนูโุง / ุชฺฉูโุง)</strong></p>
<ul>
<li>ุฏุงุฏูโูุง ุฏุฑ ูุทุนุงุช (chunks) ฺฉูฺฺฉ ุชูุณู ูโุดููุฏ.</li>
<li>ุงู ุฑูุด ุจุงุนุซ ุจุงูุงูุณ ุจูุชุฑ ุจู threadูุง ูโุดูุฏุ ูุฎุตูุตุงู ููุช ุฒูุงู ูพุฑุฏุงุฒุด ุนูุงุตุฑ <strong>ูุงูุชูุงุฒู</strong> ุจุงุดุฏ.</li>
</ul>
</li>
<li>
<p><strong>Hash Partitioning (ูพุงุฑุชุดูโุจูุฏ ูุด)</strong></p>
<ul>
<li>ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ <strong>ฺฉูุฏ ูุด</strong>ุ ุนูุงุตุฑ ุจู threadูุง ูุฎุชูู ุงุฎุชุตุงุต ุฏุงุฏู ูโุดููุฏ.</li>
<li>ุจุฑุง ุณูุงุฑููุง ฺฉู ุฏุงุฏูโูุง ุณุงุฎุชุงุฑ ุฎุงุต ุฏุงุฑูุฏ ููุฏ ุงุณุช.</li>
</ul>
</li>
</ol>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-5.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ุจูููโุณุงุฒ PLINQ ุฏุฑ ูพุงุฑุชุดูโุจูุฏ โก</h3>
<h4>ุนููฺฏุฑูุง ฺฉู ูุงุฒ ุจู ููุงุณู ุฏุงุฑูุฏ</h4>
<p>ุจุฑุง ุนููฺฏุฑูุง LINQ ฺฉู ูุงุฒููุฏ <strong>ููุงุณู ุนูุงุตุฑ</strong> ูุณุชูุฏ (ูุงููุฏ:
<code>GroupBy</code>ุ <code>Join</code>ุ <code>GroupJoin</code>ุ <code>Intersect</code>ุ <code>Except</code>ุ <code>Union</code> ู <code>Distinct</code>) โ
ูฺ ุงูุชุฎุงุจ ูุฌูุฏ ูุฏุงุฑุฏ: <strong>PLINQ ููุดู ุงุฒ Hash Partitioning ุงุณุชูุงุฏู ูโฺฉูุฏ</strong>.</p>
<ul>
<li>ุฏุฑ ุงู ุญุงูุช PLINQ ุจุงุฏ ุงุฒ ูุจู <strong>hashcode</strong> ููู ุนูุงุตุฑ ุฑุง ูุญุงุณุจู ฺฉูุฏ ุชุง ุงุทููุงู ุงุจุฏ ุนูุงุตุฑ ุจุง hashcode ูุดุงุจู ุฑู ููุงู thread ูพุฑุฏุงุฒุด ูโุดููุฏ.</li>
<li>ุงู ุฑูุด ูโุชูุงูุฏ ูุณุจุชุงู <strong>ฺฉูุฏ</strong> ุจุงุดุฏ.</li>
<li>ุงฺฏุฑ ุณุฑุนุช ุจุฑุงุชุงู ูุณุฆููโุณุงุฒ ุดุฏุ ุชููุง ฺฏุฒูู ุงู ุงุณุช ฺฉู ุจุง <strong>AsSequential</strong> ููุงุฒโุณุงุฒ ุฑุง ุบุฑูุนุงู ฺฉูุฏ.</li>
</ul>
<hr>
<h4>ุณุงุฑ ุนููฺฏุฑูุง ฺฉูุฆุฑ</h4>
<p>ุจุฑุง ุฏฺฏุฑ ุนููฺฏุฑูุงุ ุดูุง ูโุชูุงูุฏ ุงูุชุฎุงุจ ฺฉูุฏ ุจู:</p>
<ul>
<li><strong>Range Partitioning</strong> ๐ฆ</li>
<li><strong>Chunk Partitioning</strong> ๐ฉ</li>
</ul>
<p>ุจูโุตูุฑุช ูพุดโูุฑุถ:</p>
<ul>
<li>ุงฺฏุฑ ุฏูุจุงูู ูุฑูุฏ <strong>ุงูุฏฺฉุณโูพุฐุฑ</strong> ุจุงุดุฏ (ูุซู ุขุฑุงูโูุง ุง ฺุฒ ฺฉู <code>IList&lt;T&gt;</code> ูพุงุฏูโุณุงุฒ ฺฉุฑุฏู)ุ
โ <strong>PLINQ ุงุฒ Range Partitioning ุงุณุชูุงุฏู ูโฺฉูุฏ</strong>.</li>
<li>ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ
โ <strong>Chunk Partitioning ุงูุชุฎุงุจ ูโุดูุฏ</strong>.</li>
</ul>
<hr>
<h4>ููุงุณู ฺฉู ๐</h4>
<ul>
<li><strong>Range Partitioning</strong> โ ุณุฑุนโุชุฑ ุงุณุช ุจุฑุง ุฏูุจุงููโูุง ุทููุงู ฺฉู ูพุฑุฏุงุฒุด ูุฑ ุนูุตุฑ ุชูุฑุจุงู <strong>ฺฉุณุงู</strong> ุฒูุงู ูโุจุฑุฏ.</li>
<li><strong>Chunk Partitioning</strong> โ ุฏุฑ ุณุงุฑ ููุงูุน ูุนูููุงู ุณุฑุนโุชุฑ ุงุณุชุ ุจูโูฺู ููุช ูพุฑุฏุงุฒุด ุนูุงุตุฑ <strong>ูุงูุชูุงุฒู</strong> ุจุงุดุฏ.</li>
</ul>
<hr>
<h4>ุงุฌุจุงุฑ ุจู Range Partitioning</h4>
<ol>
<li>ุงฺฏุฑ ฺฉูุฆุฑ ุจุง <code>Enumerable.Range</code> ุดุฑูุน ูโุดูุฏุ ุขู ุฑุง ุจุง <code>ParallelEnumerable.Range</code> ุฌุงฺฏุฒู ฺฉูุฏ.</li>
<li>ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ฺฉุงู ุงุณุช ุฑู ูุฑูุฏ <code>ToList</code> ุง <code>ToArray</code> ุตุฏุง ุจุฒูุฏ (ุงูุจุชู ุงู ุฎูุฏุด ูุฒููโ ฺฉุงุฑุง ุฏุงุฑุฏ).</li>
</ol>
<p>๐ ูฺฉุชู ููู:
<code>ParallelEnumerable.Range</code> ููุท ฺฉ ุดูุฑุชฺฉุงุช ุจุฑุง <code>Enumerable.Range(...).AsParallel()</code> ูุณุชุ ุจูฺฉู ูุงูุนุงู ุจุงุนุซ <strong>ูุนุงู ุดุฏู Range Partitioning</strong> ูโุดูุฏ ู ุฑูุชุงุฑ ฺฉูุฆุฑ ุฑุง ุชุบุฑ ูโุฏูุฏ.</p>
<hr>
<h4>ุงุฌุจุงุฑ ุจู Chunk Partitioning</h4>
<p>ุจุฑุง ุงู ฺฉุงุฑ ุจุงุฏ ุฏูุจุงูู ูุฑูุฏ ุฑุง ุจุง <code>Partitioner.Create</code> (ุงุฒ ูุถุง ูุงู <code>System.Collections.Concurrent</code>) ุจูพฺุฏ:</p>
<pre><code class="language-csharp">int[] numbers = { 3, 4, 5, 6, 7, 8, 9 };
var parallelQuery =
    Partitioner.Create(numbers, true).AsParallel()
              .Where(...);
</code></pre>
<ul>
<li>ุขุฑฺฏููุงู ุฏูู (<code>true</code>) ูุดุฎุต ูโฺฉูุฏ ฺฉู ูโุฎูุงูุฏ <strong>load balancing</strong> ูุนุงู ุจุงุดุฏุ ุนู Chunk Partitioning ุงุณุชูุงุฏู ุดูุฏ.</li>
</ul>
<hr>
<h4>ูุญูู ฺฉุงุฑ Chunk Partitioning โ๏ธ</h4>
<ul>
<li>
<p>ูุฑ thread ุจูโุทูุฑ ุฏูุฑูโุง ฺูุฏ ุนูุตุฑ (ฺฉ &quot;chunk&quot;) ุฑุง ุจุฑูโุฏุงุฑุฏ.</p>
</li>
<li>
<p>ุฏุฑ ุงุจุชุฏุง chunkูุง ุฎู ฺฉูฺฺฉ ูุณุชูุฏ (ฑ ุง ฒ ุนูุตุฑ).</p>
</li>
<li>
<p>ุจุง ูพุดุฑูุช ฺฉูุฆุฑุ ุงูุฏุงุฒู chunkูุง ุจุดุชุฑ ูโุดูุฏ.</p>
</li>
<li>
<p>ุงู ุฑูุด ุจุงุนุซ ูโุดูุฏ:</p>
<ul>
<li>ุฏูุจุงููโูุง ฺฉูฺฺฉ ุจูโุฎูุจ ููุงุฒ ุดููุฏ โ</li>
<li>ู ุฏูุจุงููโูุง ุจุฒุฑฺฏ ุจุงุนุซ <strong>ุฑูุชโูุจุฑฺฏุดุช ุจุดโุงุฒุญุฏ (round-tripping)</strong> ูุดููุฏ.</li>
</ul>
</li>
<li>
<p>ุงฺฏุฑ ฺฉ thread ุนูุงุตุฑ &quot;ุณุงุฏูโุชุฑ&quot; ุจฺฏุฑุฏุ ุณุฑุนโุชุฑ ุขุฒุงุฏ ูโุดูุฏ ู chunks ุจุดุชุฑ ูพุฑุฏุงุฒุด ูโฺฉูุฏ.</p>
</li>
<li>
<p>ูุชุฌู โ ููู threads ูุดุบูู ู <strong>ูุชุนุงุฏู</strong> ูโูุงููุฏ.</p>
</li>
<li>
<p>ุชููุง ูุดฺฉู โ ูุงุฒ ุจู <strong>synchronization</strong> (ูุซู lock ุงุฎุชุตุงุต) ุจุฑุง ุฏุณุชุฑุณ ุจู ุฏูุจุงูู ูุฑูุฏ ุงุณุช ฺฉู ูโุชูุงูุฏ ฺฉู overhead ุงุฌุงุฏ ฺฉูุฏ.</p>
</li>
</ul>
<hr>
<h4>ูุญูู ฺฉุงุฑ Range Partitioning ๐งฎ</h4>
<ul>
<li>ุฏุฑ Range Partitioningุ ูุฑูุฏ ุงุฒ ููุงู ุงุจุชุฏุง ุจู threads ุชูุณู ูโุดูุฏ.</li>
<li>ูุฑ thread ุจุฎุด <strong>ุซุงุจุช</strong> ุงุฒ ุฏุงุฏู ุฑุง ูโฺฏุฑุฏ โ ุจุฏูู ูุงุฒ ุจู lock.</li>
<li>ูุดฺฉู: ุงฺฏุฑ ุจุนุถ threads ุนูุงุตุฑ &quot;ุณุงุฏูโุชุฑ&quot; ุจฺฏุฑูุฏ ู ุฒูุฏุชุฑ ุชูุงู ฺฉููุฏุ ุจูู ูููุฒ ุฏุฑ ุญุงู ฺฉุงุฑ ุฎูุงููุฏ ุจูุฏ โ ู ุงู ุจุงุนุซ idle ุดุฏู threadูุง ูโุดูุฏ.</li>
</ul>
<p>๐ ูุซุงู: ูุญุงุณุจู ุงุนุฏุงุฏ ุงูู ุจุง Range Partitioning ููฺฉู ุงุณุช ุนููฺฉุฑุฏ ุถุนู ุฏุงุดุชู ุจุงุดุฏ.
๐ ุงูุง ูุญุงุณุจู ุฑุดู ุฏูู ฑฐ ูููู ุนุฏุฏ ุงูู (ฺฉู ุฒูุงู ูพุฑุฏุงุฒุด ูุฑ ุนูุตุฑ ฺฉุณุงู ุงุณุช) ุจุณุงุฑ ุฎูุจ ุนูู ูโฺฉูุฏ:</p>
<pre><code class="language-csharp">ParallelEnumerable.Range(1, 10_000_000).Sum(i =&gt; Math.Sqrt(i));
</code></pre>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-6.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ุจูููโุณุงุฒ Aggregation ุฏุฑ PLINQ โ๏ธ</h3>
<h4>ParallelEnumerable.Range</h4>
<p>ูุชุฏ <code>ParallelEnumerable.Range</code> ฺฉ <code>ParallelQuery&lt;T&gt;</code> ุจุฑูโฺฏุฑุฏุงูุฏุ ุจูุงุจุฑุงู ูุงุฒ ุจู ูุฑุงุฎูุงู ุจุนุฏ <strong>AsParallel</strong> ูุณุช.</p>
<ul>
<li>ูพุงุฑุชุดูโุจูุฏ Range ูุฒููุงู ุนูุงุตุฑ ุฑุง ุฏุฑ ุจููฺฉโูุง ูุชูุงู ุชุฎุตุต ููโุฏูุฏุ ููฺฉู ุงุณุช ุงุฒ ุงุณุชุฑุงุชฺ <strong>Striping</strong> ุงุณุชูุงุฏู ฺฉูุฏ.</li>
<li>ูุซุงู: ุงฺฏุฑ ุฏู worker ุฏุงุดุชู ุจุงุดูุ ฺฉ ุนูุงุตุฑ <strong>ูุฑุฏ</strong> ู ุฏฺฏุฑ ุนูุงุตุฑ <strong>ุฒูุฌ</strong> ุฑุง ูพุฑุฏุงุฒุด ูโฺฉูุฏ.</li>
<li>ุนููฺฏุฑ <code>TakeWhile</code> ุชูุฑุจุงู ููุดู ุงุฒ ุงู ุงุณุชุฑุงุชฺ ุงุณุชูุงุฏู ูโฺฉูุฏ ุชุง ุงุฒ ูพุฑุฏุงุฒุด ุงุถุงู ุนูุงุตุฑ ุฏุฑ ุงูุชูุง ุฏูุจุงูู ุฌููฺฏุฑ ฺฉูุฏ.</li>
</ul>
<hr>
<h4>ุจูููโุณุงุฒ Aggregation ุณูุงุฑุด</h4>
<p>PLINQ ุนููฺฏุฑูุง ุงุณุชุงูุฏุงุฑุฏ ูุงููุฏ <code>Sum</code>ุ <code>Average</code>ุ <code>Min</code> ู <code>Max</code> ุฑุง ุจูโุตูุฑุช ููุงุฒ ู ุจููู ูุฏุฑุช ูโฺฉูุฏ.
ุงูุง <strong>Aggregate</strong> ฺุงูุดโูุง ุฎุงุต ุฏุงุฑุฏ.</p>
<p>ูุซุงู ุณุงุฏู ุงุฒ Aggregate (ุฌูุน ฺฉุฑุฏู ฺฉ ุฏูุจุงูู ุงุนุฏุงุฏ):</p>
<pre><code class="language-csharp">int[] numbers = { 1, 2, 3 };
int sum = numbers.Aggregate(0, (total, n) =&gt; total + n); // 6
</code></pre>
<ul>
<li>ุจุฑุง <strong>aggregation ุจุฏูู seed</strong>ุ delegate ุงุฑุงุฆูโุดุฏู ุจุงุฏ <strong>associative</strong> ู <strong>commutative</strong> ุจุงุดุฏ.</li>
<li>ุงฺฏุฑ ุงู ูุงููู ุฑุนุงุช ูุดูุฏุ PLINQ ููฺฉู ุงุณุช ูุชุงุฌ ุงุดุชุจุงู ุจุฏูุฏุ ุฒุฑุง ฺูุฏ seed ุงุฒ ุฏูุจุงูู ุจุฑุง ุฌูุนโุจูุฏ ฺูุฏ ูพุงุฑุชุดู ุงุณุชูุงุฏู ูโฺฉูุฏ.</li>
</ul>
<hr>
<h4>Aggregate ุจุง seed ฺูุฏฺฏุงูู</h4>
<ul>
<li>
<p>Aggregate ุจุง seed ุตุฑุญ ูุนูููุงู ุจูโุตูุฑุช <strong>ุณุฑุงู</strong> ุงุฌุฑุง ูโุดูุฏ ุฒุฑุง ููุท ฺฉ seed ุฏุงุฑุฏ.</p>
</li>
<li>
<p>PLINQ ฺฉ overload ุฎุงุต ุงุฑุงุฆู ูโุฏูุฏ ฺฉู <strong>seed factory</strong> ูโฺฏุฑุฏ.</p>
<ul>
<li>ุจุฑุง ูุฑ threadุ ุงู ุชุงุจุน ฺฉ seed ูุญู ุงุฌุงุฏ ูโฺฉูุฏ โ <strong>accumulator ูุญู</strong></li>
<li>ุณูพุณ ููุงุฏุฑ ูุญู ุจุง accumulator ุงุตู ุชุฑฺฉุจ ูโุดููุฏ.</li>
</ul>
</li>
<li>
<p>ุงู overload ููฺูู ฺฉ delegate ุจุฑุง <strong>ุชุจุฏู ููุง</strong> ูุชุงุฌ ูโฺฏุฑุฏ.</p>
</li>
</ul>
<p>ฺูุงุฑ delegate ุจู ุชุฑุชุจ:</p>
<ol>
<li><code>seedFactory</code> โ ุงุฌุงุฏ accumulator ูุญู</li>
<li><code>updateAccumulatorFunc</code> โ ุงุถุงูู ฺฉุฑุฏู ฺฉ ุนูุตุฑ ุจู accumulator ูุญู</li>
<li><code>combineAccumulatorFunc</code> โ ุชุฑฺฉุจ accumulator ูุญู ุจุง ุงุตู</li>
<li><code>resultSelector</code> โ ุชุจุฏู ููุง ูุชุฌู</li>
</ol>
<p>ูุซุงู ุณุงุฏู ุฌูุน ุงุนุฏุงุฏ ุจุง PLINQ:</p>
<pre><code class="language-csharp">numbers.AsParallel().Aggregate(
    () =&gt; 0,                           // seedFactory
    (localTotal, n) =&gt; localTotal + n, // updateAccumulatorFunc
    (mainTot, localTot) =&gt; mainTot + localTot, // combineAccumulatorFunc
    finalResult =&gt; finalResult          // resultSelector
);
</code></pre>
<hr>
<h4>ูุซุงู ูุงูุนโุชุฑ: ุดูุงุฑุด ูุฑฺฉุงูุณ ุญุฑูู ุฏุฑ ูุชู</h4>
<p>ูุชู:</p>
<pre><code class="language-csharp">string text = &quot;Letโs suppose this is a really long string&quot;;
var letterFrequencies = new int[26];
foreach (char c in text)
{
    int index = char.ToUpper(c) - 'A';
    if (index &gt;= 0 &amp;&amp; index &lt; 26) letterFrequencies[index]++;
}
</code></pre>
<ul>
<li>ุจุฑุง ูุชูโูุง ุทููุงู (ูุซู <strong>gene sequencing</strong>) ุงู ุฑูุด ูโุชูุงูุฏ ุฒูุงูโุจุฑ ุจุงุดุฏ.</li>
<li>ููุงุฒโุณุงุฒ ุจุง <code>Parallel.ForEach</code> ูุงุฒููุฏ ูุฏุฑุช ููุฒูุงู ุฑู ุขุฑุงู ูุดุชุฑฺฉ ุงุณุชุ ู ููู ฺฉุฑุฏู ูโุชูุงูุฏ <strong>ูพุชุงูุณู ููุงุฒโุณุงุฒ</strong> ุฑุง ุงุฒ ุจู ุจุจุฑุฏ.</li>
</ul>
<p>PLINQ ุจุง Aggregate ุฑุงูโุญู ุชูุฒ ุงุฑุงุฆู ูโุฏูุฏ:</p>
<pre><code class="language-csharp">int[] result = text.AsParallel().Aggregate(
    () =&gt; new int[26],               // accumulator ูุญู
    (localFrequencies, c) =&gt;        // ุฌูุนโุจูุฏ ุฏุฑ accumulator ูุญู
    {
        int index = char.ToUpper(c) - 'A';
        if (index &gt;= 0 &amp;&amp; index &lt; 26) localFrequencies[index]++;
        return localFrequencies;
    },
    (mainFreq, localFreq) =&gt;         // ุชุฑฺฉุจ local -&gt; main
        mainFreq.Zip(localFreq, (f1, f2) =&gt; f1 + f2).ToArray(),
    finalResult =&gt; finalResult        // ุชุจุฏู ููุง
);
</code></pre>
<ul>
<li>ุชูุฌู: ุชุงุจุน ูุญู <code>localFrequencies</code> ุนูุงุตุฑ ุฑุง ุชุบุฑ ูโุฏูุฏ.</li>
<li>ุงู ุจูููโุณุงุฒ ุงูฺฉุงูโูพุฐุฑ ุงุณุช ฺูู ูุฑ accumulator ูุญู <strong>ูุฎุชุต ูุฑ thread</strong> ุงุณุช.</li>
</ul>
<h3>ฺฉูุงุณ Parallel ๐ข</h3>
<p>ฺฉุชุงุจุฎุงูู PFX ฺฉ ุดฺฉู ูพุงู ุงุฒ <strong>Structured Parallelism</strong> ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุงุฒ ุทุฑู ุณู ูุชุฏ <strong>static</strong> ุฏุฑ ฺฉูุงุณ <code>Parallel</code> ูุงุจู ุงุณุชูุงุฏู ุงุณุช:</p>
<ul>
<li>
<p><code>Parallel.Invoke</code>
ุงุฌุฑุง ฺฉ ุขุฑุงู ุงุฒ delegateูุง ุจูโุตูุฑุช ููุงุฒ</p>
</li>
<li>
<p><code>Parallel.For</code>
ูุนุงุฏู ููุงุฒ ุญููู <code>for</code> ุฏุฑ C#</p>
</li>
<li>
<p><code>Parallel.ForEach</code>
ูุนุงุฏู ููุงุฒ ุญููู <code>foreach</code> ุฏุฑ C#</p>
</li>
</ul>
<blockquote>
<p>ูุฑ ุณู ูุชุฏ ุชุง ุชฺฉูู ูููโ ฺฉุงุฑูุงุ ุจูุงฺฉ ูโุดููุฏ. ูุดุงุจู PLINQุ ุฏุฑ ุตูุฑุช ุจุฑูุฒ <strong>exception</strong> ฺฉู ูุฏุฑุช ูุดุฏู ุจุงุดุฏุ ุณุงุฑ workerูุง ุจุนุฏ ุงุฒ ุงุชูุงู iteration ูุนู ูุชููู ูโุดููุฏ ู exceptionูุง ุจู caller ุจุฑูโฺฏุฑุฏูุฏโฺฉู ุฏุฑ ฺฉ <code>AggregateException</code> ุจุณุชูโุจูุฏ ุดุฏูโุงูุฏ.</p>
</blockquote>
<hr>
<h4>Parallel.Invoke</h4>
<p><code>Parallel.Invoke</code> ฺฉ ุขุฑุงู ุงุฒ delegateูุง <strong>Action</strong> ุฑุง ููุงุฒ ุงุฌุฑุง ฺฉุฑุฏู ู ููุชุธุฑ ุงุชูุงู ุขูโูุง ูโูุงูุฏ. ุณุงุฏูโุชุฑู ุงูุถุง ูุชุฏ:</p>
<pre><code class="language-csharp">public static void Invoke(params Action[] actions);
</code></pre>
<ul>
<li>ูุดุงุจู PLINQุ ูุชุฏูุง <code>Parallel.*</code> ุจุฑุง ฺฉุงุฑูุง <strong>compute-bound</strong> ุจููู ุดุฏูโุงูุฏุ ูู I/O-bound.</li>
<li>ูุซุงู ุณุงุฏู ุจุง ุฏุงูููุฏ ุฏู ุตูุญู ูุจ ุจู ุตูุฑุช ููุงุฒ:</li>
</ul>
<pre><code class="language-csharp">Parallel.Invoke(
    () =&gt; new WebClient().DownloadFile(&quot;http://www.linqpad.net&quot;, &quot;lp.html&quot;),
    () =&gt; new WebClient().DownloadFile(&quot;http://microsoft.com&quot;, &quot;ms.html&quot;)
);
</code></pre>
<p><strong>ูฺฉุชู ููู:</strong>
<code>Parallel.Invoke</code> ุญุช ุจุง ฺฉ ูููู delegate ูู ุจูโุตูุฑุช ูุคุซุฑ ฺฉุงุฑ ูโฺฉูุฏุ ุฒุฑุง ุนูุงุตุฑ ุฑุง ุจู <strong>batch</strong> ุชูุณู ูโฺฉูุฏ ู ุจู ฺูุฏ Task ุงุตู ุงุฎุชุตุงุต ูโุฏูุฏุ ุจู ุฌุง ุงุฌุงุฏ ฺฉ Task ุจุฑุง ูุฑ delegate.</p>
<blockquote>
<p>ูุณุฆููุช collating ูุชุงุฌ ุจุฑ ุนูุฏู ุดูุงุณุชุ ุจูุงุจุฑุงู ุจุงุฏ ุจู <strong>Thread Safety</strong> ุชูุฌู ฺฉูุฏ:</p>
</blockquote>
<pre><code class="language-csharp">var data = new List&lt;string&gt;();
Parallel.Invoke(
    () =&gt; data.Add(new WebClient().DownloadString(&quot;http://www.foo.com&quot;)),
    () =&gt; data.Add(new WebClient().DownloadString(&quot;http://www.far.com&quot;))
);
</code></pre>
<ul>
<li>ุจุฑุง ุญู ูุดฺฉู thread-unsafeุ ูโุชูุงู ุงุฒ <strong>locking</strong> ุงุณุชูุงุฏู ฺฉุฑุฏุ ุงูุง ุงู ฺฉุงุฑ ุฏุฑ ุขุฑุงูโูุง ุจุฒุฑฺฏ delegate ุจุงุนุซ <strong>bottleneck</strong> ูโุดูุฏ.</li>
<li>ุฑุงู ุจูุชุฑ: ุงุณุชูุงุฏู ุงุฒ <strong>Thread-Safe Collections</strong>ุ ูุงููุฏ <code>ConcurrentBag</code>.</li>
</ul>
<p>ููฺูู <code>Parallel.Invoke</code> ฺฉ overload ุฏุงุฑุฏ ฺฉู <strong>ParallelOptions</strong> ูโฺฏุฑุฏ:</p>
<pre><code class="language-csharp">public static void Invoke(ParallelOptions options, params Action[] actions);
</code></pre>
<ul>
<li>ุจุง <code>ParallelOptions</code> ูโุชูุงู <strong>CancellationToken</strong> ูุงุฑุฏ ฺฉุฑุฏุ ุญุฏุงฺฉุซุฑ concurrency ุฑุง ูุญุฏูุฏ ฺฉุฑุฏุ ุง ฺฉ <strong>task scheduler</strong> ุณูุงุฑุด ูุดุฎุต ฺฉุฑุฏ.</li>
</ul>
<hr>
<h4>Parallel.For ู Parallel.ForEach</h4>
<p>ุงู ูุชุฏูุง ูุนุงุฏู ููุงุฒ ุญูููโูุง <code>for</code> ู <code>foreach</code> ูุณุชูุฏุ ุจู ุงู ูุนูุง ฺฉู ูุฑ iteration ุจูโุตูุฑุช ููุงุฒ ุงุฌุฑุง ูโุดูุฏ.</p>
<p>ุณุงุฏูโุชุฑู ุงูุถุงูุง:</p>
<pre><code class="language-csharp">public static ParallelLoopResult For(int fromInclusive, int toExclusive, Action&lt;int&gt; body);
public static ParallelLoopResult ForEach&lt;TSource&gt;(IEnumerable&lt;TSource&gt; source, Action&lt;TSource&gt; body);
</code></pre>
<p>ูุซุงู:</p>
<p>ุญููู <code>for</code> ูุนููู:</p>
<pre><code class="language-csharp">for (int i = 0; i &lt; 100; i++)
    Foo(i);
</code></pre>
<p>ูุนุงุฏู ููุงุฒ:</p>
<pre><code class="language-csharp">Parallel.For(0, 100, i =&gt; Foo(i));
// ุง ุณุงุฏูโุชุฑ
Parallel.For(0, 100, Foo);
</code></pre>
<p>ุญููู <code>foreach</code> ูุนููู:</p>
<pre><code class="language-csharp">foreach (char c in &quot;Hello, world&quot;)
    Foo(c);
</code></pre>
<p>ูุนุงุฏู ููุงุฒ:</p>
<pre><code class="language-csharp">Parallel.ForEach(&quot;Hello, world&quot;, Foo);
</code></pre>
<p>ูุซุงู ุนูู ุจุง ุฑูุฒูฺฏุงุฑ (<code>System.Security.Cryptography</code>):</p>
<pre><code class="language-csharp">var keyPairs = new string[6];
Parallel.For(0, keyPairs.Length,
    i =&gt; keyPairs[i] = RSA.Create().ToXmlString(true));
</code></pre>
<ul>
<li>ูุดุงุจู <code>Parallel.Invoke</code>ุ ูโุชูุงู ุชุนุฏุงุฏ ุฒุงุฏ work item ุจู <code>Parallel.For</code> ู <code>Parallel.ForEach</code> ุฏุงุฏ ู ุขูโูุง ุจูโุตูุฑุช ูุคุซุฑ ุฑู ฺูุฏ Task ุชูุณู ูโุดููุฏ.</li>
<li>ููุงู ฺฉุงุฑ ุฑุง ูโุชูุงู ุจุง PLINQ ุงูุฌุงู ุฏุงุฏ:</li>
</ul>
<pre><code class="language-csharp">string[] keyPairs = ParallelEnumerable.Range(0, 6)
    .Select(i =&gt; RSA.Create().ToXmlString(true))
    .ToArray();
</code></pre>
<hr>
<h4>ุญูููโูุง ุฏุงุฎู ู ุฎุงุฑุฌ</h4>
<ul>
<li><code>Parallel.For</code> ู <code>Parallel.ForEach</code> ูุนูููุงู ุฑู <strong>ุญูููโูุง ุฎุงุฑุฌ</strong> ุจูุชุฑ ุนูู ูโฺฉููุฏุ ุฒุฑุง chunkูุง ุจุฒุฑฺฏุชุฑ ุจุฑุง ููุงุฒโุณุงุฒ ุงุฑุงุฆู ูโุฏููุฏ ู overhead ูุฏุฑุช ฺฉูุชุฑ ูโุดูุฏ.</li>
<li>ููุงุฒโุณุงุฒ ูุฑ ุฏู ุญููู ุฏุงุฎู ู ุฎุงุฑุฌ ูุนูููุงู ุบุฑุถุฑูุฑ ุงุณุช.</li>
</ul>
<p>ูุซุงู:</p>
<pre><code class="language-csharp">Parallel.For(0, 100, i =&gt;
{
    Parallel.For(0, 50, j =&gt; Foo(i, j));   // ุญููู ุฏุงุฎู: ูุนูููุงู sequential ุจูุชุฑ ุงุณุช
});
</code></pre>
<h3>Parallel.ForEach ุจุง ุงูุฏุณ ู ูุฏุฑุช ุชููู ุญููู ๐ข</h3>
<p>ฺฏุงู ุงููุงุช ุฏุฑ <strong>ุญูููโูุง ููุงุฒ</strong> ูุงุฒู ุงุณุช ฺฉู <strong>ุงูุฏุณ iteration</strong> ุฑุง ุจุฏุงูู.</p>
<h4>ุงูุฏุณ ุฏุฑ ุญูููโูุง ููุงุฒ</h4>
<p>ุฏุฑ ุญููู sequential ูุนููู:</p>
<pre><code class="language-csharp">int i = 0;
foreach (char c in &quot;Hello, world&quot;)
    Console.WriteLine(c.ToString() + i++);
</code></pre>
<p>ุงูุง ุฏุฑ ูุญุท ููุงุฒุ <strong>ุงูุฒุงุด ฺฉ ูุชุบุฑ ูุดุชุฑฺฉ thread-safe ูุณุช</strong>.
ุฑุงู ุญู: ุงุณุชูุงุฏู ุงุฒ overload ุง ุงุฒ <code>Parallel.ForEach</code> ฺฉู ุงูุฏุณ loop ุฑุง ุงุฑุงุฆู ูโุฏูุฏ:</p>
<pre><code class="language-csharp">public static ParallelLoopResult ForEach&lt;TSource&gt;(
    IEnumerable&lt;TSource&gt; source, Action&lt;TSource, ParallelLoopState, long&gt; body)
</code></pre>
<ul>
<li>ูพุงุฑุงูุชุฑ ุณูู ุงุฒ ููุน <code>long</code> ุงูุฏุณ ูุฑ ุนูุตุฑ ุฑุง ูุดุงู ูโุฏูุฏ.</li>
<li>ูุซุงู:</li>
</ul>
<pre><code class="language-csharp">Parallel.ForEach(&quot;Hello, world&quot;, (c, state, i) =&gt;
{
    Console.WriteLine(c.ToString() + i);
});
</code></pre>
<hr>
<h4>ูุซุงู ุนูู: Spellchecker ููุงุฒ</h4>
<pre><code class="language-csharp">var wordLookup = new HashSet&lt;string&gt;(
    File.ReadAllLines(&quot;WordLookup.txt&quot;),
    StringComparer.InvariantCultureIgnoreCase
);

var random = new Random();
string[] wordList = wordLookup.ToArray();
string[] wordsToTest = Enumerable.Range(0, 1000000)
    .Select(i =&gt; wordList[random.Next(0, wordList.Length)])
    .ToArray();

wordsToTest[12345] = &quot;woozsh&quot;;
wordsToTest[23456] = &quot;wubsie&quot;;

var misspellings = new ConcurrentBag&lt;Tuple&lt;int,string&gt;&gt;();

Parallel.ForEach(wordsToTest, (word, state, i) =&gt;
{
    if (!wordLookup.Contains(word))
        misspellings.Add(Tuple.Create((int)i, word));
});
</code></pre>
<blockquote>
<p>ูฺฉุชู: ุจุงุฏ ูุชุงุฌ ุฑุง ุฏุฑ ฺฉ <strong>collection ุงูู ุจุฑุง Thread</strong> ุฌูุนโุขูุฑ ฺฉูุฏ.
ูุฒุช ุงุณุชูุงุฏู ุงุฒ indexed <code>ForEach</code> ูุณุจุช ุจู PLINQ: ุงุฌุฑุง <strong>ูุณุชูู ุจุฏูู ุงุนูุงู Select ุจุง ุงูุฏุณ</strong> ฺฉู ฺฉุงุฑุง ุจุดุชุฑ ุฏุงุฑุฏ.</p>
</blockquote>
<hr>
<h4>ParallelLoopState: ุชููู ุฒูุฏููฺฏุงู ุญููู</h4>
<p>ุฏุฑ ุญููู ููุงุฒ ููโุชูุงู ุงุฒ <code>break</code> ูุนููู ุงุณุชูุงุฏู ฺฉุฑุฏ.
ุจุงุฏ ุงุฒ ูุชุฏูุง <code>Break()</code> ุง <code>Stop()</code> ุฏุฑ ุด <code>ParallelLoopState</code> ุงุณุชูุงุฏู ฺฉูุฏ.</p>
<pre><code class="language-csharp">Parallel.ForEach(&quot;Hello, world&quot;, (c, loopState) =&gt;
{
    if (c == ',')
        loopState.Break();  // ูพุงุงู ุญููู ุจุนุฏ ุงุฒ iteration ุฌุงุฑ
    else
        Console.Write(c);
});
</code></pre>
<p><strong>ุชูุงูุช Break ู Stop:</strong></p>
<ul>
<li><code>Break()</code> โ ุญููู ุจุนุฏ ุงุฒ iteration ูุนู ูพุงุงู ูโุงุจุฏุ ุญุฏุงูู ุนูุงุตุฑ ูุจู ุงุฒ ุชููู ุงุฌุฑุง ูโุดููุฏ.</li>
<li><code>Stop()</code> โ ุญููู ุจูุงูุงุตูู ุจุฑุง ุชูุงู threadูุง ูพุงุงู ูโุงุจุฏุ ููฺฉู ุงุณุช ุชููุง ุฒุฑูุฌููุนูโุง ุงุฒ ุนูุงุตุฑ ูพุฑุฏุงุฒุด ุดููุฏ.</li>
</ul>
<hr>
<h4>ParallelLoopResult</h4>
<p>ูุชุฏูุง <code>Parallel.For</code> ู <code>Parallel.ForEach</code> ฺฉ <strong>ParallelLoopResult</strong> ุจุงุฒูโฺฏุฑุฏุงููุฏ:</p>
<ul>
<li><code>IsCompleted</code> โ ุขุง ุญููู ุชุง ุงูุชูุง ุงุฌุฑุง ุดุฏูุ</li>
<li><code>LowestBreakIteration</code> โ ุงูุฏุณ iteration ฺฉู ุญููู ุจุง <code>Break()</code> ูพุงุงู ุงูุชู ุงุณุช (ุงฺฏุฑ <code>Stop()</code> ุจุงุดุฏุ null ุจุฑูโฺฏุฑุฏุงูุฏ).</li>
</ul>
<hr>
<h4>ูุฏุฑุช ุทูู ุญููู ู ุชููู ุฌุฒุฆ</h4>
<ul>
<li>ุงฺฏุฑ ุจุฏูู ุญููู ุทููุงู ุงุณุชุ ูโุชูุงู ุฏุฑ ููุงุท ูุฎุชูู ฺฉุฏุ <strong>poll</strong> ุฑู <code>ShouldExitCurrentIteration</code> ุงูุฌุงู ุฏุงุฏ.</li>
<li>ุงู property ุจูุงูุงุตูู ุจุนุฏ ุงุฒ <code>Stop()</code> ุง ฺฉู ุจุนุฏ ุงุฒ <code>Break()</code> ุฏุฑุณุช ูโุดูุฏ.</li>
<li>ููฺูู ุจุนุฏ ุงุฒ ุฏุฑุฎูุงุณุช <strong>cancellation</strong> ุง ุฑุฎุฏุงุฏ <strong>exception</strong> ุฏุฑ ุญูููุ <code>ShouldExitCurrentIteration</code> ุจุฑุงุจุฑ true ูโุดูุฏ.</li>
<li><code>IsExceptional</code> โ ุงุทูุงุน ุงุฒ ุจุฑูุฒ exception ุฏุฑ ุณุงุฑ threadูุง.</li>
</ul>
<blockquote>
<p>ูฺฉุชู: ูุฑ exception ูุฏุฑุช ูุดุฏู ุจุงุนุซ ุชููู ุญููู ุจุนุฏ ุงุฒ iteration ุฌุงุฑ ูุฑ thread ูโุดูุฏุ ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ฺฉุงุฑุ ุจุงุฏ <strong>exceptionูุง ุฑุง ูุฏุฑุช ฺฉูุฏ</strong>.</p>
</blockquote>
<h3>ุจูููโุณุงุฒ ุจุง ููุงุฏุฑ ูุญู ุฏุฑ Parallel.For / Parallel.ForEach ๐ข</h3>
<p>ฺฏุงู ุญูููโูุง ููุงุฒ ูุงุฒ ุจู <strong>ุฌูุนโุขูุฑ ุฏุงุฏูโูุง ุฏุฑ ุญู iteration</strong> ุฏุงุฑูุฏุ ูุฎุตูุตุงู ููุช ุชุนุฏุงุฏ ุชฺฉุฑุงุฑูุง ุฒุงุฏ ุงุณุช.</p>
<hr>
<h4>ูุดฺฉู ููููู: ุฌูุน ุฒุฏู ุฑุดู ุฏูู ฑฐ ูููู ุนุฏุฏ</h4>
<pre><code class="language-csharp">object locker = new object();
double total = 0;

Parallel.For(1, 10000000, i =&gt;
{
    lock (locker)
        total += Math.Sqrt(i);
});
</code></pre>
<ul>
<li>ูุฑ iteration ูุงุฒ ุจู <strong>lock</strong> ุฏุงุฑุฏ.</li>
<li>ฑฐ ูููู lock ุจุงุนุซ <strong>ุงูุช ุดุฏุฏ ฺฉุงุฑุง</strong> ูโุดูุฏ.</li>
</ul>
<p><strong>ุชุดุจู:</strong>
ูุฑุถ ฺฉูุฏ ฑฐ ููุฑ ุฒุจุงูู ุฌูุน ูโฺฉููุฏ ู ููู ฺฉ ุณุทู ูุดุชุฑฺฉ ุฏุงุฑูุฏุ ุฒูุงู ุชูู ุดุฏู ุจุฑุง ุตูโุจูุฏ ู contention ุจุณุงุฑ ุฒุงุฏ ุงุณุช.</p>
<hr>
<h4>ุฑุงู ุญู: <strong>Local Value</strong> (ููุฏุงุฑ ูุญู)</h4>
<ul>
<li>ูุฑ thread ฺฉ <strong>ููุฏุงุฑ ูุญู</strong> ุฏุงุฑุฏ (ูุซู ุณุทู ุฒุจุงูู ุฎุตูุต).</li>
<li>ุฏุฑ ูพุงุงู iterationโูุงุ ููุงุฏุฑ ูุญู ุจู ููุฏุงุฑ ุงุตู ุงุถุงูู ูโุดููุฏ.</li>
</ul>
<pre><code class="language-csharp">object locker = new object();
double grandTotal = 0;

Parallel.For(
    1, 10000000,
    () =&gt; 0.0,  // ููุฏุงุฑ ูุญู ุฌุฏุฏ ุจุฑุง ูุฑ thread
    (i, state, localTotal) =&gt; localTotal + Math.Sqrt(i),  // ุจุฏูู ุญููู: ุฌูุน ุจู local
    localTotal =&gt; { lock (locker) grandTotal += localTotal; }  // ุฌูุน local ุจู ููุฏุงุฑ ุงุตู
);
</code></pre>
<ul>
<li>ุชููุง lock ุจุง ููุฏุงุฑ ูุญู ุงูุฌุงู ูโุดูุฏุ ูู ุจุฑุง ูุฑ iteration.</li>
<li><strong>ฺฉุงุฑุง ุจุณุงุฑ ุจูุชุฑ ุงุฒ ูุณุฎู ูุจู</strong>.</li>
</ul>
<hr>
<h4>ูฺฉุชู</h4>
<ul>
<li><strong>PLINQ</strong> ุงุบูุจ ุฌุงฺฏุฒู ููุงุณุจ ุงุณุช:</li>
</ul>
<pre><code class="language-csharp">ParallelEnumerable.Range(1, 10000000)
                  .Sum(i =&gt; Math.Sqrt(i));
</code></pre>
<ul>
<li>ุงุณุชูุงุฏู ุงุฒ <code>ParallelEnumerable.Range</code> ุจุงุนุซ <strong>range partitioning</strong> ูโุดูุฏุ ฺฉู ุจุฑุง ุชูุงูโูุง ุจุง ุฒูุงู ูพุฑุฏุงุฒุด ุจุฑุงุจุฑ ุจุณุงุฑ ุจููู ุงุณุช.</li>
<li>ุจุฑุง ุงูฺฏูุฑุชูโูุง ูพฺุฏูโุชุฑุ ูโุชูุงู ุงุฒ LINQโs <code>Aggregate</code> ุจุง seed factory ูุญู ุงุณุชูุงุฏู ฺฉุฑุฏ ฺฉู ูุดุงุจู ููู ููููู Local Value ุฏุฑ Parallel.For ุนูู ูโฺฉูุฏ.</li>
</ul>
<hr>
<h4>ุฌูุนโุจูุฏ</h4>
<ul>
<li>ูุณุฎูโูุง <code>TLocal</code> ุฏุฑ <code>Parallel.For</code> ู <code>Parallel.ForEach</code> ุจุฑุง <strong>ุจูููโุณุงุฒ ุฌูุนโุขูุฑ ุฏุงุฏูโูุง ุฏุฑ ุญูููโูุง ุจุฒุฑฺฏ ู ูพุฑุชฺฉุฑุงุฑ</strong> ุทุฑุงุญ ุดุฏูโุงูุฏ.</li>
<li>ุงู ุฑูุด ุจุงุนุซ ฺฉุงูุด contention ู overhead ูุฑุจูุท ุจู lockูุง ูโุดูุฏ.</li>
</ul>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-7.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>Task Parallelism ูพุดุฑูุชู ุฏุฑ PFX โก</h3>
<p>ุงู ุจุฎุด ุจู <strong>ูฺฺฏโูุง ูพุดุฑูุชู Task Parallel Library (TPL)</strong> ูโูพุฑุฏุงุฒุฏ ฺฉู ุจู ุจุฑูุงููโููุณ ููุงุฒ ฺฉูฺฉ ูโฺฉููุฏ:</p>
<ul>
<li><strong>ุชูุธู ุจุฑูุงููโุฑุฒ (scheduling)</strong> task</li>
<li><strong>ุงุฌุงุฏ ุฑุงุจุทู ูุงูุฏ/ูุฑุฒูุฏ</strong> ุจู taskูุง</li>
<li><strong>ุงุณุชูุงุฏู ูพุดุฑูุชู ุงุฒ Continuations</strong></li>
<li><strong>TaskFactory</strong></li>
</ul>
<hr>
<h4>ฺฉุงุฑ ุจุง ุชุนุฏุงุฏ ุฒุงุฏ taskูุง</h4>
<ul>
<li>TPL ุงุฌุงุฒู ูโุฏูุฏ ุตุฏูุง ุง ูุฒุงุฑุงู task ุจุง overhead ฺฉู ุงุฌุงุฏ ฺฉูุฏ.</li>
<li>ุจุฑุง ููููโูุง taskุ ุจุงุฏ ุขูโูุง ุฑุง ุจู ูุงุญุฏูุง ฺฉุงุฑ ุจุฒุฑฺฏโุชุฑ ุชูุณู ฺฉูุฏ.</li>
<li><code>Parallel</code> ู <code>PLINQ</code> ุงู ฺฉุงุฑ ุฑุง ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุฏููุฏ.</li>
</ul>
<hr>
<h4>ุงุฌุงุฏ ู ุดุฑูุน task</h4>
<ul>
<li><code>Task.Run</code> ฺฉ task ุง <code>Task&lt;TResult&gt;</code> ุงุฌุงุฏ ู ุงุฌุฑุง ูโฺฉูุฏ.</li>
<li>Shortcut ุจุฑุง <code>Task.Factory.StartNew</code> ฺฉู <strong>ฺฏุฒููโูุง ุจุดุชุฑ</strong> ุจุฑุง ฺฉูุชุฑู ุฏุงุฑุฏ.</li>
</ul>
<h5>ูุซุงู: ุงุฑุณุงู state ุจู task</h5>
<pre><code class="language-csharp">var task = Task.Factory.StartNew(Greet, &quot;Hello&quot;);
task.Wait();  // ููุชุธุฑ ุชฺฉูู task
void Greet(object state) { Console.Write(state); }  // ุฎุฑูุฌ: Hello
</code></pre>
<ul>
<li>ููฺูู ูโุชูุงู <strong>ูุงู ูุนูโุฏุงุฑ</strong> ุจุฑุง task ุงุฎุชุตุงุต ุฏุงุฏ:</li>
</ul>
<pre><code class="language-csharp">var task = Task.Factory.StartNew(state =&gt; Greet(&quot;Hello&quot;), &quot;Greeting&quot;);
Console.WriteLine(task.AsyncState);  // Greeting
task.Wait();
void Greet(string message) { Console.Write(message); }
</code></pre>
<hr>
<h4>TaskCreationOptions</h4>
<p>ุจุง ุงู enum ูโุชูุงู <strong>ุฑูุชุงุฑ ุงุฌุฑุง task ุฑุง ุชูุธู ฺฉุฑุฏ</strong>:</p>
<ul>
<li><strong>LongRunning</strong> โ ุงุฎุชุตุงุต ฺฉ thread ูฺู ุจู task (ุจุฑุง taskูุง I/O ุง ุทููุงู ููุฏ).</li>
<li><strong>PreferFairness</strong> โ ุชูุงุด ุจุฑุง ุงุฌุฑุง taskูุง ุจู ุชุฑุชุจ ุงุฌุงุฏ.</li>
<li><strong>AttachedToParent</strong> โ ุงุฌุงุฏ task ุจู ุนููุงู child ฺฉ task ุฏฺฏุฑ.</li>
</ul>
<hr>
<h4>Child Tasks</h4>
<ul>
<li>ููุช ฺฉ task ุฏฺฏุฑ ุฑุง ุงุฌุงุฏ ูโฺฉูุฏุ ูโุชูุงู ุฑุงุจุทู ูุงูุฏ/ูุฑุฒูุฏ ุงุฌุงุฏ ฺฉุฑุฏ.</li>
<li>ูุซุงู:</li>
</ul>
<pre><code class="language-csharp">Task parent = Task.Factory.StartNew(() =&gt;
{
    Console.WriteLine(&quot;I am a parent&quot;);
    Task.Factory.StartNew(() =&gt; Console.WriteLine(&quot;I am detached&quot;));  // Detached
    Task.Factory.StartNew(() =&gt; Console.WriteLine(&quot;I am a child&quot;), TaskCreationOptions.AttachedToParent);
});
</code></pre>
<ul>
<li><strong>ูฺฺฏ ููู:</strong> ููฺฏุงู <code>Wait</code> ุฑู parentุ taskูุง child ูู ููุชุธุฑ ูโูุงููุฏ ู <strong>ุงุณุชุซูุงูุง child ุจู parent ููุชูู ูโุดููุฏ</strong>.</li>
</ul>
<pre><code class="language-csharp">TaskCreationOptions atp = TaskCreationOptions.AttachedToParent;
var parent = Task.Factory.StartNew(() =&gt;
{
    Task.Factory.StartNew(() =&gt; 
        Task.Factory.StartNew(() =&gt; { throw null; }, atp), atp);
});

parent.Wait();  // NullReferenceException wrapped ุฏุฑ AggregateException
</code></pre>
<hr>
<h4>ุงูุชุธุงุฑ ุจุฑุง ฺูุฏ task</h4>
<ul>
<li>
<p><strong>Task.WaitAll</strong> โ ููุชุธุฑ ุชูุงู taskูุง ูโูุงูุฏ.</p>
</li>
<li>
<p><strong>Task.WaitAny</strong> โ ููุชุธุฑ ุงููู task ุชฺฉููโุดุฏู ูโูุงูุฏ.</p>
</li>
<li>
<p><code>WaitAll</code> ุจูููโุชุฑ ุงุฒ ุงูุชุธุงุฑ ฺฉโฺฉ ุงุณุช ู AggregateException ุฑุง ุจุฑุง ููู taskูุง ุฎุทุงุฏุงุฑ ุชููุฏ ูโฺฉูุฏ.</p>
</li>
<li>
<p>ููฺูู ูโุชูุงู <strong>timeout</strong> ู <strong>cancellation token</strong> ุจู <code>Wait</code> ุฏุงุฏ:</p>
<ul>
<li>ุงู ุจุงุนุซ ูุบู ุงูุชุธุงุฑ ูโุดูุฏุ ูู ุฎูุฏ task.</li>
</ul>
</li>
</ul>
<h3>ูุบู ู ุงุฏุงูู Taskูุง ุฏุฑ TPL โน๏ธโก๏ธโก๏ธ</h3>
<h4>ูุบู Task ุจุง CancellationToken</h4>
<ul>
<li>ููฺฏุงู ุดุฑูุน ฺฉ task ูโุชูุงูุฏ ฺฉ <strong>cancellation token</strong> ุจู ุขู ุจุฏูุฏ.</li>
<li>ุงฺฏุฑ ุจุง <code>Cancel</code> ุฑู token ูุฑุงุฎูุงู ุดูุฏุ task ูุงุฑุฏ ุญุงูุช <strong>Canceled</strong> ูโุดูุฏ.</li>
</ul>
<h5>ูุซุงู</h5>
<pre><code class="language-csharp">var cts = new CancellationTokenSource();
CancellationToken token = cts.Token;
cts.CancelAfter(500);  // ูุบู ุฎูุฏฺฉุงุฑ ูพุณ ุงุฒ 500ms

Task task = Task.Factory.StartNew(() =&gt;
{
    Thread.Sleep(1000);
    token.ThrowIfCancellationRequested(); // ุจุฑุฑุณ ูุบู
}, token);

try { task.Wait(); }
catch (AggregateException ex)
{
    Console.WriteLine(ex.InnerException is TaskCanceledException); // True
    Console.WriteLine(task.IsCanceled);                             // True
    Console.WriteLine(task.Status);                                 // Canceled
}
</code></pre>
<ul>
<li><code>TaskCanceledException</code> ุงุฒ <code>OperationCanceledException</code> ูุดุชู ุดุฏู ุงุณุช.</li>
<li>ุงฺฏุฑ ุจุฎูุงูุฏ ุฎูุฏุชุงู ฺฉ <code>OperationCanceledException</code> ูพุฑุชุงุจ ฺฉูุฏุ <strong>ุญุชูุงู token ุฑุง ุจู ุณุงุฒูุฏู ุจุฏูุฏ</strong> ุชุง ูุถุนุช task ุจู Canceled ุชุบุฑ ฺฉูุฏ ู continuations ุจุง <code>OnlyOnCanceled</code> ุงุฌุฑุง ุดููุฏ.</li>
<li>ุงฺฏุฑ task ูุจู ุงุฒ ุดุฑูุน ูุบู ุดูุฏุ <strong>ููุฑ ฺฉ OperationCanceledException</strong> ุชููุฏ ูโุดูุฏ ู task ุจุฑูุงููโุฑุฒ ููโุดูุฏ.</li>
</ul>
<hr>
<h4>ุงูุชุดุงุฑ ูุบู ุจู ุณุงุฑ APIูุง</h4>
<ul>
<li>ุจุณุงุฑ ุงุฒ APIูุง ูุงููุฏ PLINQ ุงุฒ cancellation token ูพุดุชุจุงู ูโฺฉููุฏ.</li>
<li>ูุซุงู:</li>
</ul>
<pre><code class="language-csharp">var cancelSource = new CancellationTokenSource();
CancellationToken token = cancelSource.Token;

Task task = Task.Factory.StartNew(() =&gt;
{
    var query = someSequence.AsParallel().WithCancellation(token);
    foreach(var item in query) { ... }
});
</code></pre>
<ul>
<li>ูุฑุงุฎูุงู <code>cancelSource.Cancel()</code> โ ูุบู query ู task.</li>
</ul>
<hr>
<h4>Continuations (ุงุฏุงูู taskูุง) ๐</h4>
<ul>
<li><code>ContinueWith</code> ฺฉ delegate ุฑุง <strong>ุจูุงูุงุตูู ุจุนุฏ ุงุฒ ูพุงุงู ฺฉ task</strong> ุงุฌุฑุง ูโฺฉูุฏ.</li>
<li>ูุซุงู ุณุงุฏู:</li>
</ul>
<pre><code class="language-csharp">Task task1 = Task.Factory.StartNew(() =&gt; Console.Write(&quot;antecedent..&quot;));
Task task2 = task1.ContinueWith(ant =&gt; Console.Write(&quot;..continuation&quot;));
</code></pre>
<ul>
<li><code>ant</code> โ ุงุฑุฌุงุน ุจู task ุงุตู.</li>
<li><code>ContinueWith</code> ุฎูุฏ task ุฌุฏุฏ ุจุฑูโฺฏุฑุฏุงูุฏ ู ูโุชูุงู <strong>ฺูุฏ continuation ุฒูุฌุฑูโุง</strong> ุงุฌุงุฏ ฺฉุฑุฏ.</li>
</ul>
<h5>ุงุฌุฑุง Continuation ุฑู ููุงู thread</h5>
<pre><code class="language-csharp">task1.ContinueWith(ant =&gt; ..., TaskContinuationOptions.ExecuteSynchronously);
</code></pre>
<hr>
<h4>Continuations ุจุง Task<TResult></h4>
<ul>
<li>Continuation ูโุชูุงูุฏ <strong>ููุฏุงุฑ ุจุงุฒฺฏุฑุฏุงูุฏ</strong> ู ุฏุงุฏูโูุง ุฑุง ูพุฑุฏุงุฒุด ฺฉูุฏ:</li>
</ul>
<pre><code class="language-csharp">Task.Factory.StartNew&lt;int&gt;(() =&gt; 8)
    .ContinueWith(ant =&gt; ant.Result * 2)
    .ContinueWith(ant =&gt; Math.Sqrt(ant.Result))
    .ContinueWith(ant =&gt; Console.WriteLine(ant.Result));  // 4
</code></pre>
<hr>
<h4>Continuations ู Exception</h4>
<ul>
<li>Continuation ูโุชูุงูุฏ ุจุฑุฑุณ ฺฉูุฏ ุขุง antecedent ุฎุทุง ุฏุงุฏู (<code>ant.Exception</code>) ุง ุงุฒ <code>Result/Wait</code> ุงุณุชูุงุฏู ฺฉูุฏ.</li>
<li>ุงฺฏุฑ continuation exception ุฑุง ูุจูุฏุ <strong>UnobservedTaskException</strong> ุฑุฎ ูโุฏูุฏ.</li>
<li>ุงูฺฏู ุงูู:</li>
</ul>
<pre><code class="language-csharp">Task continuation = Task.Factory.StartNew(() =&gt; { throw null; })
    .ContinueWith(ant =&gt; { ant.Wait(); /* ุงุฏุงูู ูพุฑุฏุงุฒุด */ });
continuation.Wait();  // exception ูพุฑุชุงุจ ูโุดูุฏ
</code></pre>
<ul>
<li>ูโุชูุงู continuations ูุฎุชูู ุจุฑุง <strong>ููุงุฑุฏ ุฎุทุง ู ุบุฑุฎุทุง</strong> ุชุนุฑู ฺฉุฑุฏ:</li>
</ul>
<pre><code class="language-csharp">Task task1 = Task.Factory.StartNew(() =&gt; { throw null; });
Task error = task1.ContinueWith(ant =&gt; Console.Write(ant.Exception),
                                TaskContinuationOptions.OnlyOnFaulted);
Task ok = task1.ContinueWith(ant =&gt; Console.Write(&quot;Success!&quot;),
                             TaskContinuationOptions.NotOnFaulted);
</code></pre>
<ul>
<li>ุจุฑุง ุตุฑู ูุธุฑ ุงุฒ ุงุณุชุซูุงูุง:</li>
</ul>
<pre><code class="language-csharp">public static void IgnoreExceptions(this Task task)
{
    task.ContinueWith(t =&gt; { var ignore = t.Exception; },
                      TaskContinuationOptions.OnlyOnFaulted);
}

Task.Factory.StartNew(() =&gt; { throw null; }).IgnoreExceptions();
</code></pre>
<hr>
<h4>Continuations ู Child Tasks ๐ถ</h4>
<ul>
<li>Continuation <strong>ุชููุง ุฒูุงู ุงุฌุฑุง ูโุดูุฏ ฺฉู ุชูุงู child taskูุง ฺฉุงูู ุดููุฏ</strong>.</li>
<li>ุงุณุชุซูุงูุง childูุง ุจู continuation ููุชูู ูโุดููุฏ:</li>
</ul>
<pre><code class="language-csharp">TaskCreationOptions atp = TaskCreationOptions.AttachedToParent;

Task.Factory.StartNew(() =&gt;
{
    Task.Factory.StartNew(() =&gt; { throw null; }, atp);
    Task.Factory.StartNew(() =&gt; { throw null; }, atp);
    Task.Factory.StartNew(() =&gt; { throw null; }, atp);
})
.ContinueWith(p =&gt; Console.WriteLine(p.Exception),
              TaskContinuationOptions.OnlyOnFaulted);
</code></pre>
<ul>
<li>ุงู ุงูฺฉุงู ุฑุง ูโุฏูุฏ ฺฉู <strong>ฺูุฏ ุฎุทุง ููุฒูุงู ุฑุง ฺฉุฌุง ูุฏุฑุช</strong> ฺฉูุฏ.</li>
</ul>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-8.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ุงุฏุงููโูุง ุดุฑุท ุฏุฑ Taskูุง (Conditional Continuations) โก</h3>
<ul>
<li>ุจู ุทูุฑ ูพุดโูุฑุถุ ฺฉ <strong>continuation</strong> ุจุฏูู ุดุฑุท ุจุฑูุงููโุฑุฒ ูโุดูุฏุ ฺู task ุงุตู (antecedent) ูููู ุจุงุดุฏุ ฺู ุฎุทุง ุฏูุฏ ุง ูุบู ุดูุฏ.</li>
<li>ูโุชูุงู ุฑูุชุงุฑ ุงุฌุฑุง continuation ุฑุง ุจุง <strong>TaskContinuationOptions</strong> ุชุบุฑ ุฏุงุฏ.</li>
</ul>
<h4>ุณู ููฺฏ ุงุตู</h4>
<table>
<thead>
<tr>
<th>ููฺฏ</th>
<th>ุชูุถุญ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NotOnRanToCompletion</code></td>
<td>ุงุฌุฑุง ูุดูุฏ ุงฺฏุฑ antecedent ุจุง ููููุช ฺฉุงูู ุดุฏ</td>
</tr>
<tr>
<td><code>NotOnFaulted</code></td>
<td>ุงุฌุฑุง ูุดูุฏ ุงฺฏุฑ antecedent ุฎุทุง ุฏุงุฏ</td>
</tr>
<tr>
<td><code>NotOnCanceled</code></td>
<td>ุงุฌุฑุง ูุดูุฏ ุงฺฏุฑ antecedent ูุบู ุดุฏ</td>
</tr>
</tbody>
</table>
<ul>
<li>ุงู ููฺฏโูุง <strong>ุญุฐูโฺฉููุฏู</strong> ูุณุชูุฏ: ูุฑ ฺู ุจุดุชุฑ ุงุนูุงู ฺฉูุฏุ ุงุญุชูุงู ุงุฌุฑุง continuation ฺฉูุชุฑ ูโุดูุฏ.</li>
</ul>
<h4>ููุงุฏุฑ ุชุฑฺฉุจ ุฑุงุฌ</h4>
<table>
<thead>
<tr>
<th>ููุฏุงุฑ</th>
<th>ุชุฑฺฉุจ ููฺฏโูุง</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OnlyOnRanToCompletion</code></td>
<td>`NotOnFaulted</td>
<td>NotOnCanceled`</td>
</tr>
<tr>
<td><code>OnlyOnFaulted</code></td>
<td>`NotOnRanToCompletion</td>
<td>NotOnCanceled`</td>
</tr>
<tr>
<td><code>OnlyOnCanceled</code></td>
<td>`NotOnRanToCompletion</td>
<td>NotOnFaulted`</td>
</tr>
</tbody>
</table>
<ul>
<li>ุชุฑฺฉุจ ูููโ Not*โูุง ููุทู ูุณุชุ ุฒุฑุง ููุฌุฑ ุจู <strong>ูุบู ุฏุงุฆู continuation</strong> ูโุดูุฏ.</li>
</ul>
<hr>
<h4>ูุนุงู ูุถุนุช antecedent</h4>
<table>
<thead>
<tr>
<th>ูุถุนุช</th>
<th>ุชูุถุญ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>RanToCompletion</code></td>
<td>ููููุช ุจุฏูู ูุบู ุง exception</td>
</tr>
<tr>
<td><code>Faulted</code></td>
<td>ฺฉ ุงุณุชุซูุง ุฑุฎ ุฏุงุฏู ุงุณุช</td>
</tr>
<tr>
<td><code>Canceled</code></td>
<td>antecedent ุจุง token ูุบู ุดุฏู ุง ุงุฏุงูู ุดุฑุท ุงุฌุฑุง ูุดุฏู ุงุณุช</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ููู: ุงฺฏุฑ continuation ุจู ุฏูู ุงู ููฺฏโูุง ุงุฌุฑุง ูุดูุฏุ <strong>ูุบู ูโุดูุฏ</strong> ูู ูุฑุงููุด ููโุดูุฏ. ุจูุงุจุฑุงู ูุฑ continuation ุฑู ุขู continuation ูโุชูุงูุฏ ุงุฌุฑุง ุดูุฏ ูฺฏุฑ ุงูฺฉู ุดุฑุท <code>NotOnCanceled</code> ุงุนูุงู ุดุฏู ุจุงุดุฏ.</p>
</blockquote>
<hr>
<h4>ูุซุงู ุนูู</h4>
<pre><code class="language-csharp">Task t1 = Task.Factory.StartNew(() =&gt; { /* ฺฉุงุฑ ุงุตู */ });

// ุงุฏุงูู ููุท ุฏุฑ ุตูุฑุช ุฎุทุง
Task fault = t1.ContinueWith(
    ant =&gt; Console.WriteLine(&quot;fault&quot;),
    TaskContinuationOptions.OnlyOnFaulted
);

// ุงุฏุงูู ุฑู continuation ูุจู
Task t3 = fault.ContinueWith(
    ant =&gt; Console.WriteLine(&quot;t3&quot;)  // ุงู ููุดู ุงุฌุฑุง ูโุดูุฏ!
);

// ุงฺฏุฑ ุจุฎูุงูู t3 ุชููุง ููุช ุงุฌุฑุง ุดูุฏ ฺฉู fault ุงุฌุฑุง ุดุฏู:
Task t3_conditional = fault.ContinueWith(
    ant =&gt; Console.WriteLine(&quot;t3&quot;),
    TaskContinuationOptions.NotOnCanceled
);
</code></pre>
<ul>
<li>ูฺฉุชู ฺฉูุฏ: <strong>t3_conditional</strong> ุชููุง ููุช ุงุฌุฑุง ูโุดูุฏ ฺฉู <code>fault</code> ูุงูุนุงู ุงุฌุฑุง ุดุฏู ุจุงุดุฏ.</li>
<li>ุจุฏูู ุดุฑุท <code>NotOnCanceled</code>ุ ุญุช ุงฺฏุฑ <code>fault</code> ุงุฌุฑุง ูุดูุฏ (ูุบู ุดูุฏ)ุ <code>t3</code> ุงุฌุฑุง ูโุดูุฏ.</li>
</ul>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-9.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>Continuations ุจุง ฺูุฏ antecedent ู TaskFactory ๐๏ธ</h3>
<h4>1๏ธโฃ Continuations ุจุง ฺูุฏ antecedent</h4>
<ul>
<li>ูโุชูุงู ฺฉ continuation ุฑุง ุทูุฑ ุจุฑูุงููโุฑุฒ ฺฉุฑุฏ ฺฉู ุจุนุฏ ุงุฒ ุงุชูุงู <strong>ฺูุฏ task</strong> ุงุฌุฑุง ุดูุฏ.</li>
<li>ุฏู ุฑูุด ุงุตู ุฏุฑ <strong>TaskFactory</strong> ูุฌูุฏ ุฏุงุฑุฏ:</li>
</ul>
<table>
<thead>
<tr>
<th>ุฑูุด</th>
<th>ุชูุถุญ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ContinueWhenAll</code></td>
<td>continuation ูพุณ ุงุฒ ุงุชูุงู ููู antecedentูุง ุงุฌุฑุง ูโุดูุฏ</td>
</tr>
<tr>
<td><code>ContinueWhenAny</code></td>
<td>continuation ูพุณ ุงุฒ ุงุชูุงู ูุฑ ฺฉ ุงุฒ antecedentูุง ุงุฌุฑุง ูโุดูุฏ</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ูุซุงู ุจุง <code>ContinueWhenAll</code>:</p>
</blockquote>
<pre><code class="language-csharp">var task1 = Task.Run(() =&gt; Console.Write(&quot;X&quot;));
var task2 = Task.Run(() =&gt; Console.Write(&quot;Y&quot;));

var continuation = Task.Factory.ContinueWhenAll(
    new[] { task1, task2 },
    tasks =&gt; Console.WriteLine(&quot;Done&quot;)
);
</code></pre>
<ul>
<li>ููุงู ูุชุฌู ุจุง <strong>task combinator</strong> <code>WhenAll</code>:</li>
</ul>
<pre><code class="language-csharp">var continuation = Task.WhenAll(task1, task2)
                       .ContinueWith(ant =&gt; Console.WriteLine(&quot;Done&quot;));
</code></pre>
<hr>
<h4>2๏ธโฃ ฺูุฏ continuation ุฑู ฺฉ antecedent</h4>
<ul>
<li>ูโุชูุงู ฺูุฏ <code>ContinueWith</code> ุฑู ฺฉ task ูุงุญุฏ ุตุฏุง ุฒุฏ.</li>
<li>ููู continuationูุง ูพุณ ุงุฒ ูพุงุงู antecedent ุดุฑูุน ูโุดููุฏ (ูฺฏุฑ ฺฏุฒูู <code>ExecuteSynchronously</code> ูุดุฎุต ุดูุฏ).</li>
</ul>
<pre><code class="language-csharp">var t = Task.Factory.StartNew(() =&gt; Thread.Sleep(1000));
t.ContinueWith(ant =&gt; Console.Write(&quot;X&quot;));
t.ContinueWith(ant =&gt; Console.Write(&quot;Y&quot;));
// ุฎุฑูุฌ ูโุชูุงูุฏ XY ุง YX ุจุงุดุฏ
</code></pre>
<hr>
<h4>3๏ธโฃ Task Schedulers ๐๏ธ</h4>
<ul>
<li>
<p><strong>TaskScheduler</strong> ฺฉุงุฑ ุชุฎุตุต task ุจู threadูุง ุฑุง ุงูุฌุงู ูโุฏูุฏ.</p>
</li>
<li>
<p>ุฏู ูพุงุฏูโุณุงุฒ ุงุณุชุงูุฏุงุฑุฏ:</p>
<ol>
<li><strong>Default scheduler:</strong> ุจุง CLR thread pool ฺฉุงุฑ ูโฺฉูุฏ.</li>
<li><strong>Synchronization context scheduler:</strong> ุจุฑุง UI ูุซู WPF ุง Windows Formsุ ุชุง ููุท thread ุงุฌุงุฏฺฉููุฏู ฺฉูุชุฑูโูุง ุจู ุขููุง ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดุฏ.</li>
</ol>
</li>
</ul>
<blockquote>
<p>ูุซุงู: ุงุฌุฑุง ฺฉ continuation ุฑู UI thread:</p>
</blockquote>
<pre><code class="language-csharp">_uiScheduler = TaskScheduler.FromCurrentSynchronizationContext();
Task.Run(() =&gt; Foo())
    .ContinueWith(ant =&gt; lblResult.Content = ant.Result, _uiScheduler);
</code></pre>
<ul>
<li>ููฺูู ุงูฺฉุงู ููุดุชู TaskScheduler ุณูุงุฑุด ุจุง subclassing ูุฌูุฏ ุฏุงุฑุฏุ ูู ุจุดุชุฑ ุฏุฑ ุณูุงุฑููุง ุฎุงุต ฺฉุงุฑุจุฑุฏ ุฏุงุฑุฏ.</li>
</ul>
<hr>
<h4>4๏ธโฃ TaskFactory ๐ญ</h4>
<ul>
<li>
<p><code>Task.Factory</code> ฺฉ <strong>TaskFactory ูพุดโูุฑุถ</strong> ุจุงุฒูโฺฏุฑุฏุงูุฏ.</p>
</li>
<li>
<p>ฺฉุงุฑฺฉุฑุฏ ุงุตู: ุงุฌุงุฏ ุณู ููุน task:</p>
<ol>
<li>Ordinary tasks (<code>StartNew</code>)</li>
<li>Continuations ุจุง ฺูุฏ antecedent (<code>ContinueWhenAll</code>, <code>ContinueWhenAny</code>)</li>
<li>Tasks ฺฉู ูุชุฏูุง ูุฏู APM ุฑุง wrap ูโฺฉููุฏ (<code>FromAsync</code>)</li>
</ol>
</li>
<li>
<p>ูโุชูุงู TaskFactory ุฎูุฏ ุฑุง ุจุง ููุงุฏุฑ ูพุดโูุฑุถ ุณูุงุฑุด ุณุงุฎุช:</p>
</li>
</ul>
<pre><code class="language-csharp">var factory = new TaskFactory(
    TaskCreationOptions.LongRunning | TaskCreationOptions.AttachedToParent,
    TaskContinuationOptions.None
);

// ุงุณุชูุงุฏู ุงุฒ factory ุจุฑุง ุงุฌุงุฏ taskูุง
Task task1 = factory.StartNew(Method1);
Task task2 = factory.StartNew(Method2);
</code></pre>
<ul>
<li>ูุฒุช: ุงุฏุงููโูุง ู taskูุง ุจู ุตูุฑุช ฺฉูพุงุฑฺู ุจุง ููุงู ุชูุธูุงุช ุณูุงุฑุด ุงุฌุฑุง ูโุดููุฏ.</li>
</ul>
<h3>ฺฉุงุฑ ุจุง AggregateException โ๏ธ</h3>
<p>ููุงูโุทูุฑ ฺฉู ุฏุฏูุ <strong>PLINQ</strong>ุ ฺฉูุงุณ <strong>Parallel</strong> ู <strong>Tasks</strong> ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุงุณุชุซูุงูุง ุฑุง ุจู ูุตุฑูโฺฉููุฏู ููุชูู ูโฺฉููุฏ. ุจุฑุง ุฏุฑฺฉ ุงููุช ุงู ููุถูุนุ ูุฑุถ ฺฉูุฏ ฺฉูุฆุฑ LINQ ุฒุฑ ุฑุง ุฏุงุฑู ฺฉู ุฏุฑ ุงููู ุชฺฉุฑุงุฑุ ฺฉ <strong>DivideByZeroException</strong> ุงุฌุงุฏ ูโฺฉูุฏ:</p>
<pre><code class="language-csharp">try
{
    var query = from i in Enumerable.Range(0, 1000000)
                select 100 / i;
    ...
}
catch (DivideByZeroException)
{
    ...
}
</code></pre>
<p>ุงฺฏุฑ ุงุฒ PLINQ ุจุฎูุงูู ุงู ฺฉูุฆุฑ ุฑุง ููุงุฒโุณุงุฒ ฺฉูุฏ ู ุฑุณุฏฺฏ ุจู ุงุณุชุซูุงูุง ุฑุง ูุงุฏุฏู ุจฺฏุฑุฏุ ุงุญุชูุงูุงู <strong>DivideByZeroException</strong> ุฏุฑ ฺฉ ูุฎ (Thread) ุฌุฏุงฺฏุงูู ุฑุฎ ุฎูุงูุฏ ุฏุงุฏุ ุจุฏูู ุขู ฺฉู ุจูุงฺฉ <code>catch</code> ูุง ุงุฌุฑุง ุดูุฏ ู ุจุงุนุซ ฺฉุฑุด ฺฉุฑุฏู ุจุฑูุงูู ุฎูุงูุฏ ุดุฏ.</p>
<p>ุจูุงุจุฑุงูุ ุงุณุชุซูุงูุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ฺฏุฑูุชู ุดุฏู ู ุฏูุจุงุฑู ุจู ูุฑุงุฎูุงููุฏู ูพุฑุชุงุจ ูโุดููุฏ. ุงูุง ูุชุฃุณูุงูู ููุถูุน ุจู ุณุงุฏฺฏ ฺฏุฑูุชู ฺฉ <strong>DivideByZeroException</strong> ูุณุช. ฺูู ุงู ฺฉุชุงุจุฎุงููโูุง ุงุฒ ฺูุฏู ูุฎ ุงุณุชูุงุฏู ูโฺฉููุฏุ ููฺฉู ุงุณุช ุฏู ุง ฺูุฏ ุงุณุชุซูุง ููุฒูุงู ูพุฑุชุงุจ ุดููุฏ. ุจุฑุง ุงุทููุงู ุงุฒ ฺฏุฒุงุฑุด ููู ุงุณุชุซูุงูุงุ ุขูโูุง ุฏุงุฎู ฺฉ <strong>AggregateException</strong> ูุฑุงุฑ ูโฺฏุฑูุฏ ฺฉู ูพุฑุงูพุฑุช <strong>InnerExceptions</strong> ุขู ุดุงูู ููู ุงุณุชุซูุงูุง ฺฏุฑูุชู ุดุฏู ุงุณุช:</p>
<pre><code class="language-csharp">try
{
    var query = from i in ParallelEnumerable.Range(0, 1000000)
                select 100 / i;
    // ุงุฌุฑุง ฺฉูุฆุฑ
    ...
}
catch (AggregateException aex)
{
    foreach (Exception ex in aex.InnerExceptions)
        Console.WriteLine(ex.Message);
}
</code></pre>
<p>ูุฑ ุฏู <strong>PLINQ</strong> ู ฺฉูุงุณ <strong>Parallel</strong> ุงุฌุฑุง ฺฉูุฆุฑ ุง ุญููู ุฑุง ุจุง ุงููู ุงุณุชุซูุง ุฎุงุชูู ูโุฏููุฏ ู ุนูุงุตุฑ ุง ุจุฏูู ุญูููโูุง ุจุนุฏ ูพุฑุฏุงุฒุด ููโุดููุฏ. ููฺฉู ุงุณุช ูุจู ุงุฒ ูพุงุงู ฺุฑุฎู ุฌุงุฑุ ุงุณุชุซูุงูุง ุฏฺฏุฑ ูู ูพุฑุชุงุจ ุดููุฏ. ุงููู ุงุณุชุซูุง ุฏุฑ <strong>AggregateException</strong> ุงุฒ ุทุฑู ูพุฑุงูพุฑุช <strong>InnerException</strong> ุฏุฑ ุฏุณุชุฑุณ ุงุณุช.</p>
<hr>
<h3>Flatten ู Handle ๐๏ธ</h3>
<p>ฺฉูุงุณ <strong>AggregateException</strong> ุฏู ุฑูุด ุจุฑุง ุณุงุฏูโุณุงุฒ ูุฏุฑุช ุงุณุชุซูุง ุงุฑุงุฆู ูโุฏูุฏ: <strong>Flatten</strong> ู <strong>Handle</strong>.</p>
<h4>Flatten</h4>
<p>ุงุบูุจ <strong>AggregateException</strong> ุดุงูู <strong>AggregateException</strong>ูุง ุฏฺฏุฑ ูุฒ ูโุดูุฏ. ุงู ุญุงูุช ูุนูููุงู ุฒูุงู ุฑุฎ ูโุฏูุฏ ฺฉู ฺฉ <strong>Child Task</strong> ุงุณุชุซูุง ูพุฑุชุงุจ ฺฉูุฏ. ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>Flatten</strong> ูโุชูุงู ูุฑ ุณุทุญ ุงุฒ ุชูุฏุฑุชู ุฑุง ุญุฐู ฺฉุฑุฏ ุชุง ูุฏุฑุช ุณุงุฏูโุชุฑ ุดูุฏ. ุงู ูุชุฏ ฺฉ <strong>AggregateException</strong> ุฌุฏุฏ ุจุง ูุณุช ูุณุทุญ ุงุฒ ุงุณุชุซูุงูุง ุฏุงุฎู ุจุฑูโฺฏุฑุฏุงูุฏ:</p>
<pre><code class="language-csharp">catch (AggregateException aex)
{
    foreach (Exception ex in aex.Flatten().InnerExceptions)
        myLogWriter.LogException(ex);
}
</code></pre>
<h4>Handle</h4>
<p>ฺฏุงู ูุงุฒู ุงุณุช ููุท ููุน ุฎุงุต ุงุฒ ุงุณุชุซูุงูุง ฺฏุฑูุชู ุดููุฏ ู ุจูู ุฏูุจุงุฑู ูพุฑุชุงุจ ุดููุฏ. ูุชุฏ <strong>Handle</strong> ุงู ฺฉุงุฑ ุฑุง ุณุงุฏู ูโฺฉูุฏ. ุงู ูุชุฏ ฺฉ <strong>predicate</strong> ุงุฒ ููุน <code>Func&lt;Exception, bool&gt;</code> ูโฺฏุฑุฏ ู ุฑู ูุฑ ุงุณุชุซูุง ุฏุงุฎู ุงุฌุฑุง ูโฺฉูุฏ:</p>
<pre><code class="language-csharp">public void Handle(Func&lt;Exception, bool&gt; predicate)
</code></pre>
<p>ุงฺฏุฑ <strong>predicate</strong> ููุฏุงุฑ <code>true</code> ุจุฑฺฏุฑุฏุงูุฏุ ุขู ุงุณุชุซูุง &quot;ูุฏุฑุช ุดุฏู&quot; ูุญุณูุจ ูโุดูุฏ. ูพุณ ุงุฒ ุงุฌุฑุง delegate ุฑู ููู ุงุณุชุซูุงูุง:</p>
<ul>
<li>ุงฺฏุฑ ููู ุงุณุชุซูุงูุง ูุฏุฑุช ุดุฏู ุจุงุดูุฏุ ุฏูุจุงุฑู ูพุฑุชุงุจ ููโุดููุฏ.</li>
<li>ุงฺฏุฑ ุงุณุชุซูุง ูุฏุฑุช ูุดุฏู ุจุงุดุฏ (<code>false</code>)ุ ฺฉ <strong>AggregateException</strong> ุฌุฏุฏ ุดุงูู ุขู ุงุณุชุซูุงูุง ุงุฌุงุฏ ุดุฏู ู ูพุฑุชุงุจ ูโุดูุฏ.</li>
</ul>
<p>ูุซุงู ุฒุฑ ฺฉ <strong>AggregateException</strong> ุฏฺฏุฑ ุดุงูู ฺฉ <strong>NullReferenceException</strong> ุงุฌุงุฏ ูโฺฉูุฏ:</p>
<pre><code class="language-csharp">var parent = Task.Factory.StartNew(() =&gt; 
{
    int[] numbers = { 0 };
    var childFactory = new TaskFactory(TaskCreationOptions.AttachedToParent, TaskContinuationOptions.None);
    childFactory.StartNew(() =&gt; 5 / numbers[0]);   // ุชูุณู ุจุฑ ุตูุฑ
    childFactory.StartNew(() =&gt; numbers[1]);       // ุฎุงุฑุฌ ุงุฒ ูุญุฏูุฏู
    childFactory.StartNew(() =&gt; { throw null; });  // ุงุฑุฌุงุน null
});

try { parent.Wait(); }
catch (AggregateException aex)
{
    aex.Flatten().Handle(ex =&gt; // ูุงุฒ ุจู Flatten ุฏุงุฑู
    {
        if (ex is DivideByZeroException)
        {
            Console.WriteLine(&quot;Divide by zero&quot;);
            return true; // ูุฏุฑุช ุดุฏ
        }
        if (ex is IndexOutOfRangeException)
        {
            Console.WriteLine(&quot;Index out of range&quot;);
            return true; // ูุฏุฑุช ุดุฏ
        }
        return false; // ุณุงุฑ ุงุณุชุซูุงูุง ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดููุฏ
    });
}
</code></pre>
<hr>
<h3>ูุฌููุนูโูุง ููุฒูุงู (Concurrent Collections) ๐๏ธ</h3>
<p>.NET ูุฌููุนูโูุง <strong>Thread-Safe</strong> ุฑุง ุฏุฑ ูุถุง ูุงู <strong>System.Collections.Concurrent</strong> ุงุฑุงุฆู ูโุฏูุฏุ ฺฉู ุจุฑุง ูุฏุฑุช ุฏุงุฏูโูุง ุฏุฑ ูุญุทโูุง ฺูุฏูุฎ ุจุณุงุฑ ููุฏ ูุณุชูุฏ.</p>
 <div align="center">
<p><img src="../../../assets/image/22/Table-22-10.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ูุฌููุนูโูุง ููุฒูุงู (Concurrent Collections) ๐๏ธ</h3>
<p>ูุฌููุนูโูุง <strong>ููุฒูุงู</strong> ุจุฑุง ุณูุงุฑููุง <strong>ุจุง ููโุฒูุงู ุจุงูุง</strong> ุจูููโุณุงุฒ ุดุฏูโุงูุฏุ ุจุง ุงู ุญุงูุ ูุฑ ุฒูุงู ฺฉู ุจู ฺฉ <strong>ูุฌููุนู Thread-Safe</strong> ูุงุฒ ุฏุงุดุชู ุจุงุดุฏ (ุจู ุฌุง ุงุณุชูุงุฏู ุงุฒ ููู ุฑู ฺฉ ูุฌููุนู ุนุงุฏ) ูู ูโุชูุงููุฏ ููุฏ ุจุงุดูุฏ. ุจุง ุงู ุญุงูุ ฺูุฏ ูฺฉุชู ููู ูุฌูุฏ ุฏุงุฑุฏ:</p>
<ul>
<li>ูุฌููุนูโูุง <strong>ุณูุช</strong> ุฏุฑ ููู ุณูุงุฑููุง ุจู ุฌุฒ ููุงุฑุฏ ุจุง <strong>ููโุฒูุงู ุจุณุงุฑ ุจุงูุง</strong> ุนููฺฉุฑุฏ ุจูุชุฑ ุฏุงุฑูุฏ.</li>
<li>ฺฉ ูุฌููุนู <strong>Thread-Safe</strong> ุชุถูู ููโฺฉูุฏ ฺฉู ฺฉุฏ ฺฉู ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉูุฏ ูุฒ <strong>Thread-Safe</strong> ุจุงุดุฏ (ุจู ูุตู ยซLocking and Thread Safetyยป ุตูุญู 898 ูุฑุงุฌุนู ฺฉูุฏ).</li>
<li>ุงฺฏุฑ ุฑู ฺฉ ูุฌููุนู ููุฒูุงู ุฏุฑ ุญุงู ฺฉู ูุฎ ุฏฺฏุฑ ุฏุฑ ุญุงู ุชุบุฑ ุขู ุงุณุชุ <strong>Enumeration</strong> ุงูุฌุงู ุฏูุฏุ ูฺ ุงุณุชุซูุง ูพุฑุชุงุจ ููโุดูุฏุ ุจูฺฉู ุชุฑฺฉุจ ุงุฒ ูุญุชูุง ูุฏู ู ุฌุฏุฏ ูุดุงูุฏู ุฎูุงูุฏ ฺฉุฑุฏ.</li>
<li>ูุณุฎู ููุฒูุงู ุงุฒ <strong>List<T></strong> ูุฌูุฏ ูุฏุงุฑุฏ.</li>
<li>ฺฉูุงุณโูุง <strong>ConcurrentStack</strong>ุ <strong>ConcurrentQueue</strong> ู <strong>ConcurrentBag</strong> ุจูโุตูุฑุช ุฏุงุฎู ุจุง <strong>ูุณุชโูุง ูพููุฏ</strong> ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏ. ุงู ุจุงุนุซ ูโุดูุฏ ฺฉู ูุตุฑู ุญุงูุธู ุขูโูุง ูุณุจุช ุจู <strong>Stack</strong> ู <strong>Queue</strong> ุบุฑููุฒูุงู ุจุดุชุฑ ุจุงุดุฏุ ุงูุง ุฏุณุชุฑุณ ููุฒูุงู ุฑุง ุจููู ูโฺฉูุฏุ ุฒุฑุง ูุณุชโูุง ูพููุฏ ุจุฑุง ูพุงุฏูโุณุงุฒโูุง ุจุฏูู ููู ุง ฺฉูโููู ููุงุณุจโุงูุฏ. (ฺุฑุง ฺฉู ุงุถุงูู ฺฉุฑุฏู ฺฉ ฺฏุฑู ุจู ูุณุช ูพููุฏ ุชููุง ูุงุฒููุฏ ุจูโุฑูุฒุฑุณุงู ฺูุฏ ูุฑุฌุน ุงุณุชุ ุฏุฑ ุญุงู ฺฉู ุงุถุงูู ฺฉุฑุฏู ฺฉ ุนูุตุฑ ุจู ุณุงุฎุชุงุฑ ุดุจู <strong>List<T></strong> ููฺฉู ุงุณุช ูุงุฒ ุจู ุฌุงุจูโุฌุง ูุฒุงุฑุงู ุนูุตุฑ ุฏุงุดุชู ุจุงุดุฏ.)</li>
</ul>
<p>ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุงู ูุฌููุนูโูุง ุตุฑูุงู ุฌุงฺฏุฒู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ <strong>ฺฉ ูุฌููุนู ุนุงุฏ ุจุง ููู</strong> ูุณุชูุฏ. ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉุฏ ุฒุฑ ุฑุง ุฑู ฺฉ ูุฎ ุงุฌุฑุง ฺฉูู:</p>
<pre><code class="language-csharp">var d = new ConcurrentDictionary&lt;int,int&gt;();
for (int i = 0; i &lt; 1000000; i++) d[i] = 123;
</code></pre>
<p>ุงู ฺฉุฏ <strong>ุณู ุจุฑุงุจุฑ ฺฉูุฏุชุฑ</strong> ุงุฒ ุญุงูุช ุฒุฑ ุงุฌุฑุง ูโุดูุฏ:</p>
<pre><code class="language-csharp">var d = new Dictionary&lt;int,int&gt;();
for (int i = 0; i &lt; 1000000; i++) lock (d) d[i] = 123;
</code></pre>
<p>(ุจุง ุงู ุญุงูุ <strong>ุฎูุงูุฏู ุงุฒ ConcurrentDictionary</strong> ุณุฑุน ุงุณุชุ ุฒุฑุง ุจุฏูู ููู ุงูุฌุงู ูโุดูุฏ.)</p>
<hr>
<p>ูุฌููุนูโูุง ููุฒูุงู ููฺูู ุจุง ูุฌููุนูโูุง ูุนููู ูุชูุงูุชโุงูุฏุ ุฒุฑุง <strong>ูุชุฏูุง ูฺูโุง ุจุฑุง ุงูุฌุงู ุนููุงุชโูุง ุงุชูฺฉ Test-and-Act</strong> ุงุฑุงุฆู ูโฺฉููุฏุ ูุงููุฏ <strong>TryPop</strong>. ุงฺฉุซุฑ ุงู ูุชุฏูุง ุงุฒ ุทุฑู <strong>ุฑุงุจุท IProducerConsumerCollection<T></strong> ฺฉูพุงุฑฺู ุดุฏูโุงูุฏ.</p>
<hr>
<h3>IProducerConsumerCollection<T> โ๏ธ</h3>
<p>ฺฉ <strong>ูุฌููุนู Producer/Consumer</strong> ูุฌููุนูโุง ุงุณุช ฺฉู ุฏู ฺฉุงุฑุจุฑุฏ ุงุตู ุฏุงุฑุฏ:</p>
<ul>
<li><strong>ุงุถุงูู ฺฉุฑุฏู ฺฉ ุนูุตุฑ (&quot;Producing&quot;)</strong></li>
<li><strong>ุฏุฑุงูุช ู ุญุฐู ฺฉ ุนูุตุฑ (&quot;Consuming&quot;)</strong></li>
</ul>
<p>ูุซุงูโูุง ฺฉูุงุณฺฉ ุงู ููุน ูุฌููุนูโูุงุ <strong>Stack</strong> ู <strong>Queue</strong> ูุณุชูุฏ. ุงู ูุฌููุนูโูุง ุฏุฑ ุจุฑูุงููโููุณ ููุงุฒ ุงููุช ุฏุงุฑูุฏ ุฒุฑุง ุจุฑุง ูพุงุฏูโุณุงุฒโูุง <strong>lock-free</strong> ุจูููโุงูุฏ.</p>
<p>ุฑุงุจุท <strong>IProducerConsumerCollection<T></strong> ููุงุงูฺฏุฑ ฺฉ <strong>ูุฌููุนู Producer/Consumer ุงูู ุจุฑุง ูุฎโูุง</strong> ุงุณุช. ฺฉูุงุณโูุง ุฒุฑ ุงู ุฑุงุจุท ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉููุฏ:</p>
<ul>
<li><strong>ConcurrentStack<T></strong></li>
<li><strong>ConcurrentQueue<T></strong></li>
<li><strong>ConcurrentBag<T></strong></li>
</ul>
<p>ุงู ุฑุงุจุท ุงุฒ <strong>ICollection</strong> ุงุฑุซโุจุฑ ูโฺฉูุฏ ู ูุชุฏูุง ุฒุฑ ุฑุง ุงุถุงูู ูโฺฉูุฏ:</p>
<pre><code class="language-csharp">void CopyTo(T[] array, int index);
T[] ToArray();
bool TryAdd(T item);
bool TryTake(out T item);
</code></pre>
<ul>
<li><strong>TryAdd</strong> ู <strong>TryTake</strong> ุจุฑุฑุณ ูโฺฉููุฏ ฺฉู ุขุง ูโุชูุงู ุนููุงุช ุงูุฒูุฏู ุง ุญุฐู ุฑุง ุงูุฌุงู ุฏุงุฏุ ุงฺฏุฑ ููฺฉู ุจุงุดุฏุ ุขู ุฑุง ุงูุฌุงู ูโุฏููุฏ. ุชุณุช ู ุนูู ุจูโุตูุฑุช <strong>ุงุชูฺฉ</strong> ุงูุฌุงู ูโุดูุฏุ ุจูุงุจุฑุงู ูุงุฒ ุจู ููู ูุงููุฏ ูุฌููุนูโูุง ูุนููู ูุณุช:</li>
</ul>
<pre><code class="language-csharp">int result;
lock (myStack) if (myStack.Count &gt; 0) result = myStack.Pop();
</code></pre>
<ul>
<li><strong>TryTake</strong> ุงฺฏุฑ ูุฌููุนู ุฎุงู ุจุงุดุฏุ ููุฏุงุฑ <code>false</code> ุจุฑูโฺฏุฑุฏุงูุฏ.</li>
<li><strong>TryAdd</strong> ุฏุฑ ุณู ูพุงุฏูโุณุงุฒ ุงุฑุงุฆูโุดุฏู ููุดู ูููู ุงุณุช ู <code>true</code> ุจุฑูโฺฏุฑุฏุงูุฏ.</li>
<li>ุงฺฏุฑ ุดูุง ูุฌููุนู ููุฒูุงู ุฎูุฏ ุฑุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ ฺฉู ุนูุงุตุฑ ุชฺฉุฑุงุฑ ุฑุง ุงุฌุงุฒู ูุฏูุฏุ ูโุชูุงูุฏ <strong>TryAdd</strong> ุฑุง ุทูุฑ ูพุงุฏูโุณุงุฒ ฺฉูุฏ ฺฉู ุฏุฑ ุตูุฑุช ูุฌูุฏ ุนูุตุฑุ <code>false</code> ุจุฑฺฏุฑุฏุงูุฏ (ูุซูุงู ฺฉ <strong>Concurrent Set</strong>).</li>
</ul>
<p>ุนูุตุฑ ฺฉู <strong>TryTake</strong> ุญุฐู ูโฺฉูุฏุ ุชูุณุท ุฒุฑฺฉูุงุณ ุชุนู ูโุดูุฏ:</p>
<ul>
<li>ุฏุฑ <strong>Stack</strong>ุ ุขุฎุฑู ุนูุตุฑ ุงุถุงููโุดุฏู ุญุฐู ูโุดูุฏ.</li>
<li>ุฏุฑ <strong>Queue</strong>ุ ุงููู ุนูุตุฑ ุงุถุงููโุดุฏู ุญุฐู ูโุดูุฏ.</li>
<li>ุฏุฑ <strong>Bag</strong>ุ ูุฑ ุนูุตุฑ ฺฉู ุจุชูุงูุฏ ุจูโุตูุฑุช ุจููู ุญุฐู ุดูุฏุ ุญุฐู ูโุดูุฏ.</li>
</ul>
<p>ุณู ฺฉูุงุณ ุงุตู ูุนูููุงู <strong>TryTake</strong> ู <strong>TryAdd</strong> ุฑุง ุจูโุตูุฑุช ุตุฑุญ ูพุงุฏูโุณุงุฒ ูโฺฉููุฏ ู ููุงู ุนููฺฉุฑุฏ ุฑุง ุงุฒ ุทุฑู ูุชุฏูุง ุนููู ุจุง ูุงูโูุง ุฎุงุตโุชุฑ ูุงููุฏ <strong>TryDequeue</strong> ู <strong>TryPop</strong> ุฏุฑ ุงุฎุชุงุฑ ูุฑุงุฑ ูโุฏููุฏ.</p>
<h3>ConcurrentBag<T> ๐</h3>
<p>ฺฉูุงุณ <strong>ConcurrentBag<T></strong> ฺฉ ูุฌููุนู <strong>ุจุฏูู ุชุฑุชุจ</strong> ุงุฒ ุงุดุงุก ุฐุฎุฑู ูโฺฉูุฏ ู <strong>ุชฺฉุฑุงุฑ ุจูุฏู ุนูุงุตุฑ ูุฌุงุฒ ุงุณุช</strong>. ุงู ฺฉูุงุณ ุจุฑุง ููุงูุน ููุงุณุจ ุงุณุช ฺฉู <strong>ุจุฑุงุชุงู ููู ูุณุช ฺู ุนูุตุฑ ููฺฏุงู ูุฑุงุฎูุงู Take ุง TryTake ุฏุฑุงูุช ูโฺฉูุฏ</strong>.</p>
<p>ูุฒุช <strong>ConcurrentBag<T></strong> ูุณุจุช ุจู <strong>ConcurrentQueue</strong> ุง <strong>ConcurrentStack</strong> ุงู ุงุณุช ฺฉู ูุชุฏ <strong>Add</strong> ุขู ุชูุฑุจุงู ูฺ <strong>ููโุฒูุงู (contention)</strong> ุงุฌุงุฏ ููโฺฉูุฏ ุญุช ููุช ุชูุณุท ฺูุฏู ูุฎ ุจูโุทูุฑ ููุฒูุงู ูุฑุงุฎูุงู ุดูุฏ.</p>
<p>ุฏุฑ ููุงุจูุ ูุฑุงุฎูุงู <strong>Add</strong> ุจูโุตูุฑุช ููุงุฒ ุฑู <strong>Queue</strong> ุง <strong>Stack</strong> ฺฉู ููโุฒูุงู ุงุฌุงุฏ ูโฺฉูุฏ (ูุฑฺูุฏ ุจุณุงุฑ ฺฉูุชุฑ ุงุฒ ูููโฺฏุฐุงุฑ ุฑู ฺฉ ูุฌููุนู ุบุฑููุฒูุงู). ูุฑุงุฎูุงู <strong>Take</strong> ุฑู ฺฉ <strong>ConcurrentBag</strong> ูุฒ ุจุณุงุฑ ุจููู ุงุณุชุ ุจู ุดุฑุท ุขู ฺฉู ูุฑ ูุฎ ุจุดุชุฑ ุงุฒ ุชุนุฏุงุฏ ุนูุงุตุฑ ฺฉู ุงุถุงูู ฺฉุฑุฏูุ ุนูุตุฑ ูฺฏุฑุฏ.</p>
<p>ุฏุฑ ุฏุงุฎู <strong>ConcurrentBag</strong>ุ ูุฑ ูุฎ <strong>ูุณุช ูพููุฏ ุฎุตูุต ุฎูุฏ</strong> ุฑุง ุฏุงุฑุฏ. ุนูุงุตุฑ ุจู ูุณุช ุฎุตูุต ููุงู ูุฎ ุงุถุงูู ูโุดููุฏ ฺฉู <strong>Add</strong> ุฑุง ูุฑุงุฎูุงู ฺฉุฑุฏู ุงุณุช ู ุงู ุจุงุนุซ ุญุฐู <strong>ููโุฒูุงู</strong> ูโุดูุฏ. ููุช ุฑู bag <strong>Enumeration</strong> ุงูุฌุงู ูโุฏูุฏุ Enumerator ุจู ุชุฑุชุจ ุงุฒ ูุฑ ูุณุช ุฎุตูุต ูุฎโูุง ุนุจูุฑ ูโฺฉูุฏ ู ุนูุงุตุฑ ุขูโูุง ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ.</p>
<p>ููุช <strong>Take</strong> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ุงุจุชุฏุง ุจู <strong>ูุณุช ุฎุตูุต ูุฎ ุฌุงุฑ</strong> ูฺฏุงู ูโฺฉูุฏ. ุงฺฏุฑ ุญุฏุงูู ฺฉ ุนูุตุฑ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ุนููุงุช ุจูโุฑุงุญุช ู ุจุฏูู ููโุฒูุงู ุงูุฌุงู ูโุดูุฏ. ุงูุง ุงฺฏุฑ ูุณุช ุฎุงู ุจุงุดุฏุ ุจุงุฏ ุนูุตุฑ ุฑุง ุงุฒ ูุณุช ุฎุตูุต ูุฎ ุฏฺฏุฑ <strong>&quot;ุณุฑูุช&quot;</strong> ฺฉูุฏ ู ุงุญุชูุงู ุงุฌุงุฏ ููโุฒูุงู ูุฌูุฏ ุฏุงุฑุฏ.</p>
<p>ุจูุงุจุฑุงูุ ุฏููุงู ูโุชูุงู ฺฏูุช ฺฉู <strong>Take</strong> ุนูุตุฑ ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ุงุฎุฑุงู ุชูุณุท ููุงู ูุฎ ุงุถุงูู ุดุฏู ุงุณุชุ ุงฺฏุฑ ุฏุฑ ุขู ูุฎ ุนูุตุฑ ูุจุงุดุฏุ ุนูุตุฑ ุงุฒ ูุฎ ุฏฺฏุฑ ุจูโุตูุฑุช ุชุตุงุฏู ุจุงุฒฺฏุฑุฏุงูุฏู ูโุดูุฏ.</p>
<p><strong>ConcurrentBag</strong> ุจุฑุง ููุงูุน ุงุฏูโุขู ุงุณุช ฺฉู ุนููุงุช ููุงุฒ ุฑู ูุฌููุนู ุดูุง ุนูุฏุชุงู ุดุงูู <strong>ุงูุฒูุฏู ุนูุงุตุฑ</strong> ุจุงุดุฏุ ุง ุฒูุงู ฺฉู <strong>ุงูุฒูุฏู ู ุจุฑุฏุงุดุชู ุนูุงุตุฑ ุฑู ูุฑ ูุฎ ูุชุนุงุฏู</strong> ุงุณุช. ูุซุงู ูุจู ุงุฒ ุงุณุชูุงุฏู ุงุฒ <strong>Parallel.ForEach</strong> ุจุฑุง ูพุงุฏูโุณุงุฒ <strong>SpellChecker ููุงุฒ</strong> ุฑุง ุจู ุงุฏ ุจุงูุฑุฏ:</p>
<pre><code class="language-csharp">var misspellings = new ConcurrentBag&lt;Tuple&lt;int,string&gt;&gt;();
Parallel.ForEach(wordsToTest, (word, state, i) =&gt;
{
  if (!wordLookup.Contains(word))
    misspellings.Add(Tuple.Create((int)i, word));
});
</code></pre>
<p>ุงูุง ุงุณุชูุงุฏู ุงุฒ <strong>ConcurrentBag</strong> ุจุฑุง ฺฉ <strong>ุตู Producer/Consumer</strong> ููุงุณุจ ูุณุชุ ุฒุฑุง ุนูุงุตุฑ ุชูุณุท ูุฎโูุง ูุฎุชูู ุงุถุงูู ู ุญุฐู ูโุดููุฏ.</p>
<hr>
<h3>BlockingCollection<T> โ</h3>
<p>ุงฺฏุฑ ุฑู ูุฑ ฺฉ ุงุฒ ูุฌููุนูโูุง Producer/Consumer ูุงููุฏ <strong>ConcurrentStack<T></strong>ุ <strong>ConcurrentQueue<T></strong> ู <strong>ConcurrentBag<T></strong> ูุชุฏ <strong>TryTake</strong> ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ู ูุฌููุนู ุฎุงู ุจุงุดุฏุ ูุชุฏ ููุฏุงุฑ <code>false</code> ุจุฑูโฺฏุฑุฏุงูุฏ. ฺฏุงู ููุฏ ุงุณุช ฺฉู <strong>ุชุง ุฒูุงู ฺฉู ฺฉ ุนูุตุฑ ููุฌูุฏ ุดูุฏุ ููุชุธุฑ ุจูุงูู</strong>.</p>
<p>ุจู ุฌุง ุงุถุงูู ฺฉุฑุฏู ุงู ูุงุจูุช ุจู <strong>TryTake</strong> (ฺฉู ุจุงุนุซ ูพฺุฏฺฏ ุฒุงุฏ ุงุนุถุง ูโุดุฏ ู ุจุฑุง ูพุดุชุจุงู ุงุฒ <strong>CancellationToken</strong> ู <strong>Timeout</strong> ููุงุณุจ ูุจูุฏ)ุ ุทุฑุงุญุงู <strong>PFX</strong> ุงู ูุงุจูุช ุฑุง ุฏุฑ ฺฉูุงุณ <strong>BlockingCollection<T></strong> ูุฑุงุฑ ุฏุงุฏูุฏ.</p>
<p><strong>BlockingCollection<T></strong> ูุฑ ูุฌููุนูโุง ฺฉู <strong>IProducerConsumerCollection<T></strong> ุฑุง ูพุงุฏูโุณุงุฒ ฺฉุฑุฏู ุจุงุดุฏุ ุฏุฑ ุฎูุฏ ูโูพฺุงูุฏ ู ุงุฌุงุฒู ูโุฏูุฏ ุงุฒ ุขู <strong>Take</strong> ุงูุฌุงู ุฏูุฏโู ุงฺฏุฑ ุนูุตุฑ ููุฌูุฏ ูุจุงุดุฏุ ุนููุงุช <strong>Block</strong> ูโุดูุฏ.</p>
<p>ููฺููุ <strong>BlockingCollection</strong> ูโุชูุงูุฏ ุงูุฏุงุฒู ฺฉู ูุฌููุนู ุฑุง ูุญุฏูุฏ ฺฉูุฏ ู ุงฺฏุฑ ุงู ุงูุฏุงุฒู ุฑุนุงุช ูุดูุฏุ ุชููุฏฺฉููุฏู <strong>Block</strong> ูโุดูุฏ. ฺูู ูุฌููุนูโุง ุจู ูุงู <strong>Bounded Blocking Collection</strong> ุดูุงุฎุชู ูโุดูุฏ.</p>
<hr>
<h4>ูุญูู ุงุณุชูุงุฏู ุงุฒ BlockingCollection<T> ๐</h4>
<ol>
<li>ูููููโุง ุงุฒ ฺฉูุงุณ ุจุณุงุฒุฏ ู ุงุฎุชุงุฑ <strong>IProducerConsumerCollection<T></strong> ุจุฑุง wrap ฺฉุฑุฏู ู ุญุฏุงฺฉุซุฑ ุงูุฏุงุฒู (Bound) ุฑุง ูุดุฎุต ฺฉูุฏ.</li>
<li>ุจุง <strong>Add</strong> ุง <strong>TryAdd</strong> ุนูุงุตุฑ ุฑุง ุจู ูุฌููุนู ุฏุงุฎู ุงุถุงูู ฺฉูุฏ.</li>
<li>ุจุง <strong>Take</strong> ุง <strong>TryTake</strong> ุนูุงุตุฑ ุฑุง ุงุฒ ูุฌููุนู ุฏุงุฎู ุญุฐู ุง ูุตุฑู ฺฉูุฏ.</li>
</ol>
<p>ุงฺฏุฑ ุณุงุฒูุฏู ุจุฏูู ูุฌููุนู ุฏุงุฎู ูุฑุงุฎูุงู ุดูุฏุ ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉ <strong>ConcurrentQueue<T></strong> ุณุงุฎุชู ูโุดูุฏ. ูุชุฏูุง ุชููุฏ ู ูุตุฑู ุงุฌุงุฒู ุงุณุชูุงุฏู ุงุฒ <strong>CancellationToken</strong> ู <strong>Timeout</strong> ุฑุง ูโุฏููุฏ. <strong>Add</strong> ู <strong>TryAdd</strong> ููฺฉู ุงุณุช Block ุดููุฏ ุงฺฏุฑ ุงูุฏุงุฒู ูุฌููุนู ูุญุฏูุฏ ุจุงุดุฏุ <strong>Take</strong> ู <strong>TryTake</strong> ููฺฏุงู ุฎุงู ุจูุฏู ูุฌููุนู Block ูโุดููุฏ.</p>
<p>ุฑูุด ุฏฺฏุฑ ุจุฑุง ูุตุฑู ุนูุงุตุฑุ ูุฑุงุฎูุงู <strong>GetConsumingEnumerable</strong> ุงุณุช ฺฉู ฺฉ <strong>ุฏูุจุงูู (sequence) ุจุงูููู ูุงูุญุฏูุฏ</strong> ุจุฑูโฺฏุฑุฏุงูุฏ ู ุนูุงุตุฑ ุฑุง ุจู ูุญุถ ุฏุฑ ุฏุณุชุฑุณ ุดุฏู ุงุฑุงุฆู ูโุฏูุฏ. ูโุชูุงูุฏ ุจุง ูุฑุงุฎูุงู <strong>CompleteAdding</strong> ุฏูุจุงูู ุฑุง ุฎุงุชูู ุฏูุฏุ ุงู ูุชุฏ ููฺูู ุงุฌุงุฒู enqueue ฺฉุฑุฏู ุนูุงุตุฑ ุฌุฏุฏ ุฑุง ููโุฏูุฏ.</p>
<p><strong>BlockingCollection</strong> ูุชุฏูุง ุงุณุชุงุชฺฉ <strong>AddToAny</strong> ู <strong>TakeFromAny</strong> ูุฒ ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุงุฌุงุฒู ูโุฏูุฏ ฺฉ ุนูุตุฑ ุฑุง ุจู ฺูุฏ ูุฌููุนู ููุฒูุงู ุงุถุงูู ุง ุงุฒ ุขูโูุง ุจุฑุฏุงุฑุฏ ู ุงููู ูุฌููุนูโุง ฺฉู ุชูุงูุณุช ุงู ุฏุฑุฎูุงุณุช ุฑุง ุงูุฌุงู ุฏูุฏุ ุนููุงุช ุฑุง ุงูุฌุงู ูโุฏูุฏ.</p>
<h3>ููุดุชู ฺฉ ุตู Producer/Consumer ๐ญ๐ฅ</h3>
<p>ฺฉ <strong>ุตู Producer/Consumer</strong> ุณุงุฎุชุงุฑ ุจุณุงุฑ ููุฏ ุงุณุชุ ูู ุฏุฑ <strong>ุจุฑูุงููโููุณ ููุงุฒ</strong> ู ูู ุฏุฑ <strong>ุณูุงุฑููุง ุนููู ููโุฒูุงู</strong>. ุนููฺฉุฑุฏ ุขู ุจู ุงู ุตูุฑุช ุงุณุช:</p>
<ul>
<li>ฺฉ <strong>Queue</strong> ุจุฑุง ูฺฏูุฏุงุฑ ุขุชูโูุง ฺฉุงุฑ ุง ุฏุงุฏูโูุง ฺฉู ุนููุงุช ุฑู ุขูโูุง ุงูุฌุงู ูโุดูุฏุ ุงุฌุงุฏ ูโฺฉูู.</li>
<li>ูุฑฺฏุงู ฺฉ ฺฉุงุฑ ูุงุฒ ุจู ุงุฌุฑุง ุฏุงุดุชู ุจุงุดุฏุ ุฏุฑ ุตู ูุฑุงุฑ ูโฺฏุฑุฏ (<strong>Enqueue</strong>) ู ูุฑุงุฎูุงููุฏู ูโุชูุงูุฏ ุจู ฺฉุงุฑูุง ุฏฺฏุฑ ุจูพุฑุฏุงุฒุฏ.</li>
<li>ฺฉ ุง ฺูุฏ <strong>ูุฎ Worker</strong> ุฏุฑ ูพุณโุฒููู ูุนุงูุช ูโฺฉููุฏ ู ุขุชูโูุง ุตู ุฑุง ุจุฑุฏุงุดุชู ู ุงุฌุฑุง ูโฺฉููุฏ.</li>
</ul>
<p>ฺฉ <strong>ุตู Producer/Consumer</strong> ฺฉูุชุฑู ุฏูู ุฑู ุชุนุฏุงุฏ ูุฎโูุง ฺฉู ููโุฒูุงู ุงุฌุฑุง ูโุดููุฏ ูุฑุงูู ูโฺฉูุฏ. ุงู ูุงุจูุช ูู ุชููุง ุจุฑุง ูุญุฏูุฏ ฺฉุฑุฏู ูุตุฑู CPU ุจูฺฉู ุจุฑุง ูุฏุฑุช ููุงุจุน ุฏฺฏุฑ ูุฒ ููุฏ ุงุณุช. ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉุงุฑูุง ุนููุงุชโูุง ุณูฺฏู I/O ุฑู ุฏุณฺฉ ุงูุฌุงู ุฏููุฏุ ูโุชูุงู <strong>Concurrency</strong> ุฑุง ูุญุฏูุฏ ฺฉุฑุฏ ุชุง ุณุณุชูโุนุงูู ู ุณุงุฑ ุจุฑูุงููโูุง ุฏฺุงุฑ ูุดฺฉู ูุดููุฏ. ููฺูู ูโุชูุงู ุฏุฑ ุทูู ุนูุฑ ุตูุ <strong>Workers</strong> ุฑุง ุจูโุตูุฑุช ุฏูุงูฺฉ ุงุถุงูู ุง ุญุฐู ฺฉุฑุฏ.</p>
<p>ุฎูุฏ <strong>Thread Pool</strong> ุฏุฑ CLR ููุน ุตู <strong>Producer/Consumer</strong> ุงุณุช ฺฉู ุจุฑุง <strong>ฺฉุงุฑูุง ฺฉูุชุงู ูุฏุช ู Compute-bound</strong> ุจููู ุดุฏู ุงุณุช.</p>
<p>ฺฉ <strong>ุตู Producer/Consumer</strong> ูุนูููุงู ุดุงูู ุขุชูโูุง ุงุณุช ฺฉู ููุงู <strong>ฺฉุงุฑ</strong> ุฑู ุขูโูุง ุงูุฌุงู ูโุดูุฏ. ุจุฑุง ูุซุงูุ ุขุชูโูุง ููฺฉู ุงุณุช ูุงู ูุงูโูุง ุจุงุดูุฏ ู ฺฉุงุฑุ ุฑูุฒฺฏุฐุงุฑ ุขูโูุง ุจุงุดุฏ. ุงูุง ุงฺฏุฑ ุขุชู ุฑุง ุจู ุดฺฉู ฺฉ <strong>Delegate</strong> ุฏุฑ ูุธุฑ ุจฺฏุฑูุ ูโุชูุงู ฺฉ <strong>ุตู Producer/Consumer ุนูููโุชุฑ</strong> ููุดุช ฺฉู ูุฑ ุขุชู ูุงุฏุฑ ุจู ุงูุฌุงู ูุฑ ุนูู ุจุงุดุฏ.</p>
<p>ุฏุฑ <a href="http://albahari.com/threading">albahari.com/threading</a> ูุดุงู ุฏุงุฏู ุดุฏู ฺฉู ฺฺฏููู ูโุชูุงู ฺฉ <strong>Producer/Consumer Queue</strong> ุงุฒ ุตูุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>AutoResetEvent</strong> (ู ุจุนุฏุงู ุจุง <strong>Monitor.Wait/Pulse</strong>) ููุดุช.</p>
<p>ุจุง ุงู ุญุงูุ ููุดุชู ฺฉ ุตู ุงุฒ ุตูุฑ <strong>ุถุฑูุฑ ูุณุช</strong>ุ ุฒุฑุง ุงฺฉุซุฑ ูุงุจูุชโูุง ุชูุณุท <strong>BlockingCollection<T></strong> ูุฑุงูู ุดุฏูโุงูุฏ.</p>
<hr>
<h4>ูุซุงู ุงุณุชูุงุฏู ุงุฒ BlockingCollection ุจุฑุง ุตู PCQueue ๐๏ธ</h4>
<pre><code class="language-csharp">public class PCQueue : IDisposable
{
  BlockingCollection&lt;Action&gt; _taskQ = new BlockingCollection&lt;Action&gt;();

  public PCQueue(int workerCount)
  {
    // ุงุฌุงุฏ ู ุดุฑูุน ฺฉ Task ุฌุฏุงฺฏุงูู ุจุฑุง ูุฑ ูุตุฑูโฺฉููุฏู:
    for (int i = 0; i &lt; workerCount; i++)
      Task.Factory.StartNew(Consume);
  }

  public void Enqueue(Action action) { _taskQ.Add(action); }

  void Consume()
  {
    // ุงู ุฏูุจุงูู ููฺฏุงู ูุจูุฏ ุนูุตุฑ Block ูโุดูุฏ
    // ู ุจุง ูุฑุงุฎูุงู CompleteAdding ุฎุงุชูู ูโุงุจุฏ.
    foreach (Action action in _taskQ.GetConsumingEnumerable())
      action();  // ุงุฌุฑุง ฺฉุงุฑ
  }

  public void Dispose() { _taskQ.CompleteAdding(); }
}
</code></pre>
<p>ฺูู ฺุฒ ุจู ุณุงุฒูุฏู <strong>BlockingCollection</strong> ุงุฑุณุงู ูฺฉุฑุฏูโุงูุ ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉ <strong>ConcurrentQueue</strong> ุงุฌุงุฏ ูโุดูุฏ. ุงฺฏุฑ ฺฉ <strong>ConcurrentStack</strong> ูโุฏุงุฏูุ ุตู ุจู ฺฉ <strong>Producer/Consumer Stack</strong> ุชุจุฏู ูโุดุฏ.</p>
<hr>
<h3>ุงุณุชูุงุฏู ุงุฒ Tasks ุฏุฑ ุตู Producer/Consumer ๐</h3>
<p>ุตู ฺฉู ููุดุชู ฺฉู <strong>ุบุฑ ููุนุทู</strong> ุงุณุชุ ุฒุฑุง ุจุนุฏ ุงุฒ ูุฑุงุฑ ุฏุงุฏู ฺฉุงุฑูุง ุฏุฑ ุตู ููโุชูุงูู ูุถุนุช ุขูโูุง ุฑุง ุฏูุจุงู ฺฉูู. ูุซูุงู ุฎูุจ ุงุณุช ุงฺฏุฑ ุจุชูุงูู:</p>
<ul>
<li>ุจุฏุงูู ฺฉ ฺฉุงุฑ <strong>ุชูุงู ุดุฏู ุงุณุช</strong> (ู ุจุชูุงูู await ฺฉูู)</li>
<li>ฺฉ ฺฉุงุฑ ุฑุง <strong>ูุบู ฺฉูู</strong></li>
<li>ุจู ุดฺฉู ุฒุจุง ุจุง <strong>ุงุณุชุซูุงูุง</strong> ูพุฑุชุงุจ ุดุฏู ุชูุณุท ฺฉุงุฑ ุจุฑุฎูุฑุฏ ฺฉูู</li>
</ul>
<p>ุฑุงู ุญู ุงุฏูโุขู ุงู ุงุณุช ฺฉู ูุชุฏ <strong>Enqueue</strong> ฺฉ <strong>Task</strong> ุจุฑฺฏุฑุฏุงูุฏ ุชุง ุจุชูุงูู ููู ุงู ูุงุจูุชโูุง ุฑุง ุฏุงุดุชู ุจุงุดู. ุฎูุดุจุฎุชุงูู ฺฉูุงุณ <strong>Task</strong> ุฏููุงู ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ ู ูโุชูุงู ุขู ุฑุง ุจุง <strong>TaskCompletionSource</strong> ุง ุจุง <strong>ุงุฌุงุฏ ูุณุชูู</strong> ฺฉ Task (Cold/Unstarted) ุชููุฏ ฺฉุฑุฏ.</p>
<hr>
<h4>ูุซุงู PCQueue ุจุง Task ๐ฏ</h4>
<pre><code class="language-csharp">public class PCQueue : IDisposable
{
  BlockingCollection&lt;Task&gt; _taskQ = new BlockingCollection&lt;Task&gt;();

  public PCQueue(int workerCount)
  {
    for (int i = 0; i &lt; workerCount; i++)
      Task.Factory.StartNew(Consume);
  }

  public Task Enqueue(Action action, CancellationToken cancelToken = default)
  {
    var task = new Task(action, cancelToken);
    _taskQ.Add(task);
    return task;
  }

  public Task&lt;TResult&gt; Enqueue&lt;TResult&gt;(Func&lt;TResult&gt; func, CancellationToken cancelToken = default)
  {
    var task = new Task&lt;TResult&gt;(func, cancelToken);
    _taskQ.Add(task);
    return task;
  }

  void Consume()
  {
    foreach (var task in _taskQ.GetConsumingEnumerable())
      try 
      {
          if (!task.IsCanceled) task.RunSynchronously();
      } 
      catch (InvalidOperationException) { }  // ุดุฑุงุท ูุงุฏุฑ Race Condition
  }

  public void Dispose() { _taskQ.CompleteAdding(); }
}
</code></pre>
<p>ุฏุฑ ูุชุฏ <strong>Enqueue</strong>ุ ฺฉ <strong>Task</strong> ุงุฌุงุฏ ูโฺฉููุ ุขู ุฑุง ุฏุฑ ุตู ูุฑุงุฑ ูโุฏูู ู ุจู ูุฑุงุฎูุงููุฏู ุจุฑูโฺฏุฑุฏุงูู ุจุฏูู ุงูฺฉู ุงุฌุฑุง ุดูุฏ. ุฏุฑ ูุชุฏ <strong>Consume</strong>ุ <strong>Task</strong> ุฑู ูุฎ ูุตุฑูโฺฉููุฏู <strong>ุจูโุตูุฑุช ููโุฒูุงู ุงุฌุฑุง</strong> ูโุดูุฏ. ุจุง ฺฏุฑูุชู <strong>InvalidOperationException</strong>ุ ุดุฑุงุท ูุงุฏุฑ ูุบู ููโุฒูุงู Task ูุฏุฑุช ูโุดูุฏ.</p>
<hr>
<h4>ููููู ุงุณุชูุงุฏู</h4>
<pre><code class="language-csharp">var pcQ = new PCQueue(2);    // ุญุฏุงฺฉุซุฑ concurrency ุจุฑุงุจุฑ ฒ
string result = await pcQ.Enqueue(() =&gt; &quot;That was easy!&quot;);
</code></pre>
<p>ุจุง ุงู ุฑูุดุ <strong>ุชูุงู ูุฒุงุง Task</strong> ุงุฒ ุฌููู <strong>ุงูุชุดุงุฑ ุงุณุชุซูุงูุงุ ุจุงุฒฺฏุดุช ููุงุฏุฑ ู ูุบู</strong> ุฑุง ุฏุงุฑูุ ุฏุฑ ุญุงู ฺฉู <strong>ฺฉูุชุฑู ฺฉุงูู ุฑู ุฒูุงูโุจูุฏ ุงุฌุฑุง ฺฉุงุฑูุง</strong> ูุฒ ุฏุฑ ุงุฎุชุงุฑูุงู ุงุณุช.</p>

  </main>

  <!-- ููุชุฑ ูุดุชุฑฺฉ -->
  <footer class="footer">
    <div class="container">
      <p>
        <img src="/icone/copyright.svg" alt="ฺฉูพโุฑุงุช" width="14" height="14"
             style="vertical-align:middle;margin-inline:4px">
        <span id="y"></span> Gitab โ ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู
      </p>
    </div>
  </footer>

  <!-- ุณุงู + ุงุณฺฉุฑูพุช ุชู -->
  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    (() => {
      const root = document.documentElement;
      const btn = document.getElementById('themeToggle');
      const KEY = 'gitab-theme';
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      const getEffective = s => s === 'auto' ? (media.matches ? 'dark' : 'light') : s;
      function updateTheme(s) {
        root.setAttribute('data-theme', s);
        const mode = getEffective(s);
        root.dataset.colorMode = mode;
        btn.dataset.icon = mode === 'dark' ? 'moon' : 'sun';
      }
      const saved = localStorage.getItem(KEY) || 'auto';
      updateTheme(saved);
      btn.addEventListener('click', () => {
        const curr = localStorage.getItem(KEY) || 'auto';
        const next = curr === 'auto' ? 'dark' : curr === 'dark' ? 'light' : 'auto';
        localStorage.setItem(KEY, next);
        updateTheme(next);
      });
      media.addEventListener('change', () => {
        if ((localStorage.getItem(KEY) || 'auto') === 'auto') updateTheme('auto');
      });
      window.addEventListener('DOMContentLoaded', () => updateTheme(saved));
    })();
  </script>
</body>
</html>
