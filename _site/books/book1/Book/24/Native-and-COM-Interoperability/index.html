

<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="/Gitab/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ฺฉูพุงุฑฺูโุณุงุฒ ุจุง Native ู COM</title>
  <meta name="description" content="ุชุฑุฌููโูุง ูุงุฑุณ ฺฉุชุงุจโูุง ูู โ ุณุฑุนุ ูููุงู ู ูุงุจู ุงุชฺฉุง.">

  <!-- ุงุณุชุงูโูุง -->
  <link rel="stylesheet" href="/Gitab/styles/main.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

  <style>
  @font-face {
    font-family: 'Vazir';
    src: url('/Gitab/fonts/Vazir-FD-WOL.ttf') format('truetype');
    font-display: swap;
  }
  body {
    font-family: 'Vazir', sans-serif;
  }
  </style>
</head>

<body>
  <!-- ูุฏุฑ ูุดุชุฑฺฉ -->
  <header class="header">
    <div class="container nav-wrap">
      <a href="/Gitab/" class="brand">
        <img src="/Gitab/icone/logo.svg" alt="Gitab logo" width="26" height="26">
        <span>Gitab</span>
      </a>

      <nav class="nav">
        <a href="/Gitab/" aria-current="page">ุฎุงูู</a>
        <a href="/Gitab/books/list-books">ฺฉุชุงุจโูุง</a>
       <a href="/Gitab/translator.html">ูุชุฑุฌูู</a>
        <a href="/Gitab/giter.html">ฺฏุชุฑ</a>
      </nav>

      <div class="nav-actions">
        <button id="themeToggle" class="icon-btn theme-btn" data-icon="moon" aria-label="ุชุบุฑ ุชู">
          <img src="/Gitab/icone/sun.svg" class="icon-sun" alt="ุฑูุดู">
          <img src="/Gitab/icone/moon.svg" class="icon-moon" alt="ุชุงุฑฺฉ">
        </button>

        <a class="icon-btn" href="https://github.com/hheydarian/Gitab" target="_blank" title="GitHub">
          <img src="/Gitab/icone/github.svg" alt="GitHub">
        </a>

        <!-- ุฏฺฉูู ููู ุจุฑุง ููุจุงู -->
        <button class="menu-toggle" aria-label="ููู">
          <img src="/Gitab/icone/menu.svg" alt="menu">
        </button>
      </div>
    </div>
  </header>

  
  <main class="site-main book-page">
    <h1>ูุตู ุจุณุช ู ฺูุงุฑู: ฺฉูพุงุฑฺูโุณุงุฒ ุจุง Native ู COM</h1>
<p>ุงู ูุตู ุชูุถุญ ูโุฏูุฏ ฺฺฏููู ุจุง ฺฉุชุงุจุฎุงููโูุง Native (ุบุฑูุฏุฑุชโุดุฏู) Dynamic-Link (DLL) ู ฺฉุงููพูููุชโูุง Component Object Model (COM) ฺฉูพุงุฑฺู ุดูุฏ. ูฺฏุฑ ุงูฺฉู ุฎูุงู ุขู ุฐฺฉุฑ ุดุฏู ุจุงุดุฏุ ุงููุงุน ุฏุงุฏูโุง ฺฉู ุฏุฑ ุงู ูุตู ุขูุฏูโุงูุฏ ุฏุฑ ูุถุง ูุงู <strong>System</strong> ุง <strong>System.Runtime.InteropServices</strong> ูุฌูุฏ ุฏุงุฑูุฏ.</p>
<hr>
<h4>ูุฑุงุฎูุงู DLLูุง Native ๐ฆ</h4>
<p><strong>P/Invoke</strong>ุ ฺฉูุชุงู ุดุฏูโ <strong>Platform Invocation Services</strong>ุ ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุจู ุชูุงุจุนุ ุณุงุฎุชุงุฑูุง ู callbackโูุง ุฏุฑ DLLูุง ุบุฑูุฏุฑุชโุดุฏู (ฺฉุชุงุจุฎุงููโูุง ูุดุชุฑฺฉ ุฏุฑ Unix) ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏ.</p>
<p>ุจุฑุง ูุซุงูุ ุชุงุจุน <code>MessageBox</code> ฺฉู ุฏุฑ DLL ููุฏูุฒ <strong>user32.dll</strong> ุชุนุฑู ุดุฏู ุงุณุช ุจู ุดฺฉู ุฒุฑ ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-type">int</span> <span class="hljs-title function_">MessageBox</span><span class="hljs-params">(HWND hWnd, LPCTSTR lpText, LPCTSTR lpCaption, UINT uType)</span>;
</code></pre>
<p>ูโุชูุงูุฏ ุงู ุชุงุจุน ุฑุง ูุณุชููุงู ุจุง ุชุนุฑู ฺฉ ูุชุฏ <strong>static</strong> ุจุง ููุงู ูุงูุ ุงุณุชูุงุฏู ุงุฒ ฺฉููู ฺฉูุฏ <code>extern</code> ู ุงูุฒูุฏู attribute <code>DllImport</code> ูุฑุงุฎูุงู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;

MessageBox(IntPtr.Zero, 
           <span class="hljs-string">&quot;Please do not press this again.&quot;</span>, <span class="hljs-string">&quot;Attention&quot;</span>, <span class="hljs-number">0</span>);

[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">MessageBox</span>(<span class="hljs-params">IntPtr hWnd, <span class="hljs-built_in">string</span> text, <span class="hljs-built_in">string</span> caption, <span class="hljs-built_in">int</span> type</span>)</span>;
</code></pre>
<p>ฺฉูุงุณโูุง <code>MessageBox</code> ุฏุฑ ูุถุง ูุงูโูุง <strong>System.Windows</strong> ู <strong>System.Windows.Forms</strong> ุฎูุฏุดุงู ูุชุฏูุง ูุดุงุจู ุบุฑูุฏุฑุชโุดุฏู ุฑุง ูุฑุงุฎูุงู ูโฺฉููุฏ.</p>
<p>ูููููโุง ุงุฒ <code>DllImport</code> ุจุฑุง <strong>Ubuntu Linux</strong>:</p>
<pre class="hljs"><code>Console.WriteLine(<span class="hljs-string">$&quot;User ID: <span class="hljs-subst">{getuid()}</span>&quot;</span>);

[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;libc&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">uint</span> <span class="hljs-title">getuid</span>()</span>;
</code></pre>
<p>CLR ุดุงูู ฺฉ <strong>marshaler</strong> ุงุณุช ฺฉู ูโุฏุงูุฏ ฺฺฏููู ูพุงุฑุงูุชุฑูุง ู ููุงุฏุฑ ุจุงุฒฺฏุดุช ุจู ุงููุงุน .NET ู ุงููุงุน ุบุฑูุฏุฑุชโุดุฏู ุชุจุฏู ุดููุฏ. ุฏุฑ ูุซุงู ููุฏูุฒุ ูพุงุฑุงูุชุฑูุง <code>int</code> ูุณุชููุงู ุจู ุนุฏุฏ ุตุญุญ ฺูุงุฑ ุจุงุช ฺฉู ุชุงุจุน ุงูุชุธุงุฑ ุฏุงุฑุฏ ุชุจุฏู ูโุดููุฏ ู ูพุงุฑุงูุชุฑูุง <code>string</code> ุจู ุขุฑุงูโูุง Unicode ูพุงุงูโุงูุชู ุจุง null (UTF-16) ุชุจุฏู ูโุดููุฏ.<br>
<code>IntPtr</code> ฺฉ struct ุงุณุช ฺฉู ุจุฑุง ูพูุดุด ฺฉ <strong>handle</strong> ุบุฑูุฏุฑุชโุดุฏู ุทุฑุงุญ ุดุฏูุ ุฏุฑ ูพูุชูุฑูโูุง ณฒ ุจุชุ ณฒ ุจุช ู ุฏุฑ ูพูุชูุฑูโูุง ถด ุจุชุ ถด ุจุช ุนุฑุถ ุฏุงุฑุฏ. ุชุจุฏู ูุดุงุจู ุฏุฑ Unix ูุฒ ุงูุฌุงู ูโุดูุฏ. (ุงุฒ C# 9 ุจู ุจุนุฏุ ูโุชูุงูุฏ ุงุฒ ููุน <code>nint</code> ูู ุงุณุชูุงุฏู ฺฉูุฏ ฺฉู ุจู <code>IntPtr</code> ูฺฏุงุดุช ูโุดูุฏ.)</p>
<hr>
<h4>Marshaling ุงููุงุน ู ูพุงุฑุงูุชุฑูุง โ๏ธ</h4>
<h5>Marshaling ุงููุงุน ุฑุงุฌ</h5>
<p>ุฏุฑ ุณูุช ุบุฑูุฏุฑุชโุดุฏูุ ููฺฉู ุงุณุช ุจุฑุง ููุงุด ฺฉ ููุน ุฏุงุฏู ุจุด ุงุฒ ฺฉ ุฑูุด ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.<br>
ุจุฑุง ูุซุงูุ ฺฉ ุฑุดุชู (<code>string</code>) ูโุชูุงูุฏ ุดุงูู ฺฉุงุฑุงฺฉุชุฑูุง ุชฺฉโุจุงุช ANSI ุง ฺฉุงุฑุงฺฉุชุฑูุง Unicode UTF-16 ุจุงุดุฏ ู ุทูู ุขู ูโุชูุงูุฏ ุจุง ูพุดโููุฏ ูุดุฎุต ุดูุฏุ ุง null-terminated ุจุงุดุฏุ ุง ุทูู ุซุงุจุช ุฏุงุดุชู ุจุงุดุฏ.</p>
<p>ุจุง ุงุณุชูุงุฏู ุงุฒ attribute <code>MarshalAs</code> ูโุชูุงูุฏ ุจู marshaler CLR ูุดุฎุต ฺฉูุฏ ฺฉุฏุงู ุญุงูุช ุงุณุชูุงุฏู ุดูุฏ ุชุง ุชุจุฏู ุตุญุญ ุงูุฌุงู ฺฏุฑุฏ. ูุซุงู:</p>
<pre class="hljs"><code>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;...&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Foo</span>(<span class="hljs-params">[MarshalAs(UnmanagedType.LPStr</span>)] <span class="hljs-built_in">string</span> s)</span>;
</code></pre>
<p>enum <code>UnmanagedType</code> ุดุงูู ุชูุงู ุงููุงุน Win32 ู COM ุงุณุช ฺฉู marshaler ุขูโูุง ุฑุง ูโุดูุงุณุฏ. ุฏุฑ ุงู ูุซุงูุ marshaler ุจู ุชุฑุฌูู ุจู <code>LPStr</code> ุฏุณุชูุฑ ุฏุงุฏู ุดุฏุ ฺฉู ฺฉ ุฑุดุชู ุชฺฉโุจุงุช ANSI ูพุงุงูโุงูุชู ุจุง null ุงุณุช.</p>
<p>ุฏุฑ ุณูุช .NET ูุฒ ุดูุง ูโุชูุงูุฏ ููุน ุฏุงุฏูโุง ฺฉู ุงุณุชูุงุฏู ูโฺฉูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ. <strong>Handles</strong> ุบุฑูุฏุฑุชโุดุฏูุ ุจุฑุง ูุซุงูุ ูโุชูุงููุฏ ุจู <code>IntPtr</code>ุ <code>int</code>ุ <code>uint</code>ุ <code>long</code> ุง <code>ulong</code> ูฺฏุงุดุช ุดููุฏ.</p>
<p>ุจุดุชุฑ handles ุบุฑูุฏุฑุชโุดุฏู ฺฉ ุขุฏุฑุณ ุง pointer ุฑุง ุฏุฑ ุจุฑ ุฏุงุฑูุฏ ู ุจูุงุจุฑุงู ุจุฑุง ุณุงุฒฺฏุงุฑ ุจุง ุณุณุชูโุนุงููโูุง ณฒ ู ถด ุจุช ุจุงุฏ ุจู <code>IntPtr</code> ูฺฏุงุดุช ุดููุฏ. ฺฉ ูุซุงู ูุนูููุ <code>HWND</code> ุงุณุช.</p>
<p>ุงุบูุจ ุฏุฑ ุชูุงุจุน Win32 ู POSIXุ ุจุง ูพุงุฑุงูุชุฑูุง ุนุฏุฏ ุตุญุญ ููุงุฌู ูโุดูุฏ ฺฉู ูุฌููุนูโุง ุงุฒ <strong>constants</strong> ุฑุง ูโูพุฐุฑูุฏุ ฺฉู ุฏุฑ ูุงู ูุฏุฑ C++ ูุงููุฏ <code>WinUser.h</code> ุชุนุฑู ุดุฏูโุงูุฏ. ุจู ุฌุง ุชุนุฑู ุขูโูุง ุจู ุนููุงู constants ุณุงุฏู ุฏุฑ C#ุ ูโุชูุงูุฏ ุขูโูุง ุฑุง ุฏุฑ ฺฉ <strong>enum</strong> ุชุนุฑู ฺฉูุฏ. ุงุณุชูุงุฏู ุงุฒ enum ุจุงุนุซ ุชูุฒุชุฑ ุดุฏู ฺฉุฏ ู ุงูุฒุงุด ุงูู ููุน ูโุดูุฏ. ูููููโุง ุฏุฑ ุจุฎุด ยซShared Memoryยป ุฏุฑ ุตูุญู นนต ุงุฑุงุฆู ุดุฏู ุงุณุช.</p>
<hr>
<p>ููฺฏุงู ูุตุจ <strong>Microsoft Visual Studio</strong>ุ ุญุชูุงู ูุงูโูุง ูุฏุฑ C++ ุฑุง ูุตุจ ฺฉูุฏโุญุช ุงฺฏุฑ ูฺ ููุฑุฏ ุฏฺฏุฑ ุงุฒ ุฏุณุชู C++ ุงูุชุฎุงุจ ูฺฉุฑุฏู ุจุงุดุฏ. ุงูุฌุง ุฌุง ุงุณุช ฺฉู ุชูุงู constants ุจูู Win32 ุชุนุฑู ุดุฏูโุงูุฏ. ุณูพุณ ูโุชูุงูุฏ ููู ูุงูโูุง ูุฏุฑ ุฑุง ุจุง ุฌุณุชุฌู <code>*.h</code> ุฏุฑ ุฏุงุฑฺฉุชูุฑ ุจุฑูุงูู Visual Studio ูพุฏุง ฺฉูุฏ.</p>
<p>ุฏุฑ Unixุ ุงุณุชุงูุฏุงุฑุฏ POSIX ูุงูโูุง constants ุฑุง ุชุนุฑู ูโฺฉูุฏุ ุงูุง ูพุงุฏูโุณุงุฒโูุง ูุฑุฏ ุณุณุชูโูุง Unix ุณุงุฒฺฏุงุฑ ุจุง POSIX ููฺฉู ุงุณุช ููุงุฏุฑ ุนุฏุฏ ูุชูุงูุช ุจุฑุง ุงู constants ุงุฎุชุตุงุต ุฏููุฏ. ุจุงุฏ ุงุฒ ููุฏุงุฑ ุนุฏุฏ ุตุญุญ ุจุฑุง ุณุณุชูโุนุงูู ุฎูุฏ ุงุณุชูุงุฏู ฺฉูุฏ. ููฺููุ POSIX ฺฉ ุงุณุชุงูุฏุงุฑุฏ ุจุฑุง structูุง ุงุณุชูุงุฏูโุดุฏู ุฏุฑ ูุฑุงุฎูุงู interop ุชุนุฑู ูโฺฉูุฏ. ุชุฑุชุจ ููุฏูุง ุฏุฑ struct ุชูุณุท ุงุณุชุงูุฏุงุฑุฏ ุซุงุจุช ูุดุฏู ู ููฺฉู ุงุณุช ูพุงุฏูโุณุงุฒ Unix ููุฏูุง ุงุถุงู ุงุถุงูู ฺฉูุฏ. ูุงูโูุง ูุฏุฑ C++ ฺฉู ุชูุงุจุน ู ุงููุงุน ุฑุง ุชุนุฑู ูโฺฉููุฏ ูุนูููุงู ุฏุฑ <code>/usr/include</code> ุง <code>/usr/local/include</code> ูุตุจ ูโุดููุฏ.</p>
<hr>
<p>ุฏุฑุงูุช ุฑุดุชูโูุง ุงุฒ ฺฉุฏ ุบุฑูุฏุฑุชโุดุฏู ุจู .NET ูุงุฒููุฏ ูุฏุฑุช ุญุงูุธู ุงุณุช. marshaler ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ ุงฺฏุฑ ูุชุฏ ุฎุงุฑุฌ ุฑุง ุจุง <code>StringBuilder</code> ุจู ุฌุง <code>string</code> ุงุนูุงู ฺฉูุฏุ ูุงููุฏ:</p>
<pre class="hljs"><code>StringBuilder s = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-number">256</span>);
GetWindowsDirectory(s, <span class="hljs-number">256</span>);
Console.WriteLine(s);

[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;kernel32.dll&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetWindowsDirectory</span>(<span class="hljs-params">StringBuilder sb, <span class="hljs-built_in">int</span> maxChars</span>)</span>;
</code></pre>
<p>ุฏุฑ Unix ูุฒ ูุดุงุจู ุนูู ูโฺฉูุฏ. ูุซุงู ุฒุฑ ุชุงุจุน <code>getcwd</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ ุชุง ูุณุฑ ุฌุงุฑ ุฑุง ุจุงุฒฺฏุฑุฏุงูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-number">256</span>);
Console.WriteLine(getcwd(sb, sb.Capacity));

[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;libc&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">string</span> <span class="hljs-title">getcwd</span>(<span class="hljs-params">StringBuilder buf, <span class="hljs-built_in">int</span> size</span>)</span>;
</code></pre>
<p>ุงฺฏุฑฺู ุงุณุชูุงุฏู ุงุฒ <code>StringBuilder</code> ุฑุงุญุช ุงุณุชุ ุงูุง ฺฉู ูุงฺฉุงุฑุขูุฏ ุงุณุช ุฒุฑุง CLR ุจุงุฏ ุชุฎุตุตโูุง ุญุงูุธู ุงุถุงู ู ฺฉูพโฺฉุฑุฏูโูุง ุฑุง ุงูุฌุงู ุฏูุฏ. ุฏุฑ ููุงุท ุญุณุงุณ ุนููฺฉุฑุฏุ ูโุชูุงูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ <code>char[]</code> ุงู ุณุฑุจุงุฑ ุฑุง ฺฉุงูุด ุฏูุฏ:</p>
<pre class="hljs"><code>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;kernel32.dll&quot;</span>, CharSet = CharSet.Unicode)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetWindowsDirectory</span>(<span class="hljs-params"><span class="hljs-built_in">char</span>[] buffer, <span class="hljs-built_in">int</span> maxChars</span>)</span>;
</code></pre>
<p>ุชูุฌู ฺฉูุฏ ฺฉู ุจุงุฏ <code>CharSet</code> ุฑุง ุฏุฑ attribute <code>DllImport</code> ูุดุฎุต ฺฉูุฏ. ููฺูู ูพุณ ุงุฒ ูุฑุงุฎูุงู ุชุงุจุนุ ุจุงุฏ ุฑุดุชู ุฎุฑูุฌ ุฑุง ุจู ุทูู ููุงุณุจ ุจุฑุด ุฏูุฏ. ูโุชูุงูุฏ ุงู ฺฉุงุฑ ุฑุง ุจุง ุญุฏุงูู ุชุฎุตุต ุญุงูุธู ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>array pooling</strong> (ุตูุญู ตนน) ุงูุฌุงู ุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">GetWindowsDirectory</span>()</span>
{
    <span class="hljs-keyword">var</span> array = ArrayPool&lt;<span class="hljs-built_in">char</span>&gt;.Shared.Rent(<span class="hljs-number">256</span>);
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-built_in">int</span> length = GetWindowsDirectory(array, <span class="hljs-number">256</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(array, <span class="hljs-number">0</span>, length).ToString();
    }
    <span class="hljs-keyword">finally</span> { ArrayPool&lt;<span class="hljs-built_in">char</span>&gt;.Shared.Return(array); }
}
</code></pre>
<p>(ุงูุจุชูุ ุงู ูุซุงู ุตุฑูุงู ุขููุฒุด ุงุณุช ู ุดูุง ูโุชูุงูุฏ ูุณุฑ Windows ุฑุง ุงุฒ ุทุฑู ูุชุฏ ุฏุงุฎู <code>Environment.GetFolderPath</code> ุฏุฑุงูุช ฺฉูุฏ.)</p>
<p>ุงฺฏุฑ ูุทูุฆู ูุณุชุฏ ฺฺฏููู ฺฉ ูุชุฏ ุฎุงุต Win32 ุง Unix ุฑุง ูุฑุงุฎูุงู ฺฉูุฏุ ูุนูููุงู ุจุง ุฌุณุชุฌู ูุงู ุชุงุจุน ู <code>DllImport</code> ุฏุฑ ุงูุชุฑูุชุ ูููููโุง ูพุฏุง ุฎูุงูุฏ ฺฉุฑุฏ. ุจุฑุง ููุฏูุฒุ ุณุงุช <a href="http://www.pinvoke.net">http://www.pinvoke.net</a> ฺฉ ูฺฉ ุงุณุช ฺฉู ูุฏู ุขู ูุณุชูุฏุณุงุฒ ุชูุงู signatureูุง Win32 ุงุณุช.</p>
<h3>Marshaling ฺฉูุงุณโูุง ู Structูุง ๐ฆ</h3>
<p>ฺฏุงู ุงููุงุช ูุงุฒ ุฏุงุฑุฏ ฺฉ <strong>struct</strong> ุฑุง ุจู ฺฉ ูุชุฏ ุบุฑูุฏุฑุชโุดุฏู ุงุฑุณุงู ฺฉูุฏ. ุจุฑุง ูุซุงูุ ุชุงุจุน <code>GetSystemTime</code> ุฏุฑ API ููุฏูุฒ ุจู ุดฺฉู ุฒุฑ ุชุนุฑู ุดุฏู ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-type">void</span> <span class="hljs-title function_">GetSystemTime</span><span class="hljs-params">(LPSYSTEMTIME lpSystemTime)</span>;
</code></pre>
<p><code>LPSYSTEMTIME</code> ูุทุงุจู ุจุง ุงู struct ุฏุฑ C ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">SYSTEMTIME</span> {</span>
  WORD wYear;
  WORD wMonth;
  WORD wDayOfWeek;
  WORD wDay;
  WORD wHour;
  WORD wMinute;
  WORD wSecond;
  WORD wMilliseconds;
} SYSTEMTIME, *PSYSTEMTIME;
</code></pre>
<p>ุจุฑุง ูุฑุงุฎูุงู <code>GetSystemTime</code>ุ ุจุงุฏ ฺฉ ฺฉูุงุณ ุง struct ุฏุฑ .NET ุชุนุฑู ฺฉูู ฺฉู ุจุง ุงู struct ุฏุฑ C ูุทุงุจูุช ุฏุงุดุชู ุจุงุดุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;

[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">class</span> <span class="hljs-title">SystemTime</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">ushort</span> Year;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">ushort</span> Month;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">ushort</span> DayOfWeek;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">ushort</span> Day;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">ushort</span> Hour;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">ushort</span> Minute;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">ushort</span> Second;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">ushort</span> Milliseconds;
}
</code></pre>
<p>Attribute <code>StructLayout</code> ุจู marshaler ูโฺฏูุฏ ฺฺฏููู ูุฑ ููุฏ ุฑุง ุจู ูุนุงุฏู ุบุฑูุฏุฑุชโุดุฏูโุงุด ูฺฏุงุดุช ฺฉูุฏ. <code>LayoutKind.Sequential</code> ุจู ุงู ูุนู ุงุณุช ฺฉู ููุฏูุง ุจู ุชุฑุชุจ ูพุดุช ุณุฑ ูู ู ุฑู ูุฑุฒูุง <strong>pack-size</strong> ูุฑุงุฑ ูโฺฏุฑูุฏ (ฺฉู ุจุนุฏุงู ุชูุถุญ ุฏุงุฏู ูโุดูุฏ)ุ ุฏุฑุณุช ูุงููุฏ struct ุฏุฑ C. ูุงู ููุฏูุง ุงููุช ูุฏุงุฑุฏุ ุจูฺฉู <strong>ุชุฑุชุจ ููุฏูุง</strong> ููู ุงุณุช.</p>
<p>ุญุงูุง ูโุชูุงูู <code>GetSystemTime</code> ุฑุง ูุฑุงุฎูุงู ฺฉูู:</p>
<pre class="hljs"><code>SystemTime t = <span class="hljs-keyword">new</span> SystemTime();
GetSystemTime(t);
Console.WriteLine(t.Year);

[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;kernel32.dll&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetSystemTime</span>(<span class="hljs-params">SystemTime t</span>)</span>;
</code></pre>
<p>ุจูโุทูุฑ ูุดุงุจูุ ุฏุฑ Unix:</p>
<pre class="hljs"><code>Console.WriteLine(GetSystemTime());

<span class="hljs-function"><span class="hljs-keyword">static</span> DateTime <span class="hljs-title">GetSystemTime</span>()</span>
{
    DateTime startOfUnixTime = <span class="hljs-keyword">new</span> DateTime(<span class="hljs-number">1970</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, System.DateTimeKind.Utc);
    Timespec tp = <span class="hljs-keyword">new</span> Timespec();
    <span class="hljs-built_in">int</span> success = clock_gettime(<span class="hljs-number">0</span>, <span class="hljs-keyword">ref</span> tp);
    <span class="hljs-keyword">if</span> (success != <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">&quot;Error checking the time.&quot;</span>);
    <span class="hljs-keyword">return</span> startOfUnixTime.AddSeconds(tp.tv_sec).ToLocalTime();  
}

[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;libc&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">clock_gettime</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> clk_id, <span class="hljs-keyword">ref</span> Timespec tp</span>)</span>;

[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">struct</span> Timespec
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> tv_sec;   <span class="hljs-comment">/* ุซุงูู */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> tv_nsec;  <span class="hljs-comment">/* ูุงููุซุงูู */</span>
}
</code></pre>
<p>ุฏุฑ ูุฑ ุฏู ุฒุจุงู C ู C#ุ ููุฏูุง ฺฉ ุดุก ุฏุฑ ูุงุตููโุง ุงุฒ ุขุฏุฑุณ ุขู ุดุก ูุฑุงุฑ ุฏุงุฑูุฏ. ุชูุงูุช ุฏุฑ ุงู ุงุณุช ฺฉู ุฏุฑ ุจุฑูุงูู C#ุ CLR ุงู <strong>offset</strong> ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ token ููุฏ ูพุฏุง ูโฺฉูุฏุ ุงูุง ุฏุฑ Cุ ูุงู ููุฏ ูุณุชููุงู ุจู offset ฺฉุงููพุงู ูโุดูุฏ.<br>
ุจุฑุง ูุซุงูุ ุฏุฑ Cุ <code>wDay</code> ููุท ฺฉ token ุงุณุช ฺฉู ูุดุงู ูโุฏูุฏ ฺู ฺุฒ ุฏุฑ ุขุฏุฑุณ ฺฉ ููููู <code>SystemTime</code> ุจู ุงุถุงูู ฒด ุจุงุช ูุฑุงุฑ ุฏุงุฑุฏ.</p>
<p>ุจุฑุง ุณุฑุนุช ุฏุณุชุฑุณุ ูุฑ ููุฏ ุฏุฑ offset ูุฑุงุฑ ูโฺฏุฑุฏ ฺฉู ูุถุฑุจ ุงุฒ ุงูุฏุงุฒู ููุฏ ุงุณุช. ุงู ุถุฑุจ ุญุฏุงฺฉุซุฑ ุจู x ุจุงุช ูุญุฏูุฏ ุงุณุชุ ฺฉู x ุงูุฏุงุฒู <strong>pack</strong> ุงุณุช. ุฏุฑ ูพุงุฏูโุณุงุฒ ูุนูุ pack ูพุดโูุฑุถ ธ ุจุงุช ุงุณุชุ ุจูุงุจุฑุงู ฺฉ struct ุดุงูู <code>sbyte</code> ู ุณูพุณ ฺฉ <code>long</code> (ธ ุจุงุช) ุจู ฑถ ุจุงุช ุงุดุบุงู ูโุดูุฏ ู ท ุจุงุช ุจุนุฏ ุงุฒ <code>sbyte</code> ูุฏุฑ ูโุฑูุฏ. ุจุง ุชุนู ุงูุฏุงุฒู pack ุงุฒ ุทุฑู ูฺฺฏ <code>Pack</code> ุฏุฑ attribute <code>StructLayout</code> ูโุชูุงู ุงู ูุฏุฑ ุฑูุช ุฑุง ฺฉุงูุด ุง ุญุฐู ฺฉุฑุฏ. ุจุฑุง ูุซุงูุ ุจุง pack ุจุฑุงุจุฑ ฑุ ููุงู struct ุชููุง น ุจุงุช ุงุดุบุงู ูโฺฉูุฏ. ูโุชูุงูุฏ packโูุง ฑุ ฒุ ดุ ธ ุง ฑถ ุจุงุช ุชุนู ฺฉูุฏ.</p>
<p>Attribute <code>StructLayout</code> ููฺูู ุงุฌุงุฒู ูโุฏูุฏ <strong>offsetูุง ุตุฑุญ ููุฏูุง</strong> ุฑุง ูุดุฎุต ฺฉูุฏ (ุตูุญู นนด: ยซSimulating a C Unionยป).</p>
<hr>
<h4>In ู Out Marshaling โ๏ธ</h4>
<p>ุฏุฑ ูุซุงู ูุจูุ <code>SystemTime</code> ุจู ุตูุฑุช ฺฉูุงุณ ูพุงุฏูโุณุงุฒ ุดุฏ. ูโุชูุงูุณุชู ุจู ุฌุง ุขู struct ุงูุชุฎุงุจ ฺฉููโูุดุฑูุท ุจุฑ ุงูฺฉู <code>GetSystemTime</code> ุจุง ูพุงุฑุงูุชุฑ <code>ref</code> ุง <code>out</code> ุงุนูุงู ุดูุฏ:</p>
<pre class="hljs"><code>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;kernel32.dll&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetSystemTime</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> SystemTime t</span>)</span>;
</code></pre>
<p>ุฏุฑ ุงฺฉุซุฑ ููุงุฑุฏุ semantics ูพุงุฑุงูุชุฑูุง ุฌูุชโุฏุงุฑ C# ุจุง ูุชุฏูุง ุฎุงุฑุฌ ฺฉุณุงู ุงุณุช:</p>
<ul>
<li>ูพุงุฑุงูุชุฑูุง <strong>Pass-by-value</strong> ฺฉูพ ูโุดููุฏุ</li>
<li>ูพุงุฑุงูุชุฑูุง <code>ref</code> ฺฉูพ ุฏุฑ/ุฎุงุฑุฌ ูโุดููุฏุ</li>
<li>ูพุงุฑุงูุชุฑูุง <code>out</code> ฺฉูพ ุฎุฑูุฌ ูโุดููุฏ.</li>
</ul>
<p>ุจุง ุงู ุญุงูุ ุจุฑุง ุจุฑุฎ ููุนโูุง ฺฉู ุชุจุฏู ุฎุงุต ุฏุงุฑูุฏุ ุงุณุชุซูุง ูุฌูุฏ ุฏุงุฑุฏ. ุจุฑุง ูุซุงูุ ฺฉูุงุณโูุง ุขุฑุงู ู <code>StringBuilder</code> ููฺฏุงู ุฎุฑูุฌ ุงุฒ ุชุงุจุน ูุงุฒ ุจู ฺฉูพ ุฏุงุฑูุฏุ ุจูุงุจุฑุงู ุฑูุชุงุฑุดุงู <strong>in/out</strong> ุงุณุช. ฺฏุงู ุงููุงุช ููุฏ ุงุณุช ฺฉู ุงู ุฑูุชุงุฑ ุฑุง ุจุง attributes <code>In</code> ู <code>Out</code> ุจุงุฒููุณ ฺฉูู.</p>
<p>ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉ ุขุฑุงู ุจุงุฏ <strong>ููุท ุฎูุงูุฏู</strong> ุจุงุดุฏุ modifier <code>in</code> ูุดุฎุต ูโฺฉูุฏ ฺฉู ููุท ฺฉูพ ูุฑูุฏ ุขุฑุงู ุจู ุชุงุจุน ุงูุฌุงู ุดูุฏุ ูู ุฎุฑูุฌ ุขู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Foo</span>(<span class="hljs-params">[In] <span class="hljs-built_in">int</span>[] array</span>)</span>;
</code></pre>
<h3>Calling Conventions โ๏ธ</h3>
<p>ูุชุฏูุง ุบุฑูุฏุฑุชโุดุฏู ุขุฑฺฏููุงูโูุง ู ููุงุฏุฑ ุจุงุฒฺฏุดุช ุฑุง ุงุฒ ุทุฑู <strong>stack</strong> ู (ุงุฎุชุงุฑ) <strong>CPU registers</strong> ุฏุฑุงูุช ูโฺฉููุฏ. ุงุฒ ุขูุฌุง ฺฉู ฺูุฏู ุฑูุด ุจุฑุง ุงูุฌุงู ุงู ฺฉุงุฑ ูุฌูุฏ ุฏุงุฑุฏุ ูพุฑูุชฺฉูโูุง ูุฎุชูู ุดฺฉู ฺฏุฑูุชูโุงูุฏ ฺฉู ุจู ุขูโูุง <strong>calling conventions</strong> ฺฏูุชู ูโุดูุฏ.</p>
<p>CLR ุฏุฑ ุญุงู ุญุงุถุฑ ุงุฒ ุณู calling convention ูพุดุชุจุงู ูโฺฉูุฏ:</p>
<ul>
<li><code>StdCall</code></li>
<li><code>Cdecl</code></li>
<li><code>ThisCall</code></li>
</ul>
<p>ุจู ุทูุฑ ูพุดโูุฑุถุ CLR ุงุฒ <strong>calling convention ูพุดโูุฑุถ ูพูุชูุฑู</strong> ุงุณุชูุงุฏู ูโฺฉูุฏ (convention ุงุณุชุงูุฏุงุฑุฏ ุจุฑุง ุขู ูพูุชูุฑู). ุฏุฑ ููุฏูุฒุ ุงู convention ุจุฑุงุจุฑ ุจุง <code>StdCall</code> ุงุณุช ู ุฏุฑ ูููฺฉุณ x86 ุจุฑุงุจุฑ ุจุง <code>Cdecl</code>.</p>
<p>ุงฺฏุฑ ฺฉ ูุชุฏ ุบุฑูุฏุฑุชโุดุฏู ุงุฒ ุงู ูพุดโูุฑุถ ูพุฑู ูฺฉูุฏุ ูโุชูุงูุฏ ุจู ุตูุฑุช ุตุฑุญ calling convention ุขู ุฑุง ูุดุฎุต ฺฉูุฏ:</p>
<pre class="hljs"><code>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;MyLib.dll&quot;</span>, CallingConvention=CallingConvention.Cdecl)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SomeFunc</span>(<span class="hljs-params">...</span>)</span>;
</code></pre>
<p>ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ูุงู somewhat misleading <code>CallingConvention.WinApi</code> ุจู convention ูพุดโูุฑุถ ูพูุชูุฑู ุงุดุงุฑู ุฏุงุฑุฏ.</p>
<hr>
<h3>ูุฑุงุฎูุงู ุจุงุฒฺฏุดุช ุงุฒ ฺฉุฏ ุบุฑูุฏุฑุชโุดุฏู ๐</h3>
<p>C# ููฺูู ุงุฌุงุฒู ูโุฏูุฏ ุชูุงุจุน ุฎุงุฑุฌุ ฺฉุฏ C# ุฑุง ูุฑุงุฎูุงู ฺฉููุฏุ ุงุฒ ุทุฑู <strong>callbacks</strong>. ุฏู ุฑูุด ุจุฑุง ูพุงุฏูโุณุงุฒ callbacks ูุฌูุฏ ุฏุงุฑุฏ:</p>
<ul>
<li>ุงุฒ ุทุฑู <strong>function pointers</strong></li>
<li>ุงุฒ ุทุฑู <strong>delegates</strong></li>
</ul>
<p>ุจุฑุง ูุซุงูุ ุชุงุจุน ุฒุฑ ุฏุฑ <code>User32.dll</code> ููุฏูุฒุ ุชูุงู handles ูพูุฌุฑูโูุง ุณุทุญ ุจุงูุง ุฑุง enumerate ูโฺฉูุฏ:</p>
<pre class="hljs"><code>BOOL <span class="hljs-title function_">EnumWindows</span><span class="hljs-params">(WNDENUMPROC lpEnumFunc, LPARAM lParam)</span>;
</code></pre>
<p><code>WNDENUMPROC</code> ฺฉ callback ุงุณุช ฺฉู ุจุฑุง ูุฑ handle ูพูุฌุฑู ุจู ุชุฑุชุจ ูุฑุงุฎูุงู ูโุดูุฏ (ุง ุชุง ุฒูุงู ฺฉู callback <code>false</code> ุจุงุฒฺฏุฑุฏุงูุฏ). ุชุนุฑู ุขู ุจู ุดฺฉู ุฒุฑ ุงุณุช:</p>
<pre class="hljs"><code>BOOL CALLBACK <span class="hljs-title function_">EnumWindowsProc</span><span class="hljs-params">(HWND hwnd, LPARAM lParam)</span>;
</code></pre>
<hr>
<h4>Callbacks ุจุง Function Pointers ๐น</h4>
<p>ุงุฒ <strong>C# 9</strong>ุ ุณุงุฏูโุชุฑู ู ุณุฑุนโุชุฑู ฺฏุฒููโููุช callback ุดูุง ฺฉ ูุชุฏ <strong>static</strong> ุงุณุชโุงุณุชูุงุฏู ุงุฒ function pointer ุงุณุช. ุฏุฑ ููุฑุฏ callback <code>WNDENUMPROC</code>ุ ูโุชูุงู ุงุฒ function pointer ุฒุฑ ุงุณุชูุงุฏู ฺฉุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-built_in">delegate</span>*&lt;IntPtr, IntPtr, <span class="hljs-built_in">bool</span>&gt;
</code></pre>
<p>ุงู ฺฉ ุชุงุจุน ุฑุง ูุดุงู ูโุฏูุฏ ฺฉู ุฏู ุขุฑฺฏููุงู <code>IntPtr</code> ูโฺฏุฑุฏ ู <code>bool</code> ุจุฑูโฺฏุฑุฏุงูุฏ. ุณูพุณ ูโุชูุงูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ ุนููฺฏุฑ <code>&amp;</code> ุขู ุฑุง ุจู ฺฉ ูุชุฏ static ุงุฎุชุตุงุต ุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;

<span class="hljs-keyword">unsafe</span>
{
    EnumWindows(&amp;PrintWindow, IntPtr.Zero);

    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">EnumWindows</span>(<span class="hljs-params"><span class="hljs-built_in">delegate</span>*&lt;IntPtr, IntPtr, <span class="hljs-built_in">bool</span>&gt; hWnd, IntPtr lParam</span>)</span>;

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">PrintWindow</span>(<span class="hljs-params">IntPtr hWnd, IntPtr lParam</span>)</span>
    {
        Console.WriteLine(hWnd.ToInt64());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>ุจุง function pointersุ callback ุจุงุฏ ฺฉ ูุชุฏ <strong>static</strong> ุจุงุดุฏ (ุง ฺฉ <strong>static local function</strong> ููุงููุฏ ูุซุงู ุจุงูุง).</p>
<hr>
<h4>UnmanagedCallersOnly โก</h4>
<p>ูโุชูุงูุฏ ุจุง ุงุนูุงู <strong>unmanaged</strong> ุจู declaration function pointer ู attribute <code>[UnmanagedCallersOnly]</code> ุจู ูุชุฏ callbackุ ุนููฺฉุฑุฏ ุฑุง ุจูุจูุฏ ุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Runtime.CompilerServices;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;

<span class="hljs-keyword">unsafe</span>
{
    EnumWindows(&amp;PrintWindow, IntPtr.Zero);

    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">EnumWindows</span>(<span class="hljs-params"><span class="hljs-built_in">delegate</span>* <span class="hljs-keyword">unmanaged</span>&lt;IntPtr, IntPtr, <span class="hljs-built_in">byte</span>&gt; hWnd, IntPtr lParam</span>)</span>;

    [<span class="hljs-meta">UnmanagedCallersOnly</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span> <span class="hljs-title">PrintWindow</span>(<span class="hljs-params">IntPtr hWnd, IntPtr lParam</span>)</span>
    {
        Console.WriteLine(hWnd.ToInt64());
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
}
</code></pre>
<p>ุงู attribute ุจู CLR ุงุทูุงุน ูโุฏูุฏ ฺฉู ูุชุฏ <code>PrintWindow</code> ุชููุง ุงุฒ ฺฉุฏ ุบุฑูุฏุฑุชโุดุฏู ูุงุจู ูุฑุงุฎูุงู ุงุณุช ู ุงุฌุงุฒู ูโุฏูุฏ runtime ุจุฑุฎ shortcuts ุฑุง ุงุนูุงู ฺฉูุฏ. ุชูุฌู ฺฉูุฏ ฺฉู ููุน ุจุงุฒฺฏุดุช ูุชุฏ ุงุฒ <code>bool</code> ุจู <code>byte</code> ุชุบุฑ ฺฉุฑุฏู ุงุณุชุ ุฒุฑุง ูุชุฏูุง ฺฉู <code>[UnmanagedCallersOnly]</code> ุฏุงุฑูุฏุ ุชููุง ูโุชูุงููุฏ ุงุฒ <strong>blittable value types</strong> ุฏุฑ signature ุงุณุชูุงุฏู ฺฉููุฏ.</p>
<p><strong>Blittable types</strong> ุขูโูุง ูุณุชูุฏ ฺฉู ูุงุฒ ุจู marshaling ุฎุงุต ูุฏุงุฑูุฏุ ุฒุฑุง ุฏุฑ ูุญุทโูุง ูุฏุฑุชโุดุฏู ู ุบุฑูุฏุฑุชโุดุฏู ุจู ฺฉ ุดฺฉู ููุงุด ุฏุงุฏู ูโุดููุฏ. ุงู ููุนโูุง ุดุงูู:</p>
<ul>
<li>ุงููุงุน ุตุญุญ ุงุจุชุฏุง (primitive integral types)</li>
<li><code>float</code> ู <code>double</code></li>
<li>structูุง ฺฉู ุชููุง ุดุงูู blittable types ูุณุชูุฏ</li>
</ul>
<p>ููุน <code>char</code> ูุฒ blittable ุงุณุชุ ุงฺฏุฑ ุจุฎุด ุงุฒ struct ุจุงุดุฏ ฺฉู attribute <code>StructLayout</code> ุขู <strong>CharSet.Unicode</strong> ุฑุง ูุดุฎุต ฺฉุฑุฏู ุจุงุดุฏ:</p>
<pre class="hljs"><code>[<span class="hljs-meta">StructLayout(LayoutKind.Sequential, CharSet=CharSet.Unicode)</span>]
</code></pre>
<h3>Nondefault Calling Conventions โ๏ธ</h3>
<p>ุจู ุทูุฑ ูพุดโูุฑุถุ ฺฉุงููพุงูุฑ ูุฑุถ ูโฺฉูุฏ ฺฉู callback ุบุฑูุฏุฑุชโุดุฏู ุงุฒ <strong>calling convention ูพุดโูุฑุถ ูพูุชูุฑู</strong> ูพุฑู ูโฺฉูุฏ. ุงฺฏุฑ ุงูโฺฏููู ูุจุงุดุฏุ ูโุชูุงูุฏ ุจู ุตูุฑุช ุตุฑุญ calling convention ุขู ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ ูพุงุฑุงูุชุฑ <code>CallConvs</code> ุฏุฑ attribute <code>[UnmanagedCallersOnly]</code> ูุดุฎุต ฺฉูุฏ:</p>
<pre class="hljs"><code>[<span class="hljs-meta">UnmanagedCallersOnly(CallConvs = new[</span>] { <span class="hljs-keyword">typeof</span>(CallConvStdcall) })]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span> <span class="hljs-title">PrintWindow</span>(<span class="hljs-params">IntPtr hWnd, IntPtr lParam</span>) ...
</span></code></pre>
<p>ููฺูู ุจุงุฏ ููุน function pointer ุฑุง ุจุง ุฏุฑุฌ ฺฉ <strong>modifier ุฎุงุต</strong> ุจุนุฏ ุงุฒ ฺฉููู ฺฉูุฏ <code>unmanaged</code> ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-built_in">delegate</span>* <span class="hljs-keyword">unmanaged</span>[Stdcall]&lt;IntPtr, IntPtr, <span class="hljs-built_in">byte</span>&gt; hWnd, IntPtr lParam);
</code></pre>
<p>ฺฉุงููพุงูุฑ ุงุฌุงุฒู ูโุฏูุฏ ูุฑ ุดูุงุณูโุง (ูุซู <code>XYZ</code>) ุฑุง ุฏุงุฎู ฺฉุฑูุดูโูุง ูุฑุงุฑ ุฏูุฏุ ูุดุฑูุท ุจุฑ ุงูฺฉู ฺฉ ููุน .NET ุจู ูุงู <code>CallConvXYZ</code> ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุชูุณุท runtime ุฏุฑฺฉ ุดูุฏ ู ุจุง ฺุฒ ฺฉู ููฺฏุงู ุงุนูุงู <code>[UnmanagedCallersOnly]</code> ูุดุฎุต ฺฉุฑุฏูโุงุฏ ูุทุงุจูุช ุฏุงุดุชู ุจุงุดุฏ. ุงู ูฺฺฏ ุจู ูุงฺฉุฑูุณุงูุช ุงุฌุงุฒู ูโุฏูุฏ ุฏุฑ ุขูุฏู <strong>calling conventions</strong> ุฌุฏุฏ ุงุถุงูู ฺฉูุฏ.</p>
<p>ุฏุฑ ุงู ูุซุงูุ ูุง <code>StdCall</code> ุฑุง ูุดุฎุต ฺฉุฑุฏูุ ฺฉู <strong>calling convention ูพุดโูุฑุถ ููุฏูุฒ</strong> ุงุณุช (ุฏุฑ ูููฺฉุณ x86ุ ูพุดโูุฑุถ <code>Cdecl</code> ุงุณุช).<br>
ุฏุฑ ุงุฏุงููุ ุชูุงู ฺฏุฒููโูุง ฺฉู ุฏุฑ ุญุงู ุญุงุถุฑ ูพุดุชุจุงู ูโุดููุฏ ุงุฑุงุฆู ุดุฏูโุงูุฏ:</p>
 <div align="center">
<p><img src="../../../assets/image/24/Table-24-1.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>Callbacks ุจุง Delegates ๐</h3>
<p>ูโุชูุงู callbacks ุบุฑูุฏุฑุชโุดุฏู ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>delegates</strong> ูุฒ ูพุงุฏูโุณุงุฒ ฺฉุฑุฏ. ุงู ุฑูุด ุฏุฑ ุชูุงู ูุณุฎูโูุง C# ฺฉุงุฑ ูโฺฉูุฏ ู ุงุฌุงุฒู ูโุฏูุฏ callbackูุง ฺฉู ุจู ูุชุฏูุง <strong>instance</strong> ุงุดุงุฑู ุฏุงุฑูุฏ ูุฒ ุงุณุชูุงุฏู ุดููุฏ.</p>
<p>ุจุฑุง ุงูุฌุงู ุงู ฺฉุงุฑุ ุงุจุชุฏุง ฺฉ ููุน delegate ุจุง signature ูุดุงุจู callback ุชุนุฑู ูโฺฉูู. ุณูพุณ ูโุชูุงู ฺฉ ููููู delegate ุฑุง ุจู ูุชุฏ ุฎุงุฑุฌ ูพุงุณ ุฏุงุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">CallbackFun</span>
{
    <span class="hljs-function"><span class="hljs-built_in">delegate</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">EnumWindowsCallback</span>(<span class="hljs-params">IntPtr hWnd, IntPtr lParam</span>)</span>;

    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;user32.dll&quot;</span>)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">EnumWindows</span>(<span class="hljs-params">EnumWindowsCallback hWnd, IntPtr lParam</span>)</span>;

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">PrintWindow</span>(<span class="hljs-params">IntPtr hWnd, IntPtr lParam</span>)</span>
    {
        Console.WriteLine(hWnd.ToInt64());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> EnumWindowsCallback printWindowFunc = PrintWindow;

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span> =&gt; EnumWindows(printWindowFunc, IntPtr.Zero);
}
</code></pre>
<p>ุงุณุชูุงุฏู ุงุฒ delegates ุจุฑุง callbacks ุบุฑูุฏุฑุชโุดุฏู <strong>ironically unsafe</strong> ุงุณุชุ ุฒุฑุง ููฺฉู ุงุณุช callback ุจุนุฏ ุงุฒ ุฎุงุฑุฌ ุดุฏู ููููู delegate ุงุฒ scope ุฑุฎ ุฏูุฏ ู ุฏุฑ ุงู ุตูุฑุช delegate ูุงุฌุฏ ุดุฑุงุท <strong>garbage collection</strong> ูโุดูุฏ. ุงู ูโุชูุงูุฏ ููุฌุฑ ุจู ุดุฏุฏุชุฑู ููุน exception ุฏุฑ runtime ุดูุฏโฺฉ ุจุฏูู <strong>stack trace</strong> ููุฏ.</p>
<p>ุฏุฑ ููุฑุฏ callbackูุง ูุชุฏ staticุ ูโุชูุงู ุจุง ุงุฎุชุตุงุต ููููู delegate ุจู ฺฉ <strong>read-only static field</strong> ุงุฒ ุงู ูุดฺฉู ุฌููฺฏุฑ ฺฉุฑุฏ (ููุงููุฏ ูุซุงู ุจุงูุง). ุงูุง ุจุฑุง callbackูุง ูุชุฏ instanceุ ุงู ุฑูุด ฺฉุงู ูุณุช ู ุจุงุฏ ุจุง ุฏูุช ฺฉุฏููุณ ฺฉูุฏ ุชุง ุญุฏุงูู ฺฉ reference ุจู ููููู delegate ุจุฑุง ูุฏุช ุฒูุงู ูุฑ callback ุงุญุชูุงู ุญูุธ ุดูุฏ. ุญุช ุฏุฑ ุงู ุญุงูุชุ ุงฺฏุฑ ฺฉ ุจุงฺฏ ุฏุฑ ุณูุช ุบุฑูุฏุฑุชโุดุฏู ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏโฺฉู callback ุฑุง ุจุนุฏ ุงุฒ ุงูฺฉู ุจู ุขู ฺฏูุชูโุงุฏ ุงุฌุฑุง ฺฉูุฏโููฺฉู ุงุณุช ููฺูุงู ุจุง ฺฉ exception ุบุฑูุงุจู ุฑุฏุงุจ ููุงุฌู ุดูุฏ. ฺฉ ุฑุงูฺฉุงุฑ ุงู ุงุณุช ฺฉู ุจุฑุง ูุฑ ุชุงุจุน ุบุฑูุฏุฑุชโุดุฏูุ ฺฉ ููุน delegate ููุญุตุฑ ุจู ูุฑุฏ ุชุนุฑู ฺฉูุฏุ ุงู ฺฉุงุฑ ุฏุฑ ุชุดุฎุต ูุดฺฉูุงุช ฺฉูฺฉ ูโฺฉูุฏุ ุฒุฑุง ููุน delegate ุฏุฑ exception ฺฏุฒุงุฑุด ูโุดูุฏ.</p>
<hr>
<p>ูโุชูุงูุฏ <strong>calling convention</strong> callback ุฑุง ุงุฒ ูพุดโูุฑุถ ูพูุชูุฑู ุชุบุฑ ุฏูุฏ ุจุง ุงุนูุงู attribute <code>[UnmanagedFunctionPointer]</code> ุฑู delegate:</p>
<pre class="hljs"><code>[<span class="hljs-meta">UnmanagedFunctionPointer(CallingConvention.Cdecl)</span>]
<span class="hljs-function"><span class="hljs-built_in">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MyCallback</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> foo, <span class="hljs-built_in">short</span> bar</span>)</span>;
</code></pre>
<hr>
<h3>ุดุจูโุณุงุฒ C Union ๐ง</h3>
<p>ูุฑ ููุฏ ุฏุฑ ฺฉ struct ูุถุง ฺฉุงู ุจุฑุง ุฐุฎุฑู ุฏุงุฏู ุฎูุฏ ุฏุงุฑุฏ.<br>
ูุฑุถ ฺฉูุฏ struct ุดุงูู ฺฉ <code>int</code> ู ฺฉ <code>char</code> ุฏุงุฑู. <code>int</code> ุงุญุชูุงูุงู ุงุฒ offset ุตูุฑ ุดุฑูุน ูโุดูุฏ ู ุญุฏุงูู ฺูุงุฑ ุจุงุช ูุถุง ุฏุงุฑุฏ. ุจูุงุจุฑุงู <code>char</code> ุญุฏุงูู ุงุฒ offset ด ุดุฑูุน ูโุดูุฏ. ุงฺฏุฑ ุจู ูุฑ ุฏูู <code>char</code> ุงุฒ offset ฒ ุดุฑูุน ุดูุฏุ ููุฏุงุฑ <code>int</code> ุชุบุฑ ูโฺฉูุฏ. ุนุฌุจ ุงุณุชุ ุงูุง ุฒุจุงู C ููุน variation ุงุฒ struct ุจู ูุงู <strong>union</strong> ุฏุงุฑุฏ ฺฉู ุฏููุงู ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ.</p>
<p>ุฏุฑ C# ูโุชูุงู ุงู ฺฉุงุฑ ุฑุง ุจุง <code>LayoutKind.Explicit</code> ู attribute <code>FieldOffset</code> ุดุจูโุณุงุฒ ฺฉุฑุฏ.</p>
<hr>
<p>ููฺฉู ุงุณุช ุณุฎุช ุจุงุดุฏ ููุฑุฏ ูพุฏุง ฺฉูุฏ ฺฉู ุงู ฺฉุงุฑุจุฑุฏ ุจุงุดุฏ. ุงูุง ูุฑุถ ฺฉูุฏ ูโุฎูุงูุฏ ฺฉ ูุช ููุณู ุฑุง ุฑู ฺฉ <strong>synthesizer ุฎุงุฑุฌ</strong> ูพุฎุด ฺฉูุฏ. Windows Multimedia API ฺฉ ุชุงุจุน ุจุฑุง ุงู ฺฉุงุฑ ุงุฒ ุทุฑู ูพุฑูุชฺฉู MIDI ูุฑุงูู ูโฺฉูุฏ:</p>
<pre class="hljs"><code>[<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;winmm.dll&quot;</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">uint</span> <span class="hljs-title">midiOutShortMsg</span>(<span class="hljs-params">IntPtr handle, <span class="hljs-built_in">uint</span> message</span>)</span>;
</code></pre>
<p>ุขุฑฺฏููุงู ุฏููุ <code>message</code>ุ ูุดุฎุต ูโฺฉูุฏ ฺู ูุช ูพุฎุด ุดูุฏ. ูุดฺฉู ุฏุฑ ุณุงุฎุช ุงู ุนุฏุฏ ณฒ ุจุช unsigned ุงุณุช: ุงู ุนุฏุฏ ุจู ุจุงุชโูุง ุชูุณู ูโุดูุฏ ฺฉู ููุงูุฏู <strong>ฺฉุงูุงู MIDIุ ูุชุ ู ุณุฑุนุช ุถุฑุจู</strong> ูุณุชูุฏ.</p>
<p>ุฑุงู ุญู ฺฉูุงุณฺฉุ ุงุณุชูุงุฏู ุงุฒ ุนููฺฏุฑูุง ุจุช <code>&lt;&lt;</code>, <code>&gt;&gt;</code>, <code>&amp;</code>, <code>|</code> ุจุฑุง ุชุจุฏู ุจู ุจุงุชโูุง ู ุนุฏุฏ ณฒ ุจุช ุงุณุช. ุงูุง ุฑูุด ุณุงุฏูโุชุฑุ ุชุนุฑู ฺฉ struct ุจุง <strong>layout ุตุฑุญ</strong> ุงุณุช:</p>
<pre class="hljs"><code>[<span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> NoteMessage
{
    [<span class="hljs-meta">FieldOffset(0)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">uint</span> PackedMsg;    <span class="hljs-comment">// 4 ุจุงุช</span>
    [<span class="hljs-meta">FieldOffset(0)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span> Channel;      <span class="hljs-comment">// FieldOffset ูุฒ 0</span>
    [<span class="hljs-meta">FieldOffset(1)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span> Note;
    [<span class="hljs-meta">FieldOffset(2)</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span> Velocity;
}
</code></pre>
<p>ููุฏูุง <code>Channel</code>, <code>Note</code> ู <code>Velocity</code> ุนูุฏุงู ุจุง ุนุฏุฏ ณฒ ุจุช packed overlap ุฏุงุฑูุฏ. ุงู ุงูฺฉุงู ุฑุง ูโุฏูุฏ ฺฉู ุจุชูุงูุฏ ุงุฒ ูุฑ ุฏู ุฑูุด ุฎูุงูุฏู ู ููุดุชู ฺฉูุฏุ ุจุฏูู ูุงุฒ ุจู ูุญุงุณุจุงุช ุงุถุงู ุจุฑุง ููุงููฺฏ ููุฏูุง:</p>
<pre class="hljs"><code>NoteMessage n = <span class="hljs-keyword">new</span> NoteMessage();
Console.WriteLine(n.PackedMsg);  <span class="hljs-comment">// 0</span>

n.Channel = <span class="hljs-number">10</span>;
n.Note = <span class="hljs-number">100</span>;
n.Velocity = <span class="hljs-number">50</span>;
Console.WriteLine(n.PackedMsg);  <span class="hljs-comment">// 3302410</span>

n.PackedMsg = <span class="hljs-number">3328010</span>;
Console.WriteLine(n.Note);       <span class="hljs-comment">// 200</span>
</code></pre>
<h3>Shared Memory ๐๏ธ</h3>
<p><strong>Memory-mapped files</strong> ุง <strong>shared memory</strong> ูุงุจูุช ุฏุฑ ููุฏูุฒ ุงุณุช ฺฉู ุจู ฺูุฏู ูุฑุขูุฏ ุฑู ฺฉ ฺฉุงููพูุชุฑ ุงุฌุงุฒู ูโุฏูุฏ ุฏุงุฏูโูุง ุฑุง ุจุง ูู ุจู ุงุดุชุฑุงฺฉ ุจฺฏุฐุงุฑูุฏ. Shared memory ุจุณุงุฑ ุณุฑุน ุงุณุช ู ุจุฑ ุฎูุงู <strong>pipes</strong>ุ ุงูฺฉุงู <strong>ุฏุณุชุฑุณ ุชุตุงุฏู</strong> ุจู ุฏุงุฏูโูุง ูุดุชุฑฺฉ ุฑุง ูุฑุงูู ูโฺฉูุฏ. ุฏุฑ ูุตู ฑต ุฏุฏู ฺฉู ฺฺฏููู ูโุชูุงู ุงุฒ ฺฉูุงุณ <code>MemoryMappedFile</code> ุจุฑุง ุฏุณุชุฑุณ ุจู ูุงูโูุง memory-mapped ุงุณุชูุงุฏู ฺฉุฑุฏุ ุงูุง ุนุจูุฑ ุงุฒ ุงู ฺฉูุงุณ ู ูุฑุงุฎูุงู ูุณุชูู ูุชุฏูุง Win32ุ ุฑุงู ุนุงู ุจุฑุง ูุดุงู ุฏุงุฏู <strong>P/Invoke</strong> ุงุณุช.</p>
<p>ุชุงุจุน Win32 ุจู ูุงู <code>CreateFileMapping</code> ุญุงูุธู ูุดุชุฑฺฉ ุงุฎุชุตุงุต ูโุฏูุฏ. ุดูุง ุชุนุฏุงุฏ ุจุงุช ููุฑุฏ ูุงุฒ ู ูุงู ฺฉู ุจุฑุง ุดูุงุณุง share ุงุณุชูุงุฏู ูโุดูุฏ ุฑุง ูุดุฎุต ูโฺฉูุฏ. ุณูพุณ ฺฉ ุจุฑูุงูู ุฏฺฏุฑ ูโุชูุงูุฏ ุจุง ูุฑุงุฎูุงู <code>OpenFileMapping</code> ู ุงุณุชูุงุฏู ุงุฒ ููุงู ูุงูุ ุจู ุงู ุญุงูุธู ูุดุชุฑฺฉ ูุชุตู ุดูุฏ. ูุฑ ุฏู ูุชุฏ ฺฉ <strong>handle</strong> ุจุงุฒูโฺฏุฑุฏุงููุฏ ฺฉู ุจุง ูุฑุงุฎูุงู <code>MapViewOfFile</code> ูโุชูุงู ุขู ุฑุง ุจู ฺฉ <strong>pointer</strong> ุชุจุฏู ฺฉุฑุฏ.</p>
<p>ุฏุฑ ุงุฏุงููุ ฺฉ ฺฉูุงุณ ฺฉู ุฏุณุชุฑุณ ุจู shared memory ุฑุง encapsulate ูโฺฉูุฏ ูุดุงูุฏู ูโฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;
<span class="hljs-keyword">using</span> System.ComponentModel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SharedMem</span> : <span class="hljs-title">IDisposable</span>
{
    <span class="hljs-comment">// ุงุณุชูุงุฏู ุงุฒ enum ุจุฑุง ุงููุช ุจุดุชุฑ ูุณุจุช ุจู constants</span>
    <span class="hljs-built_in">enum</span> FileProtection : <span class="hljs-built_in">uint</span>      <span class="hljs-comment">// constants ุงุฒ winnt.h</span>
    {
        ReadOnly = <span class="hljs-number">2</span>,
        ReadWrite = <span class="hljs-number">4</span>
    }
    
    <span class="hljs-built_in">enum</span> FileRights : <span class="hljs-built_in">uint</span>          <span class="hljs-comment">// constants ุงุฒ WinBASE.h</span>
    {
        Read = <span class="hljs-number">4</span>,
        Write = <span class="hljs-number">2</span>,
        ReadWrite = Read + Write
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> IntPtr NoFileHandle = <span class="hljs-keyword">new</span> IntPtr(<span class="hljs-number">-1</span>);

    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;kernel32.dll&quot;</span>, SetLastError = true)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">CreateFileMapping</span>(<span class="hljs-params">IntPtr hFile,
                                           <span class="hljs-built_in">int</span> lpAttributes,
                                           FileProtection flProtect,
                                           <span class="hljs-built_in">uint</span> dwMaximumSizeHigh,
                                           <span class="hljs-built_in">uint</span> dwMaximumSizeLow,
                                           <span class="hljs-built_in">string</span> lpName</span>)</span>;

    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;kernel32.dll&quot;</span>, SetLastError=true)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">OpenFileMapping</span>(<span class="hljs-params">FileRights dwDesiredAccess,
                                         <span class="hljs-built_in">bool</span> bInheritHandle,
                                         <span class="hljs-built_in">string</span> lpName</span>)</span>;

    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;kernel32.dll&quot;</span>, SetLastError = true)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">MapViewOfFile</span>(<span class="hljs-params">IntPtr hFileMappingObject,
                                       FileRights dwDesiredAccess,
                                       <span class="hljs-built_in">uint</span> dwFileOffsetHigh,
                                       <span class="hljs-built_in">uint</span> dwFileOffsetLow,
                                       <span class="hljs-built_in">uint</span> dwNumberOfBytesToMap</span>)</span>;

    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;Kernel32.dll&quot;</span>, SetLastError = true)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">UnmapViewOfFile</span>(<span class="hljs-params">IntPtr map</span>)</span>;

    [<span class="hljs-meta">DllImport(<span class="hljs-string">&quot;kernel32.dll&quot;</span>, SetLastError = true)</span>]
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-built_in">int</span> <span class="hljs-title">CloseHandle</span>(<span class="hljs-params">IntPtr hObject</span>)</span>;

    IntPtr fileHandle, fileMap;

    <span class="hljs-keyword">public</span> IntPtr Root =&gt; fileMap;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SharedMem</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name, <span class="hljs-built_in">bool</span> existing, <span class="hljs-built_in">uint</span> sizeInBytes</span>)</span>
    {
        <span class="hljs-keyword">if</span> (existing)
            fileHandle = OpenFileMapping(FileRights.ReadWrite, <span class="hljs-literal">false</span>, name);
        <span class="hljs-keyword">else</span>
            fileHandle = CreateFileMapping(NoFileHandle, <span class="hljs-number">0</span>,
                                           FileProtection.ReadWrite,
                                           <span class="hljs-number">0</span>, sizeInBytes, name);
        <span class="hljs-keyword">if</span> (fileHandle == IntPtr.Zero)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Win32Exception();

        <span class="hljs-comment">// ุงุฌุงุฏ map ุฎูุงูุฏู/ููุดุชู ุจุฑุง ฺฉู ูุงู</span>
        fileMap = MapViewOfFile(fileHandle, FileRights.ReadWrite, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">if</span> (fileMap == IntPtr.Zero)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Win32Exception();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
    {
        <span class="hljs-keyword">if</span> (fileMap != IntPtr.Zero) UnmapViewOfFile(fileMap);
        <span class="hljs-keyword">if</span> (fileHandle != IntPtr.Zero) CloseHandle(fileHandle);
        fileMap = fileHandle = IntPtr.Zero;
    }
}
</code></pre>
<p>ุฏุฑ ุงู ูุซุงูุ ุจุฑุง ูุชุฏูุง <code>DllImport</code> ฺฉู ุงุฒ ูพุฑูุชฺฉู <code>SetLastError</code> ุจุฑุง ุงุฑุงุฆู ฺฉุฏูุง ุฎุทุง ุงุณุชูุงุฏู ูโฺฉููุฏุ <code>SetLastError=true</code> ุชูุธู ุดุฏู ุงุณุช. ุงู ุจุงุนุซ ูโุดูุฏ ฺฉู ููฺฏุงู ุงุฌุงุฏ <strong>Win32Exception</strong>ุ ุฌุฒุฆุงุช ุฎุทุง ุจู ุฏุฑุณุช ูพุฑ ุดูุฏ. ููฺูู ูโุชูุงู ุฎุทุง ุฑุง ุจู ุตูุฑุช ุตุฑุญ ุจุง ูุฑุงุฎูุงู <code>Marshal.GetLastWin32Error</code> ูพุฑุณ ู ุฌู ฺฉุฑุฏ.</p>
<hr>
<p>ุจุฑุง ุขุฒูุงุด ุงู ฺฉูุงุณุ ูุงุฒ ุจู ุงุฌุฑุง ุฏู ุจุฑูุงูู ุฏุงุฑู:</p>
<ol>
<li>ุจุฑูุงูู ุงูู shared memory ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ:</li>
</ol>
<pre class="hljs"><code><span class="hljs-keyword">using</span> (SharedMem sm = <span class="hljs-keyword">new</span> SharedMem(<span class="hljs-string">&quot;MyShare&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">1000</span>))
{
    IntPtr root = sm.Root;
    <span class="hljs-comment">// ุญุงูุธู ูุดุชุฑฺฉ ุขูุงุฏู ุงุณุช!</span>
    Console.ReadLine(); <span class="hljs-comment">// ุฏุฑ ุงูุฌุง ุจุฑูุงูู ุฏูู ุดุฑูุน ูโุดูุฏ...</span>
}
</code></pre>
<ol start="2">
<li>ุจุฑูุงูู ุฏูู ุจุง ุณุงุฎุช ฺฉ ุดุก <code>SharedMem</code> ุจุง ููุงู ูุงู ู ููุฏุงุฑ <code>existing = true</code> ุจู ุญุงูุธู ูุดุชุฑฺฉ ูุชุตู ูโุดูุฏ:</li>
</ol>
<pre class="hljs"><code><span class="hljs-keyword">using</span> (SharedMem sm = <span class="hljs-keyword">new</span> SharedMem(<span class="hljs-string">&quot;MyShare&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">1000</span>))
{
    IntPtr root = sm.Root;
    <span class="hljs-comment">// ูู ูู ุจู ููุงู ุญุงูุธู ูุดุชุฑฺฉ ุฏุณุชุฑุณ ุฏุงุฑู!</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>ูุชุฌู ุงู ุงุณุช ฺฉู ูุฑ ุจุฑูุงูู ฺฉ <code>IntPtr</code>โฺฉ pointer ุจู ููุงู ุญุงูุธู unmanagedโุฏุงุฑุฏ. ุญุงูุง ุฏู ุจุฑูุงูู ูโุชูุงููุฏ ุฏุงุฏูโูุง ุฑุง ุงุฒ ุทุฑู ุงู pointer ูุดุชุฑฺฉ ุจุฎูุงููุฏ ู ุจููุณูุฏ.</p>
<p>ฺฉ ุฑูุด ุงู ุงุณุช ฺฉู ฺฉ ฺฉูุงุณ ุจุฑุง encapsulate ฺฉู ุฏุงุฏูโูุง ูุดุชุฑฺฉ ุชุนุฑู ฺฉูุฏ ู ุณูพุณ ุฏุงุฏูโูุง ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ <code>UnmanagedMemoryStream</code> <strong>serialize</strong> ู <strong>deserialize</strong> ฺฉูุฏ. ุงูุง ุงฺฏุฑ ุญุฌู ุฏุงุฏู ุฒุงุฏ ุจุงุดุฏุ ุงู ุฑูุด ูุงฺฉุงุฑุขูุฏ ุงุณุช.<br>
ูุซูุงู ุงฺฏุฑ ฺฉูุงุณ ุญุงูุธู ูุดุชุฑฺฉ ฺฉ ูฺฏุงุจุงุช ุฏุงุฏู ุฏุงุดุชู ุจุงุดุฏ ู ููุท ฺฉ ุนุฏุฏ ุตุญุญ ูุงุฒ ุจู ุจุฑูุฒุฑุณุงู ุฏุงุดุชู ุจุงุดุฏุ ุงู ุฑูุด ุจุณุงุฑ ุณูฺฏู ุฎูุงูุฏ ุจูุฏ.</p>
<p>ุฑูุด ุจูุชุฑ ุงู ุงุณุช ฺฉู ุฏุงุฏูโูุง ูุดุชุฑฺฉ ุฑุง ุจู ุตูุฑุช ฺฉ <strong>struct</strong> ุชุนุฑู ฺฉูุฏ ู ุณูพุณ ุขู ุฑุง ูุณุชููุงู ุฏุฑ ุญุงูุธู ูุดุชุฑฺฉ map ฺฉูุฏ. ุงู ููุถูุน ุฏุฑ ุจุฎุด ุจุนุฏ ุชูุถุญ ุฏุงุฏู ุฎูุงูุฏ ุดุฏ.</p>
<h3>Mapping a Struct to Unmanaged Memory ๐งฉ</h3>
<p>ูโุชูุงู ฺฉ <strong>struct</strong> ุจุง <code>StructLayout</code> ุงุฒ ููุน <code>Sequential</code> ุง <code>Explicit</code> ุฑุง ูุณุชููุงู ุจู ุญุงูุธู ุบุฑูุฏุฑุชโุดุฏู map ฺฉุฑุฏ. ุจู ูุซุงู ุฒุฑ ุชูุฌู ฺฉูุฏ:</p>
<pre class="hljs"><code>[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">struct</span> MySharedData
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Value;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">char</span> Letter;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">fixed</span> <span class="hljs-built_in">float</span> Numbers[<span class="hljs-number">50</span>];
}
</code></pre>
<p>ุฏุณุชูุฑ <code>fixed</code> ุจู ูุง ุงุฌุงุฒู ูโุฏูุฏ <strong>ุขุฑุงูโูุง ุจุง ุทูู ุซุงุจุช ุงุฒ ููุน value</strong> ุฑุง ุฏุฑูู struct ุชุนุฑู ฺฉููุ ู ููู ูฺฺฏ ูุง ุฑุง ูุงุฑุฏ ูุถุง <strong>unsafe</strong> ูโฺฉูุฏ. ูุถุง ูุงุฒู ุจุฑุง ตฐ ุนุฏุฏ ุงุนุดุงุฑ (float) ุจู ุตูุฑุช inline ุฏุฑ struct ุงุฎุชุตุงุต ูโุงุจุฏ. ุจุฑ ุฎูุงู ุขุฑุงูโูุง ูุนููู C#ุ <code>Numbers</code> ฺฉ reference ุจู ุขุฑุงู ูุณุชโุฎูุฏ ุขุฑุงู ุงุณุช.</p>
<p>ุงฺฏุฑ ฺฉุฏ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span> =&gt; Console.WriteLine(<span class="hljs-keyword">sizeof</span>(MySharedData));
</code></pre>
<p>ูุชุฌู ุจุฑุงุจุฑ ุจุง <strong>208</strong> ุฎูุงูุฏ ุจูุฏ:</p>
<ul>
<li>ตฐ ุนุฏุฏ float ฺูุงุฑ ุจุงุช</li>
<li>ด ุจุงุช ุจุฑุง <code>Value</code></li>
<li>ฒ ุจุงุช ุจุฑุง <code>Letter</code></li>
</ul>
<p>ูุฌููุน ฒฐถ ุจุงุช ุจู ุฏูู alignment ุจุฑ ุฑู ูุฑุฒูุง ฺูุงุฑ ุจุงุชุ ุจู ฒฐธ ุจุงุช ฺฏุฑุฏ ุดุฏู ุงุณุช (ุงูุฏุงุฒู float = ด ุจุงุช).</p>
<hr>
<p>ูโุชูุงูู <code>MySharedData</code> ุฑุง ุฏุฑ ฺฉ <strong>context unsafe</strong> ุจุง ุญุงูุธู ุชุฎุตุตโุงูุชู ุฑู stack ุขุฒูุงุด ฺฉูู:</p>
<pre class="hljs"><code>MySharedData d;
MySharedData* data = &amp;d;  <span class="hljs-comment">// ฺฏุฑูุชู ุขุฏุฑุณ d</span>
data-&gt;Value = <span class="hljs-number">123</span>;
data-&gt;Letter = <span class="hljs-string">&#x27;X&#x27;</span>;
data-&gt;Numbers[<span class="hljs-number">10</span>] = <span class="hljs-number">1.45f</span>;
</code></pre>
<p>ุง:</p>
<pre class="hljs"><code><span class="hljs-comment">// ุชุฎุตุต ุขุฑุงู ุฑู stack</span>
MySharedData* data = <span class="hljs-keyword">stackalloc</span> MySharedData[<span class="hljs-number">1</span>];
data-&gt;Value = <span class="hljs-number">123</span>;
data-&gt;Letter = <span class="hljs-string">&#x27;X&#x27;</span>;
data-&gt;Numbers[<span class="hljs-number">10</span>] = <span class="hljs-number">1.45f</span>;
</code></pre>
<p>ุงูุจุชูุ ุงู ุฑูุด ฺุฒ ุจุด ุงุฒ ุขูฺู ุฏุฑ managed context ูโุชูุงู ุงูุฌุงู ุฏุงุฏุ ูุดุงู ููโุฏูุฏ. ุงูุง ุงฺฏุฑ ุจุฎูุงูู ฺฉ ููููู ุงุฒ <code>MySharedData</code> ุฑุง ุฑู <strong>heap ุบุฑูุฏุฑุชโุดุฏู</strong> ุฐุฎุฑู ฺฉููุ ุฎุงุฑุฌ ุงุฒ ูุญุฏูุฏู garbage collector CLRุ ุงูุฌุงุณุช ฺฉู <strong>pointers</strong> ูุงูุนุงู ููุฏ ูโุดููุฏ:</p>
<pre class="hljs"><code>MySharedData* data = (MySharedData*) Marshal.AllocHGlobal(<span class="hljs-keyword">sizeof</span>(MySharedData)).ToPointer();
data-&gt;Value = <span class="hljs-number">123</span>;
data-&gt;Letter = <span class="hljs-string">&#x27;X&#x27;</span>;
data-&gt;Numbers[<span class="hljs-number">10</span>] = <span class="hljs-number">1.45f</span>;
</code></pre>
<p>ุชุงุจุน <code>Marshal.AllocHGlobal</code> ุญุงูุธูโุง ุฑู <strong>heap ุบุฑูุฏุฑุชโุดุฏู</strong> ุงุฎุชุตุงุต ูโุฏูุฏ. ุจุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ุงู ุญุงูุธู:</p>
<pre class="hljs"><code>Marshal.FreeHGlobal(<span class="hljs-keyword">new</span> IntPtr(data));
</code></pre>
<p>(ูุฑุงููุด ฺฉุฑุฏู ุขุฒุงุฏุณุงุฒ ุญุงูุธูุ ููุฌุฑ ุจู <strong>memory leak</strong> ูโุดูุฏ.)</p>
<hr>
<p>ุงุฒ <strong>.NET 6</strong> ุจู ุจุนุฏุ ูโุชูุงู ุงุฒ ฺฉูุงุณ <code>NativeMemory</code> ุจุฑุง ุชุฎุตุต ู ุขุฒุงุฏุณุงุฒ ุญุงูุธู ุบุฑูุฏุฑุชโุดุฏู ุงุณุชูุงุฏู ฺฉุฑุฏ. ุงู ฺฉูุงุณ ุงุฒ API ุฌุฏุฏุชุฑ ู ุจูุชุฑ ูุณุจุช ุจู <code>AllocHGlobal</code> ุจูุฑู ูโุจุฑุฏ ู ูุชุฏูุง ุจุฑุง ุชุฎุตุต aligned ูุฒ ุงุฑุงุฆู ูโฺฉูุฏ.</p>
<hr>
<p>ุฏุฑ ุงุฏุงููุ ูุง <code>MySharedData</code> ุฑุง ุจุง ฺฉูุงุณ <code>SharedMem</code> ฺฉู ุฏุฑ ุจุฎุด ูุจู ููุดุชูุ ุชุฑฺฉุจ ูโฺฉูู. ุจุฑูุงูู ุฒุฑ ฺฉ ุจููฺฉ ุญุงูุธู ูุดุชุฑฺฉ ุชุฎุตุต ูโุฏูุฏ ู struct ุฑุง ูุณุชููุงู ุฏุฑ ุขู map ูโฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
{
    <span class="hljs-keyword">using</span> (SharedMem sm = <span class="hljs-keyword">new</span> SharedMem(<span class="hljs-string">&quot;MyShare&quot;</span>, <span class="hljs-literal">false</span>, (<span class="hljs-built_in">uint</span>)<span class="hljs-keyword">sizeof</span>(MySharedData)))
    {
        <span class="hljs-keyword">void</span>* root = sm.Root.ToPointer();
        MySharedData* data = (MySharedData*)root;

        data-&gt;Value = <span class="hljs-number">123</span>;
        data-&gt;Letter = <span class="hljs-string">&#x27;X&#x27;</span>;
        data-&gt;Numbers[<span class="hljs-number">10</span>] = <span class="hljs-number">1.45f</span>;

        Console.WriteLine(<span class="hljs-string">&quot;Written to shared memory&quot;</span>);
        Console.ReadLine();

        Console.WriteLine(<span class="hljs-string">&quot;Value is &quot;</span> + data-&gt;Value);
        Console.WriteLine(<span class="hljs-string">&quot;Letter is &quot;</span> + data-&gt;Letter);
        Console.WriteLine(<span class="hljs-string">&quot;11th Number is &quot;</span> + data-&gt;Numbers[<span class="hljs-number">10</span>]);
        Console.ReadLine();
    }
}
</code></pre>
<p>ูโุชูุงู ุจู ุฌุง <code>SharedMem</code> ุงุฒ ฺฉูุงุณ built-in <code>MemoryMappedFile</code> ูุฒ ุงุณุชูุงุฏู ฺฉุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> (MemoryMappedFile mmFile = MemoryMappedFile.CreateNew(<span class="hljs-string">&quot;MyShare&quot;</span>, <span class="hljs-number">1000</span>))
<span class="hljs-keyword">using</span> (MemoryMappedViewAccessor accessor = mmFile.CreateViewAccessor())
{
    <span class="hljs-built_in">byte</span>* pointer = <span class="hljs-literal">null</span>;
    accessor.SafeMemoryMappedViewHandle.AcquirePointer(<span class="hljs-keyword">ref</span> pointer);
    <span class="hljs-keyword">void</span>* root = pointer;
    ...
}
</code></pre>
<hr>
<p>ุจุฑูุงูู ุฏูู ูโุชูุงูุฏ ุจู ููุงู ุญุงูุธู ูุดุชุฑฺฉ ูุชุตู ุดูุฏ ู ููุงุฏุฑ ููุดุชู ุดุฏู ุชูุณุท ุจุฑูุงูู ุงูู ุฑุง ุจุฎูุงูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
{
    <span class="hljs-keyword">using</span> (SharedMem sm = <span class="hljs-keyword">new</span> SharedMem(<span class="hljs-string">&quot;MyShare&quot;</span>, <span class="hljs-literal">true</span>, (<span class="hljs-built_in">uint</span>)<span class="hljs-keyword">sizeof</span>(MySharedData)))
    {
        <span class="hljs-keyword">void</span>* root = sm.Root.ToPointer();
        MySharedData* data = (MySharedData*)root;

        Console.WriteLine(<span class="hljs-string">&quot;Value is &quot;</span> + data-&gt;Value);
        Console.WriteLine(<span class="hljs-string">&quot;Letter is &quot;</span> + data-&gt;Letter);
        Console.WriteLine(<span class="hljs-string">&quot;11th Number is &quot;</span> + data-&gt;Numbers[<span class="hljs-number">10</span>]);

        <span class="hljs-comment">// ููุจุช ูุง ุจุฑุง ุจุฑูุฒุฑุณุงู ุญุงูุธู ูุดุชุฑฺฉ</span>
        data-&gt;Value++;
        data-&gt;Letter = <span class="hljs-string">&#x27;!&#x27;</span>;
        data-&gt;Numbers[<span class="hljs-number">10</span>] = <span class="hljs-number">987.5f</span>;

        Console.WriteLine(<span class="hljs-string">&quot;Updated shared memory&quot;</span>);
        Console.ReadLine();
    }
}
</code></pre>
<p>ุฎุฑูุฌ ูุฑ ุฏู ุจุฑูุงูู:</p>
<ul>
<li>
<p><strong>ุจุฑูุงูู ุงูู</strong>:</p>
<pre class="hljs"><code>Written to shared memory
Value is 124
Letter is !
11th Number is 987.5
</code></pre>
</li>
<li>
<p><strong>ุจุฑูุงูู ุฏูู</strong>:</p>
<pre class="hljs"><code>Value is 123
Letter is X
11th Number is 1.45
Updated shared memory
</code></pre>
</li>
</ul>
<hr>
<p>ูฺฏุฑุงู pointers ูุจุงุดุฏ: ุจุฑูุงููโููุณุงู C++ ุงุฒ ุขูโูุง ุฏุฑ ุณุฑุงุณุฑ ุจุฑูุงููโูุง ุงุณุชูุงุฏู ูโฺฉููุฏ ู ูุนูููุงู ููู ฺุฒ ุฑุง ุฏุฑุณุช ุงุฌุฑุง ูโฺฉููุฏ. ฺฉุงุฑุจุฑุฏ ูุง ูุณุจุชุงู ุณุงุฏู ุงุณุช.</p>
<p>ุจู ุนูุงููุ ุงู ูุซุงู ุงุฒ ูุธุฑ <strong>thread-safety</strong> (ุง ุฏููโุชุฑุ <strong>process-safety</strong>) unsafe ุงุณุชุ ุฒุฑุง ุฏู ุจุฑูุงูู ููุฒูุงู ุจู ููุงู ุญุงูุธู ุฏุณุชุฑุณ ุฏุงุฑูุฏ. ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ุจุฑูุงููโูุง ูุงูุนุ ุจุงุฏ keyword <code>volatile</code> ุฑุง ุจู ููุฏูุง <code>Value</code> ู <code>Letter</code> ุงุถุงูู ฺฉูู ุชุง ุงุฒ cache ุดุฏู ุขูโูุง ุชูุณุท <strong>JIT compiler</strong> ุง ุณุฎุชโุงูุฒุงุฑ CPU ุฌููฺฏุฑ ุดูุฏ.</p>
<p>ููฺููุ ุฏุฑ ุชุนุงูู ูพฺุฏูโุชุฑ ุจุง ููุฏูุงุ ุงุญุชูุงูุงู ูุงุฒ ุงุณุช ุฏุณุชุฑุณ ุจู ุขูโูุง ุฑุง ุจุง ฺฉ <strong>cross-process Mutex</strong> ูุญุงูุธุช ฺฉููุ ุฏุฑุณุช ููุงููุฏ ุงุณุชูุงุฏู ุงุฒ <strong>lock</strong> ุจุฑุง ูุญุงูุธุช ุงุฒ ุฏุณุชุฑุณ ุจู ููุฏูุง ุฏุฑ ุจุฑูุงููโูุง multithreaded. ุฏุฑ ูุตู ฒฑ ุจู ุทูุฑ ฺฉุงูู ุฏุฑุจุงุฑู thread safety ุตุญุจุช ฺฉุฑุฏูโุงู.</p>
<h3>fixed ู fixed {...} ๐</h3>
<p>ฺฉ ุงุฒ ูุญุฏูุฏุชโูุง <strong>map ฺฉุฑุฏู ูุณุชูู struct ุจู ุญุงูุธู</strong> ุงู ุงุณุช ฺฉู struct ุชููุง ูโุชูุงูุฏ ุดุงูู <strong>unmanaged types</strong> ุจุงุดุฏ. ุงฺฏุฑ ูุงุฒ ุฏุงุฑุฏ ุฏุงุฏูโุง ุงุฒ ููุน <strong>string</strong> ุฑุง ุจู ุงุดุชุฑุงฺฉ ุจฺฏุฐุงุฑุฏุ ุจุงุฏ ุจู ุฌุง ุขู ุงุฒ <strong>ุขุฑุงูโุง ุงุฒ ฺฉุงุฑุงฺฉุชุฑูุง ุซุงุจุช</strong> ุงุณุชูุงุฏู ฺฉูุฏ. ุงู ุนู ุชุจุฏู ุฏุณุช ุจู string ู ุขุฑุงู. ูุซุงู:</p>
<pre class="hljs"><code>[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">struct</span> MySharedData
{
    ...
    <span class="hljs-comment">// ุงุฎุชุตุงุต ูุถุง ุจุฑุง 200 ฺฉุงุฑุงฺฉุชุฑ (ูุนุงุฏู 400 ุจุงุช)</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> MessageSize = <span class="hljs-number">200</span>;
    <span class="hljs-keyword">fixed</span> <span class="hljs-built_in">char</span> message[MessageSize];

    <span class="hljs-comment">// ูุนูููุงู ุงู ฺฉุฏ ุฏุฑ ฺฉ helper class ูุฑุงุฑ ูโฺฏุฑุฏ</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Message
    {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">fixed</span> (<span class="hljs-built_in">char</span>* cp = message) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(cp); }
        <span class="hljs-keyword">set</span>
        {
            <span class="hljs-keyword">fixed</span> (<span class="hljs-built_in">char</span>* cp = message)
            {
                <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">for</span> (; i &lt; <span class="hljs-keyword">value</span>.Length &amp;&amp; i &lt; MessageSize - <span class="hljs-number">1</span>; i++)
                    cp[i] = <span class="hljs-keyword">value</span>[i];
                <span class="hljs-comment">// ุงุถุงูู ฺฉุฑุฏู null terminator</span>
                cp[i] = <span class="hljs-string">&#x27;\0&#x27;</span>;
            }
        }
    }
}
</code></pre>
<p>ูฺ ููููู ุจู ูุงู <strong>reference ุจู ฺฉ ุขุฑุงู fixed</strong> ูุฌูุฏ ูุฏุงุฑุฏุ ุจู ุฌุง ุขูุ ฺฉ <strong>pointer</strong> ุฏุฑุงูุช ูโฺฉูุฏ. ููุช ุจู ฺฉ ุขุฑุงู fixed ุงูุฏุณโุฏู ูโฺฉูุฏุ ุฏุฑ ูุงูุน <strong>arithmetics pointer</strong> ุงูุฌุงู ูโุฏูุฏ!</p>
<p>ุฏุฑ ุงููู ุงุณุชูุงุฏู ุงุฒ keyword <code>fixed</code>ุ ูุง ูุถุง ูุงุฒู ุจุฑุง ฒฐฐ ฺฉุงุฑุงฺฉุชุฑ ุฑุง <strong>inline</strong> ุฏุฑ struct ุงุฎุชุตุงุต ุฏุงุฏู. ููู keyword ุฏุฑ property ูุนูุง ูุชูุงูุช ุฏุงุฑุฏ: ุจู CLR ูโฺฏูุฏ ฺฉู <strong>object ุฑุง pin ฺฉูุฏ</strong> ุชุง ุงฺฏุฑ garbage collection ุฑุฎ ุฏุงุฏุ ูุญุชูุง struct ุฌุงุจุฌุง ูุดูุฏุ ุฒุฑุง ุฏุงุฑู ูุณุชููุงู ุจุง memory pointers ุจู ุขู ุฏุณุชุฑุณ ูพุฏุง ูโฺฉูู.</p>
<p>ููฺฉู ุงุณุช ุจูพุฑุณุฏ ฺุฑุง MySharedData ูโุชูุงูุฏ ุฏุฑ managed memory ุฌุงุจุฌุง ุดูุฏุ ููุช ฺฉู ุฏุฑ unmanaged memory ูุฑุงุฑ ุฏุงุฑุฏ. ูพุงุณุฎ ุงู ุงุณุช ฺฉู <strong>ฺฉุงููพุงูุฑ ููโุฏุงูุฏ</strong> ู ูุฑุถ ูโฺฉูุฏ ููฺฉู ุงุณุช MySharedData ุฏุฑ context ูุฏุฑุชโุดุฏู ุงุณุชูุงุฏู ุดูุฏุ ูพุณ insist ูโฺฉูุฏ ฺฉู <code>fixed</code> ุงุถุงูู ุดูุฏ ุชุง ฺฉุฏ unsafe ูุง ุฏุฑ managed context ุงูู ุดูุฏ. ู ูุงูุนุงู ูู ุฏุฑุณุช ุงุณุชุ ุฒุฑุง ฺฉุงู ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-built_in">object</span> obj = <span class="hljs-keyword">new</span> MySharedData();
</code></pre>
<p>ุงู ุจุงุนุซ ูโุดูุฏ MySharedData ุฑู heap ูุฑุงุฑ ฺฏุฑุฏ ู <strong>boxed</strong> ุดูุฏ ู ุชุญุช ุชุงุซุฑ garbage collection ูุฑุงุฑ ฺฏุฑุฏ.</p>
<p>ุงู ูุซุงู ูุดุงู ูโุฏูุฏ ฺฺฏููู ูโุชูุงู ฺฉ <strong>string</strong> ุฑุง ุฏุฑ struct ฺฉู ุจู unmanaged memory map ุดุฏู ุงุณุชุ ููุงุด ุฏุงุฏ. ุจุฑุง ููุน ุฏุงุฏูโูุง ูพฺุฏูโุชุฑุ ูโุชูุงู ุงุฒ <strong>ฺฉุฏูุง serialization ููุฌูุฏ</strong> ุงุณุชูุงุฏู ฺฉุฑุฏุ ุจุง ุงู ุดุฑุท ฺฉู ุทูู ุฏุงุฏู serialize ุดุฏู ุงุฒ ูุถุง ุงุฎุชุตุงุตโุงูุชู ุฏุฑ struct ุชุฌุงูุฒ ูฺฉูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ูุชุฌู ูโุชูุงูุฏ <strong>ุชุฏุงุฎู ูุงุฎูุงุณุชู ุจุง ููุฏูุง ุจุนุฏ</strong> ุจุงุดุฏ.</p>
<hr>
<h3>COM Interoperability ๐ฅ๏ธ</h3>
<p><strong>Runtime .NET</strong> ูพุดุชุจุงู ูฺูโุง ุงุฒ COM ุงุฑุงุฆู ูโุฏูุฏ ู ุงุฌุงุฒู ูโุฏูุฏ <strong>COM objects</strong> ุงุฒ .NET ุงุณุชูุงุฏู ุดููุฏ ู ุจุงูุนฺฉุณ. COM ุชููุง ุฏุฑ Windows ุฏุฑ ุฏุณุชุฑุณ ุงุณุช.</p>
<hr>
<h4>ูุฏู COM</h4>
<p>COM ูุฎูู <strong>Component Object Model</strong> ุงุณุชุ ฺฉ ุงุณุชุงูุฏุงุฑุฏ ุจุงูุฑ ุจุฑุง ุชุนุงูู ุจุง ฺฉุชุงุจุฎุงููโูุง ฺฉู ุชูุณุท ูุงฺฉุฑูุณุงูุช ุฏุฑ ุณุงู ฑนนณ ุงุฑุงุฆู ุดุฏ. ูุฏู ุงุฒ ุงุฌุงุฏ COM ุงู ุจูุฏ ฺฉู <strong>ฺฉุงููพูููุชโูุง ุจุชูุงููุฏ ุจู ุตูุฑุช ูุณุชูู ุงุฒ ุฒุจุงู ู ููุงูู ุฏุฑ ุจุฑุงุจุฑ ูุณุฎูโุจูุฏ ุจุง ูู ุงุฑุชุจุงุท ุจุฑูุฑุงุฑ ฺฉููุฏ</strong>.</p>
<p>ูุจู ุงุฒ COMุ ุฏุฑ Windows ูุนูููุงู DLLูุง ููุชุดุฑ ูโุดุฏูุฏ ฺฉู ุณุงุฎุชุงุฑูุง ู ุชูุงุจุน ุฑุง ุจุง ุฒุจุงู C ุชุนุฑู ูโฺฉุฑุฏูุฏ. ุงู ุฑูุด:</p>
<ul>
<li><strong>ูุฎุชุต ุฒุจุงู ุจูุฏ</strong></li>
<li><strong>ุถุนู ู ุดฺฉููุฏู</strong> ุจูุฏุ ุญุช ุงุถุงูู ฺฉุฑุฏู ฺฉ ููุฏ ุฌุฏุฏ ุจู ฺฉ structุ specification ุขู ุฑุง ุฎุฑุงุจ ูโฺฉุฑุฏ.</li>
</ul>
<p>ุฒุจุง COM ุฏุฑ ุงู ุจูุฏ ฺฉู specification ฺฉ ููุน ุฑุง ุงุฒ ูพุงุฏูโุณุงุฒ ุขู ุฌุฏุง ฺฉุฑุฏ <strong>ุงุฒ ุทุฑู COM interface</strong>. COM ููฺูู ุงุฌุงุฒู ูโุฏูุฏ ฺฉู <strong>ูุชุฏูุง stateful objects</strong> ูุฑุงุฎูุงู ุดููุฏุ ูู ููุท procedureูุง ุณุงุฏู.</p>
<p>ุจู ููุนุ ูุฏู ุจุฑูุงููโููุณ .NET ฺฉ <strong>ุชฺฉุงูู ุงุฒ ุงุตูู ุจุฑูุงููโููุณ COM</strong> ุงุณุช:</p>
<ul>
<li>ุชูุณุนู cross-language</li>
<li>ุงูฺฉุงู ุชุบุฑ binary components ุจุฏูู ุดฺฉุณุชู ุจุฑูุงููโูุง ฺฉู ุจู ุขูโูุง ูุงุจุณุชูโุงูุฏ.</li>
</ul>
<hr>
<h4>ุงุตูู ุณุณุชู ููุน COM</h4>
<p>ุณุณุชู ููุน COM ุญูู <strong>interfaces</strong> ูโฺุฑุฎุฏ. ฺฉ COM interface ุดุจู ฺฉ .NET interface ุงุณุชุ ุงูุง ฺฉุงุฑุจุฑุฏ ุขู ฺฏุณุชุฑุฏูโุชุฑ ุงุณุชุ ุฒุฑุง COM ุชููุง ุงุฒ ุทุฑู interface ูุงุจูุชโูุง ุฎูุฏ ุฑุง ุงุฑุงุฆู ูโุฏูุฏ.</p>
<p>ูุซุงู ุฏุฑ ุฏูุง .NET:</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title">Test</span>()</span> =&gt; <span class="hljs-string">&quot;Hello, world&quot;</span>;
}
</code></pre>
<p>ฺฉุงุฑุจุฑุงู ูโุชูุงููุฏ Foo ุฑุง ูุณุชูู ุงุณุชูุงุฏู ฺฉููุฏ. ุงฺฏุฑ ุจุนุฏูุง implementation ุชุงุจุน Test() ุชุบุฑ ฺฉูุฏุ assemblyูุง ูุฑุงุฎูุงู ูุงุฒ ุจู recompile ูุฏุงุฑูุฏ.</p>
<p>ุฏุฑ COMุ Foo ุจุฑุง ุฌุฏุงุณุงุฒ interface ุงุฒ implementationุ <strong>ูุงุจูุชโูุง ุฎูุฏ ุฑุง ุงุฒ ุทุฑู ฺฉ interface ุงุฑุงุฆู ูโุฏูุฏ</strong>:</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IFoo</span> { <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">Test</span>()</span>; }
</code></pre>
<p>ุงุถุงูู ฺฉุฑุฏู overload ุฏุฑ COM ูพฺุฏูโุชุฑ ุงุณุชุ ุฒุฑุง:</p>
<ul>
<li>interfaces ููุชุดุฑุดุฏู immutable ูุณุชูุฏ.</li>
<li>COM ุงุฌุงุฒู method overloading ููโุฏูุฏ.</li>
</ul>
<p>ุฑุงูโุญู: ุงุฌุงุฏ interface ุฏูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IFoo2</span> { <span class="hljs-function"><span class="hljs-built_in">string</span> <span class="hljs-title">Test</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> s</span>)</span>; }
</code></pre>
<p>ูพุดุชุจุงู ุงุฒ ฺูุฏู interface ฺฉูุฏ ุงุณุช ุชุง <strong>ฺฉุชุงุจุฎุงููโูุง COM versionable</strong> ุดููุฏ.</p>
<hr>
<h4>IUnknown ู IDispatch</h4>
<p>ุชูุงู COM interfaces ุจุง ฺฉ <strong>GUID (Globally Unique Identifier)</strong> ุดูุงุณุง ูโุดููุฏ.</p>
<ul>
<li>
<p><strong>IUnknown</strong>: root interface ุฏุฑ COM ุงุณุช ู ุชูุงู COM objects ุจุงุฏ ุขู ุฑุง ูพุงุฏูโุณุงุฒ ฺฉููุฏ. ูุชุฏูุง ุขู:</p>
<ul>
<li><code>AddRef</code> ู <code>Release</code> ุจุฑุง ูุฏุฑุช ุทูู ุนูุฑ (COM ุงุฒ reference counting ุงุณุชูุงุฏู ูโฺฉูุฏุ ูู garbage collection ุฎูุฏฺฉุงุฑ).</li>
<li><code>QueryInterface</code> ุจุฑุง ุจุงุฒฺฏุฑุฏุงูุฏู reference ุจู ฺฉ interface ูพุดุชุจุงูโุดุฏู.</li>
</ul>
</li>
<li>
<p><strong>IDispatch</strong>: ุจุฑุง ุจุฑูุงููโููุณ ุฏุงูุงูฺฉ (ูุงููุฏ scripting ู automation). ุงูฺฉุงู ูุฑุงุฎูุงู late-bound ูุดุงุจู dynamic ุฏุฑ C# ุฑุง ูุฑุงูู ูโฺฉูุฏ (ุจุฑุง simple invocations).</p>
</li>
</ul>
<h3>ูุฑุงุฎูุงู ฺฉ ฺฉุงููพูููุช COM ุงุฒ C# ๐ฅ๏ธ</h3>
<p>CLR ุฏุฑ <strong>ูพุดุชุจุงู ุฏุงุฎู ุงุฒ COM</strong> ุจู ุดูุง ุงุฌุงุฒู ููโุฏูุฏ ูุณุชููุงู ุจุง <code>IUnknown</code> ู <code>IDispatch</code> ฺฉุงุฑ ฺฉูุฏ. ุจู ุฌุง ุขูุ ุดูุง ุจุง <strong>CLR objects</strong> ฺฉุงุฑ ูโฺฉูุฏ ู runtime ูุฑุงุฎูุงูโูุง ุดูุง ุฑุง ุจู ุฏูุง COM <strong>ุงุฒ ุทุฑู Runtime-Callable Wrappers (RCWs)</strong> ููุชูู ูโฺฉูุฏ.</p>
<ul>
<li><strong>ูุฏุฑุช ุทูู ุนูุฑ</strong>: runtime ููฺฏุงู finalize ุดุฏู ุดุก .NETุ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ <code>AddRef</code> ู <code>Release</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ.</li>
<li><strong>ุชุจุฏู ููุน ุฏุงุฏูโูุง</strong>: primitive types ูุซู int ู string ุจู ุฏูุง managed ู unmanaged ุจู ุดฺฉู ููุงุณุจ ุชุจุฏู ูโุดููุฏ.</li>
</ul>
<hr>
<h3>COM Interop Types</h3>
<p>ุจุฑุง ุฏุณุชุฑุณ ุจู RCWs ุจู ุตูุฑุช <strong>type-safe</strong>ุ ุงุฒ <strong>COM interop types</strong> ุงุณุชูุงุฏู ูโฺฉูู. ุงูโูุง <strong>proxy types</strong> ูุณุชูุฏ ฺฉู ุจุฑุง ูุฑ member COMุ ฺฉ member .NET ุงุฌุงุฏ ูโฺฉููุฏ.</p>
<ul>
<li>ุงุจุฒุงุฑ <code>tlbimp.exe</code> ูโุชูุงูุฏ COM interop types ุฑุง ุงุฒ <strong>type library</strong> ุจุณุงุฒุฏ ู ุขูโูุง ุฑุง ุฏุฑ ฺฉ <strong>COM interop assembly</strong> ูุฑุงุฑ ุฏูุฏ.</li>
<li>ุงฺฏุฑ ฺฉ ฺฉุงููพูููุช COM ฺูุฏู interface ุฏุงุดุชู ุจุงุดุฏุ <code>tlbimp.exe</code> ฺฉ type ูุงุญุฏ ุงุฌุงุฏ ูโฺฉูุฏ ฺฉู ุดุงูู <strong>union ุงุนุถุง ุงุฒ ููู interfaces</strong> ุงุณุช.</li>
</ul>
<p>ุฏุฑ <strong>Visual Studio</strong>:</p>
<ul>
<li>ุงุฒ <strong>Add Reference</strong> &gt; COM tabุ ฺฉุชุงุจุฎุงูู ููุฑุฏ ูุธุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ (ูุซูุงู Microsoft Excel Object Library).</li>
<li>ฺฉุฏ ููููู ุจุฑุง ุงุฌุงุฏ ฺฉ Workbook ู ูพุฑ ฺฉุฑุฏู ฺฉ ุณููู ุฏุฑ Excel:</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> Excel = Microsoft.Office.Interop.Excel;

<span class="hljs-keyword">var</span> excel = <span class="hljs-keyword">new</span> Excel.Application();
excel.Visible = <span class="hljs-literal">true</span>;
excel.WindowState = Excel.XlWindowState.xlMaximized;

Excel.Workbook workBook = excel.Workbooks.Add();
((Excel.Range)excel.Cells[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]).Font.FontStyle = <span class="hljs-string">&quot;Bold&quot;</span>;
((Excel.Range)excel.Cells[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]).Value2 = <span class="hljs-string">&quot;Hello World&quot;</span>;

workBook.SaveAs(<span class="hljs-string">@&quot;d:\temp.xlsx&quot;</span>);
</code></pre>
<p><strong>ูฺฉุชู ููู:</strong> ุจุฑุง ุงูฺฉู runtime ุจุชูุงูุฏ interop types ุฑุง ูพุฏุง ฺฉูุฏุ ุจุงุฏ <strong>Embed Interop Types</strong> ุฑุง ูุนุงู ฺฉูุฏ.</p>
<ul>
<li>ุฏุฑ Visual Studio: ุฑู COM reference ฺฉูฺฉ ฺฉูุฏ ู <code>Embed Interop Types = true</code> ุชูุธู ฺฉูุฏ.</li>
<li>ุง ุฏุฑ <code>.csproj</code>:</li>
</ul>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">COMReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">&quot;Microsoft.Office.Excel.dll&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">EmbedInteropTypes</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">EmbedInteropTypes</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">COMReference</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
</code></pre>
<hr>
<h3>Optional Parameters ู Named Arguments</h3>
<p>COM APIs ูุนูููุงู ุชุงุจุนโูุง ุจุง <strong>ุชุนุฏุงุฏ ุฒุงุฏ ูพุงุฑุงูุชุฑ ุงุฎุชุงุฑ</strong> ุฏุงุฑูุฏุ ุฒุฑุง overloading ูุฏุงุฑูุฏ.</p>
<ul>
<li>C# <strong>COM-aware</strong> ุงุณุช ู ูโุชูุงูุฏ ุงุฒ optional parameters ุงุณุชูุงุฏู ฺฉูุฏ:</li>
</ul>
<pre class="hljs"><code>workBook.SaveAs(<span class="hljs-string">@&quot;d:\temp.xlsx&quot;</span>);
</code></pre>
<ul>
<li><strong>Named arguments</strong> ุงูฺฉุงู ูุดุฎุต ฺฉุฑุฏู ูพุงุฑุงูุชุฑูุง ุจุฏูู ุชูุฌู ุจู ูููุนุช ุฑุง ูุฑุงูู ูโฺฉููุฏ:</li>
</ul>
<pre class="hljs"><code>workBook.SaveAs(<span class="hljs-string">@&quot;d:\test.xlsx&quot;</span>, Password: <span class="hljs-string">&quot;foo&quot;</span>);
</code></pre>
<hr>
<h3>Implicit ref Parameters</h3>
<p>ุจุฑุฎ COM APIs (ูุซู Microsoft Word) <strong>ุชูุงู ูพุงุฑุงูุชุฑูุง ุฑุง ุจู ุตูุฑุช pass-by-reference</strong> ุชุนุฑู ูโฺฉููุฏุ ุญุช ุงฺฏุฑ ุชุบุฑ ูุฏููุฏ.</p>
<ul>
<li>ูุจูุงู ูุฌุจูุฑ ุจูุฏุฏ <code>ref</code> ุฑุง ุจุฑุง ูุฑ ูพุงุฑุงูุชุฑ ุงุณุชูุงุฏู ฺฉูุฏุ ฺฉู optional parameters ุฑุง ุบุฑููฺฉู ูโฺฉุฑุฏ:</li>
</ul>
<pre class="hljs"><code><span class="hljs-built_in">object</span> filename = <span class="hljs-string">&quot;foo.doc&quot;</span>;
<span class="hljs-built_in">object</span> notUsed = Missing.Value;
word.Open(<span class="hljs-keyword">ref</span> filename, <span class="hljs-keyword">ref</span> notUsed, ...);
</code></pre>
<ul>
<li>ุจุง implicit ref parameters ุฏุฑ C#ุ ูโุชูุงูุฏ ุจุฏูู <code>ref</code> ูุฑุงุฎูุงู ฺฉูุฏ:</li>
</ul>
<pre class="hljs"><code>word.Open(<span class="hljs-string">&quot;foo.doc&quot;</span>);
</code></pre>
<blockquote>
<p>ูุดุฏุงุฑ: ุงฺฏุฑ COM method ูุงูุนุง ฺฉ ูพุงุฑุงูุชุฑ ุฑุง ุชุบุฑ ุฏูุฏุ ูฺ ุฎุทุง compile-time ุง runtime ุฏุฑุงูุช ููโฺฉูุฏ.</p>
</blockquote>
<hr>
<h3>Indexers</h3>
<ul>
<li>ุญุฐู ูุงุฒ ุจู <code>ref</code> ุงุฌุงุฒู ูโุฏูุฏ COM <strong>indexers ุจุง ูพุงุฑุงูุชุฑ ref</strong> ุฑุง ุจู ุดฺฉู ordinary C# indexer ุงุณุชูุงุฏู ฺฉูุฏ:</li>
</ul>
<pre class="hljs"><code>myComObject.Foo[<span class="hljs-number">123</span>] = <span class="hljs-string">&quot;Hello&quot;</span>;
</code></pre>
<ul>
<li>ุฎูุฏุชุงู ููโุชูุงูุฏ ฺูู indexerูุง ุจุณุงุฒุฏุ ููุท COM ูโุชูุงูุฏ ฺูู propertyูุง ุงุฑุงุฆู ุฏูุฏ ฺฉู ุฎูุฏุดุงู indexer ุฏุงุฑูุฏ.</li>
</ul>
<hr>
<h3>Dynamic Binding</h3>
<ul>
<li>ุงุฌุงุฒู ุฏุณุชุฑุณ ุจู COM component ุจุฏูู <strong>COM interop type</strong>:</li>
</ul>
<pre class="hljs"><code>Type excelAppType = Type.GetTypeFromProgID(<span class="hljs-string">&quot;Excel.Application&quot;</span>, <span class="hljs-literal">true</span>);
<span class="hljs-built_in">dynamic</span> excel = Activator.CreateInstance(excelAppType);
excel.Visible = <span class="hljs-literal">true</span>;
<span class="hljs-built_in">dynamic</span> wb = excel.Workbooks.Add();
excel.Cells[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].Value2 = <span class="hljs-string">&quot;foo&quot;</span>;
</code></pre>
<ul>
<li>ุฌุงฺฏุฒู ูุฏู ู ุณุฎุชโุชุฑ: ุงุณุชูุงุฏู ุงุฒ reflection ุจู ุฌุง dynamic.</li>
<li>Dynamic ููฺูู ูโุชูุงูุฏ ุจุง <strong>COM variant type</strong> ุจูุชุฑ ฺฉุงุฑ ฺฉูุฏ (ูุนุงุฏู object ุฏุฑ .NET). ุจุง ูุนุงู ฺฉุฑุฏู <strong>Embed Interop Types</strong>ุ variant ุจู dynamic map ูโุดูุฏ ู ูุงุฒ ุจู cast ูุณุช:</li>
</ul>
<pre class="hljs"><code>excel.Cells[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>].Font.FontStyle = <span class="hljs-string">&quot;Bold&quot;</span>;
</code></pre>
<ul>
<li>ูุนุงุจ dynamic: <strong>ุงุฒ ุฏุณุช ุฏุงุฏู IntelliSense</strong> ู ฺฺฉโูุง compile-time.</li>
<li>ุฑุงู ูุนููู: ุชุจุฏู ูุชุฌู ุจู interop type ุดูุงุฎุชู ุดุฏู:</li>
</ul>
<pre class="hljs"><code>Excel.Range range = excel.Cells[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>];
range.Font.FontStyle = <span class="hljs-string">&quot;Bold&quot;</span>;
</code></pre>
<blockquote>
<p>mapping variant โ dynamic ูพุดโูุฑุถ ุงุณุช ู ูุงุจุณุชู ุจู ูุนุงู ุจูุฏู Embed Interop Types ูโุจุงุดุฏ.</p>
</blockquote>
<h3>ุฌุงุณุงุฒ Interop Types ุฏุฑ C# ๐งฉ</h3>
<p>ุฏุฑ ฺฏุฐุดุชูุ C# ุจุฑุง ูุฑุงุฎูุงู ฺฉุงููพูููุชโูุง COM ูุงุฒ ุฏุงุดุช ฺฉู <strong>Interop Assemblies</strong> ุฑุง ุจู ูพุฑูฺู ุงุถุงูู ฺฉูุฏ (ูุซูุงู ุจุง <code>tlbimp.exe</code>). ุงูุง ุงู ฺฉุงุฑ ูุดฺฉูุงุช ุฏุงุดุช:</p>
<ul>
<li>ุงู Interop Assemblies ฺฏุงู ุจุณุงุฑ ุจุฒุฑฺฏ ูโุดุฏูุฏ.</li>
<li>ุญุช ฺฉ add-in ฺฉูฺฺฉ ุจุฑุง Word ูโุชูุงูุณุช Interop Assembly ฺูุฏู ุจุฑุงุจุฑ ุฎูุฏุด ุญุฌู ุฏุงุดุชู ุจุงุดุฏ.</li>
</ul>
<p>ุจู ุฌุง ุงูุฒูุฏู ฺฉู Assemblyุ ูโุชูุงูุฏ ููุท ุจุฎุดโูุง ฺฉู ุงุณุชูุงุฏู ูโฺฉูุฏ ุฑุง <strong>embed</strong> ฺฉูุฏ:</p>
<ul>
<li><strong>ฺฉุงููพุงูุฑ</strong> ููุท memberูุง ฺฉู ุงุณุชูุงุฏู ูโฺฉูุฏ ุฑุง ุชุญูู ฺฉุฑุฏู ู ูุณุชููุงู ุฏุฑ ุจุฑูุงูู ุดูุง ุฌุงุณุงุฒ ูโฺฉูุฏ.</li>
<li>ุงู ฺฉุงุฑ ุจุงุนุซ ฺฉุงูุด ุญุฌู ู ุนุฏู ูุงุฒ ุจู ูุงู ุงุถุงู ูโุดูุฏ.</li>
</ul>
<p><strong>ูุนุงูโุณุงุฒ ุฏุฑ Visual Studio:</strong></p>
<ul>
<li>ุฑู COM reference ฺฉูฺฉ ฺฉุฑุฏู ู <code>Embed Interop Types = true</code> ุฑุง ุฏุฑ Properties ูุนุงู ฺฉูุฏ.</li>
<li>ุง ุฏุฑ <code>.csproj</code>:</li>
</ul>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">ItemGroup</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">COMReference</span> <span class="hljs-attr">Include</span>=<span class="hljs-string">&quot;Microsoft.Office.Excel.dll&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">EmbedInteropTypes</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">EmbedInteropTypes</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">COMReference</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ItemGroup</span>&gt;</span>
</code></pre>
<hr>
<h3>Type Equivalence โ๏ธ</h3>
<p>CLR ุงุฒ <strong>Type Equivalence</strong> ุจุฑุง linked interop types ูพุดุชุจุงู ูโฺฉูุฏ:</p>
<ul>
<li>ุงฺฏุฑ ุฏู Assembly ุจู ฺฉ COM type ููฺฉ ุดููุฏุ ุขูโูุง <strong>ูุนุงุฏู</strong> ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดููุฏ ุญุช ุงฺฏุฑ Interop Assemblies ุฌุฏุงฺฏุงูู ุชููุฏ ุดุฏู ุจุงุดูุฏ.</li>
<li>ุงู ูฺฺฏ ุจุฑ ูพุงู <code>TypeIdentifierAttribute</code> ุฏุฑ ูุถุง ูุงู <code>System.Runtime.InteropServices</code> ฺฉุงุฑ ูโฺฉูุฏ.</li>
<li>COM types ุจุง <strong>GUID ฺฉุณุงู</strong> ุจุฑุงุจุฑ ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดููุฏ.</li>
</ul>
<hr>
<h3>ุงูุชุดุงุฑ ุงุดุงุก C# ุจู COM (CCW)</h3>
<p>ุจุฑุง ุงูฺฉู ฺฉ ฺฉูุงุณ C# ุฏุฑ ุฏูุง COM ูุงุจู ุงุณุชูุงุฏู ุจุงุดุฏ:</p>
<ul>
<li>ุงุฒ <strong>COM-Callable Wrapper (CCW)</strong> ุงุณุชูุงุฏู ูโุดูุฏ ฺฉู typeโูุง ุฑุง ุจู ุฏูุง managed ู unmanaged marshaling ูโฺฉูุฏ.</li>
<li>CCW <code>IUnknown</code> ู ุฏุฑ ุตูุฑุช ูุงุฒ <code>IDispatch</code> ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ.</li>
<li>ุทูู ุนูุฑ ุงุฒ ุณูุช COM ุจุง <strong>reference counting</strong> ฺฉูุชุฑู ูโุดูุฏ.</li>
</ul>
<h4>ูุฑุงุญู</h4>
<ol>
<li>ุงุฌุงุฏ ฺฉ interface ู ุงุฎุชุตุงุต GUID ฺฉุชุง ุจู ุขู:</li>
</ol>
<pre class="hljs"><code><span class="hljs-keyword">namespace</span> <span class="hljs-title">MyCom</span>
{
  [<span class="hljs-meta">ComVisible(true)</span>]
  [<span class="hljs-meta">Guid(<span class="hljs-string">&quot;226E5561-C68E-4B2B-BD28-25103ABCA3B1&quot;</span>)</span>]
  [<span class="hljs-meta">InterfaceType(ComInterfaceType.InterfaceIsIUnknown)</span>]
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IServer</span>
  {
      <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">Fibonacci</span>()</span>;
  }
}
</code></pre>
<ol start="2">
<li>ูพุงุฏูโุณุงุฒ interface ู ุงุฎุชุตุงุต GUID ุจู ฺฉูุงุณ:</li>
</ol>
<pre class="hljs"><code><span class="hljs-keyword">namespace</span> <span class="hljs-title">MyCom</span>
{
  [<span class="hljs-meta">ComVisible(true)</span>]
  [<span class="hljs-meta">Guid(<span class="hljs-string">&quot;09E01FCD-9970-4DB3-B537-0EC555967DD9&quot;</span>)</span>]
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Server</span> : <span class="hljs-title">IServer</span>
  {
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">ulong</span> <span class="hljs-title">Fibonacci</span>(<span class="hljs-params"><span class="hljs-built_in">ulong</span> whichTerm</span>)</span>
      {
          <span class="hljs-keyword">if</span> (whichTerm &lt; <span class="hljs-number">1</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">&quot;...&quot;</span>);
          <span class="hljs-built_in">ulong</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span>;
          <span class="hljs-keyword">for</span> (<span class="hljs-built_in">ulong</span> i = <span class="hljs-number">0</span>; i &lt; whichTerm; i++)
          {
              <span class="hljs-built_in">ulong</span> tmp = a;
              a = b;
              b = tmp + b;
          }
          <span class="hljs-keyword">return</span> a;
      }
  }
}
</code></pre>
<ol start="3">
<li>ูุนุงู ฺฉุฑุฏู COM hosting ุฏุฑ <code>.csproj</code>:</li>
</ol>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">EnableComHosting</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">EnableComHosting</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span>
</code></pre>
<ol start="4">
<li>ูุงู ุชููุฏ ุดุฏู (<code>MyCom.comhost.dll</code>) ุฑุง ุจุง <code>regsvr32</code> ุซุจุช ฺฉูุฏ.</li>
</ol>
<hr>
<h3>ูุตุฑู COM ุงุฒ ุณุงุฑ ุฒุจุงูโูุง</h3>
<p>ูุซุงู ุจุง <strong>VBScript</strong>:</p>
<pre class="hljs"><code><span class="hljs-comment">REM Save as ComClient.vbs</span>
<span class="hljs-keyword">Dim</span> obj
<span class="hljs-keyword">Set</span> obj = CreateObject(<span class="hljs-string">&quot;MyCom.Server&quot;</span>)
result = obj.Fibonacci(<span class="hljs-number">12</span>)
Wscript.Echo result
</code></pre>
<blockquote>
<p>ุชูุฌู: .NET Framework ู .NET 5+ / .NET Core ููโุชูุงููุฏ ุฏุฑ ฺฉ process ุจุงุฑฺฏุฐุงุฑ ุดููุฏุ ุจูุงุจุฑุงู COM server ุฏุฑ .NET 5+ ููโุชูุงูุฏ ุฏุฑ .NET Framework client ูุฑุงุฎูุงู ุดูุฏ.</p>
</blockquote>
<hr>
<h3>COM ุจุฏูู ุฑุฌุณุชุฑ (Registry-Free COM) ๐๏ธ</h3>
<ul>
<li>ุจู ุฌุง ุซุจุช COM object ุฏุฑ ุฑุฌุณุชุฑุ ุงุฒ <strong>manifest ูุงู</strong> ุงุณุชูุงุฏู ูโุดูุฏ.</li>
<li>ูุนุงูโุณุงุฒ ุฏุฑ <code>.csproj</code>:</li>
</ul>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">TargetFramework</span>&gt;</span>netcoreapp3.0<span class="hljs-tag">&lt;/<span class="hljs-name">TargetFramework</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">EnableComHosting</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">EnableComHosting</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">EnableRegFreeCom</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">EnableRegFreeCom</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span>
</code></pre>
<ul>
<li>ุฏุฑ ุงู ุญุงูุช ูุงู <code>MyCom.X.manifest</code> ุณุงุฎุชู ูโุดูุฏ.</li>
</ul>
<blockquote>
<p>ุฏุฑ .NET 5+ ุงูฺฉุงู ุชููุฏ <strong>COM type library (*.tlb)</strong> ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ูุฌูุฏ ูุฏุงุฑุฏ. ุจุงุฏ ุฏุณุช IDL ุง header C++ ุงุฌุงุฏ ฺฉูุฏ.</p>
</blockquote>

  </main>

  <!-- ููุชุฑ ูุดุชุฑฺฉ -->
  <footer class="footer">
    <div class="container">
      <p>
        <img src="/Gitab/icone/copyright.svg" alt="ฺฉูพโุฑุงุช" width="14" height="14"
             style="vertical-align:middle;margin-inline:4px">
        <span id="y"></span> Gitab โ ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู
      </p>
    </div>
  </footer>

  <!-- ุณุงู ู ุงุณฺฉุฑูพุช ุชุบุฑ ุชู -->
  <script>
  (() => {
    const root = document.documentElement;
    const btn = document.getElementById('themeToggle');
    const KEY = 'gitab-theme';

    function updateTheme(s) {
      root.setAttribute('data-theme', s);
      const mode = s;  // ููุท `dark` ุง `light` ุฎูุงูุฏ ุจูุฏ
      root.dataset.colorMode = mode;
      btn.dataset.icon = mode === 'dark' ? 'moon' : 'sun';
    }

    // ูุถุนุช ุชู ุฐุฎุฑู ุดุฏู ุงุฒ localStorage
    let saved = localStorage.getItem(KEY) || 'light'; // ูพุดโูุฑุถ ุฑูุดู
    updateTheme(saved);

    // ุชูุธู ูุฌุฏุฏ ุชู ููฺฏุงู ุชุบุฑ ูุถุนุช ุฏฺฉูู
    btn.addEventListener('click', () => {
      const current = localStorage.getItem(KEY) || 'light';
      const next = current === 'dark' ? 'light' : 'dark';  // ููุท ุฏู ุญุงูุช: ุชุงุฑฺฉ ู ุฑูุดู
      localStorage.setItem(KEY, next);
      updateTheme(next);
    });

    // ููฺฏุงู ุจุงุฑฺฏุฐุงุฑ ุตูุญู
    document.addEventListener('DOMContentLoaded', () => {
      updateTheme(localStorage.getItem(KEY) || 'light');
    });
  })();
</script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>

  <script>
  document.querySelectorAll('pre code').forEach(block => {
    const btn = document.createElement('button');
    btn.className = 'copy-btn';

    const icon = document.createElement('img');
    icon.src = "/Gitab/icone/copy.svg";
    icon.alt = 'Copy';
    btn.appendChild(icon);

    block.parentNode.insertBefore(btn, block);

    btn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(block.textContent);
      btn.classList.add('copied');
      setTimeout(() => btn.classList.remove('copied'), 1500);
    });
  });
  </script>

  <script>
  document.body.dataset.page = window.location.pathname;

  const menuBtn = document.querySelector(".menu-toggle");
  const nav = document.querySelector(".nav");

  if (menuBtn && nav) {
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      nav.classList.toggle("show");
    });

    document.addEventListener("click", (e) => {
      const clickedInsideNav = nav.contains(e.target);
      const clickedMenuButton = menuBtn.contains(e.target);
      if (!clickedInsideNav && !clickedMenuButton) {
        nav.classList.remove("show");
      }
    });
  }
  </script>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>
  <script>
document.getElementById("openDonate").addEventListener("click", () => {
  document.getElementById("donateModal").style.display = "block";
});
document.getElementById("closeDonate").addEventListener("click", () => {
  document.getElementById("donateModal").style.display = "none";
});
document.querySelectorAll(".copy-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    navigator.clipboard.writeText(btn.dataset.copy);
    btn.textContent = "โ ฺฉูพ ุดุฏ!";
    setTimeout(() => (btn.textContent = "ฺฉูพ"), 2000);
  });
});
</script>

</body>
</html>
