<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Threading ูพุดุฑูุชู</title>
  <meta name="description" content="ุชุฑุฌููโูุง ูุงุฑุณ ฺฉุชุงุจโูุง ูู โ ุณุฑุนุ ูููุงู ู ูุงุจู ุงุชฺฉุง.">
  <link rel="stylesheet" href="/styles/main.css">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
@font-face {
  font-family: 'Vazir';
  src: url('/fonts/Vazir-FD-WOL.ttf') format('truetype');
  font-display: swap;
}
body {
  font-family: 'Vazir', sans-serif;
}
</style>

</head>
<body>
  <!-- ูุฏุฑ ูุดุชุฑฺฉ -->
 <header class="header">
  <div class="container nav-wrap">
    <a href="/" class="brand">
      <img src="/icone/logo.svg" alt="Gitab logo" width="26" height="26">
      <span>Gitab</span>
    </a>

    <nav class="nav">
      <a href="/" aria-current="page">ุฎุงูู</a>
      <a href="/books/list-books">ฺฉุชุงุจโูุง</a>
      <a href="#">ูุชุฑุฌูู</a>
      <a href="#">ููฺฉุงุฑ</a>
      <a href="#">ุฏุฑุจุงุฑู ูุง</a>
    </nav>

    <div class="nav-actions">
     <button id="themeToggle" class="icon-btn theme-btn" data-icon="moon" aria-label="ุชุบุฑ ุชู">
        <img src="/icone/sun.svg" class="icon-sun" alt="ุฑูุดู">
        <img src="/icone/moon.svg" class="icon-moon" alt="ุชุงุฑฺฉ">
      </button>
  <a class="icon-btn" href="https://github.com/hheydarian/Gitab" target="_blank" title="GitHub">
    <img src="/icone/github.svg" alt="GitHub">
  </a>
      <!-- ุฏฺฉูู ููู ุจุฑุง ููุจุงู -->
      <button class="menu-toggle" aria-label=" ููู">
        <img src="/icone/menu.svg" alt="menu">
      </button>
    </div>
  </div> 
  

</header>

 

<main class="site-main book-page ">
  <h1>ูุตู ุจุณุช ู ฺฉู:  Threading ูพุดุฑูุชู</h1>
<p>ูุง ุฏุฑ <strong>ูุตู ฑด</strong> ุจุง ูุจุงู ุงูููโ <strong>Threading</strong> ุดุฑูุน ฺฉุฑุฏู ุชุง ููุฏููโุง ุจุฑุง <strong>Tasks</strong> ู <strong>Asynchrony</strong> ุจุงุดุฏ. ุจู ุทูุฑ ูุดุฎุตุ ูุดุงู ุฏุงุฏู ฺุทูุฑ ูโุชูุงู ฺฉ <strong>Thread</strong> ุฑุง ุดุฑูุน ู ูพฺฉุฑุจูุฏ ฺฉุฑุฏ ู ููุงูู ุงุณุงุณ ูุซู <strong>Thread Pooling</strong>ุ <strong>Blocking</strong>ุ <strong>Spinning</strong> ู <strong>Synchronization Contexts</strong> ุฑุง ูพูุดุด ุฏุงุฏู. ููฺูู ุจู <strong>Locking</strong> ู <strong>Thread Safety</strong> ูพุฑุฏุงุฎุชู ู ุณุงุฏูโุชุฑู ุณุงุฒูโ ุณฺฏูุงูโุฏูุ ุนู <strong>ManualResetEvent</strong> ุฑุง ูุนุฑู ฺฉุฑุฏู.</p>
<p>ุงู ูุตู ุฏููุงู ุงุฒ ููุงูโุฌุง ุงุฏุงูู ูพุฏุง ูโฺฉูุฏ ฺฉู ูุตู ฑด ุฏุฑ ููุถูุน <strong>Threading</strong> ูุชููู ุดุฏ. ุฏุฑ ุณู ุจุฎุด ุงููุ ุจูโุทูุฑ ุนููโุชุฑ ุจู <strong>Synchronization</strong>ุ <strong>Locking</strong> ู <strong>Thread Safety</strong> ูโูพุฑุฏุงุฒู. ุณูพุณ ููุงุฑุฏ ุฒุฑ ุฑุง ูพูุดุด ูโุฏูู:</p>
<ul>
<li>๐ <strong>Nonexclusive locking</strong> (ูุงููุฏ <strong>Semaphore</strong> ู <strong>Reader/Writer Locks</strong>)</li>
<li>๐ ูููโ ุณุงุฒูโูุง ุณฺฏูุงูโุฏู (<strong>AutoResetEvent</strong>ุ <strong>ManualResetEvent</strong>ุ <strong>CountdownEvent</strong> ู <strong>Barrier</strong>)</li>
<li>๐ข <strong>Lazy Initialization</strong> (ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>Lazy<T></strong> ู <strong>LazyInitializer</strong>)</li>
<li>๐งฉ <strong>Thread-local storage</strong> (ูุงููุฏ <strong>ThreadStaticAttribute</strong>ุ <strong>ThreadLocal<T></strong> ู <strong>GetData/SetData</strong>)</li>
<li>โฑ <strong>Timers</strong></li>
</ul>
<p>ููุถูุน <strong>Threading</strong> ุขูโูุฏุฑ ูุณุน ุงุณุช ฺฉู ูุง ุจุฎุดโูุง ุชฺฉูู ุฑุง ุจูโุตูุฑุช ุขููุงู ูุฑุงุฑ ุฏุงุฏูโุงู ุชุง ุชุตูุฑ ฺฉุงููโุชุฑ ุงุฑุงุฆู ุดูุฏ. ุจุฑุง ูุทุงูุนูโ ููุถูุนุงุช ูพุดุฑูุชูโุชุฑุ ุจู ูุจโุณุงุช ุฒุฑ ูุฑุงุฌุนู ฺฉูุฏ:</p>
<p>๐ <a href="http://albahari.com/threading">http://albahari.com/threading</a></p>
<p>ุฏุฑ ุขูโุฌุง ูุจุงุญุซ ุฒุฑ ุฑุง ุฎูุงูุฏ ุงูุช:</p>
<ul>
<li>โ๏ธ <strong>Monitor.Wait</strong> ู <strong>Monitor.Pulse</strong> ุจุฑุง ุณูุงุฑููุง ุฎุงุต ุณฺฏูุงูโุฏู</li>
<li>๐ ุชฺฉูฺฉโูุง <strong>Nonblocking Synchronization</strong> ุจุฑุง <strong>Micro-Optimization</strong> (ูุงููุฏ <strong>Interlocked</strong>ุ <strong>Memory Barriers</strong>ุ <strong>volatile</strong>)</li>
<li>๐ <strong>SpinLock</strong> ู <strong>SpinWait</strong> ุจุฑุง ุณูุงุฑููุง ุจุง <strong>Concurrency</strong> ุจุงูุง</li>
</ul>
<hr>
<h2>๐ Synchronization Overview (ูุฑูุฑ Synchronization)</h2>
<p><strong>Synchronization</strong> ุนู ููุงููฺฏโุณุงุฒ ุนููุงุช ููุฒูุงู ุจุฑุง ุฏุณุชุงุจ ุจู ฺฉ ูุชุฌูโ ูุงุจู ูพุดโุจู. ุงู ููุถูุน ุจูโูฺู ููุช ุงููุช ูพุฏุง ูโฺฉูุฏ ฺฉู ฺูุฏู <strong>Thread</strong> ุจู ุฏุงุฏูโ ูุดุชุฑฺฉ ุฏุณุชุฑุณ ุฏุงุฑูุฏุ ุฏุฑ ุงู ุดุฑุงุทุ ุฎู ุฑุงุญุช ูโุชูุงู ุฏฺุงุฑ ูุดฺฉู ุดุฏ.</p>
<p>ุณุงุฏูโุชุฑู ู ฺฉุงุฑุจุฑุฏโุชุฑู ุงุจุฒุงุฑูุง <strong>Synchronization</strong> ุงุญุชูุงูุงู ููุงู <strong>Continuations</strong> ู <strong>Task Combinators</strong> ูุณุชูุฏ ฺฉู ุฏุฑ ูุตู ฑด ุชูุถุญ ุฏุงุฏู. ุจุง ูุฑูููู ฺฉุฑุฏู ุจุฑูุงููโูุง ููุฒูุงู ุฏุฑ ูุงูุจ ุนููุงุช <strong>Asynchronous</strong> ฺฉู ุจุง <strong>Continuations</strong> ู <strong>Combinators</strong> ุจู ูู ูุชุตู ูโุดููุฏุ ูุงุฒ ุจู <strong>Locking</strong> ู <strong>Signaling</strong> ฺฉูุชุฑ ูโุดูุฏ. ุจุง ุงู ุญุงูุ ูููุฒ ููุงูุน ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุณุงุฒูโูุง ุณุทุญ ูพุงูโุชุฑ ูุงุฑุฏ ุนูู ูโุดููุฏ.</p>
<p>ุณุงุฒูโูุง <strong>Synchronization</strong> ุฑุง ูโุชูุงู ุจู ุณู ุฏุณุชู ุชูุณู ฺฉุฑุฏ:</p>
<ol>
<li>
<p>๐ <strong>Exclusive Locking</strong><br>
ุงู ุณุงุฒูโูุง ุงุฌุงุฒู ูโุฏููุฏ ููุท ฺฉ <strong>Thread</strong> ุฏุฑ ูุฑ ูุญุธู ูุนุงูุช ุฎุงุต ุงูุฌุงู ุฏูุฏ ุง ุจุฎุด ุงุฒ ฺฉุฏ ุฑุง ุงุฌุฑุง ฺฉูุฏ. ูุฏู ุงุตู ุขูโูุง ุงู ุงุณุช ฺฉู <strong>Threads</strong> ุจุชูุงููุฏ ุจู ูุถุนุช ูุดุชุฑฺฉ ุฏุฑ ุญุงู ููุดุชู ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดูุฏ ุจุฏูู ุงูโฺฉู ูุฒุงุญู ูู ุดููุฏ. ุณุงุฒูโูุง <strong>Exclusive Locking</strong> ุนุจุงุฑุชโุงูุฏ ุงุฒ:<br>
<strong>lock</strong>ุ <strong>Mutex</strong> ู <strong>SpinLock</strong>.</p>
</li>
<li>
<p>๐ <strong>Nonexclusive Locking</strong><br>
ุงู ููุน <strong>Locking</strong> ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ูุฒุงู <strong>Concurrency</strong> ุฑุง ูุญุฏูุฏ ฺฉูุฏ. ุณุงุฒูโูุง ุขู ุนุจุงุฑุชโุงูุฏ ุงุฒ:<br>
<strong>Semaphore(Slim)</strong> ู <strong>ReaderWriterLock(Slim)</strong>.</p>
</li>
<li>
<p>๐ข <strong>Signaling</strong><br>
ุงู ุณุงุฒูโูุง ุจู ฺฉ <strong>Thread</strong> ุงุฌุงุฒู ูโุฏููุฏ ุชุง ุฒูุงู ฺฉู ุงุฒ ฺฉ ุง ฺูุฏ <strong>Thread</strong> ุฏฺฏุฑ ุงุทูุงุน (Notification) ุฏุฑุงูุช ูฺฉุฑุฏูุ ุฏุฑ ุญุงูุช <strong>Block</strong> ุจุงู ุจูุงูุฏ. ุณุงุฒูโูุง <strong>Signaling</strong> ุดุงูู <strong>ManualResetEvent(Slim)</strong>ุ <strong>AutoResetEvent</strong>ุ <strong>CountdownEvent</strong> ู <strong>Barrier</strong> ูุณุชูุฏ. ุณู ููุฑุฏ ุงูู ูุนูููุงู ุจุง ุนููุงู <strong>Event Wait Handles</strong> ุดูุงุฎุชู ูโุดููุฏ.</p>
</li>
</ol>
<p>ููฺูู ุงูฺฉุงู (ู ุงูุจุชู ุฏุดูุงุฑ) ุงูุฌุงู ุจุฑุฎ ุนููุงุช ููุฒูุงู ุฑู ุฏุงุฏูโ ูุดุชุฑฺฉ ุจุฏูู ุงุณุชูุงุฏู ุงุฒ <strong>Locking</strong> ูุฌูุฏ ุฏุงุฑุฏุ ุจุง ฺฉูฺฉ ุณุงุฒูโูุง <strong>Nonblocking Synchronization</strong>. ุงู ุณุงุฒูโูุง ุนุจุงุฑุชโุงูุฏ ุงุฒ:<br>
<strong>Thread.MemoryBarrier</strong>ุ <strong>Thread.VolatileRead</strong>ุ <strong>Thread.VolatileWrite</strong>ุ ฺฉูุฏูุงฺูโ <strong>volatile</strong> ู ฺฉูุงุณ <strong>Interlocked</strong>.</p>
<p>ูุง ุงู ููุถูุน ุฑุง ุจู ููุฑุงู ูุชุฏูุง <strong>Monitor.Wait/Pulse</strong> ฺฉู ุจุฑุง ููุดุชู ููุทู ุณูุงุฑุด ุณฺฏูุงูโุฏู ฺฉุงุฑุจุฑุฏ ุฏุงุฑูุฏุ ุจูโุตูุฑุช ุขููุงู ูพูุดุด ุฏุงุฏูโุงู.</p>
<hr>
<h2>๐ Exclusive Locking (ูููโฺฏุฐุงุฑ ุงูุญุตุงุฑ)</h2>
<p>ุณู ุณุงุฒูโ ุงุตู ุจุฑุง <strong>Exclusive Locking</strong> ูุฌูุฏ ุฏุงุฑุฏ: ุฏุณุชูุฑ <strong>lock</strong>ุ <strong>Mutex</strong> ู <strong>SpinLock</strong>.</p>
<ul>
<li>ุฏุณุชูุฑ <strong>lock</strong> ุฑุงุญุชโุชุฑู ู ูพุฑฺฉุงุฑุจุฑุฏุชุฑู ฺฏุฒูู ุงุณุช.</li>
<li><strong>Mutex</strong> ุฒูุงู ุงุณุชูุงุฏู ูโุดูุฏ ฺฉู ุจุฎูุงูุฏ ููู ุฑุง ุจู ฺูุฏู <strong>Process</strong> ฺฏุณุชุฑุด ุฏูุฏ (ูููโูุง ุณุทุญ ฺฉุงููพูุชุฑ).</li>
<li><strong>SpinLock</strong> ฺฉ <strong>Micro-Optimization</strong> ุงุณุช ฺฉู ูโุชูุงูุฏ ุฏุฑ ุณูุงุฑููุง ุจุง <strong>Concurrency</strong> ุจุงูุง ุจุงุนุซ ฺฉุงูุด <strong>Context Switches</strong> ุดูุฏ. ๐</li>
</ul>
<h3>๐ The <code>lock</code> Statement (ุฏุณุชูุฑ lock)</h3>
<p>ุจุฑุง ูุดุงู ุฏุงุฏู ูุงุฒ ุจู <strong>Locking</strong>ุ ฺฉูุงุณ ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadUnsafe</span>
{
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _val1 = <span class="hljs-number">1</span>, _val2 = <span class="hljs-number">1</span>;
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
  {
    <span class="hljs-keyword">if</span> (_val2 != <span class="hljs-number">0</span>) Console.WriteLine (_val1 / _val2);
    _val2 = <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>ุงู ฺฉูุงุณ <strong>Thread-Safe</strong> ูุณุช: ุงฺฏุฑ ูุชุฏ <code>Go</code> ุจูโุทูุฑ ููุฒูุงู ุชูุณุท ุฏู <strong>Thread</strong> ูุฑุงุฎูุงู ุดูุฏุ ุงูฺฉุงู ุฑุฎ ุฏุงุฏู ุฎุทุง <strong>Division by Zero</strong> ูุฌูุฏ ุฏุงุฑุฏ. ฺุฑุงุ ฺูู ููฺฉู ุงุณุช ุฏุฑ ููุงู ูุญุธูโุง ฺฉู ฺฉ <strong>Thread</strong> ุจู ุงุฌุฑุง ุฏุณุชูุฑ <code>if</code> ู <code>Console.WriteLine</code> ุงุณุชุ <strong>Thread</strong> ุฏฺฏุฑ ููุฏุงุฑ <code>_val2</code> ุฑุง ุจุฑุงุจุฑ ุตูุฑ ูุฑุงุฑ ุฏูุฏ.</p>
<p>ุงูุฌุงุณุช ฺฉู ุฏุณุชูุฑ <strong>lock</strong> ูุดฺฉู ุฑุง ุญู ูโฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadSafe</span>
{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _locker = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _val1 = <span class="hljs-number">1</span>, _val2 = <span class="hljs-number">1</span>;
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
  {
    <span class="hljs-keyword">lock</span> (_locker)
    {
      <span class="hljs-keyword">if</span> (_val2 != <span class="hljs-number">0</span>) Console.WriteLine (_val1 / _val2);
      _val2 = <span class="hljs-number">0</span>;
    }
  }
}
</code></pre>
<p>ููุท ฺฉ <strong>Thread</strong> ุฏุฑ ูุฑ ูุญุธู ูโุชูุงูุฏ ุดุก ููฺฏุงูโุณุงุฒ (ุฏุฑ ุงูุฌุง <code>_locker</code>) ุฑุง ููู ฺฉูุฏ. ูุฑ <strong>Thread</strong> ุฏฺฏุฑ ฺฉู ุจุฑุง ููู ุฑูุงุจุช ฺฉูุฏุ <strong>Blocked</strong> ูโุดูุฏ ุชุง ุฒูุงู ฺฉู ููู ุขุฒุงุฏ ุดูุฏ.</p>
<p>ุงฺฏุฑ ุจุด ุงุฒ ฺฉ <strong>Thread</strong> ุจุฑุง ููู ุฑูุงุจุช ฺฉูุฏุ ุขูโูุง ุฏุฑ ฺฉ <strong>Ready Queue</strong> ูุฑุงุฑ ูโฺฏุฑูุฏ ู ุจู ุชุฑุชุจ ูุฑูุฏุ ููู ุจู ุขูโูุง ุฏุงุฏู ูโุดูุฏ (ุงูุจุชู โ๏ธ ุฏุฑ ุจุนุถ ุดุฑุงุท ุณุณุชูโุนุงูู <strong>Windows</strong> ู <strong>CLR</strong> ููฺฉู ุงุณุช ุงู ุนุฏุงูุช ููุถ ุดูุฏ).</p>
<p>ุจู ููู ุฏููุ ูููโูุง ุงูุญุตุงุฑ ุฑุง ฺฏุงู ุงููุงุช ุทูุฑ ุชูุตู ูโฺฉููุฏ ฺฉู <strong>ุฏุณุชุฑุณ ุณุฑุงู</strong> ุฑุง ุจู ฺุฒ ฺฉู ุชูุณุท ููู ูุญุงูุธุช ูโุดูุฏุ ุงุนูุงู ูโฺฉููุฏุ ุฒุฑุง ุฏุณุชุฑุณ ฺฉ <strong>Thread</strong> ููโุชูุงูุฏ ุจุง ุฏฺฏุฑ ูููพูุดุงู ุฏุงุดุชู ุจุงุดุฏ. ุฏุฑ ุงู ูุซุงูุ ูุง ูู ููุทู ุฏุงุฎู ูุชุฏ <code>Go</code> ู ูู ููุฏูุง <code>_val1</code> ู <code>_val2</code> ุฑุง ูุญุงูุธุช ฺฉุฑุฏูโุงู.</p>
<hr>
<h3>โ๏ธ Monitor.Enter ู Monitor.Exit</h3>
<p>ุฏุณุชูุฑ <code>lock</code> ุฏุฑ C# ุฏุฑ ุญููุช ฺฉ <strong>ูุงูโุจุฑ ูุญู (Syntactic Shortcut)</strong> ุจุฑุง ูุฑุงุฎูุงู ูุชุฏูุง <code>Monitor.Enter</code> ู <code>Monitor.Exit</code> ุจู ููุฑุงู ฺฉ ุจููฺฉ <code>try/finally</code> ุงุณุช.</p>
<p>ุจูโุทูุฑ ุณุงุฏูุ ฺฉุฏ ฺฉู ุฏุฑ ูุชุฏ <code>Go</code> ุงุชูุงู ูโุงูุชุฏุ ูุนุงุฏู ุฒุฑ ุงุณุช:</p>
<pre class="hljs"><code>Monitor.Enter (_locker);
<span class="hljs-keyword">try</span>
{
  <span class="hljs-keyword">if</span> (_val2 != <span class="hljs-number">0</span>) Console.WriteLine (_val1 / _val2);
  _val2 = <span class="hljs-number">0</span>;
}
<span class="hljs-keyword">finally</span> { Monitor.Exit (_locker); }
</code></pre>
<p>โ๏ธ ุงฺฏุฑ ูุชุฏ <code>Monitor.Exit</code> ุจุฏูู ุงูโฺฉู ูุจูุงู <code>Monitor.Enter</code> ุฑู ููุงู ุดุก ุตุฏุง ุฒุฏู ุดุฏู ุจุงุดุฏุ ูุฑุงุฎูุงู ุดูุฏุ ฺฉ <strong>Exception</strong> ูพุฑุชุงุจ ูโุดูุฏ.</p>
<hr>
<h3>๐ก overloadูุง lockTaken</h3>
<p>ฺฉุฏ ฺฉู ุฏุฑ ุจุงูุง ุฏุฏู ฺฉ ุขุณุจโูพุฐุฑ ุธุฑู ุฏุงุฑุฏ. ูุฑุถ ฺฉูุฏ (ูุฑฺูุฏ ุจุนุฏ) ฺฉ <strong>Exception</strong> ุจู ูุฑุงุฎูุงู <code>Monitor.Enter</code> ู ุดุฑูุน ุจููฺฉ <code>try</code> ุฑุฎ ุฏูุฏ (ูุซูุงู ฺฉ <strong>OutOfMemoryException</strong> ุง ุฏุฑ <strong>.NET Framework</strong> ุงฺฏุฑ <strong>Thread</strong> ูุชููู ุดูุฏ).</p>
<p>ุฏุฑ ุงู ุดุฑุงุท:</p>
<ul>
<li>ุงฺฏุฑ ููู ฺฏุฑูุชู ูุดุฏู ุจุงุดุฏุ ุฎุทุฑ ูุฌูุฏ ูุฏุงุฑุฏ.</li>
<li>ุงูุง ุงฺฏุฑ ููู ฺฏุฑูุชู ุดุฏู ุจุงุดุฏุ ฺูู ูฺโููุช ูุงุฑุฏ ุจููฺฉ <code>try/finally</code> ููโุดููุ ููู ุขุฒุงุฏ ูุฎูุงูุฏ ุดุฏ. ุงู ุนู <strong>Leak ุดุฏู ููู</strong>.</li>
</ul>
<p>ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ูุดฺฉูุ ูุชุฏ ุฒุฑ ุฏุฑ <strong>Monitor.Enter</strong> ุชุนุฑู ุดุฏู ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Enter</span> (<span class="hljs-params"><span class="hljs-built_in">object</span> obj, <span class="hljs-keyword">ref</span> <span class="hljs-built_in">bool</span> lockTaken</span>)</span>;
</code></pre>
<p>๐ ุงฺฏุฑ ู ููุท ุงฺฏุฑ ูุชุฏ <code>Enter</code> ฺฉ <strong>Exception</strong> ูพุฑุชุงุจ ฺฉูุฏ ู ููู ฺฏุฑูุชู ูุดุฏู ุจุงุดุฏุ ููุฏุงุฑ <code>lockTaken</code> ุจุฑุงุจุฑ <strong>false</strong> ุฎูุงูุฏ ุจูุฏ.</p>
<p>ุงูฺฏู ุฏุฑุณุช ุงุณุชูุงุฏู ุงุฒ ุขู (ู ููุงู ฺุฒ ฺฉู ฺฉุงููพุงูุฑ C# ุฏุฑ ูพุดุชโุตุญูู ุจุฑุง ุฏุณุชูุฑ <code>lock</code> ุชููุฏ ูโฺฉูุฏ) ุจู ุดฺฉู ุฒุฑ ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-built_in">bool</span> lockTaken = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">try</span>
{
  Monitor.Enter (_locker, <span class="hljs-keyword">ref</span> lockTaken);
  <span class="hljs-comment">// Do your stuff...</span>
}
<span class="hljs-keyword">finally</span> { <span class="hljs-keyword">if</span> (lockTaken) Monitor.Exit (_locker); }
</code></pre>
<hr>
<h3>โฑ TryEnter</h3>
<p>ฺฉูุงุณ <strong>Monitor</strong> ููฺูู ูุชุฏ ุจู ูุงู <strong>TryEnter</strong> ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ฺฉ <strong>Timeout</strong> ูุดุฎุต ฺฉูุฏ (ุจุฑ ุญุณุจ <strong>Milliseconds</strong> ุง ฺฉ <strong>TimeSpan</strong>).</p>
<ul>
<li>ุงฺฏุฑ ููู ฺฏุฑูุชู ุดูุฏุ ููุฏุงุฑ <strong>true</strong> ุจุฑูโฺฏุฑุฏุงูุฏ.</li>
<li>ุงฺฏุฑ ููู ุจูโุฏูู <strong>Timeout</strong> ฺฏุฑูุชู ูุดูุฏุ ููุฏุงุฑ <strong>false</strong> ุจุฑูโฺฏุฑุฏุงูุฏ.</li>
</ul>
<p>ุนูุงูู ุจุฑ ุงูุ ูุชุฏ <strong>TryEnter</strong> ูโุชูุงูุฏ ุจุฏูู ูฺ ุขุฑฺฏููุงู ูุฑุงุฎูุงู ุดูุฏ. ุฏุฑ ุงู ุญุงูุชุ ููุท <strong>ููู ุฑุง ุชุณุช ูโฺฉูุฏ</strong> ู ุงฺฏุฑ ุจูุงูุงุตูู ูุชูุงูุฏ ููู ุฑุง ุจฺฏุฑุฏุ ุจุฏูู ูุนุทู <strong>false</strong> ุจุฑูโฺฏุฑุฏุงูุฏ.</p>
<p>๐ ุฏุฑุณุช ูุซู ูุชุฏ <code>Enter</code>ุ ูุชุฏ <strong>TryEnter</strong> ูู ฺฉ ูุณุฎูโ overload ุฏุงุฑุฏ ฺฉู ุงุฒ ุขุฑฺฏููุงู <strong>lockTaken</strong> ูพุดุชุจุงู ูโฺฉูุฏ.</p>
<h3>๐ Choosing the Synchronization Object (ุงูุชุฎุงุจ ุดุก ููฺฏุงูโุณุงุฒ)</h3>
<p>ุดูุง ูโุชูุงูุฏ ุงุฒ ูุฑ ุดุฆ ฺฉู ุจุฑุง <strong>Thread</strong>โูุง ุดุฑฺฉุชโฺฉููุฏู ูุงุจู ูุดุงูุฏู ุจุงุดุฏุ ุจูโุนููุงู ุดุก ููฺฏุงูโุณุงุฒ ุงุณุชูุงุฏู ฺฉูุฏุ ุจุง ุงู ุดุฑุท ููู ฺฉู ุขู ุดุก ุจุงุฏ ฺฉ <strong>Reference Type</strong> ุจุงุดุฏ.</p>
<p>ุดุก ููฺฏุงูโุณุงุฒ ูุนูููุงู <strong>private</strong> ุงุณุช (ฺูู ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ููุทู ูููโฺฏุฐุงุฑ ุจูุชุฑ <strong>Encapsulate</strong> ุดูุฏ) ู ูุนูููุงู ฺฉ <strong>Instance Field</strong> ุง ฺฉ <strong>Static Field</strong> ุงุณุช.</p>
<p>ฺฏุงู ุงููุงุช ุดุก ููฺฏุงูโุณุงุฒ ููุงู ุดุก ูุญุงูุธุชโุดุฏู ุงุณุช. ูุงููุฏ ููุฏ <code>_list</code> ุฏุฑ ูุซุงู ุฒุฑ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadSafe</span>
{
  List&lt;<span class="hljs-built_in">string</span>&gt; _list = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>()</span>
  {
    <span class="hljs-keyword">lock</span> (_list)
    {
      _list.Add(<span class="hljs-string">&quot;Item 1&quot;</span>);
      ...
    }
  }
}
</code></pre>
<p>ุงูุจุชู ุฏุงุดุชู ฺฉ ููุฏ ุงุฎุชุตุงุต ุจุฑุง ูููโฺฏุฐุงุฑ (ูุซู <code>_locker</code> ุฏุฑ ูุซุงู ูุจู) ฺฉูุชุฑู ุฏููโุชุฑ ุฑู <strong>Scope</strong> ู <strong>Granularity</strong> ููู ูุฑุงูู ูโฺฉูุฏ.</p>
<p>ููฺูู ูโุชูุงูุฏ ุงุฒ ุดุก ุญุงู (ุนู <code>this</code>) ุจูโุนููุงู ุดุก ููฺฏุงูโุณุงุฒ ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">lock</span> (<span class="hljs-keyword">this</span>) { ... }
</code></pre>
<p>ุง ุญุช ุงุฒ ููุน ฺฉูุงุณ ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">lock</span> (<span class="hljs-keyword">typeof</span>(Widget)) { ... }   <span class="hljs-comment">// ุจุฑุง ูุญุงูุธุช ุงุฒ ููุฏูุง static</span>
</code></pre>
<p>โ ุนุจ ุงู ุฑูุดโูุง ุงู ุงุณุช ฺฉู ููุทู ูููโฺฏุฐุงุฑ <strong>Encapsulate</strong> ููโุดูุฏ ู ููู ูโุชูุงูุฏ ูุฏุฑุช <strong>Deadlock</strong> ู <strong>Blocking</strong> ุจุด ุงุฒ ุญุฏ ุฑุง ุณุฎุชโุชุฑ ฺฉูุฏ.</p>
<p>ุดูุง ุญุช ูโุชูุงูุฏ ุฑู ูุชุบุฑูุง ูุญู ฺฉู ุชูุณุท <strong>Lambda Expressions</strong> ุง <strong>Anonymous Methods</strong> ฺฏุฑูุชู ุดุฏูโุงูุฏ ูุฒ ููู ุจฺฏุฐุงุฑุฏ.</p>
<hr>
<h3>โฐ When to Lock (ฺู ุฒูุงู ุจุงุฏ ููู ฺฉูู)</h3>
<p>ููู ฺฉุฑุฏู ุฏุณุชุฑุณ ุจู ุฎูุฏ ุดุก ููฺฏุงูโุณุงุฒ ุฑุง ูุญุฏูุฏ ููโฺฉูุฏ. ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุงฺฏุฑ ูุชุฏ ูุซู <code>x.ToString()</code> ูุฑุงุฎูุงู ุดูุฏุ <strong>Blocked</strong> ูุฎูุงูุฏ ุดุฏ ููุท ุจู ุงู ุฏูู ฺฉู ฺฉ <strong>Thread</strong> ุฏฺฏุฑ ุฑู <code>lock(x)</code> ููู ฺฉุฑุฏู ุงุณุช.<br>
ููุท ุฒูุงู <strong>Blocking</strong> ุงุชูุงู ูโุงูุชุฏ ฺฉู ูุฑ ุฏู <strong>Thread</strong> ุงุฒ <code>lock(x)</code> ุงุณุชูุงุฏู ฺฉููุฏ.</p>
<p>ูุงุนุฏูโ ูพุงูโุง ุงู ุงุณุช:<br>
๐ ุดูุง ุจุงุฏ ููุดู ููฺฏุงู ุฏุณุชุฑุณ ุจู ูุฑ <strong>Shared Writable Field</strong> ุงุฒ ููู ุงุณุชูุงุฏู ฺฉูุฏ.</p>
<p>ุญุช ุฏุฑ ุณุงุฏูโุชุฑู ุญุงูุชโูุซูุงู ฺฉ ุนูู <strong>Assignment</strong> ุฑู ฺฉ ููุฏโุจุงุฏ <strong>Synchronization</strong> ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ.</p>
<p>ุจู ูุซุงู ุฒุฑ ุชูุฌู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadUnsafe</span>
{
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _x;
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Increment</span>()</span> { _x++; }
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Assign</span>()</span>    { _x = <span class="hljs-number">123</span>; }
}
</code></pre>
<p>ุงู ฺฉูุงุณ <strong>Thread-Safe</strong> ูุณุช. ูุณุฎูโ ุงููโุชุฑ ุขู ุจู ุดฺฉู ุฒุฑ ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _locker = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
<span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _x;

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Increment</span>()</span> { <span class="hljs-keyword">lock</span> (_locker) _x++; }
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Assign</span>()</span>    { <span class="hljs-keyword">lock</span> (_locker) _x = <span class="hljs-number">123</span>; }
</code></pre>
<hr>
<h3>โ๏ธ ูุดฺฉูุงุช ุจุฏูู Lock</h3>
<p>ุงฺฏุฑ ููู ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏุ ุฏู ูุดฺฉู ุฑุฎ ูโุฏูุฏ:</p>
<ol>
<li>โ ุนููุงุชโูุง ูุซู ุงูุฒุงุด ููุฏุงุฑ ฺฉ ูุชุบุฑ (ุง ุญุช ุฎูุงูุฏู/ููุดุชู ุขู ุฏุฑ ุดุฑุงุท ุฎุงุต) <strong>Atomic</strong> ูุณุชูุฏ.</li>
<li>โก <strong>Compiler</strong>ุ <strong>CLR</strong> ู <strong>Processor</strong> ูุฌุงุฒ ูุณุชูุฏ ุจุฑุง ุจูุจูุฏ ฺฉุงุฑุงุ ุฏุณุชูุฑุงุช ุฑุง <strong>Reorder</strong> ฺฉููุฏ ุง ูุชุบุฑูุง ุฑุง ุฏุฑ <strong>CPU Registers</strong> ฺฉุด ฺฉููุฏโุชุง ุฒูุงู ฺฉู ุงู ุจูููโุณุงุฒโูุง ุฑูุชุงุฑ ฺฉ ุจุฑูุงููโ ุชฺฉโุฑุณูุงู (ุง ฺูุฏุฑุณูุงู ฺฉู ุงุฒ ููู ุงุณุชูุงุฏู ูโฺฉูุฏ) ุฑุง ุชุบุฑ ูุฏูุฏ.</li>
</ol>
<p>ูููโูุง ูุดฺฉู ุฏูู ุฑุง ุจุง ุงุฌุงุฏ ฺฉ <strong>Memory Barrier</strong> ูุจู ู ุจุนุฏ ุงุฒ ููู ฺฉุงูุด ูโุฏููุฏ.</p>
<p>๐งฑ <strong>Memory Barrier</strong> ูุงููุฏ ฺฉ ุญุตุงุฑ ุงุณุช ฺฉู ูุงูุน ุนุจูุฑ ุงุซุฑุงุช <strong>Reordering</strong> ู <strong>Caching</strong> ูโุดูุฏ.</p>
<p>ุงู ูุงุนุฏู ููุท ูุฎุตูุต ูููโูุง ูุณุชุ ุจูฺฉู ุจุฑุง ูููโ ุณุงุฒูโูุง <strong>Synchronization</strong> ุตุฏู ูโฺฉูุฏ.</p>
<p>ูุซุงู: ุงฺฏุฑ ฺฉ ุณุงุฒูโ ุณฺฏูุงูโุฏู ุชุถูู ฺฉูุฏ ฺฉู ููุท ฺฉ <strong>Thread</strong> ุฏุฑ ูุฑ ูุญุธู ูุชุบุฑ ุฑุง ุจุฎูุงูุฏ/ุจููุณุฏุ ุฏฺฏุฑ ูุงุฒ ุจู ููู ูุฏุงุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> signal = <span class="hljs-keyword">new</span> ManualResetEvent(<span class="hljs-literal">false</span>);
<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>;
<span class="hljs-keyword">new</span> Thread(() =&gt; { x++; signal.Set(); }).Start();
signal.WaitOne();
Console.WriteLine(x);   <span class="hljs-comment">// ููุดู 1</span>
</code></pre>
<p>ุฏุฑ ุจุฎุด ยซ<strong>Nonblocking Synchronization</strong>ยป ุชูุถุญ ุฏุงุฏูโุงู ฺฉู ฺุฑุง ฺูู ูุงุฒ ูพุด ูโุขุฏ ู ฺฺฏููู <strong>Memory Barriers</strong> ู ฺฉูุงุณ <strong>Interlocked</strong> ูโุชูุงููุฏ ุฌุงฺฏุฒู ููู ุฏุฑ ุงู ุณูุงุฑููุง ุจุงุดูุฏ.</p>
<hr>
<h3>๐ Locking and Atomicity (ูููโฺฏุฐุงุฑ ู ุงุชูฺฉ ุจูุฏู)</h3>
<p>ุงฺฏุฑ ฺฏุฑูู ุงุฒ ูุชุบุฑูุง ููุดู ุฏุฑูู ฺฉ ููู ุฎูุงูุฏู ุง ููุดุชู ุดููุฏุ ูโุชูุงู ฺฏูุช ุงู ูุชุบุฑูุง ุจู ุดฺฉู <strong>Atomic</strong> ุฏุณุชุฑุณ ุฏุงุฑูุฏ.</p>
<p>ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-keyword">lock</span> (locker) { <span class="hljs-keyword">if</span> (x != <span class="hljs-number">0</span>) y /= x; }
</code></pre>
<p>ุฏุฑ ุงู ุญุงูุชุ ูุชุบุฑูุง <code>x</code> ู <code>y</code> ุจูโุตูุฑุช <strong>Atomic</strong> ุฏุณุชุฑุณ ุฏุงุฏู ูโุดููุฏุ ุนู ูฺ <strong>Thread</strong> ุฏฺฏุฑ ููโุชูุงูุฏ ุฏุฑ ูุงููโ ุงู ุนููุงุช ุขูโูุง ุฑุง ุชุบุฑ ุฏูุฏ ู ูุชุฌู ุฑุง ุจโุงุนุชุจุงุฑ ฺฉูุฏ. ุจูุงุจุฑุงูุ ุดูุง ูุฑฺฏุฒ ุฎุทุง <strong>Division by Zero</strong> ุฏุฑุงูุช ููโฺฉูุฏุ ูุดุฑูุท ุจุฑ ุงูโฺฉู <code>x</code> ู <code>y</code> ููุดู ุฏุฑ ููู ููู ุงูุญุตุงุฑ ุฏุณุชุฑุณ ุฏุงุฏู ุดููุฏ.</p>
<hr>
<h3>๐จ ุงุณุชุซูุงูุง ู Atomicity</h3>
<p>ุงุชูฺฉ ุจูุฏู ููู ููุถ ูโุดูุฏ ุงฺฏุฑ ุฏุงุฎู ุจููฺฉ ููู ฺฉ <strong>Exception</strong> ุฑุฎ ุฏูุฏ (ฺู ุจุฑูุงูู ฺูุฏุฑุณูุงู ุจุงุดุฏ ฺู ูุจุงุดุฏ).</p>
<p>ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-built_in">decimal</span> _savingsBalance, _checkBalance;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Transfer</span>(<span class="hljs-params"><span class="hljs-built_in">decimal</span> amount</span>)</span>
{
  <span class="hljs-keyword">lock</span> (_locker)
  {
    _savingsBalance += amount;
    _checkBalance -= amount + GetBankFee();
  }
}
</code></pre>
<p>ุงฺฏุฑ ูุชุฏ <code>GetBankFee()</code> ฺฉ <strong>Exception</strong> ูพุฑุชุงุจ ฺฉูุฏุ ุจุงูฺฉ ูพูู ุงุฒ ุฏุณุช ูโุฏูุฏ! ๐ฆ๐ธ</p>
<p>ุฏุฑ ุงู ุดุฑุงุท ูโุชูุงู ูุดฺฉู ุฑุง ุจุง ูุฑุงุฎูุงู <code>GetBankFee</code> ูพุด ุงุฒ ูุฑูุฏ ุจู ุจููฺฉ ููู ุจุฑุทุฑู ฺฉุฑุฏ.</p>
<p>๐ ุจุฑุง ููุงุฑุฏ ูพฺุฏูโุชุฑุ ฺฉ ุฑุงูโุญู ุงู ุงุณุช ฺฉู ููุทู <strong>Rollback</strong> ุฑุง ุฏุงุฎู ฺฉ ุจููฺฉ <code>catch</code> ุง <code>finally</code> ูพุงุฏูโุณุงุฒ ฺฉูู.</p>
<hr>
<h3>โก Instruction Atomicity</h3>
<p>ููููู <strong>Instruction Atomicity</strong> ูุชูุงูุช ุงูุง ูุดุงุจู ุงุณุช: ฺฉ ุฏุณุชูุฑ <strong>Atomic</strong> ุงุณุช ุงฺฏุฑ ุฑู ูพุฑุฏุงุฒูุฏูโ ุฒุฑู ุจูโุทูุฑ ุบุฑูุงุจู ุชูุณู ุงุฌุฑุง ุดูุฏ.</p>
<h3>๐ ูููโูุง ุชู ุฏุฑ ุชู (Nested Locking)</h3>
<p>ฺฉ <strong>Thread</strong> ูโุชูุงูุฏ ุจุงุฑูุง ฺฉ ุดุก ุฑุง ุจูโุตูุฑุช ุชู ุฏุฑ ุชู (ุง <strong>Reentrant</strong>) ููู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">lock</span> (locker)
  <span class="hljs-keyword">lock</span> (locker)
    <span class="hljs-keyword">lock</span> (locker)
    {
       <span class="hljs-comment">// Do something...</span>
    }
</code></pre>
<p>ุง ุจู ุฑูุด ุฏฺฏุฑ:</p>
<pre class="hljs"><code>Monitor.Enter (locker); 
Monitor.Enter (locker);  
Monitor.Enter (locker); 

<span class="hljs-comment">// Do something...</span>

Monitor.Exit (locker);  
Monitor.Exit (locker);   
Monitor.Exit (locker);
</code></pre>
<p>ุฏุฑ ุงู ุญุงูุชโูุงุ ุดุก ุชููุง ุฒูุงู <strong>ุขุฒุงุฏ (unlock)</strong> ูโุดูุฏ ฺฉู ุง ุฎุงุฑุฌโุชุฑู ุฏุณุชูุฑ <code>lock</code> ูพุงุงู ุงูุชู ุจุงุดุฏุ ุง ุชุนุฏุงุฏ ูุชูุงุธุฑ ุงุฒ <code>Monitor.Exit</code> ุงุฌุฑุง ุดุฏู ุจุงุดุฏ.</p>
<p>๐ <strong>ููู ุชู ุฏุฑ ุชู</strong> ุฒูุงู ููุฏ ุงุณุช ฺฉู ฺฉ ูุชุฏ ุงุฒ ุฏุงุฎู ฺฉ ูููุ ูุชุฏ ุฏฺฏุฑ ุฑุง ุตุฏุง ุจุฒูุฏ:</p>
<pre class="hljs"><code><span class="hljs-built_in">object</span> locker = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();

<span class="hljs-keyword">lock</span> (locker)
{
    AnotherMethod();
    <span class="hljs-comment">// ูููุฒ ููู ุฏุงุฑู - ฺูู ูููโูุง Reentrant ูุณุชูุฏ</span>
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">AnotherMethod</span>()</span>
{
    <span class="hljs-keyword">lock</span> (locker) { Console.WriteLine (<span class="hljs-string">&quot;Another method&quot;</span>); }
}
</code></pre>
<p>โ ุฏุฑ ุงูุฌุง Thread ุชููุง ุฑู ุงููู (ุฎุงุฑุฌโุชุฑู) ููู ูุณุฏูุฏ ูโุดูุฏ.</p>
<hr>
<h3>โ๏ธ ุจูโุจุณุชโูุง (Deadlocks)</h3>
<p><strong>Deadlock</strong> ุฒูุงู ุงุชูุงู ูโุงูุชุฏ ฺฉู ุฏู Thread ูุฑฺฉุฏุงู ููุชุธุฑ ฺฉ ููุจุน ุจุงุดูุฏ ฺฉู ุชูุณุท ุฏฺฏุฑ ููู ุดุฏู ุงุณุชุ ุฏุฑ ูุชุฌู ูฺโฺฉุฏุงู ูุงุฏุฑ ุจู ุงุฏุงูู ฺฉุงุฑ ูุฎูุงููุฏ ุจูุฏ.</p>
<p>ูุซุงู ุณุงุฏู ุจุง ุฏู ููู:</p>
<pre class="hljs"><code><span class="hljs-built_in">object</span> locker1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
<span class="hljs-built_in">object</span> locker2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();

<span class="hljs-keyword">new</span> Thread (() =&gt; {
    <span class="hljs-keyword">lock</span> (locker1)
    {
        Thread.Sleep (<span class="hljs-number">1000</span>);
        <span class="hljs-keyword">lock</span> (locker2);   <span class="hljs-comment">// Deadlock</span>
    }
}).Start();

<span class="hljs-keyword">lock</span> (locker2)
{
    Thread.Sleep (<span class="hljs-number">1000</span>);
    <span class="hljs-keyword">lock</span> (locker1);       <span class="hljs-comment">// Deadlock</span>
}
</code></pre>
<p>๐ ุฏุฑ ุงู ุญุงูุชุ ูุฑ Thread ฺฉ ุงุฒ ูููโูุง ุฑุง ฺฏุฑูุชู ู ููุชุธุฑ ุฏฺฏุฑ ุงุณุช โ <strong>ุจูโุจุณุช ุฏุงุฆู</strong>.</p>
<ul>
<li>ุฏุฑ ูุญุท ุนุงุฏ CLRุ ุจุฑ ุฎูุงู SQL Serverุ <strong>ุจูโุจุณุชโูุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุชุดุฎุต ู ุฑูุน ููโุดููุฏ</strong>.</li>
<li>ุงฺฏุฑ ุจูโุจุณุช ุฑุฎ ุฏูุฏุ Threadูุง ุจูโุทูุฑ ูุงูุญุฏูุฏ ูุณุฏูุฏ ูโุดููุฏ (ูฺฏุฑ ุงูโฺฉู ุฒูุงูโุงูุชุธุงุฑ ุง Timeout ุชุนุฑู ฺฉุฑุฏู ุจุงุดุฏ).</li>
<li>ุฏุฑ ูุงุณุช SQL CLR (ุงุฏุบุงู SQL Server ุจุง CLR)ุ ุจูโุจุณุชโูุง ุดูุงุณุง ูโุดููุฏ ู ฺฉ ุงุณุชุซูุง ูุงุจูโูุฏุฑุช ุฑู ฺฉ ุงุฒ Threadูุง ูพุฑุชุงุจ ูโุดูุฏ.</li>
</ul>
<hr>
<h3>๐ ฺุฑุง Deadlock ุณุฎุช ุงุณุชุ</h3>
<ul>
<li>ููฺฏุงู ุทุฑุงุญ ุดโุกฺฏุฑุงุ ููฺฉู ุงุณุช ูููโูุง ุฏุฑ ุฒูุฌุฑูโุง ุงุฒ ูุชุฏูุง ุชู ุฏุฑ ุชู ฺฏุฑูุชู ุดููุฏ ฺฉู ุชุฑุชุจ ุขูโูุง ุฏุฑ ุฒูุงู ุงุฌุฑุง ูุดุฎุต ูโุดูุฏ.</li>
<li>ููฺฉู ุงุณุช ุดูุง ุฑู ููุฏ <code>a</code> ุฏุฑ ฺฉูุงุณ <code>x</code> ููู ุจุฒูุฏุ ุฏุฑ ุญุงู ฺฉู ูุฑุงุฎูุงููุฏูโ ุดูุง ูุจูุงู ุฑู ููุฏ <code>b</code> ุฏุฑ ฺฉูุงุณ <code>y</code> ููู ุฒุฏู ุจุงุดุฏ. ููโุฒูุงู Thread ุฏฺฏุฑ ุจุฑุนฺฉุณ ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏูุฏ โ Deadlock.</li>
<li>ุงูฺฏููุง ุฎูุจ ุทุฑุงุญ ุดโุกฺฏุฑุง (OOP) ุงู ูุดฺฉู ุฑุง ุชุดุฏุฏ ูโฺฉููุฏ ฺูู ูุฑุงุฎูุงูโูุง ุฏุฑ ุฒูุงู ุงุฌุฑุง ุชุนู ูโุดููุฏ.</li>
</ul>
<hr>
<h3>โ ุฑุงูฺฉุงุฑูุง ุจุฑุง ฺฉุงูุด Deadlock</h3>
<ol>
<li>
<p><strong>ูููโูุง ุฑุง ุจู ุชุฑุชุจ ุซุงุจุช ุจฺฏุฑุฏ</strong> (ุฑูุด ฺฉูุงุณฺฉุ ูู ููุดู ุนูู ูุณุช).</p>
</li>
<li>
<p>ููฺฏุงู ููู ฺฉุฑุฏู ุงุทุฑุงู ูุฑุงุฎูุงู ูุชุฏูุง ุฏฺฏุฑ ุงุญุชุงุท ฺฉูุฏ.</p>
</li>
<li>
<p>ุจุฑุฑุณ ฺฉูุฏ ุขุง ูุงูุนุงู ูุงุฒู ุงุณุช ููฺฏุงู ูุฑุงุฎูุงู ูุชุฏูุง ุฏฺฏุฑ ููู ุจฺฏุฑุฏ ุง ุฎุฑ.</p>
</li>
<li>
<p>ุงุณุชูุงุฏู ุจุดุชุฑ ุงุฒ <strong>ุณูฺฉุฑููโุณุงุฒ ุณุทุญ ุจุงูุงุชุฑ</strong> ูุซู:</p>
<ul>
<li>Task continuations/combinators</li>
<li>Data parallelism</li>
<li>Immutable types</li>
</ul>
</li>
</ol>
<p>๐ก ูฺฉุชู: ุฒูุงู ฺฉู ุฏุฑ ุญู ุฏุงุดุชู ฺฉ ูููุ ฺฉุฏ ุจุฑูู ุฑุง ุตุฏุง ูโุฒูุฏุ <strong>ฺฉูพุณูููโุณุงุฒ ููู ูุดุช ูโฺฉูุฏ</strong>. ุงู ฺฉ ูุญุฏูุฏุช ุฐุงุช ูฺฉุงูุฒู ูููโฺฏุฐุงุฑ ุงุณุชุ ูู ฺฉ ุถุนู CLR.</p>
<hr>
<h3>โก๏ธ ุณูุงุฑู ุฎุงุต Deadlock ุฏุฑ UI</h3>
<ul>
<li>ุฏุฑ ุงูพูฺฉุดูโูุง WPF: <code>Dispatcher.Invoke</code></li>
<li>ุฏุฑ Windows Forms: <code>Control.Invoke</code></li>
</ul>
<p>ุงฺฏุฑ ุงูโูุง ุฑุง ููฺฏุงู ุฏุงุดุชู ฺฉ ููู ุตุฏุง ุจุฒูุฏ ู Thread UI ููุชุธุฑ ููุงู ููู ุจุงุดุฏ โ Deadlock.</p>
<p>ุฑุงูโุญูโูุง:</p>
<ul>
<li>ุงุณุชูุงุฏู ุงุฒ <code>BeginInvoke</code> ุจูโุฌุง <code>Invoke</code>.</li>
<li>ุง ุขุฒุงุฏ ฺฉุฑุฏู ููู ูุจู ุงุฒ ุตุฏุง ุฒุฏู <code>Invoke</code> (ุงูุจุชู ุงฺฏุฑ ููู ุชูุณุท Caller ฺฏุฑูุชู ุดุฏู ุจุงุดุฏุ ุฌูุงุจ ููโุฏูุฏ).</li>
</ul>
<hr>
<h3>๐ ฺฉุงุฑุง (Performance)</h3>
<ul>
<li>ฺฏุฑูุชู ู ุขุฒุงุฏ ฺฉุฑุฏู ููู ุฏุฑ ุญุงูุช <strong>ุจุฏูู ุฑูุงุจุช (uncontended)</strong> ุฑู ุณุณุชูโูุง 2020 ฺฉูุชุฑ ุงุฒ <strong>ฒฐ ูุงููุซุงูู</strong> ุทูู ูโฺฉุดุฏ.</li>
<li>ุฏุฑ ุญุงูุช <strong>ุฑูุงุจุช (contended)</strong>ุ ูุฒูู ุจู ุญุฏูุฏ <strong>ูฺฉุฑูุซุงูู</strong> ูโุฑุณุฏ (ุจูโุฎุงุทุฑ Context Switch).</li>
<li>ุฒูุงู ูุงูุน ุจุงุฒุฒูุงูโุจูุฏ Thread ููฺฉู ุงุณุช ุญุช ุจุดุชุฑ ุทูู ุจฺฉุดุฏ.</li>
</ul>
<h3>๐ <strong>Mutex (ููุชฺฉุณ)</strong></h3>
<p>ฺฉ <strong>Mutex</strong> ุดุจู ุจู ุฏุณุชูุฑ <code>lock</code> ุฏุฑ C# ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู ูโุชูุงูุฏ ุฏุฑ <strong>ฺูุฏ ูพุฑุฏุงุฒู (multi-process)</strong> ูู ฺฉุงุฑ ฺฉูุฏ. ุนู:</p>
<ul>
<li><code>lock</code> ููุท ุฏุงุฎู ฺฉ ูพุฑุฏุงุฒู ฺฉุงุฑุจุฑุฏ ุฏุงุฑุฏ.</li>
<li><code>Mutex</code> ูู <strong>ุณุฑุงุณุฑ ุฏุฑ ุณุทุญ ฺฉุงููพูุชุฑ (computer-wide)</strong> ู ูู <strong>ุณุทุญ ุจุฑูุงูู (application-wide)</strong> ูุงุจู ุงุณุชูุงุฏู ุงุณุช.</li>
</ul>
<p>โฑ ฺฏุฑูุชู ู ุขุฒุงุฏ ฺฉุฑุฏู ฺฉ Mutex (ุฏุฑ ุญุงูุช ุจุฏูู ุฑูุงุจุช) ุญุฏูุฏ <strong>ฐ.ต ูฺฉุฑูุซุงูู</strong> ุทูู ูโฺฉุดุฏุ ุนู ุจุด ุงุฒ <strong>ฒฐ ุจุฑุงุจุฑ ฺฉูุฏุชุฑ ุงุฒ lock</strong>.</p>
<hr>
<h3>๐ ุงุณุชูุงุฏู ุงุฒ Mutex</h3>
<ul>
<li>ุจุฑุง ฺฏุฑูุชู ููู: <code>WaitOne()</code></li>
<li>ุจุฑุง ุขุฒุงุฏ ฺฉุฑุฏู: <code>ReleaseMutex()</code></li>
<li>ุฏููุงู ูุซู <code>lock</code>ุ ููุท ููุงู <strong>Thread</strong> ฺฉู Mutex ุฑุง ฺฏุฑูุชูุ ูโุชูุงูุฏ ุขู ุฑุง ุขุฒุงุฏ ฺฉูุฏ.</li>
</ul>
<p>โ๏ธ ุงฺฏุฑ <code>ReleaseMutex</code> ุฑุง ูุฑุงููุด ฺฉูุฏ ู ููุท <code>Close</code> ุง <code>Dispose</code> ุตุฏุง ุจุฒูุฏุ<br>
ุงููู Thread ุฏฺฏุฑ ฺฉู ุฑู ุขู ููุชุธุฑ ูุงูุฏู ุจุงุดุฏุ ุจุง <strong>AbandonedMutexException</strong> ููุงุฌู ูโุดูุฏ.</p>
<hr>
<h3>๐ฏ ฺฉุงุฑุจุฑุฏ ูุชุฏุงูู: ูุญุฏูุฏ ฺฉุฑุฏู ุงุฌุฑุง ฺูุฏู ูุณุฎู ุงุฒ ฺฉ ุจุฑูุงูู</h3>
<p>ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-comment">// ุจุง ูุงูโฺฏุฐุงุฑ Mutexุ ุขู ุฑุง ุฏุฑ ุณุทุญ ฺฉู ฺฉุงููพูุชุฑ ูุงุจูโุฏุณุชุฑุณ ูโฺฉูู.</span>
<span class="hljs-comment">// ุจูุชุฑ ุงุณุช ูุงูุ ฺฉุชุง ุจุงุดุฏ (ูุซูุงู ุดุงูู ูุงู ุดุฑฺฉุช ุง URL).</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> mutex = <span class="hljs-keyword">new</span> Mutex (<span class="hljs-literal">true</span>, <span class="hljs-string">@&quot;Global\oreilly.com OneAtATimeDemo&quot;</span>);

<span class="hljs-comment">// ุงฺฏุฑ ููู ุงุดุบุงู ุจูุฏุ ฺูุฏ ุซุงูู ุตุจุฑ ฺฉูู</span>
<span class="hljs-comment">// ุดุงุฏ ูุณุฎู ูุจู ุจุฑูุงูู ุฏุฑ ุญุงู ุจุณุชู ุจุงุดุฏ.</span>
<span class="hljs-keyword">if</span> (!mutex.WaitOne (TimeSpan.FromSeconds (<span class="hljs-number">3</span>), <span class="hljs-literal">false</span>))
{
    Console.WriteLine (<span class="hljs-string">&quot;Another instance of the app is running. Bye!&quot;</span>);
    <span class="hljs-keyword">return</span>;
}

<span class="hljs-keyword">try</span> { RunProgram(); }
<span class="hljs-keyword">finally</span> { mutex.ReleaseMutex(); }

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RunProgram</span>()</span>
{
    Console.WriteLine (<span class="hljs-string">&quot;Running. Press Enter to exit&quot;</span>);
    Console.ReadLine();
}
</code></pre>
<p>๐ ูฺฉุชู:</p>
<ul>
<li>ุฏุฑ <strong>Terminal Services</strong> ุง <strong>ฺฉูุณููโูุง ููฺฉุณ ุฌุฏุงฺฏุงูู</strong>ุ Mutex ุณุฑุงุณุฑ ูุนูููุงู ููุท ุจุฑุง ุจุฑูุงููโูุง ุฏุฑ ููุงู <strong>Session</strong> ูุงุจูโุฏุณุชุฑุณ ุงุณุช.</li>
<li>ุงฺฏุฑ ุจุฎูุงูุฏ ุจุฑุง ูููโ Sessionูุง ุฏุฑ ุฏุณุชุฑุณ ุจุงุดุฏุ ุจุงุฏ ูุงู Mutex ุฑุง ุจุง <code>&quot;Global\&quot;</code> ุดุฑูุน ฺฉูุฏ (ูุซู ููููู ฺฉุฏ).</li>
</ul>
<hr>
<h3>๐งฉ Thread Safety (ุงูู ุฏุฑ ฺูุฏูุฎ)</h3>
<p>ฺฉ ุจุฑูุงูู ุง ูุชุฏ ุฒูุงู <strong>Thread-Safe</strong> ุงุณุช ฺฉู ุฏุฑ ูุฑ ุณูุงุฑู ฺูุฏูุฎ ุฏุฑุณุช ฺฉุงุฑ ฺฉูุฏ.<br>
ุงู ฺฉุงุฑ ุนูุฏุชุงู ุจุง <strong>ูููโฺฏุฐุงุฑ (locking)</strong> ู <strong>ฺฉุงูุด ุชุนุงูู Threadูุง</strong> ุจู ุฏุณุช ูโุขุฏ.</p>
<h4>ฺุฑุง ูููโฺุฒ ููุดู Thread-Safe ูุณุชุ</h4>
<ol>
<li>ุณุฑุจุงุฑ ุชูุณุนู ุฒุงุฏ ุงุณุช (ุงฺฏุฑ ฺฉ ููุน ุชุนุฏุงุฏ ุฒุงุฏ ููุฏ ุฏุงุดุชู ุจุงุดุฏุ ูุฑ ููุฏ ูโุชูุงูุฏ ููุจุน ุชุฏุงุฎู ุจุงุดุฏ).</li>
<li>Thread-Safety ูุฒููโ ฺฉุงุฑุง ุฏุงุฑุฏ (ุญุช ุงฺฏุฑ ููุท ฺฉ Thread ุงุณุชูุงุฏู ฺฉูุฏ).</li>
<li>ุญุช ุงฺฏุฑ ฺฉ ฺฉูุงุณ Thread-Safe ุจุงุดุฏุ <strong>ุจุฑูุงููโุง ฺฉู ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉูุฏุ ูุฒููุงู Thread-Safe ูุฎูุงูุฏ ุจูุฏ</strong>.</li>
</ol>
<p>โก๏ธ ุจูุงุจุฑุงูุ ูุนูููุงู <strong>ููุท ููุงูโุฌุง Thread-Safe ูพุงุฏูโุณุงุฒ ูโุดูุฏ ฺฉู ูุงุฒู ุงุณุช</strong>.</p>
<hr>
<h3>โ๏ธ ุฑุงูโูุง &quot;ูุงูโุจุฑ&quot; ุจุฑุง Thread-Safety</h3>
<ol>
<li>
<p><strong>ูููโฺฏุฐุงุฑ ฺฉู (Coarse-Grained Locking)</strong></p>
<ul>
<li>ฺฉู ุฏุณุชุฑุณ ุจู ฺฉ ุดุก ุฑุง ุฏุงุฎู ฺฉ ููู ุงูุญุตุงุฑ ูุฑุงุฑ ุฏูุฏ.</li>
<li>ุงู ุฑูุด ุจูโุฎุตูุต ุจุฑุง ุงุณุชูุงุฏู ุงุฒ <strong>ฺฉุฏูุง ูุงุงูู ุฏุฑ ฺูุฏูุฎ</strong> (ูุซู ุจุดุชุฑ ุงููุงุน .NET ุง ฺฉุฏูุง ุดุฎุต ุซุงูุซ) ุถุฑูุฑ ุงุณุช.</li>
<li>ุงฺฏุฑ ูุชุฏูุง ุดุก ุณุฑุน ุจุงุดูุฏุ ุงู ุฑูุด ุฌูุงุจ ูโุฏูุฏ. (ูฺฏุฑูู ููู ุฒุงุฏ ุจุงุนุซ ุจููฺฉู ุดุฏู ุฎูุงูุฏ ุดุฏ).</li>
</ul>
</li>
<li>
<p><strong>ฺฉุงูุด ุชุนุงูู Threadูุง ุจุง ฺฉุงูุด ุฏุงุฏูโูุง ูุดุชุฑฺฉ</strong></p>
<ul>
<li>ุงู ุงุณุชุฑุงุชฺ ุฏุฑ ุงูพูฺฉุดูโูุง Stateless (ูุซู ูุจโุณุฑูุฑูุง ุง ุณุฑูุณโูุง ูุงู) ุงุณุชูุงุฏู ูโุดูุฏ.</li>
<li>ฺูู ุฏุงุฏู ุจู ุฏุฑุฎูุงุณุชโูุง ุฐุฎุฑู ููโุดูุฏุ ุชุนุงูู Threadูุง ฺฉู ูโุดูุฏ.</li>
<li>ุชููุง ููุงุท ูุดุชุฑฺฉ ูโุชูุงููุฏ ููุฏูุง <code>static</code> ุจุงุดูุฏ (ูุซูุงู ุจุฑุง ฺฉุด ฺฉุฑุฏู ุฏุงุฏู ุง ุณุฑูุณโูุง ุฒุฑุณุงุฎุช ูุซู Authentication ู Auditing).</li>
</ul>
</li>
<li>
<p><strong>ุงุฌุฑุง ฺฉุฏ ุฏุณุชุฑุณ ุจู ุฏุงุฏูโูุง ูุดุชุฑฺฉ ุฑู Thread ุฑุงุจุท ฺฉุงุฑุจุฑ (UI Thread)</strong></p>
<ul>
<li>ุฏุฑ ุงูพูฺฉุดูโูุง ฺฉูุงูุช ุบู (Rich Client).</li>
<li>ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>ุชูุงุจุน Asynchronous</strong> (ฺฉู ุฏุฑ ูุตู 14 ุฏุฏู) ุงู ฺฉุงุฑ ุฑุงุญุชโุชุฑ ูโุดูุฏ.</li>
</ul>
</li>
</ol>
<hr>
<p>๐ ุฌูุนโุจูุฏ:</p>
<ul>
<li>ุงุฒ <strong>Mutex</strong> ููุช ุงุณุชูุงุฏู ฺฉูุฏ ฺฉู ูุงุฒ ุจู ููุงููฺฏ ุจู ฺูุฏ ูพุฑุฏุงุฒู ุฏุงุฑุฏ (ูุซู ุงุทููุงู ุงุฒ ุงุฌุฑุง ุชููุง ฺฉ ูุณุฎูโ ุจุฑูุงูู).</li>
<li>ุจุฑุง <strong>Thread-Safety</strong>ุ ุง ุจุงุฏ ุจุง ูููโูุง ุฏุณุชุฑุณ ุฑุง ฺฉูุชุฑู ฺฉูุฏุ ุง ุจุง ุทุฑุงุญ ุตุญุญ (ูุซู Stateless ุง Immutable) ุชุนุงูู Threadูุง ุฑุง ุจู ุญุฏุงูู ุจุฑุณุงูุฏ.</li>
</ul>
<h3>ุงูู ูุฎโูุง ู ุงููุงุน .NET ๐งต๐ก๏ธ</h3>
<p>ุดูุง ูโุชูุงูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>locking</strong> ฺฉุฏ ฺฉู thread-unsafe ุงุณุช ุฑุง ุจู ฺฉุฏ thread-safe ุชุจุฏู ฺฉูุฏ. ฺฉ ุงุฒ ฺฉุงุฑุจุฑุฏูุง ุฎูุจ ุงู ฺฉุงุฑ ุฏุฑ <strong>.NET</strong> ุงุณุช: ุชูุฑุจุงู ูููโ ุงููุงุน <strong>nonprimitive</strong> (ุบุฑุงุจุชุฏุง) ุฏุฑ .NET ุฒูุงู ฺฉู ุณุงุฎุชู ูโุดููุฏุ thread-safe ูุณุชูุฏ (ุจุฑุง ฺุฒ ุจุดุชุฑ ุงุฒ ุฏุณุชุฑุณ ููุทโุฎูุงูุฏู). ุจุง ุงู ุญุงูุ ุดูุง ูโุชูุงูุฏ ุขูโูุง ุฑุง ุฏุฑ ฺฉุฏ ฺูุฏูุฎ (multithreaded) ุงุณุชูุงุฏู ฺฉูุฏุ ุจู ุดุฑุท ฺฉู ูููโ ุฏุณุชุฑุณโูุง ุจู ฺฉ ุดุก ูุดุฎุต ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ <strong>lock</strong> ูุญุงูุธุช ุดููุฏ.</p>
<p>ุฏุฑ ุงูุฌุง ูุซุงู ุฏุงุฑู ฺฉู ุฏุฑ ุขู ุฏู ูุฎ ุจูโุทูุฑ ููุฒูุงู ฺฉ ุขุชู ุฑุง ุจู ููุงู <strong>List collection</strong> ุงุถุงูู ูโฺฉููุฏ ู ุณูพุณ ุขู ูุณุช ุฑุง ูพูุงุด ูโฺฉููุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadSafe</span>
{
  <span class="hljs-keyword">static</span> List&lt;<span class="hljs-built_in">string</span>&gt; _list = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt;();
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
  {
    <span class="hljs-keyword">new</span> Thread (AddItem).Start();
    <span class="hljs-keyword">new</span> Thread (AddItem).Start();
  }
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddItem</span>()</span>
  {
    <span class="hljs-keyword">lock</span> (_list) _list.Add (<span class="hljs-string">&quot;Item &quot;</span> + _list.Count);
    <span class="hljs-built_in">string</span>[] items;
    <span class="hljs-keyword">lock</span> (_list) items = _list.ToArray();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> s <span class="hljs-keyword">in</span> items) Console.WriteLine (s);
  }
}
</code></pre>
<hr>
<h3>ูููโฺฏุฐุงุฑ ู ุงูู ูุฎโูุง ๐</h3>
<p>ุฏุฑ ุงู ุญุงูุชุ ูุง ุฑู ุฎูุฏ ุดุก <strong>_list</strong> ููู ูโฺฉูู. ุงฺฏุฑ ุฏู ูุณุช ูุฑุชุจุท ุฏุงุดุชูุ ุจุงุฏ ฺฉ ุดุก ูุดุชุฑฺฉ ุฑุง ุจุฑุง ููู ุงูุชุฎุงุจ ูโฺฉุฑุฏู (ูโุชูุงูุณุชู ฺฉ ุงุฒ ูุณุชโูุง ุฑุง ุงูุชุฎุงุจ ฺฉูู ุง ุจูุชุฑ: ุงุฒ ฺฉ ููุฏ ูุณุชูู ุงุณุชูุงุฏู ฺฉูู).</p>
<p>ูพูุงุด (enumerating) ูุฌููุนูโูุง .NET ูุฒ thread-unsafe ุงุณุชุ ุจู ุงู ูุนูุง ฺฉู ุงฺฏุฑ ูุณุช ููฺฏุงู ูพูุงุด ุชุบุฑ ฺฉูุฏุ ฺฉ <strong>exception</strong> ุฑุฎ ูโุฏูุฏ. ุจู ุฌุง ูููโฺฏุฐุงุฑ ุฏุฑ ฺฉู ูุฏุช ูพูุงุดุ ุฏุฑ ุงู ูุซุงู ุงุจุชุฏุง ุขุชูโูุง ุฑุง ุฏุฑ ฺฉ <strong>ุขุฑุงู</strong> ฺฉูพ ูโฺฉูู. ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ููู ุจุฑุง ูุฏุช ุทููุงู ูฺฏู ุฏุงุดุชู ูุดูุฏุ ูุฎุตูุตุงู ุงฺฏุฑ ฺฉุงุฑ ฺฉู ููฺฏุงู ูพูุงุด ุงูุฌุงู ูโุฏูู ุฒูุงูโุจุฑ ุจุงุดุฏ. (ุฑุงูโุญู ุฏฺฏุฑ ุงุณุชูุงุฏู ุงุฒ ฺฉ <strong>reader/writer lock</strong> ุงุณุชุ ุจู ุจุฎุด ยซReader/Writer Locksยป ุฏุฑ ุตูุญู นฐท ูุฑุงุฌุนู ฺฉูุฏ.)</p>
<hr>
<h3>ูููโฺฏุฐุงุฑ ุฑู ุงุดุงุก thread-safe โก</h3>
<p>ฺฏุงู ูุงุฒู ุงุณุช ุญุช ููฺฏุงู ุฏุณุชุฑุณ ุจู ุงุดุงุก <strong>thread-safe</strong> ูุฒ ุงุฒ ููู ุงุณุชูุงุฏู ฺฉูุฏ. ุจุฑุง ุชูุถุญุ ูุฑุถ ฺฉูุฏ ฺฉู ฺฉูุงุณ <strong>List</strong> ุฏุฑ .NET ูุงูุนุงู thread-safe ุจูุฏ ู ูุง ูโุฎูุงุณุชู ฺฉ ุขุชู ุจู ูุณุช ุงุถุงูู ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">if</span> (!_list.Contains (newItem)) _list.Add (newItem);
</code></pre>
<p>ุตุฑูโูุธุฑ ุงุฒ ุงูฺฉู ูุณุช thread-safe ุจุงุดุฏ ุง ููุ ุงู ุฏุณุชูุฑ ูุทุนุงู thread-safe ูุณุช! ฺฉู ุนุจุงุฑุช <strong>if</strong> ุจุงุฏ ุฏุฑูู ฺฉ ููู ูุฑุงุฑ ฺฏุฑุฏ ุชุง ุงุฒ ูพุดโุฏุณุช (preemption) ุจู ุจุฑุฑุณ ุนุถูุช ู ุงุถุงูู ฺฉุฑุฏู ุขุชู ุฌููฺฏุฑ ุดูุฏ. ุงู ููู ุจุงุฏ ุฏุฑ ูููโ ุฌุงูุง ฺฉู ูุณุช ุฑุง ุชุบุฑ ูโุฏูู ุงุณุชูุงุฏู ุดูุฏ. ุจุฑุง ูุซุงูุ ุฏุณุชูุฑ ุฒุฑ ูุฒ ุจุงุฏ ุฏุฑ ููุงู ููู ูพฺุฏู ุดูุฏ ุชุง ุงุฒ ูพุดโุฏุณุช ูุณุจุช ุจู ุนุจุงุฑุช ูุจู ุฌููฺฏุฑ ฺฉูุฏ:</p>
<pre class="hljs"><code>_list.Clear();
</code></pre>
<p>ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุจุงุฏ ุฏููุงู ููุงููุฏ ฺฉูุงุณโูุง ูุฌููุนูโ thread-unsafe ูููโฺฏุฐุงุฑ ฺฉูู (ฺฉู ุงู ููุถูุน ุงูู ูุฎู ูุฑุถู ฺฉูุงุณ <strong>List</strong> ุฑุง ุจโุงุซุฑ ูโุณุงุฒุฏ).</p>
<hr>
<h3>ุงุนุถุง ุงุณุชุง (Static Members) โ๏ธ</h3>
<p>ูููโฺฏุฐุงุฑ ููฺฏุงู ุฏุณุชุฑุณ ุจู ฺฉ ูุฌููุนู ูโุชูุงูุฏ ุฏุฑ ูุญุทโูุง ุจุง ููุฑููุฏ ุจุงูุง (<strong>highly concurrent environments</strong>) ุจุงุนุซ <strong>blocking</strong> ุจุดโุงุฒุญุฏ ุดูุฏ. ุจุฑุง ูููุ .NET ฺฉ <strong>queue</strong>ุ <strong>stack</strong> ู <strong>dictionary</strong> thread-safe ูุฑุงูู ฺฉุฑุฏู ุงุณุช ฺฉู ุฏุฑ ูุตู ฒฒ ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.</p>
<p>ูพฺุฏู ุฏุณุชุฑุณ ุจู ฺฉ ุดุก ุฏุฑ ฺฉ ููู ุณูุงุฑุด ููุท ููุช ฺฉุงุฑ ูโฺฉูุฏ ฺฉู ูููโ ูุฎโูุง ููุฑููุฏ ุงุฒ ุขู ููู ุขฺฏุงู ุจุงุดูุฏ ู ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉููุฏ. ุงู ููฺฉู ุงุณุช ููุช ุดุก ุฏุฑ ุณุทุญ ูุณุน ุงุณุชูุงุฏู ูโุดูุฏ ุจุฑูุฑุงุฑ ูุจุงุดุฏ. ุจุฏุชุฑู ุญุงูุช ุฏุฑ ููุฑุฏ <strong>static members</strong> ุฏุฑ ฺฉ ููุน ุนููู (public type) ุฑุฎ ูโุฏูุฏ.</p>
<p>ุจุฑุง ูุซุงูุ ุชุตูุฑ ฺฉูุฏ ฺฉู ูฺฺฏ ุงุณุชุง <strong>DateTime.Now</strong> ุฏุฑ ุณุงุฎุชุงุฑ <strong>DateTime</strong> thread-safe ูุจูุฏ ู ุฏู ูุฑุงุฎูุงู ููุฒูุงู ูโุชูุงูุณุช ุฎุฑูุฌ ุฏุฑูู ุง ฺฉ <strong>exception</strong> ุงุฌุงุฏ ฺฉูุฏ. ุชููุง ุฑุงูโุญู ุจุง ูููโฺฏุฐุงุฑ ุฎุงุฑุฌ ุงู ุจูุฏ ฺฉู ูุจู ุงุฒ ูุฑุงุฎูุงู DateTime.Now ููุน ุฑุง ููู ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">lock</span>(<span class="hljs-keyword">typeof</span>(DateTime))
</code></pre>
<p>ุงู ููุท ุฒูุงู ุฌูุงุจ ูโุฏูุฏ ฺฉู ูููโ ุจุฑูุงููโููุณุงู ุจุง ุงู ฺฉุงุฑ ููุงูู ุจุงุดูุฏ (ฺฉู ุจุนุฏ ุงุณุช). ุนูุงูู ุจุฑ ุงูุ ูููโฺฏุฐุงุฑ ุฑู ฺฉ ููุน ูุดฺฉูุงุช ุฎูุฏุด ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ.</p>
<p>ุจู ููู ุฏููุ ุงุนุถุง ุงุณุชุง <strong>DateTime struct</strong> ุจูโุทูุฑ ุฏูู thread-safe ูพุงุฏูโุณุงุฒ ุดุฏูโุงูุฏ. ุงู ฺฉ ุงูฺฏู ุฑุงุฌ ุฏุฑ .NET ุงุณุช:</p>
<ul>
<li>ุงุนุถุง ุงุณุชุง (static members) โ <strong>thread-safe</strong> โ</li>
<li>ุงุนุถุง ููููู (instance members) โ <strong>thread-unsafe</strong> โ</li>
</ul>
<p>ุฏูุจุงู ฺฉุฑุฏู ุงู ุงูฺฏู ููฺฏุงู ููุดุชู ุงููุงุน ุจุฑุง ุงุณุชูุงุฏู ุนููู ููุทู ุงุณุช ุชุง ุงุฒ ุงุฌุงุฏ ูุนูุงูุง ุบุฑููฺฉูู ุงูู ูุฎ ุฌููฺฏุฑ ุดูุฏ. ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุจุง thread-safe ฺฉุฑุฏู ูุชุฏูุง ุงุณุชุงุ ุดูุง ุทูุฑ ฺฉุฏููุณ ูโฺฉูุฏ ฺฉู ูุงูุน ุงูู ูุฎ ุจุฑุง ูุตุฑูโฺฉููุฏฺฏุงู ุขู ููุน ูุดูุฏ.</p>
<p>โ๏ธ <strong>ุงูู ูุฎ ุฏุฑ ูุชุฏูุง ุงุณุชุง ฺุฒ ุงุณุช ฺฉู ุจุงุฏ ุจูโุทูุฑ ุตุฑุญ ูพุงุฏูโุณุงุฒ ุดูุฏุ ุงู ูฺฺฏ ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ููุท ุจู ุฏูู ุงุณุชุง ุจูุฏู ูุชุฏ ุงุชูุงู ููโุงูุชุฏ!</strong></p>
<hr>
<h3>ุงูู ูุฎ ุฏุฑ ุญุงูุช ููุทโุฎูุงูุฏู ๐</h3>
<p>ุงูู ฺฉุฑุฏู ุงููุงุน ุจุฑุง ุฏุณุชุฑุณ ููุฒูุงู ููุทโุฎูุงูุฏู (ุฏุฑ ุตูุฑุช ุงูฺฉุงู) ุณูุฏููุฏ ุงุณุช ุฒุฑุง ุจู ุงู ูุนูุงุณุช ฺฉู ูุตุฑูโฺฉููุฏฺฏุงู ูโุชูุงููุฏ ุงุฒ ูููโฺฏุฐุงุฑ ุจุดโุงุฒุญุฏ ุฌููฺฏุฑ ฺฉููุฏ. ุจุณุงุฑ ุงุฒ ุงููุงุน .NET ุงู ุงุตู ุฑุง ุฏูุจุงู ูโฺฉููุฏ: ุจุฑุง ูุซุงูุ ูุฌููุนูโูุง ุจุฑุง ุฎูุงููุฏฺฏุงู ููุฒูุงู thread-safe ูุณุชูุฏ.</p>
<p>ุฏูุจุงู ฺฉุฑุฏู ุงู ุงุตู ุจุฑุง ุฎูุฏุชุงู ุณุงุฏู ุงุณุช: ุงฺฏุฑ ููุน ุฑุง ุจูโุนููุงู thread-safe ุจุฑุง ุฏุณุชุฑุณ ููุฒูุงู ููุทโุฎูุงูุฏู ูุณุชูุฏ ูโฺฉูุฏุ ุฏุฑ ูุชุฏูุง ฺฉู ูุตุฑูโฺฉููุฏู ุงูุชุธุงุฑ ุฏุงุฑุฏ ููุทโุฎูุงูุฏู ุจุงุดูุฏ ุจู ููุฏูุง ูููุณุฏ (ุง ุฏุฑ ุตูุฑุช ูุงุฒ ูููโฺฏุฐุงุฑ ฺฉูุฏ).</p>
<p>ุจุฑุง ูููููุ ุฏุฑ ูพุงุฏูโุณุงุฒ ฺฉ ูุชุฏ <strong>ToArray()</strong> ุฏุฑ ฺฉ ูุฌููุนูุ ููฺฉู ุงุณุช ุจุฎูุงูุฏ ุงุจุชุฏุง ุณุงุฎุชุงุฑ ุฏุงุฎู ูุฌููุนู ุฑุง ูุดุฑุฏูโุณุงุฒ ฺฉูุฏ. ุจุง ุงู ุญุงูุ ุงู ฺฉุงุฑ ุขู ุฑุง ุจุฑุง ูุตุฑูโฺฉููุฏฺฏุงู ฺฉู ุงูุชุธุงุฑ ุฏุงุดุชูุฏ ููุทโุฎูุงูุฏู ุจุงุดุฏุ thread-unsafe ูโฺฉูุฏ.</p>
<p>ุงูู ูุฎ ุฏุฑ ุญุงูุช ููุทโุฎูุงูุฏู ฺฉ ุงุฒ ุฏูุงู ุงุณุช ฺฉู <strong>enumerator</strong> ูุง ุงุฒ <strong>enumerable</strong> ูุง ุฌุฏุง ูุณุชูุฏ: ุฏู ูุฎ ูโุชูุงููุฏ ุจูโุทูุฑ ููุฒูุงู ุฑู ฺฉ ูุฌููุนู ูพูุงุด ฺฉููุฏ ฺูู ูุฑฺฉุฏุงู ฺฉ ุดุก enumerator ุฌุฏุง ุฏุฑุงูุช ูโฺฉููุฏ.</p>
<p>ุฏุฑ ูุจูุฏ ูุณุชูุฏุงุชุ ุจูุชุฑ ุงุณุช ูุญุชุงุท ุจุงุดุฏ ู ูุฑุถ ูฺฉูุฏ ฺฉู ฺฉ ูุชุฏ ุฐุงุชุงู ููุทโุฎูุงูุฏู ุงุณุช. ฺฉ ูุซุงู ุฎูุจ ฺฉูุงุณ <strong>Random</strong> ุงุณุช: ููุช <strong>Random.Next()</strong> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ูพุงุฏูโุณุงุฒ ุฏุงุฎู ุขู ูุงุฒ ุฏุงุฑุฏ ฺฉู ููุงุฏุฑ ุจุฐุฑ ุฎุตูุต (private seed values) ุฑุง ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ. ุจูุงุจุฑุงูุ ุดูุง ุจุงุฏ ุง ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ฺฉูุงุณ Random ูููโฺฏุฐุงุฑ ฺฉูุฏ ุง ฺฉ ููููู ุฌุฏุงฺฏุงูู ุจุฑุง ูุฑ ูุฎ ูฺฏู ุฏุงุฑุฏ.</p>
<h3>ุงูู ูุฎ ุฏุฑ ุณุฑูุฑูุง ุจุฑูุงูู ๐ฅ๏ธ๐งต</h3>
<p>ุณุฑูุฑูุง ุจุฑูุงูู (Application servers) ุจุงุฏ <strong>ฺูุฏูุฎ (multithreaded)</strong> ุจุงุดูุฏ ุชุง ุจุชูุงููุฏ ุฏุฑุฎูุงุณุชโูุง ููุฒูุงู ฺฉูุงูุชโูุง ุฑุง ูุฏุฑุช ฺฉููุฏ. ุจุฑูุงููโูุง <strong><a href="http://ASP.NET">ASP.NET</a> Core</strong> ู <strong>Web API</strong> ุจูโุตูุฑุช ุถูู ฺูุฏูุฎ ูุณุชูุฏ. ุงู ุนู ููฺฏุงู ููุดุชู ฺฉุฏ ุฏุฑ ุณูุช ุณุฑูุฑุ ุงฺฏุฑ ุงุญุชูุงู ุชุนุงูู ูุงู ูุฎโูุง ฺฉู ุฏุฑุฎูุงุณุชโูุง ฺฉูุงูุช ุฑุง ูพุฑุฏุงุฒุด ูโฺฉููุฏ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ ุจุงุฏ <strong>ุงูู ูุฎ (thread safety)</strong> ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ. ุฎูุดุจุฎุชุงููุ ฺูู ุงุญุชูุงู ูุงุฏุฑ ุงุณุชุ ฺฉ ฺฉูุงุณ ูุนููู ุฏุฑ ุณุฑูุฑ ุง <strong>stateless</strong> ุงุณุช (ูฺ ููุฏ ูุฏุงุฑุฏ) ุง ฺฉ ูุฏู ูุนุงูโุณุงุฒ ุฏุงุฑุฏ ฺฉู ุจุฑุง ูุฑ ฺฉูุงูุช ุง ูุฑ ุฏุฑุฎูุงุณุช ฺฉ ูููููโ ุฌุฏุง ุงุฒ ุดุก ูโุณุงุฒุฏ. ุชุนุงูู ูุนูููุงู ููุท ุงุฒ ุทุฑู <strong>static fields</strong> ุฑุฎ ูโุฏูุฏุ ฺฉู ฺฏุงู ุจุฑุง ฺฉุด ฺฉุฑุฏู ุจุฎุดโูุง ุงุฒ ุฏุชุงุจุณ ุฏุฑ ุญุงูุธู ุฌูุช ุจูุจูุฏ ฺฉุงุฑุง ุงุณุชูุงุฏู ูโุดููุฏ.</p>
<p>ุจุฑุง ูุซุงูุ ูุฑุถ ฺฉูุฏ ูุชุฏ ุจู ูุงู <strong>RetrieveUser</strong> ุฏุงุฑุฏ ฺฉู ฺฉ ุฏุชุงุจุณ ุฑุง ฺฉูุฆุฑ ูโฺฏุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-comment">// User is a custom class with fields for user data</span>
<span class="hljs-function"><span class="hljs-keyword">internal</span> User <span class="hljs-title">RetrieveUser</span> (<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span> { ... }
</code></pre>
<p>ุงฺฏุฑ ุงู ูุชุฏ ุจู ุฏูุนุงุช ูุฑุงุฎูุงู ุดูุฏุ ูโุชูุงู ุนููฺฉุฑุฏ ุฑุง ุจุง ฺฉุด ฺฉุฑุฏู ูุชุงุฌ ุฏุฑ ฺฉ <strong>Dictionary</strong> ุงุณุชุง ุจูุจูุฏ ุฏุงุฏ. ุฏุฑ ุงูุฌุง ฺฉ ุฑุงูโุญู ุณุงุฏูโ ููููู ุขูุฑุฏู ุดุฏู ุงุณุช ฺฉู ุงูู ูุฎ ุฑุง ูุฒ ุฏุฑ ูุธุฑ ูโฺฏุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserCache</span>
{
  <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">int</span>, User&gt; _users = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>, User&gt;();
  <span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> User <span class="hljs-title">GetUser</span> (<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span>
  {
    User u = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">lock</span> (_users)
      <span class="hljs-keyword">if</span> (_users.TryGetValue (id, <span class="hljs-keyword">out</span> u))
        <span class="hljs-keyword">return</span> u;
    u = RetrieveUser (id);           <span class="hljs-comment">// Method to retrieve from database;</span>
    <span class="hljs-keyword">lock</span> (_users) _users[id] = u;
    <span class="hljs-keyword">return</span> u;
  }
}
</code></pre>
<p>ุฏุฑ ุงูุฌุง ุจุงุฏ ุญุฏุงูู ููฺฏุงู ุฎูุงูุฏู ู ุจูโุฑูุฒุฑุณุงู ุฏฺฉุดูุฑ ูููโฺฏุฐุงุฑ ฺฉูู ุชุง ุงูู ูุฎ ุชุถูู ุดูุฏ. ุงู ุทุฑุงุญ ฺฉ ูุตุงูุญูโ ุนูู ูุงู ุณุงุฏฺฏ ู ฺฉุงุฑุง ุฏุฑ ูููโฺฏุฐุงุฑ ุงุณุช. ุงูุง ฺฉ ูุดฺฉู ฺฉูฺฺฉ ุงุฌุงุฏ ูโุดูุฏ: ุงฺฏุฑ ุฏู ูุฎ ุจูโุทูุฑ ููุฒูุงู ุงู ูุชุฏ ุฑุง ุจุง ฺฉ ุดูุงุณูโ ฺฉุณุงู (ฺฉู ูุจูุงู ูุงฺฉุด ูุดุฏู) ูุฑุงุฎูุงู ฺฉููุฏุ ูุชุฏ <strong>RetrieveUser</strong> ุฏูุจุงุฑ ุงุฌุฑุง ูโุดูุฏ ู ุฏฺฉุดูุฑ ุจโุฏูู ุจูโุฑูุฒุฑุณุงู ุฎูุงูุฏ ุดุฏ.</p>
<p>ููู ฺฉุฑุฏู ฺฉู ูุชุฏ ุฌูู ุงู ูุดฺฉู ุฑุง ูโฺฏุฑุฏุ ุงูุง ูุงฺฉุงุฑุขูุฏ ุจุดุชุฑ ุงุฌุงุฏ ูโฺฉูุฏ: ฺฉู ฺฉุด ุจุฑุง ูุฏุช ูุฑุงุฎูุงู <strong>RetrieveUser</strong> ููู ูโุดูุฏ ู ุฏุฑ ุงู ูุฏุช ุณุงุฑ ูุฎโูุง ุจุฑุง ูุงฺฉุด ฺฉุงุฑุจุฑุงู ุฏฺฏุฑ ุจูุงฺฉ ุฎูุงููุฏ ุดุฏ.</p>
<hr>
<h3>ุฑุงูโุญู ุงุฏูโุขู ุจุง Task<User> โก</h3>
<p>ุจุฑุง ฺฉ ุฑุงูโุญู ุงุฏูโุขูุ ุจุงุฏ ุงุณุชุฑุงุชฺโุง ฺฉู ุฏุฑ ุจุฎุด ยซCompleting synchronouslyยป ุตูุญู ถทท ุชูุถุญ ุฏุงุฏู ุดุฏ ุฑุง ุจูโฺฉุงุฑ ุจฺฏุฑู. ุจู ุฌุง ฺฉุด ฺฉุฑุฏู <strong>User</strong>ุ ูุง <strong>Task<User></strong> ุฑุง ฺฉุด ูโฺฉูู ู ูุฑุงุฎูุงููุฏู ุขู ุฑุง <strong>await</strong> ูโฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserCache</span>
{
  <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">int</span>, Task&lt;User&gt;&gt; _userTasks = 
     <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>, Task&lt;User&gt;&gt;();
  <span class="hljs-function"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> Task&lt;User&gt; <span class="hljs-title">GetUserAsync</span> (<span class="hljs-params"><span class="hljs-built_in">int</span> id</span>)</span>
  {
    <span class="hljs-keyword">lock</span> (_userTasks)
      <span class="hljs-keyword">if</span> (_userTasks.TryGetValue (id, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> userTask))
        <span class="hljs-keyword">return</span> userTask;
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> _userTasks[id] = Task.Run(() =&gt; RetrieveUser(id));
  }
}
</code></pre>
<p>ุฏุฑ ุงู ูุณุฎูุ ฺฉ ููู ูุงุญุฏ ฺฉู ููุทู ูุชุฏ ุฑุง ูพูุดุด ูโุฏูุฏ. ุงู ฺฉุงุฑ ุจู ููุฑููุฏ (concurrency) ุขุณุจ ููโุฒูุฏ ุฒุฑุง ุชููุง ฺฉุงุฑ ฺฉู ุฏุงุฎู ููู ุงูุฌุงู ูโุฏููุ ุฏุณุชุฑุณ ุจู ุฏฺฉุดูุฑ ู (ุงุญุชูุงูุงู) ุดุฑูุน ฺฉ ุนููุงุช <strong>asynchronous</strong> ุจุง ูุฑุงุฎูุงู <strong>Task.Run</strong> ุงุณุช.</p>
<p>ุงฺฏุฑ ุฏู ูุฎ ุจูโุทูุฑ ููุฒูุงู ุงู ูุชุฏ ุฑุง ุจุง ููุงู ุดูุงุณู (ID) ุตุฏุง ุจุฒููุฏุ ูุฑ ุฏู ููุชุธุฑ ููุงู <strong>Task</strong> ุฎูุงููุฏ ูุงูุฏุ ฺฉู ุฏููุงู ููุงู ฺุฒ ุงุณุช ฺฉู ูโุฎูุงูู. โ</p>
<hr>
<h3>ุงุดุงุก ุชุบุฑูุงูพุฐุฑ (Immutable Objects) ๐</h3>
<p>ฺฉ <strong>immutable object</strong> ุดุฆ ุงุณุช ฺฉู ูุถุนุชุด (state) ฺู ุจูโุตูุฑุช ุฎุงุฑุฌ ู ฺู ุฏุงุฎูุ ูุงุจู ุชุบุฑ ูุจุงุดุฏ. ููุฏูุง ฺฉ ุดุก immutable ูุนูููุงู <strong>read-only</strong> ุชุนุฑู ูโุดููุฏ ู ุฏุฑ ุทูู ุณุงุฒูุฏู (constructor) ููุฏุงุฑุฏู ฺฉุงูู ูโุดููุฏ.</p>
<p>ุชุบุฑูุงูพุฐุฑ (immutability) ฺฉ ุงุฒ ูฺฺฏโูุง ุงุตู <strong>ุจุฑูุงููโููุณ ุชุงุจุน (functional programming)</strong> ุงุณุชโุฌุง ฺฉู ุจูโุฌุง ุชุบุฑ ุฏุงุฏู ฺฉ ุดุกุ ฺฉ ุดุก ุฌุฏุฏ ุจุง ูฺฺฏโูุง ูุชูุงูุช ูโุณุงุฒุฏ. <strong>LINQ</strong> ุงุฒ ุงู ูพุงุฑุงุฏุงู ูพุฑู ูโฺฉูุฏ.</p>
<p>ุชุบุฑูุงูพุฐุฑ ุฏุฑ ุจุฑูุงููโูุง ฺูุฏูุฎ ูุฒ ุงุฑุฒุดููุฏ ุงุณุช ุฒุฑุง ูุดฺฉู <strong>shared writable state</strong> (ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ูุถุนุช ูุงุจูโููุดุชู) ุฑุง ุงุฒ ุจู ูโุจุฑุฏ ุง ุจู ุญุฏุงูู ูโุฑุณุงูุฏ.</p>
<p>ฺฉ ุงูฺฏู ุฑุงุฌ ุงู ุงุณุช ฺฉู ุงุฒ ุงุดุงุก immutable ุจุฑุง ฺฉูพุณููู ฺฉุฑุฏู ฺฏุฑูู ุงุฒ ููุฏูุง ูุฑุชุจุท ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ูุฏุช ุฒูุงู ูููโฺฏุฐุงุฑ ฺฉุงูุด ุงุจุฏ.</p>
<hr>
<h3>ฺฉ ูุซุงู ุณุงุฏู ๐</h3>
<p>ูุฑุถ ฺฉูุฏ ุฏู ููุฏ ุฒุฑ ุฏุงุฑู:</p>
<pre class="hljs"><code><span class="hljs-built_in">int</span> _percentComplete;
<span class="hljs-built_in">string</span> _statusMessage;
</code></pre>
<p>ุญุงูุง ุงฺฏุฑ ุจุฎูุงูู ุขูโูุง ุฑุง ุจูโุทูุฑ ุงุชู (atomic) ุจุฎูุงูู ู ุจููุณูุ ุจู ุฌุง ูููโฺฏุฐุงุฑ ูุณุชูู ุฑู ุงู ููุฏูุงุ ูโุชูุงูู ฺฉ ฺฉูุงุณ immutable ุชุนุฑู ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">ProgressStatus</span>    <span class="hljs-comment">// Represents progress of some activity</span>
{
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> PercentComplete;
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> StatusMessage;
  <span class="hljs-comment">// This class might have many more fields...</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProgressStatus</span> (<span class="hljs-params"><span class="hljs-built_in">int</span> percentComplete, <span class="hljs-built_in">string</span> statusMessage</span>)</span>
  {
    PercentComplete = percentComplete;
    StatusMessage = statusMessage;
  }
}
</code></pre>
<p>ุณูพุณ ูโุชูุงูู ฺฉ ููุฏ ุงุฒ ุงู ููุน ุจู ููุฑุงู ฺฉ ุดุก ููู ุชุนุฑู ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _statusLocker = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
ProgressStatus _status;
</code></pre>
<p>ุงฺฉููู ูโุชูุงูู ููุงุฏุฑ ุงู ููุน ุฑุง ุจุฏูู ูฺฏู ุฏุงุดุชู ููู ุจุฑุง ูุฏุช ุทููุงู ุจุฎูุงูู ู ุจููุณู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> status = <span class="hljs-keyword">new</span> ProgressStatus (<span class="hljs-number">50</span>, <span class="hljs-string">&quot;Working on it&quot;</span>);
<span class="hljs-comment">// Imagine we were assigning many more fields...</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">lock</span> (_statusLocker) _status = status;    <span class="hljs-comment">// Very brief lock</span>
</code></pre>
<p>ุจุฑุง ุฎูุงูุฏู ุดุกุ ุงุจุชุฏุง ฺฉ ฺฉูพ ุงุฒ ูุฑุฌุน ุดุก ุฑุง (ุฏุงุฎู ููู) ูโฺฏุฑู. ุณูพุณ ูโุชูุงูู ููุงุฏุฑุด ุฑุง ุจุฏูู ูุงุฒ ุจู ูฺฏู ุฏุงุดุชู ููู ุจุฎูุงูู:</p>
<pre class="hljs"><code>ProgressStatus status;
<span class="hljs-keyword">lock</span> (_statusLocker) status = _status;   <span class="hljs-comment">// Again, a brief lock</span>
<span class="hljs-built_in">int</span> pc = status.PercentComplete;
<span class="hljs-built_in">string</span> msg = status.StatusMessage;
...
</code></pre>
<h3>ููู ุบุฑุงูุญุตุงุฑ (Nonexclusive Locking) ๐</h3>
<p>ุณุงุฎุชุงุฑูุง ููู <strong>ุบุฑุงูุญุตุงุฑ</strong> ุจุฑุง ูุญุฏูุฏ ฺฉุฑุฏู ููโุฒูุงู (concurrency) ุจูโฺฉุงุฑ ูโุฑููุฏ. ุฏุฑ ุงู ุจุฎุดุ ุจู <strong>Semaphore</strong> ู <strong>Read/Writer Locks</strong> ูโูพุฑุฏุงุฒู ู ูุดุงู ูโุฏูู ฺฉู ฺฺฏููู ฺฉูุงุณ <strong>SemaphoreSlim</strong> ูโุชูุงูุฏ ููโุฒูุงู ุฑุง ุฏุฑ ุนููุงุช <strong>ุขุณูฺฉุฑูู</strong> ูุญุฏูุฏ ฺฉูุฏ.</p>
<hr>
<h3>Semaphore ๐บ</h3>
<p>ฺฉ <strong>Semaphore</strong> ุดุจู ฺฉ <strong>ฺฉูุงุจ ุดุจุงูู</strong> ุจุง ุธุฑูุช ูุญุฏูุฏ ุงุณุช ฺฉู ุชูุณุท <strong>ุฏุฑุจุงู (bouncer)</strong> ูุฏุฑุช ูโุดูุฏ.</p>
<ul>
<li>ููุช ฺฉูุงุจ ูพุฑ ุงุณุชุ ฺฉุณ ููโุชูุงูุฏ ูุงุฑุฏ ุดูุฏ ู ุตู ุฎุงุฑุฌ ุงุฒ ฺฉูุงุจ ุชุดฺฉู ูโุดูุฏ.</li>
<li>ุชุนุฏุงุฏ Semaphore ุจุฑุงุจุฑ ุงุณุช ุจุง ุชุนุฏุงุฏ ุฌุงฺฏุงูโูุง ุฏุฑ ฺฉูุงุจ.</li>
<li><strong>Release</strong> ฺฉุฑุฏู ฺฉ Semaphore ุชุนุฏุงุฏ ุฑุง ุงูุฒุงุด ูโุฏูุฏุ ูุนูููุงู ููุช ฺฉุณ ฺฉูุงุจ ุฑุง ุชุฑฺฉ ูโฺฉูุฏ (ูุทุงุจูุช ุจุง ุขุฒุงุฏ ุดุฏู ฺฉ ููุจุน)ุ ุง ููุช Semaphore ููุฏุงุฑุฏู ุงููู ูโุดูุฏ.</li>
<li>ูโุชูุงู ุฏุฑ ูุฑ ุฒูุงู <strong>Release</strong> ฺฉุฑุฏ ุชุง ุธุฑูุช ุงูุฒุงุด ุงุจุฏ.</li>
</ul>
<p><strong>Wait ฺฉุฑุฏู ุฑู ฺฉ Semaphore</strong> ุชุนุฏุงุฏ ุขู ุฑุง ฺฉุงูุด ูโุฏูุฏ ู ูุนูููุงู ูุจู ุงุฒ ฺฏุฑูุชู ฺฉ ููุจุน ุงูุฌุงู ูโุดูุฏ. ุงฺฏุฑ <strong>Wait</strong> ุฑู Semaphoreโุง ุจุง ููุฏุงุฑ ูุนู ุจุฒุฑฺฏโุชุฑ ุงุฒ ุตูุฑ ุงูุฌุงู ุดูุฏุ ุจูุงูุงุตูู ุชฺฉูู ูโุดูุฏ.</p>
<p>Semaphore ูโุชูุงูุฏ ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ (maximum count) ุฏุงุดุชู ุจุงุดุฏ ฺฉู ฺฉ ูุญุฏูุฏุช ุณุฎุช ูุญุณูุจ ูโุดูุฏ. ุงูุฒุงุด ููุฏุงุฑ ุจุด ุงุฒ ุงู ุญุฏ ุจุงุนุซ ูพุฑุชุงุจ ุงุณุชุซูุงุก ุฎูุงูุฏ ุดุฏ. ููฺฏุงู ุงุฌุงุฏ Semaphoreุ ููุฏุงุฑ ุงููู (initial count) ู ุงุฎุชุงุฑ ุญุฏุงฺฉุซุฑ ููุฏุงุฑ ูุดุฎุต ูโุดูุฏ.</p>
<hr>
<p>ฺฉ <strong>Semaphore</strong> ุจุง ููุฏุงุฑ ุงููู ฺฉ ุดุจู <strong>Mutex</strong> ุง <strong>lock</strong> ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู <strong>Semaphore</strong> ูุงูฺฉ (owner) ูุฏุงุฑุฏ ู ูุณุชูู ุงุฒ ูุฎ ุงุณุช. ูุฑ ูุฎ ูโุชูุงูุฏ <strong>Release</strong> ฺฉูุฏุ ุฏุฑ ุญุงู ฺฉู ุฏุฑ Mutex ู lock ููุท ูุฎ ุฏุฑุงูุชโฺฉููุฏูโ ููู ูโุชูุงูุฏ ุขู ุฑุง ุขุฒุงุฏ ฺฉูุฏ.</p>
<p>ุฏู ูุณุฎูโ ุนููฺฉุฑุฏ ูุดุงุจู ูุฌูุฏ ุฏุงุฑุฏ: <strong>Semaphore</strong> ู <strong>SemaphoreSlim</strong>. ูุณุฎูโ ุฏูู ุจุฑุง ุจุฑูุงููโููุณ ููุงุฒ ุจุง ุชุฃุฎุฑ ูพุงู ุจููู ุดุฏู ุงุณุช ู ุฏุฑ <strong>multithreading</strong> ุณูุช ูุฒ ููุฏ ุงุณุชุ ุฒุฑุง ุงุฌุงุฒู ูโุฏูุฏ <strong>CancellationToken</strong> ููฺฏุงู <strong>Wait</strong> ูุดุฎุต ุดูุฏ ู ฺฉ ูุชุฏ <strong>WaitAsync</strong> ุจุฑุง ุจุฑูุงููโููุณ ุขุณูฺฉุฑูู ุงุฑุงุฆู ูโุฏูุฏ. ุงูุง ุจุฑุง ุณฺฏูุงูโุฏู ุจู ูุฑุขูุฏูุง (interprocess) ฺฉุงุฑุจุฑุฏ ูุฏุงุฑุฏ.</p>
<ul>
<li><strong>Semaphore</strong> ุญุฏูุฏ ฑ ูฺฉุฑูุซุงูู ุจุฑุง ูุฑุงุฎูุงู <strong>WaitOne</strong> ู <strong>Release</strong> ุตุฑู ูโฺฉูุฏ.</li>
<li><strong>SemaphoreSlim</strong> ุชูุฑุจุงู ฺฉโุฏูู ุงู ุฒูุงู ุฑุง ูุตุฑู ูโฺฉูุฏ.</li>
</ul>
<hr>
<h3>ฺฉุงุฑุจุฑุฏ Semaphore ุจุฑุง ูุญุฏูุฏ ฺฉุฑุฏู ููโุฒูุงู โก</h3>
<p>Semaphore ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงุฌุฑุง ุจุด ุงุฒ ุญุฏ ูุฎโูุง ุฑู ฺฉ ุจุฎุด ุฎุงุต ุงุฒ ฺฉุฏ ููุฏ ุงุณุช.</p>
<p>ูุซุงู ุฏุงุฑู ฺฉู ูพูุฌ ูุฎ ุชูุงุด ูโฺฉููุฏ ูุงุฑุฏ ฺฉ ฺฉูุงุจ ุดููุฏ ฺฉู ููุท ุณู ูุฎ ููุฒูุงู ุงุฌุงุฒู ูุฑูุฏ ุฏุงุฑูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">TheClub</span>
{
  <span class="hljs-keyword">static</span> SemaphoreSlim _sem = <span class="hljs-keyword">new</span> SemaphoreSlim(<span class="hljs-number">3</span>);    <span class="hljs-comment">// ุธุฑูุช ณ</span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
  {
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) <span class="hljs-keyword">new</span> Thread(Enter).Start(i);
  }

  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Enter</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> id</span>)</span>
  {
    Console.WriteLine(id + <span class="hljs-string">&quot; wants to enter&quot;</span>);
    _sem.Wait();
    Console.WriteLine(id + <span class="hljs-string">&quot; is in!&quot;</span>);           <span class="hljs-comment">// ุญุฏุงฺฉุซุฑ ุณู ูุฎ</span>
    Thread.Sleep(<span class="hljs-number">1000</span> * (<span class="hljs-built_in">int</span>)id);               <span class="hljs-comment">// ูโุชูุงููุฏ ููุฒูุงู</span>
    Console.WriteLine(id + <span class="hljs-string">&quot; is leaving&quot;</span>);      <span class="hljs-comment">// ุฏุฑ ฺฉูุงุจ ุจุงุดูุฏ</span>
    _sem.Release();
  }
}
</code></pre>
<p>ููููู ุฎุฑูุฌ ููฺฉู:</p>
<pre class="hljs"><code>1 wants to enter
1 is in!
2 wants to enter
2 is in!
3 wants to enter
3 is in!
4 wants to enter
5 wants to enter
1 is leaving
4 is in!
2 is leaving
5 is in!
</code></pre>
<hr>
<p>ููฺูู ูุงููู ุงุณุช ฺฉู Semaphore ุฑุง ุจุง <strong>ููุฏุงุฑ ุงููู ุตูุฑ</strong> ุงุฌุงุฏ ฺฉูุฏ ู ุณูพุณ ุจุง <strong>Release</strong> ุชุนุฏุงุฏ ุขู ุฑุง ุงูุฒุงุด ุฏูุฏ. ูุซุงู ุฒุฑ ุฏู Semaphore ูุนุงุฏู ุฑุง ูุดุงู ูโุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> semaphore1 = <span class="hljs-keyword">new</span> SemaphoreSlim(<span class="hljs-number">3</span>);
<span class="hljs-keyword">var</span> semaphore2 = <span class="hljs-keyword">new</span> SemaphoreSlim(<span class="hljs-number">0</span>); 
semaphore2.Release(<span class="hljs-number">3</span>);
</code></pre>
<p>ุงฺฏุฑ Semaphore ูุงูโฺฏุฐุงุฑ ุดุฏู ุจุงุดุฏุ ูโุชูุงูุฏ ูุงููุฏ Mutex ุจู ูุฑุขูุฏูุง ูุฒ ููุฑุฏ ุงุณุชูุงุฏู ูุฑุงุฑ ฺฏุฑุฏ. (Semaphore ูุงูโฺฏุฐุงุฑ ุดุฏู ููุท ุฏุฑ Windows ููุฌูุฏ ุงุณุชุ ุฏุฑ ุญุงู ฺฉู Mutex ูุงูโฺฏุฐุงุฑ ุดุฏู ุฑู Unix ูู ฺฉุงุฑ ูโฺฉูุฏ.)</p>
<h3>Semaphoreูุง ู ูููโูุง ุขุณูฺฉุฑูู (Asynchronous Semaphores and Locks) โณ</h3>
<p>ููู ฺฉุฑุฏู (lock) <strong>ุฏุฑ ฺฉ ุนุจุงุฑุช await ุบุฑูุฌุงุฒ ุงุณุช</strong>:</p>
<pre class="hljs"><code><span class="hljs-keyword">lock</span> (_locker)
{
  <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);    <span class="hljs-comment">// ุฎุทุง ฺฉุงููพุงู</span>
  ...
}
</code></pre>
<p>ุฏููุด ุณุงุฏู ุงุณุช: ูููโูุง ุจู ฺฉ <strong>ูุฎ ุฎุงุต</strong> ุชุนูู ุฏุงุฑูุฏุ ู ููฺฏุงู ุจุงุฒฺฏุดุช ุงุฒ <code>await</code> ูุนูููุงู ูุฎ ุชุบุฑ ูโฺฉูุฏ. ุนูุงูู ุจุฑ ุงูุ <strong>lock ุจููฺฉโฺฉููุฏู ุงุณุช</strong> ู ุจููฺฉ ฺฉุฑุฏู ุจุฑุง ฺฉ ุจุงุฒู ุทููุงู ุฏููุงู ููุงู ฺุฒ ุงุณุช ฺฉู ุฏุฑ ุจุฑูุงููโูุง ุขุณูฺฉุฑูู ููโุฎูุงูุฏ.</p>
<hr>
<p>ุจุง ุงู ุญุงูุ ฺฏุงู ุงููุงุช ูโุฎูุงูู ุนููุงุช ุขุณูฺฉุฑูู <strong>ุจู ุตูุฑุช ูุชูุงู ุงุฌุฑุง ุดููุฏ</strong> ุง ุชุนุฏุงุฏ ุนููุงุช ููุฒูุงู ุฑุง ูุญุฏูุฏ ฺฉูู ุชุง ุจุด ุงุฒ n ุนููุงุช ููุฒูุงู ุฑุฎ ูุฏูุฏ.</p>
<p>ูุซุงู: ฺฉ ูุฑูุฑฺฏุฑ ูุจ ููฺฉู ุงุณุช ูุงุฒ ุฏุงุดุชู ุจุงุดุฏ ุชุง ุฏุงูููุฏูุง ุฑุง ุจูโุตูุฑุช ุขุณูฺฉุฑูู ู ููุฒูุงู ุงูุฌุงู ุฏูุฏุ ุงูุง ุจุฎูุงูุฏ ูุญุฏูุฏุช ุญุฏุงฺฉุซุฑ ฑฐ ุฏุงูููุฏ ููุฒูุงู ุฑุง ุงุนูุงู ฺฉูุฏ. ุงู ฺฉุงุฑ ุฑุง ูโุชูุงู ุจุง <strong>SemaphoreSlim</strong> ุงูุฌุงู ุฏุงุฏ:</p>
<pre class="hljs"><code>SemaphoreSlim _semaphore = <span class="hljs-keyword">new</span> SemaphoreSlim(<span class="hljs-number">10</span>);

<span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">byte</span>[]&gt; DownloadWithSemaphoreAsync(<span class="hljs-built_in">string</span> uri)
{
    <span class="hljs-keyword">await</span> _semaphore.WaitAsync();
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> WebClient().DownloadDataTaskAsync(uri);
    }
    <span class="hljs-keyword">finally</span>
    {
        _semaphore.Release();
    }
}
</code></pre>
<ul>
<li>ุงฺฏุฑ <code>initialCount</code> Semaphore ุฑุง ุจู ฑ ฺฉุงูุด ุฏููุ ุญุฏุงฺฉุซุฑ ููโุฒูุงู ุจู ฑ ูุญุฏูุฏ ูโุดูุฏ ู ุนููุงู ฺฉ <strong>ููู ุขุณูฺฉุฑูู</strong> ุงุฌุงุฏ ูโฺฉูุฏ.</li>
</ul>
<hr>
<h3>ููุดุชู ฺฉ ูุชุฏ extension ุจู ูุงู <code>EnterAsync</code></h3>
<p>ูุชุฏ extension ุฒุฑ ุงุณุชูุงุฏู ุขุณูฺฉุฑูู ุงุฒ <strong>SemaphoreSlim</strong> ุฑุง ุณุงุฏูโุชุฑ ูโฺฉูุฏุ ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉูุงุณ <strong>Disposable</strong> ฺฉู ุฏุฑ ุจุฎุด โAnonymous Disposalโ ูุนุฑู ุดุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;IDisposable&gt; <span class="hljs-title">EnterAsync</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> SemaphoreSlim ss</span>)</span>
{
    <span class="hljs-keyword">await</span> ss.WaitAsync().ConfigureAwait(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> Disposable.Create(() =&gt; ss.Release());
}
</code></pre>
<p>ุจุง ุงู ูุชุฏ ูโุชูุงูู ุฑูุด ูุจู ุฏุงูููุฏ ุฑุง ุจู ุดฺฉู ุณุงุฏูโุชุฑ ุจุงุฒููุณ ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">byte</span>[]&gt; DownloadWithSemaphoreAsync(<span class="hljs-built_in">string</span> uri)
{
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">await</span> _semaphore.EnterAsync())
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> WebClient().DownloadDataTaskAsync(uri);
}
</code></pre>
<hr>
<h3>Parallel.ForEachAsync</h3>
<p>ุงุฒ <strong>.NET 6</strong>ุ ุฑูุด ุฏฺฏุฑ ุจุฑุง ูุญุฏูุฏ ฺฉุฑุฏู ููโุฒูุงู ุขุณูฺฉุฑูู ูุฌูุฏ ุฏุงุฑุฏ: <strong>Parallel.ForEachAsync</strong>.</p>
<p>ูุฑุถ ฺฉูุฏ ุขุฑุงูโุง ุงุฒ URIูุง ุฏุงุฑู ฺฉู ูโุฎูุงูู ุฏุงูููุฏ ฺฉูู. ูโุชูุงูู ุขููุง ุฑุง ุจูโุตูุฑุช ููุฒูุงู ุฏุงูููุฏ ฺฉูู ู ููโุฒูุงู ุฑุง ุจู ุญุฏุงฺฉุซุฑ ฑฐ ุนููุงุช ูุญุฏูุฏ ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">await</span> Parallel.ForEachAsync(
    uris,
    <span class="hljs-keyword">new</span> ParallelOptions { MaxDegreeOfParallelism = <span class="hljs-number">10</span> },
    <span class="hljs-keyword">async</span> (uri, cancelToken) =&gt;
    {
        <span class="hljs-keyword">var</span> download = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> HttpClient().GetByteArrayAsync(uri);
        Console.WriteLine(<span class="hljs-string">$&quot;Downloaded <span class="hljs-subst">{download.Length}</span> bytes&quot;</span>);
    });
</code></pre>
<ul>
<li>ุณุงุฑ ูุชุฏูุง ฺฉูุงุณ <strong>Parallel</strong> ุจุดุชุฑ ุจุฑุง ุณูุงุฑููุง ุจุฑูุงููโููุณ ููุงุฒ ูุญุงุณุจุงุช (<strong>compute-bound</strong>) ุงุณุชูุงุฏู ูโุดููุฏุ ฺฉู ุฏุฑ ูุตู ฒฒ ุจุฑุฑุณ ุดุฏูโุงูุฏ.</li>
</ul>
<h3>ูููโูุง ุฎูุงูุฏู/ููุดุชู (Reader/Writer Locks) ๐</h3>
<p>ุงุบูุจ ุงููุงุชุ ูููููโูุง ฺฉ ููุน ุฏุงุฏู <strong>ุจุฑุง ุฎูุงูุฏู ููุฒูุงู ุงูู ูุณุชูุฏ</strong>ุ ุงูุง <strong>ุจุฑุง ุจูโุฑูุฒุฑุณุงู ููุฒูุงู ุง ุชุฑฺฉุจ ุงุฒ ุฎูุงูุฏู ู ููุดุชู ุงูู ูุณุชูุฏ</strong>.<br>
ุงู ููุถูุน ูโุชูุงูุฏ ุฏุฑ ููุฑุฏ ููุงุจุน ูุงููุฏ ูุงูโูุง ูู ุตุงุฏู ุจุงุดุฏ.</p>
<ul>
<li>ุงุณุชูุงุฏู ุงุฒ ฺฉ <strong>ููู ุงูุญุตุงุฑ ุณุงุฏู</strong> (exclusive lock) ูุนูููุงู ูุดฺฉู ุฑุง ุญู ูโฺฉูุฏุ</li>
<li>ุงูุง ุงฺฏุฑ ุชุนุฏุงุฏ ุฒุงุฏ ุฎูุงููุฏู ู ููุท ุจูโุฑูุฒุฑุณุงูโูุง ฺฏุงูโุจูโฺฏุงู ุฏุงุดุชู ุจุงุดูุ ุงู ฺฉุงุฑ <strong>ูุญุฏูุฏุช ุฒุงุฏ ุฑู ููุฒูุงู ุงุฌุงุฏ ูโฺฉูุฏ</strong>.</li>
</ul>
<p>ูุซุงู ุงุฒ ฺูู ุณูุงุฑู ุฏุฑ <strong>ุณุฑูุฑูุง ุชุฌุงุฑ</strong> ุงุณุช ฺฉู ุฏุงุฏูโูุง ูพุฑฺฉุงุฑุจุฑุฏ ุฑุง ุฏุฑ <strong>ููุฏูุง static</strong> ุจุฑุง ุฏุณุชุฑุณ ุณุฑุน ฺฉุด ูโฺฉููุฏ.</p>
<hr>
<h3>ฺฉูุงุณ <code>ReaderWriterLockSlim</code></h3>
<p>ุงู ฺฉูุงุณ ุจุฑุง <strong>ุญุฏุงฺฉุซุฑ ุฏุณุชุฑุณ ููุฒูุงู</strong> ุฏุฑ ฺูู ุดุฑุงุท ุทุฑุงุญ ุดุฏู ุงุณุช ู ุฌุงฺฏุฒู ฺฉูุงุณ ูุฏูโุชุฑ ู โฺุงูโ <strong>ReaderWriterLock</strong> ุงุณุช:</p>
<ul>
<li>ฺฉูุงุณ ูุฏู ฺูุฏู ุจุงุฑ ฺฉูุฏุชุฑ ุจูุฏ ู ฺฉ ูุดฺฉู ุทุฑุงุญ ุฏุฑ ุงุฑุชูุง ููู ุฏุงุดุช.</li>
<li>ุฏุฑ ููุงุณู ุจุง ฺฉ ููู ูุนููู (<code>Monitor.Enter/Exit</code>) ูููุฒ ุฏู ุจุฑุงุจุฑ ฺฉูุฏุชุฑ ุงุณุชุ ุงูุง <strong>ูุฒุช ุขู ฺฉุงูุด ุฑูุงุจุช (contention) ููฺฏุงู ุฎูุงูุฏู ุฒุงุฏ ู ููุดุชู ฺฉู ุงุณุช</strong>.</li>
</ul>
<hr>
<h3>ุงููุงุน ููู</h3>
<p>ุฏู ููุน ุงุตู ููู ุฏุงุฑู:</p>
<ul>
<li><strong>Write lock (ููู ููุดุชู)</strong>: ฺฉุงููุงู ุงูุญุตุงุฑ ุงุณุช.</li>
<li><strong>Read lock (ููู ุฎูุงูุฏู)</strong>: ุจุง ุณุงุฑ read lockูุง ุณุงุฒฺฏุงุฑ ุงุณุช.</li>
</ul>
<blockquote>
<p>ุงฺฏุฑ ฺฉ ูุฎ write lock ุฏุงุดุชู ุจุงุดุฏุ ุชูุงู ูุฎโูุง ุฏฺฏุฑ ฺฉู ูุตุฏ read ุง write ุฏุงุฑูุฏุ ูุณุฏูุฏ ูโุดููุฏ. ุงูุง ุงฺฏุฑ ูฺ write lock ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏุ ูุฑ ุชุนุฏุงุฏ ูุฎ ูโุชูุงูุฏ ููุฒูุงู read lock ุจฺฏุฑุฏ.</p>
</blockquote>
<hr>
<h3>ูุชุฏูุง ููู <code>ReaderWriterLockSlim</code></h3>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">EnterReadLock</span>()</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ExitReadLock</span>()</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">EnterWriteLock</span>()</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ExitWriteLock</span>()</span>;
</code></pre>
<ul>
<li>ูุณุฎูโูุง <strong>Try</strong> ูู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู timeout ูโูพุฐุฑูุฏ (ูุดุงุจู <code>Monitor.TryEnter</code>)</li>
<li>ฺฉูุงุณ ูุฏู ReaderWriterLock ุฑูุดโูุง ูุดุงุจู ุจู ูุงูโูุง <code>AcquireXXX</code> ู <code>ReleaseXXX</code> ุฏุงุฑุฏ ฺฉู ุฏุฑ ุตูุฑุช timeout <strong>ApplicationException</strong> ูพุฑุชุงุจ ูโฺฉูุฏ.</li>
</ul>
<hr>
<h3>ูุซุงู ุนูู</h3>
<p>ุณู ูุฎ ูุฑุชุจุงู ฺฉ ูุณุช ุฑุง ูโุฎูุงููุฏ ู ุฏู ูุฎ ุฏฺฏุฑ ูุฑ ฑฐฐ ููโุซุงูู ฺฉ ุนุฏุฏ ุชุตุงุฏู ุจู ูุณุช ุงุถุงูู ูโฺฉููุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">SlimDemo</span>
{
    <span class="hljs-keyword">static</span> ReaderWriterLockSlim _rw = <span class="hljs-keyword">new</span> ReaderWriterLockSlim();
    <span class="hljs-keyword">static</span> List&lt;<span class="hljs-built_in">int</span>&gt; _items = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();
    <span class="hljs-keyword">static</span> Random _rand = <span class="hljs-keyword">new</span> Random();

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-keyword">new</span> Thread(Read).Start();
        <span class="hljs-keyword">new</span> Thread(Read).Start();
        <span class="hljs-keyword">new</span> Thread(Read).Start();
        <span class="hljs-keyword">new</span> Thread(Write).Start(<span class="hljs-string">&quot;A&quot;</span>);
        <span class="hljs-keyword">new</span> Thread(Write).Start(<span class="hljs-string">&quot;B&quot;</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Read</span>()</span>
    {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
        {
            _rw.EnterReadLock();
            <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">int</span> i <span class="hljs-keyword">in</span> _items) Thread.Sleep(<span class="hljs-number">10</span>);
            _rw.ExitReadLock();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Write</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> threadID</span>)</span>
    {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
        {
            <span class="hljs-built_in">int</span> newNumber = GetRandNum(<span class="hljs-number">100</span>);
            _rw.EnterWriteLock();
            _items.Add(newNumber);
            _rw.ExitWriteLock();
            Console.WriteLine(<span class="hljs-string">&quot;Thread &quot;</span> + threadID + <span class="hljs-string">&quot; added &quot;</span> + newNumber);
            Thread.Sleep(<span class="hljs-number">100</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetRandNum</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> max</span>)</span> { <span class="hljs-keyword">lock</span> (_rand) <span class="hljs-keyword">return</span> _rand.Next(max); }
}
</code></pre>
<ul>
<li>ุฏุฑ ฺฉุฏ ุชููุฏ ูุงูุนุ ูุนูููุงู ุงุฒ <strong>try/finally</strong> ุจุฑุง ุงุทููุงู ุงุฒ ุขุฒุงุฏ ุดุฏู ูููโูุง ุฏุฑ ุตูุฑุช ุจุฑูุฒ ุงุณุชุซูุง ุงุณุชูุงุฏู ูโฺฉูู.</li>
<li>ุฎุฑูุฌ ููููู:</li>
</ul>
<pre class="hljs"><code>Thread B added 61
Thread A added 83
Thread B added 55
Thread A added 33
...
</code></pre>
<hr>
<h3>ูุฒุช ุงุตู</h3>
<p><code>ReaderWriterLockSlim</code> <strong>ุงูฺฉุงู ุฎูุงูุฏู ููุฒูุงู ุจุดุชุฑ ูุณุจุช ุจู ููู ุณุงุฏู ูุฑุงูู ูโฺฉูุฏ</strong>.</p>
<ul>
<li>ุจุฑุง ูุดุงูุฏู ุชุนุฏุงุฏ ูุฎโูุง concurrent ุฎูุงููุฏู ูโุชูุงูู ุฏุฑ ูุชุฏ Write ุจููุณู:</li>
</ul>
<pre class="hljs"><code>Console.WriteLine(_rw.CurrentReadCount + <span class="hljs-string">&quot; concurrent readers&quot;</span>);
</code></pre>
<ul>
<li>ุงุบูุจ ุงููุงุช ุงู ููุฏุงุฑ ณ concurrent readers ุฎูุงูุฏ ุจูุฏุ ุฒุฑุง ูุชุฏูุง Read ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุฏุฑ ุญููู <code>foreach</code> ูโฺฏุฐุฑุงููุฏ.</li>
</ul>
<hr>
<h3>ูฺฺฏโูุง ู ูพุฑููพุฑุชโูุง ูุงูุชูุฑูฺฏ</h3>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsReadLockHeld            { <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsUpgradeableReadLockHeld { <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsWriteLockHeld           { <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>  WaitingReadCount          { <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>  WaitingUpgradeCount       { <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>  WaitingWriteCount         { <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>  RecursiveReadCount        { <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>  RecursiveUpgradeCount     { <span class="hljs-keyword">get</span>; }
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span>  RecursiveWriteCount       { <span class="hljs-keyword">get</span>; }
</code></pre>
<p>ุงู ูฺฺฏโูุง ุจู ุจุฑูุงููโููุณ ุงูฺฉุงู <strong>ูุงูุชูุฑ ฺฉุฑุฏู ูุถุนุช ูููโูุง</strong> ู ุจูููโุณุงุฒ ุนููฺฉุฑุฏ ุฑุง ูโุฏูุฏ.</p>
<h3>ูููโูุง ูุงุจู ุงุฑุชูุง (Upgradeable Locks) ๐</h3>
<p>ฺฏุงู ูุงุฒู ุงุณุช ฺฉู <strong>ฺฉ read lock ุฑุง ุจู write lock ุชุจุฏู ฺฉูู</strong> ุจู ุตูุฑุช <strong>ุงุชู</strong> (atomic).<br>
ูุซูุงู ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ฺฉ ุขุชู ุจู ูุณุช ุงุถุงูู ฺฉูู <strong>ููุท ุฏุฑ ุตูุฑุช ฺฉู ูุจูุงู ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ</strong>.</p>
<p>ุงุฏู ุงู ุงุณุช ฺฉู ุฒูุงู ูฺฏู ุฏุงุดุชู write lock ุฑุง <strong>ุจู ุญุฏุงูู ุจุฑุณุงูู</strong>ุ ู ูุนูููุงู ูุฑุงุญู ุฒุฑ ุฑุง ุฏูุจุงู ูโฺฉูู:</p>
<ol>
<li>ฺฏุฑูุชู ฺฉ <strong>read lock</strong>.</li>
<li>ุจุฑุฑุณ ุงูฺฉู ุขุง ุขุชู ูุจูุงู ุฏุฑ ูุณุช ูุณุช ุง ููุ ุงฺฏุฑ ูุณุชุ ููู ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู ุจุงุฒ ูโฺฏุฑุฏู.</li>
<li>ุขุฒุงุฏ ฺฉุฑุฏู read lock.</li>
<li>ฺฏุฑูุชู <strong>write lock</strong>.</li>
<li>ุงุถุงูู ฺฉุฑุฏู ุขุชู ุจู ูุณุช.</li>
</ol>
<p>๐ก ูุดฺฉู: ุจู ูุฑุงุญู ณ ู ดุ <strong>ฺฉ ูุฎ ุฏฺฏุฑ ููฺฉู ุงุณุช ูุงุฑุฏ ุดุฏู ู ูุณุช ุฑุง ุชุบุฑ ุฏูุฏ</strong> (ูุซูุงู ููุงู ุขุชู ุฑุง ุงุถุงูู ฺฉูุฏ).</p>
<hr>
<h3>ุฑุงูโุญู <code>ReaderWriterLockSlim</code></h3>
<p>ฺฉูุงุณ <code>ReaderWriterLockSlim</code> ุจุฑุง ุงู ูุดฺฉูุ <strong>ููุน ุณูู ุงุฒ ููู</strong> ุงุฑุงุฆู ูโุฏูุฏ: <strong>upgradeable lock</strong>.</p>
<ul>
<li>ุงู ููู ุดุจู read lock ุงุณุชุ ุงูุง ูโุชูุงู ุขู ุฑุง <strong>ุจุนุฏุงู ุจู write lock ุงุฑุชูุง ุฏุงุฏ</strong> ุจู ุตูุฑุช ุงุชู.</li>
</ul>
<p>ูุฑุงุญู ุงุณุชูุงุฏู ุงุฒ Upgradeable Lock:</p>
<ol>
<li>ูุฑุงุฎูุงู <code>EnterUpgradeableReadLock()</code></li>
<li>ุงูุฌุงู ุนููุงุช ูุจุชู ุจุฑ ุฎูุงูุฏู (ูุซูุงู ุจุฑุฑุณ ูุฌูุฏ ุขุชู)</li>
<li>ูุฑุงุฎูุงู <code>EnterWriteLock()</code> โ ุงู ูุฑุญูู <strong>ููู ูุงุจู ุงุฑุชูุง ุฑุง ุจู write lock ุชุจุฏู ูโฺฉูุฏ</strong></li>
<li>ุงูุฌุงู ุนููุงุช ููุดุชู (ูุซูุงู ุงุถุงูู ฺฉุฑุฏู ุขุชู ุจู ูุณุช)</li>
<li>ูุฑุงุฎูุงู <code>ExitWriteLock()</code> โ write lock ุจู upgradeable lock ุจุงุฒ ูโฺฏุฑุฏุฏ</li>
<li>ุงูุฌุงู ูุฑ ุนููุงุช ุฎูุงูุฏู ุฏฺฏุฑ</li>
<li>ูุฑุงุฎูุงู <code>ExitUpgradeableReadLock()</code></li>
</ol>
<blockquote>
<p>ุงุฒ ุฏุฏ ุจุฑูุงููโููุณุ ุงู ูุงููุฏ <strong>ูููโูุง ุชู ุฏุฑ ุชู ุง ุจุงุฒฺฏุดุช (nested/recursive)</strong> ุงุณุช.<br>
ุงุฒ ูุธุฑ ุนููฺฉุฑุฏุ ุฏุฑ ูุฑุญูู ณุ <code>ReaderWriterLockSlim</code> <strong>read lock ูุจู ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู write lock ุฌุฏุฏ ูโฺฏุฑุฏ ุจู ุตูุฑุช ุงุชู</strong>.</p>
</blockquote>
<hr>
<h3>ุชูุงูุช ููู ุจุง read lock</h3>
<ul>
<li>ฺฉ upgradeable lock ูโุชูุงูุฏ <strong>ููุฒูุงู ุจุง ุชุนุฏุงุฏ ุฒุงุฏ read lock</strong> ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.</li>
<li>ุงูุง <strong>ุชููุง ฺฉ upgradeable lock ูโุชูุงูุฏ ููุฒูุงู ฺฏุฑูุชู ุดูุฏ</strong>.</li>
<li>ุงู ูุญุฏูุฏุช <strong>ุงุฒ deadlock ููฺฏุงู ุชุจุฏู ุฌููฺฏุฑ ูโฺฉูุฏ</strong>ุ ูุดุงุจู ฺฉุงุฑ ฺฉู <strong>update lock ุฏุฑ SQL Server</strong> ุงูุฌุงู ูโุฏูุฏ.</li>
</ul>
 <div align="center">
<p><img src="../../../assets/image/21/Table-21-1.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ูุซุงู ุนูู ุงุฒ Upgradeable Lock ู ููู ุจุงุฒฺฏุดุช ๐</h3>
<p>ูโุชูุงูู <strong>Upgradeable Lock</strong> ุฑุง ุจุง ุชุบุฑ ูุชุฏ <code>Write</code> ุฏุฑ ูุซุงู ูุจู ูุดุงู ุฏููุ ุจู ุทูุฑ ฺฉู <strong>ฺฉ ุนุฏุฏ ุจู ูุณุช ุงุถุงูู ุดูุฏ ููุท ุงฺฏุฑ ูุจูุงู ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏ</strong>:</p>
<pre class="hljs"><code><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
{
    <span class="hljs-built_in">int</span> newNumber = GetRandNum(<span class="hljs-number">100</span>);
    _rw.EnterUpgradeableReadLock();

    <span class="hljs-keyword">if</span> (!_items.Contains(newNumber))
    {
        _rw.EnterWriteLock();
        _items.Add(newNumber);
        _rw.ExitWriteLock();
        Console.WriteLine(<span class="hljs-string">&quot;Thread &quot;</span> + threadID + <span class="hljs-string">&quot; added &quot;</span> + newNumber);
    }

    _rw.ExitUpgradeableReadLock();
    Thread.Sleep(<span class="hljs-number">100</span>);
}
</code></pre>
<hr>
<h3>ููู ุจุงุฒฺฏุดุช (Lock Recursion) ๐</h3>
<ul>
<li><code>ReaderWriterLock</code> ูุฏู ูโุชูุงูุฏ ุชุจุฏู ูููโูุง ุฑุง ุงูุฌุงู ุฏูุฏุ ุงูุง <strong>ุบุฑูุงุจู ุงุนุชูุงุฏ</strong> ุงุณุช ู ููููู <strong>upgradeable lock</strong> ุฑุง ูุฏุงุฑุฏ.</li>
<li><code>ReaderWriterLockSlim</code> ุจู ุทูุฑ ูพุดโูุฑุถ <strong>ูููโูุง ุจุงุฒฺฏุดุช ุง ุชู ุฏุฑ ุชู ุฑุง ูุฌุงุฒ ููโุฏุงูุฏ</strong>.</li>
</ul>
<p>ูุซุงู ุฎุทุงโุฏููุฏู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> rw = <span class="hljs-keyword">new</span> ReaderWriterLockSlim();
rw.EnterReadLock();
rw.EnterReadLock();  <span class="hljs-comment">// Exception!</span>
rw.ExitReadLock();
rw.ExitReadLock();
</code></pre>
<p>ุจุฑุง ูพุดุชุจุงู ุงุฒ ููู ุจุงุฒฺฏุดุชุ ุจุงุฏ ููฺฏุงู ุณุงุฎุช ฺฉูุงุณ ูุดุฎุต ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> rw = <span class="hljs-keyword">new</span> ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion);
</code></pre>
<p>๐ก ูุงููู ุงุตู ุจุฑุง ูููโูุง ุจุงุฒฺฏุดุช: ูพุณ ุงุฒ ฺฏุฑูุชู ฺฉ ูููุ <strong>ูููโูุง ุจุนุฏ ูโุชูุงููุฏ ฺฉูุชุฑ ุงูุง ูู ุจุดุชุฑ ุงุฒ ููุน ุงููู ุจุงุดูุฏ</strong>:</p>
<pre class="hljs"><code>Read Lock โ Upgradeable Lock โ Write Lock
</code></pre>
<ul>
<li>ุงุฑุชูุงุก upgradeable lock ุจู write lock ููุดู ูุฌุงุฒ ุงุณุช.</li>
</ul>
<p>ูุซุงู ุชุฑฺฉุจ:</p>
<pre class="hljs"><code>rw.EnterWriteLock();
rw.EnterReadLock();
Console.WriteLine(rw.IsReadLockHeld);   <span class="hljs-comment">// True</span>
Console.WriteLine(rw.IsWriteLockHeld);  <span class="hljs-comment">// True</span>
rw.ExitReadLock();
rw.ExitWriteLock();
</code></pre>
<hr>
<h3>ุณฺฏูุงูโุฏู ุจุง Event Wait Handles ๐</h3>
<p><strong>Event Wait Handle</strong> ุณุงุฏูโุชุฑู ุงุจุฒุงุฑ ุจุฑุง ุณฺฏูุงูโุฏู ุจู ูุฎโูุง ุงุณุช ู <strong>ูุฑุชุจุท ุจุง C# events ูุณุช</strong>.<br>
ุงููุงุน ุงุตู:</p>
<ul>
<li><code>AutoResetEvent</code></li>
<li><code>ManualResetEvent</code> / <code>ManualResetEventSlim</code></li>
<li><code>CountdownEvent</code></li>
</ul>
<p>ุชูุงู ุงูโูุง ุงุฒ ฺฉูุงุณ ูพุงู <code>EventWaitHandle</code> ูุดุชู ุดุฏูโุงูุฏ.</p>
<hr>
<h4>AutoResetEvent ๐๏ธ</h4>
<ul>
<li>ุดุจู <strong>ฺฏุฐุฑฺฏุงู ุจูุช (turnstile)</strong> ุงุณุช: ูุฑูุฏ ุจูุช ููุท ฺฉ ููุฑ ุฑุง ุนุจูุฑ ูโุฏูุฏ.</li>
<li>ูพุณ ุงุฒ ุนุจูุฑุ ฺฏุฐุฑฺฏุงู ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ <strong>reset</strong> ูโุดูุฏ.</li>
<li>ฺฉ ูุฎ ุจุง <code>WaitOne()</code> ููุชุธุฑ ูโูุงูุฏ ู ฺฉ ูุฎ ุฏฺฏุฑ ุจุง <code>Set()</code> ุขู ุฑุง ุขุฒุงุฏ ูโฺฉูุฏ.</li>
</ul>
<p>ุณุงุฎุช AutoResetEvent:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> auto = <span class="hljs-keyword">new</span> AutoResetEvent(<span class="hljs-literal">false</span>);  
<span class="hljs-comment">// ุง</span>
<span class="hljs-keyword">var</span> auto = <span class="hljs-keyword">new</span> EventWaitHandle(<span class="hljs-literal">false</span>, EventResetMode.AutoReset);
</code></pre>
<p>ูุซุงู ุณุงุฏู:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">BasicWaitHandle</span>
{
    <span class="hljs-keyword">static</span> EventWaitHandle _waitHandle = <span class="hljs-keyword">new</span> AutoResetEvent(<span class="hljs-literal">false</span>);

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-keyword">new</span> Thread(Waiter).Start();
        Thread.Sleep(<span class="hljs-number">1000</span>);       <span class="hljs-comment">// ูฺฉุซ ฺฉ ุซุงูู</span>
        _waitHandle.Set();        <span class="hljs-comment">// ูุนุงู ฺฉุฑุฏู Waiter</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Waiter</span>()</span>
    {
        Console.WriteLine(<span class="hljs-string">&quot;Waiting...&quot;</span>);
        _waitHandle.WaitOne();    <span class="hljs-comment">// ุงูุชุธุงุฑ ุจุฑุง ุณฺฏูุงู</span>
        Console.WriteLine(<span class="hljs-string">&quot;Notified&quot;</span>);
    }
}
</code></pre>
<p><strong>ุฎุฑูุฌ:</strong></p>
<pre class="hljs"><code>Waiting... (pause) Notified
</code></pre>
 <div align="center">
<p><img src="../../../assets/image/21/Table-21-2.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ุฑูุชุงุฑ <code>Set</code> ููุช ูฺ ูุฎ ููุชุธุฑ ูุณุช โ๏ธ</h3>
<ul>
<li>ุงฺฏุฑ <code>Set()</code> ูุฑุงุฎูุงู ุดูุฏ ู ูฺ ูุฎ ููุชุธุฑ ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏุ <strong>handle ุจุงุฒ ูโูุงูุฏ</strong> ุชุง ุฒูุงู ฺฉู ฺฉ ูุฎ <code>WaitOne()</code> ูุฑุงุฎูุงู ฺฉูุฏ.</li>
<li>ุงู ุฑูุชุงุฑ ุงุฒ <strong>ุฑูุงุจุช ุจู ูุฎโูุง ุฌููฺฏุฑ ูโฺฉูุฏ</strong>: ูุฎ ูโุฎูุงูุฏ ูุงุฑุฏ ฺฏุฐุฑฺฏุงู ุดูุฏ ู ูุฎ ุฏฺฏุฑ ุฒูุฏุชุฑ <code>Set()</code> ุฒุฏู ุจุงุดุฏ.</li>
<li>ุงูุงุ <strong>ูุฑุงุฎูุงู ูฺฉุฑุฑ <code>Set()</code> ููุช ูฺโฺฉุณ ููุชุธุฑ ูุณุชุ ุจุงุนุซ ุนุจูุฑ ฺูุฏ ููุฑ ููโุดูุฏ</strong>ุ ููุท ููุฑ ุจุนุฏ ุนุจูุฑ ูโฺฉูุฏ ู ุจูุชโูุง ุงุถุงู ยซูุฏุฑ ูโุฑููุฏยป.</li>
</ul>
<hr>
<h3>ุขุฒุงุฏุณุงุฒ Wait Handle โป๏ธ</h3>
<ul>
<li>ูพุณ ุงุฒ ูพุงุงู ุงุณุชูุงุฏู ุงุฒ wait handleุ ูโุชูุงู <code>Close()</code> ุฑุง ุตุฏุง ุฒุฏ ุชุง ููุจุน ุณุณุชู ุนุงูู ุขุฒุงุฏ ุดูุฏ.</li>
<li>ุง ูโุชูุงู ุชูุงู ุงุฑุฌุงุนุงุช ุจู ุขู ุฑุง ุฑูุง ฺฉุฑุฏ ู ุงุฌุงุฒู ุฏุงุฏ <strong>garbage collector</strong> ุจุนุฏุงู ุขู ุฑุง ุฌูุนโุขูุฑ ฺฉูุฏ (wait handleูุง ุงุฒ ุงูฺฏู disposal ูพุฑู ูโฺฉููุฏ ู finalizer ุขูโูุง <code>Close()</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ).</li>
<li>Wait handleูุง ููฺฏุงู ุฎุฑูุฌ process ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุขุฒุงุฏ ูโุดููุฏ.</li>
</ul>
<h4>ูฺฉุงุช ููู</h4>
<ul>
<li><code>Reset()</code> ุฑู AutoResetEventุ ฺฏุฐุฑฺฏุงู ุฑุง ูโุจูุฏุฏ (ุงฺฏุฑ ุจุงุฒ ุจุงุดุฏ) ุจุฏูู ุงูุชุธุงุฑ ุง ุจูุงฺฉ ฺฉุฑุฏู.</li>
<li><code>WaitOne(timeout)</code> ูโุชูุงูุฏ <strong>ูุฏุช ุงูุชุธุงุฑ ุฑุง ูุญุฏูุฏ</strong> ฺฉูุฏ ู ุงฺฏุฑ timeout ุฑุฎ ุฏูุฏุ <code>false</code> ุจุฑูโฺฏุฑุฏุงูุฏ.</li>
<li><code>WaitOne(0)</code> ูโุชูุงูุฏ ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง wait handle ยซุจุงุฒยป ุงุณุช ุจุฏูู ุจูุงฺฉ ฺฉุฑุฏู ูุฎ ูุฑุงุฎูุงููุฏู.</li>
</ul>
<blockquote>
<p>โ๏ธ ุชูุฌู: ุงู ฺฉุงุฑ ุจุงุนุซ <strong>reset ุดุฏู AutoResetEvent</strong> ุงฺฏุฑ ุจุงุฒ ุจุงุดุฏุ ูโุดูุฏ.</p>
</blockquote>
<hr>
<h3>ุณฺฏูุงูโุฏู ุฏูุทุฑูู โ๏ธ</h3>
<p>ุงฺฏุฑ ุจุฎูุงูู ูุฎ ุงุตู (main thread) ุจู ฺฉ ูุฎ worker ุณู ุจุงุฑ ูุชูุงู ุณฺฏูุงู ุจุฏูุฏ:</p>
<ul>
<li>ูุฑุงุฎูุงู ุณุงุฏู <code>Set()</code> ฺูุฏ ุจุงุฑ ูพุดุช ุณุฑ ูู ููฺฉู ุงุณุช ุจุงุนุซ <strong>ุงุฒ ุฏุณุช ุฑูุชู ุณฺฏูุงูโูุง</strong> ุดูุฏุ ุฒุฑุง worker ููฺฉู ุงุณุช ุฒูุงู ุจุจุฑุฏ ุชุง ูุฑ ุณฺฏูุงู ุฑุง ูพุฑุฏุงุฒุด ฺฉูุฏ.</li>
<li>ุฑุงูโุญู: ูุฎ ุงุตู <strong>ุตุจุฑ ฺฉูุฏ ุชุง worker ุขูุงุฏู ุดูุฏ</strong> ูุจู ุงุฒ ุงุฑุณุงู ุณฺฏูุงู. ุงู ฺฉุงุฑ ุจุง ฺฉ <code>AutoResetEvent</code> ุฏฺฏุฑ ุงูุฌุงู ูโุดูุฏ.</li>
</ul>
<p>ูุซุงู ฺฉุงูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">TwoWaySignaling</span>
{
    <span class="hljs-keyword">static</span> EventWaitHandle _ready = <span class="hljs-keyword">new</span> AutoResetEvent(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">static</span> EventWaitHandle _go = <span class="hljs-keyword">new</span> AutoResetEvent(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _locker = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
    <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> _message;

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-keyword">new</span> Thread(Work).Start();

        _ready.WaitOne();       <span class="hljs-comment">// ููุชุธุฑ ูโูุงูุฏ ุชุง worker ุขูุงุฏู ุดูุฏ</span>
        <span class="hljs-keyword">lock</span> (_locker) _message = <span class="hljs-string">&quot;ooo&quot;</span>;
        _go.Set();              <span class="hljs-comment">// ุณฺฏูุงู ุจู worker</span>

        _ready.WaitOne();       <span class="hljs-comment">// ููุชุธุฑ ูโูุงูุฏ ุชุง worker ุฏูุจุงุฑู ุขูุงุฏู ุดูุฏ</span>
        <span class="hljs-keyword">lock</span> (_locker) _message = <span class="hljs-string">&quot;ahhh&quot;</span>;
        _go.Set();

        _ready.WaitOne();
        <span class="hljs-keyword">lock</span> (_locker) _message = <span class="hljs-literal">null</span>; <span class="hljs-comment">// ุณฺฏูุงู ูพุงุงู</span>
        _go.Set();
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Work</span>()</span>
    {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
        {
            _ready.Set();       <span class="hljs-comment">// ุงุนูุงู ุขูุงุฏฺฏ</span>
            _go.WaitOne();      <span class="hljs-comment">// ููุชุธุฑ ุณฺฏูุงู</span>

            <span class="hljs-keyword">lock</span> (_locker)
            {
                <span class="hljs-keyword">if</span> (_message == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// ุฎุฑูุฌ ฺฉูุชุฑูโุดุฏู</span>
                Console.WriteLine(_message);
            }
        }
    }
}
</code></pre>
<p><strong>ุฎุฑูุฌ:</strong></p>
<pre class="hljs"><code>ooo
ahhh
</code></pre>
<ul>
<li>ุฏุฑ ุดฺฉู 21-2 ูุฑุขูุฏ ุขูุงุฏู ุดุฏู ู ุณฺฏูุงูโุฏู ุฏูุทุฑูู ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.</li>
</ul>
 <div align="center">
<p><img src="../../../assets/image/21/Table-21-3.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ุงุณุชูุงุฏู ุงุฒ ูพุงู null ุจุฑุง ูพุงุงู ุฏุงุฏู ุจู worker ๐</h3>
<ul>
<li>ุฏุฑ ูุซุงู ูุจูุ ุงุฒ ฺฉ ูพุงู <code>null</code> ุจุฑุง ูุดุฎุต ฺฉุฑุฏู ูพุงุงู ฺฉุงุฑ worker ุงุณุชูุงุฏู ุดุฏ.</li>
<li>ุจุฑุง ูุฎโูุง ฺฉู <strong>ุจูโุตูุฑุช ูุงูุญุฏูุฏ ุงุฌุฑุง ูโุดููุฏ</strong>ุ ุฏุงุดุชู ฺฉ ุงุณุชุฑุงุชฺ ุฎุฑูุฌ ุถุฑูุฑ ุงุณุช.</li>
</ul>
<hr>
<h3>ManualResetEvent ๐๏ธ</h3>
<ul>
<li>
<p>ููุงูโุทูุฑ ฺฉู ุฏุฑ ูุตู ฑด ุชูุถุญ ุฏุงุฏู ุดุฏุ <code>ManualResetEvent</code> ูุงููุฏ ฺฉ <strong>ุฏุฑูุงุฒู ุณุงุฏู</strong> ุนูู ูโฺฉูุฏ:</p>
<ul>
<li>ูุฑุงุฎูุงู <code>Set()</code> ุฏุฑูุงุฒู ุฑุง ุจุงุฒ ูโฺฉูุฏ ู <strong>ูุฑ ุชุนุฏุงุฏ ูุฎ</strong> ฺฉู <code>WaitOne()</code> ูุฑุงุฎูุงู ฺฉุฑุฏูโุงูุฏุ ุนุจูุฑ ูโุฏููุฏ.</li>
<li>ูุฑุงุฎูุงู <code>Reset()</code> ุฏุฑูุงุฒู ุฑุง ูโุจูุฏุฏ. ูุฎโูุง ฺฉู <code>WaitOne()</code> ุฑู ุฏุฑูุงุฒู ุจุณุชู ุตุฏุง ูโุฒููุฏุ <strong>ุจูุงฺฉ ูโุดููุฏ</strong> ุชุง ุฏุฑูุงุฒู ุจุงุฒ ุดูุฏ.</li>
</ul>
</li>
<li>
<p>ุนููฺฉุฑุฏ ฺฉู ูุดุงุจู <code>AutoResetEvent</code> ุงุณุช.</p>
</li>
</ul>
<h4>ุณุงุฎุช ManualResetEvent</h4>
<pre class="hljs"><code><span class="hljs-keyword">var</span> manual1 = <span class="hljs-keyword">new</span> ManualResetEvent(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">var</span> manual2 = <span class="hljs-keyword">new</span> EventWaitHandle(<span class="hljs-literal">false</span>, EventResetMode.ManualReset);
</code></pre>
<ul>
<li>ูุณุฎู ุจูููโุชุฑ ุจู ูุงู <code>ManualResetEventSlim</code> ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุจุฑุง <strong>ุฒูุงู ุงูุชุธุงุฑ ฺฉูุชุงู</strong> ุจููู ุดุฏู ู ุงูฺฉุงู <strong>ุงุณุชูุงุฏู ุงุฒ CancellationToken</strong> ุฑุง ุฏุงุฑุฏ.</li>
<li><code>ManualResetEventSlim</code> subclass ุงุฒ <code>WaitHandle</code> ูุณุช ุงูุง ุฏุงุฑุง ูฺฺฏ <code>WaitHandle</code> ุงุณุช ฺฉู ฺฉ <strong>object ูุจุชู ุจุฑ WaitHandle</strong> ุจุฑูโฺฏุฑุฏุงูุฏ.</li>
</ul>
<hr>
<h3>ุนููฺฉุฑุฏ ู ฺฉุงุฑุง โฑ๏ธ</h3>
<ul>
<li>ุงูุชุธุงุฑ ุง ุณฺฏูุงู ุฏุงุฏู ุจุง <code>AutoResetEvent</code> ุง <code>ManualResetEvent</code> ุญุฏูุฏ <strong>ฺฉ ูฺฉุฑูุซุงูู</strong> ุทูู ูโฺฉุดุฏ (ุงฺฏุฑ ุจูุงฺฉ ูุดูุฏ).</li>
<li><code>ManualResetEventSlim</code> ู <code>CountdownEvent</code> ูโุชูุงููุฏ <strong>ุชุง ตฐ ุจุฑุงุจุฑ ุณุฑุนโุชุฑ</strong> ุฏุฑ ุฒูุงู ุงูุชุธุงุฑ ฺฉูุชุงู ุนูู ฺฉููุฏุ ุจู ุฏูู ุนุฏู ูุงุจุณุชฺฏ ุจู OS ู ุงุณุชูุงุฏู ุงุฒ <strong>spinning constructs</strong>.</li>
<li>ุจุง ุงู ุญุงูุ ุฏุฑ ุงฺฉุซุฑ ุณูุงุฑููุงุ overhead ุงู ฺฉูุงุณโูุง ูุนูููุงู <strong>ฺฏููฺฏุงู ุงุฌุงุฏ ููโฺฉูุฏ</strong>.</li>
</ul>
<hr>
<h3>ฺฉุงุฑุจุฑุฏ ManualResetEvent ู CountdownEvent</h3>
<ul>
<li><code>ManualResetEvent</code>: ุจุฑุง <strong>ุจุงุฒ ฺฉุฑุฏู ฺฉ ูุฎ ุจุฑุง ฺูุฏ ูุฎ ุฏฺฏุฑ</strong> ููุฏ ุงุณุช.</li>
<li><code>CountdownEvent</code>: ุจุฑุง <strong>ููุชุธุฑ ูุงูุฏู ุฑู ฺูุฏ ูุฎ</strong> ุงุณุชูุงุฏู ูโุดูุฏ.</li>
</ul>
<h4>CountdownEvent</h4>
<pre class="hljs"><code><span class="hljs-keyword">var</span> countdown = <span class="hljs-keyword">new</span> CountdownEvent(<span class="hljs-number">3</span>); <span class="hljs-comment">// ููุฏุงุฑ ุงููู ณ ูุฎ</span>

<span class="hljs-keyword">new</span> Thread(SaySomething).Start(<span class="hljs-string">&quot;I am thread 1&quot;</span>);
<span class="hljs-keyword">new</span> Thread(SaySomething).Start(<span class="hljs-string">&quot;I am thread 2&quot;</span>);
<span class="hljs-keyword">new</span> Thread(SaySomething).Start(<span class="hljs-string">&quot;I am thread 3&quot;</span>);

countdown.Wait(); <span class="hljs-comment">// ุจููฺฉ ุชุง ณ ุจุงุฑ Signal ูุฑุงุฎูุงู ุดูุฏ</span>
Console.WriteLine(<span class="hljs-string">&quot;All threads have finished speaking!&quot;</span>);

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SaySomething</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> thing</span>)</span>
{
    Thread.Sleep(<span class="hljs-number">1000</span>);
    Console.WriteLine(thing);
    countdown.Signal(); <span class="hljs-comment">// ฺฉุงูุด count</span>
}
</code></pre>
<ul>
<li>ูโุชูุงู count ุฑุง ุจุง <code>AddCount</code> ุงูุฒุงุด ุฏุงุฏุ ุงูุง ุงฺฏุฑ ุดูุงุฑุด ุจู ุตูุฑ ุฑุณุฏู ุจุงุดุฏุ <strong>ุงุณุชุซูุง ุงุฌุงุฏ ูโฺฉูุฏ</strong>.</li>
<li>ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฎุทุงุ ุงุฒ <code>TryAddCount</code> ุงุณุชูุงุฏู ูโฺฉูู ฺฉู <strong>false</strong> ุจุฑูโฺฏุฑุฏุงูุฏ ุงฺฏุฑ ุดูุงุฑุด ุตูุฑ ุจุงุดุฏ.</li>
<li>ุจุฑุง โunsignalโ ฺฉุฑุฏู ฺฉ CountdownEvent ุงุฒ <code>Reset()</code> ุงุณุชูุงุฏู ูโฺฉูู ฺฉู <strong>count ุฑุง ุจู ููุฏุงุฑ ุงููู ุจุงุฒูุดุงู ูโฺฉูุฏ</strong>.</li>
<li>ูุดุงุจู <code>ManualResetEventSlim</code>ุ CountdownEvent ุฏุงุฑุง ูฺฺฏ <code>WaitHandle</code> ุจุฑุง ุชุนุงูู ุจุง ฺฉูุงุณโูุง ฺฉู <strong>WaitHandle ุงูุชุธุงุฑ ุฏุงุฑูุฏ</strong>ุ ุงุณุช.</li>
</ul>
<hr>
<h3>ุงุฌุงุฏ EventWaitHandle ูุงู ูพุฑุฏุงุฒุด ๐</h3>
<ul>
<li>ูโุชูุงู ฺฉ EventWaitHandle <strong>ูุงูโุฏุงุฑ</strong> ุงุฌุงุฏ ฺฉุฑุฏ ฺฉู ุจู ฺูุฏ ูพุฑุฏุงุฒุด ฺฉุงุฑ ฺฉูุฏ.</li>
<li>ูุงู ุชููุง ฺฉ ุฑุดุชู ุงุณุช ู ุจุงุฏ <strong>ููุญุตุฑุจูโูุฑุฏ ุจุงุดุฏ</strong> ุชุง ุจุง ุณุงุฑ ููุงุจุน ุชุฏุงุฎู ูฺฉูุฏ.</li>
</ul>
<pre class="hljs"><code>EventWaitHandle wh = <span class="hljs-keyword">new</span> EventWaitHandle(
    <span class="hljs-literal">false</span>,
    EventResetMode.AutoReset,
    <span class="hljs-string">@&quot;Global\MyCompany.MyApp.SomeName&quot;</span>
);
</code></pre>
<ul>
<li>ุงฺฏุฑ ุฏู ุจุฑูุงูู ุงู ฺฉุฏ ุฑุง ุงุฌุฑุง ฺฉููุฏุ ูโุชูุงููุฏ <strong>ุจู ูู ุณฺฏูุงู ุฏููุฏ</strong>: wait handle ุฏุฑ ููู ูุฎโูุง ู ูพุฑุฏุงุฒุดโูุง ฺฉุงุฑ ูโฺฉูุฏ.</li>
<li>ุชูุฌู: <strong>Named EventWaitHandle ููุท ุฏุฑ Windows ููุฌูุฏ ุงุณุช</strong>.</li>
</ul>
<h3>Wait Handles ู Continuations ๐</h3>
<p>ุจู ุฌุง <strong>ููุชุธุฑ ูุงูุฏู ุฑู ฺฉ wait handle</strong> ู ุจูุงฺฉ ฺฉุฑุฏู ูุฎุ ูโุชูุงู ฺฉ <strong>continuation</strong> ุจู ุขู ุถููู ฺฉุฑุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ <code>ThreadPool.RegisterWaitForSingleObject</code>.</p>
<h4>ูุซุงู</h4>
<pre class="hljs"><code><span class="hljs-keyword">var</span> starter = <span class="hljs-keyword">new</span> ManualResetEvent(<span class="hljs-literal">false</span>);

RegisteredWaitHandle reg = ThreadPool.RegisterWaitForSingleObject(
    starter, Go, <span class="hljs-string">&quot;Some Data&quot;</span>, <span class="hljs-number">-1</span>, <span class="hljs-literal">true</span>);

Thread.Sleep(<span class="hljs-number">5000</span>);
Console.WriteLine(<span class="hljs-string">&quot;Signaling worker...&quot;</span>);
starter.Set();
Console.ReadLine();

reg.Unregister(starter); <span class="hljs-comment">// ูพุงฺฉโุณุงุฒ ูพุณ ุงุฒ ุงุชูุงู</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> data, <span class="hljs-built_in">bool</span> timedOut</span>)</span>
{
    Console.WriteLine(<span class="hljs-string">&quot;Started - &quot;</span> + data);
    <span class="hljs-comment">// ุงูุฌุงู ฺฉุงุฑ...</span>
}
</code></pre>
<ul>
<li>ุฒูุงู ฺฉู wait handle <strong>signaled</strong> ูโุดูุฏ (ุง timeout ุฑุฎ ูโุฏูุฏ)ุ delegate ุฑู ฺฉ ูุฎ ุงุฒ ThreadPool ุงุฌุฑุง ูโุดูุฏ.</li>
<li>ูพุณ ุงุฒ ุขู ุจุงุฏ <code>Unregister</code> ูุฑุงุฎูุงู ุดูุฏ ุชุง <strong>handle ุบุฑูุฏุฑุชโุดุฏู</strong> ุขุฒุงุฏ ุดูุฏ.</li>
<li>ุงู ูุชุฏ ููฺูู ฺฉ <strong>object โblack boxโ</strong> ูโฺฏุฑุฏ ฺฉู ุจู delegate ููุชูู ูโุดูุฏุ ฺฉ <strong>timeout</strong> (ููโุซุงููุ <code>-1</code> ุนู ุจุฏูู timeout) ู ฺฉ <strong>Boolean</strong> ฺฉู ูุดุฎุต ูโฺฉูุฏ ุขุง ูุฑุงุฎูุงู ฺฉโุจุงุฑู ุงุณุช ุง ูฺฉุฑุฑ.</li>
</ul>
<p>โ๏ธ ูฺฉุชู:</p>
<ul>
<li>ูโุชูุงู <code>RegisterWaitForSingleObject</code> ุฑุง <strong>ููุท ฺฉ ุจุงุฑ ุจุฑุง ูุฑ wait handle</strong> ูุฑุงุฎูุงู ฺฉุฑุฏ.</li>
<li>ูุฑุงุฎูุงู ุฏูุจุงุฑู ุฑู ููุงู wait handle ููฺฉู ุงุณุช ุจุงุนุซ ุดูุฏ callback ุญุช ููุช handle signaled ูุดุฏูุ ุงุฌุฑุง ุดูุฏ.</li>
<li>ุจู ููู ุฏููุ wait handles ุบุฑ-Slim ุจุฑุง ุจุฑูุงููโููุณ asynchronous ููุงุณุจ ูุณุชูุฏ.</li>
</ul>
<hr>
<h3>WaitAnyุ WaitAll ู SignalAndWait โณ๐</h3>
<p>ุนูุงูู ุจุฑ ูุชุฏูุง <strong>Set</strong>ุ <strong>WaitOne</strong> ู <strong>Reset</strong>ุ ฺฉูุงุณ <strong>WaitHandle</strong> ุฏุงุฑุง ูุชุฏูุง ุงุณุชุงุชฺฉ ุฏฺฏุฑ ุงุณุช ฺฉู ุจุฑุง ุญู ูุณุงุฆู ูพฺุฏูโุชุฑ ููุฒูุงูโุณุงุฒ ฺฉุงุฑุจุฑุฏ ุฏุงุฑูุฏ. ูุชุฏูุง <strong>WaitAny</strong>ุ <strong>WaitAll</strong> ู <strong>SignalAndWait</strong> ุนููุงุชโูุง ุณฺฏูุงูโุฏู ู ุงูุชุธุงุฑ ุฑุง ุฑู ฺูุฏู <strong>wait handle</strong> ุงูุฌุงู ูโุฏููุฏ. ุงู <strong>wait handle</strong>ูุง ูโุชูุงููุฏ ุงุฒ ุงููุงุน ูุฎุชูู ุจุงุดูุฏ (ุงุฒ ุฌููู <strong>Mutex</strong> ู <strong>Semaphore</strong>ุ ุฒุฑุง ุงูโูุง ูุฒ ุงุฒ ฺฉูุงุณ ุงูุชุฒุงุน <strong>WaitHandle</strong> ูุดุชู ุดุฏูโุงูุฏ).</p>
<p>ููฺููุ <strong>ManualResetEventSlim</strong> ู <strong>CountdownEvent</strong> ูโุชูุงููุฏ ุงุฒ ุทุฑู ูฺฺฏโูุง <strong>WaitHandle</strong> ุฎูุฏ ุฏุฑ ุงู ูุชุฏูุง ุดุฑฺฉุช ฺฉููุฏ.</p>
<p>ูุชุฏูุง <strong>WaitAll</strong> ู <strong>SignalAndWait</strong> ุงุฑุชุจุงุท ุนุฌุจ ุจุง ูุนูุงุฑ ูุฏู <strong>COM</strong> ุฏุงุฑูุฏ: ุงู ูุชุฏูุง ูุงุฒููุฏ ุขู ูุณุชูุฏ ฺฉู ูุฑุงุฎูุงููุฏู ุฏุฑ ฺฉ <strong>multithreaded apartment</strong> ุจุงุดุฏุ ูุฏู ฺฉู ุจุฑุง ุชุนุงูู ุจุง ุฏฺฏุฑ ุณุณุชูโูุง ฺูุฏุงู ููุงุณุจ ูุณุช. ุจูโุนููุงู ูุซุงูุ <strong>thread ุงุตู</strong> ฺฉ ุจุฑูุงูู <strong>WPF</strong> ุง <strong>Windows Forms</strong> ุฏุฑ ุงู ุญุงูุช ููโุชูุงูุฏ ุจุง <strong>clipboard</strong> ุชุนุงูู ฺฉูุฏ. ุฌุงฺฏุฒูโูุง ุฑุง ุฏุฑ ุงุฏุงูู ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.</p>
<ul>
<li><strong>WaitHandle.WaitAny</strong> ููุชุธุฑ ูโูุงูุฏ ุชุง ูุฑ ฺฉ ุงุฒ ุขุฑุงูโุง ุงุฒ <strong>wait handle</strong>ูุง ุณฺฏูุงู ุจฺฏุฑูุฏ.</li>
<li><strong>WaitHandle.WaitAll</strong> ููุชุธุฑ ูโูุงูุฏ ุชุง ููู <strong>wait handle</strong>ูุง ุฏุงุฏูโุดุฏู ุจูโุตูุฑุช <strong>ุงุชู</strong> ุณฺฏูุงู ุจฺฏุฑูุฏ.</li>
</ul>
<p>ุงู ุจุฏุงู ูุนูุงุณุช ฺฉู ุงฺฏุฑ ุฑู ุฏู <strong>AutoResetEvent</strong> ููุชุธุฑ ุจุงุดุฏ:</p>
<ul>
<li><strong>WaitAny</strong> ูุฑฺฏุฒ ุจุงุนุซ ููโุดูุฏ ฺฉู ูุฑ ุฏู ุฑูุฏุงุฏ ุจูโุทูุฑ ููุฒูุงู &quot;ููู&quot; ุดููุฏ.</li>
<li><strong>WaitAll</strong> ูุฑฺฏุฒ ุจุงุนุซ ููโุดูุฏ ฺฉู ุชููุง ฺฉ ุงุฒ ุฑูุฏุงุฏูุง &quot;ููู&quot; ุดูุฏ.</li>
</ul>
<p><strong>SignalAndWait</strong> ุงุจุชุฏุง <strong>Set</strong> ุฑุง ุฑู ฺฉ <strong>WaitHandle</strong> ูุฑุงุฎูุงู ูโฺฉูุฏ ู ุณูพุณ <strong>WaitOne</strong> ุฑุง ุฑู <strong>WaitHandle</strong> ุฏฺฏุฑ ุตุฏุง ูโุฒูุฏ. ูพุณ ุงุฒ ุณฺฏูุงูโุฏู ุจู <strong>handle</strong> ุงููุ ุจู ุงุจุชุฏุง ุตู ุงูุชุธุงุฑ ุจุฑุง <strong>handle</strong> ุฏูู ูโุฑูุฏุ ุงู ฺฉุงุฑ ฺฉูฺฉ ูโฺฉูุฏ ุชุง ุนููุงุช ูููู ุดูุฏ (ูุฑฺูุฏ ฺฉู ุนููุงุช ูุงูุนุงู ุงุชู ูุณุช). ูโุชูุงู ุงู ูุชุฏ ุฑุง ุจูโุนููุงู ยซุชุจุงุฏู ฺฉ ุณฺฏูุงู ุจุง ุณฺฏูุงู ุฏฺฏุฑยป ุชุตูุฑ ฺฉุฑุฏ ู ุขู ุฑุง ุฑู ฺฉ ุฌูุช <strong>EventWaitHandle</strong> ุงุณุชูุงุฏู ฺฉุฑุฏ ุชุง ุฏู <strong>thread</strong> ุฏุฑ ฺฉ ููุทู ุฒูุงู ุจุง ูู ููุงูุงุช ุง <strong>rendezvous</strong> ุฏุงุดุชู ุจุงุดูุฏ. ูู <strong>AutoResetEvent</strong> ู ูู <strong>ManualResetEvent</strong> ููุงุณุจ ุงู ฺฉุงุฑ ูุณุชูุฏ.</p>
<ul>
<li><strong>Thread ุงูู</strong> ุงุฌุฑุง ูโฺฉูุฏ:</li>
</ul>
<pre class="hljs"><code>WaitHandle.SignalAndWait (wh1, wh2);
</code></pre>
<ul>
<li><strong>Thread ุฏูู</strong> ฺฉุงุฑ ูุนฺฉูุณ ุฑุง ุงูุฌุงู ูโุฏูุฏ:</li>
</ul>
<pre class="hljs"><code>WaitHandle.SignalAndWait (wh2, wh1);
</code></pre>
<hr>
<h3>ุฌุงฺฏุฒูโูุง ุจุฑุง WaitAll ู SignalAndWait ๐</h3>
<p>ูุชุฏูุง <strong>WaitAll</strong> ู <strong>SignalAndWait</strong> ุฏุฑ ฺฉ <strong>single-threaded apartment</strong> ฺฉุงุฑ ููโฺฉููุฏ. ุฎูุดุจุฎุชุงูู ุฌุงฺฏุฒูโูุง ูุฌูุฏ ุฏุงุฑูุฏ. ุฏุฑ ููุฑุฏ <strong>SignalAndWait</strong>ุ ุจู ูุฏุฑุช ูุงุฒ ุจู ูฺฺฏโูุง <strong>queue-jumping</strong> ุขู ุงุณุช: ุจุฑุง ูุซุงู ุฏุฑ ูุซุงู <strong>rendezvous</strong> ูุงุ ฺฉุงู ุงุณุช ฺฉู ุงุจุชุฏุง <strong>Set</strong> ุฑุง ุฑู <strong>wait handle</strong> ุงูู ุตุฏุง ุจุฒูุฏ ู ุณูพุณ <strong>WaitOne</strong> ุฑุง ุฑู ุฏฺฏุฑ ูุฑุงุฎูุงู ฺฉูุฏุ ุงฺฏุฑ ุงุฒ <strong>wait handle</strong>ูุง ุตุฑูุงู ุจุฑุง ููุงู ููุงูุงุช ุงุณุชูุงุฏู ูโฺฉูุฏ. ุฏุฑ ุจุฎุด ุจุนุฏุ ฺฉ ฺฏุฒูู ุฏฺฏุฑ ุจุฑุง ูพุงุฏูโุณุงุฒ <strong>thread rendezvous</strong> ุจุฑุฑุณ ูโฺฉูู.</p>
<p>ุฏุฑ ููุฑุฏ <strong>WaitAny</strong> ู <strong>WaitAll</strong>ุ ุงฺฏุฑ ุจู ุงุชู ุจูุฏู ูุงุฒ ูุฏุงุฑุฏุ ูโุชูุงูุฏ ุงุฒ ฺฉุฏ ฺฉู ุฏุฑ ุจุฎุด ูุจู ููุดุชู ุงุณุชูุงุฏู ฺฉูุฏ ุชุง <strong>wait handle</strong>ูุง ุฑุง ุจู <strong>Task</strong> ุชุจุฏู ฺฉุฑุฏู ู ุณูพุณ ุงุฒ <strong>Task.WhenAny</strong> ู <strong>Task.WhenAll</strong> ุงุณุชูุงุฏู ฺฉูุฏ (ูุตู ฑด).</p>
<p>ุงฺฏุฑ ุจู ุงุชู ุจูุฏู ูุงุฒ ุฏุงุฑุฏุ ูโุชูุงูุฏ ุงุฒ ุณุทุญ ูพุงูโุชุฑ ุดุฑูุน ฺฉูุฏ ู ููุทู ุณฺฏูุงูโุฏู ุฑุง ุฎูุฏุชุงู ุจุง ูุชุฏูุง <strong>Monitor.Wait</strong> ู <strong>Monitor.Pulse</strong> ุจููุณุฏ. ูุง <strong>Wait</strong> ู <strong>Pulse</strong> ุฑุง ุจูโุตูุฑุช ููุตู ุฏุฑ <a href="http://albahari.com/threading">ุงู ููฺฉ</a> ุชูุถุญ ุฏุงุฏูโุงู. โ</p>
<h3>ฺฉูุงุณ Barrier ๐๐งต</h3>
<p>ฺฉูุงุณ <strong>Barrier</strong> ฺฉ <strong>ูุงูุน ุงุฌุฑุง thread</strong> ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ ฺฉู ุงุฌุงุฒู ูโุฏูุฏ ฺูุฏู <strong>thread</strong> ุฏุฑ ฺฉ ููุทู ุฒูุงู ุจุง ูู <strong>rendezvous</strong> ุฏุงุดุชู ุจุงุดูุฏ (ุงู ุจุง <strong>Thread.MemoryBarrier</strong> ูุชูุงูุช ุงุณุช).</p>
<p>ุงู ฺฉูุงุณ ุจุณุงุฑ ุณุฑุน ู ฺฉุงุฑุขูุฏ ุงุณุช ู ุจุฑ ุงุณุงุณ ูุชุฏูุง <strong>Wait</strong>ุ <strong>Pulse</strong> ู <strong>spinlock</strong> ุณุงุฎุชู ุดุฏู ุงุณุช.</p>
<h4>ูุญูู ุงุณุชูุงุฏู</h4>
<ol>
<li>ฺฉ ููููู ุงุฒ ฺฉูุงุณ ุงุฌุงุฏ ฺฉูุฏ ู ูุดุฎุต ฺฉูุฏ ฺฉู ฺูุฏ <strong>thread</strong> ุจุงุฏ ุฏุฑ <strong>rendezvous</strong> ุดุฑฺฉุช ฺฉููุฏ (ูโุชูุงูุฏ ุจุนุฏุงู ุจุง ูุชุฏูุง <strong>AddParticipants</strong> ุง <strong>RemoveParticipants</strong> ุงู ุชุนุฏุงุฏ ุฑุง ุชุบุฑ ุฏูุฏ).</li>
<li>ูุฑ <strong>thread</strong> ุฒูุงู ฺฉู ูโุฎูุงูุฏ ุฏุฑ <strong>rendezvous</strong> ุดุฑฺฉุช ฺฉูุฏุ ูุชุฏ <strong>SignalAndWait</strong> ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.</li>
</ol>
<p>ุงฺฏุฑ ฺฉูุงุณ <strong>Barrier</strong> ุฑุง ุจุง ููุฏุงุฑ ณ ุงุฌุงุฏ ฺฉูุฏุ ูุฑุงุฎูุงู <strong>SignalAndWait</strong> ุชุง ุฒูุงู ฺฉู ุงู ูุชุฏ ุณู ุจุงุฑ ูุฑุงุฎูุงู ูุดุฏู ุจุงุดุฏุ <strong>ุจููฺฉ</strong> ูโุดูุฏ. ุณูพุณ ุฏูุจุงุฑู ฺุฑุฎู ุดุฑูุน ูโุดูุฏ: ูุฑุงุฎูุงู ุจุนุฏ <strong>SignalAndWait</strong> ุฏูุจุงุฑู ุชุง ุณู ุจุงุฑ ุตุฏุง ุฒุฏู ูุชุฏ <strong>ุจููฺฉ</strong> ูโุดูุฏ. ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ูุฑ <strong>thread</strong> ููุฒูุงู ุจุง ุฏฺฏุฑ <strong>thread</strong>ูุง ุญุฑฺฉุช ฺฉูุฏ.</p>
<h4>ูุซุงู ุนูู</h4>
<p>ุฏุฑ ุงู ูุซุงูุ ูุฑ ฺฉ ุงุฒ ุณู <strong>thread</strong> ุงุนุฏุงุฏ ฐ ุชุง ด ุฑุง ฺุงูพ ูโฺฉููุฏ ู ููโุฒูุงู ุจุง ุฏฺฏุฑ <strong>thread</strong>ูุง ุฌูู ูโุฑููุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> barrier = <span class="hljs-keyword">new</span> Barrier(<span class="hljs-number">3</span>);
<span class="hljs-keyword">new</span> Thread(Speak).Start();
<span class="hljs-keyword">new</span> Thread(Speak).Start();
<span class="hljs-keyword">new</span> Thread(Speak).Start();

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Speak</span>()</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)
    {
        Console.Write(i + <span class="hljs-string">&quot; &quot;</span>);
        barrier.SignalAndWait();
    }
}
</code></pre>
<p><strong>ุฎุฑูุฌ:</strong></p>
<pre class="hljs"><code>0 0 0 1 1 1 2 2 2 3 3 3 4 4 4
</code></pre>
<p>ฺฉ ูฺฺฏ ุจุณุงุฑ ููุฏ <strong>Barrier</strong> ุงู ุงุณุช ฺฉู ูโุชูุงูุฏ <strong>post-phase action</strong> ุฑุง ููฺฏุงู ุงุฌุงุฏ ุขู ูุดุฎุต ฺฉูุฏ. ุงู ฺฉ <strong>delegate</strong> ุงุณุช ฺฉู ุจุนุฏ ุงุฒ ุขูฺฉู <strong>SignalAndWait</strong> ุจู ุชุนุฏุงุฏ ูุดุฎุต ูุฑุงุฎูุงู ุดุฏ ุงุฌุฑุง ูโุดูุฏุ ุงูุง ูุจู ุงุฒ ุงูฺฉู <strong>threads</strong> ุขุฒุงุฏ ุดููุฏ.</p>
<p>ุฏุฑ ูุซุงู ูุงุ ุงฺฏุฑ <strong>Barrier</strong> ุฑุง ุจู ุงู ุตูุฑุช ุงุฌุงุฏ ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> Barrier _barrier = <span class="hljs-keyword">new</span> Barrier(<span class="hljs-number">3</span>, barrier =&gt; Console.WriteLine());
</code></pre>
<p>ุฎุฑูุฌ ุจู ุตูุฑุช ุฎุท ุจู ุฎุท ุฎูุงูุฏ ุจูุฏ:</p>
<pre class="hljs"><code>0 0 0 
1 1 1 
2 2 2 
3 3 3 
4 4 4
</code></pre>
<p>ุงู ูฺฺฏ ุจุงุนุซ ูโุดูุฏ ููุงููฺฏ <strong>threads</strong> ุจุณุงุฑ ููุธู ู ุฎูุงูุง ุจุงุดุฏ. โ</p>
 <div align="center">
<p><img src="../../../assets/image/21/Table-21-4.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h3>ุนููุงุช ูพุณโูุงุฒ (Post-Phase Action) ู ุฌูุนโุขูุฑ ุฏุงุฏูโูุง ๐</h3>
<p>ฺฉ <strong>Post-Phase Action</strong> ูโุชูุงูุฏ ุจุฑุง <strong>ุงุฏุบุงู ุฏุงุฏูโูุง ุงุฒ ูุฑ ฺฉ ุงุฒ worker threadโูุง</strong> ููุฏ ุจุงุดุฏ. ุฏุฑ ุงู ุญุงูุชุ ูฺฏุฑุงูโุง ุงุฒ ุจุงุจุช <strong>preemption</strong> ูุฌูุฏ ูุฏุงุฑุฏุ ุฒุฑุง ุชูุงู <strong>workerูุง</strong> ุฏุฑ ุญู ุงุฌุฑุง ุงู ุนููุงุช <strong>ูุณุฏูุฏ</strong> ูุณุชูุฏ.</p>
<hr>
<h3>ููุฏุงุฑุฏู ุชูุจู (Lazy Initialization) ๐ข๐ก</h3>
<p>ฺฉ ุงุฒ ูุดฺฉูุงุช ุฑุงุฌ ุฏุฑ <strong>threading</strong> ุงู ุงุณุช ฺฉู ฺฺฏููู ฺฉ <strong>ููุฏ ูุดุชุฑฺฉ</strong> ุฑุง ุจู ุตูุฑุช <strong>ุชูุจู ู thread-safe</strong> ููุฏุงุฑุฏู ฺฉูู. ุงู ูุงุฒ ุฒูุงู ุงุฌุงุฏ ูโุดูุฏ ฺฉู ฺฉ ููุฏ ุงุฒ ููุน ุฏุงุดุชู ุจุงุดู ฺฉู <strong>ุณุงุฎุช ุขู ูุฒููโุจุฑ ุจุงุดุฏ</strong>:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> Expensive Expensive = <span class="hljs-keyword">new</span> Expensive();
    ...
}
<span class="hljs-keyword">class</span> <span class="hljs-title">Expensive</span> { <span class="hljs-comment">/* ูุฑุถ ฺฉูุฏ ุณุงุฎุช ุงู ฺฉูุงุณ ูพุฑูุฒูู ุงุณุช */</span> }
</code></pre>
<p>ูุดฺฉู ุงู ฺฉุฏ ุงู ุงุณุช ฺฉู <strong>ุณุงุฎุช Foo</strong> ูุฒููโ <strong>ุณุงุฎุช Expensive</strong> ุฑุง ูุฒ ูุชุญูู ูโุดูุฏุ ุญุช ุงฺฏุฑ ููุฏ <strong>Expensive</strong> ูฺโููุช ุฏุณุชุฑุณ ูพุฏุง ูฺฉูุฏ.</p>
<p>ุฑุงู ุญู ูุงุถุญ ุงู ุงุณุช ฺฉู <strong>ููููู ุฑุง ููุท ุฏุฑ ุตูุฑุช ูุงุฒ ุงุฌุงุฏ ฺฉูู</strong>:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span>
{
    Expensive _expensive;
    <span class="hljs-keyword">public</span> Expensive Expensive   <span class="hljs-comment">// ููุฏุงุฑุฏู ุชูุจู Expensive</span>
    {
        <span class="hljs-keyword">get</span>
        {
            <span class="hljs-keyword">if</span> (_expensive == <span class="hljs-literal">null</span>) _expensive = <span class="hljs-keyword">new</span> Expensive();
            <span class="hljs-keyword">return</span> _expensive;
        }
    }
    ...
}
</code></pre>
<p>ุงูุง ุณูุงู ุงูุฌุงุณุช: ุขุง ุงู <strong>thread-safe</strong> ุงุณุชุ<br>
ุงฺฏุฑ ุฏู <strong>thread</strong> ููุฒูุงู ุจู ุงู property ุฏุณุชุฑุณ ูพุฏุง ฺฉููุฏุ ููฺฉู ุงุณุช ูุฑ ุฏู ุดุฑุท <strong>if</strong> ุฑุง ุจุฑุขูุฑุฏู ฺฉููุฏ ู ูุฑ thread ฺฉ ูููููโ ูุชูุงูุช ุงุฒ <strong>Expensive</strong> ุงุฌุงุฏ ฺฉูุฏ. ุงู ูโุชูุงูุฏ ููุฌุฑ ุจู ุฎุทุงูุง ุธุฑู ุดูุฏุ ุจูุงุจุฑุงู ุจู ุทูุฑ ฺฉูุ ุงู ฺฉุฏ <strong>ุงูู ุจุฑุง thread ูุณุช</strong>.</p>
<p>ุฑุงู ุญู <strong>ุงูู ุจุฑุง thread</strong> ุงู ุงุณุช ฺฉู <strong>ฺฺฉ ฺฉุฑุฏู ู ููุฏุงุฑุฏู ุฑุง ุฏุงุฎู ฺฉ lock</strong> ุงูุฌุงู ุฏูู:</p>
<pre class="hljs"><code>Expensive _expensive;
<span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _expenseLock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();

<span class="hljs-keyword">public</span> Expensive Expensive
{
    <span class="hljs-keyword">get</span>
    {
        <span class="hljs-keyword">lock</span> (_expenseLock)
        {
            <span class="hljs-keyword">if</span> (_expensive == <span class="hljs-literal">null</span>) _expensive = <span class="hljs-keyword">new</span> Expensive();
            <span class="hljs-keyword">return</span> _expensive;
        }
    }
}
</code></pre>
<hr>
<h3>ฺฉูุงุณ Lazy<T> โก</h3>
<p>ฺฉูุงุณ <strong>Lazy<T></strong> ุจุฑุง ฺฉูฺฉ ุจู <strong>ููุฏุงุฑุฏู ุชูุจู</strong> ุฏุฑ ุฏุณุชุฑุณ ุงุณุช. ุงฺฏุฑ ุขู ุฑุง ุจุง ุขุฑฺฏููุงู <strong>true</strong> ุจุณุงุฒุฏุ <strong>ุงูฺฏู ููุฏุงุฑุฏู thread-safe</strong> ฺฉู ุจุงูุงุชุฑ ุชูุถุญ ุฏุงุฏู ุดุฏ ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ.</p>
<p><strong>Lazy<T></strong> ุฏุฑ ูุงูุน ฺฉ ูุณุฎูโ <strong>micro-optimized</strong> ุงุฒ ุงู ุงูฺฏูุ ุจู ูุงู <strong>double-checked locking</strong> ุฑุง ูพุงุฏูโุณุงุฒ ูโฺฉูุฏ.<br>
ุงู ุงูฺฏู ฺฉ <strong>ุฎูุงูุฏู volatile ุงุถุงู</strong> ุงูุฌุงู ูโุฏูุฏ ุชุง ุงฺฏุฑ ุดุก ุงุฒ ูุจู ููุฏุงุฑุฏู ุดุฏู ุจูุฏุ ูุฒููโ ฺฏุฑูุชู lock ุฑุง ูุฏุงุดุชู ุจุงุดู.</p>
<h4>ูุญูู ุงุณุชูุงุฏู ุงุฒ Lazy<T></h4>
<pre class="hljs"><code>Lazy&lt;Expensive&gt; _expensive = <span class="hljs-keyword">new</span> Lazy&lt;Expensive&gt;(
    () =&gt; <span class="hljs-keyword">new</span> Expensive(), <span class="hljs-literal">true</span>);

<span class="hljs-keyword">public</span> Expensive Expensive { <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _expensive.Value; } }
</code></pre>
<p>ุงฺฏุฑ <strong>false</strong> ุจู ุณุงุฒูุฏูโ <strong>Lazy<T></strong> ุจุฏูุฏุ ุงูฺฏู <strong>ุบุฑ ุงูู ุจุฑุง thread</strong> ุงุฌุงุฏ ูโฺฉูุฏุ ููุงููุฏ ุงูฺฏู ฺฉู ุฏุฑ ุงุจุชุฏุง ุงู ุจุฎุด ุชูุถุญ ุฏุงุฏู ุดุฏโฺฉู ุฏุฑ ูุญุทโูุง <strong>single-threaded</strong> ููุงุณุจ ุงุณุช. โ</p>
<h3>ฺฉูุงุณ LazyInitializer โก</h3>
<p>ฺฉูุงุณ <strong>LazyInitializer</strong> ฺฉ ฺฉูุงุณ <strong>static</strong> ุงุณุช ฺฉู ุฏููุงู ูุงููุฏ <strong>Lazy<T></strong> ุนูู ูโฺฉูุฏุ ุจุง ุงู ุชูุงูุชโูุง:</p>
<ul>
<li>ุนููฺฉุฑุฏ ุขู ุงุฒ ุทุฑู ฺฉ <strong>ูุชุฏ static</strong> ุงุฑุงุฆู ูโุดูุฏ ฺฉู ูุณุชูู ุฑู <strong>ููุฏ ุฎูุฏุชุงู</strong> ุนูู ูโฺฉูุฏ. ุงู ุจุงุนุซ ูโุดูุฏ ฺฉ ุณุทุญ <strong>indirection</strong> ุญุฐู ุดูุฏ ู ุฏุฑ ุณูุงุฑููุง ฺฉู ุจู <strong>ุจูููโุณุงุฒ ุดุฏุฏ</strong> ูุงุฒ ุฏุงุฑุฏุ ุนููฺฉุฑุฏ ุจูุชุฑ ุดูุฏ.</li>
<li>ฺฉ <strong>ุญุงูุช ููุฏุงุฑุฏู ุฏฺฏุฑ</strong> ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุฏุฑ ุขู <strong>ฺูุฏู thread ูโุชูุงููุฏ ุจุฑุง ููุฏุงุฑุฏู ุฑูุงุจุช ฺฉููุฏ</strong>.</li>
</ul>
<p>ุจุฑุง ุงุณุชูุงุฏู ุงุฒ <strong>LazyInitializer</strong>ุ ูุจู ุงุฒ ุฏุณุชุฑุณ ุจู ููุฏุ <strong>EnsureInitialized</strong> ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ู <strong>ุงุฑุฌุงุน ููุฏ ู delegate ฺฉุงุฑุฎุงูู</strong> ุฑุง ูพุงุณ ุฏูุฏ:</p>
<pre class="hljs"><code>Expensive _expensive;
<span class="hljs-keyword">public</span> Expensive Expensive
{ 
    <span class="hljs-keyword">get</span>          <span class="hljs-comment">// ูพุงุฏูโุณุงุฒ double-checked locking</span>
    { 
        LazyInitializer.EnsureInitialized(<span class="hljs-keyword">ref</span> _expensive,
                                         () =&gt; <span class="hljs-keyword">new</span> Expensive());
        <span class="hljs-keyword">return</span> _expensive;
    }
}
</code></pre>
<p>ููฺูู ูโุชูุงูุฏ ฺฉ ุขุฑฺฏููุงู ุงุถุงู ูพุงุณ ุฏูุฏ ุชุง <strong>ฺูุฏ thread ุฑูุจ ุจุฑุง ููุฏุงุฑุฏู ุฑูุงุจุช ฺฉููุฏ</strong>. ุงู ุดุจู ูุซุงู thread-unsafe ุงููู ูุง ุงุณุชุ ุงูุง <strong>ุงููู thread ฺฉู ุชูุงู ูโุดูุฏ ููุดู ุจุฑูุฏู ุงุณุช</strong> ู ุฏุฑ ููุงุช ุชููุง ฺฉ ููููู ุฎูุงูุฏ ุฏุงุดุช.</p>
<p>ูุฒุช ุงู ุชฺฉูฺฉ ุงู ุงุณุช ฺฉู ุฏุฑ ุณุณุชูโูุง <strong>ฺูุฏ ูุณุชูโุง</strong> ุญุช ุณุฑุนโุชุฑ ุงุฒ <strong>double-checked locking</strong> ุงุณุชุ ุฒุฑุง ูโุชูุงูุฏ <strong>ฺฉุงููุงู ุจุฏูู lock</strong> ูพุงุฏูโุณุงุฒ ุดูุฏุ ุจุง ุงุณุชูุงุฏู ุงุฒ ุชฺฉูฺฉโูุง ูพุดุฑูุชูโุง ฺฉู ุฏุฑ ุจุฎุดโูุง ยซNonblocking Synchronizationยป ู ยซLazy Initializationยป ุฏุฑ <a href="http://albahari.com/threading">albahari.com/threading</a> ุชูุถุญ ุฏุงุฏู ุดุฏู ุงุณุช.</p>
<p>ุงู ฺฉ ุจูููโุณุงุฒ <strong>extreme ู ุจู ูุฏุฑุช ููุฑุฏ ูุงุฒ</strong> ุงุณุช ฺฉู ูุฒููโูุง ุฏุงุฑุฏ:</p>
<ul>
<li>ููุช ุชุนุฏุงุฏ threadูุง ุฑูุงุจุชโฺฉููุฏู ุจุฑุง ููุฏุงุฑุฏู ุงุฒ ุชุนุฏุงุฏ ูุณุชูโูุง ุจุดุชุฑ ุจุงุดุฏุ <strong>ฺฉูุฏุชุฑ ุงุณุช</strong>.</li>
<li>ููฺฉู ุงุณุช ููุงุจุน CPU ุตุฑู ุงูุฌุงู <strong>ููุฏุงุฑุฏู ุชฺฉุฑุงุฑ</strong> ุดูุฏ.</li>
<li>ููุทู ููุฏุงุฑุฏู ุจุงุฏ <strong>thread-safe</strong> ุจุงุดุฏ (ูุซูุงู ุงฺฏุฑ constructor ฺฉูุงุณ <strong>Expensive</strong> ุฏุงุฏูโุง ุฑุง ุจู ููุฏูุง static ูโููุดุช).</li>
<li>ุงฺฏุฑ initializer ุดุฆ ุงุฌุงุฏ ฺฉูุฏ ฺฉู ูุงุฒ ุจู <strong>disposal</strong> ุฏุงุฑุฏุ ุดุก ยซุงุถุงูยป ุจุฏูู ููุทู ุงุถุงูู <strong>dispose</strong> ููโุดูุฏ.</li>
</ul>
<hr>
<h3>ุฐุฎุฑูโุณุงุฒ ูุญู ุจุฑุง Threadโูุง (Thread-Local Storage) ๐งต</h3>
<p>ุจุฎุด ุฒุงุฏ ุงุฒ ุงู ูุตู ุฑู <strong>ุณูฺฉุฑููุฒุดู ู ูุดฺฉูุงุช ฺฉู ููฺฏุงู ุฏุณุชุฑุณ ููุฒูุงู threadูุง ุจู ฺฉ ุฏุงุฏู ุงุฌุงุฏ ูโุดูุฏ</strong> ุชูุฑฺฉุฒ ุฏุงุดุช.<br>
ฺฏุงู ุงููุงุชุ ูโุฎูุงูุฏ ุฏุงุฏูโูุง ุฑุง <strong>ุงุฒููู ูฺฏู ุฏุงุฑุฏ</strong> ู ูุทูุฆู ุดูุฏ ฺฉู <strong>ูุฑ thread ูุณุฎูโ ุฌุฏุงฺฏุงููโุง ุฏุงุฑุฏ</strong>.</p>
<ul>
<li>ูุชุบุฑูุง ูุญู ุฏููุงู ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏููุฏุ ุงูุง ููุท ุจุฑุง ุฏุงุฏูโูุง <strong>ูููุช</strong> ููุฏ ูุณุชูุฏ.</li>
<li><strong>ุฑุงู ุญู:</strong> <strong>Thread-local storage</strong>.</li>
</ul>
<p>ูุนูููุงู ุฏุงุฏูโูุง ฺฉู ูโุฎูุงูุฏ ุจู ฺฉ thread ุงุฎุชุตุงุต ุฏูุฏ <strong>ุจู ุทูุฑ ุทุจุน ูููุช</strong> ูุณุชูุฏ. ฺฉุงุฑุจุฑุฏ ุงุตู ุขูโูุง <strong>ุฐุฎุฑูโุณุงุฒ ุฏุงุฏูโูุง ยซุฎุงุฑุฌ ุงุฒ ูุณุฑ ุงุตูยป</strong> ุงุณุชโูุซู <strong>messagingุ transaction ู security tokens</strong>.<br>
ูพุงุณ ุฏุงุฏู ฺูู ุฏุงุฏูโูุง ุงุฒ ุทุฑู ูพุงุฑุงูุชุฑูุง ูุชุฏ ูโุชูุงูุฏ <strong>ุฏุณุช ู ูพุง ฺฏุฑ</strong> ุจุงุดุฏ ู ุฐุฎุฑู ุขูโูุง ุฏุฑ ููุฏูุง static ูุนููู ุจุงุนุซ <strong>ุจู ุงุดุชุฑุงฺฉ ฺฏุฐุงุดุชู ุฏุงุฏู ูุงู ููู threadูุง</strong> ูโุดูุฏ.</p>
<p><strong>Thread-local storage</strong> ููฺูู ุฏุฑ <strong>ุจูููโุณุงุฒ ฺฉุฏ ููุงุฒ</strong> ููุฏ ุงุณุชุ ุฒุฑุง ุจู ูุฑ thread ุงุฌุงุฒู ูโุฏูุฏ <strong>ูุณุฎูโ ุฎูุฏุด ุงุฒ ฺฉ ุดุก thread-unsafe</strong> ุฑุง ุจุฏูู lock ู ุจุฏูู ูุงุฒ ุจู ุจุงุฒุณุงุฒ ุจู ูุฑุงุฎูุงูโูุง ูุชุฏ ุฏุงุดุชู ุจุงุดุฏ.</p>
<hr>
<h4>ุฑูุดโูุง ูพุงุฏูโุณุงุฒ Thread-Local Storage</h4>
<p>ฑ. <strong>[ThreadStatic]</strong></p>
<p>ุณุงุฏูโุชุฑู ุฑูุดุ ุนูุงูุชโฺฏุฐุงุฑ ฺฉ <strong>ููุฏ static</strong> ุจุง <strong>ThreadStatic</strong> ุงุณุช:</p>
<pre class="hljs"><code>[<span class="hljs-meta">ThreadStatic</span>] <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _x;
</code></pre>
<p>ูุฑ thread ูุณุฎูโ ุฌุฏุงฺฏุงููโุง ุงุฒ <code>_x</code> ุฎูุงูุฏ ุฏุฏ.</p>
<p>โ๏ธ ูุญุฏูุฏุชโูุง:</p>
<ul>
<li>[ThreadStatic] ุจุง <strong>ููุฏูุง instance</strong> ฺฉุงุฑ ููโฺฉูุฏ.</li>
<li>ุจุง <strong>field initializers</strong> ุฎูุจ ฺฉุงุฑ ููโฺฉูุฏุ ุขูโูุง ุชููุง ฺฉ ุจุงุฑ ุฏุฑ threadโุง ฺฉู static constructor ุงุฌุฑุง ูโุดูุฏุ ุงุฌุฑุง ูโุดููุฏ.</li>
</ul>
<p>ุงฺฏุฑ ูุงุฒ ุฏุงุฑุฏ ุจุง <strong>ููุฏูุง instance</strong> ฺฉุงุฑ ฺฉูุฏ ุง <strong>ููุฏุงุฑ ุบุฑ ูพุดโูุฑุถ</strong> ุฏุงุดุชู ุจุงุดุฏุ <strong>ThreadLocal<T></strong> ฺฏุฒูู ุจูุชุฑ ุงุณุช.</p>
<hr>
<p>ฒ. <strong>ThreadLocal<T></strong></p>
<p>ฺฉูุงุณ <strong>ThreadLocal<T></strong> ุงูฺฉุงู <strong>ุฐุฎุฑูโุณุงุฒ ูุญู ุจุฑุง thread</strong> ุฑุง ูู ุจุฑุง ููุฏูุง static ู ูู instance ูุฑุงูู ูโฺฉูุฏ ู ุงุฌุงุฒู ูโุฏูุฏ <strong>ููุฏุงุฑ ูพุดโูุฑุถ</strong> ูุดุฎุต ฺฉูุฏ.</p>
<p>ูุซุงู: ุณุงุฎุช ฺฉ <strong>ThreadLocal<int></strong> ุจุง ููุฏุงุฑ ูพุดโูุฑุถ ณ ุจุฑุง ูุฑ thread:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> ThreadLocal&lt;<span class="hljs-built_in">int</span>&gt; _x = <span class="hljs-keyword">new</span> ThreadLocal&lt;<span class="hljs-built_in">int</span>&gt;(() =&gt; <span class="hljs-number">3</span>);
</code></pre>
<p>ุณูพุณ ุงุฒ property <strong>Value</strong> ุจุฑุง ุฏุฑุงูุช ุง ุชูุธู ููุฏุงุฑ ูุญู ูุฑ thread ุงุณุชูุงุฏู ูโฺฉูุฏ.</p>
<p>โ ูฺฉุชู: <strong>ููุฏุงุฑุฏู ุชูุจู</strong> ุงุณุชโdelegate ฺฉุงุฑุฎุงูู ููุท <strong>ุฏุฑ ุงููู ุฏุณุชุฑุณ ูุฑ thread</strong> ุงุฌุฑุง ูโุดูุฏ.</p>
<h3>ThreadLocal<T> ู ููุฏูุง Instance ๐งต</h3>
<p>ฺฉูุงุณ <strong>ThreadLocal<T></strong> ููฺูู ุจุฑุง <strong>ููุฏูุง instance</strong> ู <strong>local variableูุง capture ุดุฏู</strong> ููุฏ ุงุณุช.<br>
ุจุฑุง ูุซุงูุ ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ุฏุฑ ูุญุท <strong>ฺูุฏ threadโุง</strong> ุงุนุฏุงุฏ ุชุตุงุฏู ุชููุฏ ฺฉูู. ฺฉูุงุณ <strong>Random</strong> <strong>thread-safe ูุณุช</strong>ุ ุจูุงุจุฑุงู ุฏู ุฑุงู ุฏุงุฑู:</p>
<ol>
<li>ุงุณุชูุงุฏู ุงุฒ <strong>lock</strong> ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ Random (ฺฉู <strong>Concurrency</strong> ุฑุง ูุญุฏูุฏ ูโฺฉูุฏ).</li>
<li>ุชููุฏ ฺฉ <strong>ุดุก Random ุฌุฏุงฺฏุงูู ุจุฑุง ูุฑ thread</strong>.</li>
</ol>
<p>ุจุง <strong>ThreadLocal<T></strong>ุ ฺฏุฒูู ุฏูู ุฎู ุขุณุงู ูโุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> localRandom = <span class="hljs-keyword">new</span> ThreadLocal&lt;Random&gt;(() =&gt; <span class="hljs-keyword">new</span> Random());
Console.WriteLine(localRandom.Value.Next());
</code></pre>
<p>๐น ูฺฉุชู: ุชุงุจุน ฺฉุงุฑุฎุงูู ูุง ุจุฑุง ุงุฌุงุฏ ุดุก <strong>Random</strong> ฺฉู ุณุงุฏู ุงุณุชุ ฺูู ุณุงุฒูุฏู ุจุฏูู ูพุงุฑุงูุชุฑ Random ุงุฒ <strong>ุณุงุนุช ุณุณุชู</strong> ุจุฑุง seed ุงุณุชูุงุฏู ูโฺฉูุฏ. ุงู ููฺฉู ุงุณุช ุจุฑุง ุฏู ุดุก Random ฺฉู ุฏุฑ ุญุฏูุฏ <strong>ฑฐ ููโุซุงูู</strong> ุงุฒ ูู ุงุฌุงุฏ ุดุฏูโุงูุฏุ ฺฉุณุงู ุจุงุดุฏ.</p>
<p>ฺฉ ุฑูุด ุจุฑุง ุฑูุน ุงู ูุดฺฉู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> localRandom = <span class="hljs-keyword">new</span> ThreadLocal&lt;Random&gt;
(() =&gt; <span class="hljs-keyword">new</span> Random(Guid.NewGuid().GetHashCode()));
</code></pre>
<p>ุงู ุฑูุด ุฏุฑ <strong>ูุตู ฒฒ</strong> ุฏุฑ ูุซุงู <strong>parallel spellchecking</strong> (ุฏุฑ ุจุฎุด PLINQ ุตูุญู นณต) ุงุณุชูุงุฏู ุดุฏู ุงุณุช.</p>
<hr>
<h3>GetData ู SetData ๐ฆ</h3>
<p>ุฑูุด ุณูู ุงุณุชูุงุฏู ุงุฒ ุฏู ูุชุฏ ุฏุฑ ฺฉูุงุณ <strong>Thread</strong> ุงุณุช: <strong>GetData</strong> ู <strong>SetData</strong>.</p>
<ul>
<li>ุงู ูุชุฏูุง ุฏุงุฏูโูุง ุฑุง ุฏุฑ <strong>slotูุง ูุฎุตูุต thread</strong> ุฐุฎุฑู ูโฺฉููุฏ.</li>
<li><strong>Thread.GetData</strong> ุฏุงุฏู ุฑุง ุงุฒ <strong>ุฐุฎุฑูโุณุงุฒ ุงุฒููู thread</strong> ูโุฎูุงูุฏ.</li>
<li><strong>Thread.SetData</strong> ุฏุงุฏู ุฑุง ุฏุฑ ุขู ูโููุณุฏ.</li>
<li>ูุฑ ุฏู ูุชุฏ ูุงุฒ ุจู ฺฉ <strong>LocalDataStoreSlot</strong> ุจุฑุง ุดูุงุณุง slot ุฏุงุฑูุฏ.</li>
</ul>
<p>ูโุชูุงูุฏ ุงุฒ ููุงู slot ุจุฑุง ููู threadูุง ุงุณุชูุงุฏู ฺฉูุฏ ู ูุฑ thread ููฺูุงู <strong>ููุฏุงุฑ ุฌุฏุงฺฏุงููโุง</strong> ุฏุฑุงูุช ูโฺฉูุฏ. ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>
{
    <span class="hljs-comment">// ููุงู LocalDataStoreSlot ูโุชูุงูุฏ ุจุฑุง ููู threadูุง ุงุณุชูุงุฏู ุดูุฏ</span>
    LocalDataStoreSlot _secSlot = Thread.GetNamedDataSlot(<span class="hljs-string">&quot;securityLevel&quot;</span>);

    <span class="hljs-comment">// ุงู property ุจุฑุง ูุฑ thread ููุฏุงุฑ ุฌุฏุงฺฏุงูู ุฏุงุฑุฏ</span>
    <span class="hljs-built_in">int</span> SecurityLevel
    {
        <span class="hljs-keyword">get</span>
        {
            <span class="hljs-built_in">object</span> data = Thread.GetData(_secSlot);
            <span class="hljs-keyword">return</span> data == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : (<span class="hljs-built_in">int</span>)data; <span class="hljs-comment">// null == ููุฏุงุฑุฏู ูุดุฏู</span>
        }
        <span class="hljs-keyword">set</span> { Thread.SetData(_secSlot, <span class="hljs-keyword">value</span>); }
    }
}
</code></pre>
<p>ุฏุฑ ุงู ูุซุงูุ ุงุฒ <strong>Thread.GetNamedDataSlot</strong> ุงุณุชูุงุฏู ฺฉุฑุฏู ฺฉู ฺฉ <strong>slot ูุงูโฺฏุฐุงุฑโุดุฏู</strong> ุงุฌุงุฏ ูโฺฉูุฏโุงู ุงุฌุงุฒู ูโุฏูุฏ slot ุจู ููู ุจุฎุดโูุง ุจุฑูุงูู ุจู ุงุดุชุฑุงฺฉ ฺฏุฐุงุดุชู ุดูุฏ.<br>
ุจู ุทูุฑ ุฌุงฺฏุฒูุ ูโุชูุงูุฏ ุจุง ฺฉ slot ุจุฏูู ูุงูุ ฺฉู ุจุง <strong>Thread.AllocateDataSlot</strong> ุงุฌุงุฏ ุดุฏู ุงุณุชุ ฺฉูุชุฑู ูุญุฏูุฏู ุขู ุฑุง ุฎูุฏุชุงู ุฏุงุดุชู ุจุงุดุฏ:</p>
<pre class="hljs"><code>LocalDataStoreSlot _secSlot = Thread.AllocateDataSlot();
</code></pre>
<p>โ๏ธ ูฺฉุชู:</p>
<ul>
<li><strong>Thread.FreeNamedDataSlot</strong> ฺฉ slot ูุงูโฺฏุฐุงุฑโุดุฏู ุฑุง ุฏุฑ ููู threadูุง ุขุฒุงุฏ ูโฺฉูุฏุ ุงูุง ููุท ููุช ฺฉู <strong>ุชูุงู ุงุฑุฌุงุนุงุช ุจู ุขู LocalDataStoreSlot ุงุฒ ูุญุฏูุฏู ุฎุงุฑุฌ ุดุฏู ู garbage collected ุดุฏู ุจุงุดูุฏ</strong>.</li>
<li>ุงู ุชุถูู ูโฺฉูุฏ ฺฉู threadูุง slotูุง ุฏุงุฏู ุฎูุฏ ุฑุง ุงุฒ ุฏุณุช ูุฏููุฏุ ุชุง ุฒูุงู ฺฉู <strong>ุงุฑุฌุงุน ููุงุณุจ ุจู LocalDataStoreSlot</strong> ุฑุง ูฺฏู ุฏุงุดุชู ุจุงุดูุฏ.</li>
</ul>
<hr>
<h3>AsyncLocal<T> ๐</h3>
<p>ุฑูุดโูุง ูพุดู <strong>Thread-local storage</strong> ุจุง <strong>async functions</strong> ุณุงุฒฺฏุงุฑ ูุณุชูุฏุ ฺูู ุจุนุฏ ุงุฒ <strong>await</strong>ุ ุงุฌุฑุง ฺฉุฏ ูโุชูุงูุฏ ุฑู ฺฉ thread ุฏฺฏุฑ ุงุฏุงูู ูพุฏุง ฺฉูุฏ.</p>
<p>ฺฉูุงุณ <strong>AsyncLocal<T></strong> ุงู ูุดฺฉู ุฑุง ุญู ูโฺฉูุฏ ู ููุฏุงุฑ ุฎูุฏ ุฑุง <strong>ุจุนุฏ ุงุฒ await ุญูุธ ูโฺฉูุฏ</strong>:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> AsyncLocal&lt;<span class="hljs-built_in">string</span>&gt; _asyncLocalTest = <span class="hljs-keyword">new</span> AsyncLocal&lt;<span class="hljs-built_in">string</span>&gt;();

<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
{
    _asyncLocalTest.Value = <span class="hljs-string">&quot;test&quot;</span>;  
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);  
    <span class="hljs-comment">// ุญุช ุงฺฏุฑ ุฑู thread ุฏฺฏุฑ ุงุฏุงูู ูพุฏุง ฺฉููุ ุฏุฑุณุช ฺฉุงุฑ ูโฺฉูุฏ:</span>
    Console.WriteLine(_asyncLocalTest.Value);   <span class="hljs-comment">// test</span>
}
</code></pre>
<p><strong>AsyncLocal<T></strong> ููฺูู ูโุชูุงูุฏ ุนููุงุช ุดุฑูุนโุดุฏู ุฑู <strong>threadูุง ุฌุฏุงฺฏุงูู</strong> ุฑุง ุงุฒ ูู ุฌุฏุง ูฺฏู ุฏุงุฑุฏุ ฺู ุชูุณุท <strong>Thread.Start</strong> ู ฺู <strong>Task.Run</strong>:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> AsyncLocal&lt;<span class="hljs-built_in">string</span>&gt; _asyncLocalTest = <span class="hljs-keyword">new</span> AsyncLocal&lt;<span class="hljs-built_in">string</span>&gt;();

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
{
    <span class="hljs-comment">// Test ุฑุง ุฑู ุฏู thread ููุฒูุงู ุตุฏุง ุจุฒู</span>
    <span class="hljs-keyword">new</span> Thread(() =&gt; Test(<span class="hljs-string">&quot;one&quot;</span>)).Start();
    <span class="hljs-keyword">new</span> Thread(() =&gt; Test(<span class="hljs-string">&quot;two&quot;</span>)).Start();
}

<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span></span>)</span>
{
    _asyncLocalTest.Value = <span class="hljs-keyword">value</span>;
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
    Console.WriteLine(<span class="hljs-keyword">value</span> + <span class="hljs-string">&quot; &quot;</span> + _asyncLocalTest.Value);
}
<span class="hljs-comment">// ุฎุฑูุฌ: </span>
<span class="hljs-comment">// one one</span>
<span class="hljs-comment">// two two</span>
</code></pre>
<p>ฺฉ ูฺฉุชู ุฌุงูุจ ุฏุฑุจุงุฑู <strong>AsyncLocal<T></strong>:</p>
<ul>
<li>ุงฺฏุฑ ฺฉ ุดุก AsyncLocal<T> <strong>ูุจูุงู ููุฏุงุฑ ุฏุงุดุชู ุจุงุดุฏ</strong>ุ ููุช ฺฉ thread ุฌุฏุฏ ุดุฑูุน ุดูุฏุ thread ุฌุฏุฏ <strong>ุขู ููุฏุงุฑ ุฑุง ุจู ุงุฑุซ ูโุจุฑุฏ</strong>:</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">static</span> AsyncLocal&lt;<span class="hljs-built_in">string</span>&gt; _asyncLocalTest = <span class="hljs-keyword">new</span> AsyncLocal&lt;<span class="hljs-built_in">string</span>&gt;();

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
{
    _asyncLocalTest.Value = <span class="hljs-string">&quot;test&quot;</span>;
    <span class="hljs-keyword">new</span> Thread(AnotherMethod).Start();
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">AnotherMethod</span>()</span> =&gt; Console.WriteLine(_asyncLocalTest.Value);  <span class="hljs-comment">// test</span>
</code></pre>
<ul>
<li>ุจุง ุงู ุญุงูุ thread ุฌุฏุฏ <strong>ฺฉ ฺฉูพ ุงุฒ ููุฏุงุฑ ุฏุฑุงูุช ูโฺฉูุฏ</strong>ุ ุจูุงุจุฑุงู ูุฑ ุชุบุฑ ฺฉู ุฑู ุขู ุงูุฌุงู ุฏูุฏุ ุฑู ููุฏุงุฑ ุงุตู ุชุฃุซุฑ ููโฺฏุฐุงุฑุฏ:</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">static</span> AsyncLocal&lt;<span class="hljs-built_in">string</span>&gt; _asyncLocalTest = <span class="hljs-keyword">new</span> AsyncLocal&lt;<span class="hljs-built_in">string</span>&gt;();

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
{
    _asyncLocalTest.Value = <span class="hljs-string">&quot;test&quot;</span>;
    <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">new</span> Thread(AnotherMethod);
    t.Start(); t.Join();
    Console.WriteLine(_asyncLocalTest.Value);   <span class="hljs-comment">// test</span>
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">AnotherMethod</span>()</span> =&gt; _asyncLocalTest.Value = <span class="hljs-string">&quot;ha-ha!&quot;</span>;
</code></pre>
<p>โ๏ธ ุชูุฌู: thread ุฌุฏุฏ <strong>ฺฉ ฺฉูพ ุณุทุญ (shallow copy)</strong> ุงุฒ ููุฏุงุฑ ุฏุฑุงูุช ูโฺฉูุฏ.</p>
<ul>
<li>ุจูุงุจุฑุงู ุงฺฏุฑ <strong>Async<string></strong> ุฑุง ุจุง <strong>Async<StringBuilder></strong> ุง <strong>Async&lt;List<string>&gt;</strong> ุฌุงฺฏุฒู ฺฉูุฏุ thread ุฌุฏุฏ ูโุชูุงูุฏ <strong>StringBuilder ุฑุง ูพุงฺฉ ฺฉูุฏ ุง ุขุชูโูุง ุฑุง ุจู List ุงุถุงูู/ุญุฐู ฺฉูุฏ</strong> ู ุงู ุฑู ููุฏุงุฑ ุงุตู ุชุฃุซุฑ ุฎูุงูุฏ ฺฏุฐุงุดุช.</li>
</ul>
<h3>Timers โฑ๏ธ</h3>
<p>ุงฺฏุฑ ูุงุฒ ุฏุงุฑุฏ ฺฉ <strong>ูุชุฏ</strong> ุจู ุตูุฑุช <strong>ุฏูุฑูโุง ู ููุธู</strong> ุงุฌุฑุง ุดูุฏุ ุณุงุฏูโุชุฑู ุฑุงู ุงุณุชูุงุฏู ุงุฒ <strong>timer</strong> ุงุณุช.</p>
<p><strong>Timerูุง</strong> ูู ุฑุงุญุช ู ูู ุจููู ุงุฒ ูุธุฑ ุญุงูุธู ู ููุงุจุน ูุณุชูุฏุ ูุฎุตูุตุงู ุฏุฑ ููุงุณู ุจุง ุชฺฉูฺฉโูุง ุฒุฑ:</p>
<pre class="hljs"><code><span class="hljs-keyword">new</span> Thread(<span class="hljs-built_in">delegate</span>() {
    <span class="hljs-keyword">while</span> (enabled)
    {
        DoSomeAction();
        Thread.Sleep(TimeSpan.FromHours(<span class="hljs-number">24</span>));
    }
}).Start();
</code></pre>
<ul>
<li>ุงู ุฑูุด ฺฉ <strong>thread</strong> ุฑุง ุฏุงุฆูุงู ูุดุบูู ูฺฏู ูโุฏุงุฑุฏ.</li>
<li>ุจุฏูู ฺฉุฏููุณ ุงุถุงููุ ูุชุฏ <strong>DoSomeAction</strong> ูุฑ ุฑูุฒ ุฏุฑ ุฒูุงู ูุชูุงูุช ุงุฌุฑุง ูโุดูุฏ.</li>
<li><strong>Timers</strong> ุงู ูุดฺฉูุงุช ุฑุง ุญู ูโฺฉููุฏ.</li>
</ul>
<hr>
<p>.NET ูพูุฌ ููุน <strong>timer</strong> ุงุฑุงุฆู ูโุฏูุฏ:</p>
<h4>ฑ. Timerูุง ฺูุฏthreadโุง ุนููู</h4>
<ul>
<li><strong>System.Threading.Timer</strong></li>
<li><strong>System.Timers.Timer</strong></li>
</ul>
<h4>ฒ. Timerูุง ุชฺฉโthreadโุง ูฺู</h4>
<ul>
<li>
<p><strong>System.Windows.Forms.Timer</strong> (ุจุฑุง Windows Forms)</p>
</li>
<li>
<p><strong>System.Windows.Threading.DispatcherTimer</strong> (ุจุฑุง WPF)</p>
</li>
<li>
<p>Timerูุง ฺูุฏthreadโุง <strong>ูุฏุฑุชููุฏุชุฑุ ุฏููโุชุฑ ู ุงูุนุทุงูโูพุฐุฑุชุฑ</strong> ูุณุชูุฏ.</p>
</li>
<li>
<p>Timerูุง ุชฺฉโthreadโุง ุจุฑุง <strong>ุงุฌุฑุง ุณุงุฏู</strong> ู ุจูโุฑูุฒุฑุณุงู <strong>ฺฉูุชุฑูโูุง Windows Forms ุง ุนูุงุตุฑ WPF</strong> ุงููโุชุฑ ู ุฑุงุญุชโุชุฑูุฏ.</p>
</li>
<li>
<p>ุงุฒ <strong>.NET 6</strong>ุ ฺฉ Timer ุฌุฏุฏ ุจู ูุงู <strong>PeriodicTimer</strong> ุงุถุงูู ุดุฏู ฺฉู ุงุจุชุฏุง ุจู ุขู ูโูพุฑุฏุงุฒู.</p>
</li>
</ul>
<hr>
<h3>PeriodicTimer ๐</h3>
<p><strong>PeriodicTimer</strong> ุฏุฑ ูุงูุน ฺฉ timer ุณูุช ูุณุชุ ุจูฺฉู <strong>ฺฉูุงุณ ุจุฑุง ุณุงุฏูโุณุงุฒ ุญูููโูุง asynchronous</strong> ุงุณุช.</p>
<p>ุจุง ุธููุฑ <strong>async ู await</strong>ุ ูุนูููุงู ุจู timerูุง ุณูุช ูุงุฒ ูุณุช. ุจู ุฌุง ุขูุ ุงูฺฏู ุฒุฑ ุฎูุจ ฺฉุงุฑ ูโฺฉูุฏ:</p>
<pre class="hljs"><code>StartPeriodicOperation();

<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StartPeriodicOperation</span>()</span>
{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
    {
        <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
        Console.WriteLine(<span class="hljs-string">&quot;Tick&quot;</span>);   <span class="hljs-comment">// ุงูุฌุงู ฺฉ ุนููุงุช</span>
    }
}
</code></pre>
<ul>
<li>ุงฺฏุฑ ุงู ฺฉุฏ ุฑุง ุงุฒ <strong>UI thread</strong> ูุฑุงุฎูุงู ฺฉูุฏุ ูุงููุฏ ฺฉ <strong>timer ุชฺฉโthreadโุง</strong> ุฑูุชุงุฑ ุฎูุงูุฏ ฺฉุฑุฏุ ฺูู <strong>await</strong> ููุดู ุฑู ููุงู <strong>synchronization context</strong> ุจุฑูโฺฏุฑุฏุฏ.</li>
<li>ุจุฑุง ุฑูุชุงุฑ ุจู ุตูุฑุช <strong>multi-threaded timer</strong> ฺฉุงู ุงุณุช <strong>.ConfigureAwait(false)</strong> ุจู await ุงุถุงูู ฺฉูุฏ.</li>
</ul>
<p><strong>PeriodicTimer</strong> ุงู ุงูฺฏู ุฑุง ุณุงุฏู ูโฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> timer = <span class="hljs-keyword">new</span> PeriodicTimer(TimeSpan.FromSeconds(<span class="hljs-number">1</span>));
StartPeriodicOperation();

<span class="hljs-comment">// ุงุฎุชุงุฑ: ููุช ูโุฎูุงูุฏ ุญููู ุฑุง ูุชููู ฺฉูุฏุ timer ุฑุง dispose ฺฉูุฏ.</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StartPeriodicOperation</span>()</span>
{
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">await</span> timer.WaitForNextTickAsync())
        Console.WriteLine(<span class="hljs-string">&quot;Tick&quot;</span>);    <span class="hljs-comment">// ุงูุฌุงู ฺฉ ุนููุงุช</span>
}
</code></pre>
<ul>
<li>ููฺูู ูโุชูุงู ุจุง <strong>dispose ฺฉุฑุฏู</strong> ููููู <strong>PeriodicTimer</strong>ุ timer ุฑุง ูุชููู ฺฉุฑุฏ.</li>
<li>ุฏุฑ ุงู ุตูุฑุช <strong>WaitForNextTickAsync</strong> ููุฏุงุฑ <strong>false</strong> ุจุฑูโฺฏุฑุฏุงูุฏ ู ุญููู ูพุงุงู ูโุงุจุฏ.</li>
</ul>
<h3>ุชุงูุฑูุง ฺูุฏโูุฎ โฑ๏ธ๐งต</h3>
<p><strong>System.Threading.Timer</strong> ุณุงุฏูโุชุฑู <strong>timer ฺูุฏโูุฎ</strong> ุงุณุช: ููุท ฺฉ <strong>constructor</strong> ู ุฏู <strong>method</strong> ุฏุงุฑุฏ (ุจุฑุง ูููุงูุณุชโูุง ู ููุณูุฏฺฏุงู ฺฉุชุงุจโูุง ูุงูุนุงู ูุฐุชโุจุฎุด!).</p>
<p>ุฏุฑ ูุซุงู ุฒุฑุ ฺฉ <strong>timer</strong> ูุชุฏ <strong>Tick</strong> ุฑุง ุตุฏุง ูโุฒูุฏุ ฺฉู ุจุนุฏ ุงุฒ ต ุซุงูู <code>&quot;tick...&quot;</code> ุฑุง ฺุงูพ ูโฺฉูุฏ ู ุณูพุณ ูุฑ ุซุงูู ฺฉโุจุงุฑ ุงู ฺฉุงุฑ ุฑุง ุชฺฉุฑุงุฑ ูโฺฉูุฏุ ุชุง ุฒูุงู ฺฉู ฺฉุงุฑุจุฑ <strong>Enter</strong> ุฑุง ูุดุงุฑ ุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading;

<span class="hljs-comment">// ุงููู ูุงุตูู = 5000msุ ููุงุตู ุจุนุฏ = 1000ms</span>
Timer tmr = <span class="hljs-keyword">new</span> Timer(Tick, <span class="hljs-string">&quot;tick...&quot;</span>, <span class="hljs-number">5000</span>, <span class="hljs-number">1000</span>);

Console.ReadLine();
tmr.Dispose();  <span class="hljs-comment">// ูู timer ุฑุง ูุชููู ูโฺฉูุฏ ู ูู ููุงุจุน ุฑุง ุขุฒุงุฏ ูโฺฉูุฏ.</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Tick</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> data</span>)</span>
{
    <span class="hljs-comment">// ุงู ุฑู ฺฉ pooled thread ุงุฌุฑุง ูโุดูุฏ</span>
    Console.WriteLine(data);  <span class="hljs-comment">// ฺุงูพ &quot;tick...&quot;</span>
}
</code></pre>
<ul>
<li>ุจุฑุง ุชุบุฑ ูุงุตููโ ุงุฌุฑุง timer ุจุนุฏ ุงุฒ ุณุงุฎุช ุขูุ ูโุชูุงู ุงุฒ ูุชุฏ <strong>Change</strong> ุงุณุชูุงุฏู ฺฉุฑุฏ.</li>
<li>ุงฺฏุฑ ุจุฎูุงูุฏ timer ููุท ฺฉโุจุงุฑ ุงุฌุฑุง ุดูุฏุ ุงุฒ <strong>Timeout.Infinite</strong> ุฏุฑ ุขุฑฺฏููุงู ุขุฎุฑ <strong>constructor</strong> ุงุณุชูุงุฏู ฺฉูุฏ.</li>
</ul>
<hr>
<p>.NET ฺฉ ฺฉูุงุณ <strong>timer</strong> ุฏฺฏุฑ ุจุง ููุงู ูุงู ุฏุฑ ูุถุง ูุงู <strong>System.Timers</strong> ุฏุงุฑุฏ. ุงู ฺฉูุงุณุ <strong>System.Threading.Timer</strong> ุฑุง wrap ูโฺฉูุฏ ู ุงูฺฉุงูุงุช ุฑุงุญุชโุชุฑ ู ุงุถุงู ุงุฑุงุฆู ูโุฏูุฏุ ุฏุฑ ุญุงู ฺฉู ููุชูุฑ ุงุตู ููุงู ุงุณุช. ูฺฺฏโูุง ุงุถุงูู ุดุฏู ุนุจุงุฑุชโุงูุฏ ุงุฒ:</p>
<ul>
<li>ูพุงุฏูโุณุงุฒ <strong>IComponent</strong> ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ <strong>Designer</strong> ูฺูุงู ุงุณุชูุฏู</li>
<li><strong>Interval</strong> ุจู ุฌุง ูุชุฏ <strong>Change</strong></li>
<li><strong>Elapsed event</strong> ุจู ุฌุง <strong>callback delegate</strong></li>
<li><strong>Enabled property</strong> ุจุฑุง ุดุฑูุน ู ุชููู timer (ููุฏุงุฑ ูพุดโูุฑุถ = false)</li>
<li>ูุชุฏูุง <strong>Start</strong> ู <strong>Stop</strong></li>
<li><strong>AutoReset flag</strong> ุจุฑุง ูุดุฎุต ฺฉุฑุฏู ุงุฌุฑุง ุฏูุฑูโุง (ููุฏุงุฑ ูพุดโูุฑุถ = true)</li>
<li><strong>SynchronizingObject</strong> ุจุง ูุชุฏูุง <strong>Invoke</strong> ู <strong>BeginInvoke</strong> ุจุฑุง ูุฑุงุฎูุงู ุงูู ูุชุฏูุง ุฑู ุนูุงุตุฑ WPF ู ฺฉูุชุฑูโูุง Windows Forms</li>
</ul>
<p>ูุซุงู ุงุฒ ุขู:</p>
<pre class="hljs"><code><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Timers;  <span class="hljs-comment">// ูุถุง ูุงู Timers</span>

<span class="hljs-keyword">var</span> tmr = <span class="hljs-keyword">new</span> Timer(); <span class="hljs-comment">// ุจุฏูู ูุงุฒ ุจู ุขุฑฺฏููุงู</span>
tmr.Interval = <span class="hljs-number">500</span>;
tmr.Elapsed += tmr_Elapsed;  <span class="hljs-comment">// ุงุณุชูุงุฏู ุงุฒ event ุจู ุฌุง delegate</span>
tmr.Start();                 <span class="hljs-comment">// ุดุฑูุน timer</span>
Console.ReadLine();
tmr.Stop();                  <span class="hljs-comment">// ุชููู timer</span>
Console.ReadLine();
tmr.Start();                 <span class="hljs-comment">// ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ timer</span>
Console.ReadLine();
tmr.Dispose();               <span class="hljs-comment">// ูุชููู ฺฉุฑุฏู ุฏุงุฆู timer</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">tmr_Elapsed</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, EventArgs e</span>)</span>
    =&gt; Console.WriteLine(<span class="hljs-string">&quot;Tick&quot;</span>);
</code></pre>
<ul>
<li>
<p><strong>Timerูุง ฺูุฏโูุฎ</strong> ุงุฒ <strong>thread pool</strong> ุงุณุชูุงุฏู ูโฺฉููุฏ ุชุง ฺูุฏ thread ุจุชูุงููุฏ ุจู ุชุนุฏุงุฏ ุฒุงุฏ timer ุณุฑูุณ ุจุฏููุฏ.</p>
</li>
<li>
<p>ุจูุงุจุฑุงูุ callback ุง event handler ููฺฉู ุงุณุช ูุฑ ุจุงุฑ ุฑู <strong>thread ูุชูุงูุช</strong> ุงุฌุฑุง ุดูุฏ.</p>
</li>
<li>
<p>ููฺููุ <strong>Elapsed event</strong> ุชูุฑุจุงู ููุดู ุจู ูููุน ุงุฌุฑุง ูโุดูุฏุ ุญุช ุงฺฏุฑ ุงุฌุฑุง ูุจู ูููุฒ ุชูุงู ูุดุฏู ุจุงุดุฏ.</p>
</li>
<li>
<p>ูพุณ callbackูุง ู event handlerูุง ุจุงุฏ <strong>thread-safe</strong> ุจุงุดูุฏ.</p>
</li>
<li>
<p>ุฏูุช timerูุง ฺูุฏโูุฎ ุจู ุณุณุชูโุนุงูู ูุงุจุณุชู ุงุณุช ู ูุนูููุงู ุญุฏูุฏ <strong>ฑฐ ุชุง ฒฐ ููโุซุงูู</strong> ุงุณุช.</p>
</li>
<li>
<p>ุจุฑุง ุฏูุช ุจุงูุงุชุฑุ ูโุชูุงู ุงุฒ <strong>Windows multimedia timer</strong> ุงุณุชูุงุฏู ฺฉุฑุฏ ฺฉู ุฏูุช ุขู ุชุง <strong>ฺฉ ููโุซุงูู</strong> ุงุณุช ู ุฏุฑ <strong>winmm.dll</strong> ุชุนุฑู ุดุฏู.</p>
</li>
</ul>
<hr>
<h3>ุชุงูุฑูุง ุชฺฉโูุฎ ๐งต๐ฅ๏ธ</h3>
<p>.NET ุชุงูุฑูุง ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุจุฑุง <strong>ุญุฐู ูุดฺฉูุงุช thread-safety</strong> ุฏุฑ ุจุฑูุงููโูุง <strong>WPF ู Windows Forms</strong> ุทุฑุงุญ ุดุฏูโุงูุฏ:</p>
<ul>
<li>
<p><strong>System.Windows.Threading.DispatcherTimer</strong> (WPF)</p>
</li>
<li>
<p><strong>System.Windows.Forms.Timer</strong> (Windows Forms)</p>
</li>
<li>
<p>ุงู ุชุงูุฑูุง ุจุฑุง ูุญุทโูุง ูุฑุจูุทู ุทุฑุงุญ ุดุฏูโุงูุฏ ู ุฎุงุฑุฌ ุงุฒ ุขู ูุญุทโูุง ฺฉุงุฑ ููโฺฉููุฏ.</p>
</li>
<li>
<p>ุจู ุนููุงู ูุซุงูุ ุงุณุชูุงุฏู ุงุฒ Windows Forms Timer ุฏุฑ ฺฉ <strong>Windows Service</strong> ุจุงุนุซ ูโุดูุฏ event ุชุงูุฑ ุงุฌุฑุง ูุดูุฏ!</p>
</li>
<li>
<p>ุงู ุชุงูุฑูุง ูุดุงุจู <strong>System.Timers.Timer</strong> ุนูู ูโฺฉููุฏ ู <strong>Intervalุ Startุ Stop</strong> ู <strong>Tick</strong> ุฏุงุฑูุฏุ ุงูุง ุฏุฑ ุงุฌุฑุง ุฏุงุฎู ูุชูุงูุช ูุณุชูุฏ:</p>
<ul>
<li>ุจู ุฌุง ุงุฌุฑุง event ุฑู <strong>pooled threads</strong>ุ event ุฑุง ุจู <strong>message loop</strong> ูุญุท WPF ุง Windows Forms ุงุฑุณุงู ูโฺฉููุฏ.</li>
<li>ุจูุงุจุฑุงู <strong>Tick</strong> ููุดู ุฑู ููุงู thread ฺฉู timer ุณุงุฎุชู ุดุฏูุ ุงุฌุฑุง ูโุดูุฏ.</li>
<li>ุงู thread ูุนูููุงู ููุงู thread ูุฏุฑุช ุชูุงู ุนูุงุตุฑ ู ฺฉูุชุฑูโูุง UI ุงุณุช.</li>
</ul>
</li>
</ul>
<p>ูุฒุงุง ุงู ุฑูุด:</p>
<ul>
<li>
<p>ุฏฺฏุฑ ูุงุฒ ุจู ูฺฏุฑุงู ุฏุฑุจุงุฑู <strong>thread safety</strong> ูุณุช.</p>
</li>
<li>
<p>ุงุฌุฑุง ุจุนุฏ Tick ุชุง ุฒูุงู ฺฉู Tick ูุจู ุชูุงู ูุดุฏู ุจุงุดุฏุ ุดุฑูุน ููโุดูุฏ.</p>
</li>
<li>
<p>ูโุชูุงู ุนูุงุตุฑ ู ฺฉูุชุฑูโูุง UI ุฑุง ูุณุชููุงู ุงุฒ Tick ุจูโุฑูุฒุฑุณุงู ฺฉุฑุฏุ ุจุฏูู ูุงุฒ ุจู <strong>Control.BeginInvoke</strong> ุง <strong>Dispatcher.BeginInvoke</strong>.</p>
</li>
<li>
<p>ุจุฑูุงููโูุง ฺฉู ุงุฒ ุงู ุชุงูุฑูุง ุงุณุชูุงุฏู ูโฺฉููุฏุ ูุงูุนุงู <strong>multithreaded</strong> ูุณุชูุฏุ ููุน <strong>pseudo-concurrency</strong> ุดุจู ูุตู ฑด ุจุง asynchronous functions ุฑู UI thread ุฏุงุฑูุฏ.</p>
</li>
<li>
<p>ุงู ุชุงูุฑูุง ุจุฑุง <strong>ฺฉุงุฑูุง ฺฉูฺฺฉ</strong> ู ูุนูููุงู ุจูโุฑูุฒุฑุณุงู UI ููุงุณุจโุงูุฏ (ูุซูุงู ููุงุด ุณุงุนุช ุง countdown).</p>
</li>
<li>
<p>ุงุฒ ูุธุฑ ุฏูุชุ ุชุงูุฑูุง ุชฺฉโูุฎ ูุดุงุจู ุชุงูุฑูุง ฺูุฏโูุฎ ูุณุชูุฏ (ุฏูโูุง ููโุซุงูู)ุ ุงูุง ูุนูููุงู ฺฉู ฺฉูุชุฑ ุฏููโุงูุฏ ฺูู ููฺฉู ุงุณุช ููฺฏุงู ูพุฑุฏุงุฒุด ุฏุฑุฎูุงุณุชโูุง ุฏฺฏุฑ UI ุง eventูุง ุชุงูุฑ ุชุฃุฎุฑ ุงุฌุงุฏ ุดูุฏ.</p>
</li>
</ul>

</main>


 

  <!-- ููุชุฑ ูุดุชุฑฺฉ -->
  <footer class="footer">
    <div class="container">
      <p>
        <img src="/icone/copyright.svg" alt="ฺฉูพโุฑุงุช" width="14" height="14"
             style="vertical-align:middle;margin-inline:4px">
        <span id="y"></span> Gitab โ ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู
      </p>
    </div>
  </footer>

  <!-- ุณุงู + ุงุณฺฉุฑูพุช ุชู -->
<script>
(() => {
  const root = document.documentElement;
  const btn = document.getElementById('themeToggle');
  const KEY = 'gitab-theme';
  const media = window.matchMedia('(prefers-color-scheme: dark)');
  const getEffective = s => (s === 'auto' ? (media.matches ? 'dark' : 'light') : s);

  function updateTheme(s) {
    root.setAttribute('data-theme', s);
    const mode = getEffective(s);
    root.dataset.colorMode = mode;
    btn.dataset.icon = mode === 'dark' ? 'moon' : 'sun';
  }

  // ููุฏุงุฑ ุฐุฎุฑูโุดุฏู ุง ูพุดโูุฑุถ
  let saved = localStorage.getItem(KEY) || 'auto';
  updateTheme(saved);

  btn.addEventListener('click', () => {
    // ุจูโุฑูุฒุฑุณุงู ููุฑ ุชู
    const current = localStorage.getItem(KEY) || 'auto';
    const next = current === 'auto' ? 'dark' : current === 'dark' ? 'light' : 'auto';
    localStorage.setItem(KEY, next);
    updateTheme(next);
  });

  // ููุช ุชู ุณุณุชู ุชุบุฑ ฺฉูู ู ุญุงูุช auto ูุนุงููุ ุชู ุจูโุฑูุฒุฑุณุงู ูุดู
  media.addEventListener('change', () => {
    if ((localStorage.getItem(KEY) || 'auto') === 'auto') updateTheme('auto');
  });

  // ุงุทููุงู ุงุฒ ููโุฒูุงู ุจู DOM ู localStorage
  document.addEventListener('DOMContentLoaded', () => {
    updateTheme(localStorage.getItem(KEY) || 'auto');
  });
})();
</script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

<script>
document.querySelectorAll('pre code').forEach(block => {
  const btn = document.createElement('button');
  btn.className = 'copy-btn';

  const icon = document.createElement('img');
  icon.src = '/icone/copy.svg';
  icon.alt = 'Copy';
  btn.appendChild(icon);

  block.parentNode.insertBefore(btn, block);

  btn.addEventListener('click', async () => {
    await navigator.clipboard.writeText(block.textContent);
    btn.classList.add('copied');
    setTimeout(() => btn.classList.remove('copied'), 1500);
  });
});
</script>
<script>
  document.body.dataset.page = window.location.pathname;
</script>
<script>
  // ุจุงุฒ ู ุจุณุชู ฺฉุฑุฏู ููู ููุจุงู
  const menuBtn = document.querySelector(".menu-toggle");
  const nav = document.querySelector(".nav");

  if (menuBtn && nav) {
    // ุจุงุฒ ู ุจุณุชู ุดุฏู ุจุง ุฏฺฉูู
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation(); // ูุฐุงุฑู ฺฉูฺฉ ุฑู ุฎูุฏ ุฏฺฉูู ุจุงุนุซ ุจุณุชู ุดุฏู ุจุดู
      nav.classList.toggle("show");
    });

    // ุจุณุชู ููู ุจุง ฺฉูฺฉ ุจุฑูู
    document.addEventListener("click", (e) => {
      const clickedInsideNav = nav.contains(e.target);
      const clickedMenuButton = menuBtn.contains(e.target);
      if (!clickedInsideNav && !clickedMenuButton) {
        nav.classList.remove("show");
      }
    });
  }
</script>



</body>

</html>
