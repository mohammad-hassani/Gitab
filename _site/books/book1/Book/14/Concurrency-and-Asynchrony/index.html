

<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="/Gitab/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ููโุฒูุงู ู ูุงููโุฒูุงู</title>
  <meta name="description" content="ุชุฑุฌููโูุง ูุงุฑุณ ฺฉุชุงุจโูุง ูู โ ุณุฑุนุ ูููุงู ู ูุงุจู ุงุชฺฉุง.">

  <!-- ุงุณุชุงูโูุง -->
  <link rel="stylesheet" href="/Gitab/styles/main.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

  <style>
  @font-face {
    font-family: 'Vazir';
    src: url('/Gitab/fonts/Vazir-FD-WOL.ttf') format('truetype');
    font-display: swap;
  }
  body {
    font-family: 'Vazir', sans-serif;
  }
  </style>
</head>

<body>
  <!-- ูุฏุฑ ูุดุชุฑฺฉ -->
  <header class="header">
    <div class="container nav-wrap">
      <a href="/Gitab/" class="brand">
        <img src="/Gitab/icone/logo.svg" alt="Gitab logo" width="26" height="26">
        <span>Gitab</span>
      </a>

      <nav class="nav">
        <a href="/Gitab/" aria-current="page">ุฎุงูู</a>
        <a href="/Gitab/books/list-books">ฺฉุชุงุจโูุง</a>
       <a href="/Gitab/translator.html">ูุชุฑุฌูู</a>
        <a href="/Gitab/giter.html">ฺฏุชุฑ</a>
      </nav>

      <div class="nav-actions">
        <button id="themeToggle" class="icon-btn theme-btn" data-icon="moon" aria-label="ุชุบุฑ ุชู">
          <img src="/Gitab/icone/sun.svg" class="icon-sun" alt="ุฑูุดู">
          <img src="/Gitab/icone/moon.svg" class="icon-moon" alt="ุชุงุฑฺฉ">
        </button>

        <a class="icon-btn" href="https://github.com/hheydarian/Gitab" target="_blank" title="GitHub">
          <img src="/Gitab/icone/github.svg" alt="GitHub">
        </a>

        <!-- ุฏฺฉูู ููู ุจุฑุง ููุจุงู -->
        <button class="menu-toggle" aria-label="ููู">
          <img src="/Gitab/icone/menu.svg" alt="menu">
        </button>
      </div>
    </div>
  </header>

  
  <main class="site-main book-page">
    <h1>ูุตู ฺูุงุฑุฏูู: ููโุฒูุงู ู ูุงููโุฒูุงู</h1>
<p>ุจุดุชุฑ ุจุฑูุงููโูุง ูุงุฒ ุฏุงุฑูุฏ ุจุง ุจุด ุงุฒ ฺฉ ุฑูุฏุงุฏ ฺฉู ุจูโุทูุฑ ููโุฒูุงู ุฑุฎ ูโุฏูุฏ ุณุฑูฺฉุงุฑ ุฏุงุดุชู ุจุงุดูุฏ (ููโุฒูุงู ุง <strong>Concurrency</strong>).<br>
ุฏุฑ ุงู ูุตูุ ูุง ุจุง ูพุดโูุงุฒูุง ุถุฑูุฑ ุดุฑูุน ูโฺฉููุ ุนู ูุจุงู <strong>Threading</strong> (ุงุฌุงุฏ ู ูุฏุฑุช ุฑุดุชูโูุง) ู <strong>Tasks</strong> (ูุธุงู)ุ ู ุณูพุณ ุงุตูู <strong>Asynchrony</strong> (ูุงููโุฒูุงู) ู ุชูุงุจุน ูุงููโุฒูุงู ุฏุฑ #C ุฑุง ุจุง ุฌุฒุฆุงุช ุชูุถุญ ูโุฏูู.</p>
<p>ุฏุฑ <strong>ูุตู ฒฑ</strong> ุฏูุจุงุฑู ุจู ููุถูุน <strong>Multithreading</strong> (ฺูุฏโุฑุดุชูโุง) ุจุง ุฌุฒุฆุงุช ุจุดุชุฑ ุจุฑูโฺฏุฑุฏู ู ุฏุฑ <strong>ูุตู ฒฒ</strong> ููุถูุน ูุฑุชุจุท ุนู <strong>Parallel Programming</strong> (ุจุฑูุงููโููุณ ููุงุฒ) ุฑุง ูพูุดุด ูโุฏูู.</p>
<hr>
<h2>๐น ููุฏูู</h2>
<p>ุฏุฑ ุงุฏุงูู ุฑุงุฌโุชุฑู ุณูุงุฑููุง ููโุฒูุงู ุขูุฑุฏู ุดุฏู ุงุณุช:</p>
<h3>๐ฅ๏ธ ููุดุชู ฺฉ ุฑุงุจุท ฺฉุงุฑุจุฑ ูพุงุณุฎโฺฏู</h3>
<p>ุฏุฑ ุจุฑูุงููโูุง <strong>WPF</strong>ุ ููุจุงู ู <strong>Windows Forms</strong> ุจุงุฏ ฺฉุงุฑูุง ุฒูุงูโุจุฑ ุฑุง ุจูโุตูุฑุช ููโุฒูุงู ุจุง ฺฉุฏ ฺฉู ุฑุงุจุท ฺฉุงุฑุจุฑ ุดูุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ุงูุฌุงู ุฏูุฏ ุชุง ุฑุงุจุท ฺฉุงุฑุจุฑ ููฺูุงู ูพุงุณุฎโฺฏู ุจุงู ุจูุงูุฏ.</p>
<h3>๐ ูพุฑุฏุงุฒุด ููโุฒูุงู ุฏุฑุฎูุงุณุชโูุง</h3>
<p>ุฑู ฺฉ ุณุฑูุฑุ ุฏุฑุฎูุงุณุชโูุง ฺฉูุงูุช ูโุชูุงููุฏ ุจูโุทูุฑ ููโุฒูุงู ุจุฑุณูุฏ ู ุจูุงุจุฑุงู ุจุงุฏ ุจูโุตูุฑุช ููุงุฒ ูพุฑุฏุงุฒุด ุดููุฏ ุชุง <strong>Scalability</strong> (ููุงุณโูพุฐุฑ) ุญูุธ ุดูุฏ. ุงฺฏุฑ ุงุฒ <strong><a href="http://ASP.NET">ASP.NET</a> Core</strong> ุง <strong>Web API</strong> ุงุณุชูุงุฏู ฺฉูุฏุ ุฒูุงูโุงุฌุฑุง (Runtime) ุงู ฺฉุงุฑ ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุจุฑุง ุดูุง ุงูุฌุงู ูโุฏูุฏ.<br>
ุจุงุงูโุญุงูุ ููฺูุงู ุจุงุฏ ูุณุจุช ุจู <strong>Shared State</strong> (ูุถุนุช ูุดุชุฑฺฉ) ุขฺฏุงู ุจุงุดุฏ (ุจุฑุง ูููููุ ุงุซุฑ ุงุณุชูุงุฏู ุงุฒ <strong>Static Variables</strong> ุจุฑุง ฺฉุดโฺฉุฑุฏู).</p>
<h3>โก ุจุฑูุงููโููุณ ููุงุฒ</h3>
<p>ฺฉุฏ ฺฉู ูุญุงุณุจุงุช ุณูฺฏู ุงูุฌุงู ูโุฏูุฏ ูโุชูุงูุฏ ุฑู ุฑุงุงููโูุง ฺูุฏโูุณุชูโุง ุง ฺูุฏโูพุฑุฏุงุฒูุฏูโุง ุณุฑุนโุชุฑ ุงุฌุฑุง ุดูุฏุ ุงฺฏุฑ ุญุฌู ฺฉุงุฑ ูุงู ูุณุชูโูุง ุชูุณู ุดูุฏ. (ูุตู ฒฒ ุจูโุทูุฑ ฺฉุงูู ุจู ุงู ููุถูุน ุงุฎุชุตุงุต ุฏุงุฑุฏ.)</p>
<h3>๐ฎ ุงุฌุฑุง ุญุฏุณ (Speculative Execution)</h3>
<p>ุฑู ูุงุดูโูุง ฺูุฏโูุณุชูโุงุ ฺฏุงู ูโุชูุงู ุจุง ูพุดโุจู ฺฉุงุฑ ฺฉู ููฺฉู ุงุณุช ูุงุฒ ุจู ุงูุฌุงู ุขู ุจุงุดุฏ ู ุงูุฌุงู ุฏุงุฏู ุขู ุงุฒ ูุจูุ ุนููฺฉุฑุฏ ุฑุง ุจูุจูุฏ ุฏุงุฏ.<br>
ุจุฑูุงูู <strong>LINQPad</strong> ุงุฒ ุงู ุชฺฉูฺฉ ุจุฑุง ุณุฑุนุชโุจุฎุดุฏู ุจู ุงุฌุงุฏ ฺฉูุฆุฑโูุง ุฌุฏุฏ ุงุณุชูุงุฏู ูโฺฉูุฏ.<br>
ููุน ุฏฺฏุฑ ุงุฒ ุงู ุฑูุด ุงู ุงุณุช ฺฉู ฺูุฏ ุงูฺฏูุฑุชู ูุฎุชูู ุฑุง ุจูโุทูุฑ ููุงุฒ ุงุฌุฑุง ฺฉูุฏ ฺฉู ููฺฏ ฺฉ ูุธูู ูุดุงุจู ุฑุง ุญู ูโฺฉููุฏ. ูุฑฺฉุฏุงู ุฒูุฏุชุฑ ุชูุงู ุดูุฏ ยซุจุฑูุฏูยป ุฎูุงูุฏ ุจูุฏ. ุงู ุฑูุด ุฒูุงู ูุคุซุฑ ุงุณุช ฺฉู ุงุฒ ูุจู ูุฏุงูุฏ ฺฉุฏุงู ุงูฺฏูุฑุชู ุณุฑุนโุชุฑ ุนูู ุฎูุงูุฏ ฺฉุฑุฏ.</p>
<hr>
<h2>๐งต ูฺฉุงูุฒู ุนููู ููโุฒูุงู: Multithreading</h2>
<p>ูฺฉุงูุฒู ุนูููโุง ฺฉู ุจู ฺฉ ุจุฑูุงูู ุงุฌุงุฒู ูโุฏูุฏ ุจูโุทูุฑ ููโุฒูุงู ฺฉุฏ ุฑุง ุงุฌุฑุง ฺฉูุฏุ <strong>Multithreading</strong> ูุงู ุฏุงุฑุฏ.<br>
Multithreading ูู ุชูุณุท <strong>CLR</strong> ู ูู ุชูุณุท <strong>ุณุณุชูโุนุงูู</strong> ูพุดุชุจุงู ูโุดูุฏ ู ฺฉ ููููู ุจูุงุฏู ุฏุฑ ููโุฒูุงู ุงุณุช.<br>
ุจูุงุจุฑุงู ุฏุฑฺฉ ูุจุงู <strong>Threading</strong>ุ ู ุจูโูฺู ุชุฃุซุฑ ุฑุดุชูโูุง ุจุฑ <strong>Shared State</strong> (ูุถุนุช ูุดุชุฑฺฉ)ุ ุถุฑูุฑ ุงุณุช.</p>
<hr>
<h2>๐งฉ Threading</h2>
<p>ฺฉ <strong>Thread</strong> ุง ยซุฑุดุชูยปุ ฺฉ ูุณุฑ ุงุฌุฑุง ูุณุชูู ุงุณุช ฺฉู ูโุชูุงูุฏ ุฌุฏุง ุงุฒ ุณุงุฑ ูุณุฑูุง ูพุด ุจุฑูุฏ.</p>
<p>ูุฑ ุฑุดุชู ุฏุฑูู ฺฉ <strong>Process</strong> (ูุฑุงูุฏ) ุณุณุชูโุนุงูู ุงุฌุฑุง ูโุดูุฏ ฺฉู ูุญุท ุงุฒููู ุฑุง ุจุฑุง ุงุฌุฑุง ฺฉ ุจุฑูุงูู ูุฑุงูู ูโฺฉูุฏ.</p>
<ul>
<li>ุฏุฑ ฺฉ ุจุฑูุงูู <strong>ุชฺฉโุฑุดุชูโุง</strong> (Single-Threaded)ุ ุชููุง ฺฉ ุฑุดุชู ุฏุฑ ูุญุท ุงุฒููู ูพุฑุฏุงุฒุด ุงุฌุฑุง ูโุดูุฏ ู ุจูุงุจุฑุงู ุขู ุฑุดุชู ุฏุณุชุฑุณ ุงูุญุตุงุฑ ุจู ุขู ุฏุงุฑุฏ.</li>
<li>ุฏุฑ ฺฉ ุจุฑูุงูู <strong>ฺูุฏโุฑุดุชูโุง</strong> (Multi-Threaded)ุ ฺูุฏ ุฑุดุชู ุฏุฑ ฺฉ ูุฑุงูุฏ ูุงุญุฏ ุงุฌุฑุง ูโุดููุฏ ู ฺฉ ูุญุท ุงุฌุฑุง ูุดุชุฑฺฉ (ุจูโูฺู ุญุงูุธู) ุฑุง ุจุง ูู ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏ.</li>
</ul>
<p>ุงู ููุถูุน ุฏูู ุงุตู ููุฏ ุจูุฏู Multithreading ุงุณุช:<br>
ุจุฑุง ูููููุ ฺฉ ุฑุดุชู ูโุชูุงูุฏ ุฏุฑ ูพุณโุฒููู ุฏุงุฏูโูุง ุฑุง ูุงฺฉุด ฺฉูุฏุ ุฏุฑุญุงูโฺฉู ุฑุดุชู ุฏฺฏุฑ ููุงู ุฏุงุฏูโูุง ุฑุง ุจูโูุญุถ ุฑุณุฏู ููุงุด ุฏูุฏ. ุงู ุฏุงุฏูโูุง ุจูโุนููุงู <strong>Shared State</strong> ุดูุงุฎุชู ูโุดููุฏ.</p>
<hr>
<h2>๐๏ธ ุงุฌุงุฏ ฺฉ Thread</h2>
<p>ฺฉ ุจุฑูุงูู ฺฉูุงูุช (<strong>Console</strong>ุ <strong>WPF</strong>ุ <strong>UWP</strong> ุง <strong>Windows Forms</strong>) ุฏุฑ ฺฉ ุฑุดุชู ูููุฑุฏ ฺฉู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุชูุณุท ุณุณุชูโุนุงูู ุณุงุฎุชู ูโุดูุฏ (ุฑุดุชูโ ุงุตู ุง <strong>Main Thread</strong>) ุดุฑูุน ุจู ฺฉุงุฑ ูโฺฉูุฏ.<br>
ุงู ุจุฑูุงูู ุชุง ุฒูุงู ฺฉู ุดูุง ฺฉุงุฑ ุฎูุงู ุขู ุงูุฌุงู ูุฏูุฏ (ุนู ุฑุดุชูโูุง ุจุดุชุฑ ุจุณุงุฒุฏุ ฺู ุจูโุทูุฑ ูุณุชูู ู ฺู ุบุฑูุณุชูู) ุจูโุตูุฑุช ุชฺฉโุฑุดุชูโุง ุจุงู ูโูุงูุฏ.ยน</p>
<p>ุจุฑุง ุงุฌุงุฏ ู ุดุฑูุน ฺฉ ุฑุดุชู ุฌุฏุฏุ ุจุงุฏ ฺฉ ุดุก ุงุฒ ููุน <strong>Thread</strong> ุจุณุงุฒุฏ ู ูุชุฏ <strong>Start</strong> ุขู ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.<br>
ุณุงุฏูโุชุฑู ุณุงุฒูุฏู (Constructor) ุจุฑุง Threadุ ฺฉ <strong>ThreadStart Delegate</strong> ูโฺฏุฑุฏ: ูุชุฏ ุจุฏูู ูพุงุฑุงูุชุฑ ฺฉู ูุดุงู ูโุฏูุฏ ุงุฌุฑุง ุฑุดุชู ุงุฒ ฺฉุฌุง ุขุบุงุฒ ุดูุฏ.</p>
<h3>๐ ูุซุงู</h3>
<pre class="hljs"><code><span class="hljs-comment">// ุชูุฌู: ููู ูููููโูุง ุงู ูุตู ูุฑุถ ูโฺฉููุฏ ฺฉู Namespaceูุง ุฒุฑ Import ุดุฏูโุงูุฏ:</span>
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading;

Thread t = <span class="hljs-keyword">new</span> Thread (WriteY);     <span class="hljs-comment">// ุงุฌุงุฏ ู ุฑุงูโุงูุฏุงุฒ ฺฉ ุฑุดุชู ุฌุฏุฏ</span>
t.Start();                          <span class="hljs-comment">// ุงุฌุฑุง ูุชุฏ WriteY ุฑู ุฑุดุชู ุฌุฏุฏ</span>

<span class="hljs-comment">// ููโุฒูุงูุ ุฑู ุฑุดุชู ุงุตู ูู ฺฉุงุฑ ุงูุฌุงู ูโุฏูู.</span>
<span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) Console.Write (<span class="hljs-string">&quot;x&quot;</span>);

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WriteY</span>()</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) Console.Write (<span class="hljs-string">&quot;y&quot;</span>);
}
</code></pre>
<hr>
<h3>๐ค ุฎุฑูุฌ ููููู</h3>
<pre class="hljs"><code>xxxxxxxxxxxxxxxxyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
...
</code></pre>
<hr>
<p>ุฑุดุชู ุงุตู ฺฉ ุฑุดุชู ุฌุฏุฏ ุจู ูุงู <code>t</code> ูโุณุงุฒุฏ ู ุฑู ุขู ูุชุฏ ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ฺฉู ฺฉุงุฑุงฺฉุชุฑ <code>y</code> ุฑุง ุจูโุทูุฑ ุชฺฉุฑุงุฑ ฺุงูพ ูโฺฉูุฏ.<br>
ุจูโุทูุฑ ููโุฒูุงูุ ุฑุดุชู ุงุตู ูุฒ ฺฉุงุฑุงฺฉุชุฑ <code>x</code> ุฑุง ุจูโุทูุฑ ุชฺฉุฑุงุฑ ฺุงูพ ูโฺฉูุฏุ ููุงูโุทูุฑ ฺฉู ุฏุฑ ุดฺฉู <strong>ฑด-ฑ</strong> ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.</p>
<ul>
<li>ุฑู ฺฉ ุฑุงุงูู ุชฺฉโูุณุชูโุงุ ุณุณุชูโุนุงูู ุจุงุฏ ยซุจูุฑุดโูุงยป ุงุฒ ุฒูุงู (ูุนูููุงู ุญุฏูุฏ <strong>ฒฐ ููโุซุงูู</strong> ุฏุฑ ููุฏูุฒ) ุฑุง ุจู ูุฑ ุฑุดุชู ุงุฎุชุตุงุต ุฏูุฏ ุชุง ููโุฒูุงู ุดุจูโุณุงุฒ ุดูุฏ. ูุชุฌู ุงู ฺฉุงุฑุ ุจูุงฺฉโูุง ุชฺฉุฑุงุฑ ุงุฒ <code>x</code> ู <code>y</code> ุงุณุช.</li>
<li>ุฑู ฺฉ ูุงุดู ฺูุฏโูุณุชูโุง ุง ฺูุฏโูพุฑุฏุงุฒูุฏูโุงุ ุฏู ุฑุดุชู ูโุชูุงููุฏ ูุงูุนุงู ุจูโุทูุฑ ููุงุฒ ุงุฌุฑุง ุดููุฏ (ุจุง ุงู ุดุฑุท ฺฉู ุฏฺฏุฑ ูพุฑุฏุงุฒูโูุง ูุนุงู ุฑู ุฑุงุงูู ูู ุฏุฑ ุฑูุงุจุช ุจุงุดูุฏ).<br>
ุจุงุงูโุญุงู ุฏุฑ ุงู ูุซุงู ููฺูุงู ุจูุงฺฉโูุง ุชฺฉุฑุงุฑ ุงุฒ <code>x</code> ู <code>y</code> ูุดุงูุฏู ูโฺฉูุฏุ ุฒุฑุง ุฌุฒุฆุงุช ุธุฑู ุฏุฑ ูฺฉุงูุฒู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู <strong>Console</strong> ุฏุฑุฎูุงุณุชโูุง ููโุฒูุงู ุฑุง ูุฏุฑุช ูโฺฉูุฏ.</li>
</ul>
<div align="center">
<p><img src="../../../assets/image/14/Table-14-1.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h2>๐ ูพุดโุงูุชุงุฒุฏู (Preemption)</h2>
<p>ููุช ุงุฌุฑุง ฺฉ <strong>Thread</strong> ุจุง ุงุฌุฑุง ฺฉุฏ ุฑู ฺฉ <strong>Thread</strong> ุฏฺฏุฑ ุฏุฑ ูู ุขูุฎุชู ูโุดูุฏุ ฺฏูุชู ูโุดูุฏ ฺฉู ุขู Thread <strong>Preempted</strong> (ูพุดโุงูุชุงุฒ ุฏุงุฏู ุดุฏู) ุงุณุช. ุงู ุงุตุทูุงุญ ุงุบูุจ ุฒูุงู ุธุงูุฑ ูโุดูุฏ ฺฉู ุจุฎูุงูู ุชูุถุญ ุฏูู ฺุฑุง ฺุฒ ุจูโุฏุฑุณุช ฺฉุงุฑ ูฺฉุฑุฏู ุงุณุช!</p>
<hr>
<h2>๐ข ูุถุนุช ุฒูุฏู ุจูุฏู (IsAlive)</h2>
<p>ูพุณ ุงุฒ ุดุฑูุน ุดุฏูุ ูฺฺฏ (<strong>Property</strong>) <code>IsAlive</code> ุฏุฑ ฺฉ Thread ููุฏุงุฑ <strong>true</strong> ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ ุชุง ุฒูุงู ฺฉู ุขู Thread ูพุงุงู ุงุจุฏ.<br>
ฺฉ Thread ุฒูุงู ูพุงุงู ูโุงุจุฏ ฺฉู <strong>Delegate</strong>ุง ฺฉู ุจู ุณุงุฒูุฏูโ (Constructor) ุขู ุฏุงุฏู ุดุฏูุ ุงุฌุฑุง ุฎูุฏ ุฑุง ุชูุงู ฺฉูุฏ. ูพุณ ุงุฒ ูพุงุงู ุงูุชูุ ฺฉ Thread ุฑุง ููโุชูุงู ุฏูุจุงุฑู ุฑุงูโุงูุฏุงุฒ ฺฉุฑุฏ.</p>
<hr>
<h2>๐ ูุงูโฺฏุฐุงุฑ Threadูุง</h2>
<p>ูุฑ Thread ฺฉ ูฺฺฏ ุจู ูุงู <strong>Name</strong> ุฏุงุฑุฏ ฺฉู ูโุชูุงูุฏ ุขู ุฑุง ุจุฑุง ุงูุฏุงู <strong>Debugging</strong> ุชูุธู ฺฉูุฏ.<br>
ุงู ูฺฺฏ ุฏุฑ <strong>Visual Studio</strong> ุจุณุงุฑ ููุฏ ุงุณุชุ ุฒุฑุง ูุงู Thread ุฏุฑ <strong>Threads Window</strong> ู ููุงุฑ ุงุจุฒุงุฑ <strong>Debug Location</strong> ููุงุด ุฏุงุฏู ูโุดูุฏ.<br>
ุดูุง ุชููุง ฺฉโุจุงุฑ ูโุชูุงูุฏ ูุงู ฺฉ Thread ุฑุง ุชูุธู ฺฉูุฏุ ูุฑ ุชูุงุด ุฏฺฏุฑ ุจุฑุง ุชุบุฑ ูุงูุ ฺฉ <strong>Exception</strong> ุงุฌุงุฏ ุฎูุงูุฏ ฺฉุฑุฏ.</p>
<hr>
<h2>๐ ุฏุณุชุฑุณ ุจู Thread ูุนู</h2>
<p>ูฺฺฏ ุงุณุชุงุชฺฉ <code>Thread.CurrentThread</code> ุฑุดุชูโุง ุฑุง ฺฉู ุฏุฑ ุญุงู ุญุงุถุฑ ุฏุฑ ุญุงู ุงุฌุฑุงุณุช ุจุฑูโฺฏุฑุฏุงูุฏ:</p>
<pre class="hljs"><code>Console.WriteLine (Thread.CurrentThread.Name);
</code></pre>
<hr>
<h2>โณ Join ู Sleep</h2>
<h3>๐ Join</h3>
<p>ูโุชูุงูุฏ ุจุง ูุฑุงุฎูุงู ูุชุฏ <strong>Join</strong> ููุชุธุฑ ุจูุงูุฏ ุชุง ฺฉ Thread ุฏฺฏุฑ ูพุงุงู ุงุจุฏ:</p>
<pre class="hljs"><code>Thread t = <span class="hljs-keyword">new</span> Thread (Go);
t.Start();
t.Join();
Console.WriteLine (<span class="hljs-string">&quot;Thread t has ended!&quot;</span>);

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span> 
{ 
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) Console.Write (<span class="hljs-string">&quot;y&quot;</span>); 
}
</code></pre>
<p>ุงู ฺฉุฏ ุงุจุชุฏุง ฑฐฐฐ ุจุงุฑ <code>y</code> ฺุงูพ ูโฺฉูุฏ ู ุจูุงูุงุตูู ูพุณ ุงุฒ ุขู ูุชู <code>&quot;Thread t has ended!&quot;</code> ููุงุด ุฏุงุฏู ูโุดูุฏ.</p>
<p>ููฺูู ูโุชูุงูุฏ ููฺฏุงู ูุฑุงุฎูุงู <strong>Join</strong> ฺฉ <strong>Timeout</strong> ูุดุฎุต ฺฉูุฏ (ุจุฑุญุณุจ ููโุซุงูู ุง ฺฉ <strong>TimeSpan</strong>). ุฏุฑ ุงู ุตูุฑุช ูุชุฏ ููุฏุงุฑ <strong>true</strong> ุจุฑูโฺฏุฑุฏุงูุฏ ุงฺฏุฑ Thread ูพุงุงู ุงูุชู ุจุงุดุฏุ ุง <strong>false</strong> ุงฺฏุฑ ุฒูุงู ุชูุงู ุดุฏู ุจุงุดุฏ.</p>
<hr>
<h3>๐ Sleep</h3>
<p>ูุชุฏ <strong>Thread.Sleep</strong> ุงุฌุฑุง Thread ูุนู ุฑุง ุจุฑุง ูุฏุช ูุดุฎุต ูุชููู ูโฺฉูุฏ:</p>
<pre class="hljs"><code>Thread.Sleep (TimeSpan.FromHours (<span class="hljs-number">1</span>));  <span class="hljs-comment">// ุชููู ุจุฑุง ฑ ุณุงุนุช</span>
Thread.Sleep (<span class="hljs-number">500</span>);                     <span class="hljs-comment">// ุชููู ุจุฑุง ตฐฐ ููโุซุงูู</span>
</code></pre>
<p>ูุฑุงุฎูุงู <code>Thread.Sleep(0)</code> ุจูุงูุงุตูู <strong>ุจูุฑุด ุฒูุงู</strong> (Time Slice) ูุนู ุฑุง ุขุฒุงุฏ ฺฉุฑุฏู ู ุฏุงูุทูุจุงูู CPU ุฑุง ุฏุฑ ุงุฎุชุงุฑ ุณุงุฑ Threadูุง ูุฑุงุฑ ูโุฏูุฏ.<br>
ูุชุฏ <code>Thread.Yield()</code> ูุฒ ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏุ ุจุง ุงู ุชูุงูุช ฺฉู CPU ุฑุง ุชููุง ุจู Threadูุง ูุงฺฏุฐุงุฑ ูโฺฉูุฏ ฺฉู ุฑู ููุงู ูพุฑุฏุงุฒูุฏู ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชูุฏ.</p>
<ul>
<li>ุงุณุชูุงุฏู ุงุฒ <code>Sleep(0)</code> ุง <code>Yield</code> ฺฏุงู ุฏุฑ ฺฉุฏูุง <strong>Production</strong> ุจุฑุง ุจูููโุณุงุฒโูุง ูพุดุฑูุชูโ ุนููฺฉุฑุฏ ููุฏ ุงุณุช.</li>
<li>ุงูโูุง ููฺูู ุงุจุฒุงุฑูุง ุนุงู <strong>Diagnostic</strong> (ุนุจโุงุจ) ูุณุชูุฏ: ุงฺฏุฑ ุงุถุงูู ฺฉุฑุฏู <code>Thread.Yield()</code> ุฏุฑ ูุฑุฌุง ฺฉุฏ ุดูุง ุจุงุนุซ ุฎุฑุงุจ ุดุฏู ุจุฑูุงูู ุดูุฏุ ุชูุฑุจุงู ูุทูุฆู ุจุงุดุฏ ฺฉู ฺฉ <strong>Bug</strong> ุฏุฑ ฺฉุฏุชุงู ูุฌูุฏ ุฏุงุฑุฏ.</li>
</ul>
<hr>
<h2>๐ซ Block ุดุฏู ฺฉ Thread</h2>
<p>ููุช ุงุฌุฑุง ฺฉ Thread ุจู ุฏูุงู ูุชููู ุดูุฏุ ฺฏูุชู ูโุดูุฏ ฺฉู ุขู Thread <strong>Blocked</strong> ุงุณุชุ ูุซูุงู ููฺฏุงู ุงุฌุฑุง <strong>Sleep</strong> ุง ููุชุธุฑ ูุงูุฏู ุจุฑุง ูพุงุงู ุงูุชู ฺฉ Thread ุฏฺฏุฑ ุจุง <strong>Join</strong>.</p>
<ul>
<li>ฺฉ Thread <strong>Blocked</strong> ุจูุงูุงุตูู ุจูุฑุด ุฒูุงู ูพุฑุฏุงุฒูุฏูโ ุฎูุฏ ุฑุง ุขุฒุงุฏ ูโฺฉูุฏ.</li>
<li>ุงุฒ ุขู ูุญุธู ุจู ุจุนุฏุ ูฺ ุฒูุงู ุงุฒ CPU ูุตุฑู ููโฺฉูุฏ ุชุง ุฒูุงู ฺฉู ุดุฑุท Block ุดุฏู ุจุฑุทุฑู ุดูุฏ.</li>
</ul>
<p>ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ุขุง ฺฉ Thread ุฏุฑ ุญุงูุช Block ุงุณุช ูโุชูุงูุฏ ุงุฒ ูฺฺฏ <strong>ThreadState</strong> ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-built_in">bool</span> blocked = (someThread.ThreadState &amp; ThreadState.WaitSleepJoin) != <span class="hljs-number">0</span>;
</code></pre>
<hr>
<h2>โ๏ธ ThreadState</h2>
<p>ูฺฺฏ <strong>ThreadState</strong> ฺฉ <strong>Flags Enum</strong> ุงุณุช ฺฉู ุณู ยซูุงูยป ุฏุงุฏู ุฑุง ุจูโุตูุฑุช <strong>Bitwise</strong> ุชุฑฺฉุจ ูโฺฉูุฏ.<br>
ุจุงุงูโุญุงู ุจุดุชุฑ ููุงุฏุฑ ุขู ุฒุงุฆุฏุ ุจูุงุงุณุชูุงุฏู ุง ููุณูุฎ ุดุฏูโุงูุฏ.</p>
<p>ุฑูุด ุชูุณุนูโุงูุชูโ ุฒุฑ ฺฉ ููุฏุงุฑ ThreadState ุฑุง ุจู ฺฉ ุงุฒ ฺูุงุฑ ููุฏุงุฑ ููุฏ ุณุงุฏูโุณุงุฒ ูโฺฉูุฏ:</p>
<ul>
<li><strong>Unstarted</strong></li>
<li><strong>Running</strong></li>
<li><strong>WaitSleepJoin</strong></li>
<li><strong>Stopped</strong></li>
</ul>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ThreadState <span class="hljs-title">Simplify</span> (<span class="hljs-params"><span class="hljs-keyword">this</span> ThreadState ts</span>)</span>
{
    <span class="hljs-keyword">return</span> ts &amp; (ThreadState.Unstarted |
                 ThreadState.WaitSleepJoin |
                 ThreadState.Stopped);
}
</code></pre>
<p>๐ ูฺฺฏ ThreadState ุจุฑุง ููุงุตุฏ <strong>Diagnostic</strong> ููุฏ ุงุณุชุ ุงูุง ุจุฑุง <strong>Synchronization</strong> ููุงุณุจ ูุณุชุ ุฒุฑุง ูุถุนุช ฺฉ Thread ูโุชูุงูุฏ ุจู ุจุฑุฑุณ ููุฏุงุฑ ThreadState ู ุนููโฺฉุฑุฏู ุจุฑ ุงุณุงุณ ุขู ุชุบุฑ ฺฉูุฏ.</p>
<p>ููฺฏุงูโฺฉู ฺฉ Thread <strong>Block</strong> ุง <strong>Unblock</strong> ูโุดูุฏุ ุณุณุชูโุนุงูู ฺฉ <strong>Context Switch</strong> ุงูุฌุงู ูโุฏูุฏ. ุงู ุนูู ูุฒููโ ุงูุฏฺฉ ุฏุงุฑุฏ (ูุนูููุงู ฺฉ ุง ุฏู ูฺฉุฑูุซุงูู).</p>
<hr>
<h2>โ๏ธ I/O-bound ุฏุฑ ููุงุจู Compute-bound</h2>
<ul>
<li>
<p>ุนููุงุช ฺฉู ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุฏุฑ ุงูุชุธุงุฑ ุฑุฎโุฏุงุฏู ฺุฒ ูโฺฏุฐุฑุงูุฏุ <strong>I/O-bound</strong> ูุงูุฏู ูโุดูุฏ.<br>
ููููู: <strong>ุฏุงูููุฏ ฺฉ ุตูุญู ูุจ</strong> ุง ูุฑุงุฎูุงู <code>Console.ReadLine</code>.<br>
(ุนููุงุช I/O-bound ูุนูููุงู ุดุงูู ูุฑูุฏ ุง ุฎุฑูุฌ ูุณุชูุฏุ ุงูุง ุงู ฺฉ ุงูุฒุงู ูุทุน ูุณุช: <code>Thread.Sleep</code> ูู I/O-bound ูุญุณูุจ ูโุดูุฏ.)</p>
</li>
<li>
<p>ุฏุฑ ููุงุจูุ ุนููุงุช ฺฉู ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุตุฑู ุงูุฌุงู ฺฉุงุฑูุง ุณูฺฏู CPU ูโฺฉูุฏุ <strong>Compute-bound</strong> ูุงู ุฏุงุฑุฏ.</p>
</li>
</ul>
<hr>
<h2>๐ Blocking ุฏุฑ ููุงุจู Spinning</h2>
<p>ฺฉ ุนููุงุช I/O-bound ูโุชูุงูุฏ ุจู ุฏู ุตูุฑุช ุนูู ฺฉูุฏ:</p>
<ol>
<li><strong>ุงูุชุธุงุฑ ููฺฏุงู (Synchronous)</strong> ุฑู Thread ูุนู ุชุง ูพุงุงู ุนููุงุช (ูุซุงู: <code>Console.ReadLine</code>ุ <code>Thread.Sleep</code> ุง <code>Thread.Join</code>).</li>
<li><strong>ุนูู ูุงููฺฏุงู (Asynchronous)</strong> ฺฉู ุจุง ูพุงุงู ุนููุงุช ุฏุฑ ุขูุฏูุ ฺฉ <strong>Callback</strong> ุงุฌุฑุง ูโฺฉูุฏ (ุจุดุชุฑ ุฏุฑ ุงุฏุงูู ุงู ูุตู ุชูุถุญ ุฏุงุฏู ูโุดูุฏ).</li>
</ol>
<hr>
<h3>๐ Blocking ุจุง ุญููู Sleep</h3>
<p>ุนููุงุชโูุง I/O-bound ฺฉู ุจูโุตูุฑุช ููฺฏุงู ููุชุธุฑ ูโูุงููุฏ ุจุดุชุฑ ุฒูุงู ุฎูุฏ ุฑุง ุฏุฑ ุญุงูุช Block ุณูพุฑ ูโฺฉููุฏ.<br>
ฺฏุงู ุงู ุงูุชุธุงุฑ ุจู ุดฺฉู ฺฉ ุญูููโ Sleep ูพุงุฏูโุณุงุฒ ูโุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">while</span> (DateTime.Now &lt; nextStartTime)
    Thread.Sleep (<span class="hljs-number">100</span>);
</code></pre>
<hr>
<h3>๐ Spinning (ฺุฑุฎุด ูุฏุงูู)</h3>
<p>ฺฏุฒููโ ุฏฺฏุฑ ุงู ุงุณุช ฺฉู ฺฉ Thread ุจูโุทูุฑ ูุฏุงูู ุจฺุฑุฎุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">while</span> (DateTime.Now &lt; nextStartTime);
</code></pre>
<p>ุงู ฺฉุงุฑ ุจูโุดุฏุช ููุช CPU ุฑุง ุชูู ูโฺฉูุฏ. ุงุฒ ุฏุฏ <strong>CLR</strong> ู ุณุณุชูโุนุงููุ Thread ุฏุฑ ุญุงู ุงูุฌุงู ฺฉ ูุญุงุณุจู ููู ุงุณุชุ ุจูุงุจุฑุงู ููุงุจุน ุจู ุขู ุงุฎุชุตุงุต ุฏุงุฏู ูโุดูุฏ. ุฏุฑ ุนููุ ูุง ฺฉ ุนููุงุช I/O-bound ุฑุง ุจู ฺฉ ุนููุงุช <strong>Compute-bound</strong> ุชุจุฏู ฺฉุฑุฏูโุงู.</p>
<hr>
<h2>โจ ูฺฉุงุช ุธุฑู ุฏุฑุจุงุฑู Spinning ุฏุฑ ุจุฑุงุจุฑ Blocking</h2>
<p>ฑ. <strong>Spinning ฺฉูุชุงูโูุฏุช</strong> ฺฏุงู ูโุชูุงูุฏ ูุคุซุฑ ุจุงุดุฏุ ุฒูุงู ฺฉู ุงูุชุธุงุฑ ุฏุงุฑุฏ ุดุฑุท ุจูโุฒูุฏ (ูุซูุงู ุฏุฑ ฺูุฏ ูฺฉุฑูุซุงูู) ุจุฑูุฑุงุฑ ุดูุฏ. ุงู ฺฉุงุฑ ุงุฒ ุณุฑุจุงุฑ ู ุชุฃุฎุฑ <strong>Context Switch</strong> ุฌููฺฏุฑ ูโฺฉูุฏ.<br>
๐ ุจุฑุง ุงู ููุธูุฑุ .NET ูุชุฏูุง ู ฺฉูุงุณโูุง ุฎุงุต ูุซู <strong>SpinLock</strong> ู <strong>SpinWait</strong> ุฑุง ุงุฑุงุฆู ูโุฏูุฏ.</p>
<p>ฒ. <strong>Blocking ูู ุจโูุฒูู ูุณุช</strong>. ูุฑ Thread ุญุฏูุฏ <strong>ฑ ูฺฏุงุจุงุช ุญุงูุธู</strong> ุฑุง ุจุฑุง ุชูุงู ูุฏุช ุนูุฑุด ุงุดุบุงู ูโฺฉูุฏ ู ุจุฑุง <strong>CLR</strong> ู ุณุณุชูโุนุงูู ุจุงุฑ ูุฏุฑุช ูุฏุงูู ุงุฌุงุฏ ูโฺฉูุฏ.<br>
ุจู ููู ุฏููุ Blocking ุฏุฑ ุจุฑูุงููโูุง ุจุณุงุฑ I/O-bound ฺฉู ุจุงุฏ ุตุฏูุง ุง ูุฒุงุฑุงู ุนููุงุช ููโุฒูุงู ุฑุง ูุฏุฑุช ฺฉููุฏ ูโุชูุงูุฏ ูุดฺฉูโุณุงุฒ ุดูุฏ.</p>
<p>๐ ุฏุฑ ฺูู ุดุฑุงุทุ ุจุฑูุงููโูุง ุจุงุฏ ุงุฒ ุฑูฺฉุฑุฏ <strong>Callback-based</strong> ุงุณุชูุงุฏู ฺฉููุฏุ ุนู ููฺฏุงู ุงูุชุธุงุฑุ Thread ุฎูุฏ ุฑุง ุจูโุทูุฑ ฺฉุงูู ุขุฒุงุฏ ฺฉููุฏ.<br>
ุงู ุฏููุงู (ุจุฎุด ุงุฒ) ูุฏู ุงูฺฏููุง <strong>Asynchronous</strong> ุงุณุช ฺฉู ุฏุฑ ุงุฏุงูู ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.</p>
<h2>๐ ูุถุนุช ูุญู ุฏุฑ ููุงุจู ูุถุนุช ูุดุชุฑฺฉ</h2>
<p><strong>CLR</strong> ุจู ูุฑ Thread ูพุดุชูโ ุญุงูุธูโ ูุฎุตูุต ุฎูุฏุด ุฑุง ุงุฎุชุตุงุต ูโุฏูุฏุ ุจูุงุจุฑุงู ูุชุบุฑูุง ูุญู ุงุฒ ูู ุฌุฏุง ูฺฏู ุฏุงุดุชู ูโุดููุฏ.</p>
<p>ุฏุฑ ูุซุงู ุฒุฑุ ูุชุฏ ุจุง ฺฉ ูุชุบุฑ ูุญู ุชุนุฑู ูโฺฉูู ู ุณูพุณ ุขู ูุชุฏ ุฑุง ุจูโุทูุฑ ููโุฒูุงู ุฑู <strong>Thread ุงุตู</strong> ู ฺฉ <strong>Thread ุฌุฏุฏ</strong> ูุฑุงุฎูุงู ูโฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">new</span> Thread (Go).Start();      <span class="hljs-comment">// ูุฑุงุฎูุงู Go() ุฑู ฺฉ Thread ุฌุฏุฏ</span>
Go();                         <span class="hljs-comment">// ูุฑุงุฎูุงู Go() ุฑู Thread ุงุตู</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
{
    <span class="hljs-comment">// ุชุนุฑู ู ุงุณุชูุงุฏู ุงุฒ ูุชุบุฑ ูุญู - &#x27;cycles&#x27;</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> cycles = <span class="hljs-number">0</span>; cycles &lt; <span class="hljs-number">5</span>; cycles++) 
        Console.Write (<span class="hljs-string">&#x27;?&#x27;</span>);
}
</code></pre>
<p>ุจุฑุง ูุฑ Thread ฺฉ ูุณุฎู ุฌุฏุงฺฏุงูู ุงุฒ ูุชุบุฑ <code>cycles</code> ุฑู ูพุดุชูโ ุญุงูุธูโุงุด ุณุงุฎุชู ูโุดูุฏ. ุจูุงุจุฑุงูุ ุฎุฑูุฌ ุทุจู ุงูุชุธุงุฑ ฑฐ ุนูุงูุช ุณุคุงู ุฎูุงูุฏ ุจูุฏ.</p>
<hr>
<h2>๐ค ุงุดุชุฑุงฺฉ ุฏุงุฏู ุจู Threadูุง</h2>
<p>Threadูุง ุฏุงุฏูโูุง ุฑุง ุฏุฑ ุตูุฑุช ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏ ฺฉู ูุฑุฌุน (Reference) ูุดุชุฑฺฉ ุจู ฺฉ ุดุก ุง ูุชุบุฑ ุฏุงุดุชู ุจุงุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-built_in">bool</span> _done = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">new</span> Thread (Go).Start();
Go();

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
{
    <span class="hljs-keyword">if</span> (!_done) 
    { 
        _done = <span class="hljs-literal">true</span>; 
        Console.WriteLine (<span class="hljs-string">&quot;Done&quot;</span>); 
    }
}
</code></pre>
<p>ุฏุฑ ุงู ูุซุงูุ ูุฑ ุฏู Thread ูุชุบุฑ <code>_done</code> ุฑุง ุจู ุงุดุชุฑุงฺฉ ูโฺฏุฐุงุฑูุฏุ ูพุณ ุฎุฑูุฌ <code>&quot;Done&quot;</code> ููุท ฺฉโุจุงุฑ ฺุงูพ ูโุดูุฏ.</p>
<hr>
<h3>๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Lambda</h3>
<p>ูุชุบุฑูุง ูุญู ฺฉู ุฏุฑ ฺฉ <strong>Lambda Expression</strong> ฺฏุฑูุชู (Capture) ูโุดููุฏ ูุฒ ูโุชูุงููุฏ ูุดุชุฑฺฉ ุจุงุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-built_in">bool</span> done = <span class="hljs-literal">false</span>;
ThreadStart action = () =&gt;
{
    <span class="hljs-keyword">if</span> (!done) 
    { 
        done = <span class="hljs-literal">true</span>; 
        Console.WriteLine (<span class="hljs-string">&quot;Done&quot;</span>); 
    }
};

<span class="hljs-keyword">new</span> Thread (action).Start();
action();
</code></pre>
<hr>
<h3>๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Fieldูุง</h3>
<p>ุจูโุทูุฑ ุฑุงุฌโุชุฑุ <strong>Fieldูุง</strong> ุจุฑุง ุงุดุชุฑุงฺฉ ุฏุงุฏู ูุงู Threadูุง ุงุณุชูุงุฏู ูโุดููุฏ.</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> tt = <span class="hljs-keyword">new</span> ThreadTest();
<span class="hljs-keyword">new</span> Thread (tt.Go).Start();
tt.Go();

<span class="hljs-keyword">class</span> <span class="hljs-title">ThreadTest</span> 
{
    <span class="hljs-built_in">bool</span> _done;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
    {
        <span class="hljs-keyword">if</span> (!_done) 
        { 
            _done = <span class="hljs-literal">true</span>; 
            Console.WriteLine (<span class="hljs-string">&quot;Done&quot;</span>); 
        }
    }
}
</code></pre>
<hr>
<h3>๐ ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ุงุฒ ุทุฑู Static Field</h3>
<p>ุฑุงู ุฏฺฏุฑ ุจุฑุง ุงุดุชุฑุงฺฉ ุฏุงุฏูโูุง ูุงู Threadูุง ุงุณุชูุงุฏู ุงุฒ <strong>Static Field</strong>ูุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadTest</span> 
{
    <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _done;    <span class="hljs-comment">// Static Fieldูุง ูุงู ููู Threadูุง ุฏุฑ ฺฉ Process ูุดุชุฑฺฉ ูุณุชูุฏ</span>

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-keyword">new</span> Thread (Go).Start();
        Go();
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
    {
        <span class="hljs-keyword">if</span> (!_done) 
        { 
            _done = <span class="hljs-literal">true</span>; 
            Console.WriteLine (<span class="hljs-string">&quot;Done&quot;</span>); 
        }
    }
}
</code></pre>
<hr>
<h2>โ๏ธ ูุดฺฉู Thread Safety</h2>
<p>ูุฑ ฺูุงุฑ ูุซุงู ุจุงูุง ููููู ฺฉูุฏ ุฏฺฏุฑ ุฑุง ูุดุงู ูโุฏููุฏ: <strong>ุงูู Threadูุง</strong> (ุง ุจูุชุฑ ุจฺฏููุ ูุจูุฏ ุขู!).<br>
ุฏุฑ ุญููุช ุฎุฑูุฌ <strong>ูุงูุนู</strong> ุงุณุช: ุงู ุงูฺฉุงู (ูุฑฺูุฏ ูุงุฏุฑ) ูุฌูุฏ ุฏุงุฑุฏ ฺฉู <code>&quot;Done&quot;</code> ุฏูุจุงุฑ ฺุงูพ ุดูุฏ.</p>
<p>ุงฺฏุฑ ุชุฑุชุจ ุฏุณุชูุฑุงุช ุฏุฑ ูุชุฏ <code>Go</code> ุฑุง ุนูุถ ฺฉููุ ุงุญุชูุงู ฺุงูพ ุฏูุจุงุฑู <code>&quot;Done&quot;</code> ุจูโุดุฏุช ุงูุฒุงุด ูโุงุจุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
{
    <span class="hljs-keyword">if</span> (!_done) 
    { 
        Console.WriteLine (<span class="hljs-string">&quot;Done&quot;</span>); 
        _done = <span class="hljs-literal">true</span>; 
    }
}
</code></pre>
<p>ูุดฺฉู ุงูุฌุงุณุช ฺฉู ฺฉ Thread ููฺฉู ุงุณุช ุฏุฑ ุญุงู ุจุฑุฑุณ ุดุฑุท <code>if</code> ุจุงุดุฏ ุฏุฑ ููุงู ูุญุธูโุง ฺฉู Thread ุฏฺฏุฑ ุฏุงุฑุฏ <code>WriteLine</code> ุฑุง ุงุฌุฑุง ูโฺฉูุฏโูุจู ุงุฒ ุขูฺฉู ูุฑุตุช ฺฉูุฏ ููุฏุงุฑ <code>_done</code> ุฑุง ุจุฑุงุจุฑ <strong>true</strong> ฺฉูุฏ.</p>
<p>ุงู ูุซุงู ฺฉ ุงุฒ ุฑุงูโูุง ูุชุนุฏุฏ ุฑุง ูุดุงู ูโุฏูุฏ ฺฉู ุฏุฑ ุขู <strong>Shared Writable State</strong> (ูุถุนุช ูุดุชุฑฺฉ ูุงุจูโููุดุชู) ูโุชูุงูุฏ ุฎุทุงูุง ูุชูุงูุจ ุงุฌุงุฏ ฺฉูุฏุ ููุงู ุฎุทุงูุง ฺฉู <strong>Multithreading</strong> ุจูโุจุฏูุงู ุจุฑุง ุขูโูุง ูุดููุฑ ุงุณุช.</p>
<hr>
<h2>๐ ูููโฺฏุฐุงุฑ ู ุงูู Threadูุง</h2>
<p>ุจุฑุง ุญู ูุซุงู ูุจู ูโุชูุงูู ููฺฏุงู ุฎูุงูุฏู ู ููุดุชู ุฑู Field ูุดุชุฑฺฉุ ฺฉ <strong>Exclusive Lock</strong> ุจฺฏุฑู.<br>
#C ุจุฑุง ุงู ููุธูุฑ ุฏุณุชูุฑ <code>lock</code> ุฑุง ูุฑุงูู ฺฉุฑุฏู ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadSafe</span> 
{
    <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _done;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> _locker = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-keyword">new</span> Thread (Go).Start();
        Go();
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
    {
        <span class="hljs-keyword">lock</span> (_locker)
        {
            <span class="hljs-keyword">if</span> (!_done) 
            { 
                Console.WriteLine (<span class="hljs-string">&quot;Done&quot;</span>); 
                _done = <span class="hljs-literal">true</span>; 
            }
        }
    }
}
</code></pre>
<p>ููุช ุฏู Thread ููโุฒูุงู ุจุฑุง ฺฏุฑูุชู ฺฉ Lock (ฺฉู ูโุชูุงูุฏ ุฑู ูุฑ ุดุก ุงุฒ ููุน Reference ุจุงุดุฏุ ุฏุฑ ุงูุฌุง <code>_locker</code>) ุฑูุงุจุช ฺฉููุฏุ ฺฉ ุงุฒ ุขูโูุง ููุชุธุฑ ูโูุงูุฏ (Blocked) ุชุง Lock ุขุฒุงุฏ ุดูุฏ.<br>
ุงู ฺฉุงุฑ ุชุถูู ูโฺฉูุฏ ฺฉู ููุท ฺฉ Thread ูโุชูุงูุฏ ููโุฒูุงู ูุงุฑุฏ ุจููฺฉ ฺฉุฏ ุดูุฏุ ู <code>&quot;Done&quot;</code> ููุท ฺฉโุจุงุฑ ฺุงูพ ุฎูุงูุฏ ุดุฏ.</p>
<p>ฺฉุฏ ฺฉู ุจู ุงู ุดฺฉู ูุญุงูุธุช ุดุฏู ุจุงุดุฏโุฏุฑ ุจุฑุงุจุฑ ุนุฏู ูุทุนุช ุฏุฑ ฺฉ ูุญุท ฺูุฏโุฑุดุชูโุงโุจู ุขู <strong>Thread Safe</strong> ูโฺฏููุฏ.</p>
<hr>
<h2>โก ุนููุงุช ูุงุงูู ุญุช ุฏุฑ ุณุงุฏูโุชุฑู ุญุงูุงุช</h2>
<p>ุญุช ุนูู ุณุงุฏูโ <strong>Auto-increment</strong> ฺฉ ูุชุบุฑ ูู Thread Safe ูุณุช:</p>
<p>ุนุจุงุฑุช <code>x++</code> ุฑู ูพุฑุฏุงุฒูุฏู ุจูโุตูุฑุช ฺูุฏ ุนูู ุฌุฏุงฺฏุงูู (ุฎูุงูุฏูุ ุงูุฒุงุด ู ููุดุชู) ุงุฌุฑุง ูโุดูุฏ.<br>
ุจูุงุจุฑุงู ุงฺฏุฑ ุฏู Thread ููโุฒูุงู <code>x++</code> ุฑุง ุฎุงุฑุฌ ุงุฒ ฺฉ Lock ุงุฌุฑุง ฺฉููุฏุ ูุชุบุฑ ููฺฉู ุงุณุช ููุท ฺฉโุจุงุฑ ุงูุฒุงุด ุงุจุฏ ุจูโุฌุง ุฏูุจุงุฑ (ุง ุจุฏุชุฑุ ููุฏุงุฑ <code>x</code> ููฺฉู ุงุณุช ุฏุฑ ุดุฑุงุท ุฎุงุต ุจูโุดฺฉู ุชฺฉูโุชฺฉู ู ูุงุฏุฑุณุช ุฐุฎุฑู ุดูุฏ).</p>
<hr>
<h2>๐ซ ูุญุฏูุฏุชโูุง ูููโฺฏุฐุงุฑ</h2>
<p>ูููโฺฏุฐุงุฑ <strong>ฺฏูููู ููุฑูโุง</strong> ุจุฑุง ุญู ููู ูุดฺฉูุงุช Thread Safety ูุณุช:</p>
<ul>
<li>ููฺฉู ุงุณุช ูุฑุงููุด ฺฉูุฏ ฺฉู ุฏุฑ ุญู ุฏุณุชุฑุณ ุจู ฺฉ Field ุงุฒ Lock ุงุณุชูุงุฏู ฺฉูุฏ.</li>
<li>ูููโฺฏุฐุงุฑ ุฎูุฏุด ูโุชูุงูุฏ ูุดฺฉูุงุช ูุงููุฏ <strong>Deadlock</strong> ุงุฌุงุฏ ฺฉูุฏ.</li>
</ul>
<p>ฺฉ ููููู ุฎูุจ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ูููโฺฏุฐุงุฑุ ุฏุณุชุฑุณ ุจู ฺฉ <strong>Cache ุฏุฑ ุญุงูุธู</strong> ุงุณุช ฺฉู ุจุฑุง ูฺฏูุฏุงุฑ ุงุดุง ูพุงฺฏุงู ุฏุงุฏู ุฏุฑ ฺฉ ุจุฑูุงููโ <strong><a href="http://ASP.NET">ASP.NET</a></strong> ุงุณุชูุงุฏู ูโุดูุฏ.<br>
ุงู ููุน ุจุฑูุงูู ุณุงุฏู ุงุณุช ู ุจูโุฏุฑุณุช ฺฉุงุฑ ูโฺฉูุฏ ู ูฺ ุฎุทุฑ ุจุฑุง Deadlock ูุฌูุฏ ูุฏุงุฑุฏ.<br>
ูููููโุง ุงุฒ ุงู ููุถูุน ุฑุง ุฏุฑ ุจุฎุด <strong>&quot;Thread Safety in Application Servers&quot;</strong> (ุตูุญู นฐฑ) ุฎูุงูู ุฏุฏ.</p>
<h2>๐ค ุงุฑุณุงู ุฏุงุฏู ุจู ฺฉ Thread</h2>
<p>ฺฏุงู ูุงุฒู ุงุณุช ููฺฏุงู ุดุฑูุน ฺฉ <strong>Thread</strong>ุ ุขุฑฺฏููุงูโูุง ุจู ูุชุฏ ูุฑูุฏ ุขู ุงุฑุณุงู ฺฉูุฏ.<br>
ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง ุงู ฺฉุงุฑ ุงุณุชูุงุฏู ุงุฒ <strong>Lambda Expression</strong> ุงุณุช ฺฉู ูุชุฏ ุฑุง ุจุง ุขุฑฺฏููุงูโูุง ููุฑุฏ ูุธุฑ ูุฑุงุฎูุงู ูโฺฉูุฏ:</p>
<pre class="hljs"><code>Thread t = <span class="hljs-keyword">new</span> Thread ( () =&gt; Print (<span class="hljs-string">&quot;Hello from t!&quot;</span>) );
t.Start();

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Print</span> (<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span> =&gt; Console.WriteLine (message);
</code></pre>
<p>ุจุง ุงู ุฑูุดุ ูโุชูุงูุฏ ูุฑ ุชุนุฏุงุฏ ุขุฑฺฏููุงู ุฑุง ุจู ูุชุฏ ุงุฑุณุงู ฺฉูุฏ.<br>
ุญุช ูโุชูุงูุฏ ฺฉู ูพุงุฏูโุณุงุฒ ุฑุง ุฏุฑ ฺฉ <strong>Lambda ฺูุฏโุฏุณุชูุฑูโุง</strong> ูุฑุงุฑ ุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">new</span> Thread (() =&gt;
{
    Console.WriteLine (<span class="hljs-string">&quot;I&#x27;m running on another thread!&quot;</span>);
    Console.WriteLine (<span class="hljs-string">&quot;This is so easy!&quot;</span>);
}).Start();
</code></pre>
<hr>
<h3>๐ ุฑูุด ุฏฺฏุฑ: ุงุณุชูุงุฏู ุงุฒ <code>Thread.Start</code></h3>
<p>ุฑูุด ุฌุงฺฏุฒู (ุงูุง ฺฉูุชุฑ ุงูุนุทุงูโูพุฐุฑ) ุงู ุงุณุช ฺฉู ุขุฑฺฏููุงู ุฑุง ุจู ูุชุฏ <code>Start</code> ุงุฑุณุงู ฺฉูู:</p>
<pre class="hljs"><code>Thread t = <span class="hljs-keyword">new</span> Thread (Print);
t.Start (<span class="hljs-string">&quot;Hello from t!&quot;</span>);

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Print</span> (<span class="hljs-params"><span class="hljs-built_in">object</span> messageObj</span>)</span>
{
    <span class="hljs-built_in">string</span> message = (<span class="hljs-built_in">string</span>) messageObj;   <span class="hljs-comment">// ูุงุฒ ุจู Cast ุฏุงุฑู</span>
    Console.WriteLine (message);
}
</code></pre>
<p>ุงู ุฑูุด ฺฉุงุฑ ูโฺฉูุฏ ฺูู ุณุงุฒูุฏูโ <strong>Thread</strong> ุจุฑุง ุฏู ููุน Delegate <strong>Overload</strong> ุดุฏู ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ThreadStart</span>()</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ParameterizedThreadStart</span> (<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span>;
</code></pre>
<hr>
<h2>๐งฉ Lambda Expressions ู ูุชุบุฑูุง Captured</h2>
<p>ููุงูโุทูุฑ ฺฉู ุฏุฏูุ <strong>Lambda Expression</strong> ุฑุงุญุชโุชุฑู ู ูุฏุฑุชููุฏุชุฑู ุฑูุด ุจุฑุง ุงุฑุณุงู ุฏุงุฏู ุจู ฺฉ Thread ุงุณุช.<br>
ุงูุง ุจุงุฏ ูุฑุงูุจ ุจุงุดุฏ ฺฉู ุจุนุฏ ุงุฒ ุดุฑูุน Threadุ ุจูโุทูุฑ ูุงุฎูุงุณุชู ูุชุบุฑูุง Captured ุฑุง ุชุบุฑ ูุฏูุฏ.</p>
<p>ุจุฑุง ููููู:</p>
<pre class="hljs"><code><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
    <span class="hljs-keyword">new</span> Thread (() =&gt; Console.Write (i)).Start();
</code></pre>
<p>ุฎุฑูุฌ <strong>ูุงูุนู</strong> ุงุณุช! ูุซุงู ุงุฒ ุฎุฑูุฌ:</p>
<pre class="hljs"><code>0223557799
</code></pre>
<p>ูุดฺฉู ุงู ุงุณุช ฺฉู ูุชุบุฑ <code>i</code> ุฏุฑ ุทูู ุงุฌุฑุง ุญููู ุจู ฺฉ ูุญู ุญุงูุธูโ ูุดุชุฑฺฉ ุงุดุงุฑู ุฏุงุฑุฏ.<br>
ุจูุงุจุฑุงู ูุฑ Threadุ ูุชุฏ ุฑุง ุฑู ูุชุบุฑ ูุฑุงุฎูุงู ูโฺฉูุฏ ฺฉู ููฺฉู ุงุณุช ููโุฒูุงู ุฏุฑ ุญุงู ุชุบุฑ ุจุงุดุฏ!</p>
<p>โ ุฑุงูโุญู: ุงุณุชูุงุฏู ุงุฒ ฺฉ ูุชุบุฑ ูููุช:</p>
<pre class="hljs"><code><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
{
    <span class="hljs-built_in">int</span> temp = i;
    <span class="hljs-keyword">new</span> Thread (() =&gt; Console.Write (temp)).Start();
}
</code></pre>
<p>ุญุงูุง ูุฑ ุนุฏุฏ ุงุฒ <strong>ฐ ุชุง น</strong> ุฏููุงู ฺฉโุจุงุฑ ฺุงูพ ูโุดูุฏ.<br>
(ุงูุจุชู ุชุฑุชุจ ูููุฒ ูุดุฎุต ูุณุชุ ฺูู Threadูุง ูโุชูุงููุฏ ุฏุฑ ุฒูุงูโูุง ูุงูุนู ุดุฑูุน ุดููุฏ.)</p>
<p>ุงู ูุดฺฉู ูุดุงุจู ููุถูุน <strong>&quot;Captured Variables&quot;</strong> (ุตูุญู ดณด) ุงุณุชุ<br>
ูุดฺฉู ูู ุจู ููุงูู C# ุฏุฑ Capture ูุชุบุฑูุง ุญููู ูุฑุจูุท ูโุดูุฏ ู ูู ุจู Multithreading.</p>
<p>ุฏุฑ ุงู ุฑูุดุ ูุชุบุฑ <code>temp</code> ูุญู ุจู ูุฑ Iteration ุญููู ุงุณุชุ ูพุณ ูุฑ Thread ุญุงูุธูโุง ูุชูุงูุช Capture ูโฺฉูุฏ ู ูุดฺฉู ูพุด ููโุขุฏ.</p>
<p>ฺฉ ูุซุงู ุณุงุฏูโุชุฑ ุจุฑุง ููุงุด ูุดฺฉู:</p>
<pre class="hljs"><code><span class="hljs-built_in">string</span> text = <span class="hljs-string">&quot;t1&quot;</span>;
Thread t1 = <span class="hljs-keyword">new</span> Thread ( () =&gt; Console.WriteLine (text) );
text = <span class="hljs-string">&quot;t2&quot;</span>;
Thread t2 = <span class="hljs-keyword">new</span> Thread ( () =&gt; Console.WriteLine (text) );
t1.Start(); t2.Start();
</code></pre>
<p>ฺูู ูุฑ ุฏู Lambda ูุชุบุฑ <code>text</code> ุฑุง Capture ฺฉุฑุฏูโุงูุฏุ ุฎุฑูุฌ ุฏูุจุงุฑ <code>&quot;t2&quot;</code> ุฎูุงูุฏ ุจูุฏ.</p>
<hr>
<h2>โ๏ธ ูุฏุฑุช ุงุณุชุซูุงูุง ุฏุฑ Threadูุง</h2>
<p>ุจููฺฉโูุง <strong>try/catch/finally</strong> ฺฉู ููฺฏุงู ุงุฌุงุฏ ฺฉ Thread ุฏุฑ ุฌุฑุงู ูุณุชูุฏุ ูฺ ุชุฃุซุฑ ุฑู ุขู Thread ููฺฏุงู ุงุฌุฑุง ูุฏุงุฑูุฏ.</p>
<p>ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-keyword">try</span>
{
    <span class="hljs-keyword">new</span> Thread (Go).Start();
}
<span class="hljs-keyword">catch</span> (Exception ex)
{
    <span class="hljs-comment">// ุงูุฌุง ูฺโููุช ุงุฌุฑุง ููโุดูุฏ!</span>
    Console.WriteLine (<span class="hljs-string">&quot;Exception!&quot;</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span> { <span class="hljs-keyword">throw</span> <span class="hljs-literal">null</span>; }   <span class="hljs-comment">// ูพุฑุชุงุจ NullReferenceException</span>
</code></pre>
<p>ุฏุฑ ุงูุฌุงุ Thread ุฌุฏุฏ ุจุง ฺฉ <strong>Unhandled NullReferenceException</strong> ููุงุฌู ูโุดูุฏ.<br>
ุงู ุฑูุชุงุฑ ููุทู ุงุณุชุ ฺูู ูุฑ Thread ูุณุฑ ุงุฌุฑุง ูุณุชูู ุฎูุฏ ุฑุง ุฏุงุฑุฏ.</p>
<p>โ ุฑุงูโุญู ุงู ุงุณุช ฺฉู <strong>Exception Handler</strong> ุฑุง ุฏุงุฎู ูุชุฏ <code>Go</code> ูุฑุงุฑ ุฏูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">new</span> Thread (Go).Start();

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
{
    <span class="hljs-keyword">try</span>
    {
        ...
        <span class="hljs-keyword">throw</span> <span class="hljs-literal">null</span>;    <span class="hljs-comment">// ุงูุฌุง ุฎุทุง ูพุฑุชุงุจ ูโุดูุฏ</span>
        ...
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-comment">// ูุนูููุงู Exception ุฑุง Log ูโฺฉูู ุง ุจู ฺฉ Thread ุฏฺฏุฑ ุณฺฏูุงู ูโุฏูู</span>
        ...
    }
}
</code></pre>
<p>ุฏุฑ ุจุฑูุงููโูุง ูุงูุนุ ุจุงุฏ ุฏุฑ ุชูุงู ูุชุฏูุง ูุฑูุฏ Thread <strong>Exception Handler</strong> ุฏุงุดุชู ุจุงุดุฏโููุงูโุทูุฑ ฺฉู ุฏุฑ Thread ุงุตู ุจุฑูุงูู ูู ูุงุฒ ุฏุงุฑุฏ.<br>
ฺูู ฺฉ Exception ูุฏุฑุชโูุดุฏู ุจุงุนุซ ุจุณุชูโุดุฏู ฺฉู ุจุฑูุงูู ู ููุงุด ฺฉ ูพูุฌุฑูโ ูุงุฎูุดุงูุฏ ูโุดูุฏ.</p>
<hr>
<h2>๐๏ธ ูุฏุฑุช ูุชูุฑฺฉุฒ ุงุณุชุซูุงูุง</h2>
<p>ุฏุฑ ุจุฑูุงููโูุง <strong>WPFุ UWP ู Windows Forms</strong> ูโุชูุงูุฏ ุจุฑุง ูุฏุฑุช ุณุฑุงุณุฑ Exceptionูุง ูุดุชุฑฺฉ ุดูุฏ:</p>
<ul>
<li><code>Application.DispatcherUnhandledException</code></li>
<li><code>Application.ThreadException</code></li>
</ul>
<p>ุงู ุฑูุฏุงุฏูุง ูพุณ ุงุฒ ูููุน ฺฉ Exception ูุฏุฑุชโูุดุฏู ุฏุฑ ูุฑ ุจุฎุด ุจุฑูุงูู ฺฉู ุงุฒ ุทุฑู Message Loop ูุฑุงุฎูุงู ุดุฏู ุงุณุช (ุนู ุชูุงู ฺฉุฏ ฺฉู ุฑู Thread ุงุตู ุฏุฑ ุญุงู ุงุฌุฑุงุณุช) ูุนุงู ูโุดููุฏ.</p>
<p>ุงู ุฑูุด ุจูโุนููุงู ฺฉ ูพุดุชูุงูู ุจุฑุง <strong>Log ฺฉุฑุฏู ู ฺฏุฒุงุฑุด ุจุงฺฏโูุง</strong> ููุฏ ุงุณุช (ูุฑฺูุฏ ุจุฑุง Exceptionูุง ูุฏุฑุชโูุดุฏู ุฑู Worker Threadูุง ูุนุงู ููโุดูุฏ).</p>
<p>ูุฏุฑุช ุงู ุฑูุฏุงุฏูุง ุงุฒ ุจุณุชูโุดุฏู ุจุฑูุงูู ุฌููฺฏุฑ ูโฺฉูุฏุ ุงูุจุชู ููฺฉู ุงุณุช ุชุตูู ุจฺฏุฑุฏ ุจุฑูุงูู ุฑุง ูุฌุฏุฏุงู ุฑุงูโุงูุฏุงุฒ ฺฉูุฏ ุชุง ุงุฒ ุญุงูุช ูุงูพุงุฏุงุฑ ุงุญุชูุงู ุฌููฺฏุฑ ุดูุฏ.</p>
<h2>๐ Foreground ุฏุฑ ููุงุจู Background Threads</h2>
<p>ุจูโุทูุฑ ูพุดโูุฑุถุ Threadูุง ฺฉู ุดูุง ุจูโุทูุฑ ุตุฑุญ ุงุฌุงุฏ ูโฺฉูุฏุ <strong>Foreground</strong> ูุณุชูุฏ.</p>
<p>๐น <strong>Foreground Thread</strong> ุจุงุนุซ ูโุดูุฏ ุจุฑูุงูู ุชุง ุฒูุงู ฺฉู ุญุช ฺฉ ุงุฒ ุขูโูุง ุฏุฑ ุญุงู ุงุฌุฑุงุณุชุ ุฒูุฏู ุจูุงูุฏ.<br>
๐น <strong>Background Thread</strong> ฺูู ุงุซุฑ ูุฏุงุฑุฏุ ุจูโูุญุถ ุงูฺฉู ูููโ Foreground Threadูุง ุชูุงู ุดููุฏุ ุจุฑูุงูู ูพุงุงู ูโุงุจุฏ ู ูุฑ Background Thread ฺฉู ูููุฒ ุฏุฑ ุญุงู ุงุฌุฑุงุณุชุ ูุงฺฏูุงู ูุทุน ูโุดูุฏ.</p>
<p>โ๏ธ ูุถุนุช Foreground ุง Background ูฺ ุงุฑุชุจุงุท ุจุง <strong>Priority</strong> (ุงูููุช ุชุฎุตุต ุฒูุงู ูพุฑุฏุงุฒุด) ูุฏุงุฑุฏ.</p>
<p>ูโุชูุงูุฏ ูุถุนุช ฺฉ Thread ุฑุง ุงุฒ ุทุฑู ูฺฺฏ <code>IsBackground</code> ูพุฑุณโูุฌู ุง ุชุบุฑ ุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span> (<span class="hljs-params"><span class="hljs-built_in">string</span>[] <span class="hljs-keyword">args</span></span>)</span>
{
    Thread worker = <span class="hljs-keyword">new</span> Thread ( () =&gt; Console.ReadLine() );
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">args</span>.Length &gt; <span class="hljs-number">0</span>) worker.IsBackground = <span class="hljs-literal">true</span>;
    worker.Start();
}
</code></pre>
<ul>
<li>ุงฺฏุฑ ุจุฑูุงูู ุจุฏูู ุขุฑฺฏููุงู ุงุฌุฑุง ุดูุฏุ Thread ุจูโุตูุฑุช <strong>Foreground</strong> ุฎูุงูุฏ ุจูุฏ ู ููุชุธุฑ ูโูุงูุฏ ุชุง ฺฉุงุฑุจุฑ Enter ุจุฒูุฏ.</li>
<li>ุงฺฏุฑ ุจุฑูุงูู ุจุง ุขุฑฺฏููุงู ุงุฌุฑุง ุดูุฏุ Thread ุจูโุตูุฑุช <strong>Background</strong> ุงุณุช ู ุจุฑูุงูู ุชูุฑุจุงู ุจูุงูุงุตูู ุชูุงู ูโุดูุฏ (ู <code>ReadLine</code> ูุทุน ูโฺฏุฑุฏุฏ).</li>
</ul>
<p>โ ุชูุฌู: ููุช ุจุฑูุงูู ุงูโฺฏููู ูพุงุงู ุงุจุฏุ ุจูุงฺฉโูุง <code>finally</code> ุฏุฑ ูพุดุชูโ ุงุฌุฑุง Background Thread ุงุฌุฑุง ููโุดููุฏ.<br>
ุจูุงุจุฑุงู ุงฺฏุฑ ุจุฑุง ูพุงฺฉโุณุงุฒ (ูุซู ุญุฐู ูุงูโูุง ูููุช) ุงุฒ <code>finally</code> ุง <code>using</code> ุงุณุชูุงุฏู ูโฺฉูุฏุ ุจุงุฏ ูุทูุฆู ุดูุฏ ููฺฏุงู ุฎุฑูุฌ ุงุฒ ุจุฑูุงููุ ุงู Threadูุง ุจูโุทูุฑ ุตุญุญ ุจู ูพุงุงู ุจุฑุณูุฏ (ูุซูุงู ุจุง <code>Join</code> ุง <strong>Signaling</strong>). ููุดู ูู ุจุงุฏ <strong>Timeout</strong> ุชุนู ฺฉูุฏ ุชุง ุฏุฑ ุตูุฑุช ูุฌุจุงุฒ ฺฉ Threadุ ุจุฑูุงูู ุจุณุชู ูุดูุฏ.</p>
<hr>
<h2>๐๏ธ ุงูููุช Threads</h2>
<p>ูฺฺฏ <code>Priority</code> ุชุนู ูโฺฉูุฏ ฺฉ Thread ฺู ูุฒุงู ุฒูุงู ูพุฑุฏุงุฒุด ูุณุจุช ุจู ุณุงุฑ Threadูุง ุฏุฑุงูุช ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-built_in">enum</span> ThreadPriority { Lowest, BelowNormal, Normal, AboveNormal, Highest }
</code></pre>
<p>ุงู ููุถูุน ุฒูุงู ุงููุช ุฏุงุฑุฏ ฺฉู ฺูุฏู Thread ููโุฒูุงู ูุนุงู ุจุงุดูุฏ.</p>
<ul>
<li>ุจุงูุง ุจุฑุฏู ุงูููุช ูโุชูุงูุฏ ุจุงุนุซ ุดูุฏ Threadูุง ุฏฺฏุฑ <strong>ฺฏุฑุณูู</strong> ุจูุงููุฏ.</li>
<li>ุงฺฏุฑ ูโุฎูุงูุฏ Thread ุดูุง ุงูููุช ุจุงูุงุชุฑ ุงุฒ ุณุงุฑ Processูุง ุฏุงุดุชู ุจุงุดุฏุ ุจุงุฏ ุงูููุช Process ุฑุง ูู ุจุงูุง ุจุจุฑุฏ:</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">using</span> Process p = Process.GetCurrentProcess();
p.PriorityClass = ProcessPriorityClass.High;
</code></pre>
<p>ุงู ฺฉุงุฑ ุจุฑุง <strong>ูพุฑุฏุงุฒุดโูุง ุบุฑ-UI ฺฉูฺฺฉ ุจุง ูุงุฒ ุจู ูุงฺฉูุด ุณุฑุน</strong> ููุงุณุจ ุงุณุช. ุงูุง ุฏุฑ ุจุฑูุงููโูุง ูพุฑูุตุฑู (ูุฎุตูุตุงู ุจุง UI)ุ ุงูุฒุงุด ุงูููุช Process ูโุชูุงูุฏ ฺฉู ุณุณุชู ุฑุง ฺฉูุฏ ฺฉูุฏ.</p>
<hr>
<h2>๐ก Signaling</h2>
<p>ฺฏุงู ูุงุฒู ุงุณุช ฺฉ Thread ููุชุธุฑ ุจูุงูุฏ ุชุง ุงุฒ Threadูุง ุฏฺฏุฑ ุณฺฏูุงู ุฏุฑุงูุช ฺฉูุฏ.<br>
ุณุงุฏูโุชุฑู ุณุงุฒู ุจุฑุง ุงู ฺฉุงุฑ <strong>ManualResetEvent</strong> ุงุณุช:</p>
<ul>
<li><code>WaitOne</code> โ Thread ูุนู ุฑุง ูุณุฏูุฏ ูโฺฉูุฏ.</li>
<li><code>Set</code> โ ุณฺฏูุงู ุฑุง ุจุงุฒ ูโฺฉูุฏ ู ููุชุธุฑูุง ุขุฒุงุฏ ูโุดููุฏ.</li>
</ul>
<p>ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> signal = <span class="hljs-keyword">new</span> ManualResetEvent (<span class="hljs-literal">false</span>);

<span class="hljs-keyword">new</span> Thread (() =&gt;
{
    Console.WriteLine (<span class="hljs-string">&quot;Waiting for signal...&quot;</span>);
    signal.WaitOne();
    signal.Dispose();
    Console.WriteLine (<span class="hljs-string">&quot;Got signal!&quot;</span>);
}).Start();

Thread.Sleep(<span class="hljs-number">2000</span>);
signal.Set();  <span class="hljs-comment">// ุณฺฏูุงู ุจุงุฒ ุดุฏ</span>
</code></pre>
<p>ุจุนุฏ ุงุฒ ูุฑุงุฎูุงู <code>Set</code>ุ ุณฺฏูุงู ุจุงุฒ ูโูุงูุฏ ุชุง ุฒูุงู ฺฉู ุฏูุจุงุฑู <code>Reset</code> ุดูุฏ.<br>
CLR ุณุงุฒูโูุง Signaling ูุชููุน ุฏุงุฑุฏ ฺฉู ุฏุฑ ูุตู ฒฑ ุจุฑุฑุณ ูโุดููุฏ.</p>
<hr>
<h2>๐ฅ๏ธ Threading ุฏุฑ ุจุฑูุงููโูุง Rich Client</h2>
<p>ุฏุฑ ุจุฑูุงููโูุง <strong>WPFุ UWP ู Windows Forms</strong>ุ ุงุฌุฑุง ุนููุงุช ุทููุงู ุฑู Thread ุงุตู ุจุงุนุซ <strong>ููฺฏ ฺฉุฑุฏู UI</strong> ูโุดูุฏุ ฺูู ููุงู Thread ูุณุฆูู ูพุฑุฏุงุฒุด ูุฑูุฏโูุง (ฺฉุจูุฑุฏ/ูุงูุณ) ู ุฑูุฏุฑ ุฑุงุจุท ฺฉุงุฑุจุฑ ุงุณุช.</p>
<p>ุฑุงูโุญู:</p>
<ul>
<li>ุงุฌุงุฏ <strong>Worker Thread</strong> ุจุฑุง ฺฉุงุฑูุง ุฒูุงูโุจุฑ.</li>
<li>ุณูพุณ ุงูุชูุงู ูุชุฌู ุจู Thread ุงุตู ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI.</li>
</ul>
<p>โ๏ธ ูููโ ุงู ูุฑูโูุฑฺฉโูุง ูุฏู Threading ุฏุงุฑูุฏ ฺฉู ููุท ุงุฌุงุฒู ูโุฏูุฏ UI ุชูุณุท ููุงู Thread ุฏุณุชุฑุณ ุงุจุฏ ฺฉู ุขู ุฑุง ุณุงุฎุชู ุงุณุช (ูุนูููุงู Thread ุงุตู). ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุฑูุชุงุฑ ูุงูุดุฎุต ุง Exception ุฑุฎ ูโุฏูุฏ.</p>
<p>ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI ุงุฒ Worker Thread ุจุงุฏ ุฏุฑุฎูุงุณุช ุฑุง ุจู UI Thread <strong>Marshal</strong> ฺฉูุฏ:</p>
<ul>
<li><strong>WPF</strong> โ ุจุง <code>Dispatcher.BeginInvoke</code> ุง <code>Dispatcher.Invoke</code></li>
<li><strong>UWP</strong> โ ุจุง <code>Dispatcher.RunAsync</code> ุง <code>Dispatcher.Invoke</code></li>
<li><strong>Windows Forms</strong> โ ุจุง <code>Control.BeginInvoke</code> ุง <code>Control.Invoke</code></li>
</ul>
<p><code>BeginInvoke</code>/<code>RunAsync</code> Delegate ุฑุง ุฏุฑ ุตู ูพุงู UI ูโฺฏุฐุงุฑูุฏ (ุบุฑูุณุฏูุฏฺฉููุฏู).<br>
<code>Invoke</code> ููุงู ฺฉุงุฑ ุฑุง ูโฺฉูุฏุ ุงูุง ุชุง ูพุฑุฏุงุฒุด Delegate ุชูุณุท UI Thread ุตุจุฑ ูโฺฉูุฏ (ูุณุฏูุฏฺฉููุฏู ู ุจุง ุงูฺฉุงู ุจุงุฒฺฏุดุช ููุฏุงุฑ).</p>
<hr>
<h2>๐ ูุซุงู ุฏุฑ WPF</h2>
<p>ูุฑุถ ฺฉูุฏ ฺฉ ูพูุฌุฑู WPF ุฏุงุฑู ฺฉู ุดุงูู TextBox ุจู ูุงู <code>txtMessage</code> ุงุณุช. ูโุฎูุงูู ูพุณ ุงุฒ ฺฉ ฺฉุงุฑ ุฒูุงูโุจุฑุ ูุชู ุขู ุฑุง ุชุบุฑ ุฏูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyWindow</span> : <span class="hljs-title">Window</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyWindow</span>()</span>
    {
        InitializeComponent();
        <span class="hljs-keyword">new</span> Thread (Work).Start();
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Work</span>()</span>
    {
        Thread.Sleep (<span class="hljs-number">5000</span>);           <span class="hljs-comment">// ุดุจูโุณุงุฒ ฺฉุงุฑ ุฒูุงูโุจุฑ</span>
        UpdateMessage (<span class="hljs-string">&quot;The answer&quot;</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UpdateMessage</span> (<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span>
    {
        Action action = () =&gt; txtMessage.Text = message;
        Dispatcher.BeginInvoke (action);
    }
}
</code></pre>
<p>๐น ูพูุฌุฑู ููุฑุงู ูพุงุณุฎโฺฏู ุฎูุงูุฏ ุจูุฏ.<br>
๐น ุจุนุฏ ุงุฒ ต ุซุงููุ TextBox ุจูโุฑูุฒุฑุณุงู ูโุดูุฏ.</p>
<p>ุฏุฑ Windows Forms ูู ูุดุงุจู ุงุณุชุ ุจุง ุงู ุชูุงูุช ฺฉู ุจุงุฏ ุงุฒ ูุชุฏ <code>BeginInvoke</code> ูุฑู ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UpdateMessage</span> (<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span>
{
    Action action = () =&gt; txtMessage.Text = message;
    <span class="hljs-keyword">this</span>.BeginInvoke (action);
}
</code></pre>
<hr>
<h2>๐ช ฺูุฏู UI Thread</h2>
<p>ุฏุฑ ฺฉ ุจุฑูุงูู ูโุชูุงู ฺูุฏู UI Thread ุฏุงุดุชุ ูุฑฺฉุฏุงู ูุงูฺฉ ฺฉ <strong>ูพูุฌุฑูโ ูุณุชูู</strong>.<br>
ุงู ูุนูููุงู ุฏุฑ <strong>SDI Applications</strong> (ูุซู Microsoft Word) ุงุณุชูุงุฏู ูโุดูุฏ. ูุฑ ูพูุฌุฑูโ ูุณุชูู ูโุชูุงูุฏ UI Thread ุฎูุฏุด ุฑุง ุฏุงุดุชู ุจุงุดุฏ ุชุง ูพุงุณุฎโฺฏู ุจุดุชุฑ ุจู ฺฉุงุฑุจุฑ ุงุฑุงุฆู ุฏูุฏ.</p>
<h3>ฺฉุงูุชฺฉุณุชโูุง ููฺฏุงูโุณุงุฒ (Synchronization Contexts) ๐</h3>
<p>ุฏุฑ ูุถุง ูุงู <strong>System.ComponentModel</strong> ฺฉูุงุณ ุจู ูุงู <strong>SynchronizationContext</strong> ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุงูฺฉุงู <strong>ุนูููุช ุฏุงุฏู ุจู Thread Marshaling</strong> ุฑุง ูุฑุงูู ูโฺฉูุฏ.</p>
<p>๐ฑ๐ป ุฏุฑ APIูุง ูุฑุจูุท ุจู rich-client ุจุฑุง ููุจุงู ู ุฏุณฺฉุชุงูพ (ุนู <strong>UWPุ WPF ู Windows Forms</strong>) ูุฑฺฉุฏุงู ุฒุฑฺฉูุงุณ ุงุฒ <strong>SynchronizationContext</strong> ุชุนุฑู ู ุงุฌุงุฏ ูโฺฉููุฏ. ุดูุง ูโุชูุงูุฏ ุงู ููููู ุฑุง ุงุฒ ุทุฑู ูฺฺฏ (Property) ุงุณุชุง ุจู ูุงู <strong>SynchronizationContext.Current</strong> (ููุช ุฑู ฺฉ UI thread ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชุฏ) ุจูโุฏุณุช ุขูุฑุฏ.</p>
<p>ฺฏุฑูุชู ุงู property ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุจุนุฏุงู ุงุฒ ุฏุงุฎู ฺฉ worker thread ุจู ฺฉูุชุฑูโูุง UI โpostโ ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyWindow</span> : <span class="hljs-title">Window</span>
{
    SynchronizationContext _uiSyncContext;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyWindow</span>()</span>
    {
        InitializeComponent();
        <span class="hljs-comment">// ฺฏุฑูุชู ฺฉุงูุชฺฉุณุช ููฺฏุงูโุณุงุฒ ุจุฑุง UI thread ุฌุงุฑ:</span>
        _uiSyncContext = SynchronizationContext.Current;
        <span class="hljs-keyword">new</span> Thread(Work).Start();
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Work</span>()</span>
    {
        Thread.Sleep(<span class="hljs-number">5000</span>);   <span class="hljs-comment">// ุดุจูโุณุงุฒ ฺฉ ฺฉุงุฑ ุฒูุงูโุจุฑ</span>
        UpdateMessage(<span class="hljs-string">&quot;The answer&quot;</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">UpdateMessage</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> message</span>)</span>
    {
        <span class="hljs-comment">// Marshal ฺฉุฑุฏู delegate ุจู UI thread:</span>
        _uiSyncContext.Post(_ =&gt; txtMessage.Text = message, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<p>๐ ุงู ุฑูุด ููุฏ ุงุณุช ฺูู ุฏุฑ ูููโ APIูุง ุฑุงุจุท ฺฉุงุฑุจุฑ rich-client ุจู ฺฉ ุดฺฉู ฺฉุงุฑ ูโฺฉูุฏ.</p>
<p>ูุฑุงุฎูุงู <strong>Post</strong> ูุนุงุฏู ูุฑุงุฎูุงู <strong>BeginInvoke</strong> ุฑู ฺฉ Dispatcher ุง Control ุงุณุช. ููฺูู ูุชุฏ ุจู ูุงู <strong>Send</strong> ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ูุนุงุฏู <strong>Invoke</strong> ุงุณุช.</p>
<hr>
<h3>Thread Pool ๐โโ๏ธ</h3>
<p>ููุช ฺฉ thread ุฌุฏุฏ ุงุฌุงุฏ ูโฺฉูุฏุ ฺูุฏ ุตุฏ ูฺฉุฑูุซุงูู ุตุฑู ุขูุงุฏูโุณุงุฒ ฺุฒูุง ูุซู stack ูุชุบุฑูุง ูุญู ูโุดูุฏ. <strong>Thread Pool</strong> ุงู overhead ุฑุง ฺฉุงูุด ูโุฏูุฏ ฺูู ุดุงูู ูุฌููุนูโุง ุงุฒ threadูุง ุงุฒ ูพุด ุณุงุฎุชูโุดุฏู ู ูุงุจู ุจุงุฒุงูุช ุงุณุช.</p>
<p>๐น ุงุณุชูุงุฏู ุงุฒ Thread Pool ุจุฑุง ุจุฑูุงููโููุณ ููุงุฒ ฺฉุงุฑุขูุฏ ู <strong>Concurrency</strong> ุฑุฒุฏุงููโุง ุถุฑูุฑ ุงุณุช. ุงู ฺฉุงุฑ ุงุฌุงุฒู ูโุฏูุฏ ุนููุงุชโูุง ฺฉูุชุงู ุงุฌุฑุง ุดููุฏ ุจุฏูู ุงูฺฉู overhead ุงุฌุงุฏ Thread ุฒุงุฏ ุดูุฏ.</p>
<p>ุงูุง ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ pooled threadูุง ุจุงุฏ ฺูุฏ ูฺฉุชู ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:</p>
<ul>
<li>๐ซ ููโุชูุงูุฏ ุฎุงุตุช <strong>Name</strong> ุฑุง ุจุฑุง pooled threadูุง ุชูุธู ฺฉูุฏ (ุงุดฺฉุงูโุฒุฏุง ุณุฎุชโุชุฑ ูโุดูุฏุ ฺฏุฑฺู ุฏุฑ Visual Studio ูโุชูุงูุฏ ฺฉ description ุจู ุขูโูุง ุงุถุงูู ฺฉูุฏ).</li>
<li>๐ pooled threadูุง ููุดู <strong>background thread</strong> ูุณุชูุฏ.</li>
<li>โ ุจูุงฺฉ ฺฉุฑุฏู pooled threadูุง ูโุชูุงูุฏ ุนููฺฉุฑุฏ ุฑุง ฺฉุงูุด ุฏูุฏ (ูฺฏุงู ฺฉูุฏ ุจู ยซHygiene in the thread poolยป).</li>
</ul>
<p>ูโุชูุงูุฏ <strong>Priority</strong> ฺฉ pooled thread ุฑุง ุชุบุฑ ุฏูุฏุ ููุช thread ุขุฒุงุฏ ุดูุฏ ู ุจู Pool ุจุฑฺฏุฑุฏุฏุ ููุฏุงุฑุด ุฏูุจุงุฑู ุฑู Normal ุชูุธู ูโุดูุฏ.</p>
<p>ุจุฑุง ุจุฑุฑุณ ุงูฺฉู ุขุง ุฏุฑ ุญุงู ุญุงุถุฑ ุฑู ฺฉ pooled thread ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชุฏ ุง ููุ ูโุชูุงูุฏ ุงุฒ ุฎุงุตุช <strong>Thread.CurrentThread.IsThreadPoolThread</strong> ุงุณุชูุงุฏู ฺฉูุฏ.</p>
<hr>
<h3>ูุฑูุฏ ุจู Thread Pool ๐</h3>
<p>ุณุงุฏูโุชุฑู ุฑุงู ุงุฌุฑุง ุตุฑุญ ฺฉ ฺฉุงุฑ ุฏุฑ thread pool ุงุณุชูุงุฏู ุงุฒ <strong>Task.Run</strong> ุงุณุช (ุงู ููุถูุน ุฑุง ุฏุฑ ุจุฎุด ุจุนุฏ ฺฉุงููโุชุฑ ุชูุถุญ ูโุฏูู):</p>
<pre class="hljs"><code><span class="hljs-comment">// Task ุฏุฑ ูุถุง ูุงู System.Threading.Tasks ุงุณุช</span>
Task.Run(() =&gt; Console.WriteLine(<span class="hljs-string">&quot;Hello from the thread pool&quot;</span>));
</code></pre>
<p>ูุจู ุงุฒ ูุณุฎูโ <strong>.NET Framework 4.0</strong> ฺฉู Task ูุฌูุฏ ูุฏุงุดุชุ ุฑูุด ุฑุงุฌ ุงุณุชูุงุฏู ุงุฒ <strong>ThreadPool.QueueUserWorkItem</strong> ุจูุฏ:</p>
<pre class="hljs"><code>ThreadPool.QueueUserWorkItem(notUsed =&gt; Console.WriteLine(<span class="hljs-string">&quot;Hello&quot;</span>));
</code></pre>
<p>ููฺูู ุงุณุชูุงุฏูโูุง ุฒุฑ ุจูโุทูุฑ ุถูู ุงุฒ thread pool ุจูุฑู ูโุจุฑูุฏ:</p>
<ul>
<li>๐ ุณุฑูุฑูุง ุงูพูฺฉุดู <strong><a href="http://ASP.NET">ASP.NET</a> Core</strong> ู <strong>Web API</strong></li>
<li>โฑ๏ธ ฺฉูุงุณโูุง <strong>System.Timers.Timer</strong> ู <strong>System.Threading.Timer</strong></li>
<li>๐ ุณุงุฎุชุงุฑูุง ุจุฑูุงููโููุณ ููุงุฒ (ุชูุถุญ ุฏุฑ ูุตู 22)</li>
<li>โ๏ธ ฺฉูุงุณ ูุฏู <strong>BackgroundWorker</strong></li>
</ul>
<hr>
<h3>ุฑุนุงุช ุจูุฏุงุดุช ุฏุฑ Thread Pool ๐งน</h3>
<p>Thread Pool ูุธูู ุฏฺฏุฑ ูู ุฏุงุฑุฏ: ุฌููฺฏุฑ ุงุฒ ุงุฌุงุฏ <strong>oversubscription</strong>.</p>
<p>โ Oversubscription ุนู ุชุนุฏุงุฏ threadูุง ูุนุงู ุจุดุชุฑ ุงุฒ ุชุนุฏุงุฏ ูุณุชูโูุง CPU ุจุงุดุฏ ู ุณุณุชูโุนุงูู ูุฌุจูุฑ ุดูุฏ ุจู ุขูโูุง time-slice ุงูุฌุงู ุฏูุฏ. ุงู ฺฉุงุฑ ฺฉุงุฑุง ุฑุง ฺฉุงูุด ูโุฏูุฏ ฺูู context switch ูพุฑูุฒูู ุงุณุช ู cacheูุง CPU ุฑุง ูู ุจโุงุนุชุจุงุฑ ูโฺฉูุฏ.</p>
<p>โ CLR ุงุฒ oversubscription ุฌููฺฏุฑ ูโฺฉูุฏ ุจุง:</p>
<ul>
<li>ุตูโุจูุฏ (queue) ฺฉุฑุฏู ุชุณฺฉโูุง</li>
<li>ู ฺฉูุชุฑู ุดุฑูุน ุขูโูุง</li>
</ul>
<p>ุงูู ุจู ุงูุฏุงุฒู ุชุนุฏุงุฏ ูุณุชูโูุง ุณุฎุชโุงูุฒุงุฑ ุชุณฺฉโูุง ุฑุง ุจูโุทูุฑ ููุฒูุงู ุงุฌุฑุง ูโฺฉูุฏุ ุณูพุณ ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ุงูฺฏูุฑุชู hill-climbing ุณุทุญ Concurrency ุฑุง ุชูุธู ูโฺฉูุฏ. ุงฺฏุฑ throughput ุจูุชุฑ ุดูุฏุ ุฏุฑ ููุงู ุฌูุช ุงุฏุงูู ูโุฏูุฏ ูฺฏุฑูู ูุณุฑุด ุฑุง ุนูุถ ูโฺฉูุฏ.</p>
<p>ุงู ุงุณุชุฑุงุชฺ ุฏุฑ ุตูุฑุช ุจูุชุฑู ุนููฺฉุฑุฏ ุฑุง ุฏุงุฑุฏ ฺฉู:</p>
<ol>
<li>๐ ฺฉุงุฑูุง ฺฉูุชุงูโูุฏุช ุจุงุดูุฏ (ฺฉูุชุฑ ุงุฒ ฒตฐ ููโุซุงููุ ู ุชุฑุฌุญุงู ุฒุฑ ฑฐฐ ููโุซุงูู).</li>
<li>๐ซ ฺฉุงุฑูุง ฺฉู ุจุดุชุฑ ููุชุดุงู ุฑุง ุฏุฑ ุญุงูุช <strong>Blocked</strong> ูุณุชูุฏุ ุบุงูุจ ูุจุงุดูุฏ.</li>
</ol>
<p>ุจูุงฺฉ ุดุฏู ูุดฺฉูโุณุงุฒ ุงุณุช ฺูู CLR ุชุตูุฑ ูโฺฉูุฏ CPU ุฏุฑฺฏุฑ ุงุณุช. CLR ููุดููุฏ ุงุณุช ู ุจุฑุง ุฌุจุฑุงู threadูุง ุจุดุชุฑ ูุงุฑุฏ Pool ูโฺฉูุฏุ ุงูุง ุงู ฺฉุงุฑ ูโุชูุงูุฏ ุฏูุจุงุฑู ุจู oversubscription ููุฌุฑ ุดูุฏ ู ููฺูู ุจุงุนุซ ุชุฃุฎุฑ (latency) ุดูุฏุ ูุฎุตูุตุงู ุฏุฑ ุงุจุชุฏุง ุงุฌุฑุง ุงูพูฺฉุดู (ุจุดุชุฑ ุฏุฑ ุณุณุชูโุนุงููโูุง client ฺฉู ูุตุฑู ููุงุจุน ูพุงูโุชุฑ ุชุฑุฌุญ ุฏุงุฏู ูโุดูุฏ).</p>
<p>๐ ุฑุนุงุช ุจูุฏุงุดุช ุฏุฑ Thread Pool ููุช ุงููุช ุจุดุชุฑ ุฏุงุฑุฏ ฺฉู ุจุฎูุงูุฏ CPU ุฑุง ุจูโุทูุฑ ฺฉุงูู ุงุณุชูุงุฏู ฺฉูุฏ (ูุซูุงู ุจุง ุงุณุชูุงุฏู ุงุฒ APIูุง ุจุฑูุงููโููุณ ููุงุฒ ุฏุฑ ูุตู 22).</p>
<h3>ุชุณฺฉโูุง (Tasks) โก</h3>
<p>๐น ฺฉ <strong>Thread</strong> ุงุจุฒุงุฑ ุณุทุญ ูพุงู ุจุฑุง ุงุฌุงุฏ <strong>Concurrency</strong> ุงุณุช ู ูุญุฏูุฏุชโูุง ุฏุงุฑุฏุ ุงุฒ ุฌููู:</p>
<ul>
<li>๐ฅ ุงฺฏุฑฺู ูุฑุณุชุงุฏู ุฏุงุฏู ุจู ุฏุงุฎู ฺฉ Thread ฺฉู ุงุฌุงุฏ ฺฉุฑุฏูโุงุฏ ุณุงุฏู ุงุณุชุ ฺฏุฑูุชู ฺฉ <strong>ููุฏุงุฑ ุจุงุฒฺฏุดุช (return value)</strong> ุงุฒ Thread ฺฉู Join ฺฉุฑุฏูโุงุฏ ุขุณุงู ูุณุช. ุจุงุฏ ฺฉ <strong>ููุฏ ูุดุชุฑฺฉ</strong> ุชูุธู ฺฉูุฏ. ููฺูู ุงฺฏุฑ ุนููุงุช ฺฉ <strong>Exception</strong> ูพุฑุชุงุจ ฺฉูุฏุ ฺฏุฑูุชู ู ููุชูู ฺฉุฑุฏู ุขู ูู ุฏุฑุฏุณุฑ ุฏุงุฑุฏ.</li>
<li>๐ ููโุชูุงูุฏ ุจู Thread ุจฺฏูุฏ ููุช ุชูุงู ุดุฏ ฺุฒ ุฏฺฏุฑ ุฑุง ุดุฑูุน ฺฉูุฏุ ุจูฺฉู ุจุงุฏ ุขู ุฑุง Join ฺฉูุฏ (ฺฉู ุจุงุนุซ ุจูุงฺฉ ุดุฏู Thread ุฎูุฏุชุงู ูโุดูุฏ).</li>
</ul>
<p>ุงู ูุญุฏูุฏุชโูุง ุจุงุนุซ ูโุดููุฏ <strong>Concurrency ุฑุฒุฏุงููโุง (fine-grained)</strong> ุณุฎุช ุดูุฏุ ุนู ุชุฑฺฉุจ ุนููุงุชโูุง ฺฉูฺฺฉโุชุฑ ุจุฑุง ุณุงุฎุช ุนููุงุชโูุง ููุฒูุงู ุจุฒุฑฺฏโุชุฑ ูุดฺฉู ุงุณุช (ฺฉู ุจุฑุง <strong>ุจุฑูุงููโููุณ Asynchronous</strong> ุญุงุช ุงุณุช). ุฏุฑ ูุชุฌู ูุงุฒ ุจู <strong>synchronization ุฏุณุช</strong> (ูุซู Lockingุ Signaling ู ุบุฑู) ุจุดุชุฑ ูโุดูุฏ ฺฉู ุฎูุฏุด ูุดฺฉูุงุช ุฏฺฏุฑ ุฏุงุฑุฏ.</p>
<p>ููฺูู ุงุณุชูุงุฏู ูุณุชูู ุงุฒ Threadูุง ุงุซุฑุงุช ููู ุฑู <strong>ฺฉุงุฑุง</strong> ุฏุงุฑุฏ (ุชูุถุญ ุฏุฑ ุจุฎุด ยซThread Poolยป). ุงฺฏุฑ ูุงุฒ ุจู ุงุฌุฑุง ุตุฏูุง ุง ูุฒุงุฑุงู ุนููุงุช I/O ููุฒูุงู ุฏุงุดุชู ุจุงุดุฏุ ุฑูฺฉุฑุฏ Threadโูุญูุฑ ุจุงุนุซ ูุตุฑู ุตุฏูุง ุง ูุฒุงุฑุงู ูฺฏุงุจุงุช ุญุงูุธู ุตุฑูุงู ุจุฑุง overhead ูุฑุจูุท ุจู Threadูุง ูโุดูุฏ.</p>
<p>โ ฺฉูุงุณ <strong>Task</strong> ุจู ููู ุงู ูุดฺฉูุงุช ฺฉูฺฉ ูโฺฉูุฏ. <strong>Task</strong> ูุณุจุช ุจู Thread ฺฉ <strong>ุงูุชุฒุงุน ุณุทุญ ุจุงูุงุชุฑ</strong> ุงุณุชุ ุนู ูุดุงูโุฏููุฏู ฺฉ ุนููุงุช ููุฒูุงู ุงุณุช ฺฉู ููฺฉู ุงุณุช ูพุดุชุจุงูโุดุฏู ุชูุณุท Thread ุจุงุดุฏ ุง ูุจุงุดุฏ.</p>
<p>ูฺฺฏโูุง:</p>
<ul>
<li>๐ <strong>Taskูุง ุชุฑฺฉุจโูพุฐุฑ (compositional)</strong> ูุณุชูุฏ (ูโุชูุงูุฏ ุขูโูุง ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ Continuationูุง ุจู ูู ุฒูุฌุฑ ฺฉูุฏ).</li>
<li>๐ ูโุชูุงููุฏ ุงุฒ Thread Pool ุงุณุชูุงุฏู ฺฉููุฏ ุชุง ุฒูุงู ุดุฑูุน ุฑุง ฺฉู ฺฉููุฏ.</li>
<li>๐ ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>TaskCompletionSource</strong> ูโุชูุงููุฏ ุฑูฺฉุฑุฏ Callback ุฑุง ูพุงุฏูโุณุงุฒ ฺฉููุฏ ฺฉู ุงุตูุงู ูุงุฒ ุจู Threadูุง ูุฏุงุฑุฏ (ููุงุณุจ ุจุฑุง ุนููุงุช I/O-bound).</li>
</ul>
<p>ฺฉูุงุณโูุง Task ุฏุฑ <strong>.NET Framework 4.0</strong> ุจูโุนููุงู ุจุฎุด ุงุฒ ฺฉุชุงุจุฎุงูู ุจุฑูุงููโููุณ ููุงุฒ ูุนุฑู ุดุฏูุฏุ ู ุจุนุฏุงู ุจุง <strong>awaiters</strong> ุจูุจูุฏ ูพุฏุง ฺฉุฑุฏูุฏ ุชุง ุฏุฑ ุณูุงุฑููุง ุนููู Concurrency ูู ุฎูุจ ฺฉุงุฑ ฺฉููุฏ. ุขูโูุง ููฺูู ูพุงูโ <strong>ุชูุงุจุน Asynchronous ุฏุฑ C#</strong> ูุณุชูุฏ.</p>
<p>(ุฏุฑ ุงู ุจุฎุดุ ูฺฺฏโูุง Task ูุฑุชุจุท ุจุง <strong>ุจุฑูุงููโููุณ ููุงุฒ</strong> ุฑุง ฺฉูุงุฑ ูโฺฏุฐุงุฑู ู ุฏุฑ ูุตู 22 ุจู ุขูโูุง ูโูพุฑุฏุงุฒู.)</p>
<hr>
<h3>ุดุฑูุน ฺฉ Task โถ๏ธ</h3>
<p>ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง ุดุฑูุน ฺฉ Task ูพุดุชุจุงูโุดุฏู ุชูุณุท Thread ุงุณุชูุงุฏู ุงุฒ ูุชุฏ ุงุณุชุง <strong>Task.Run</strong> ุงุณุช (ฺฉูุงุณ Task ุฏุฑ ูุถุง ูุงู <strong>System.Threading.Tasks</strong> ุงุณุช):</p>
<pre class="hljs"><code>Task.Run(() =&gt; Console.WriteLine(<span class="hljs-string">&quot;Foo&quot;</span>));
</code></pre>
<p>ุจูโุทูุฑ ูพุดโูุฑุถุ Taskูุง ุฑู <strong>Thread Pool</strong> ุงุฌุฑุง ูโุดููุฏ ฺฉู <strong>background thread</strong> ูุณุชูุฏ.<br>
ุนู ููุช <strong>main thread</strong> ุชูุงู ุดูุฏุ ููู Taskูุง ฺฉู ุณุงุฎุชูโุงุฏ ูู ูุชููู ูโุดููุฏ.</p>
<p>ูพุณ ุฏุฑ ฺฉ <strong>Console Application</strong>ุ ุจุงุฏ main thread ุฑุง ุจุนุฏ ุงุฒ ุดุฑูุน Task ุจูุงฺฉ ฺฉูุฏ (ูุซูุงู ุจุง <strong>Wait</strong> ุฑู Task ุง ุจุง <strong>Console.ReadLine</strong>):</p>
<pre class="hljs"><code>Task.Run(() =&gt; Console.WriteLine(<span class="hljs-string">&quot;Foo&quot;</span>));
Console.ReadLine();
</code></pre>
<p>ุฏุฑ <strong>LINQPad</strong> ูุงุฒ ุจู <code>Console.ReadLine</code> ูุณุชุ ฺูู ูพุฑูุณูโ LINQPad ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ background threadูุง ุฑุง ุฒูุฏู ูฺฏู ูโุฏุงุฑุฏ.</p>
<p>ูุฑุงุฎูุงู <strong>Task.Run</strong> ุชูุฑุจุงู ุดุจู ุจู ุงุฌุงุฏ ฺฉ Thread ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-keyword">new</span> Thread(() =&gt; Console.WriteLine(<span class="hljs-string">&quot;Foo&quot;</span>)).Start();
</code></pre>
<p>ุงูุง <code>Task.Run</code> ฺฉ <strong>Task object</strong> ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ูโุชูุงูู ูุถุนุช ูพุดุฑูุช ุขู ุฑุง ูุงูุชูุฑ ฺฉูู (ูุดุงุจู Thread object).<br>
ุชูุฌู ฺฉูุฏ ฺฉู ุจุนุฏ ุงุฒ <code>Task.Run</code> ุฏฺฏุฑ <strong>Start</strong> ููโุฒูู ฺูู ุงู ูุชุฏ <strong>Hot Task</strong> ุงุฌุงุฏ ูโฺฉูุฏ. (ูโุชูุงูุฏ ุจุง ุณุงุฒูุฏูโ Task ฺฉ <strong>Cold Task</strong> ุจุณุงุฒุฏุ ุงูุง ุฏุฑ ุนูู ฺฉูโุงุณุชูุงุฏู ุงุณุช.)</p>
<p>ูโุชูุงูุฏ ูุถุนุช ุงุฌุฑุง Task ุฑุง ุงุฒ ุทุฑู ุฎุงุตุช <strong>Status</strong> ุจุฑุฑุณ ฺฉูุฏ.</p>
<hr>
<h3>Wait โณ</h3>
<p>ูุฑุงุฎูุงู <strong>Wait</strong> ุฑู ฺฉ Task ุจุงุนุซ ุจูุงฺฉ ุดุฏู ูโุดูุฏ ุชุง Task ฺฉุงูู ุดูุฏ (ูุดุงุจู ูุฑุงุฎูุงู <strong>Join</strong> ุฑู ฺฉ Thread):</p>
<pre class="hljs"><code>Task task = Task.Run(() =&gt;
{
    Thread.Sleep(<span class="hljs-number">2000</span>);
    Console.WriteLine(<span class="hljs-string">&quot;Foo&quot;</span>);
});
Console.WriteLine(task.IsCompleted);  <span class="hljs-comment">// False</span>
task.Wait();  <span class="hljs-comment">// ุชุง ุชฺฉูู Task ุจูุงฺฉ ูโุดูุฏ</span>
</code></pre>
<p>ูุชุฏ Wait ุงูฺฉุงู ุชุนู <strong>Timeout</strong> ู <strong>CancellationToken</strong> ุฑุง ูู ูโุฏูุฏ (ุชูุถุญ ุฏุฑ ุจุฎุด ยซCancellationยป ุตูุญู 681).</p>
<hr>
<h3>Long-running Tasks ๐ข</h3>
<p>ุจูโุทูุฑ ูพุดโูุฑุถุ CLR ุชุณฺฉโูุง ุฑุง ุฑู pooled threads ุงุฌุฑุง ูโฺฉูุฏ ฺฉู ุจุฑุง ฺฉุงุฑูุง <strong>ฺฉูุชุงูโูุฏุช ู compute-bound</strong> ุงุฏูโุขู ุงุณุช.</p>
<p>ุจุฑุง ฺฉุงุฑูุง <strong>ุจููุฏูุฏุช ุง blocking</strong> ูโุชูุงูุฏ ูุงูุน ุงุณุชูุงุฏู ุงุฒ pooled thread ุดูุฏ:</p>
<pre class="hljs"><code>Task task = Task.Factory.StartNew(() =&gt; ...,
    TaskCreationOptions.LongRunning);
</code></pre>
<p>ุงุฌุฑุง ฺฉ ุชุณฺฉ ุจููุฏูุฏุช ุฑู ฺฉ pooled thread ูุดฺฉู ูุฏุงุฑุฏุ ุงูุง ุงฺฏุฑ ฺูุฏู ุชุณฺฉ ุจููุฏูุฏุช ููุงุฒ ุงุฌุฑุง ุดููุฏ (ุฎุตูุตุงู ุขูโูุง ฺฉู Block ูโุดููุฏ)ุ ุนููฺฉุฑุฏ ฺฉุงูุด ูโุงุจุฏ.</p>
<p>ุฑุงูฺฉุงุฑูุง ุจูุชุฑ ุฏุฑ ุงู ุญุงูุช:</p>
<ul>
<li>ุงฺฏุฑ ุชุณฺฉโูุง <strong>I/O-bound</strong> ูุณุชูุฏ: ุงุฒ <strong>TaskCompletionSource</strong> ู ุชูุงุจุน <strong>Asynchronous</strong> ุจุฑุง ูพุงุฏูโุณุงุฒ Concurrency ุจุง Callbackูุง ุงุณุชูุงุฏู ฺฉูุฏ.</li>
<li>ุงฺฏุฑ ุชุณฺฉโูุง <strong>Compute-bound</strong> ูุณุชูุฏ: ุงุฒ ฺฉ <strong>Producer/Consumer Queue</strong> ุงุณุชูุงุฏู ฺฉูุฏ ุชุง Concurrency ุฑุง ฺฉูุชุฑู ฺฉุฑุฏู ู ุฌูู ฺฏุฑุณูฺฏ ุณุงุฑ Threadูุง ู ูพุฑูุณูโูุง ุฑุง ุจฺฏุฑุฏ (ุชูุถุญ ุฏุฑ ยซProducer/Consumer Queueยป ุตูุญู 970).</li>
</ul>
<hr>
<h3>ุจุงุฒฺฏุฑุฏุงูุฏู ููุงุฏุฑ ๐ข</h3>
<p>ฺฉูุงุณ Task ฺฉ ุฒุฑฺฉูุงุณ ุฌูุฑฺฉ ุจู ูุงู <strong>Task<TResult></strong> ุฏุงุฑุฏ ฺฉู ุงุฌุงุฒู ูโุฏูุฏ ฺฉ ููุฏุงุฑ ุจุงุฒฺฏุดุช ุชููุฏ ฺฉูุฏ.</p>
<p>ูโุชูุงูุฏ ุจุง ุฏุงุฏู ฺฉ <strong>Func<TResult></strong> (ุง lambda expression ุณุงุฒฺฏุงุฑ) ุจู Task.Run ฺฉ Task<TResult> ุจุณุงุฒุฏ:</p>
<pre class="hljs"><code>Task&lt;<span class="hljs-built_in">int</span>&gt; task = Task.Run(() =&gt; 
{ 
    Console.WriteLine(<span class="hljs-string">&quot;Foo&quot;</span>); 
    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; 
});
<span class="hljs-built_in">int</span> result = task.Result;   <span class="hljs-comment">// ุจูุงฺฉ ูโุดูุฏ ุชุง Task ุชูุงู ุดูุฏ</span>
Console.WriteLine(result);  <span class="hljs-comment">// 3</span>
</code></pre>
<p>ููููู: ูุญุงุณุจู ุชุนุฏุงุฏ ุงุนุฏุงุฏ ุงูู ุฏุฑ ุณู ูููู ุนุฏุฏ ุงูู:</p>
<pre class="hljs"><code>Task&lt;<span class="hljs-built_in">int</span>&gt; primeNumberTask = Task.Run(() =&gt;
    Enumerable.Range(<span class="hljs-number">2</span>, <span class="hljs-number">3000000</span>)
              .Count(n =&gt; Enumerable.Range(<span class="hljs-number">2</span>, (<span class="hljs-built_in">int</span>)Math.Sqrt(n)<span class="hljs-number">-1</span>)
              .All(i =&gt; n % i &gt; <span class="hljs-number">0</span>)));

Console.WriteLine(<span class="hljs-string">&quot;Task running...&quot;</span>);
Console.WriteLine(<span class="hljs-string">&quot;The answer is &quot;</span> + primeNumberTask.Result);
</code></pre>
<p>ุฎุฑูุฌ:</p>
<pre class="hljs"><code>Task running...
The answer is 216816
</code></pre>
<hr>
<h3>ูุฏุฑุช Exceptionูุง โ๏ธ</h3>
<p>๐ฎ <strong>Task<TResult></strong> ุดุจู ฺฉ <em>Future</em> ุงุณุชุ ุนู ูุชุฌูโุง ุฑุง ุฏุฑ ุขูุฏู ูฺฏู ูโุฏุงุฑุฏ.<br>
ุจุฑุฎูุงู Threadูุงุ ุชุณฺฉโูุง Exceptionูุง ุฑุง ุฑุงุญุช ููุชูู ูโฺฉููุฏ.</p>
<p>ุงฺฏุฑ ฺฉุฏ ุฏุงุฎู Task ฺฉ Exception ูุฏุฑุชโูุดุฏู ูพุฑุชุงุจ ฺฉูุฏ:</p>
<ul>
<li>ุงฺฏุฑ Wait ฺฉูุฏ ุง ุจู Result ุฏุณุชุฑุณ ุจุฒูุฏุ Exception ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดูุฏ.</li>
</ul>
<pre class="hljs"><code><span class="hljs-comment">// ุดุฑูุน ฺฉ Task ฺฉู NullReferenceException ูพุฑุชุงุจ ูโฺฉูุฏ:</span>
Task task = Task.Run(() =&gt; { <span class="hljs-keyword">throw</span> <span class="hljs-literal">null</span>; });

<span class="hljs-keyword">try</span>
{
    task.Wait();
}
<span class="hljs-keyword">catch</span> (AggregateException aex)
{
    <span class="hljs-keyword">if</span> (aex.InnerException <span class="hljs-keyword">is</span> NullReferenceException)
        Console.WriteLine(<span class="hljs-string">&quot;Null!&quot;</span>);
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">throw</span>;
}
</code></pre>
<p>๐งฉ CLR Exception ุฑุง ุฏุฑ ฺฉ <strong>AggregateException</strong> ุจุณุชูโุจูุฏ ูโฺฉูุฏ ุชุง ุจุง ุณูุงุฑููุง ุจุฑูุงููโููุณ ููุงุฒ ููโุฎูุงู ุฏุงุดุชู ุจุงุดุฏ (ุชูุถุญ ุฏุฑ ูุตู 22).</p>
<p>ูโุชูุงูุฏ ุจุฏูู ูพุฑุชุงุจ Exception ุจุฑุฑุณ ฺฉูุฏ ฺฉู ุขุง Task Faulted ุดุฏู ุง ููุ ุจุง ุงุณุชูุงุฏู ุงุฒ ูฺฺฏโูุง:</p>
<ul>
<li><strong>IsFaulted</strong></li>
<li><strong>IsCanceled</strong></li>
</ul>
<p>ุงฺฏุฑ ูุฑ ุฏู <code>false</code> ุจุงุดูุฏุ ุฎุทุง ุฑุฎ ูุฏุงุฏู.</p>
<ul>
<li>ุงฺฏุฑ <code>IsCanceled = true</code> ุจุงุดุฏุ ุนู ฺฉ <strong>OperationCanceledException</strong> ูพุฑุชุงุจ ุดุฏู (ุชูุถุญ ุฏุฑ ุจุฎุด ยซCancellationยป ุตูุญู 941).</li>
<li>ุงฺฏุฑ <code>IsFaulted = true</code> ุจุงุดุฏุ ููุน ุฏฺฏุฑ ุงุฒ Exception ุฑุฎ ุฏุงุฏู ู ุฎุงุตุช <strong>Exception</strong> ุฌุฒุฆุงุช ุฎุทุง ุฑุง ูุดุงู ูโุฏูุฏ.</li>
</ul>
<h3>ุงุณุชุซูุงูุง ู Taskูุง ูุณุชูู ๐จ</h3>
<p>ุฏุฑ ููุฑุฏ Taskูุง ูุณุชูู ุง ููุงู <strong>set-and-forget</strong> (ุนู ุขูโูุง ฺฉู ุดูุง ุฏฺฏุฑ ุจุง <code>Wait()</code> ุง <code>Result</code> ุง continuation ุจู ุณุฑุงุบุดุงู ููโุฑูุฏ)ุ ฺฉ <strong>ุฑูุด ุฏุฑุณุช</strong> ุงู ุงุณุช ฺฉู ุญุชูุงู ฺฉุฏ Task ุฑุง ุจูโุตูุฑุช ุตุฑุญ ูุฏุฑุช ุงุณุชุซูุง ุจููุณุฏ ุชุง ุงุฒ ุดฺฉุณุชโูุง ุฎุงููุด ุฌููฺฏุฑ ฺฉูุฏุ ุฏููุงู ููุงูโุทูุฑ ฺฉู ุฏุฑ ฺฉ Thread ุนุงุฏ ุนูู ูโฺฉูุฏ.</p>
<p>ูุงุฏุฏู ฺฏุฑูุชู ุงุณุชุซูุงูุง ุฒูุงู ูุดฺฉู ูุฏุงุฑุฏ ฺฉู ุขู ุงุณุชุซูุง ููุท ุจู ูุนู ุดฺฉุณุช ุฏุฑ ฺฏุฑูุชู ูุชุฌูโุง ุจุงุดุฏ ฺฉู ุฏฺฏุฑ ุจู ุขู ุนูุงููโุง ูุฏุงุฑุฏ.<br>
๐ ุจุฑุง ูุซุงูุ ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏุฑุฎูุงุณุช ุฏุงูููุฏ ฺฉ ุตูุญู ูุจ ุฑุง ูุบู ฺฉูุฏุ ุจุฑุงูุงู ููู ูุณุช ฺฉู ุฏุฑ ุงุฏุงูู ูุดุฎุต ุดูุฏ ุขู ุตูุญู ุงุตูุงู ูุฌูุฏ ูุฏุงุดุชู ุงุณุช.</p>
<p>ุงูุง ูุงุฏุฏู ฺฏุฑูุชู ุงุณุชุซูุง ุฒูุงู ูุดฺฉูโุณุงุฒ ูโุดูุฏ ฺฉู ุขู ุงุณุชุซูุง ูุดุงูโุฏููุฏูโ ฺฉ <strong>ุจุงฺฏ ุฏุฑ ุจุฑูุงูู</strong> ุจุงุดุฏุ ุจู ุฏู ุฏูู:</p>
<ul>
<li>๐ ููฺฉู ุงุณุช ุจุงฺฏ ุจุงุนุซ ุดูุฏ ุจุฑูุงูู ุฏุฑ ฺฉ ูุถุนุช ูุงูุนุชุจุฑ ุจุงู ุจูุงูุฏ.</li>
<li>๐งฉ ุงุญุชูุงู ุฏุงุฑุฏ ุงุณุชุซูุงูุง ุจุดุชุฑ ุฏุฑ ุขูุฏู ุฑุฎ ุฏููุฏ ู ุงฺฏุฑ ุฎุทุง ุงููู ุซุจุช (log) ูุดูุฏุ ุชุดุฎุต ูุดฺฉู ุณุฎุช ุฎูุงูุฏ ุดุฏ.</li>
</ul>
<p>ุดูุง ูโุชูุงูุฏ ุงุณุชุซูุงูุง ูุดุงูุฏูโูุดุฏู ุฑุง ุฏุฑ ุณุทุญ ุณุฑุงุณุฑ ูุฏุฑุช ฺฉูุฏุ ุงุฒ ุทุฑู ุฑูุฏุงุฏ ุงุณุชุงุชฺฉ <code>TaskScheduler.UnobservedTaskException</code>. ูุฏุฑุช ุงู ุฑูุฏุงุฏ ู ุซุจุช ุฎุทุง ูโุชูุงูุฏ ุจุณุงุฑ ููุทู ุจุงุดุฏ.</p>
<hr>
<h3>ูฺฉุงุช ุธุฑู ุฏุฑุจุงุฑูโ ุงุณุชุซูุงูุง ูุดุงูุฏูโูุดุฏู ๐ต๏ธโโ๏ธ</h3>
<p>ฺูุฏ ูฺฉุชู ุฌุงูุจ ุฏุฑ ููุฑุฏ ุงูฺฉู ฺู ฺุฒ <strong>unobserved</strong> ูุญุณูุจ ูโุดูุฏ ูุฌูุฏ ุฏุงุฑุฏ:</p>
<ul>
<li>ุงฺฏุฑ ุฑู ฺฉ Task ุจุง ุฒูุงูโุจูุฏ (timeout) ููุชุธุฑ ุจูุงูุฏ ู ุฎุทุง ุจุนุฏ ุงุฒ ูพุงุงู ุฒูุงู ุฑุฎ ุฏูุฏุ ุขู ุฎุทุง ุจูโุนููุงู ุงุณุชุซูุง ูุดุงูุฏูโูุดุฏู ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ.</li>
<li>ููู ฺฉู ูฺฺฏ <code>Exception</code> ฺฉ Task ุฑุง ุจุนุฏ ุงุฒ fault ุดุฏู ุจุฑุฑุณ ฺฉูุฏุ ุขู ุงุณุชุซูุง ยซobservedยป ูุญุณูุจ ูโุดูุฏ.</li>
</ul>
<hr>
<h3>Continuations ๐</h3>
<p>ฺฉ Continuation ุจู ฺฉ Task ูโฺฏูุฏ: ยซููุช ฺฉุงุฑุช ุชูุงู ุดุฏุ ุงุฏุงูู ุจุฏู ู ฺฉ ฺฉุงุฑ ุฏฺฏุฑ ุงูุฌุงู ุจุฏู.ยป<br>
ูุนูููุงู Continuation ุจูโุตูุฑุช ฺฉ <strong>callback</strong> ูพุงุฏูโุณุงุฒ ูโุดูุฏ ฺฉู ุฏุฑุณุช ูพุณ ุงุฒ ุงุชูุงู ุนููุงุช ุงุฌุฑุง ูโฺฏุฑุฏุฏ.</p>
<p>ุฏู ุฑูุด ุจุฑุง ุงุชุตุงู Continuation ุจู ฺฉ Task ูุฌูุฏ ุฏุงุฑุฏ. ุฑูุด ุงูู ุงููุช ูฺูโุง ุฏุงุฑุฏุ ฺูู ุชูุณุท ุชูุงุจุน <strong>asynchronous ุฏุฑ C#</strong> ุงุณุชูุงุฏู ูโุดูุฏ. ูุซุงู ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ (ููุงู ูุซุงู ุดูุงุฑุด ุงุนุฏุงุฏ ุงูู):</p>
<pre class="hljs"><code>Task&lt;<span class="hljs-built_in">int</span>&gt; primeNumberTask = Task.Run(() =&gt;
  Enumerable.Range(<span class="hljs-number">2</span>, <span class="hljs-number">3000000</span>).Count(n =&gt; 
    Enumerable.Range(<span class="hljs-number">2</span>, (<span class="hljs-built_in">int</span>)Math.Sqrt(n) - <span class="hljs-number">1</span>).All(i =&gt; n % i &gt; <span class="hljs-number">0</span>)));

<span class="hljs-keyword">var</span> awaiter = primeNumberTask.GetAwaiter();
awaiter.OnCompleted(() =&gt;
{
  <span class="hljs-built_in">int</span> result = awaiter.GetResult();
  Console.WriteLine(result); <span class="hljs-comment">// ููุงุด ูุชุฌู</span>
});
</code></pre>
<p>ูุฑุงุฎูุงู <code>GetAwaiter</code> ุฑู ฺฉ Taskุ ฺฉ <strong>awaiter object</strong> ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ูุชุฏ <code>OnCompleted</code> ุขูุ ุจู Task ูโฺฏูุฏ ูพุณ ุงุฒ ูพุงุงู (ุง ุฎุทุง)ุ ฺฉุฏุงู delegate ุงุฌุฑุง ุดูุฏ.<br>
ุญุช ูโุชูุงูุฏ ฺฉ Continuation ุฑุง ุฑู Task ฺฉู ูุจูุงู ฺฉุงูู ุดุฏู ูุตู ฺฉูุฏุ ุฏุฑ ุงู ุตูุฑุชุ Continuation ุจูุงูุงุตูู ุฒูุงูโุจูุฏ ู ุงุฌุฑุง ูโุดูุฏ.</p>
<p>ฺฉ <strong>awaiter</strong> ูุฑ ุดุฆ ุงุณุช ฺฉู ุฏู ูุชุฏ (<code>OnCompleted</code> ู <code>GetResult</code>) ู ฺฉ ูฺฺฏ ุจูู (<code>IsCompleted</code>) ุฏุงุดุชู ุจุงุดุฏ. ูฺ interface ุง ฺฉูุงุณ ูพุงูโ ูุดุชุฑฺฉ ุจุฑุง ููู ุงู ููุงุฑุฏ ูุฌูุฏ ูุฏุงุฑุฏ (ุงูุจุชู <code>OnCompleted</code> ุจุฎุด ุงุฒ ุงูุชุฑูุณ <code>INotifyCompletion</code> ุงุณุช).</p>
<p>๐ ุงฺฏุฑ Task ูุงุฏุฑ fault ุดูุฏุ ุงุณุชุซูุง ุฒูุงู ฺฉู continuation ูุฑุงุฎูุงู <code>GetResult()</code> ุฑุง ุงูุฌุงู ูโุฏูุฏ ุฏูุจุงุฑู ูพุฑุชุงุจ ูโุดูุฏ.<br>
ุจุฑุชุฑ <code>GetResult</code> ูุณุจุช ุจู ุฏุณุชุฑุณ ูุณุชูู ุจู <code>Result</code> ุงู ุงุณุช ฺฉู ุงุณุชุซูุงูุง ุฑุง ุจุฏูู ุจุณุชูโุจูุฏ ุฏุฑ <code>AggregateException</code> ูพุฑุชุงุจ ูโฺฉูุฏุ ฺฉู ุจุงุนุซ ฺฉุฏูุง <code>catch</code> ุชูุฒุชุฑ ูโุดูุฏ.</p>
<hr>
<h3>ูฺฉุชู ุฏุฑุจุงุฑูโ Synchronization Context ๐๏ธ</h3>
<p>ุงฺฏุฑ ฺฉ <strong>SynchronizationContext</strong> ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏุ <code>OnCompleted</code> ุขู ุฑุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ capture ูโฺฉูุฏ ู continuation ุฑุง ุฏุฑ ููุงู context ุงุฌุฑุง ูโฺฉูุฏ. ุงู ุจุฑุง ุงูพูฺฉุดูโูุง ุฑุงุจุท ฺฉุงุฑุจุฑ (UI) ุจุณุงุฑ ููุฏ ุงุณุชุ ฺูู Continuation ุจู ูุฎ UI ุจุงุฒฺฏุฑุฏุงูุฏู ูโุดูุฏ.</p>
<p>ุงูุง ุฏุฑ ฺฉุชุงุจุฎุงููโูุง ูุนูููุงู ูุทููุจ ูุณุชุ ฺูู ุงู ูพุฑุด ุจู ูุฎ UI ูุฒููโุจุฑ ุงุณุช.<br>
ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุขู ูโุชูุงู ุงุฒ ูุชุฏ <code>ConfigureAwait(false)</code> ุงุณุชูุงุฏู ฺฉุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> awaiter = primeNumberTask.ConfigureAwait(<span class="hljs-literal">false</span>).GetAwaiter();
</code></pre>
<p>ุงฺฏุฑ ูฺ SynchronizationContextุง ูุฌูุฏ ูุฏุงุดุชู ุจุงุดุฏโุง ุดูุง <code>ConfigureAwait(false)</code> ุงุณุชูุงุฏู ฺฉูุฏโContinuation ุจูโุทูุฑ ฺฉู ุฑู ฺฉ <strong>pooled thread</strong> ุงุฌุฑุง ูโุดูุฏ.</p>
<hr>
<h3>ุฑูุด ุฏูู: ContinueWith ๐งฉ</h3>
<p>ุฑูุด ุฏฺฏุฑ ุงุชุตุงู Continuationุ ูุฑุงุฎูุงู ูุชุฏ <code>ContinueWith</code> ุฑู Task ุงุณุช:</p>
<pre class="hljs"><code>primeNumberTask.ContinueWith(antecedent =&gt;
{
  <span class="hljs-built_in">int</span> result = antecedent.Result;
  Console.WriteLine(result); <span class="hljs-comment">// ููุงุด 123</span>
});
</code></pre>
<p>๐น <code>ContinueWith</code> ุฎูุฏุด ฺฉ Task ุจุฑูโฺฏุฑุฏุงูุฏุ ุจูุงุจุฑุงู ูโุชูุงูุฏ ฺูุฏู Continuation ุฒูุฌุฑูโุง ุจุณุงุฒุฏ.<br>
ุงูุง ุฏุฑ ุงู ุญุงูุช ุจุงุฏ ุจูโุตูุฑุช ูุณุชูู ุจุง <code>AggregateException</code> ุณุฑูฺฉุงุฑ ุฏุงุดุชู ุจุงุดุฏ ู ุจุฑุง ุงูพูฺฉุดูโูุง UI ฺฉุฏ ุงุถุงู ุจุฑุง <strong>marshal ฺฉุฑุฏู</strong> Continuation ุจููุณุฏ.<br>
ููฺูู ุฏุฑ ูุญุทโูุง ุบุฑ UIุ ุงฺฏุฑ ุจุฎูุงูุฏ Continuation ุฑู ููุงู ูุฎ ุงุฌุฑุง ุดูุฏุ ุจุงุฏ ฺฏุฒููโ <code>TaskContinuationOptions.ExecuteSynchronously</code> ุฑุง ูุดุฎุต ฺฉูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุจู thread pool ูพุฑุด ุฎูุงูุฏ ฺฉุฑุฏ.</p>
<p>๐ <code>ContinueWith</code> ุจูโูฺู ุฏุฑ ุณูุงุฑููุง <strong>parallel programming</strong> ููุฏ ุงุณุช (ุฏุฑ ูุตู 22 ุจูโุทูุฑ ฺฉุงูู ุจุฑุฑุณ ุฎูุงูุฏ ุดุฏ).</p>
<hr>
<h3>TaskCompletionSource โก</h3>
<p>ุชุง ุงูุฌุง ุฏุฏู ฺฉู <code>Task.Run</code> ฺฉ Task ูโุณุงุฒุฏ ฺฉู delegate ุฑุง ุฑู ฺฉ ูุฎ (pooled ุง ุบุฑ pooled) ุงุฌุฑุง ูโฺฉูุฏ. ุงูุง ุฑูุด ุฏฺฏุฑ ุงุณุชูุงุฏู ุงุฒ <code>TaskCompletionSource</code> ุงุณุช.</p>
<p><code>TaskCompletionSource</code> ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ฺฉ Task ุจุณุงุฒุฏ ฺฉู ุญุงุตู ูุฑ ุนููุงุช ุจุงุดุฏ ฺฉู ุฏุฑ ุขูุฏู ฺฉุงูู ุฎูุงูุฏ ุดุฏ. ุงู ฺฉุงุฑ ุงุฒ ุทุฑู ุณุงุฎุช ฺฉ Task ยซูุงุจุณุชูยป ุงูุฌุงู ูโุดูุฏ ฺฉู ุดูุง ุจูโุทูุฑ ุฏุณุช ฺฉูุชุฑูุด ูโฺฉูุฏ (ุจุง ูุดุฎุต ฺฉุฑุฏู ุฒูุงู ูพุงุงู ุง fault ุดุฏู ุนููุงุช).</p>
<p>ุงู ุฑูุด ุจุฑุง ุนููุงุชโูุง I/O-bound ุนุงู ุงุณุช: ุดูุง ููู ูุฒุงุง Taskูุง (ุงูุชูุงู ููุงุฏุฑ ุจุงุฒฺฏุดุชุ ุงุณุชุซูุงูุง ู Continuationูุง) ุฑุง ุฏุงุฑุฏุ ุจุฏูู ุงูฺฉู ฺฉ ูุฎ ุจุฑุง ฺฉู ูุฏุช ุงุดุบุงู ุดูุฏ.</p>
<p>ุจุฑุง ุงุณุชูุงุฏูุ ฺฉุงูุณุช ฺฉ ููููู ุงุฒ ฺฉูุงุณ ุจุณุงุฒุฏ. ุงู ฺฉูุงุณ ฺฉ ูฺฺฏ ุจู ูุงู <code>Task</code> ุฏุงุฑุฏ ฺฉู ููุงู Task ุงุณุช ฺฉู ูโุชูุงูุฏ ุฑู ุขู ููุชุธุฑ ุจูุงูุฏ ุง Continuation ูุตู ฺฉูุฏ. ฺฉูุชุฑู ฺฉุงูู Task ูู ุจุง ุฎูุฏ <code>TaskCompletionSource</code> ุงุณุช ุงุฒ ุทุฑู ูุชุฏูุง ุฒุฑ:</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TaskCompletionSource</span>&lt;<span class="hljs-title">TResult</span>&gt;
{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetResult</span> (<span class="hljs-params">TResult result</span>)</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetException</span> (<span class="hljs-params">Exception exception</span>)</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetCanceled</span>()</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TrySetResult</span> (<span class="hljs-params">TResult result</span>)</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TrySetException</span> (<span class="hljs-params">Exception exception</span>)</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TrySetCanceled</span>()</span>;
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TrySetCanceled</span> (<span class="hljs-params">CancellationToken cancellationToken</span>)</span>;
  ...
}
</code></pre>
<p>ูุฑุงุฎูุงู ูุฑฺฉุฏุงู ุงุฒ ุงู ูุชุฏูุง Task ุฑุง ุณฺฏูุงู ูโุฏูุฏ ู ุขู ุฑุง ุฏุฑ ูุถุนุช <strong>completed</strong>ุ <strong>faulted</strong> ุง <strong>canceled</strong> ูุฑุงุฑ ูโุฏูุฏ.</p>
<p>๐ ุงูุชุธุงุฑ ุงู ุงุณุช ฺฉู ุฏููุงู ฺฉ ุงุฒ ุงู ูุชุฏูุง ฺฉโุจุงุฑ ูุฑุงุฎูุงู ุดูุฏ. ุงฺฏุฑ ุฏูุจุงุฑู <code>SetResult</code>, <code>SetException</code> ุง <code>SetCanceled</code> ุตุฏุง ุฒุฏู ุดููุฏุ ุงุณุชุซูุง ูพุฑุชุงุจ ูโฺฉููุฏ. ุฏุฑุญุงูโฺฉู ูุชุฏูุง <code>Try*</code> ููุท ููุฏุงุฑ <code>false</code> ุจุฑูโฺฏุฑุฏุงููุฏ.</p>
<hr>
<h3>ููููู ฺฉุฏ: ฺุงูพ ุนุฏุฏ ดฒ ุจุนุฏ ุงุฒ ต ุซุงูู ๐</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> tcs = <span class="hljs-keyword">new</span> TaskCompletionSource&lt;<span class="hljs-built_in">int</span>&gt;();
<span class="hljs-keyword">new</span> Thread(() =&gt; { Thread.Sleep(<span class="hljs-number">5000</span>); tcs.SetResult(<span class="hljs-number">42</span>); })
{ IsBackground = <span class="hljs-literal">true</span> }
.Start();
Task&lt;<span class="hljs-built_in">int</span>&gt; task = tcs.Task;         
Console.WriteLine(task.Result);   <span class="hljs-comment">// 42</span>
</code></pre>
<hr>
<h3>ููุดุชู ูุชุฏ Run ุงุฎุชุตุงุต ๐</h3>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-title">Task</span>&lt;<span class="hljs-title">TResult</span>&gt; <span class="hljs-title">Run</span>&lt;<span class="hljs-title">TResult</span>&gt;(<span class="hljs-params">Func&lt;TResult&gt; function</span>)</span>
{
  <span class="hljs-keyword">var</span> tcs = <span class="hljs-keyword">new</span> TaskCompletionSource&lt;TResult&gt;();
  <span class="hljs-keyword">new</span> Thread(() =&gt;
  {
    <span class="hljs-keyword">try</span> { tcs.SetResult(function()); }
    <span class="hljs-keyword">catch</span> (Exception ex) { tcs.SetException(ex); }
  }).Start();
  <span class="hljs-keyword">return</span> tcs.Task;
}
...
Task&lt;<span class="hljs-built_in">int</span>&gt; task = Run(() =&gt; { Thread.Sleep(<span class="hljs-number">5000</span>); <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; });
</code></pre>
<p>ุงู ฺฉุงุฑ ูุนุงุฏู ูุฑุงุฎูุงู <code>Task.Factory.StartNew</code> ุจุง ฺฏุฒููโ <code>TaskCreationOptions.LongRunning</code> ุงุณุช.</p>
<hr>
<h3>ูุฏุฑุช ุงุตู TaskCompletionSource โก</h3>
<p>ูุฏุฑุช ูุงูุน ุงู ุฑูุด ุฏุฑ ุณุงุฎุช Taskูุง ุงุณุช ฺฉู <strong>ูุฎ ุฑุง ุงุดุบุงู ููโฺฉููุฏ</strong>. ุจุฑุง ูุซุงู:<br>
ูโุฎูุงูู Task ุจุณุงุฒู ฺฉู ุจุนุฏ ุงุฒ ต ุซุงูู ููุฏุงุฑ ดฒ ุฑุง ุจุฑฺฏุฑุฏุงูุฏ. ูโุชูุงูู ุจุฏูู ุงุณุชูุงุฏู ุงุฒ Thread ู ููุท ุจุง ุงุณุชูุงุฏู ุงุฒ <code>Timer</code> ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏูู:</p>
<pre class="hljs"><code><span class="hljs-function">Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetAnswerToLife</span>()</span>
{
  <span class="hljs-keyword">var</span> tcs = <span class="hljs-keyword">new</span> TaskCompletionSource&lt;<span class="hljs-built_in">int</span>&gt;();
  <span class="hljs-keyword">var</span> timer = <span class="hljs-keyword">new</span> System.Timers.Timer(<span class="hljs-number">5000</span>) { AutoReset = <span class="hljs-literal">false</span> };
  timer.Elapsed += <span class="hljs-built_in">delegate</span> { timer.Dispose(); tcs.SetResult(<span class="hljs-number">42</span>); };
  timer.Start();
  <span class="hljs-keyword">return</span> tcs.Task;
}
</code></pre>
<p>ุจุง ูุตู ฺฉุฑุฏู ฺฉ Continuation ุจู ุงู Task:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> awaiter = GetAnswerToLife().GetAwaiter();
awaiter.OnCompleted(() =&gt; Console.WriteLine(awaiter.GetResult()));
</code></pre>
<hr>
<h3>ุณุงุฎุช ูุชุฏ Delay ุนููู โฑ๏ธ</h3>
<p>ูโุชูุงูู ฺฉุฏ ุจููุณู ฺฉู ููุท ุตุจุฑ ฺฉูุฏ (ุจุฏูู ููุฏุงุฑ ุจุงุฒฺฏุดุช):</p>
<pre class="hljs"><code><span class="hljs-function">Task <span class="hljs-title">Delay</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> milliseconds</span>)</span>
{
  <span class="hljs-keyword">var</span> tcs = <span class="hljs-keyword">new</span> TaskCompletionSource&lt;<span class="hljs-built_in">object</span>&gt;();
  <span class="hljs-keyword">var</span> timer = <span class="hljs-keyword">new</span> System.Timers.Timer(milliseconds) { AutoReset = <span class="hljs-literal">false</span> };
  timer.Elapsed += <span class="hljs-built_in">delegate</span> { timer.Dispose(); tcs.SetResult(<span class="hljs-literal">null</span>); };
  timer.Start();
  <span class="hljs-keyword">return</span> tcs.Task;
}
</code></pre>
<p>๐ ุฏุฑ .NET 5 ุจู ุจุนุฏุ ูุณุฎูโ ุบุฑ generic ุงุฒ TaskCompletionSource ูุนุฑู ุดุฏู ุงุณุชุ ุจูุงุจุฑุงู ูโุชูุงูุฏ ุจูโุฌุง <code>TaskCompletionSource&lt;object&gt;</code> ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุฏ.</p>
<hr>
<h3>ุงุฌุฑุง ฑฐ,ฐฐฐ ุนููุงุช ููุฒูุงู ๐</h3>
<p>ุงุฒ ุขูุฌุง ฺฉู ุงู ุฑูุด ูุฎโูุง ุฑุง ุงุดุบุงู ููโฺฉูุฏุ ูโุชูุงูู ูุฒุงุฑุงู ุนููุงุช ุฑุง ููุฒูุงู ุงุฌุฑุง ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++)
  Delay(<span class="hljs-number">5000</span>).GetAwaiter().OnCompleted(() =&gt; Console.WriteLine(<span class="hljs-number">42</span>));
</code></pre>
<p>ุชุงูุฑูุง callbackูุง ุฎูุฏ ุฑุง ุฑู <strong>pooled threads</strong> ุงุฌุฑุง ูโฺฉููุฏ. ุจูุงุจุฑุงู ุจุนุฏ ุงุฒ ต ุซุงููุ thread pool ุฏุฑุฎูุงุณุชโูุง ุฒุงุฏ ุจุฑุง <code>SetResult(null)</code> ุฏุฑุงูุช ูโฺฉูุฏ. ุงฺฏุฑ ุฏุฑุฎูุงุณุชโูุง ุณุฑุนโุชุฑ ุงุฒ ุชูุงู ูพุฑุฏุงุฒุด ุจุฑุณูุฏุ thread pool ุขูโูุง ุฑุง ุฏุฑ ุตู ูุฑุงุฑ ูโุฏูุฏ ู ุฏุฑ ุณุทุญ ุจูููโ ููุงุฒโุณุงุฒ ูพุฑุฏุงุฒุด ูโฺฉูุฏ.</p>
<p>ุงุฒ ุขูุฌุง ฺฉู ฺฉุงุฑ ูุฎโูุง ฺฉูุชุงู ุงุณุช (ููุท ูุฑุงุฎูุงู <code>SetResult</code> ู ุงุฌุฑุง continuation)ุ ุงู ุฑูุด ุจุณุงุฑ ุจููู ุนูู ูโฺฉูุฏ.</p>
<h3>โณ <strong>Task.Delay</strong></h3>
<p>ูุชุฏ ฺฉู ูพุดโุชุฑ ููุดุชู ุจู ุงูุฏุงุฒูโุง ฺฉุงุฑุจุฑุฏ ุงุณุช ฺฉู ุจูโุตูุฑุช ฺฉ ูุชุฏ ุงุณุชุงุชฺฉ ุฏุฑ ฺฉูุงุณ <strong>Task</strong> ุฏุฑ ุฏุณุชุฑุณ ูุฑุงุฑ ฺฏุฑูุชู ุงุณุช:</p>
<pre class="hljs"><code>Task.Delay(<span class="hljs-number">5000</span>).GetAwaiter().OnCompleted(() =&gt; Console.WriteLine(<span class="hljs-number">42</span>));
</code></pre>
<p>ุง:</p>
<pre class="hljs"><code>Task.Delay(<span class="hljs-number">5000</span>).ContinueWith(ant =&gt; Console.WriteLine(<span class="hljs-number">42</span>));
</code></pre>
<p><strong>Task.Delay</strong> ูุนุงุฏู asynchronous ุจุฑุง <strong>Thread.Sleep</strong> ุงุณุช.</p>
<hr>
<h3>๐ <strong>ุงุตูู Asynchrony (ุบุฑููุฒูุงู)</strong></h3>
<p>ุฏุฑ ููฺฏุงู ููุงุด <strong>TaskCompletionSource</strong>ุ ุนููุงู ูุชุฏูุง asynchronous ููุดุชู. ุฏุฑ ุงู ุจุฎุด ุฏููุงู ุชุนุฑู ูโฺฉูู ฺฉู ุนููุงุช asynchronous ฺุณุช ู ุชูุถุญ ูโุฏูู ฺฺฏููู ุงู ููุถูุน ุจู ุจุฑูุงููโููุณ asynchronous ููุฌุฑ ูโุดูุฏ.</p>
<hr>
<h4>๐ <strong>ุนููุงุช Synchronous ุฏุฑ ุจุฑุงุจุฑ Asynchronous</strong></h4>
<ul>
<li>ฺฉ ุนููุงุช <strong>synchronous</strong> ฺฉุงุฑ ุฎูุฏ ุฑุง <strong>ูุจู ุงุฒ ุจุงุฒฺฏุดุช ุจู ูุฑุงุฎูุงููุฏู</strong> ุงูุฌุงู ูโุฏูุฏ.</li>
<li>ฺฉ ุนููุงุช <strong>asynchronous</strong> ูโุชูุงูุฏ (ุจุดุชุฑ ุง ุชูุงู) ฺฉุงุฑ ุฎูุฏ ุฑุง <strong>ุจุนุฏ ุงุฒ ุจุงุฒฺฏุดุช ุจู ูุฑุงุฎูุงููุฏู</strong> ุงูุฌุงู ุฏูุฏ.</li>
</ul>
<p>ุจุดุชุฑ ูุชุฏูุง ฺฉู ูโููุณุฏ ู ุตุฏุง ูโุฒูุฏ synchronous ูุณุชูุฏ. ุจุฑุง ููููู:</p>
<ul>
<li><code>List&lt;T&gt;.Add</code></li>
<li><code>Console.WriteLine</code></li>
<li><code>Thread.Sleep</code></li>
</ul>
<p>ุงูุง ูุชุฏูุง asynchronous ฺฉูุชุฑ ุฑุงุฌ ูุณุชูุฏ ู ุจุงุนุซ <strong>ุงุฌุงุฏ concurrency (ููโุฒูุงู)</strong> ูโุดููุฏุ ุฒุฑุง ฺฉุงุฑ ุจู ููุงุฒุงุช ูุฑุงุฎูุงููุฏู ุงุฏุงูู ูพุฏุง ูโฺฉูุฏ. ุงู ูุชุฏูุง ูุนูููุงู ุณุฑุน (ุง ุจูุงูุงุตูู) ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏูุฏุ ุจูุงุจุฑุงู ุจู ุขูโูุง <strong>nonblocking methods</strong> ูุฒ ฺฏูุชู ูโุดูุฏ.</p>
<p>ุจุดุชุฑ ูุชุฏูุง asynchronous ฺฉู ุชุงฺฉููู ุฏุฏูโุงูุ ูุชุฏูุง <strong>general-purpose</strong> ูุณุชูุฏุ ูุซู:</p>
<ul>
<li><code>Thread.Start</code></li>
<li><code>Task.Run</code></li>
<li>ูุชุฏูุง ฺฉู continuation ุจู taskูุง ูุชุตู ูโฺฉููุฏ</li>
</ul>
<p>ุนูุงูู ุจุฑ ุงูโูุงุ ุจุฑุฎ ูุชุฏูุง ุจุฎุด <strong>Synchronization Contexts</strong> (ูุซู <code>Dispatcher.BeginInvoke</code>ุ โ<code>Control.BeginInvoke</code> ู โ<code>SynchronizationContext.Post</code>) ูุฒ asynchronous ูุณุชูุฏ. ููฺูู ูุชุฏูุง ฺฉู ุฏุฑ ุจุฎุด <strong>TaskCompletionSource</strong> ููุดุชู (ูุซู <strong>Delay</strong>) ูู asynchronous ูโุจุงุดูุฏ.</p>
<hr>
<h3>โ <strong>ุจุฑูุงููโููุณ Asynchronous ฺุณุชุ</strong></h3>
<p>ุงุตู ุจุฑูุงููโููุณ asynchronous ุงู ุงุณุช ฺฉู ุชูุงุจุน <strong>ุทููุงู ุง ุจุงูููู ุทููุงู</strong> ุฑุง ุจูโุตูุฑุช asynchronous ุจููุณุฏ.</p>
<p>ุงู ููุถูุน ุฏุฑ ุชุถุงุฏ ุจุง ุฑูฺฉุฑุฏ ุณูุช ุงุณุช ฺฉู ุชูุงุจุน ุทููุงู ุฑุง ุจูโุตูุฑุช synchronous ููุดุชู ู ุณูพุณ ุขูโูุง ุฑุง ุงุฒ ฺฉ thread ุง task ุฌุฏุฏ ูุฑุงุฎูุงู ูโฺฉูุฏ ุชุง concurrency ูุฑุงูู ุดูุฏ.</p>
<p>ุชูุงูุช ุฏุฑ ุงูุฌุงุณุช ฺฉู ุฏุฑ ุฑูฺฉุฑุฏ asynchronousุ <strong>concurrency ุฏุฑูู ููุงู ุชุงุจุน ุทููุงู</strong> ุขุบุงุฒ ูโุดูุฏุ ูู ุงุฒ ุจุฑูู ุขู.</p>
<p>โ ุงู ุฏู ูุฒุช ุจุฒุฑฺฏ ุฏุงุฑุฏ:</p>
<ol>
<li><strong>I/O-bound concurrency</strong> ุจุฏูู ุงุดุบุงู thread ูุงุจู ูพุงุฏูโุณุงุฒ ุงุณุช (ููุงูโุทูุฑ ฺฉู ุฏุฑ ุจุฎุด TaskCompletionSource ุฏุฏู)ุ ฺฉู ุจุงุนุซ ุจูุจูุฏ <strong>scalability</strong> ู <strong>efficiency</strong> ูโุดูุฏ.</li>
<li>ุฏุฑ ุงูพูฺฉุดูโูุง <strong>rich-client</strong>ุ ฺฉุฏ ฺฉูุชุฑ ุฑู worker thread ุงุฌุฑุง ูโุดูุฏุ ฺฉู <strong>thread-safety</strong> ุฑุง ุณุงุฏูโุชุฑ ูโฺฉูุฏ.</li>
</ol>
<hr>
<h3>๐ฏ <strong>ฺฉุงุฑุจุฑุฏูุง Asynchronous Programming</strong></h3>
<p>ุงู ููุฌุฑ ุจู ุฏู ฺฉุงุฑุจุฑุฏ ูุดุฎุต ุจุฑุง ุจุฑูุงููโููุณ asynchronous ูโุดูุฏ:</p>
<ol>
<li>
<p><strong>ุจุฑูุงููโูุง ุณูุช ุณุฑูุฑ (server-side)</strong> ฺฉู ูุงุฒ ุจู ูุฏุฑุช ฺฉุงุฑุขูุฏ ุญุฌู ุจุงูุง ุงุฒ <strong>I/O ููุฒูุงู</strong> ุฏุงุฑูุฏ.</p>
<ul>
<li>ฺุงูุด ุงูุฌุง <strong>thread-safety</strong> ูุณุช (ฺูู ูุนูููุงู shared state ฺฉู ูุฌูุฏ ุฏุงุฑุฏ).</li>
<li>ุจูฺฉู ฺุงูุด <strong>ุจูุฑูโูุฑ ุงุฒ thread</strong> ุงุณุชุ ูุซูุงู ูุตุฑู ูฺฉุฑุฏู ฺฉ thread ุจุฑุง ูุฑ ุฏุฑุฎูุงุณุช ุดุจฺฉู.</li>
</ul>
</li>
<li>
<p><strong>ุณุงุฏูโุณุงุฒ thread-safety ุฏุฑ ุงูพูฺฉุดูโูุง rich-client.</strong></p>
<ul>
<li>ููุช ุจุฑูุงูู ุจุฒุฑฺฏ ูโุดูุฏุ ูุนูููุงู ูุชุฏูุง ุจุฒุฑฺฏ ุฑุง ุจู ูุชุฏูุง ฺฉูฺฺฉโุชุฑ refactor ูโฺฉูู.</li>
<li>ุงู ููุถูุน ุจุงุนุซ ุงุฌุงุฏ ุฒูุฌุฑูโุง ุงุฒ ูุชุฏูุง (call graph) ูโุดูุฏ ฺฉู ููุฏฺฏุฑ ุฑุง ุตุฏุง ูโุฒููุฏ.</li>
<li>ุฏุฑ ุญุงูุช synchronousุ ุงฺฏุฑ ฺฉ ุงุฒ ูุชุฏูุง ุทููุงู ุจุงุดุฏุ ฺฉู ุฒูุฌุฑู ุจุงุฏ ุฑู worker thread ุงุฌุฑุง ุดูุฏ.</li>
<li>ุฏุฑ ุญุงูุช asynchronousุ ููุท ููุช thread ูุงุฒู ุจุงุดุฏ ุดุฑูุน ูโฺฉูู (ุง ุญุช ุงุตูุงู ุจุฑุง ุนููุงุช I/O ูุงุฒ ุจู thread ูุณุช).</li>
</ul>
</li>
</ol>
<p>ุงู ุจุงุนุซ ุงุฌุงุฏ <strong>concurrency ุฏููโุชุฑ (fine-grained)</strong> ูโุดูุฏุ ุนู ูุฌููุนูโุง ุงุฒ ุนููุงุชโูุง ฺฉูฺฺฉ ููุฒูุงู ฺฉู ุจู ุขูโูุง ุงุฌุฑุง ุจุฑูุงูู ุจู UI thread ุจุงุฒูโฺฏุฑุฏุฏ.</p>
<hr>
<h3>โ๏ธ <strong>ฺฉ ูุงููู ุณุฑุงูฺฏุดุช ููู</strong></h3>
<p>ุจุฑุง ุจูุฑูโููุฏ ุงุฒ ูุฒุงุง asynchronyุ ูู ุนููุงุชโูุง <strong>I/O-bound</strong> ู ูู ุนููุงุชโูุง <strong>compute-bound</strong> ุจุงุฏ asynchronous ููุดุชู ุดููุฏ.</p>
<ul>
<li>ูุฑ ฺุฒ ฺฉู ุจุดุชุฑ ุงุฒ <strong>ตฐ ููโุซุงูู</strong> ุทูู ุจฺฉุดุฏุ ฺฉุงูุฏุฏ ููุงุณุจ ุจุฑุง asynchronous ุงุณุช.</li>
<li>ุงูุจุชู ุงฺฏุฑ ุจุด ุงุฒ ุญุฏ ุนููุงุช ฺฉูฺฺฉ ุฑุง asynchronous ฺฉูุฏุ ฺฉุงุฑุง ฺฉุงูุด ูโุงุจุฏ (ุจู ุฏูู overhead ุนููุงุช asynchronous).</li>
</ul>
<hr>
<h3>๐ฑ <strong>UWP ู ุชุดูู ุจู Asynchronous</strong></h3>
<p>ูุฑูโูุฑฺฉ <strong>UWP</strong> ุขูโูุฏุฑ ุจุฑูุงููโููุณ asynchronous ุฑุง ุชุดูู ูโฺฉูุฏ ฺฉู ูุณุฎูโูุง synchronous ุจุฑุฎ ูุชุฏูุง ุทููุงู ุงุตูุงู ุงุฑุงุฆู ูุดุฏูโุงูุฏ ุง ุญุช exception ูพุฑุชุงุจ ูโฺฉููุฏ.<br>
ุจูุงุจุฑุงู ุดูุง <strong>ุจุงุฏ</strong> ูุชุฏูุง asynchronous ุฑุง ุตุฏุง ุจุฒูุฏ ฺฉู <strong>task</strong> ุจุงุฒูโฺฏุฑุฏุงููุฏ (ุง ุดุฆโูุง ฺฉู ุจุง ูุชุฏ <strong>AsTask</strong> ูุงุจู ุชุจุฏู ุจู task ูุณุชูุฏ).</p>
<hr>
<h3>๐ <strong>Asynchronous Programming ู Continuations</strong></h3>
<p>Taskูุง ุจูโุฎูุจ ุจุง ุจุฑูุงููโููุณ asynchronous ุณุงุฒฺฏุงุฑูุฏุ ุฒุฑุง ุงุฒ <strong>continuation</strong> ูพุดุชุจุงู ูโฺฉููุฏ.</p>
<ul>
<li>ุจุฑุง ุนููุงุช <strong>I/O-bound</strong> ุงุฒ <strong>TaskCompletionSource</strong> ุงุณุชูุงุฏู ูโฺฉูู (ูุซู ูุชุฏ Delay).</li>
<li>ุจุฑุง ุนููุงุช <strong>compute-bound</strong> ุงุฒ <strong>Task.Run</strong> ุงุณุชูุงุฏู ูโฺฉูู.</li>
</ul>
<p>ูฺฺฏ ููู ุงู ุงุณุช ฺฉู ุณุน ูโฺฉูู <strong>ุฏุฑ ุณุทุญ ูพุงู call graph</strong> ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏููุ ุชุง ุฏุฑ ุงูพูฺฉุดูโูุง rich-client ูุชุฏูุง ุณุทุญ ุจุงูุง ุฑู UI thread ุจุงู ุจูุงููุฏ ู ุจุฏูู ูฺฏุฑุงู ุงุฒ thread-safety ุจู ฺฉูุชุฑูโูุง ู shared state ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดูุฏ.</p>
<hr>
<h3>๐ข <strong>ููููู ฺฉุฏ: ุดูุงุฑุด ุงุนุฏุงุฏ ุงูู</strong></h3>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">GetPrimesCount</span> (<span class="hljs-params"><span class="hljs-built_in">int</span> start, <span class="hljs-built_in">int</span> count</span>)</span>
{
  <span class="hljs-keyword">return</span>
    ParallelEnumerable.Range (start, count).Count (n =&gt; 
      Enumerable.Range (<span class="hljs-number">2</span>, (<span class="hljs-built_in">int</span>)Math.Sqrt(n)<span class="hljs-number">-1</span>).All (i =&gt; n % i &gt; <span class="hljs-number">0</span>));
}
</code></pre>
<p>ุงู ุชุงุจุน ุงุนุฏุงุฏ ุงูู ุฑุง ูโุดูุงุฑุฏ ู ุงุฒ ููู ูุณุชูโูุง CPU ุงุณุชูุงุฏู ูโฺฉูุฏ. ุงุฌุฑุง ุขู ุทููุงู ุงุณุช.</p>
<p>ฺฉ ูุชุฏ ุจุฑุง ูุฑุงุฎูุงู ุขู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisplayPrimeCounts</span>()</span>
{
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
    Console.WriteLine (GetPrimesCount (i*<span class="hljs-number">1000000</span> + <span class="hljs-number">2</span>, <span class="hljs-number">1000000</span>) +
      <span class="hljs-string">&quot; primes between &quot;</span> + (i*<span class="hljs-number">1000000</span>) + <span class="hljs-string">&quot; and &quot;</span> + ((i+<span class="hljs-number">1</span>)*<span class="hljs-number">1000000</span><span class="hljs-number">-1</span>));
  Console.WriteLine (<span class="hljs-string">&quot;Done!&quot;</span>);
}
</code></pre>
<p>ุฎุฑูุฌ:</p>
<pre class="hljs"><code>78498 primes between 0 and 999999
70435 primes between 1000000 and 1999999
67883 primes between 2000000 and 2999999
...
62090 primes between 9000000 and 9999999
</code></pre>
<p>ุฏุฑ ุงูุฌุง ฺฉ <strong>call graph</strong> ุฏุงุฑู:</p>
<ul>
<li>โ<code>DisplayPrimeCounts</code> ูุฑุงุฎูุงู ูโฺฉูุฏ โ<code>GetPrimesCount</code> ุฑุง.</li>
<li>ุฏุฑ ุนููุ ุฏุฑ ุงูพูฺฉุดูโูุง rich-clientุ ุงู ูุชุฏ ุงุญุชูุงูุงู UI ุฑุง ุจูโุฑูุฒุฑุณุงู ูโฺฉุฑุฏ.</li>
</ul>
<hr>
<h3>โก <strong>ุงุฌุฑุง coarse-grained concurrency</strong></h3>
<pre class="hljs"><code>Task.Run(() =&gt; DisplayPrimeCounts());
</code></pre>
<hr>
<h3>โ <strong>ุงุฌุฑุง fine-grained concurrency (ูุณุฎู asynchronous)</strong></h3>
<pre class="hljs"><code><span class="hljs-function">Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetPrimesCountAsync</span> (<span class="hljs-params"><span class="hljs-built_in">int</span> start, <span class="hljs-built_in">int</span> count</span>)</span>
{
  <span class="hljs-keyword">return</span> Task.Run(() =&gt;
    ParallelEnumerable.Range (start, count).Count (n =&gt; 
      Enumerable.Range (<span class="hljs-number">2</span>, (<span class="hljs-built_in">int</span>)Math.Sqrt(n)<span class="hljs-number">-1</span>).All (i =&gt; n % i &gt; <span class="hljs-number">0</span>)));
}
</code></pre>
<h3>๐ <strong>ฺุฑุง ูพุดุชุจุงู ุฒุจุงู ููู ุงุณุช</strong></h3>
<p>ุงฺฉููู ุจุงุฏ <strong>DisplayPrimeCounts</strong> ุฑุง ุชุบุฑ ุฏูู ุชุง <strong>GetPrimesCountAsync</strong> ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ.<br>
ุงูุฌุงุณุช ฺฉู ฺฉูุฏูุงฺูโูุง <strong>async</strong> ู <strong>await</strong> ุฏุฑ C# ูุงุฑุฏ ูโุดููุฏุ ุฒุฑุง ุจุฏูู ุขูโูุง ฺฉุงุฑ ุณุงุฏู ูุณุช.</p>
<p>ุงฺฏุฑ ููุท ุญููู ุฑุง ุจู ุงู ุดฺฉู ุชุบุฑ ุฏูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
{
  <span class="hljs-keyword">var</span> awaiter = GetPrimesCountAsync(i*<span class="hljs-number">1000000</span> + <span class="hljs-number">2</span>, <span class="hljs-number">1000000</span>).GetAwaiter();
  awaiter.OnCompleted(() =&gt;
    Console.WriteLine(awaiter.GetResult() + <span class="hljs-string">&quot; primes between... &quot;</span>));
}
Console.WriteLine(<span class="hljs-string">&quot;Done&quot;</span>);
</code></pre>
<ul>
<li>ุญููู ุณุฑุนุงู ฑฐ ุจุงุฑ ุชฺฉุฑุงุฑ ูโุดูุฏ (ุฒุฑุง ูุชุฏูุง nonblocking ูุณุชูุฏ).</li>
<li>ููู ฑฐ ุนููุงุช <strong>ููุฒูุงู</strong> ุงุฌุฑุง ูโุดููุฏ ู ูพุงู <strong>Done</strong> ูุจู ุงุฒ ุชูุงู ุดุฏู ฺฉุงุฑูุง ฺุงูพ ูโุดูุฏ.</li>
</ul>
<hr>
<h3>โ๏ธ ูุดฺฉู ุงุฌุฑุง ููุฒูุงู</h3>
<ul>
<li>ุฏุฑ ุงู ูุซุงูุ ุงุฌุฑุง ููุงุฒ ุนููุงุช ูุทููุจ ูุณุชุ ุฒุฑุง ุฎูุฏ ูุชุฏูุง ุฏุงุฎู parallel ุดุฏูโุงูุฏ ู ููุท ุจุงุนุซ ุทููุงูโุชุฑ ุดุฏู ุฒูุงู ูุดุงูุฏู ุงููู ูุชุฌู ูโุดูุฏ.</li>
<li>ููฺููุ ููฺฉู ุงุณุช <strong>Task B ุจู ูุชุฌู Task A ูุงุจุณุชู ุจุงุดุฏ</strong> (ูุซูุงู ุฏุฑ ฺฏุฑูุชู ุตูุญู ูุจุ ุงุจุชุฏุง DNS lookup ู ุณูพุณ HTTP request ุงูุฌุงู ูโุดูุฏ).</li>
</ul>
<p>ุจุฑุง ุงุฌุฑุง <strong>ุชูุงูโุง</strong>ุ ุจุงุฏ iteration ุจุนุฏ ุญููู ุงุฒ continuation ุฎูุฏ ูุชุฏ ุงุฌุฑุง ุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisplayPrimeCounts</span>()</span>
{
  DisplayPrimeCountsFrom(<span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisplayPrimeCountsFrom</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> i</span>)</span>
{
  <span class="hljs-keyword">var</span> awaiter = GetPrimesCountAsync(i*<span class="hljs-number">1000000</span> + <span class="hljs-number">2</span>, <span class="hljs-number">1000000</span>).GetAwaiter();
  awaiter.OnCompleted(() =&gt; 
  {
    Console.WriteLine(awaiter.GetResult() + <span class="hljs-string">&quot; primes between...&quot;</span>);
    <span class="hljs-keyword">if</span> (++i &lt; <span class="hljs-number">10</span>) DisplayPrimeCountsFrom(i);
    <span class="hljs-keyword">else</span> Console.WriteLine(<span class="hljs-string">&quot;Done&quot;</span>);
  });
}
</code></pre>
<ul>
<li>ุงฺฏุฑ ุจุฎูุงูู <strong>DisplayPrimeCounts</strong> ุฎูุฏุด asynchronous ุจุงุดุฏ ู ฺฉ Task ุจุงุฒฺฏุฑุฏุงูุฏุ ุจุงุฏ ุงุฒ <strong>TaskCompletionSource</strong> ุงุณุชูุงุฏู ฺฉูู.</li>
</ul>
<hr>
<h3>โ <strong>ุฑุงู ุญู ุณุงุฏู ุจุง async/await</strong></h3>
<p>C# ุงู ฺฉุงุฑ ุฑุง ุจุฑุง ูุง ุณุงุฏู ฺฉุฑุฏู ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">DisplayPrimeCountsAsync</span>()</span>
{
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
    Console.WriteLine(<span class="hljs-keyword">await</span> GetPrimesCountAsync(i*<span class="hljs-number">1000000</span> + <span class="hljs-number">2</span>, <span class="hljs-number">1000000</span>) +
      <span class="hljs-string">&quot; primes between &quot;</span> + (i*<span class="hljs-number">1000000</span>) + <span class="hljs-string">&quot; and &quot;</span> + ((i+<span class="hljs-number">1</span>)*<span class="hljs-number">1000000</span><span class="hljs-number">-1</span>));
  Console.WriteLine(<span class="hljs-string">&quot;Done!&quot;</span>);
}
</code></pre>
<ul>
<li>ฺฉูุฏูุงฺูโูุง <strong>async</strong> ู <strong>await</strong> ุงูฺฉุงู ูพุงุฏูโุณุงุฒ asynchronous ุฑุง ุจุฏูู ูพฺุฏฺฏ ุฒุงุฏ ูุฑุงูู ูโฺฉููุฏ.</li>
</ul>
<hr>
<h3>๐ <strong>ฺุฑุง ุญูููโูุง imperative ูุดฺฉู ุฏุงุฑูุฏุ</strong></h3>
<p>ุญูููโูุง <code>for</code> ู <code>foreach</code> ุจุง continuations ุฎูุจ ุชุฑฺฉุจ ููโุดููุฏุ ุฒุฑุง ุฑู <strong>state ูุญู ูุนู ูุชุฏ</strong> ุชฺฉู ุฏุงุฑูุฏ (ูุซูุงู โฺูุฏ ุจุงุฑ ุฏฺฏุฑ ุญููู ุงุฌุฑุง ูโุดูุฏุโ).</p>
<ul>
<li>ุงุณุชูุงุฏู ุงุฒ <strong>async/await</strong> ฺฉ ุฑุงู ุญู ุงุณุช.</li>
<li>ุฑุงู ุฏฺฏุฑุ ุฌุงฺฏุฒู ฺฉุฑุฏู ุญูููโูุง imperative ุจุง ูุนุงุฏู functional ุขูโูุง (ูุซู <strong>LINQ</strong>) ุงุณุชุ ฺฉู ุงุณุงุณ <strong>Reactive Extensions (Rx)</strong> ูโุจุงุดุฏ.</li>
<li>Rx ุจุฑุง ุฌููฺฏุฑ ุงุฒ blocking ุฑู <strong>push-based sequences</strong> ฺฉุงุฑ ูโฺฉูุฏ ฺฉู ููููู ูพฺุฏู ุฏุงุฑุฏ.</li>
</ul>
<hr>
<h3>๐๏ธ <strong>ุชูุงุจุน Asynchronous ุฏุฑ C#</strong></h3>
<p>ฺฉูุฏูุงฺูโูุง <strong>async</strong> ู <strong>await</strong> ุงุฌุงุฒู ูโุฏููุฏ ฺฉุฏ asynchronous ุจุง <strong>ุณุงุฎุชุงุฑ ูุดุงุจู synchronous</strong> ุจููุณูุ ุจุฏูู ูุงุฒ ุจู ููุดุชู ุชูุงู plumbing ุฏุงุฎู asynchronous.</p>
<h4>Awaiting</h4>
<pre class="hljs"><code><span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> expression;
statement(s);
</code></pre>
<ul>
<li>ุชูุณุท ฺฉุงููพุงูุฑ ุจู ฺุฒ ูุดุงุจู ุงู ฺฏุณุชุฑุด ูโุงุจุฏ:</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">var</span> awaiter = expression.GetAwaiter();
awaiter.OnCompleted(() =&gt;
{
  <span class="hljs-keyword">var</span> result = awaiter.GetResult();
  statement(s);
});
</code></pre>
<ul>
<li>ฺฉุงููพุงูุฑ ููฺูู ุจุฑุง <strong>ุณุฑูุณโุฏู ุณุฑุน ุฏุฑ ุตูุฑุช ุชฺฉูู ููุฒูุงู</strong> ู ูุฏุฑุช ุฌุฒุฆุงุช ุฏฺฏุฑุ ฺฉุฏ ุงุถุงูู ูโฺฉูุฏ.</li>
</ul>
<hr>
<h3>๐ข <strong>ููููู ฺฉุฏ ุดูุงุฑุด ุงุนุฏุงุฏ ุงูู ุจุง await</strong></h3>
<pre class="hljs"><code><span class="hljs-function">Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetPrimesCountAsync</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> start, <span class="hljs-built_in">int</span> count</span>)</span>
{
  <span class="hljs-keyword">return</span> Task.Run(() =&gt;
    ParallelEnumerable.Range(start, count).Count(n =&gt;
      Enumerable.Range(<span class="hljs-number">2</span>, (<span class="hljs-built_in">int</span>)Math.Sqrt(n)<span class="hljs-number">-1</span>).All(i =&gt; n % i &gt; <span class="hljs-number">0</span>)));
}

<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DisplayPrimesCount</span>()</span>
{
  <span class="hljs-built_in">int</span> result = <span class="hljs-keyword">await</span> GetPrimesCountAsync(<span class="hljs-number">2</span>, <span class="hljs-number">1000000</span>);
  Console.WriteLine(result);
}
</code></pre>
<ul>
<li>ฺฉูุฏูุงฺู <strong>async</strong> ุจู ฺฉุงููพุงูุฑ ูโฺฏูุฏ ฺฉู <code>await</code> ุฏุฑ ุงู ูุชุฏุ ฺฉ keyword ุงุณุช ูู ฺฉ identifier.</li>
<li>async ููุท ุฑู <strong>ุขูฺู ุฏุงุฎู ูุชุฏ ุฑุฎ ูโุฏูุฏ</strong> ุชุฃุซุฑ ุฏุงุฑุฏ ู ูุดุงุจู <code>unsafe</code>ุ ุชุงุซุฑ ุฑู signature ูุชุฏ ูุฏุงุฑุฏ.</li>
<li>ูโุชูุงูุฏ ุฑู ูุชุฏูุง <code>void</code> ุง <code>Task</code> ู <code>Task&lt;TResult&gt;</code> ุงุนูุงู ุดูุฏ.</li>
</ul>
<hr>
<h3>๐ <strong>ฺฺฏููฺฏ ฺฉุงุฑ await</strong></h3>
<ul>
<li>ุจุง ุฑุณุฏู ุจู ฺฉ <strong>await expression</strong>ุ ุงุฌุฑุง ูุนูููุงู ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏุ ูุดุงุจู <code>yield return</code> ุฏุฑ iteratorูุง.</li>
<li>ูุจู ุงุฒ ุจุงุฒฺฏุดุชุ runtime ฺฉ <strong>continuation</strong> ุจู task ุถููู ูโฺฉูุฏ.</li>
<li>ููุช task ุชฺฉูู ุดุฏุ ุงุฌุฑุง ุงุฒ ููุงู ููุทู ุงุฏุงูู ูโุงุจุฏ.</li>
<li>ุฏุฑ ุตูุฑุช ุฎุทุงุ exception ุจุงุฒุชุงุจ ุฏุงุฏู ูโุดูุฏ ู ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ููุฏุงุฑ ุจุงุฒฺฏุดุช ุจู <strong>await expression</strong> ุงุฎุชุตุงุต ูโุงุจุฏ.</li>
</ul>
<h4>ูุนุงุฏู ููุทู</h4>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisplayPrimesCount</span>()</span>
{
  <span class="hljs-keyword">var</span> awaiter = GetPrimesCountAsync(<span class="hljs-number">2</span>, <span class="hljs-number">1000000</span>).GetAwaiter();
  awaiter.OnCompleted(() =&gt;
  {
    <span class="hljs-built_in">int</span> result = awaiter.GetResult();
    Console.WriteLine(result);
  });
}
</code></pre>
<ul>
<li>Await ูโุชูุงูุฏ ุฑู taskูุง generic (<code>Task&lt;TResult&gt;</code>) ุง nongeneric (<code>Task</code>) ุงุณุชูุงุฏู ุดูุฏ.</li>
<li>ููููู nongeneric:</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">5000</span>);
Console.WriteLine(<span class="hljs-string">&quot;Five seconds passed!&quot;</span>);
</code></pre>
<h3>๐น <strong>ุญูุธ state ูุญู ุจุง await</strong></h3>
<p>ฺฉ ุงุฒ ูุฏุฑุชโูุง ูุงูุน <strong>await</strong> ุงู ุงุณุช ฺฉู ูโุชูุงูุฏ ุชูุฑุจุงู ุฏุฑ ูุฑ ุฌุง ุงุฒ ฺฉุฏ ุธุงูุฑ ุดูุฏ (ุฏุงุฎู ฺฉ ุชุงุจุน asynchronous)ุ ุจู ุฌุฒ ุฏุฑูู <code>lock</code> ุง <code>unsafe context</code>.</p>
<p>ูุซุงู ุณุงุฏู ุฏุงุฎู ฺฉ ุญููู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DisplayPrimeCounts</span>()</span>
{
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
    Console.WriteLine(<span class="hljs-keyword">await</span> GetPrimesCountAsync(i*<span class="hljs-number">1000000</span> + <span class="hljs-number">2</span>, <span class="hljs-number">1000000</span>));
}
</code></pre>
<ul>
<li>
<p>ุจุง ุงููู ุงุฌุฑุง <code>GetPrimesCountAsync</code>ุ ฺฉูุชุฑู ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏ.</p>
</li>
<li>
<p>ูพุณ ุงุฒ ุชฺฉูู (ุง ุฎุทุง) ูุชุฏุ ุงุฌุฑุง ฺฉุฏ ุงุฒ ููุงู ููุทู ุงุฏุงูู ูโุงุจุฏ.</p>
</li>
<li>
<p><strong>ููุงุฏุฑ ูุชุบุฑูุง ูุญู ู ุดูุงุฑูุฏูโูุง ุญููู ุญูุธ ูโุดููุฏ</strong>.</p>
</li>
<li>
<p>ฺฉุงููพุงูุฑ ุงู ูุชุฏูุง ุฑุง ุจู ฺฉ <strong>state machine</strong> ุชุจุฏู ูโฺฉูุฏ (ูุดุงุจู iteratorูุง).</p>
</li>
<li>
<p>continuationูุง ุชุถูู ูโฺฉููุฏ ฺฉู ุจุนุฏ ุงุฒ <code>await</code>ุ ุงุฌุฑุง ุฏูุจุงุฑู ุงุฒ ููุงู ููุทู ุงุฏุงูู ุงุจุฏ.</p>
</li>
</ul>
<hr>
<h3>๐น <strong>Await ุฏุฑ ุฑุงุจุท ฺฉุงุฑุจุฑ (UI)</strong></h3>
<p>ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ฺฉ UI ุณุงุฏู ุฏุงุดุชู ุจุงุดู ฺฉู ููุฒูุงู <strong>ูุญุงุณุจุงุช ุณูฺฏู</strong> ุงูุฌุงู ูโุฏูุฏ ุงูุง ูพุงุณุฎฺฏู ุจูุงูุฏ.</p>
<h4>ูุณุฎู synchronous (ุบุฑูุงฺฉูุดโฺฏุฑุง)</h4>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
{
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">5</span>; i++)
    _results.Text += GetPrimesCount(i*<span class="hljs-number">1000000</span>, <span class="hljs-number">1000000</span>) + <span class="hljs-string">&quot; primes between ...&quot;</span> + Environment.NewLine;
}
</code></pre>
<ul>
<li>ุฏุฑ ุงู ุญุงูุชุ ุจุฑูุงูู <strong>ุจุฑุง ูุฏุช ููู ูโุดูุฏ</strong> ู UI ูพุงุณุฎฺฏู ูุณุช.</li>
</ul>
<h4>ูุณุฎู asynchronous ุจุง Task.Run ู await</h4>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
{
  _button.IsEnabled = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">5</span>; i++)
    _results.Text += <span class="hljs-keyword">await</span> GetPrimesCountAsync(i*<span class="hljs-number">1000000</span>, <span class="hljs-number">1000000</span>) +
                     <span class="hljs-string">&quot; primes between ...&quot;</span> + Environment.NewLine;
  _button.IsEnabled = <span class="hljs-literal">true</span>;
}
</code></pre>
<ul>
<li>ฺฉุฏ ุฏุงุฎู <code>Go</code> ุจุฑ ุฑู <strong>UI thread</strong> ุงุฌุฑุง ูโุดูุฏ ู ุชููุง <strong>GetPrimesCountAsync</strong> ุฑู worker thread.</li>
<li>ุงุฌุฑุง <code>Go</code> ุจู ุตูุฑุช <strong>pseudo-concurrent</strong> ุจุง message loop ุฑุฎ ูโุฏูุฏ.</li>
<li><strong>ููุงุท preemption ุชููุง ููฺฏุงู await</strong> ุฑุฎ ูโุฏููุฏุ ุจูุงุจุฑุงู thread safety ุณุงุฏูโุชุฑ ุงุณุช.</li>
<li>ุจุง Task.Runุ <strong>concurrency ูุงูุน</strong> ูพุงูโุชุฑ ุฏุฑ call stack ุฑุฎ ูโุฏูุฏ.</li>
</ul>
<hr>
<h3>๐น ูุซุงู I/O-bound: ุฏุงูููุฏ ุตูุญุงุช ูุจ</h3>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
{
  _button.IsEnabled = <span class="hljs-literal">false</span>;
  <span class="hljs-built_in">string</span>[] urls = <span class="hljs-string">&quot;www.albahari.com www.oreilly.com www.linqpad.net&quot;</span>.Split();
  <span class="hljs-built_in">int</span> totalLength = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">try</span>
  {
    <span class="hljs-keyword">foreach</span> (<span class="hljs-built_in">string</span> url <span class="hljs-keyword">in</span> urls)
    {
      <span class="hljs-keyword">var</span> uri = <span class="hljs-keyword">new</span> Uri(<span class="hljs-string">&quot;http://&quot;</span> + url);
      <span class="hljs-built_in">byte</span>[] data = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> WebClient().DownloadDataTaskAsync(uri);
      _results.Text += <span class="hljs-string">&quot;Length of &quot;</span> + url + <span class="hljs-string">&quot; is &quot;</span> + data.Length + Environment.NewLine;
      totalLength += data.Length;
    }
    _results.Text += <span class="hljs-string">&quot;Total length: &quot;</span> + totalLength;
  }
  <span class="hljs-keyword">catch</span> (WebException ex)
  {
    _results.Text += <span class="hljs-string">&quot;Error: &quot;</span> + ex.Message;
  }
  <span class="hljs-keyword">finally</span>
  {
    _button.IsEnabled = <span class="hljs-literal">true</span>;
  }
}
</code></pre>
<ul>
<li>ฺฉุฏ <strong>ุดุจู ูุณุฎู synchronous</strong> ููุดุชู ุดุฏู ุงุณุช.</li>
<li>ูพุณ ุงุฒ ุงููู awaitุ ฺฉูุชุฑู ุจู caller ุจุงุฒูโฺฏุฑุฏุฏุ ุงูุง continuation ุชุถูู ูโฺฉูุฏ ฺฉู ุชูุงู ุจูุงฺฉ <code>finally</code> ุจุนุฏ ุงุฒ ุชฺฉูู method ุงุฌุฑุง ุดูุฏ.</li>
</ul>
<hr>
<h3>๐น <strong>ูุญูู ุนููฺฉุฑุฏ ุฒุฑ ฺฉุงูพูุช</strong></h3>
<ul>
<li>UI thread ฺฉ <strong>message loop</strong> ุฏุงุฑุฏ ฺฉู event handlerูุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ.</li>
<li>ุงุฌุฑุง <code>Go</code> ุชุง ุฑุณุฏู ุจู await ุงุฏุงูู ูพุฏุง ูโฺฉูุฏุ ุณูพุณ ฺฉูุชุฑู ุจู message loop ุจุงุฒูโฺฏุฑุฏุฏ.</li>
<li>ฺฉุงููพุงูุฑ ฺฉ continuation ุถููู ูโฺฉูุฏ ุชุง ูพุณ ุงุฒ ุชฺฉูู taskุ ุงุฌุฑุง ูุชุฏ ุงุฒ ููุงู ููุทู ุงุฏุงูู ุงุจุฏ.</li>
<li>ฺูู await ุฑู <strong>UI thread</strong> ุงูุฌุงู ุดุฏู ุงุณุชุ continuation ุจู <strong>synchronization context</strong> ุงุฑุณุงู ูโุดูุฏ ู ุฏูุจุงุฑู ุชูุณุท message loop ุงุฌุฑุง ูโุดูุฏ.</li>
<li>ุงู ูุฏู <strong>pseudo-concurrency</strong> ุฑุง ุฑู UI ูุฑุงูู ูโฺฉูุฏ ู <strong>concurrency ูุงูุน</strong> ุฏุฑ Task.Run ุง I/O-bound method ุฑุฎ ูโุฏูุฏ.</li>
</ul>
<h3>๐น <strong>Coarse-Grained Concurrency vs Async/Await</strong></h3>
<p>ูุจู ุงุฒ C# 5ุ ุจุฑูุงููโููุณ <strong>asynchronous</strong> ุฏุดูุงุฑ ุจูุฏ:</p>
<ul>
<li>ุฒุจุงู ูฺ ูพุดุชุจุงู ูุณุชูู ูุฏุงุดุช.</li>
<li>ูุฑููุฑฺฉ .NET ูุชุฏูุง asynchronous ุฑุง ุจุง ุงูฺฏููุง ูพฺุฏูโุง ูุงููุฏ <strong>EAP</strong> ู <strong>APM</strong> ุงุฑุงุฆู ูโฺฉุฑุฏ.</li>
<li>ุฑุงูโุญู ุฑุงุฌ: <strong>coarse-grained concurrency</strong> ุจุง BackgroundWorker ุง Task.Run.</li>
</ul>
<h4>ูุซุงู coarse-grained</h4>
<pre class="hljs"><code>_button.Click += (sender, <span class="hljs-keyword">args</span>) =&gt;
{
    _button.IsEnabled = <span class="hljs-literal">false</span>;
    Task.Run(() =&gt; Go());
};

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Go</span>()</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">5</span>; i++)
    {
        <span class="hljs-built_in">int</span> result = GetPrimesCount(i * <span class="hljs-number">1000000</span>, <span class="hljs-number">1000000</span>);
        Dispatcher.BeginInvoke(<span class="hljs-keyword">new</span> Action(() =&gt;
            _results.Text += result + <span class="hljs-string">&quot; primes between ...&quot;</span> + Environment.NewLine));
    }
    Dispatcher.BeginInvoke(<span class="hljs-keyword">new</span> Action(() =&gt; _button.IsEnabled = <span class="hljs-literal">true</span>));
}
</code></pre>
<p>โ๏ธ ูุดฺฉูุงุช ุงู ุฑูุด:</p>
<ul>
<li>ฺฉู call graph (Go + GetPrimesCount) ุฑู worker thread ุงุฌุฑุง ูโุดูุฏ.</li>
<li>ุจุฑุง ุฏุณุชุฑุณ ุจู UI ุจุงุฏ ุงุฒ <code>Dispatcher.BeginInvoke</code> ุงุณุชูุงุฏู ฺฉุฑุฏ.</li>
<li><strong>race conditions</strong> ู ุฎุทุงูุง thread-safety ุจู ุฑุงุญุช ุฑุฎ ูโุฏููุฏุ ุฎุตูุตุงู ุงฺฏุฑ ุฏุงุฏูโูุง ุง ุชูุธูุงุช ุงุฒ ููุงุจุน ุบุฑ thread-safe ุฎูุงูุฏู ุดููุฏ.</li>
</ul>
<hr>
<h3>๐น <strong>ููุดุชู ุชูุงุจุน Asynchronous ุจุง async/await</strong></h3>
<p>ูโุชูุงู <code>void</code> ุฑุง ุจุง <code>Task</code> ุฌุงฺฏุฒู ฺฉุฑุฏ ุชุง ูุชุฏ ุฎูุฏ ุจู ุตูุฑุช <strong>awaitable</strong> ุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">PrintAnswerToLife</span>()</span>
{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">5000</span>);
    <span class="hljs-built_in">int</span> answer = <span class="hljs-number">21</span> * <span class="hljs-number">2</span>;
    Console.WriteLine(answer);
}
</code></pre>
<ul>
<li>ูุงุฒ ุจู return ุตุฑุญ Task ูุณุชุ ฺฉุงููพุงูุฑ <strong>Task</strong> ุฑุง ุชููุฏ ูโฺฉูุฏ.</li>
<li>ุงู ุงูฺฉุงู ุงุฌุงุฏ <strong>chained async calls</strong> ุฑุง ูุฑุงูู ูโฺฉูุฏ:</li>
</ul>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Go</span>()</span>
{
    <span class="hljs-keyword">await</span> PrintAnswerToLife();
    Console.WriteLine(<span class="hljs-string">&quot;Done&quot;</span>);
}
</code></pre>
<hr>
<h3>๐น <strong>ุชูุณุนู ูุชุฏ ุจุง TaskCompletionSource</strong></h3>
<p>ูุนุงุฏู ุฏุงุฎู async/await:</p>
<pre class="hljs"><code><span class="hljs-function">Task <span class="hljs-title">PrintAnswerToLife</span>()</span>
{
    <span class="hljs-keyword">var</span> tcs = <span class="hljs-keyword">new</span> TaskCompletionSource&lt;<span class="hljs-built_in">object</span>&gt;();
    <span class="hljs-keyword">var</span> awaiter = Task.Delay(<span class="hljs-number">5000</span>).GetAwaiter();
    awaiter.OnCompleted(() =&gt;
    {
        <span class="hljs-keyword">try</span>
        {
            awaiter.GetResult(); <span class="hljs-comment">// ูพุฑุชุงุจ ุงุณุชุซูุง ุฏุฑ ุตูุฑุช ูููุน</span>
            <span class="hljs-built_in">int</span> answer = <span class="hljs-number">21</span> * <span class="hljs-number">2</span>;
            Console.WriteLine(answer);
            tcs.SetResult(<span class="hljs-literal">null</span>);
        }
        <span class="hljs-keyword">catch</span> (Exception ex) { tcs.SetException(ex); }
    });
    <span class="hljs-keyword">return</span> tcs.Task;
}
</code></pre>
<ul>
<li>ููุช ูุชุฏ asynchronous ุชูุงู ูโุดูุฏุ ุงุฌุฑุง ฺฉุฏ ุจู <strong>continuation</strong> ููุชูู ูโุดูุฏ.</li>
<li>ุฏุฑ rich-client scenarioุ ุงุฏุงูู ุงุฌุฑุง ุจู <strong>UI thread</strong> ุจุงุฒ ูโฺฏุฑุฏุฏ.</li>
</ul>
<hr>
<h3>๐น <strong>Returning Task<TResult></strong></h3>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetAnswerToLife</span>()</span>
{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">5000</span>);
    <span class="hljs-built_in">int</span> answer = <span class="hljs-number">21</span> * <span class="hljs-number">2</span>;
    <span class="hljs-keyword">return</span> answer; <span class="hljs-comment">// ูุชุฏ Task&lt;int&gt; ุจุฑูโฺฏุฑุฏุงูุฏ</span>
}

<span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">PrintAnswerToLife</span>()</span>
{
    <span class="hljs-built_in">int</span> answer = <span class="hljs-keyword">await</span> GetAnswerToLife();
    Console.WriteLine(answer);
}

<span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Go</span>()</span>
{
    <span class="hljs-keyword">await</span> PrintAnswerToLife();
    Console.WriteLine(<span class="hljs-string">&quot;Done&quot;</span>);
}
</code></pre>
<ul>
<li>ุงู ุงูฺฏู ูุดุงุจู ุจุฑูุงููโููุณ synchronous ุงุณุชุ ุงูุง ุจุฏูู ุจูุงฺฉ ฺฉุฑุฏู thread.</li>
</ul>
<hr>
<h3>๐น <strong>ุฑุงูููุง ุทุฑุงุญ ูุชุฏูุง Asynchronous ุฏุฑ C#</strong></h3>
<ol>
<li>ุงุจุชุฏุง ูุชุฏูุง ุฑุง ุจู ุตูุฑุช synchronous ุจููุณุฏ.</li>
<li>ูุชุฏูุง synchronous ุฑุง ุจุง <strong>ูุชุฏูุง asynchronous</strong> ุฌุงฺฏุฒู ู <code>await</code> ฺฉูุฏ.</li>
<li>ุจู ุฌุฒ ูุชุฏูุง <strong>top-level</strong> (ูุซูุงู event handlerูุง)ุ ููุน ุจุงุฒฺฏุดุช ูุชุฏูุง asynchronous ุฑุง ุจู <code>Task</code> ุง <code>Task&lt;TResult&gt;</code> ุชุบุฑ ุฏูุฏ ุชุง <strong>awaitable</strong> ุดููุฏ.</li>
</ol>
<p>๐ก ูฺฉุชู: ูุงุฒ ุจู ุงุณุชูุงุฏู ุตุฑุญ ุงุฒ <code>TaskCompletionSource</code> ูุณุช ูฺฏุฑ ุฏุฑ <strong>bottom-level methods</strong> ฺฉู I/O-bound concurrency ุฑุง ูุฏุฑุช ูโฺฉููุฏ.</p>
<h3>ุงุฌุฑุง ูููุฏุงุฑ ูุฑุงุฎูุงูโูุง ุบุฑููุฒูุงู โฑ๏ธ</h3>
<p>ุจุฑุง ุงูฺฉู ุฏููุงู ุจุจูู ุงู ฺฉุฏ ฺฺฏููู ุงุฌุฑุง ูโุดูุฏุ ููุฏ ุงุณุช ฺฉู ฺฉุฏ ุฎูุฏ ุฑุง ุจู ุดฺฉู ุฒุฑ ุจุงุฒฺู ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Go</span>()</span>
{
    <span class="hljs-keyword">var</span> task = PrintAnswerToLife();
    <span class="hljs-keyword">await</span> task;
    Console.WriteLine(<span class="hljs-string">&quot;Done&quot;</span>);
}

<span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">PrintAnswerToLife</span>()</span>
{
    <span class="hljs-keyword">var</span> task = GetAnswerToLife();
    <span class="hljs-built_in">int</span> answer = <span class="hljs-keyword">await</span> task;
    Console.WriteLine(answer);
}

<span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetAnswerToLife</span>()</span>
{
    <span class="hljs-keyword">var</span> task = Task.Delay(<span class="hljs-number">5000</span>);
    <span class="hljs-keyword">await</span> task;
    <span class="hljs-built_in">int</span> answer = <span class="hljs-number">21</span> * <span class="hljs-number">2</span>;
    <span class="hljs-keyword">return</span> answer;
}
</code></pre>
<p>ุฏุฑ ุงูุฌุงุ <code>Go</code> ูุชุฏ <code>PrintAnswerToLife</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ฺฉู ุขู ุฎูุฏ <code>GetAnswerToLife</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ฺฉู ุฏุฑ ููุงุช <code>Delay</code> ุฑุง ุตุฏุง ูโุฒูุฏ ู ููุชุธุฑ ูโูุงูุฏ. ุนุจุงุฑุช <code>await</code> ุจุงุนุซ ูโุดูุฏ ุงุฌุฑุง ฺฉุฏ ุจู <code>PrintAnswerToLife</code> ุจุงุฒฺฏุฑุฏุฏุ ฺฉู ุขู ูุฒ ููุชุธุฑ ุงุณุช ู ุจู <code>Go</code> ุจุงุฒูโฺฏุฑุฏุฏ ู ุฏุฑ ููุงุช ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏ. ููู ุงูโูุง ุจู ุตูุฑุช ููุฒูุงู (synchronously) ุฑู ููุงู ูุฎ (thread) ฺฉู <code>Go</code> ุฑุง ูุฑุงุฎูุงู ฺฉุฑุฏู ุงุณุช ุงุฌุฑุง ูโุดูุฏุ ุงู ูุงุฒ ฺฉูุชุงู ููุฒูุงู ุงุฌุฑุง ุจุฑูุงูู ุงุณุช.</p>
<p>ูพุณ ุงุฒ ูพูุฌ ุซุงููุ ุงุฏุงููโ ุงุฌุฑุง <code>Delay</code> ูุฑุงุฎูุงู ูโุดูุฏ ู ุงุฌุฑุง ฺฉุฏ ุจู <code>GetAnswerToLife</code> ุจุฑูโฺฏุฑุฏุฏุ ุฑู ฺฉ ูุฎ ููุฌูุฏ ุฏุฑ pool. (ุงฺฏุฑ ุงุฒ ฺฉ ูุฎ UI ุดุฑูุน ฺฉุฑุฏู ุจุงุดูุ ุงุฌุฑุง ฺฉุฏ ุจู ููุงู ูุฎ ุจุงุฒูโฺฏุฑุฏุฏ.) ุณูพุณ ุจูู ุฏุณุชูุฑุงุช ุฏุฑ <code>GetAnswerToLife</code> ุงุฌุฑุง ูโุดููุฏุ ู ูพุณ ุงุฒ ุขู <code>Task&lt;int&gt;</code> ุงู ูุชุฏ ุจุง ูุชุฌู ดฒ ุชฺฉูู ูโุดูุฏ ู ุงุฏุงููโ ุงุฌุฑุง <code>PrintAnswerToLife</code> ุงุฌุฑุง ูโุดูุฏ ู ุฏุณุชูุฑุงุช ุจุงูโูุงูุฏู ุฏุฑ ุขู ูุชุฏ ุงุฌุฑุง ูโุดููุฏ. ุงู ุฑููุฏ ุชุง ุฒูุงู ฺฉู <code>Go</code> ุชฺฉูู ุดูุฏ ุงุฏุงูู ูพุฏุง ูโฺฉูุฏ.</p>
<p>ุฌุฑุงู ุงุฌุฑุง ูุทุงุจู ูููุฏุงุฑ ูุฑุงุฎูุงู ููุฒูุงู ุงุณุช ฺฉู ูพุดโุชุฑ ูุดุงู ุฏุงุฏูุ ุฒุฑุง ุงูฺฏู ูุง ุงู ุงุณุช ฺฉู ุจูุงูุงุตูู ูพุณ ุงุฒ ูุฑุงุฎูุงู ูุฑ ูุชุฏ ุบุฑููุฒูุงูุ ุขู ุฑุง <code>await</code> ูโฺฉูู. ุงู ุจุงุนุซ ุงุฌุงุฏ ุฌุฑุงู ุชุฑุชุจ ุจุฏูู ููุงุฒโุณุงุฒ ุง ุงุฌุฑุง ููุฒูุงู ุฏุฑูู ูููุฏุงุฑ ูุฑุงุฎูุงู ูโุดูุฏ. ูุฑ ุนุจุงุฑุช <code>await</code> ฺฉ ยซููููยป ุฏุฑ ุงุฌุฑุง ุงุฌุงุฏ ูโฺฉูุฏ ู ูพุณ ุงุฒ ุขู ุจุฑูุงูู ุงุฒ ููุงู ููุทู ุงุฏุงูู ูโุงุจุฏ.</p>
<hr>
<h3>ููุงุฒโุณุงุฒ โก</h3>
<p>ูุฑุงุฎูุงู ฺฉ ูุชุฏ ุบุฑููุฒูุงู ุจุฏูู <code>await</code> ฺฉุฑุฏู ุขูุ ุงุฌุงุฒู ูโุฏูุฏ ฺฉุฏ ุจุนุฏ ุจู ุตูุฑุช ููุงุฒ ุงุฌุฑุง ุดูุฏ. ููฺฉู ุงุณุช ุฏุฑ ูุซุงูโูุง ูุจู ุฏุฏู ุจุงุดุฏ ฺฉู ฺฉ ุฏฺฉูู ุฏุงุดุชู ฺฉู handler ุขู <code>Go</code> ุฑุง ูุฑุงุฎูุงู ูโฺฉุฑุฏ:</p>
<pre class="hljs"><code>_button.Click += (sender, <span class="hljs-keyword">args</span>) =&gt; Go();
</code></pre>
<p>ุจุง ูุฌูุฏ ุงูฺฉู <code>Go</code> ฺฉ ูุชุฏ ุบุฑููุฒูุงู ุงุณุชุ ูุง ุขู ุฑุง <code>await</code> ูฺฉุฑุฏู ู ุงู ููุงู ฺุฒ ุงุณุช ฺฉู ููุฒูุงู ูุงุฒู ุจุฑุง ุญูุธ ูพุงุณุฎฺฏู UI ุฑุง ูุฑุงูู ูโฺฉูุฏ.</p>
<p>ูโุชูุงูู ุงุฒ ููู ุงุตู ุจุฑุง ุงุฌุฑุง ุฏู ุนููุงุช ุบุฑููุฒูุงู ุจู ุตูุฑุช ููุงุฒ ุงุณุชูุงุฏู ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> task1 = PrintAnswerToLife();
<span class="hljs-keyword">var</span> task2 = PrintAnswerToLife();
<span class="hljs-keyword">await</span> task1;
<span class="hljs-keyword">await</span> task2;
</code></pre>
<p>(ุจุง <code>await</code> ฺฉุฑุฏู ูุฑ ุฏู ุนููุงุช ุจุนุฏุงูุ ุฏุฑ ุขู ููุทู ููุงุฒโุณุงุฒ ยซุจู ูพุงุงู ูโุฑุณุฏยป. ุจุนุฏุงู ุจุง ุชุฑฺฉุจโฺฉููุฏู <code>WhenAll</code> ุงู ุงูฺฏู ุฑุง ุชูุถุญ ูโุฏูู.)</p>
<p>ููุฒูุงู ุงุฌุงุฏ ุดุฏู ุจู ุงู ุดฺฉูุ ฺู ุนููุงุช ุฑู ูุฎ UI ุขุบุงุฒ ุดุฏู ุจุงุดุฏ ู ฺู ููุ ุฑุฎ ูโุฏูุฏุ ุงฺฏุฑฺู ุชูุงูุช ุฏุฑ ูุญูู ูููุน ุขู ูุฌูุฏ ุฏุงุฑุฏ. ุฏุฑ ูุฑ ุฏู ุญุงูุชุ ููุงู ููุฒูุงู ูุงูุน ุฏุฑ ุณุทุญ ูพุงู ุงุชูุงู ูโุงูุชุฏ (ูุซู <code>Task.Delay</code> ุง ฺฉุฏ ฺฉู ุจู <code>Task.Run</code> ุณูพุฑุฏู ุดุฏู ุงุณุช). ูุชุฏูุง ุจุงูุงุชุฑ ุฏุฑ call stack ุชููุง ุฏุฑ ุตูุฑุช ููุฒูุงู ูุงูุน ุฎูุงููุฏ ุฏุงุดุช ฺฉู ุนููุงุช ุจุฏูู ุญุถูุฑ <code>SynchronizationContext</code> ุขุบุงุฒ ุดุฏู ุจุงุดุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุจู ููุฒูุงู ุดุจูโูุงูุน (pseudo-concurrency) ู ุงูู ุณุงุฏูโุดุฏู ูุฎโูุง ูุญุฏูุฏ ูโุดููุฏุ ุฌุง ฺฉู ุชููุง ููุทูโุง ฺฉู ูโุชูุงูู ูุชููู ุดููุ ุนุจุงุฑุช <code>await</code> ุงุณุช. ุงู ุงุฌุงุฒู ูโุฏูุฏ ฺฉู ุจุฑุง ูุซุงูุ ฺฉ ููุฏ ูุดุชุฑฺฉ <code>_x</code> ุชุนุฑู ฺฉุฑุฏู ู ุฏุฑ <code>GetAnswerToLife</code> ุจุฏูู ููู ฺฉุฑุฏู ุขู ุฑุง ุงูุฒุงุด ุฏูู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetAnswerToLife</span>()</span>
{
    _x++;
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">5000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">21</span> * <span class="hljs-number">2</span>;
}
</code></pre>
<p>(ุจุง ุงู ุญุงูุ ููโุชูุงูู ูุฑุถ ฺฉูู ฺฉู <code>_x</code> ูุจู ู ุจุนุฏ ุงุฒ <code>await</code> ููุฏุงุฑ ฺฉุณุงู ุฏุงุฑุฏ.)</p>
<hr>
<h3>ุนุจุงุฑุชโูุง Lambda ุบุฑููุฒูุงู ๐น</h3>
<p>ููุงูุทูุฑ ฺฉู ูุชุฏูุง ูุนููู ูุงูโุฏุงุฑ ูโุชูุงููุฏ ุบุฑููุฒูุงู ุจุงุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">NamedMethod</span>()</span>
{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
    Console.WriteLine(<span class="hljs-string">&quot;Foo&quot;</span>);
}
</code></pre>
<p>ูููโุทูุฑ ูโุชูุงู ูุชุฏูุง ุจุฏูู ูุงู (lambda ู anonymous) ุฑุง ุจุง ูพุดููุฏ <code>async</code> ููุดุช:</p>
<pre class="hljs"><code>Func&lt;Task&gt; unnamed = <span class="hljs-keyword">async</span> () =&gt;
{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
    Console.WriteLine(<span class="hljs-string">&quot;Foo&quot;</span>);
};
</code></pre>
<p>ูโุชูุงูู ุขููุง ุฑุง ูุฑุงุฎูุงู ู <code>await</code> ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">await</span> NamedMethod();
<span class="hljs-keyword">await</span> unnamed();
</code></pre>
<p>ููฺูู ูโุชูุงู ุงุฒ Lambda ุบุฑููุฒูุงู ููฺฏุงู attach ฺฉุฑุฏู event handler ุงุณุชูุงุฏู ฺฉุฑุฏ:</p>
<pre class="hljs"><code>myButton.Click += <span class="hljs-keyword">async</span> (sender, <span class="hljs-keyword">args</span>) =&gt;
{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
    myButton.Content = <span class="hljs-string">&quot;Done&quot;</span>;
};
</code></pre>
<p>ุงู ฺฉูุชุงูโุชุฑ ุงุฒ ุฑูุด ุฒุฑ ุงุณุช ฺฉู ููุงู ุงุซุฑ ุฑุง ุฏุงุฑุฏ:</p>
<pre class="hljs"><code>myButton.Click += ButtonHandler;
...
<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ButtonHandler</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, EventArgs <span class="hljs-keyword">args</span></span>)</span>
{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
    myButton.Content = <span class="hljs-string">&quot;Done&quot;</span>;
};
</code></pre>
<p>Lambda ุบุฑููุฒูุงู ูโุชูุงูุฏ <code>Task&lt;TResult&gt;</code> ูุฒ ุจุงุฒฺฏุฑุฏุงูุฏ:</p>
<pre class="hljs"><code>Func&lt;Task&lt;<span class="hljs-built_in">int</span>&gt;&gt; unnamed = <span class="hljs-keyword">async</span> () =&gt;
{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>;
};
<span class="hljs-built_in">int</span> answer = <span class="hljs-keyword">await</span> unnamed();
</code></pre>
<hr>
<h3>ุฌุฑุงูโูุง ุบุฑููุฒูุงู ๐</h3>
<p>ุจุง <code>yield return</code> ูโุชูุงู ฺฉ iterator ููุดุชุ ุจุง <code>await</code> ูโุชูุงู ฺฉ ูุชุฏ ุบุฑููุฒูุงู ููุดุช. <strong>ุฌุฑุงูโูุง ุบุฑููุฒูุงู</strong> (ุงุฒ C# 8) ุงู ุฏู ููููู ุฑุง ุชุฑฺฉุจ ูโฺฉููุฏ ู ุจู ุดูุง ุงูฺฉุงู ูโุฏููุฏ ฺฉ iterator ุจููุณุฏ ฺฉู ุฏุฑ ุทูู ุงุฌุฑุง ุขู ููุชุธุฑ ุจูุงูุฏ ู ุนูุงุตุฑ ุฑุง ุจู ุตูุฑุช ุบุฑููุฒูุงู ุจุฑฺฏุฑุฏุงูุฏ. ุงู ูฺฺฏ ุจุฑ ุงุณุงุณ ุฏู ุงูุชุฑูุณ ุฒุฑ ุณุงุฎุชู ุดุฏู ุงุณุช ฺฉู ูุณุฎูโูุง ุบุฑููุฒูุงู ุงูุชุฑูุณโูุง ุดูุงุฑุด ูุณุชูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IAsyncEnumerable</span>&lt;<span class="hljs-keyword">out</span> <span class="hljs-title">T</span>&gt;
{
    <span class="hljs-function">IAsyncEnumerator&lt;T&gt; <span class="hljs-title">GetAsyncEnumerator</span>(<span class="hljs-params">...</span>)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IAsyncEnumerator</span>&lt;<span class="hljs-keyword">out</span> <span class="hljs-title">T</span>&gt; : <span class="hljs-title">IAsyncDisposable</span>
{
    T Current { <span class="hljs-keyword">get</span>; }
    <span class="hljs-function">ValueTask&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-title">MoveNextAsync</span>()</span>;
}
</code></pre>
<p><code>ValueTask&lt;T&gt;</code> ฺฉ struct ุงุณุช ฺฉู <code>Task&lt;T&gt;</code> ุฑุง ุจุณุชูโุจูุฏ ูโฺฉูุฏ ู ุงุฒ ูุธุฑ ุฑูุชุงุฑ ูุดุงุจู ุขู ุงุณุช ู ุฏุฑ ุนู ุญุงู ุงุฌุฑุง ฺฉุงุฑุขูุฏุชุฑ ุฒูุงู ฺฉู ุชุณฺฉ ุจู ุตูุฑุช ููุฒูุงู ฺฉุงูู ุดูุฏุ ุงุฑุงุฆู ูโุฏูุฏ. <code>IAsyncDisposable</code> ูุณุฎู ุบุฑููุฒูุงู <code>IDisposable</code> ุงุณุช ู ุงูฺฉุงู cleanup ุบุฑููุฒูุงู ุฑุง ูุฑุงูู ูโฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IAsyncDisposable</span>
{
    <span class="hljs-function">ValueTask <span class="hljs-title">DisposeAsync</span>()</span>;
}
</code></pre>
<p>ุงูุฏุงู ุจู ฺฏุฑูุชู ูุฑ ุนูุตุฑ ุงุฒ ุชูุงู (<code>MoveNextAsync</code>) ฺฉ ุนููุงุช ุบุฑููุฒูุงู ุงุณุชุ ุจูุงุจุฑุงู ุฌุฑุงูโูุง ุบุฑููุฒูุงู ููุงุณุจ ุฒูุงู ูุณุชูุฏ ฺฉู ุนูุงุตุฑ ุจู ุตูุฑุช ุชุฏุฑุฌ (ูุซูุงู ุงุฒ ฺฉ ูุฏู ุงุณุชุฑู) ูโุฑุณูุฏ.</p>
<p>ุฏุฑ ููุงุจูุ ููุน ุฒุฑ ุฒูุงู ููุงุณุจ ุงุณุช ฺฉู ฺฉู ุชูุงู ุชุฃุฎุฑ ุฏุงุดุชู ุจุงุดุฏ ุงูุง ุนูุงุตุฑ ููฺฏุงู ุฑุณุฏู ููู ุจุง ูู ุงุฑุงุฆู ุดููุฏ:</p>
<pre class="hljs"><code>Task&lt;IEnumerable&lt;T&gt;&gt;
</code></pre>
<p>ุจุฑุง ุงุฌุงุฏ ุฌุฑุงู ุบุฑููุฒูุงูุ ุจุงุฏ ูุชุฏ ููุดุช ฺฉู ุงุตูู iterator ู ูุชุฏูุง ุบุฑููุฒูุงู ุฑุง ุชุฑฺฉุจ ฺฉูุฏ. ุนู ูุชุฏ ุจุงุฏ ูู <code>yield return</code> ู ูู <code>await</code> ุฏุงุดุชู ุจุงุดุฏ ู ููุน ุจุงุฒฺฏุดุช ุขู <code>IAsyncEnumerable&lt;T&gt;</code> ุจุงุดุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> IAsyncEnumerable&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">RangeAsync</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> start, <span class="hljs-built_in">int</span> count, <span class="hljs-built_in">int</span> delay</span>)</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = start; i &lt; start + count; i++)
    {
        <span class="hljs-keyword">await</span> Task.Delay(delay);
        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> i;
    }
}
</code></pre>
<p>ุจุฑุง ูุตุฑู ฺฉ ุฌุฑุงู ุบุฑููุฒูุงูุ ุงุฒ <code>await foreach</code> ุงุณุชูุงุฏู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-function"><span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> <span class="hljs-title">RangeAsync</span>(<span class="hljs-params"><span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">500</span></span>))
    Console.<span class="hljs-title">WriteLine</span>(<span class="hljs-params">number</span>)</span>;
</code></pre>
<p>ุชูุฌู ฺฉูุฏ ฺฉู ุฏุงุฏูโูุง ุจู ุตูุฑุช ูพูุณุชู ูุฑ ตฐฐ ููโุซุงูู (ุง ุฏุฑ ูุงูุนุชุ ุจู ูุญุถ ุขูุงุฏู ุดุฏู) ูโุฑุณูุฏ. ุฏุฑ ููุงุณู ุจุง ููุงู ุณุงุฎุชุงุฑ ุจุง <code>Task&lt;IEnumerable&lt;T&gt;&gt;</code>ุ ูฺ ุฏุงุฏูโุง ุจุงุฒฺฏุฑุฏุงูุฏู ููโุดูุฏ ุชุง ุขุฎุฑู ุนูุตุฑ ุขูุงุฏู ุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;IEnumerable&lt;<span class="hljs-built_in">int</span>&gt;&gt; RangeTaskAsync(<span class="hljs-built_in">int</span> start, <span class="hljs-built_in">int</span> count, <span class="hljs-built_in">int</span> delay)
{
    List&lt;<span class="hljs-built_in">int</span>&gt; data = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = start; i &lt; start + count; i++)
    {
        <span class="hljs-keyword">await</span> Task.Delay(delay);
        data.Add(i);
    }
    <span class="hljs-keyword">return</span> data;
}
</code></pre>
<p>ุจุฑุง ูุตุฑู ุขู ุจุง <code>foreach</code>:</p>
<pre class="hljs"><code><span class="hljs-keyword">foreach</span> (<span class="hljs-function"><span class="hljs-keyword">var</span> data <span class="hljs-keyword">in</span> <span class="hljs-keyword">await</span> <span class="hljs-title">RangeTaskAsync</span>(<span class="hljs-params"><span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">500</span></span>))
    Console.<span class="hljs-title">WriteLine</span>(<span class="hljs-params">data</span>)</span>;
</code></pre>
<h3>ูพุฑุณโูุฌู ุฑู IAsyncEnumerable<T> ๐</h3>
<p>ูพฺฉุฌ <strong>System.Linq.Async</strong>ุ ุนููฺฏุฑูุง LINQ ุฑุง ุจุฑุง <strong>IAsyncEnumerable<T></strong> ุชุนุฑู ูโฺฉูุฏุ ฺฉู ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ฺฉูุฆุฑโูุง ุฑุง ุชูุฑุจุงู ููุงููุฏ <strong>IEnumerable<T></strong> ุจููุณุฏ.</p>
<p>ุจุฑุง ูุซุงูุ ูโุชูุงูู ฺฉ ฺฉูุฆุฑ LINQ ุฑู ูุชุฏ <strong>RangeAsync</strong> ฺฉู ุฏุฑ ุจุฎุด ูุจู ุชุนุฑู ฺฉุฑุฏู ุจููุณู:</p>
<pre class="hljs"><code>IAsyncEnumerable&lt;<span class="hljs-built_in">int</span>&gt; query =
    <span class="hljs-function"><span class="hljs-keyword">from</span> i <span class="hljs-keyword">in</span> <span class="hljs-title">RangeAsync</span>(<span class="hljs-params"><span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">500</span></span>)
    <span class="hljs-keyword">where</span> i % 2</span> == <span class="hljs-number">0</span>      <span class="hljs-comment">// ููุท ุงุนุฏุงุฏ ุฒูุฌ</span>
    <span class="hljs-keyword">select</span> i * <span class="hljs-number">10</span>;        <span class="hljs-comment">// ุถุฑุจ ุฏุฑ ฑฐ</span>

<span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> query)
    Console.WriteLine(number);
</code></pre>
<p>ุงู ฺฉุฏ ุฎุฑูุฌโูุง ูุงููุฏ <code>0, 20, 40, ...</code> ุชููุฏ ูโฺฉูุฏ.</p>
<p>ุงฺฏุฑ ุจุง <strong>Rx</strong> ุขุดูุง ูุณุชุฏุ ูโุชูุงูุฏ ุงุฒ ุนููฺฏุฑูุง ููโุชุฑ ุขู ูุฒ ุจูุฑู ุจุจุฑุฏุ ุจุง ูุฑุงุฎูุงู ูุชุฏ <strong>ToObservable</strong> ฺฉู ฺฉ <strong>IAsyncEnumerable<T></strong> ุฑุง ุจู <strong>IObservable<T></strong> ุชุจุฏู ูโฺฉูุฏ. ููฺูู ูุชุฏ <strong>ToAsyncEnumerable</strong> ุจุฑุง ุชุจุฏู ุฏุฑ ุฌูุช ูุนฺฉูุณ ูุฒ ูุฌูุฏ ุฏุงุฑุฏ.</p>
<hr>
<h3>IAsyncEnumerable<T> ุฏุฑ <a href="http://ASP.Net">ASP.Net</a> Core ๐</h3>
<p>ุงฺฉุดูโูุง Controller ุฏุฑ <strong><a href="http://ASP.Net">ASP.Net</a> Core</strong> ุงฺฉููู ูโุชูุงููุฏ <strong>IAsyncEnumerable<T></strong> ุจุงุฒฺฏุฑุฏุงููุฏ. ฺูู ูุชุฏูุง ุจุงุฏ ุจุง ฺฉููู ฺฉูุฏ <code>async</code> ูุดุฎุต ุดููุฏ. ูุซุงู:</p>
<pre class="hljs"><code>[<span class="hljs-meta">HttpGet</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> IAsyncEnumerable&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">Get</span>()</span>
{
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> dbContext = <span class="hljs-keyword">new</span> BookContext();
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> title <span class="hljs-keyword">in</span> dbContext.Books
                                         .Select(b =&gt; b.Title)
                                         .AsAsyncEnumerable())
        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> title;
}
</code></pre>
<hr>
<h3>ูุชุฏูุง ุบุฑููุฒูุงู ุฏุฑ WinRT โก</h3>
<p>ุงฺฏุฑ ุฏุฑ ุญุงู ุชูุณุนู ุจุฑูุงููโูุง <strong>UWP</strong> ูุณุชุฏุ ุจุงุฏ ุจุง ุงููุงุน <strong>WinRT</strong> ฺฉู ุฏุฑ ุณุณุชูโุนุงูู ุชุนุฑู ุดุฏูโุงูุฏ ฺฉุงุฑ ฺฉูุฏ. ูุนุงุฏู <strong>Task</strong> ุฏุฑ WinRTุ <strong>IAsyncAction</strong> ู ูุนุงุฏู <strong>Task<TResult></strong>ุ <strong>IAsyncOperation<TResult></strong> ุงุณุช. ุจุฑุง ุนููุงุชโูุง ฺฉู ูพุดุฑูุช (Progress) ฺฏุฒุงุฑุด ูโุฏููุฏุ ูุนุงุฏูโูุง ุนุจุงุฑุชโุงูุฏ ุงุฒ: <strong>IAsyncActionWithProgress<TProgress></strong> ู <strong>IAsyncOperationWithProgress&lt;TResult, TProgress&gt;</strong>. ููู ุงูโูุง ุฏุฑ namespace <strong>Windows.Foundation</strong> ุชุนุฑู ุดุฏูโุงูุฏ.</p>
<p>ูโุชูุงูุฏ ุขููุง ุฑุง ุจู <strong>Task</strong> ุง <strong>Task<TResult></strong> ุชุจุฏู ฺฉูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>AsTask</strong>:</p>
<pre class="hljs"><code>Task&lt;StorageFile&gt; fileTask = KnownFolders.DocumentsLibrary
                                     .CreateFileAsync(<span class="hljs-string">&quot;test.txt&quot;</span>)
                                     .AsTask();
</code></pre>
<p>ุง ูุณุชููุงู <code>await</code> ฺฉูุฏ:</p>
<pre class="hljs"><code>StorageFile <span class="hljs-keyword">file</span> = <span class="hljs-keyword">await</span> KnownFolders.DocumentsLibrary
                                .CreateFileAsync(<span class="hljs-string">&quot;test.txt&quot;</span>);
</code></pre>
<p>ุจู ุฏูู ูุญุฏูุฏุชโูุง ุณุณุชู ููุน COMุ <strong>IAsyncActionWithProgress<TProgress></strong> ู <strong>IAsyncOperationWithProgress&lt;TResult, TProgress&gt;</strong> ุจุฑ ุงุณุงุณ <strong>IAsyncAction</strong> ูุณุชูุฏุ ุจูฺฉู ูุฑ ุฏู ุงุฒ ููุน ูพุงู ูุดุชุฑฺฉ ุจู ูุงู <strong>IAsyncInfo</strong> ุงุฑุซโุจุฑ ูโฺฉููุฏ.</p>
<p>ูุชุฏ <strong>AsTask</strong> ููฺูู ูโุชูุงูุฏ ฺฉ <strong>cancellation token</strong> ุฏุฑุงูุช ฺฉูุฏ ู ูโุชูุงูุฏ ุจุง ููุน <strong>IProgress<T></strong> ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ูุณุฎูโูุง WithProgress ุชุฑฺฉุจ ุดูุฏ.</p>
<hr>
<h3>ุบุฑููุฒูุงู ู Synchronization Context โณ</h3>
<p>ููุงูโุทูุฑ ฺฉู ูุจูุงู ุฏุฏูุ ูุฌูุฏ <strong>SynchronizationContext</strong> ุฏุฑ ุงุฑุณุงู ุงุฏุงููโูุง ุงุฌุฑุง (continuations) ููู ุงุณุช. ฺูุฏ ูฺฉุชู ุธุฑู ุฏฺฏุฑ ูุฒ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุงู contexts ุจุง ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช <code>void</code> ุงุฌุงุฏ ูโฺฉููุฏ. ุงูโูุง ูุชุฌู ูุณุชูู ฺฉุงููพุงูุฑ C# ูุณุชุ ุจูฺฉู ูุงุด ุงุฒ ููุนโูุง <strong>Async*MethodBuilder</strong> ุฏุฑ namespace <strong>System.CompilerServices</strong> ุงุณุช ฺฉู ฺฉุงููพุงูุฑ ููฺฏุงู ฺฏุณุชุฑุด ูุชุฏูุง ุบุฑููุฒูุงู ุงุณุชูุงุฏู ูโฺฉูุฏ.</p>
<h4>ุงุฑุณุงู Exception โ๏ธ</h4>
<p>ุฏุฑ ุจุฑูุงููโูุง Rich-Client ูุนููู ุงุณุช ฺฉู ุงุฒ ุฑูุฏุงุฏ ูุฑฺฉุฒ ูุฏุฑุช ุงุณุชุซูุง (<strong>Application.DispatcherUnhandledException</strong> ุฏุฑ WPF) ุจุฑุง ูพุฑุฏุงุฒุด ุงุณุชุซูุงูุง ุจุฏูู ฺฉูุชุฑู ุฑู ูุฎ UI ุงุณุชูุงุฏู ุดูุฏ. ุฏุฑ ุจุฑูุงููโูุง <strong><a href="http://ASP.NET">ASP.NET</a> Core</strong> ูุฒุ ฺฉ <strong>ExceptionFilterAttribute</strong> ุณูุงุฑุด ุฏุฑ <strong>ConfigureServices</strong> ุฏุฑ <strong>Startup.cs</strong> ููู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ. ุฏุฑ ูพุดุช ุตุญููุ ุงูโูุง ุจุง ูุฑุงุฎูุงู eventูุง (ุง pipeline ูุชุฏูุง ูพุฑุฏุงุฒุด ุตูุญุงุช ุฏุฑ <a href="http://ASP.NET">ASP.NET</a> Core) ุฏุฑ ุจููฺฉ try/catch ุฎูุฏุดุงู ฺฉุงุฑ ูโฺฉููุฏ.</p>
<p>ูุชุฏูุง ุบุฑููุฒูุงู ุณุทุญ ุจุงูุง ุงู ููุถูุน ุฑุง ูพฺุฏู ูโฺฉููุฏ. ุจู ูุซุงู ุฒุฑ ุชูุฌู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ButtonClick</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, RoutedEventArgs <span class="hljs-keyword">args</span></span>)</span>
{
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">&quot;Will this be ignored?&quot;</span>);
}
</code></pre>
<p>ููุช ุฏฺฉูู ฺฉูฺฉ ูโุดูุฏ ู handler ุงุฌุฑุง ูโุดูุฏุ ูพุณ ุงุฒ <code>await</code> ุงุฌุฑุง ุจุฑูุงูู ุจู message loop ุจุงุฒูโฺฏุฑุฏุฏุ ู ุงุณุชุซูุง ฺฉู ฺฉ ุซุงูู ุจุนุฏ ูพุฑุชุงุจ ูโุดูุฏุ ุชูุณุท catch ุจููฺฉ ุฏุฑ message loop ฺฏุฑูุชู ููโุดูุฏ.</p>
<p>ุจุฑุง ุญู ุงู ูุดฺฉูุ <strong>AsyncVoidMethodBuilder</strong> ุงุณุชุซูุงูุง ุจุฏูู ฺฉูุชุฑู (ุฏุฑ ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช <code>void</code>) ุฑุง ูโฺฏุฑุฏ ู ุขููุง ุฑุง ุฏุฑ ุตูุฑุช ูุฌูุฏุ ุจู <strong>SynchronizationContext</strong> ุงุฑุณุงู ูโฺฉูุฏ ุชุง ุฑูุฏุงุฏูุง ูุฏุฑุช ุงุณุชุซูุง ุฌูุงู ููฺูุงู ุงุฌุฑุง ุดููุฏ.</p>
<p>ฺฉุงููพุงูุฑ ุงู ููุทู ุฑุง ุชููุง ุฑู ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช <code>void</code> ุงุนูุงู ูโฺฉูุฏ. ุจูุงุจุฑุงู ุงฺฏุฑ <strong>ButtonClick</strong> ุฑุง ุจู ุจุงุฒฺฏุดุช <strong>Task</strong> ุชุบุฑ ุฏููุ ุงุณุชุซูุง ุจุฏูู ฺฉูุชุฑู Task ุฑุง Fault ูโฺฉูุฏ ู ูฺ ูุณุฑ ุฏฺฏุฑ ุจุฑุง ุฑุณุฏู ุจู ุขู ูุฌูุฏ ูุฏุงุฑุฏ (ููุฌุฑ ุจู unobserved exception ูโุดูุฏ).</p>
<p>ฺฉ ูฺฉุชู ุฌุงูุจ: ูุฑู ููโฺฉูุฏ ฺฉู ุงุณุชุซูุง ูุจู ุง ุจุนุฏ ุงุฒ <code>await</code> ูพุฑุชุงุจ ุดูุฏ. ุจุฑุง ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Foo</span>()</span> { <span class="hljs-keyword">throw</span> <span class="hljs-literal">null</span>; <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>); }
</code></pre>
<p>ุงุณุชุซูุง ุจู SynchronizationContext (ุงฺฏุฑ ููุฌูุฏ ุจุงุดุฏ) ุงุฑุณุงู ูโุดูุฏ ู ูุฑฺฏุฒ ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒููโฺฏุฑุฏุฏ. ุงฺฏุฑ SynchronizationContext ููุฌูุฏ ูุจุงุดุฏุ ุงุณุชุซูุง ุฑู Thread Pool ฺฏุณุชุฑุด ูโุงุจุฏ ู ุจุฑูุงูู ุฎุงุชูู ูโุงุจุฏ.</p>
<p>ุงู ุฑูุชุงุฑ ุจุฑุง ุงุทููุงู ุงุฒ ูพุดโุจูโูพุฐุฑ ู ุณุงุฒฺฏุงุฑ ุงุณุช. ูุดุงุจู ุงูุ <strong>InvalidOperationException</strong> ููุดู ุจุงุนุซ Fault ุดุฏู Task ูโุดูุฏุ ุจุฏูู ุชูุฌู ุจู ุดุฑุทโูุง:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Foo</span>()</span>
{
    <span class="hljs-keyword">if</span> (someCondition) <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">100</span>);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException();
}
</code></pre>
<p>Iteratorูุง ูุฒ ุจู ููู ุดฺฉู ฺฉุงุฑ ูโฺฉููุฏ:</p>
<pre class="hljs"><code><span class="hljs-function">IEnumerable&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">Foo</span>()</span> { <span class="hljs-keyword">throw</span> <span class="hljs-literal">null</span>; <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>; }
</code></pre>
<p>ุฏุฑ ุงู ูุซุงูุ ุงุณุชุซูุง ุชุง ุฒูุงู enumerating ุชูุงู ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒููโฺฏุฑุฏุฏ.</p>
<hr>
<h3>OperationStarted ู OperationCompleted โ๏ธ</h3>
<p>ุงฺฏุฑ SynchronizationContext ููุฌูุฏ ุจุงุดุฏุ ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช <code>void</code> ููฺฏุงู ูุฑูุฏ ุจู ูุชุฏ <strong>OperationStarted</strong> ู ููฺฏุงู ูพุงุงู <strong>OperationCompleted</strong> ุขู ุฑุง ูุฑุงุฎูุงู ูโฺฉููุฏ.</p>
<p>Override ฺฉุฑุฏู ุงู ูุชุฏูุง ููฺฏุงู ููุดุชู ฺฉ SynchronizationContext ุณูุงุฑุด ุจุฑุง ุชุณุช ูุงุญุฏ ูุชุฏูุง ุบุฑููุฒูุงู ุจุง ุจุงุฒฺฏุดุช <code>void</code> ููุฏ ุงุณุช. ุงู ููุถูุน ุฏุฑ <strong>Microsoft Parallel Programming blog</strong> ุชูุถุญ ุฏุงุฏู ุดุฏู ุงุณุช.</p>
<h3>ุจูููโุณุงุฒโูุง โก</h3>
<h4>ุชฺฉูู ููุฒูุงู (Completing synchronously) โฑ๏ธ</h4>
<p>ฺฉ ูุชุฏ ุบุฑููุฒูุงู ูโุชูุงูุฏ ูุจู ุงุฒ <code>await</code> ุจุงุฒฺฏุฑุฏุฏ. ุจู ูุซุงู ุฒุฑ ฺฉู ุฏุงูููุฏ ุตูุญุงุช ูุจ ุฑุง <strong>ฺฉุด</strong> ูโฺฉูุฏ ุชูุฌู ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">string</span>,<span class="hljs-built_in">string</span>&gt; _cache = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>,<span class="hljs-built_in">string</span>&gt;();

<span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetWebPageAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> uri</span>)</span>
{
    <span class="hljs-built_in">string</span> html;
    <span class="hljs-keyword">if</span> (_cache.TryGetValue(uri, <span class="hljs-keyword">out</span> html)) <span class="hljs-keyword">return</span> html;
    <span class="hljs-keyword">return</span> _cache[uri] = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> WebClient().DownloadStringTaskAsync(uri);
}
</code></pre>
<p>ุงฺฏุฑ URI ุงุฒ ูุจู ุฏุฑ ฺฉุด ููุฌูุฏ ุจุงุดุฏุ ุงุฌุฑุง ุจุฑูุงูู ุจุฏูู ูฺ <code>await</code> ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏ ู ูุชุฏ ฺฉ <strong>Task</strong> ุงุฒ ูพุด ุชฺฉููโุดุฏู ุจุฑูโฺฏุฑุฏุงูุฏ. ุจู ุงู ุญุงูุช <strong>ุชฺฉูู ููุฒูุงู (synchronous completion)</strong> ฺฏูุชู ูโุดูุฏ.</p>
<p>ููุช ฺฉ <strong>Task</strong> ฺฉู ููุฒูุงู ุชฺฉูู ุดุฏู ุฑุง <code>await</code> ูโฺฉูุฏุ ุงุฌุฑุง ุจู ุฌุง ุจุงุฒฺฏุดุช ุจู ูุฑุงุฎูุงููุฏู ู ุงุฏุงูู ุงุฒ ุทุฑู continuationุ ูุณุชูู ุจู ุฏุณุชูุฑ ุจุนุฏ ูโุฑูุฏ. ฺฉุงููพุงูุฑ ุงู ุจูููโุณุงุฒ ุฑุง ุจุง ุจุฑุฑุณ ุฎุงุตุช <code>IsCompleted</code> ุฑู <strong>awaiter</strong> ุงูุฌุงู ูโุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> awaiter = GetWebPageAsync().GetAwaiter();
<span class="hljs-keyword">if</span> (awaiter.IsCompleted)
    Console.WriteLine(awaiter.GetResult());
<span class="hljs-keyword">else</span>
    awaiter.OnCompleted(() =&gt; Console.WriteLine(awaiter.GetResult()));
</code></pre>
<p><code>await</code> ฺฉุฑุฏู ฺฉ ูุชุฏ ฺฉู ููุฒูุงู ุชฺฉูู ุดุฏูุ ุชููุง ุจุงุฑ ฺฉูฺฺฉ ุฏุงุฑุฏโูุซูุงู ุญุฏูุฏ ฒฐ ูุงููุซุงูู ุฑู ฺฉ ฺฉุงููพูุชุฑ ฒฐฑน. ุฏุฑ ููุงุจูุ ุฑูุชู ุจู <strong>Thread Pool</strong> ูุฒูู ฺฉ <strong>Context Switch</strong> ุฏุงุฑุฏโุญุฏูุฏ ฑ ุชุง ฒ ูฺฉุฑูุซุงููุ ู ุฑูุชู ุจู <strong>UI Message Loop</strong> ุญุฏุงูู ฑฐ ุจุฑุงุจุฑ ุจุดุชุฑ (ุจุณุงุฑ ุจุดุชุฑ ุงฺฏุฑ ูุฎ UI ุดููุบ ุจุงุดุฏ).</p>
<hr>
<h4>ูุชุฏูุง ุบุฑููุฒูุงู ุจุฏูู <code>await</code> โ๏ธ</h4>
<p>ูุงูููุงู ูโุชูุงูุฏ ูุชุฏูุง ุบุฑููุฒูุงู ุจููุณุฏ ฺฉู ูุฑฺฏุฒ <code>await</code> ูุฏุงุดุชู ุจุงุดูุฏุ ฺฏุฑฺู ฺฉุงููพุงูุฑ ูุดุฏุงุฑ ูโุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">Foo</span>()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;abc&quot;</span>; }
</code></pre>
<p>ุงู ูุชุฏูุง ุจุฑุง <strong>Override ฺฉุฑุฏู ูุชุฏูุง virtual/abstract</strong> ููุฏูุฏุ ุญุช ุงฺฏุฑ ูุงุฒ ุจู ุบุฑููุฒูุงู ูุฏุงุดุชู ุจุงุดุฏ. ุฑูุด ุฏฺฏุฑ ุงุณุชูุงุฏู ุงุฒ <strong>Task.FromResult</strong> ุงุณุชุ ฺฉู ฺฉ <strong>Task</strong> ุงุฒ ูพุด ุชฺฉููโุดุฏู ุจุฑูโฺฏุฑุฏุงูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function">Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">Foo</span>()</span> { <span class="hljs-keyword">return</span> Task.FromResult(<span class="hljs-string">&quot;abc&quot;</span>); }
</code></pre>
<p>ูุชุฏ <strong>GetWebPageAsync</strong> ุงฺฏุฑ ุงุฒ ูุฎ UI ูุฑุงุฎูุงู ุดูุฏุ ุจู ุทูุฑ ุถูู <strong>Thread-Safe</strong> ุงุณุชุ ุฒุฑุง ูโุชูุงู ฺูุฏ ุจุงุฑ ูพุดุช ุณุฑ ูู ุขู ุฑุง ูุฑุงุฎูุงู ฺฉุฑุฏ ุจุฏูู ูุงุฒ ุจู ููู ฺฉุฑุฏู. ุงูุง ุงฺฏุฑ ฺูุฏ ูุฑุงุฎูุงู ุจุฑุง ููุงู URI ุงูุฌุงู ุดูุฏุ ฺูุฏ ุฏุงูููุฏ ุชฺฉุฑุงุฑ ุฑุฎ ูโุฏูุฏ ฺฉู ุฏุฑ ููุงุช ุขุฎุฑู ุฏุงูููุฏ ฺฉุด ุฑุง ุจุฑูุฒุฑุณุงู ูโฺฉูุฏ.</p>
<p>ุฑุงู ุญู ุจููู: ุจู ุฌุง ุฐุฎุฑู ุฑุดุชูโูุงุ <strong>ฺฉุด โfuturesโ</strong> (ุนู Task<string>) ุงุฌุงุฏ ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-built_in">string</span>,Task&lt;<span class="hljs-built_in">string</span>&gt;&gt; _cache = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>,Task&lt;<span class="hljs-built_in">string</span>&gt;&gt;();

<span class="hljs-function">Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">GetWebPageAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> uri</span>)</span>
{
    <span class="hljs-keyword">if</span> (_cache.TryGetValue(uri, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> downloadTask)) <span class="hljs-keyword">return</span> downloadTask;
    <span class="hljs-keyword">return</span> _cache[uri] = <span class="hljs-keyword">new</span> WebClient().DownloadStringTaskAsync(uri);
}
</code></pre>
<p>ุชูุฌู ฺฉูุฏ ฺฉู ูุชุฏ ุฑุง <code>async</code> ูฺฉุฑุฏูุ ุฒุฑุง ูุณุชููุงู <strong>Task</strong> ุจุฏุณุช ุขูุฏู ุงุฒ <strong>WebClient</strong> ุฑุง ุจุฑูโฺฏุฑุฏุงูู.</p>
<p>ุงฺฏุฑ ฺูุฏ ุจุงุฑ ููุงู URI ุฑุง ูุฑุงุฎูุงู ฺฉููุ ููุงู <strong>Task<string></strong> ุจุฑูโฺฏุฑุฏุฏ ู ุญุช ุงฺฏุฑ Task ฺฉุงูู ุดุฏู ุจุงุดุฏุ <code>await</code> ฺฉุฑุฏู ุขู ุงุฑุฒุงู ุงุณุช.</p>
<p>ุจุฑุง ุงููโุณุงุฒ ฺฉุงููุ ูโุชูุงูู ุจู ฺฉู ุจุฏูู ูุชุฏ <strong>Lock</strong> ุงุถุงูู ฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">lock</span>(_cache)
{
    <span class="hljs-keyword">if</span> (_cache.TryGetValue(uri, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> downloadTask))
        <span class="hljs-keyword">return</span> downloadTask;
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> _cache[uri] = <span class="hljs-keyword">new</span> WebClient().DownloadStringTaskAsync(uri);
}
</code></pre>
<p>ููู ููุท ุจุฑุง ุจุฑุฑุณ ฺฉุด ู ุงุฌุงุฏ Task ุฌุฏุฏ ุงุณุชุ ูู ุจุฑุง ุทูู ุฒูุงู ุฏุงูููุฏุ ุชุง ููุฒูุงู ุญูุธ ุดูุฏ.</p>
<hr>
<h4>ValueTask<T> ๐</h4>
<p><strong>ValueTask<T></strong> ุจุฑุง <strong>ูุฑูุจูููโุณุงุฒ</strong> ุทุฑุงุญ ุดุฏู ู ููฺฉู ุงุณุช ูุงุฒ ุจู ุงุณุชูุงุฏู ุงุฒ ุขู ูุฏุงุดุชู ุจุงุดุฏุ ุงูุง ุจุฑุฎ ูุชุฏูุง .NET ู <strong>IAsyncEnumerable<T></strong> ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉููุฏ.</p>
<p>ููุงูโุทูุฑ ฺฉู ุฏุฏูุ ฺฉุงููพุงูุฑ ููฺฏุงู <code>await</code> ุฑู ฺฉ Task ุชฺฉููโุดุฏู ููุฒูุงูุ continuation ุฑุง ฺฉูุชุงูโฺฉุฑุฏู ู ูุณุชูู ุจู ุฏุณุชูุฑ ุจุนุฏ ูโุฑูุฏ. ุงฺฏุฑ ุชฺฉูู ููุฒูุงู ุจู ุฏูู <strong>ฺฉุด</strong> ุจุงุดุฏุ ูโุชูุงู ฺฉุด Task ุฑุง ุฐุฎุฑู ฺฉุฑุฏ ุชุง ุจููู ู ุดฺฉ ุจุงุดุฏ.</p>
<p>ุงูุง ุฏุฑ ููู ุญุงูุงุช ุนูู ูุณุช ู ฺฏุงู ูุงุฒ ุจู ุณุงุฎุช Task ุฌุฏุฏ ุงุณุช. ฺูู Task ู Task<T> <strong>Reference Type</strong> ูุณุชูุฏุ ุงุฌุงุฏ ุขูโูุง ูุงุฒ ุจู ุญุงูุธู ุฑู Heap ุฏุงุฑุฏ ู ุฏุฑ ููุงุช ุฌูุนโุขูุฑ ุฒุจุงูู ุฑุฎ ูโุฏูุฏ.</p>
<p>ุจุฑุง <strong>ุจูููโุณุงุฒ ุจุฏูู ุชุฎุตุต ุญุงูุธู</strong>ุ ุงุฒ <strong>ValueTask</strong> ู <strong>ValueTask<T></strong> ุงุณุชูุงุฏู ูโฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> ValueTask&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">Foo</span>()</span> { ... }
<span class="hljs-built_in">int</span> answer = <span class="hljs-keyword">await</span> Foo();   <span class="hljs-comment">// (ุงุญุชูุงูุงู) ุจุฏูู ุชุฎุตุต</span>
</code></pre>
<p>ุงฺฏุฑ ุนููุงุช ููุฒูุงู ฺฉุงูู ูุดูุฏุ <strong>ValueTask<T></strong> ฺฉ Task<T> ูุนููู ูโุณุงุฒุฏ ู await ุฑุง ุจู ุขู ููุชูู ูโฺฉูุฏ. ูโุชูุงู ValueTask<T> ุฑุง ุจู Task<T> ุจุง <strong>AsTask</strong> ุชุจุฏู ฺฉุฑุฏ. ูุณุฎู ุบุฑุฌูุฑฺฉ ุขู ูุฒ ูุฌูุฏ ุฏุงุฑุฏุ ูุดุงุจู Task.</p>
<hr>
<h4>ูฺฉุงุช ุงุญุชุงุท ููฺฏุงู ุงุณุชูุงุฏู ุงุฒ ValueTask<T> โ๏ธ</h4>
<p>ValueTask<T> ุจู ุฏูู ุงูฺฉู struct ุงุณุชุ ุฑูุชุงุฑ ููุน ููุฏุงุฑ (Value Type) ุฏุงุฑุฏ ู ููฺฉู ุงุณุช ุจุงุนุซ ุงุดุชุจุงู ุดูุฏ. ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฑูุชุงุฑ ูุงุฏุฑุณุชุ ุงุฒ ฺฉุงุฑูุง ุฒุฑ ูพุฑูุฒ ฺฉูุฏ:</p>
<ul>
<li><code>await</code> ฺฉุฑุฏู ููุงู ValueTask<T> ฺูุฏ ุจุงุฑ</li>
<li>ูุฑุงุฎูุงู <code>.GetAwaiter().GetResult()</code> ูุจู ุงุฒ ุชฺฉูู ุนููุงุช</li>
</ul>
<p>ุงฺฏุฑ ูุงุฒ ุจู ุงู ฺฉุงุฑูุง ุฏุงุฑุฏุ ุงุจุชุฏุง ุจุง <strong>.AsTask()</strong> ุจู Task ุชุจุฏู ฺฉุฑุฏู ู ุฑู ุขู ฺฉุงุฑ ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">await</span> Foo();              <span class="hljs-comment">// ุงูู</span>
ValueTask&lt;<span class="hljs-built_in">int</span>&gt; valueTask = Foo();  <span class="hljs-comment">// ุฎุทุฑูุงฺฉ!</span>
Task&lt;<span class="hljs-built_in">int</span>&gt; task = Foo().AsTask();   <span class="hljs-comment">// ุงูู</span>
</code></pre>
<hr>
<h4>ุฌููฺฏุฑ ุงุฒ Bounce ุฒุงุฏ ๐</h4>
<p>ุจุฑุง ูุชุฏูุง ฺฉู ุฏุฑ ฺฉ ุญููู ูุฑุงุฎูุงู ูโุดููุฏุ ูโุชูุงูุฏ ูุฒูู ุฑูุช ู ุจุฑฺฏุดุช ุจู UI message loop ุฑุง ุจุง <strong>ConfigureAwait(false)</strong> ฺฉุงูุด ุฏูุฏ. ุงู ุจุงุนุซ ูโุดูุฏ continuation ุจู <strong>SynchronizationContext</strong> ุจุงุฒูฺฏุฑุฏุฏ ู ุจุงุฑ ฺฉูุชุฑ ุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">A</span>()</span> { ... <span class="hljs-keyword">await</span> B(); ... }

<span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">B</span>()</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++)
        <span class="hljs-keyword">await</span> C().ConfigureAwait(<span class="hljs-literal">false</span>);
}

<span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">C</span>()</span> { ... }
</code></pre>
<p>ุฏุฑ ุงู ุญุงูุชุ ูุฏู ุณุงุฏู thread-safety ุฏุฑ ุงูพโูุง UI ุงุฒ ุจู ูโุฑูุฏุ ุงูุง ูุชุฏ A ุงฺฏุฑ ุฑู ูุฎ UI ุดุฑูุน ุดุฏู ุจุงุดุฏุ ุฑู ููุงู ูุฎ ุจุงู ูโูุงูุฏ.</p>
<p>ุงู ุจูููโุณุงุฒ ุจุฑุง <strong>ฺฉุชุงุจุฎุงููโูุง</strong> ุจุณุงุฑ ููุฏ ุงุณุชุ ุฌุง ฺฉู ูุนูููุงู ุจุง state ูุดุชุฑฺฉ ูุฑุงุฎูุงููุฏู ฺฉุงุฑ ููโฺฉูุฏ ู ุจู ฺฉูุชุฑูโูุง UI ุฏุณุชุฑุณ ูุฏุงุฑุฏ. ููฺูู ูุชุฏูุง ฺฉู ุณุฑุน ุงุฌุฑุง ูโุดููุฏุ ูโุชูุงููุฏ ุจุฏูู ุชุฎุตุต Task ฺฉุงูู ุดููุฏ.</p>
<h3>ุงูฺฏููุง ุบุฑููุฒูุงู (Asynchronous Patterns) โก</h3>
<h4>ูุบู ุนููุงุช (Cancellation) โ</h4>
<p>ฺฏุงู ุงููุงุช ููู ุงุณุช ฺฉู ุจุชูุงู ฺฉ ุนููุงุช ููุฒูุงู ุฑุง ุจุนุฏ ุงุฒ ุดุฑูุนุ <strong>ูุบู</strong> ฺฉุฑุฏโูุซูุงู ุฏุฑ ูพุงุณุฎ ุจู ุฏุฑุฎูุงุณุช ฺฉุงุฑุจุฑ. ฺฉ ุฑุงู ุณุงุฏู ุจุฑุง ุงู ฺฉุงุฑ ุงุณุชูุงุฏู ุงุฒ <strong>ููฺฏ ูุบู (cancellation flag)</strong> ุงุณุชุ ฺฉู ูโุชูุงู ุจุง ููุดุชู ฺฉูุงุณ ุฒุฑ ุขู ุฑุง ฺฉูพุณููู ฺฉุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">class</span> <span class="hljs-title">CancellationToken</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsCancellationRequested { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Cancel</span>()</span> { IsCancellationRequested = <span class="hljs-literal">true</span>; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ThrowIfCancellationRequested</span>()</span>
    {
        <span class="hljs-keyword">if</span> (IsCancellationRequested)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OperationCanceledException();
    }
}
</code></pre>
<p>ุณูพุณ ูโุชูุงูู ฺฉ ูุชุฏ ุบุฑููุฒูุงู ูุงุจู ูุบู ุจููุณู:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Foo</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
    {
        Console.WriteLine(i);
        <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
        cancellationToken.ThrowIfCancellationRequested();
    }
}
</code></pre>
<p>ููุช ูุฑุงุฎูุงููุฏู ุจุฎูุงูุฏ ุนููุงุช ุฑุง ูุบู ฺฉูุฏุ ูุชุฏ <code>Cancel</code> ุฑุง ุฑู <strong>cancellation token</strong> ูุฑุงุฎูุงู ูโฺฉูุฏ. ุงู ุจุงุนุซ ูโุดูุฏ <code>IsCancellationRequested</code> ุจุฑุงุจุฑ ุจุง true ุดูุฏ ู ูุชุฏ Foo ุจุง ฺฉ <strong>OperationCanceledException</strong> ูุชููู ุดูุฏ.</p>
<p>CLR ฺฉ ููุน ูุดุงุจู ุจู ูุงู <strong>CancellationToken</strong> ุฏุงุฑุฏุ ูู <strong>ูุชุฏ Cancel</strong> ูุฏุงุฑุฏุ ุงู ูุชุฏ ุฑู <strong>CancellationTokenSource</strong> ุงุฑุงุฆู ุดุฏู ุงุณุช. ุงู ุชูฺฉฺฉ ุจุงุนุซ ุงููุช ุจุดุชุฑ ูโุดูุฏ: ูุชุฏ ฺฉู ููุท ุฏุณุชุฑุณ ุจู CancellationToken ุฏุงุฑุฏุ ูโุชูุงูุฏ ูุบู ุฑุง ฺฺฉ ฺฉูุฏ ูู ุขู ุฑุง ุขุบุงุฒ ูฺฉูุฏ.</p>
<p>ุจุฑุง ฺฏุฑูุชู ฺฉ <strong>cancellation token</strong> ุงุจุชุฏุง ฺฉ <strong>CancellationTokenSource</strong> ุงุฌุงุฏ ูโฺฉูู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> cancelSource = <span class="hljs-keyword">new</span> CancellationTokenSource();
Task foo = Foo(cancelSource.Token);
...
cancelSource.Cancel();
</code></pre>
<p>ุงฺฉุซุฑ ูุชุฏูุง ุบุฑููุฒูุงู ุฏุฑ CLR ุงุฒ <strong>cancellation token</strong> ูพุดุชุจุงู ูโฺฉููุฏุ ุงุฒ ุฌููู <strong>Task.Delay</strong>. ุงฺฏุฑ ูุชุฏ Foo <strong>ุชูฺฉู</strong> ุฎูุฏ ุฑุง ุจู Delay ุจุฏูุฏุ Task ุจูุงูุงุตูู ูพุณ ุงุฒ ุฏุฑุฎูุงุณุช ูุบู ูุชููู ูโุดูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Foo</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
    {
        Console.WriteLine(i);
        <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>, cancellationToken);
    }
}
</code></pre>
<p>ุฏฺฏุฑ ูุงุฒ ุจู <code>ThrowIfCancellationRequested</code> ูุณุชุ ุฒุฑุง <strong>Task.Delay</strong> ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ูโุฏูุฏ. <strong>Cancellation tokens</strong> ุจู ุฎูุจ ุฏุฑ ุทูู call stack ููุชูู ูโุดููุฏ.</p>
<hr>
<h4>ฺฏุฒุงุฑุด ูพุดุฑูุช (Progress Reporting) ๐</h4>
<p>ฺฏุงู ูุงุฒู ุงุณุช ฺฉ ุนููุงุช ุบุฑููุฒูุงู <strong>ูพุดุฑูุช</strong> ุฎูุฏ ุฑุง ฺฏุฒุงุฑุด ุฏูุฏ. ฺฉ ุฑุงู ุณุงุฏู ุงุณุชูุงุฏู ุงุฒ <strong>Action delegate</strong> ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-function">Task <span class="hljs-title">Foo</span>(<span class="hljs-params">Action&lt;<span class="hljs-built_in">int</span>&gt; onProgressPercentChanged</span>)</span>
{
    <span class="hljs-keyword">return</span> Task.Run(() =&gt;
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++)
        {
            <span class="hljs-keyword">if</span> (i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>) onProgressPercentChanged(i / <span class="hljs-number">10</span>);
            <span class="hljs-comment">// ุงูุฌุงู ฺฉุงุฑ ฺฉู ุฒูุงูโุจุฑ ุงุณุช...</span>
        }
    });
}

Action&lt;<span class="hljs-built_in">int</span>&gt; progress = i =&gt; Console.WriteLine(i + <span class="hljs-string">&quot; %&quot;</span>);
<span class="hljs-keyword">await</span> Foo(progress);
</code></pre>
<p>ุงู ุฑูุด ุฏุฑ <strong>Console App</strong> ุฎูุจ ฺฉุงุฑ ูโฺฉูุฏุ ูู ุฏุฑ <strong>rich-client</strong> ูุดฺฉูุงุช <strong>thread-safety</strong> ุงุฌุงุฏ ูโฺฉูุฏุ ฺูู ูพุดุฑูุช ุงุฒ ฺฉ <strong>worker thread</strong> ฺฏุฒุงุฑุด ูโุดูุฏ.</p>
<p>CLR ฺฉ ุฑุงู ุญู ุจูุชุฑ ุงุฑุงุฆู ูโุฏูุฏ: <strong>IProgress<T></strong> ู ฺฉูุงุณ <strong>Progress<T></strong>. ุงู ฺฉูุงุณโูุง <strong>delegate</strong> ุฑุง ฺฉูพุณููู ูโฺฉููุฏ ุชุง ุงูพูฺฉุดูโูุง UI ุจุชูุงููุฏ ูพุดุฑูุช ุฑุง ุจู ุตูุฑุช ุงูู ุงุฒ ุทุฑู <strong>SynchronizationContext</strong> ฺฏุฒุงุฑุด ฺฉููุฏ.</p>
<pre class="hljs"><code><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IProgress</span>&lt;<span class="hljs-keyword">in</span> <span class="hljs-title">T</span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Report</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span></span>)</span>;
}
</code></pre>
<p>ุงุณุชูุงุฏู ุงุฒ IProgress<T> ุขุณุงู ุงุณุช:</p>
<pre class="hljs"><code><span class="hljs-function">Task <span class="hljs-title">Foo</span>(<span class="hljs-params">IProgress&lt;<span class="hljs-built_in">int</span>&gt; onProgressPercentChanged</span>)</span>
{
    <span class="hljs-keyword">return</span> Task.Run(() =&gt;
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++)
        {
            <span class="hljs-keyword">if</span> (i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>) onProgressPercentChanged.Report(i / <span class="hljs-number">10</span>);
            <span class="hljs-comment">// ุงูุฌุงู ฺฉุงุฑ ฺฉู ุฒูุงูโุจุฑ ุงุณุช...</span>
        }
    });
}

<span class="hljs-keyword">var</span> progress = <span class="hljs-keyword">new</span> Progress&lt;<span class="hljs-built_in">int</span>&gt;(i =&gt; Console.WriteLine(i + <span class="hljs-string">&quot; %&quot;</span>));
<span class="hljs-keyword">await</span> Foo(progress);
</code></pre>
<p>ฺฉูุงุณ <strong>Progress<T></strong> ููฺฏุงู ุงุฌุงุฏุ <strong>SynchronizationContext</strong> ุฑุง ุฐุฎุฑู ูโฺฉูุฏ. ููุช <strong>Report</strong> ูุฑุงุฎูุงู ุดูุฏุ delegate ุงุฒ ุทุฑู ููุงู context ุงุฌุฑุง ูโุดูุฏ.</p>
<hr>
<h4>ููุงุณู ุจุง Rx</h4>
<p>ุงฺฏุฑ ุจุง <strong>Rx</strong> ุขุดูุง ุจุงุดุฏุ ูุชูุฌู ูโุดูุฏ ฺฉู <strong>IProgress<T></strong> ููุฑุงู ุจุง <strong>Task</strong> ุฎุฑูุฌุ ูุฌููุนู ูุงุจูุช ูุดุงุจู <strong>IObserver<T></strong> ุฑุง ุงุฑุงุฆู ูโุฏูุฏ. ุชูุงูุช ุงู ุงุณุช ฺฉู Task ูโุชูุงูุฏ <strong>ููุฏุงุฑ ููุง</strong> ุจุฑฺฏุฑุฏุงูุฏุ ุฏุฑ ุญุงู ฺฉู IProgress<T> ููุงุฏุฑ ูุงู (ูุซูุงู ุฏุฑุตุฏ ุชฺฉูู ุง ุจุงุชโูุง ุฏุงูููุฏ ุดุฏู) ุฑุง ฺฏุฒุงุฑุด ูโฺฉูุฏ.</p>
<hr>
<h4>WinRT ู ฺฏุฒุงุฑุด ูพุดุฑูุช</h4>
<p>ุฏุฑ WinRTุ ูุชุฏูุง ุบุฑููุฒูุงู ฺฉู ูพุดุฑูุช ุฑุง ฺฏุฒุงุฑุด ูโุฏููุฏุ ุจู ุฌุง IProgress<T>ุ ฺฉ ุงุฒ ุงู ุฑุงุจุทโูุง ุฑุง ุจุฑูโฺฏุฑุฏุงููุฏ:</p>
<ul>
<li><code>IAsyncActionWithProgress&lt;TProgress&gt;</code></li>
<li><code>IAsyncOperationWithProgress&lt;TResult, TProgress&gt;</code></li>
</ul>
<p>ูุฑ ุฏู ุงุฒ <code>IAsyncInfo</code> ูุดุชู ุดุฏูโุงูุฏ. ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>AsTask</strong>ุ ูโุชูุงู ุขูโูุง ุฑุง ุจู Task ูุนููู ุจุง <strong>IProgress<T></strong> ุชุจุฏู ฺฉุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> progress = <span class="hljs-keyword">new</span> Progress&lt;<span class="hljs-built_in">int</span>&gt;(i =&gt; Console.WriteLine(i + <span class="hljs-string">&quot; %&quot;</span>));
CancellationToken cancelToken = ...
<span class="hljs-keyword">var</span> task = someWinRTobject.FooAsync().AsTask(cancelToken, progress);
</code></pre>
<p>ุงู ุฑูุด ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ุชุง ุงุฒ <strong>ุฑุงุจุทโูุง COM ูพฺุฏู</strong> ุตุฑูโูุธุฑ ฺฉูุฏ ู ุจู ุณุงุฏฺฏ ุงุฒ <strong>.NET API</strong> ุจุฑุง ูุบู ู ฺฏุฒุงุฑุด ูพุดุฑูุช ุงุณุชูุงุฏู ููุงุฏ.</p>
<h3>ุงูฺฏู ุบุฑููุฒูุงู ูุจุชู ุจุฑ Task (Task-Based Asynchronous Pattern โ TAP) โก</h3>
<p>ุฏุฑ .NET ุตุฏูุง ูุชุฏ ุบุฑููุฒูุงู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู <strong>Task</strong> ุง <strong>Task<TResult></strong> ุจุฑูโฺฏุฑุฏุงููุฏ ู ูโุชูุงูุฏ ุฑู ุขูโูุง <strong>await</strong> ฺฉูุฏ (ุจุดุชุฑ ูุฑุจูุท ุจู ุนููุงุช I/O). ุจุดุชุฑ ุงู ูุชุฏูุง ุญุฏุงูู ุชุง ุญุฏ ุงุฒ ุงูฺฏู ุจู ูุงู <strong>Task-Based Asynchronous Pattern (TAP)</strong> ูพุฑู ูโฺฉููุฏ ฺฉู ฺฉ <strong>ุณุงุฎุชุงุฑ ููุทู ู ุงุณุชุงูุฏุงุฑุฏ</strong> ุจุฑุง ฺฉุงุฑ ุจุง Taskูุง ุงุฑุงุฆู ูโุฏูุฏ. ฺฉ ูุชุฏ TAP ูุนูููุงู ูฺฺฏโูุง ุฒุฑ ุฑุง ุฏุงุฑุฏ:</p>
<ul>
<li>ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉ <strong>Task ุง Task<TResult> ูุนุงู (hot)</strong></li>
<li>ูุงู ุขู ุจุง ูพุณููุฏ <strong>Async</strong> ุฎุชู ูโุดูุฏ (ุจู ุฌุฒ ููุงุฑุฏ ุฎุงุต ูุซู task combinatorูุง)</li>
<li>ุฏุฑ ุตูุฑุช ูพุดุชุจุงู ุงุฒ ูุบู ุง ฺฏุฒุงุฑุด ูพุดุฑูุชุ <strong>overload</strong>ูุง ูโูพุฐุฑุฏ ฺฉู <strong>cancellation token</strong> ู/ุง <strong>IProgress<T></strong> ุฑุง ุฏุฑุงูุช ูโฺฉููุฏ</li>
<li>ุณุฑุน ุจู ูุฑุงุฎูุงููุฏู ุจุงุฒูโฺฏุฑุฏุฏ (ููุท ฺฉ ูุงุฒ ููุฒูุงู ฺฉูุชุงู ุฏุงุฑุฏ)</li>
<li>ุงฺฏุฑ ุนููุงุช I/O ูุญูุฑ ุจุงุดุฏุ ฺฉ Thread ุฑุง ุฏุฑฺฏุฑ ููโฺฉูุฏ</li>
</ul>
<p>ููุงูโุทูุฑ ฺฉู ุฏุฏูุ ููุดุชู ูุชุฏูุง TAP ุจุง <strong>async/await</strong> ุฏุฑ C# ุจุณุงุฑ ุณุงุฏู ุงุณุช.</p>
<hr>
<h3>ุชุฑฺฉุจโฺฉููุฏูโูุง Task (Task Combinators) ๐</h3>
<p>ฺฉ ุงุฒ ูุฒุงุง ุฏุงุดุชู ฺฉ ูพุฑูุชฺฉู ฺฉููุงุฎุช ุจุฑุง ูุชุฏูุง ุบุฑููุฒูุงู ุงู ุงุณุช ฺฉู ูโุชูุงู <strong>task combinator</strong> ููุดุช ู ุงุณุชูุงุฏู ฺฉุฑุฏโุนู ุชูุงุจุน ฺฉู ฺูุฏ Task ุฑุง ุจุง ูู ุชุฑฺฉุจ ูโฺฉููุฏุ ุจุฏูู ุชูุฌู ุจู ุงูฺฉู ูุฑ Task ุฏููุงู ฺู ฺฉุงุฑ ุงูุฌุงู ูโุฏูุฏ.</p>
<p>CLR ุฏู ุชุฑฺฉุจโฺฉููุฏู Task ุงุฑุงุฆู ูโุฏูุฏ: <strong>Task.WhenAny</strong> ู <strong>Task.WhenAll</strong>. ุจุฑุง ุชูุถุญ ุขูโูุงุ ูุฑุถ ูโฺฉูู ูุชุฏูุง ุฒุฑ ุชุนุฑู ุดุฏูโุงูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">Delay1</span>()</span> { <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>); <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; }
<span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">Delay2</span>()</span> { <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">2000</span>); <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>; }
<span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">Delay3</span>()</span> { <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">3000</span>); <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; }
</code></pre>
<hr>
<h4>Task.WhenAny ๐</h4>
<p><strong>Task.WhenAny</strong> ฺฉ Task ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ููุช <strong>ูุฑ ฺฉ ุงุฒ Taskูุง ฺฉุงูู ุดุฏ</strong>ุ ุชูุงู ูโุดูุฏ. ูุซุงู ุฒุฑ ูพุณ ุงุฒ ฑ ุซุงูู ุชฺฉูู ูโุดูุฏ:</p>
<pre class="hljs"><code>Task&lt;<span class="hljs-built_in">int</span>&gt; winningTask = <span class="hljs-keyword">await</span> Task.WhenAny(Delay1(), Delay2(), Delay3());
Console.WriteLine(<span class="hljs-string">&quot;Done&quot;</span>);
Console.WriteLine(winningTask.Result);   <span class="hljs-comment">// 1</span>
</code></pre>
<p>ุจูุชุฑ ุงุณุช <strong>winningTask</strong> ุฑุง ูุฒ await ฺฉูู ุชุง ูุฑฺฏููู Exception ุจุฏูู AggregateException ุจุงุฒูุดุงู ุดูุฏ:</p>
<pre class="hljs"><code>Console.WriteLine(<span class="hljs-keyword">await</span> winningTask);   <span class="hljs-comment">// 1</span>
</code></pre>
<p>ูโุชูุงู ุงู ุฑุง ุฏุฑ ฺฉ ุฎุท ูู ููุดุช:</p>
<pre class="hljs"><code><span class="hljs-built_in">int</span> answer = <span class="hljs-keyword">await</span> <span class="hljs-keyword">await</span> Task.WhenAny(Delay1(), Delay2(), Delay3());
</code></pre>
<p><strong>ฺฉุงุฑุจุฑุฏ:</strong> ุงุนูุงู <strong>Timeout</strong> ุง ูุบู ุฑู ุนููุงุช ฺฉู ูพุดุชุจุงู ููโฺฉููุฏ:</p>
<pre class="hljs"><code>Task&lt;<span class="hljs-built_in">string</span>&gt; task = SomeAsyncFunc();
Task winner = <span class="hljs-keyword">await</span> Task.WhenAny(task, Task.Delay(<span class="hljs-number">5000</span>));
<span class="hljs-keyword">if</span> (winner != task) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TimeoutException();
<span class="hljs-built_in">string</span> result = <span class="hljs-keyword">await</span> task;   <span class="hljs-comment">// ุจุงุฒฺฉุฑุฏู ูุชุฌู ู ูพุฑุชุงุจ ูุฌุฏุฏ</span>
</code></pre>
<hr>
<h4>Task.WhenAll ๐ฆ</h4>
<p><strong>Task.WhenAll</strong> ฺฉ Task ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ููุช <strong>ุชูุงู Taskูุง ุชฺฉูู ุดุฏูุฏ</strong>ุ ุชูุงู ูโุดูุฏ. ูุซุงู ุฒุฑ ูพุณ ุงุฒ ณ ุซุงูู ุชฺฉูู ูโุดูุฏ ู ุงูฺฏู <strong>fork/join</strong> ุฑุง ูุดุงู ูโุฏูุฏ:</p>
<pre class="hljs"><code><span class="hljs-keyword">await</span> Task.WhenAll(Delay1(), Delay2(), Delay3());
</code></pre>
<p>ุชูุงูุช ุจุง await ฺฉุฑุฏู Taskูุง ฺฉโฺฉ ุงู ุงุณุช ฺฉู ุงฺฏุฑ task1 ุจุง ุฎุทุง ููุงุฌู ุดูุฏุ ุฏฺฏุฑ task2 ู task3 ุงุฌุฑุง ููโุดููุฏ ู Exceptionูุง ุขูโูุง ูุงุฏุฏู ฺฏุฑูุชู ูโุดููุฏ. ุงูุง <strong>Task.WhenAll</strong> ููุชุธุฑ ูโูุงูุฏ ุชุง ููู Taskูุง ุชฺฉูู ุดููุฏ ู ุงฺฏุฑ ฺูุฏ ุฎุทุง ุฑุฎ ุฏูุฏุ ููู Exceptionูุง ุฏุฑ <strong>AggregateException</strong> ุชุฑฺฉุจ ูโุดููุฏ.</p>
<p>ุงุณุชูุงุฏู ุงุฒ Task<TResult> ุจุง WhenAll ูุชุฌูโุง ุงุฒ ููุน <strong>Task&lt;TResult[]&gt;</strong> ุจุฑูโฺฏุฑุฏุงูุฏ:</p>
<pre class="hljs"><code>Task&lt;<span class="hljs-built_in">int</span>&gt; task1 = Task.Run(() =&gt; <span class="hljs-number">1</span>);
Task&lt;<span class="hljs-built_in">int</span>&gt; task2 = Task.Run(() =&gt; <span class="hljs-number">2</span>);
<span class="hljs-built_in">int</span>[] results = <span class="hljs-keyword">await</span> Task.WhenAll(task1, task2);   <span class="hljs-comment">// {1, 2}</span>
</code></pre>
<p><strong>ูุซุงู ุนูู:</strong> ุฏุงูููุฏ ฺูุฏ URI ุจู ุตูุฑุช ููุงุฒ ู ุฌูุน ุทูู ฺฉู ูุญุชูุง:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">GetTotalSize</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] uris</span>)</span>
{
    IEnumerable&lt;Task&lt;<span class="hljs-built_in">int</span>&gt;&gt; downloadTasks = uris.Select(<span class="hljs-keyword">async</span> uri =&gt;
        (<span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> WebClient().DownloadDataTaskAsync(uri)).Length);
    <span class="hljs-built_in">int</span>[] contentLengths = <span class="hljs-keyword">await</span> Task.WhenAll(downloadTasks);
    <span class="hljs-keyword">return</span> contentLengths.Sum();
}
</code></pre>
<hr>
<h3>ุชุฑฺฉุจโฺฉููุฏูโูุง ุณูุงุฑุด ๐๏ธ</h3>
<p>ูโุชูุงู ุชุฑฺฉุจโฺฉููุฏู Task ุฎูุฏ ุฑุง ููุดุชุ ูุซูุงู ุจุฑุง await ฺฉุฑุฏู ฺฉ Task ุจุง <strong>Timeout</strong>:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">static</span> <span class="hljs-title">Task</span>&lt;<span class="hljs-title">TResult</span>&gt; <span class="hljs-title">WithTimeout</span>&lt;<span class="hljs-title">TResult</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">this</span> Task&lt;TResult&gt; task, TimeSpan timeout</span>)</span>
{
    <span class="hljs-keyword">var</span> cancelSource = <span class="hljs-keyword">new</span> CancellationTokenSource();
    <span class="hljs-keyword">var</span> delay = Task.Delay(timeout, cancelSource.Token);
    Task winner = <span class="hljs-keyword">await</span> Task.WhenAny(task, delay).ConfigureAwait(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (winner == task)
        cancelSource.Cancel();
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TimeoutException();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> task.ConfigureAwait(<span class="hljs-literal">false</span>);   <span class="hljs-comment">// ุจุงุฒฺฉุฑุฏู ูุชุฌู ู ูพุฑุชุงุจ ูุฌุฏุฏ</span>
}
</code></pre>
<p>ููฺูู ูโุชูุงู Task ุฑุง ุจุง <strong>CancellationToken</strong> ุชุฑฺฉ ฺฉุฑุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">Task</span>&lt;<span class="hljs-title">TResult</span>&gt; <span class="hljs-title">WithCancellation</span>&lt;<span class="hljs-title">TResult</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">this</span> Task&lt;TResult&gt; task, CancellationToken cancelToken</span>)</span>
{
    <span class="hljs-keyword">var</span> tcs = <span class="hljs-keyword">new</span> TaskCompletionSource&lt;TResult&gt;();
    <span class="hljs-keyword">var</span> reg = cancelToken.Register(() =&gt; tcs.TrySetCanceled());
    task.ContinueWith(ant =&gt; 
    {
        reg.Dispose();
        <span class="hljs-keyword">if</span> (ant.IsCanceled)
            tcs.TrySetCanceled();
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ant.IsFaulted)
            tcs.TrySetException(ant.Exception.InnerExceptions);
        <span class="hljs-keyword">else</span>
            tcs.TrySetResult(ant.Result);
    });
    <span class="hljs-keyword">return</span> tcs.Task;
}
</code></pre>
<p><strong>ูุฒุช:</strong> ูพฺุฏฺฏ ูุฑุจูุท ุจู concurrency ุงุฒ ููุทู ุงุตู ุจุฑูุงูู ุฌุฏุง ูโุดูุฏ ู ุฏุฑ ูุชุฏูุง ูุงุจู ุงุณุชูุงุฏู ูุฌุฏุฏ ูฺฏูุฏุงุฑ ูโุดูุฏ.</p>
<hr>
<h4>TaskCompletionSource ู ฺฉูุชุฑู ุฎุทุง</h4>
<p>ูโุชูุงู ุชุฑฺฉุจโฺฉููุฏูโุง ููุดุช ฺฉู ุดุจู <strong>WhenAll</strong> ุนูู ฺฉูุฏุ ุงูุง ุงฺฏุฑ ูุฑ Task ุฎุทุง ุฏูุฏุ Task ุญุงุตู ููุฑุงู ุฎุทุง ฺฉูุฏ:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">Task</span>&lt;<span class="hljs-title">TResult</span>[]&gt; <span class="hljs-title">WhenAllOrError</span>&lt;<span class="hljs-title">TResult</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">params</span> Task&lt;TResult&gt;[] tasks</span>)</span>
{
    <span class="hljs-keyword">var</span> killJoy = <span class="hljs-keyword">new</span> TaskCompletionSource&lt;TResult[]&gt;();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> task <span class="hljs-keyword">in</span> tasks)
        task.ContinueWith(ant =&gt;
        {
            <span class="hljs-keyword">if</span> (ant.IsCanceled) 
                killJoy.TrySetCanceled();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ant.IsFaulted)
                killJoy.TrySetException(ant.Exception.InnerExceptions);
        });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">await</span> Task.WhenAny(killJoy.Task, Task.WhenAll(tasks))
                           .ConfigureAwait(<span class="hljs-literal">false</span>);
}
</code></pre>
<hr>
<h3>ููู ุบุฑููุฒูุงู (Asynchronous Locking) ๐</h3>
<p>ุฏุฑ ุจุฎุด <strong>Asynchronous semaphores and locks</strong> (ุตูุญู 906) ุชูุถุญ ุฏุงุฏูโุงู ฺฉู ฺฺฏููู ูโุชูุงู ุจุง <strong>SemaphoreSlim</strong> ููู ุง ูุญุฏูุฏุช ููุฒูุงู ุฑุง ุจู ุตูุฑุช ุบุฑููุฒูุงู ุงุนูุงู ฺฉุฑุฏ.</p>
<h3>ุงูฺฏููุง ูุฏู ุบุฑููุฒูุงู (Obsolete Patterns) โณ</h3>
<p>ูุจู ุงุฒ ุธููุฑ <strong>Task</strong> ู <strong>async/await</strong>ุ ุฏุฑ .NET ุฑูุดโูุง ุฏฺฏุฑ ุจุฑุง ุจุฑูุงููโููุณ ุบุฑููุฒูุงู ูุฌูุฏ ุฏุงุดุช ฺฉู ุงูุฑูุฒู ุจู ูุฏุฑุช ููุฑุฏ ูุงุฒ ูุณุชูุฏ. ุฏู ุงูฺฏู ููู ุนุจุงุฑุชโุงูุฏ ุงุฒ <strong>APM</strong> ู <strong>EAP</strong>.</p>
<hr>
<h2>ฑ. ุงูฺฏู ุจุฑูุงููโููุณ ุบุฑููุฒูุงู (Asynchronous Programming Model โ APM) ๐๏ธ</h2>
<p>APM ูุฏูโุชุฑู ุงูฺฏู ุงุณุช ู ุจุฑ ุงุณุงุณ <em><em>ุฒูุฌ ูุชุฏูุง Begin</em>/End</em>** ู <strong>IAsyncResult</strong> ฺฉุงุฑ ูโฺฉูุฏ.</p>
<p>ูุซุงู ุจุง ฺฉูุงุณ <code>Stream</code> ุฏุฑ <strong><a href="http://System.IO">System.IO</a></strong>:</p>
<ul>
<li>ูุณุฎู ููุฒูุงู:</li>
</ul>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Read</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> size</span>)</span>;
</code></pre>
<ul>
<li>ูุณุฎู ุบุฑููุฒูุงู ูุจุชู ุจุฑ Task:</li>
</ul>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-title">ReadAsync</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> size</span>)</span>;
</code></pre>
<ul>
<li>ูุณุฎู APM:</li>
</ul>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> IAsyncResult <span class="hljs-title">BeginRead</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] buffer, <span class="hljs-built_in">int</span> offset, <span class="hljs-built_in">int</span> size,
                              AsyncCallback callback, <span class="hljs-built_in">object</span> state</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">EndRead</span>(<span class="hljs-params">IAsyncResult asyncResult</span>)</span>;
</code></pre>
<p><strong>ูุญูู ฺฉุงุฑ:</strong></p>
<ol>
<li>ูุฑุงุฎูุงู <code>BeginRead</code> ุนููุงุช ุฑุง ุดุฑูุน ูโฺฉูุฏ ู ฺฉ <strong>IAsyncResult</strong> ุจุฑูโฺฏุฑุฏุงูุฏ ฺฉู ูุงููุฏ ฺฉ <strong>ุชูฺฉู</strong> ุนูู ูโฺฉูุฏ.</li>
<li>ููุช ุนููุงุช ุชฺฉูู ุดุฏ ุง ุฎุทุง ุฏุงุฏุ <strong>AsyncCallback</strong> ูุฑุงุฎูุงู ูโุดูุฏ.</li>
<li>ุฏุฑ callbackุ <code>EndRead</code> ุตุฏุง ุฒุฏู ูโุดูุฏ ุชุง ููุฏุงุฑ ุจุงุฒฺฏุดุช ู Exception ุฏุฑ ุตูุฑุช ูุฌูุฏ ุงุฑุงุฆู ุดูุฏ.</li>
</ol>
<p><strong>ูพฺุฏฺฏ:</strong> ุงุณุชูุงุฏู ุงุฒ APM ุฏุดูุงุฑ ู ูพุงุฏูโุณุงุฒ ุขู ุญุช ุณุฎุชโุชุฑ ุงุณุช.</p>
<p><strong>ุฑุงู ุญู ูุฏุฑู:</strong> ุงุณุชูุงุฏู ุงุฒ <strong>Task.Factory.FromAsync</strong> ุจุฑุง ุชุจุฏู ุฒูุฌ ูุชุฏ APM ุจู Task:</p>
<pre class="hljs"><code>Task&lt;<span class="hljs-built_in">int</span>&gt; readChunk = Task&lt;<span class="hljs-built_in">int</span>&gt;.Factory.FromAsync(
    stream.BeginRead, stream.EndRead, buffer, <span class="hljs-number">0</span>, <span class="hljs-number">1000</span>, <span class="hljs-literal">null</span>);
</code></pre>
<hr>
<h2>ฒ. ุงูฺฏู ุบุฑููุฒูุงู ูุจุชู ุจุฑ ุฑูุฏุงุฏ (Event-Based Asynchronous Pattern โ EAP) ๐</h2>
<p>EAP ุฏุฑ ุณุงู ฒฐฐต ูุนุฑู ุดุฏ ุชุง ุฌุงฺฏุฒู ุณุงุฏูโุชุฑ ุจุฑุง APM ุจุงุดุฏุ ุจู ูฺู ุฏุฑ ุณูุงุฑููุง UI.</p>
<p><strong>ููููู ฺฉูุงุณ WebClient:</strong></p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">DownloadData</span>(<span class="hljs-params">Uri address</span>)</span>;           <span class="hljs-comment">// ูุณุฎู ููุฒูุงู</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DownloadDataAsync</span>(<span class="hljs-params">Uri address</span>)</span>;        <span class="hljs-comment">// ูุณุฎู ุบุฑููุฒูุงู</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DownloadDataAsync</span>(<span class="hljs-params">Uri address, <span class="hljs-built_in">object</span> userToken</span>)</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> DownloadDataCompletedEventHandler DownloadDataCompleted;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CancelAsync</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> userState</span>)</span>;         <span class="hljs-comment">// ูุบู ุนููุงุช</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsBusy { <span class="hljs-keyword">get</span>; }                        <span class="hljs-comment">// ูุถุนุช ุฏุฑ ุญุงู ุงุฌุฑุง</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> DownloadProgressChangedEventHandler DownloadProgressChanged;
</code></pre>
<p><strong>ูุญูู ฺฉุงุฑ:</strong></p>
<ul>
<li>ูุชุฏูุง <code>*Async</code> ุนููุงุช ุฑุง ุดุฑูุน ูโฺฉููุฏ.</li>
<li>ููุช ุนููุงุช ุชฺฉูู ุดุฏุ <strong>ุฑูุฏุงุฏ <code>*Completed</code></strong> ูุฑุงุฎูุงู ูโุดูุฏ ู ูุชุฌูุ Exception ุง ูุถุนุช ูุบู ุฑุง ุงุฑุงุฆู ูโุฏูุฏ.</li>
<li>ฺฏุฒุงุฑุด ูพุดุฑูุช ูโุชูุงูุฏ ุงุฒ ุทุฑู ุฑูุฏุงุฏ <code>DownloadProgressChanged</code> ุงูุฌุงู ุดูุฏ.</li>
<li>ุงฺฏุฑ <strong>SynchronizationContext</strong> ููุฌูุฏ ุจุงุดุฏุ ุฑูุฏุงุฏูุง ุจู ุตูุฑุช ุงูู ุจู thread UI ุงุฑุณุงู ูโุดููุฏ.</li>
</ul>
<p><strong>ูุดฺฉู:</strong> ูพุงุฏูโุณุงุฒ EAP ูุงุฒููุฏ ฺฉุฏ boilerplate ุฒุงุฏ ุงุณุช ู ุงูฺฏู ุจู ุณุฎุช ุชุฑฺฉุจโูพุฐุฑ ุงุณุช.</p>
<hr>
<h3>ณ. BackgroundWorker ๐๏ธ</h3>
<p>ฺฉูุงุณ <strong>BackgroundWorker</strong> ุฏุฑ <strong>System.ComponentModel</strong> ฺฉ ูพุงุฏูโุณุงุฒ ุนููู ุงุฒ EAP ุงุณุช ฺฉู ุจู ุจุฑูุงููโูุง rich-client ุงุฌุงุฒู ูโุฏูุฏ:</p>
<ul>
<li>ุงุฌุฑุง <strong>worker thread</strong> ุจุฑุง ุนููุงุช ุบุฑููุฒูุงู</li>
<li>ฺฏุฒุงุฑุด ุฏุฑุตุฏ ูพุดุฑูุช</li>
<li>ุงุทูุงุน ุงุฒ ุงุชูุงู ุนููุงุช ุง ุฎุทุง</li>
</ul>
<p>ูุซุงู:</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">new</span> BackgroundWorker { WorkerSupportsCancellation = <span class="hljs-literal">true</span> };

worker.DoWork += (sender, <span class="hljs-keyword">args</span>) =&gt; 
{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">args</span>.Cancel) <span class="hljs-keyword">return</span>;
    Thread.Sleep(<span class="hljs-number">1000</span>); 
    <span class="hljs-keyword">args</span>.Result = <span class="hljs-number">123</span>;
};

worker.RunWorkerCompleted += (sender, <span class="hljs-keyword">args</span>) =&gt;
{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">args</span>.Cancelled)
        Console.WriteLine(<span class="hljs-string">&quot;Cancelled&quot;</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">args</span>.Error != <span class="hljs-literal">null</span>)
        Console.WriteLine(<span class="hljs-string">&quot;Error: &quot;</span> + <span class="hljs-keyword">args</span>.Error.Message);
    <span class="hljs-keyword">else</span>
        Console.WriteLine(<span class="hljs-string">&quot;Result is: &quot;</span> + <span class="hljs-keyword">args</span>.Result);
};

worker.RunWorkerAsync();   <span class="hljs-comment">// ุดุฑูุน ุนููุงุช ู capture synchronization context</span>
</code></pre>
<p><strong>ูฺฺฏโูุง:</strong></p>
<ul>
<li><code>DoWork</code> ุฑู <strong>worker thread</strong> ุงุฌุฑุง ูโุดูุฏ.</li>
<li><code>RunWorkerCompleted</code> ุฑู <strong>UI thread</strong> ุงุฌุฑุง ูโุดูุฏ (ุงฺฏุฑ SynchronizationContext ููุฌูุฏ ุจุงุดุฏ).</li>
<li>ุจุฑุง ุจูโุฑูุฒุฑุณุงู UI ุฏุฑ <code>DoWork</code> ุจุงุฏ ุงุฒ <code>Dispatcher.BeginInvoke</code> ุงุณุชูุงุฏู ุดูุฏ.</li>
</ul>
<hr>
<p>๐ <strong>ุฌูุนโุจูุฏ:</strong></p>
<ul>
<li><strong>APM ู EAP</strong> ุงูฺฏููุง ูุฏู ูุณุชูุฏ ู ุงูุฑูุฒู ุจู ูุฏุฑุช ููุฑุฏ ุงุณุชูุงุฏูโุงูุฏ.</li>
<li><strong>TAP (Task + async/await)</strong> ุฌุงฺฏุฒู ูุฏุฑูุ ุณุงุฏู ู ุงูุนุทุงูโูพุฐุฑ ุงุณุช ู ุชูุฑุจุง ููู ูุชุฏูุง ุฌุฏุฏ .NET ุงุฒ ุขู ุงุณุชูุงุฏู ูโฺฉููุฏ.</li>
</ul>

  </main>

  <!-- ููุชุฑ ูุดุชุฑฺฉ -->
  <footer class="footer">
    <div class="container">
      <p>
        <img src="/Gitab/icone/copyright.svg" alt="ฺฉูพโุฑุงุช" width="14" height="14"
             style="vertical-align:middle;margin-inline:4px">
        <span id="y"></span> Gitab โ ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู
      </p>
    </div>
  </footer>

  <!-- ุณุงู ู ุงุณฺฉุฑูพุช ุชุบุฑ ุชู -->
  <script>
  (() => {
    const root = document.documentElement;
    const btn = document.getElementById('themeToggle');
    const KEY = 'gitab-theme';
    const media = window.matchMedia('(prefers-color-scheme: dark)');
    const getEffective = s => (s === 'auto' ? (media.matches ? 'dark' : 'light') : s);

    function updateTheme(s) {
      root.setAttribute('data-theme', s);
      const mode = getEffective(s);
      root.dataset.colorMode = mode;
      btn.dataset.icon = mode === 'dark' ? 'moon' : 'sun';
    }

    let saved = localStorage.getItem(KEY) || 'auto';
    updateTheme(saved);

    btn.addEventListener('click', () => {
      const current = localStorage.getItem(KEY) || 'auto';
      const next = current === 'auto' ? 'dark' : current === 'dark' ? 'light' : 'auto';
      localStorage.setItem(KEY, next);
      updateTheme(next);
    });

    media.addEventListener('change', () => {
      if ((localStorage.getItem(KEY) || 'auto') === 'auto') updateTheme('auto');
    });

    document.addEventListener('DOMContentLoaded', () => {
      updateTheme(localStorage.getItem(KEY) || 'auto');
    });
  })();
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>

  <script>
  document.querySelectorAll('pre code').forEach(block => {
    const btn = document.createElement('button');
    btn.className = 'copy-btn';

    const icon = document.createElement('img');
    icon.src = "/Gitab/icone/copy.svg";
    icon.alt = 'Copy';
    btn.appendChild(icon);

    block.parentNode.insertBefore(btn, block);

    btn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(block.textContent);
      btn.classList.add('copied');
      setTimeout(() => btn.classList.remove('copied'), 1500);
    });
  });
  </script>

  <script>
  document.body.dataset.page = window.location.pathname;

  const menuBtn = document.querySelector(".menu-toggle");
  const nav = document.querySelector(".nav");

  if (menuBtn && nav) {
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      nav.classList.toggle("show");
    });

    document.addEventListener("click", (e) => {
      const clickedInsideNav = nav.contains(e.target);
      const clickedMenuButton = menuBtn.contains(e.target);
      if (!clickedInsideNav && !clickedMenuButton) {
        nav.classList.remove("show");
      }
    });
  }
  </script>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>
</body>
</html>
