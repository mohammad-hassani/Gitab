<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gitab | ฺฉุชุงุจุฎุงููู ุชุฑุฌููโูุง ุฏุงุชโูุช ู ุณ ุดุงุฑูพ</title>
  <meta name="description" content="ุชุฑุฌููโูุง ูุงุฑุณ ฺฉุชุงุจโูุง ูู โ ุณุฑุนุ ูููุงู ู ูุงุจู ุงุชฺฉุง.">
  <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
  <!-- ูุฏุฑ ูุดุชุฑฺฉ -->
  <header class="header">
    <div class="container nav-wrap">
      <a class="brand" href="/">
        <img src="/icone/logo.svg" alt="Gitab" width="28" height="28">
        <span>Gitab</span>
      </a>

      <nav class="nav">
        <a href="/">ุฎุงูู</a>
        <a href="/books/list-books">ฺฉุชุงุจโูุง</a>
        <a href="#">ููฺฉุงุฑ</a>
        <a href="#">ุฏุฑุจุงุฑูโูุง</a>
      </nav>

     <div class="nav-actions">
  <button id="themeToggle" class="icon-btn theme-btn" aria-label="ุชุบุฑ ุญุงูุช">
    <img class="icon-sun" src="/icone/sun.svg" alt="ุฑูุดู">
    <img class="icon-moon" src="/icone/moon.svg" alt="ุชุงุฑฺฉ">
  </button>

  <a class="icon-btn" href="https://github.com/hheydarian/Gitab" target="_blank" title="GitHub">
    <img src="/icone/github.svg" alt="GitHub">
  </a>
</div>

  </header>

  <!-- ูุญุชูุง ุตูุญู -->
  <main class="site-main">
    <h1>ูุตู ุฏูุงุฒุฏูู: ูุฏุฑุช Disposal ู Garbage Collection</h1>
<p>ุจุฑุฎ ุงุฒ ุงุดุงุก ูุงุฒููุฏ ฺฉุฏูุง ูุฎุตูุต ุจุฑุง <strong>ุฌูุนโฺฉุฑุฏู (tear-down)</strong> ูุณุชูุฏ ุชุง ููุงุจุน ูุซู ูุงูโูุง ุจุงุฒุ ูููโูุง (locks)ุ ููุฏูโูุง ุณุณุชูโุนุงูู ู ุงุดุงุก <strong>unmanaged</strong> ุขุฒุงุฏ ุจุดู. ุฏุฑ ุงุตุทูุงุญ ุฏุงุชโูุชุ ุจู ุงู ฺฉุงุฑ <strong>Disposal</strong> ฺฏูุชู ูโุดู ู ุงุฒ ุทุฑู ุงูุชุฑูุณ <strong>IDisposable</strong> ูพุดุชุจุงู ูโุดู.</p>
<p>ููฺูู ุญุงูุธู ูุฏุฑุชโุดุฏู (Managed Memory) ฺฉู ุชูุณุท ุงุดุงุก ุงุณุชูุงุฏูโูุดุฏู ุงุดุบุงู ุดุฏูุ ุจุงุฏ ุฏุฑ ฺฉ ููุทู ุขุฒุงุฏ ุจุดู. ุงู ฺฉุงุฑ <strong>Garbage Collection</strong> ูุงู ุฏุงุฑู ู ุชูุณุท <strong>CLR</strong> ุงูุฌุงู ูโุดู.</p>
<p>ุชูุงูุช Disposal ู Garbage Collection ุฏุฑ ุงูู ฺฉู:</p>
<ul>
<li><strong>Disposal</strong> ูุนูููุงู ุจูโุตูุฑุช ุตุฑุญ ู ุชูุณุท ุจุฑูุงููโููุณ ุงูุฌุงู ูโุดู. ๐งโ๐ป</li>
<li><strong>Garbage Collection</strong> ฺฉุงููุงู ุฎูุฏฺฉุงุฑ ูุณุช ู ุชูุณุท CLR ูุฏุฑุช ูโุดู. โ๏ธ</li>
</ul>
<p>ุจู ุนุจุงุฑุช ุฏฺฏูุ ุขุฒุงุฏ ฺฉุฑุฏู ฺุฒูุง ูุซู <strong>file handles</strong>ุ <strong>locks</strong> ู ููุงุจุน ุณุณุชูโุนุงูู ุจุฑ ุนูุฏูโ ุจุฑูุงููโููุณ ูุณุชุ ุฏุฑ ุญุงู ฺฉู ุขุฒุงุฏุณุงุฒ ุญุงูุธู ุฑู CLR ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุฏู.</p>
<p>ุงู ูุตู ุจู ูุฑ ุฏู ููุถูุน <strong>Disposal</strong> ู <strong>Garbage Collection</strong> ูโูพุฑุฏุงุฒู ู ููฺูู <strong>Finalizer</strong>โูุง ุณโุดุงุฑูพ ู ุงูฺฏู (Pattern) ูุฑุชุจุท ุฑู ุชูุถุญ ูโุฏู ฺฉู ูโุชููู ููุด ูพุดุชุจุงู ุจุฑุง Disposal ุฏุงุดุชู ุจุงุดู. ุฏุฑ ููุงุชุ ุจู ุฌุฒุฆุงุช <strong>Garbage Collector</strong> ู ุณุงุฑ ฺฏุฒููโูุง ูุฏุฑุช ุญุงูุธู ุฎูุงูู ูพุฑุฏุงุฎุช.</p>
<hr>
<h2>โป๏ธ IDisposableุ Dispose ู Close</h2>
<p>ุฏุงุชโูุช ฺฉ ุงูุชุฑูุณ ุฎุงุต ุจุฑุง ุชุงูพโูุง ฺฉู ูุงุฒููุฏ ูุชุฏ tear-down ูุณุชู ุชุนุฑู ฺฉุฑุฏู:</p>
<pre><code class="language-csharp">public interface IDisposable
{
  void Dispose();
}
</code></pre>
<p>ุณโุดุงุฑูพ ุฏุณุชูุฑ <strong>using</strong> ุฑู ุจูโุนููุงู ฺฉ ูุงูโุจูุฑ ูุญู (syntactic shortcut) ูุฑุงูู ฺฉุฑุฏู ุชุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ูุชุฏ <strong>Dispose</strong> ุฑู ุงุดุงุฆ ฺฉู ุงุฒ <strong>IDisposable</strong> ูพุฑู ูโฺฉูู ูุฑุงุฎูุงู ุจุดู. ุงู ฺฉุงุฑ ุฏุฑ ูพุดุชโุตุญูู ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ุจูุงฺฉ <strong>try/finally</strong> ุงูุฌุงู ูโุดู:</p>
<pre><code class="language-csharp">using (FileStream fs = new FileStream(&quot;myFile.txt&quot;, FileMode.Open))
{
  // ... Write to the file ...
}
</code></pre>
<p>ฺฉุงููพุงูุฑ ุงู ุฑู ุจู ฺฉุฏ ุฒุฑ ุชุจุฏู ูโฺฉูู:</p>
<pre><code class="language-csharp">FileStream fs = new FileStream(&quot;myFile.txt&quot;, FileMode.Open);
try
{
  // ... Write to the file ...
}
finally
{
  if (fs != null) ((IDisposable)fs).Dispose();
}
</code></pre>
<p>ุจูุงฺฉ <strong>finally</strong> ุชุถูู ูโฺฉูู ฺฉู ูุชุฏ <strong>Dispose</strong> ุญุช ุฏุฑ ุตูุฑุช ฺฉู <strong>Exception</strong> ุฑุฎ ุจุฏู ุง ฺฉุฏ ุฒูุฏุชุฑ ุงุฒ ุจูุงฺฉ ุฎุงุฑุฌ ุจุดูุ ุญุชูุงู ูุฑุงุฎูุงู ุจุดู.</p>
<p>ุจูโุทูุฑ ูุดุงุจูุ ููุดุชู ฺฉุฏ ุจู ุดฺฉู ุฒุฑ ุชุถูู ูโฺฉูู ฺฉู <strong>Dispose</strong> ุจูโูุญุถ ุฎุฑูุฌ <strong>fs</strong> ุงุฒ ูุญุฏูุฏูโ (scope) ุฎูุฏุด ุงูุฌุงู ุจุดู:</p>
<pre><code class="language-csharp">using FileStream fs = new FileStream(&quot;myFile.txt&quot;, FileMode.Open);
// ... Write to the file ...
</code></pre>
<p>ุฏุฑ ุณูุงุฑููุง ุณุงุฏูุ ููุดุชู ฺฉ ุชุงูพ disposable ููุท ูุงุฒููุฏ ูพุงุฏูโุณุงุฒ <strong>IDisposable</strong> ู ููุดุชู ูุชุฏ <strong>Dispose</strong> ูุณุช:</p>
<pre><code class="language-csharp">sealed class Demo : IDisposable
{
  public void Dispose()
  {
    // Perform cleanup / tear-down.
    ...
  }
}
</code></pre>
<p>ุงู ุงูฺฏู ุจุฑุง ููุงุฑุฏ ุณุงุฏู ู ฺฉูุงุณโูุง <strong>sealed</strong> (ุบุฑูุงุจู ุงุฑุซโุจุฑ) ุฎู ุฎูุจ ุนูู ูโฺฉูู. ุฏุฑ ุจุฎุด ยซCalling Dispose from a Finalizerยป (ุตูุญู ตนฐ) ฺฉ ุงูฺฏู ูพุดุฑูุชูโุชุฑ ุชูุถุญ ุฏุงุฏู ูโุดู ฺฉู ูโุชููู ุจุฑุง ูุตุฑูโฺฉููุฏฺฏุงู ฺฉู <strong>Dispose</strong> ุฑู ูุฑุงููุด ูโฺฉููุ ููุด ูพุดุชุจุงู ุฏุงุดุชู ุจุงุดู.</p>
<p>ุจุฑุง ุชุงูพโูุง <strong>unsealed</strong> (ูุงุจู ุงุฑุซโุจุฑ)ุ ุจูุชุฑู ุงุฒ ูููู ุงุจุชุฏุง ุงุฒ ุงู ุงูฺฏู ูพุดุฑูุชูโุชุฑ ูพุฑู ุจุดูุ ฺูู ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุงฺฏู ุฒุฑฺฉูุงุณ ุจุฎูุงุฏ ฺูู ูุงุจูุช ุงุถุงูู ฺฉููุ ุงูุถุงุน ุฎู ูพฺุฏู ูโุดู.</p>
<hr>
<h2>๐ ููุงูู ุงุณุชุงูุฏุงุฑุฏ Disposal</h2>
<p>ุฏุงุชโูุช ฺฉ ูุฌููุนูโ ุบุฑุฑุณู (de facto) ุงุฒ ููุงูู ุจุฑุง ููุทู Disposal ุฏุงุฑู. ุงู ููุงูู ูุณุชููุงู ุฏุฑ ุฏุงุชโูุช ุง ุฒุจุงู C# ฺฉุฏููุณ ูุดุฏูุ ุงูุง ูุฏูโุดูู ุงุฌุงุฏ ฺฉ <strong>ูพุฑูุชฺฉู ุณุงุฒฺฏุงุฑ ุจุฑุง ูุตุฑูโฺฉููุฏฺฏุงู</strong> ูุณุช. ููุงูู ุนุจุงุฑุชโุงูุฏ ุงุฒ:</p>
<p>ฑ. ุจุนุฏ ุงุฒ ุงูฺฉู ฺฉ ุดุก Dispose ุดุฏุ ุฏฺฏู ูุงุจู ุงุณุชูุงุฏู ูุณุช. ููโุดู ุฏูุจุงุฑู ูุนุงูุด ฺฉุฑุฏ ู ูุฑฺฏููู ูุฑุงุฎูุงู ูุชุฏ ุง property (ุจูโุฌุฒ <strong>Dispose</strong>) ุจุงุนุซ ูพุฑุชุงุจ ุดุฏู <strong>ObjectDisposedException</strong> ูโุดู.
ฒ. ูุฑุงุฎูุงู ฺูุฏุจุงุฑูโ ูุชุฏ <strong>Dispose</strong> ุฑู ฺฉ ุดุก ูฺ ุฎุทุง ุงุฌุงุฏ ููโฺฉูู.
ณ. ุงฺฏุฑ ฺฉ ุดุก disposable ุจูโูุงู <strong>x</strong> ูุงูฺฉ ฺฉ ุดุก disposable ุฏฺฏู ุจูโูุงู <strong>y</strong> ุจุงุดูุ ูุชุฏ <strong>Dispose</strong> ุดุก <strong>x</strong> ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ูุชุฏ <strong>Dispose</strong> ุดุก <strong>y</strong> ุฑู ูุฑุงุฎูุงู ูโฺฉููโูฺฏุฑ ุงูฺฉู ุฎูุงู ุงู ููุถูุน ูุดุฎุต ุดุฏู ุจุงุดู.</p>
<p>ุงู ููุงูู ููฺฏุงู ููุดุชู ุชุงูพโูุง ุฌุฏุฏ ูู ููุฏ ูุณุชูุ ูุฑฺูุฏ <strong>ุงุฌุจุงุฑ</strong> ูุณุชู. ฺุฒ ุฌูู ุดูุง ุฑู ุจุฑุง ููุดุชู ูุชุฏ ูุซู ยซUndisposeยป ููโฺฏุฑูโุงูุจุชู ุงุญุชูุงูุงู ุจุง ูุงฺฉูุด ููู ููฺฉุงุฑุงูุชูู ุฑูุจูโุฑู ุฎูุงูุฏ ุดุฏ! ๐</p>
<p>ุทุจู ูุงููู ุณููุ ฺฉ <strong>container object</strong> ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุงุดุงุก ูุฑุฒูุฏ ุฎูุฏุด ุฑู Dispose ูโฺฉูู.</p>
<ul>
<li>ูุซุงู ุฎูุจ ุงู ููุถูุน ฺฉูุชุฑูโูุง ฺฉุงูุชูุฑ ุฏุฑ <strong>Windows Forms</strong> ูุซู <strong>Form</strong> ุง <strong>Panel</strong> ูุณุชู. ููุช ุงู ฺฉูุชุฑูโูุง ุจุณุชู ุง Dispose ูโุดูุ ูููโ ฺฉูุชุฑูโูุง ูุฑุฒูุฏ ูู ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ Dispose ูโุดู.</li>
<li>ูุซุงู ุฏฺฏูุ ุฒูุงู ูุณุช ฺฉู ฺฉ <strong>FileStream</strong> ุฑู ุฏุงุฎู ฺฉ <strong>DeflateStream</strong> ูโูพฺู. Dispose ฺฉุฑุฏู <strong>DeflateStream</strong> ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ <strong>FileStream</strong> ุฑู ูู Dispose ูโฺฉููโูฺฏุฑ ุงูฺฉู ุฎูุงู ุงู ููุถูุน ุฏุฑ ุณุงุฒูุฏู (constructor) ูุดุฎุต ุดุฏู ุจุงุดู.</li>
</ul>
<hr>
<h2>๐ Close ู Stop</h2>
<p>ุจุฑุฎ ุชุงูพโูุง ุนูุงูู ุจุฑ ูุชุฏ <strong>Dispose</strong>ุ ูุชุฏ ุจูโูุงู <strong>Close</strong> ูู ุฏุงุฑู. ฺฉุชุงุจุฎุงููโ ุงุตู ุฏุงุชโูุช (BCL) ุฏุฑ ููุฑุฏ ูุนูุง ุฏูู ูุชุฏ Close ฺฉุงููุงู ุณุงุฒฺฏุงุฑ ูุณุชุ ุงูุง ุชูุฑุจุงู ููุดู ฺฉ ุงุฒ ุงู ุฏู ุญุงูุช ูุณุช:</p>
<ul>
<li>ุงุฒ ูุธุฑ ฺฉุงุฑฺฉุฑุฏ ฺฉุงููุงู ุจุฑุงุจุฑ ุจุง <strong>Dispose</strong>.</li>
<li>ุฒุฑูุฌููุนูโุง ุงุฒ ฺฉุงุฑฺฉุฑุฏ <strong>Dispose</strong>.</li>
</ul>
<p>ูุซุงู ุญุงูุช ุฏูู <strong>IDbConnection</strong> ูุณุช:</p>
<ul>
<li>ฺฉ connection ฺฉู ุจุณุชู (Closed) ุดุฏู ูโุชููู ุฏูุจุงุฑู ุจุงุฒ ุจุดู (Re-Opened).</li>
<li>ุงูุง connection ฺฉู Dispose ุดุฏู ุจุงุดู ุฏฺฏู ููโุชููู.</li>
</ul>
<p>ูุซุงู ุฏฺฏู ฺฉ <strong>Windows Form</strong> ูุณุช ฺฉู ุจุง <strong>ShowDialog</strong> ูุนุงู ุดุฏู:</p>
<ul>
<li>ูุฑุงุฎูุงู <strong>Close</strong> ููุท ูุฑู ุฑู ูุฎู ูโฺฉูู.</li>
<li>ุงูุง ูุฑุงุฎูุงู <strong>Dispose</strong> ููุงุจุนุด ุฑู ูู ุขุฒุงุฏ ูโฺฉูู.</li>
</ul>
<p>ุจุฑุฎ ฺฉูุงุณโูุง ูุชุฏ ุจูโูุงู <strong>Stop</strong> ุชุนุฑู ฺฉุฑุฏู (ูุซู <strong>Timer</strong> ุง <strong>HttpListener</strong>).</p>
<ul>
<li>ูุชุฏ <strong>Stop</strong> ููฺฉูู ูุซู <strong>Dispose</strong> ููุงุจุน unmanaged ุฑู ุขุฒุงุฏ ฺฉููุ</li>
<li>ุงูุง ุจุฑ ุฎูุงู Disposeุ ุงุฌุงุฒูโ <strong>ุดุฑูุน ูุฌุฏุฏ (Restarting)</strong> ุฑู ูโุฏู.</li>
</ul>
<h2>๐๏ธ ฺู ุฒูุงู ุจุงุฏ Dispose ฺฉููุ</h2>
<p>ฺฉ ูุงููู ุงูู (ุฏุฑ ุชูุฑุจุงู ูููโ ููุงุฑุฏ) ุงูู ฺฉู:
๐ <strong>ยซุงฺฏุฑ ุดฺฉ ุฏุงุฑุ Dispose ฺฉู.ยป</strong></p>
<p>ุงุดุงุฆ ฺฉู ฺฉ <strong>unmanaged resource handle</strong> ุฑู ุฏุฑ ุฎูุฏุดูู ูฺฏู ูโุฏุงุฑูุ ุชูุฑุจุงู ููุดู ูุงุฒููุฏ Dispose ูุณุชู ุชุง ุงูู ููุฏู ุขุฒุงุฏ ุจุดู. ูููููโูุง ุดุงูู:</p>
<ul>
<li><strong>File ุง Network Stream</strong>โูุง</li>
<li><strong>Network Socket</strong>โูุง</li>
<li>ฺฉูุชุฑูโูุง <strong>Windows Forms</strong></li>
<li>ุงุจุฒุงุฑูุง <strong>GDI+</strong> ูุซู <strong>pen</strong>ุ <strong>brush</strong> ู <strong>bitmap</strong></li>
</ul>
<p>ุงุฒ ุทุฑู ุฏฺฏูุ ุงฺฏู ฺฉ ุชุงูพ <strong>disposable</strong> ุจุงุดูุ ูุนูููุงู (ุงูุง ูู ููุดู) ุจูโุทูุฑ ูุณุชูู ุง ุบุฑูุณุชูู ฺฉ <strong>unmanaged handle</strong> ุฑู ูุฑุฌุนโุฏู ูโฺฉูู. ุฏููุด ุงูู ฺฉู unmanaged handleูุง ุฏุฑูุงุฒูโุง ุจู ยซุฏูุง ุจุฑููยป ูุซู ููุงุจุน ุณุณุชูโุนุงููุ ุงุชุตุงูโูุง ุดุจฺฉู ู ูููโูุง ุฏุชุงุจุณ ูุณุชูโุฑุงู ุงุตูโุง ฺฉู ุงุดุงุก ูโุชููู ุฏุฑ ุตูุฑุช ุฑูุง ุดุฏู ูุงุฏุฑุณุชุ ุจุฑูู ุงุฒ ุฎูุฏุดูู ุฏุฑุฏุณุฑ ุงุฌุงุฏ ฺฉูู. โ๏ธ</p>
<hr>
<h3>๐ ุณู ุณูุงุฑู ุนุฏู ูุงุฒ ุจู Dispose</h3>
<p>ุงูุจุชู ุณู ุญุงูุช ูุณุช ฺฉู ูุจุงุฏ Dispose ุงูุฌุงู ุจุดู:</p>
<p>ฑ. ุฒูุงู ฺฉู ุดูุง <strong>ูุงูฺฉ ุดุก ูุณุชุฏ</strong>โูุซูุงู ููุช ฺฉ ุดุก ูุดุชุฑฺฉ ุฑู ุงุฒ ุทุฑู ฺฉ <strong>static field ุง property</strong> ูโฺฏุฑุฏ.
ฒ. ุฒูุงู ฺฉู ูุชุฏ <strong>Dispose</strong> ุดุก ฺฉุงุฑ ุงูุฌุงู ูโุฏู ฺฉู ุดูุง ููโุฎูุงุฏ.
ณ. ุฒูุงู ฺฉู ูุชุฏ <strong>Dispose</strong> ุจุฑุง ุดุก <strong>ุงุตูุงู ุทุฑุงุญ ูุดุฏู</strong> ู Dispose ฺฉุฑุฏู ุงูู ููุท ูพฺุฏฺฏ ุบุฑุถุฑูุฑ ุจู ุจุฑูุงูู ุงุถุงูู ูโฺฉูู.</p>
<hr>
<h3>๐ต ุฏุณุชู ุงูู: ููุงุฑุฏ ูุงุฏุฑ</h3>
<p>ุงู ุญุงูุช ุฎู ฺฉู ูพุด ูุงุฏ. ูููููโูุง ุงุตู ุฏุฑ ูุถุง ูุงู <strong>System.Drawing</strong> ุฏุฏู ูโุดู:</p>
<ul>
<li>ุงุดุงุก GDI+ ฺฉู ุงุฒ ุทุฑู <strong>static field ุง property</strong> ุจูโุฏุณุช ูุงู (ูุซู <strong>Brushes.Blue</strong>) ูุฑฺฏุฒ ูุจุงุฏ Dispose ุจุดูุ ฺูู ูููู ููููู ุฏุฑ ุชูุงู ุทูู ุนูุฑ ุจุฑูุงูู ุงุณุชูุงุฏู ูโุดู.</li>
<li>ุงูุง ูููููโูุง ฺฉู ุงุฒ ุทุฑู <strong>constructor</strong> ุณุงุฎุชู ูโุดู (ูุซู <strong>new SolidBrush</strong>) ุง ูููููโูุง ฺฉู ุงุฒ ุทุฑู <strong>static method</strong> ูุซู <strong>Font.FromHdc</strong> ุจูโุฏุณุช ูุงูุ ุจุงุฏ Dispose ุจุดู.</li>
</ul>
<hr>
<h3>๐ ุฏุณุชู ุฏูู: ููุงุฑุฏ ุฑุงุฌโุชุฑ</h3>
<p>ุงู ุฏุณุชู ุฎู ุจุดุชุฑ ุฏุฏู ูโุดู. ูููููโูุง ุฎูุจุด ุฏุฑ ูุถุง ูุงูโูุง <strong>System.IO</strong> ู <strong>System.Data</strong> ูุณุชู.</p>
<div align="center">
<p><img src="../../../assets/image/12/Table-12-1.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h2>๐๏ธ MemoryStream ู ุฏุณุชูโ ุณูู ุงุฒ ุนุฏู ูุงุฒ ุจู Dispose</h2>
<p>ูุชุฏ <strong>Dispose</strong> ุฏุฑ ฺฉูุงุณ <strong>MemoryStream</strong> ููุท ุดุก ุฑู ุบุฑูุนุงู ูโฺฉููุ ูฺ ุนููุงุช ููู ุจุฑุง ูพุงฺฉโุณุงุฒ ุงูุฌุงู ููโุฏู ฺูู MemoryStream ูฺ <strong>unmanaged handle</strong> ุง ููุจุน ูุดุงุจู ุฏุฑ ุงุฎุชุงุฑ ูุฏุงุฑู.</p>
<p>ุฏุณุชูโ ุณูู ุดุงูู ฺฉูุงุณโูุง ูุซู <strong>StringReader</strong> ู <strong>StringWriter</strong> ูโุดู. ุงู ุชุงูพโูุง ุจูโุฎุงุทุฑ <strong>base class</strong> ุฎูุฏุดูู disposable ูุณุชูุ ูู ุจู ุงู ุฏูู ฺฉู ูุงูุนุงู ูุงุฒููุฏ ูพุงฺฉโุณุงุฒ ุญุงุช ุจุงุดู.</p>
<ul>
<li>ุงฺฏู ฺูู ุดุฆ ุฑู ููุท ุฏุงุฎู ฺฉ ูุชุฏ ุจุณุงุฒุฏ ู ุงุฒุด ุงุณุชูุงุฏู ฺฉูุฏุ ูพฺุฏู ุงูู ุฏุงุฎู ฺฉ ุจูุงฺฉ <strong>using</strong> ฺฉุงุฑ ุณุฎุช ูุณุช.</li>
<li>ุงูุง ุงฺฏู ุนูุฑ ุงูู ุดุก ุทููุงูโุชุฑ ุจุงุดูุ ูุฏุฑุช ุงูฺฉู ฺู ุฒูุงู ุฏฺฏู ุงุณุชูุงุฏู ููโุดู ู Dispose ฺฉุฑุฏูุดุ ููุท ูพฺุฏฺฏ ุบุฑุถุฑูุฑ ุจู ุจุฑูุงูู ุงุถุงูู ูโฺฉูู.</li>
</ul>
<p>ุฏุฑ ฺูู ููุงุฑุฏ ูโุชููุฏ ุจูโุณุงุฏฺฏ <strong>Dispose ุฑู ูุงุฏุฏู ุจฺฏุฑุฏ</strong>. ุงูุจุชู ูุงุฏุฏู ฺฏุฑูุชู Dispose ฺฏุงู ูโุชููู ูุฒููโ ฺฉุงุฑุง ุฏุงุดุชู ุจุงุดู (ุจุฎุด ยซCalling Dispose from a Finalizerยป ุตูุญู ตนฐ ุฑู ุจุจูุฏ).</p>
<hr>
<h2>๐งน ูพุงฺฉโุณุงุฒ ููุฏูุง ุฏุฑ Dispose</h2>
<p>ุจูโุทูุฑ ฺฉูุ ุฏุฑ ูุชุฏ <strong>Dispose</strong> ูุงุฒู ูุณุช ููุฏูุง ฺฉ ุดุก ุฑู ูพุงฺฉ ฺฉูุฏ. ุจุง ุงู ุญุงูุ ฺฉ ฺฉุงุฑ ุฎูุจ ุงูู ฺฉู ุงุฒ <strong>event</strong>โูุง ฺฉู ุดุก ุฏุฑ ุทูู ุนูุฑุด ุจู ุงููโูุง subscribe ฺฉุฑุฏูุ <strong>unsubscribe</strong> ฺฉูุฏ (ุจุฑุง ูููููุ ุจุฎุด ยซManaged Memory Leaksยป ุฏุฑ ุตูุญู ถฐฐ ุฑู ุจุจูุฏ).</p>
<p>ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดู:</p>
<ul>
<li>ุงุนูุงูโูุง ูุงุฎูุงุณุชู ุฏุฑุงูุช ูฺฉูุฏ.</li>
<li>ู ุฌูู ุฒูุฏู ูููุฏู ูุงุฎูุงุณุชูโ ุดุก ุฏุฑ ูฺฏุงู <strong>Garbage Collector (GC)</strong> ฺฏุฑูุชู ุจุดู.</li>
</ul>
<p>ุฎูุฏ ูุชุฏ <strong>Dispose</strong> ุจุงุนุซ ุขุฒุงุฏุณุงุฒ ุญุงูุธูโ ูุฏุฑุชโุดุฏู (Managed Memory) ููโุดูโุงู ููุท ุฏุฑ ุฒูุงู <strong>Garbage Collection</strong> ุงุชูุงู ูโุงูุชู.</p>
<p>ููฺูู ุฎูุจู ฺฉ ููุฏ ูุฑุงุฑ ุจุฏุฏ ุชุง ูุดูู ุจุฏู ุดุก Dispose ุดุฏู. ุงูุทูุฑ ุงฺฏู ุจุนุฏุงู ูุตุฑูโฺฉููุฏู ุจุฎูุงุฏ ุฑู ุดุก ูุชุฏ ุตุฏุง ุจุฒููุ ูโุชููุฏ ฺฉ <strong>ObjectDisposedException</strong> ูพุฑุชุงุจ ฺฉูุฏ:</p>
<pre><code class="language-csharp">public bool IsDisposed { get; private set; }
</code></pre>
<p>ุนูุงูู ุจุฑ ุงูุ (ูุฑฺูุฏ ุงุฒ ูุธุฑ ูู ุถุฑูุฑ ูุณุช) ุจูุชุฑู ููุฏูุฑูุง event ุฏุงุฎู ุดุก ุฑู ูู ุฏุฑ ูุชุฏ Dispose ูพุงฺฉ ฺฉูุฏ (ุจุง ููุฏุงุฑุฏู <strong>null</strong>). ุงู ุจุงุนุซ ูโุดู ุงูู eventูุง ุญู ุง ุจุนุฏ ุงุฒ Dispose ุดุฏูุ ุงุฌุฑุง ูุดู.</p>
<p>ฺฏุงู ฺฉ ุดุก ุฏุงุฏูโูุง ูุญุฑูุงูู ู ุญุณุงุณ ูุซู ฺฉูุฏูุง ุฑูุฒูฺฏุงุฑ ูฺฏู ูโุฏุงุฑู. ุฏุฑ ุงู ุญุงูุช ููุทูู ฺฉู ุงูู ุฏุงุฏูโูุง ุฑู ููฺฏุงู Dispose ูพุงฺฉ ฺฉูุฏ (ุจุฑุง ุฌููฺฏุฑ ุงุฒ ฺฉุดู ุงุญุชูุงู ุชูุณุท ุณุงุฑ ูพุฑุฏุงุฒูโูุง ููุช ุญุงูุธู ุจุนุฏุงู ุจู ุณุณุชูโุนุงูู ุจุงุฒฺฏุฑุฏููุฏู ูโุดู). ฺฉูุงุณ <strong>SymmetricAlgorithm</strong> ุฏุฑ ูุถุง ูุงู <strong>System.Security.Cryptography</strong> ุฏููุงู ููู ฺฉุงุฑ ุฑู ูโฺฉูู ู ุฑู ุขุฑุงูโ ุจุงุช ฺฉู ฺฉูุฏ ุฑูุฒูฺฏุงุฑ ุฑู ูฺฏู ูโุฏุงุฑูุ ูุชุฏ <strong>Array.Clear</strong> ุฑู ุตุฏุง ูโุฒูู.</p>
<hr>
<h2>๐น๏ธ Anonymous Disposal</h2>
<p>ฺฏุงู ููุฏู ฺฉู <strong>IDisposable</strong> ุฑู ูพุงุฏูโุณุงุฒ ฺฉูู ุจุฏูู ุงูฺฉู ฺฉ ฺฉูุงุณ ฺฉุงูู ุจููุณู.</p>
<p>ูุฑุถ ฺฉูุฏ ูโุฎูุงุฏ ุฏุฑ ฺฉ ฺฉูุงุณุ ูุชุฏูุง ุจุฑุง <strong>suspend</strong> ู <strong>resume</strong> ฺฉุฑุฏู ูพุฑุฏุงุฒุด event ุฏุงุดุชู ุจุงุดุฏ:</p>
<pre><code class="language-csharp">class Foo
{
  int _suspendCount;
  public void SuspendEvents() =&gt; _suspendCount++;           
  public void ResumeEvents() =&gt; _suspendCount--;            
  void FireSomeEvent()
  {
    if (_suspendCount == 0)
      ... fire some event ...
  }
  ...
}
</code></pre>
<p>ุงู API ุฏุณุชโููพุงฺฏุฑ ูุณุช ฺูู ูุตุฑูโฺฉููุฏูโูุง ุจุงุฏ ุญุชูุงู <strong>ResumeEvents</strong> ุฑู ุตุฏุง ุจุฒูู. ุจุฑุง ูุทูุฆู ุจูุฏูุ ุจุงุฏ ุงู ฺฉุงุฑ ุฑู ุฏุงุฎู ฺฉ ุจูุงฺฉ <strong>finally</strong> ุงูุฌุงู ุจุฏู (ุฏุฑ ุตูุฑุช ฺฉู Exception ุฑุฎ ุจุฏู):</p>
<pre><code class="language-csharp">var foo = new Foo();
foo.SuspendEvents();
try
{
  ... do stuff ...      // ููฺฉูู ุงูุฌุง Exception ูพุฑุชุงุจ ุจุดู
}
finally
{
  foo.ResumeEvents();   // ุจุงุฏ ุญุชูุงู ุงูุฌุง ุตุฏุง ุฒุฏู ุจุดู
}
</code></pre>
<p>ฺฉ ุงูฺฏู ุจูุชุฑ ุงูู ฺฉู ูุชุฏ <strong>ResumeEvents</strong> ุฑู ุญุฐู ฺฉูู ู ูุชุฏ <strong>SuspendEvents</strong> ฺฉ <strong>IDisposable</strong> ุจุฑฺฏุฑุฏููู. ูุตุฑูโฺฉููุฏูโูุง ูโุชููู ุงูุทูุฑ ุงุณุชูุงุฏู ฺฉูู:</p>
<pre><code class="language-csharp">using (foo.SuspendEvents())
{
  ... do stuff ...
}
</code></pre>
<p>ุงูุง ูุดฺฉู ุงูุฌุงุณุช ฺฉู ูพุงุฏูโุณุงุฒ ูุชุฏ <strong>SuspendEvents</strong> ุจุฑุง ูุง ุฒุญูุช ุงุถุงูู ุฏุฑุณุช ูโฺฉูู:</p>
<pre><code class="language-csharp">public IDisposable SuspendEvents()
{
  _suspendCount++;
  return new SuspendToken(this);
}

class SuspendToken : IDisposable 
{
  Foo _foo;          
  public SuspendToken(Foo foo) =&gt; _foo = foo;
  public void Dispose()
  {
    if (_foo != null) _foo._suspendCount--;
    _foo = null;  // ุฌููฺฏุฑ ุงุฒ ุฏูุจุงุฑ Dispose ุดุฏู
  }
}
</code></pre>
<hr>
<h3>๐ช ุงูฺฏู Anonymous Disposal</h3>
<p>ุงู ูุดฺฉู ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ฺฉูุงุณ <strong>Disposable</strong> ูุงุจู ุงุณุชูุงุฏูโ ูุฌุฏุฏ ุญู ูโุดู:</p>
<pre><code class="language-csharp">public class Disposable : IDisposable
{
  public static Disposable Create(Action onDispose)
    =&gt; new Disposable(onDispose);
  Action _onDispose;
  Disposable(Action onDispose) =&gt; _onDispose = onDispose;
  public void Dispose()
  {
    _onDispose?.Invoke();   // ุงุฌุฑุง ุนููุงุช Dispose ุฏุฑ ุตูุฑุช ูุฌูุฏ
    _onDispose = null;      // ุฌููฺฏุฑ ุงุฒ ุงุฌุฑุง ุฏูุจุงุฑู
  }
}
</code></pre>
<p>ุญุงูุง ูโุชููู ูุชุฏ <strong>SuspendEvents</strong> ุฑู ุจูโุดฺฉู ุฒุฑ ุณุงุฏู ฺฉูู:</p>
<pre><code class="language-csharp">public IDisposable SuspendEvents()
{
  _suspendCount++;
  return Disposable.Create(() =&gt; _suspendCount--);
}
</code></pre>
<h2>โ๏ธ Garbage Collection ุฎูุฏฺฉุงุฑ</h2>
<p>ูุฑู ููโฺฉูู ฺฉ ุดุก ูุงุฒููุฏ ูุชุฏ <strong>Dispose</strong> ุจุฑุง ููุทู tear-down ุณูุงุฑุด ุจุงุดู ุง ููุ ุฏุฑ ูุฑ ุตูุฑุช ุญุงูุธูโุง ฺฉู ุฑู heap ุงุดุบุงู ฺฉุฑุฏู ุจุงุฏ ุฏุฑ ฺฉ ููุทู ุขุฒุงุฏ ุจุดู. ุงู ุจุฎุด ุจูโุทูุฑ ฺฉุงูู ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุชูุณุท <strong>CLR</strong> ู ุงุฒ ุทุฑู ฺฉ <strong>Garbage Collector (GC)</strong> ุฎูุฏฺฉุงุฑ ูุฏุฑุช ูโุดู. ุดูุง ูฺโููุช ุญุงูุธูโ ูุฏุฑุชโุดุฏู (Managed Memory) ุฑู ุฎูุฏุชูู ุขุฒุงุฏ ููโฺฉูุฏ.</p>
<p>ูุซุงู:</p>
<pre><code class="language-csharp">public void Test()
{
  byte[] myArray = new byte[1000];
  ...
}
</code></pre>
<p>ููุช ูุชุฏ <strong>Test</strong> ุงุฌุฑุง ูโุดูุ ฺฉ ุขุฑุงู ุจุฑุง ูฺฏูุฏุงุฑ ฑฐฐฐ ุจุงุช ุฑู heap ุชุฎุตุต ุฏุงุฏู ูโุดู. ุงู ุขุฑุงู ุชูุณุท ูุชุบุฑ <strong>myArray</strong> ฺฉู ุฑู stack ูุชุบุฑูุง ูุญู ูุฑุงุฑ ุฏุงุฑูุ ูุฑุฌุนโุฏู ูโุดู. ููุช ูุชุฏ ุฎุงุฑุฌ ูโุดูุ ุงู ูุชุบุฑ ูุญู ุงุฒ scope ุฎุงุฑุฌ ูโุดูุ ุนู ุฏฺฏู ูฺ ฺุฒ ุจู ุงูู ุขุฑุงู ุฑู heap ุงุดุงุฑู ููโฺฉูู. ุฏุฑ ุงู ุญุงูุชุ ุขุฑุงูโ ุจโุตุงุญุจ ูโุชููู ุฏุฑ ูุฑุขูุฏ Garbage Collection ุขุฒุงุฏ ุจุดู.</p>
<p>ุฏุฑ <strong>ุญุงูุช Debug</strong> ููุช ุจูููโุณุงุฒโูุง ุบุฑูุนุงู ุจุงุดูุ ุทูู ุนูุฑ ฺฉ ุดุก ฺฉู ุชูุณุท ูุชุบุฑ ูุญู ูุฑุฌุนโุฏู ูโุดู ุชุง ูพุงุงู ุจูุงฺฉ ฺฉุฏ ุงุฏุงูู ูพุฏุง ูโฺฉูู ุชุง ุงุดฺฉุงูโุฒุฏุง ุฑุงุญุชโุชุฑ ุจุงุดู. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุดุก ุฏุฑ ุงููู ููุทูโุง ฺฉู ุฏฺฏู ุงุณุชูุงุฏู ููโุดูุ ูุงุฌุฏ ุดุฑุงุท ุฌูุนโุขูุฑ ูโุดู.</p>
<p>Garbage Collection ุจูุงูุงุตูู ุจุนุฏ ุงุฒ ุจโุตุงุญุจ ุดุฏู ฺฉ ุดุก ุงูุฌุงู ููโุดู. ุฏุฑุณุช ูุซู ุฌูุนโุขูุฑ ุฒุจุงูู ุฏุฑ ุฎุงุจุงูุ ุงู ฺฉุงุฑ ุจูโุตูุฑุช ุฏูุฑูโุง ุงูุฌุงู ูโุดูโุงูุจุชู ุจุฑ ุฎูุงู ุฌูุนโุขูุฑ ุฒุจุงูู ุฏุฑ ุฎุงุจุงูุ ุฒูุงูโุจูุฏ ุซุงุจุช ูุฏุงุฑู. ุชุตูู CLR ุจุฑุง ุงุฌุฑุง GC ุจุฑ ุงุณุงุณ ุนูุงูู ูุซู ูุฒุงู ุญุงูุธูโ ููุฌูุฏุ ุญุฌู ุชุฎุตุต ุญุงูุธูุ ู ูุฏุช ุฒูุงู ฺฏุฐุดุชู ุงุฒ ุขุฎุฑู GC ฺฏุฑูุชู ูโุดู (GC ุฎูุฏุด ุฑู ุจุฑ ุงุณุงุณ ุงูฺฏููุง ุฏุณุชุฑุณ ุญุงูุธูโ ุจุฑูุงูู ุชูุธู ูโฺฉูู).</p>
<p>ุจู ููู ุฎุงุทุฑุ ฺฉ ุชุฃุฎุฑ ูุงูุดุฎุต ุจู ุจโุตุงุญุจ ุดุฏู ฺฉ ุดุก ู ุขุฒุงุฏ ุดุฏู ุญุงูุธูโ ุงูู ูุฌูุฏ ุฏุงุฑู. ุงู ุชุฃุฎุฑ ูโุชููู ุงุฒ ูุงููุซุงูู ุชุง ฺูุฏ ุฑูุฒ ุทูู ุจฺฉุดู.</p>
<p>GC ูููโ ุฒุจุงููโูุง ุฑู ุฏุฑ ูุฑ ุจุงุฑ ุฌูุนโุขูุฑ ูพุงฺฉ ููโฺฉูู.
ูุฏุฑ ุญุงูุธู ุงุดุงุก ุฑู ุจู <strong>generation</strong>โูุง ุชูุณู ูโฺฉูู ู GC ุงุดุงุก ุชุงุฒู (ุฌุฏุฏุงู ุชุฎุตุต ุฏุงุฏูโุดุฏู) ุฑู ุจุดุชุฑ ุงุฒ ุงุดุงุก ูุฏู (ุจุง ุทูู ุนูุฑ ุฒุงุฏ) ุฌูุนโุขูุฑ ูโฺฉูู. ุฌุฒุฆุงุช ุงู ููุถูุน ุฏุฑ ุจุฎุด ยซHow the GC Worksยป (ุตูุญู ตนณ) ุชูุถุญ ุฏุงุฏู ุดุฏู.</p>
<hr>
<h2>๐ Garbage Collection ู ูุตุฑู ุญุงูุธู</h2>
<p>GC ุชูุงุด ูโฺฉูู ุจู <strong>ุฒูุงู ฺฉู ุตุฑู ุฌูุนโุขูุฑ ูโฺฉูู</strong> ู <strong>ูุฒุงู ุญุงูุธูโุง ฺฉู ุจุฑูุงูู ูุตุฑู ูโฺฉูู (Working Set)</strong> ุชุนุงุฏู ุจุฑูุฑุงุฑ ฺฉูู. ุจู ููู ุฏููุ ุจุฑูุงููโูุง ูโุชููู ุจุดุชุฑ ุงุฒ ูุงุฒุดูู ุญุงูุธู ูุตุฑู ฺฉููุ ุจูโูฺู ููุช ุขุฑุงูโูุง ูููุช ุจุฒุฑฺฏ ุณุงุฎุชู ูโุดู.</p>
<p>ุดูุง ูโุชููุฏ ูุตุฑู ุญุงูุธูโ ฺฉ ูพุฑุฏุงุฒู ุฑู ุงุฒ ุทุฑู <strong>Windows Task Manager</strong> ุง <strong>Resource Monitor</strong> ูุงูุชูุฑ ฺฉูุฏโุง ุจูโุตูุฑุช ุจุฑูุงููโููุณุ ุจุง ุงุณุชูุงุฏู ุงุฒ <strong>PerformanceCounter</strong>:</p>
<pre><code class="language-csharp">// ุงู ุชุงูพโูุง ุฏุฑ System.Diagnostics ูุณุชู:
string procName = Process.GetCurrentProcess().ProcessName;
using PerformanceCounter pc = new PerformanceCounter
     (&quot;Process&quot;, &quot;Private Bytes&quot;, procName);
Console.WriteLine(pc.NextValue());
</code></pre>
<p>ุงู ฺฉุฏ <strong>Private Working Set</strong> ุฑู ุจุฑูโฺฏุฑุฏููู ฺฉู ุจูุชุฑู ูุดููู ุจุฑุง ูุตุฑู ุญุงูุธูโ ุจุฑูุงููโุณุช. ุงู ููุฏุงุฑ ุจูโุทูุฑ ุฎุงุต ุญุงูุธูโุง ุฑู ฺฉู CLR ุจูโุตูุฑุช ุฏุงุฎู ุขุฒุงุฏ ฺฉุฑุฏู ู ุขูุงุฏูโุณุช ุจู ุณุณุชูโุนุงูู ูพุณ ุจุฏู (ุงฺฏู ฺฉ ูพุฑุฏุงุฒูโ ุฏฺฏู ุจู ุงูู ูุงุฒ ุฏุงุดุชู ุจุงุดู)ุ ุดุงูู ููโุดู.</p>
<hr>
<h2>๐ฑ Root</h2>
<p><strong>Root</strong> ฺุฒ ูุณุช ฺฉู ุจุงุนุซ ูโุดู ฺฉ ุดุก ุฒูุฏู ุจูููู. ุงฺฏู ฺฉ ุดุก ุจูโุทูุฑ ูุณุชูู ุง ุบุฑูุณุชูู ุชูุณุท ฺฉ Root ูุฑุฌุนโุฏู ูุดูุ ูุงุฌุฏ ุดุฑุงุท Garbage Collection ูโุดู.</p>
<p>Root ูโุชููู ฺฉ ุงุฒ ููุงุฑุฏ ุฒุฑ ุจุงุดู:</p>
<ul>
<li>ฺฉ ูุชุบุฑ ูุญู ุง ูพุงุฑุงูุชุฑ ุฏุฑ ฺฉ ูุชุฏ ุฏุฑ ุญุงู ุงุฌุฑุง (ุง ุฏุฑ ูุฑ ูุชุฏ ุฏุฑ call stack ุงูู)</li>
<li>ฺฉ ูุชุบุฑ <strong>static</strong></li>
<li>ฺฉ ุดุก ุฏุฑ ุตู ฺฉู ุงุดุงุก ุขูุงุฏู ุจุฑุง <strong>Finalization</strong> ุฑู ุฐุฎุฑู ูโฺฉูู</li>
</ul>
<p>ุงุฒ ุงููโุฌุง ฺฉู ุบุฑููฺฉูู ฺฉุฏ ุฏุฑ ฺฉ ุดุก ุญุฐูโุดุฏู ุงุฌุฑุง ุจุดูุ ุงฺฏู ุงุญุชูุงู ุงุฌุฑุง ฺฉ ูุชุฏ instance ูุฌูุฏ ุฏุงุดุชู ุจุงุดูุ ุงูู ุดุก ุจุงุฏ ุจู ฺฉ ุงุฒ ุงู ุฑูุดโูุง ูุฑุฌุนโุฏู ุจุดู.</p>
<p>ุชูุฌู ฺฉูุฏ ฺฉู ฺฏุฑูู ุงุฒ ุงุดุงุฆ ฺฉู ุจูโุตูุฑุช ฺุฑุฎูโุง ุจู ููุฏฺฏู ูุฑุฌุน ูโุฏูุ ุจุฏูู ฺฉ Root <strong>ูุฑุฏู</strong> ูุญุณูุจ ูโุดู (ุดฺฉู ฑฒ-ฑ ุฑู ุจุจูุฏ). ุจู ุจุงู ุฏฺฏูุ ุงุดุงุฆ ฺฉู ูุชููุฏ ุจุง ุฏูุจุงู ฺฉุฑุฏู ูพฺฉุงูโูุง (references) ุงุฒ ฺฉ Root ุจู ุงููโูุง ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏุ <strong>unreachable</strong> ูุณุชูโู ุจูุงุจุฑุงู ูุดููู ุฌูุนโุขูุฑ ูโุดู.</p>
<div align="center">
<p><img src="../../../assets/image/12/Table-12-2.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h2>โฐ๏ธ Finalizers</h2>
<p>ูพุด ุงุฒ ุงูฺฉู ฺฉ ุดุก ุงุฒ ุญุงูุธู ุขุฒุงุฏ ุจุดูุ ุงฺฏุฑ <strong>Finalizer</strong> ุฏุงุดุชู ุจุงุดูุ ุงุฌุฑุง ูโุดู. ฺฉ Finalizer ุดุจู ุจู ฺฉ ุณุงุฒูุฏู (<strong>Constructor</strong>) ุชุนุฑู ูโุดูุ ุจุง ุงู ุชูุงูุช ฺฉู ูุจู ุงุฒ ุงุณู ฺฉูุงุณ ุนูุงูุช <code>~</code> ูุฑุงุฑ ูโฺฏุฑู:</p>
<pre><code class="language-csharp">class Test
{
  ~Test()
  {
    // Finalizer logic...
  }
}
</code></pre>
<p>(ุงฺฏุฑฺู ุฏุฑ ูุญู ููุดุชู ุดุจู ุณุงุฒูุฏูโุณุชุ ุงูุง <strong>Finalizer</strong>โูุง ููโุชููู <code>public</code> ุง <code>static</code> ุจุงุดูุ ูพุงุฑุงูุชุฑ ุจฺฏุฑู ุง ุณุงุฒูุฏูโ ูพุงู (base class) ุฑู ุตุฏุง ุจุฒูู.)</p>
<p>ูุฌูุฏ Finalizerูุง ุจู ุงู ุฎุงุทุฑ ููฺฉูู ฺฉู ูุฑุขูุฏ Garbage Collection ุฏุฑ ฺูุฏู ูุงุฒ ุงูุฌุงู ูโุดู. ุฏุฑ ูุฑุญููโ ุงููุ GC ุงุดุงุก ุจูุงุงุณุชูุงุฏู ุฑู ุดูุงุณุง ูโฺฉูู. ุงููโูุง ฺฉู Finalizer ูุฏุงุฑูุ ููุฑุงู ุญุฐู ูโุดู. ุงูุง ุงุดุงุฆ ฺฉู Finalizer ุฏุงุฑูุ ูููุชุงู ุฒูุฏู ูฺฏู ุฏุงุดุชู ูโุดู ู ุชู ฺฉ ุตู ุฎุงุต ูุฑุงุฑ ูโฺฏุฑู.</p>
<p>ุฏุฑ ุงูู ูุญุธูุ ูุฑุขูุฏ Garbage Collection ุชููู ูโุดู ู ุจุฑูุงููโ ุดูุง ุจู ุงุฌุฑุง ุฎูุฏุด ุงุฏุงูู ูโุฏู. ุจุนุฏ ูุฎ (Thread) ูุฑุจูุท ุจู Finalizer ูุงุฑุฏ ุนูู ูโุดู ู ุจูโุตูุฑุช ููุงุฒ ุจุง ุจุฑูุงูู ุงุฌุฑุง ูโุดูุ ุงุดุงุก ุฑู ุงุฒ ุตู ุจุฑูโุฏุงุฑู ู ูุชุฏ Finalizer ุงููโูุง ุฑู ุงุฌุฑุง ูโฺฉูู.</p>
<p>ุชุง ูพุด ุงุฒ ุงุฌุฑุง Finalizer ูุฑ ุดุกุ ุงูู ูููุฒ ยซุฒูุฏูยป ุญุณุงุจ ูโุดูโฺูู ุงูู ุตู ุจูโุนููุงู ฺฉ Root ุนูู ูโฺฉูู. ุจุนุฏ ุงุฒ ุฎุงุฑุฌ ุดุฏู ุงุฒ ุตู ู ุงุฌุฑุง Finalizerุ ุดุก ุจโุตุงุญุจ ูโุดู ู ุฏุฑ ุฌูุนโุขูุฑ ุจุนุฏ (ุจุฑุง ูููู Generation) ุญุฐู ุฎูุงูุฏ ุดุฏ.</p>
<hr>
<h3>โ๏ธ ูฺฉุงุช ููู ุฏุฑุจุงุฑู Finalizerูุง</h3>
<ul>
<li>๐ซ Finalizerูุง ุณุฑุนุช ุชุฎุตุต ู ุฌูุนโุขูุฑ ุญุงูุธู ุฑู ฺฉุงูุด ูโุฏู (ฺูู GC ุจุงุฏ ุฏูุจุงู ฺฉูู ฺฉู ฺฉุฏูู Finalizer ุงุฌุฑุง ุดุฏู).</li>
<li>โณ ุทูู ุนูุฑ ุดุก ู ุงุดุงุก ูุฑุฌุน ุงููโูุง ุฑู ุทููุงูโุชุฑ ูโฺฉูู.</li>
<li>๐ ุชุฑุชุจ ุงุฌุฑุง Finalizerูุง ุจุฑุง ูุฌููุนูโุง ุงุฒ ุงุดุงุก ุบุฑูุงุจู ูพุดโุจูู.</li>
<li>๐๏ธ ฺฉูุชุฑู ุดูุง ุฑู ุฒูุงู ุงุฌุฑุง Finalizer ุฎู ูุญุฏูุฏู.</li>
<li>๐ ุงฺฏุฑ ฺฉุฏ ุฏุฑ Finalizer ูุณุฏูุฏ ุจุดูุ ุจูู ุงุดุงุก ูู ููโุชููู Finalize ุจุดู.</li>
<li>โ Finalizerูุง ููฺฉูู ุจูโุทูุฑ ฺฉุงูู ุฏูุฑ ุฒุฏู ุจุดู ุงฺฏุฑ ุจุฑูุงูู ุจูโุฏุฑุณุช unload ูุดู.</li>
</ul>
<p>๐ ุฏุฑ ฺฉูุ Finalizerูุง ุดุจู ูฺฉู ูุณุชูโูุฑฺูุฏ ุฏุฑ ุจุนุถ ุดุฑุงุท ูุงูุนุงู ุจูุดูู ูุงุฒ ุฏุงุฑุฏุ ูู ุจูโุทูุฑ ฺฉู ุจูุชุฑู ูฺฏุฑ ุฏุฑ ุตูุฑุช ุถุฑูุฑุช ูุทูู ุงุฒุดูู ุงุณุชูุงุฏู ูฺฉูุฏ.</p>
<hr>
<h3>๐ ุฏุณุชูุฑุงูุนููโูุง ูพุงุฏูโุณุงุฒ Finalizerูุง</h3>
<ul>
<li>โ ูุทูุฆู ุจุดุฏ Finalizer ุณุฑุน ุงุฌุฑุง ูโุดู.</li>
<li>โ ูุฑฺฏุฒ ุฏุฑ Finalizer ุจูุงฺฉ ูฺฉูุฏ (ุจู ุจุฎุด โBlockingโ ุฏุฑ ุตูุญู ถณด ูุฑุงุฌุนู ฺฉูุฏ).</li>
<li>๐ซ ุจู ุงุดุงุก ุฏฺฏูโุง ฺฉู ุฎูุฏุดูู Finalizer ุฏุงุฑู ุงุฑุฌุงุน ูุฏุฏ.</li>
<li>โ ุงุณุชุซูุง (Exception) ูพุฑุชุงุจ ูฺฉูุฏ.</li>
</ul>
<blockquote>
<p>ูฺฉุชู: CLR ูโุชููู Finalizer ฺฉ ุดุก ุฑู ุญุช ุงฺฏุฑ ุฏุฑ ุทูู ุณุงุฒูุฏู ุงุณุชุซูุง ุฑุฎ ุฏุงุฏู ุจุงุดูุ ูุฑุงุฎูุงู ฺฉูู. ูพุณ ูุจุงุฏ ูุฑุถ ฺฉูุฏ ููุฏูุง ููุดู ุจูโุฏุฑุณุช ููุฏุงุฑุฏู ุดุฏู.</p>
</blockquote>
<hr>
<h2>๐ ูุฑุงุฎูุงู Dispose ุงุฒ Finalizer</h2>
<p>ฺฉ ุงูฺฏู ูุชุฏุงูู ุงูู ฺฉู Finalizer ูุชุฏ <strong>Dispose</strong> ุฑู ูุฑุงุฎูุงู ฺฉูู. ุงู ฺฉุงุฑ ููุทูู ููุช ูพุงฺฉโุณุงุฒ ููุฑ ูุงุฒู ูุณุช ู ุตุฏุง ุฒุฏู Dispose ุจุดุชุฑ ฺฉ <strong>ุจูููโุณุงุฒ</strong> ุญุณุงุจ ูโุดู ุชุง ฺฉ ุถุฑูุฑุช.</p>
<p>ุงูุง ุชูุฌู ฺฉูุฏ ฺฉู ุงู ุงูฺฏู ุจุงุนุซ ูโุดู ุขุฒุงุฏุณุงุฒ ุญุงูุธู ู ุขุฒุงุฏุณุงุฒ ููุงุจุน (Resource) ุจู ูู ฺฏุฑู ุจุฎูุฑูโฺฉู ููฺฉูู ุงูุฏุงู ูุชูุงูุช ุฏุงุดุชู ุจุงุดู. ููฺูู ุจุงุฑ ุจุดุชุฑ ุจู ูุฎ Finalizer ูุงุฑุฏ ูโฺฉูู.</p>
<p>ุงู ุงูฺฏู ุจูโุนููุงู <strong>ูพุดุชุจุงู</strong> ูู ุจูโฺฉุงุฑ ูโุฑูุ ุจุฑุง ููุช ฺฉู ูุตุฑูโฺฉููุฏู ุดุก ูุฑุงููุด ฺฉูู Dispose ุฑู ุตุฏุง ุจุฒูู. ุฏุฑ ุงู ุญุงูุชุ ุจูุชุฑู ุฎุทุง ุฑู ูุงฺฏ ฺฉูุฏ ุชุง ุจุนุฏุงู ุจุชููุฏ ูุดฺฉู ุฑู ุฑูุน ฺฉูุฏ.</p>
<p>ฺฉ ุงูฺฏู ุงุณุชุงูุฏุงุฑุฏ ุจุฑุง ูพุงุฏูโุณุงุฒ ุงู ุฑูุด ุจู ุดฺฉู ุฒุฑู:</p>
<pre><code class="language-csharp">class Test : IDisposable
{
  public void Dispose()             // NOT virtual
  {
    Dispose(true);
    GC.SuppressFinalize(this);     // ูุงูุน ุงุฌุฑุง Finalizer ูโุดู
  }

  protected virtual void Dispose(bool disposing)
  {
    if (disposing)
    {
      // Dispose ุฑู ุงุดุงุก ุฏฺฏูโุง ฺฉู ูุชุนูู ุจู ุงู ุดุก ูุณุชู.
      // ูโุชููุฏ ุงูุฌุง ุจู ุงุดุงุก Finalizable ูู ุงุฑุฌุงุน ุจุฏุฏ.
    }

    // ุขุฒุงุฏุณุงุฒ ููุงุจุน unmanaged ูุชุนูู ุจู ููู ุดุก.
  }

  ~Test() =&gt; Dispose(false);
}
</code></pre>
<p>ุฏุฑ ุงูุฌุง:</p>
<ul>
<li>ูุชุฏ <strong>Dispose ุจุฏูู ูพุงุฑุงูุชุฑ</strong>ุ <code>virtual</code> ูุณุช ู ููุท ูุณุฎูโ ุชูุณุนูโุงูุชู ุฑู ุจุง ููุฏุงุฑ <code>true</code> ุตุฏุง ูโุฒูู.</li>
<li>ูุณุฎูโ ุชูุณุนูโุงูุชู <code>protected</code> ู <code>virtual</code> ูุณุช ู ููุทู ุงุตู ุขุฒุงุฏุณุงุฒ ุฑู ุฏุงุฑู.</li>
<li>ูพุงุฑุงูุชุฑ <strong>disposing</strong> ูุดุฎุต ูโฺฉูู ุขุง ูุชุฏ ุงุฒ Dispose ุตุฏุง ุฒุฏู ุดุฏู (true) ุง ุงุฒ Finalizer (false).</li>
</ul>
<p>ููุช disposing ุจุฑุงุจุฑ false ุจุงุดูุ ูุจุงุฏ ุจู ุงุดุงุฆ ฺฉู Finalizer ุฏุงุฑู ุงุฑุฌุงุน ุจุฏุฏุ ฺูู ููฺฉูู ุฎูุฏุดูู ูุจูุงู Finalize ุดุฏู ุจุงุดู.</p>
<p>ฺฉุงุฑูุง ฺฉู ููฺูุงู ุฏุฑ ุงู ุญุงูุช ูโุดู ุงูุฌุงู ุฏุงุฏ:</p>
<ul>
<li>ุขุฒุงุฏ ฺฉุฑุฏู ูุฑุงุฌุน ูุณุชูู ุจู ููุงุจุน ุณุณุชูโุนุงูู (ูุซูุงู ุงุฒ ุทุฑู P/Invoke ุจู Win32 API).</li>
<li>ุญุฐู ูุงู ูููุช ฺฉู ุฏุฑ ุณุงุฒูุฏู ุณุงุฎุชู ุดุฏู.</li>
</ul>
<p>ุจุฑุง ููุงููโุณุงุฒุ ูุฑ ฺฉุฏ ฺฉู ููฺฉูู ุงุณุชุซูุง ูพุฑุชุงุจ ฺฉูู ุจุงุฏ ุฏุฑ ุจููฺฉ try/catch ูุฑุงุฑ ุจฺฏุฑู ู ุงุณุชุซูุง ูุงฺฏ ุจุดู (ุจู ุณุงุฏูโุชุฑู ู ูุทูุฆูโุชุฑู ุดฺฉู).</p>
<p>ูุฑุงุฎูุงู <strong>GC.SuppressFinalize</strong> ุฏุฑ Dispose ุจุฏูู ูพุงุฑุงูุชุฑ ุจุงุนุซ ูโุดู Finalizer ุจุนุฏุงู ุงุฌุฑุง ูุดู. ุงู ฺฉุงุฑ ุนูุงูู ุจุฑ ุจูุจูุฏ ฺฉุงุฑุงุ ุงุฌุงุฒู ูโุฏู ุดุก (ู ุงุดุงุก ูุฑุฌุน ุงูู) ุฏุฑ ฺฉ ฺุฑุฎู GC ุขุฒุงุฏ ุจุดู.</p>
<hr>
<h2>๐ง Resurrection</h2>
<p>ูุฑุถ ฺฉูุฏ ฺฉ Finalizerุ ุดุก ุฒูุฏูโุง ุฑู ุทูุฑ ุชุบุฑ ุจุฏู ฺฉู ุจู ุดุก ุฏุฑ ุญุงู ูุฑฺฏ ุงุฑุฌุงุน ุจุฏู. ุฏุฑ ุงู ุตูุฑุชุ ููุช GC ุจุนุฏ ุงุฌุฑุง ุจุดูุ CLR ุงูู ุดุก ุฑู ุฏฺฏู ุจโุตุงุญุจ ููโุจูู ู ุจูุงุจุฑุงู ุงุฒ ุฌูุนโุขูุฑ ูุฑุงุฑ ูโฺฉูู. ุจู ุงู ุณูุงุฑู <strong>Resurrection</strong> ูโฺฏู.</p>
<p>ูุซุงู: ููุดุชู ฺฉูุงุณ ุจุฑุง ูุฏุฑุช ฺฉ ูุงู ูููุช:</p>
<pre><code class="language-csharp">public class TempFileRef
{
  public readonly string FilePath;
  public TempFileRef(string filePath) { FilePath = filePath; }
  ~TempFileRef() { File.Delete(FilePath); }
}
</code></pre>
<p>โ๏ธ ูุดฺฉู: <code>File.Delete</code> ููฺฉูู ุงุณุชุซูุง ูพุฑุชุงุจ ฺฉูู (ูุซูุงู ุจู ุฎุงุทุฑ ูุฏุงุดุชู ุฏุณุชุฑุณุ ุฏุฑ ุญุงู ุงุณุชูุงุฏู ุจูุฏู ูุงู ุง ูุจูุงู ุญุฐู ุดุฏู). ุงู ุฎุทุง ุจุงุนุซ ฺฉุฑุด ฺฉู ุจุฑูุงูู ูโุดู ู ูุงูุน ุงุฌุฑุง Finalizerูุง ุฏฺฏู ูู ุฎูุงูุฏ ุดุฏ.</p>
<p>ูโุชููู ุงุณุชุซูุง ุฑู ุจุง ฺฉ ุจููฺฉ catch ุฎุงู ุจุจูุนูุ ุงูุง ูฺโููุช ูุชูุฌู ููโุดู ฺฉู ุฎุทุง ุฑุฎ ุฏุงุฏู. ุง ูโุชููู ฺฉ API ูพฺุฏูโ ฺฏุฒุงุฑุด ุฎุทุง ุตุฏุง ุจุฒููุ ุงูุง ุงู ุจุงุฑ ูุฎ Finalizer ุฑู ุณูฺฏู ูโฺฉูู. ุจูุงุจุฑุงู ุจุงุฏ ุนููุงุช Finalizer ุฑู ุจู ูุธุงู ุณุงุฏูุ ูุทูุฆู ู ุณุฑุน ูุญุฏูุฏ ฺฉูู.</p>
<p>ุฑุงู ุจูุชุฑ: ุซุจุช ุฎุทุง ุฏุฑ ฺฉ ฺฉุงูฺฉุดู ุงุณุชุงุชฺฉ:</p>
<pre><code class="language-csharp">public class TempFileRef
{
  static internal readonly ConcurrentQueue&lt;TempFileRef&gt; FailedDeletions
    = new ConcurrentQueue&lt;TempFileRef&gt;();

  public readonly string FilePath;
  public Exception DeletionError { get; private set; }

  public TempFileRef(string filePath) { FilePath = filePath; }

  ~TempFileRef()
  {
    try { File.Delete(FilePath); }
    catch (Exception ex)
    {
      DeletionError = ex;
      FailedDeletions.Enqueue(this);   // Resurrection
    }
  }
}
</code></pre>
<p>ุงุถุงูู ฺฉุฑุฏู ุดุก ุจู ฺฉุงูฺฉุดู <strong>FailedDeletions</strong> ฺฉ ูุฑุฌุน ุฌุฏุฏ ุจุฑุงุด ุงุฌุงุฏ ูโฺฉูู ู ุจุงุนุซ ูโุดู ุฒูุฏู ุจูููู ุชุง ุฒูุงู ฺฉู dequeue ุจุดู.</p>
<p><code>ConcurrentQueue&lt;T&gt;</code> ูุณุฎูโ <strong>Thread-Safe</strong> ุงุฒ <code>Queue&lt;T&gt;</code> ูุณุช ู ุฏุฑ ูุถุง ูุงู <code>System.Collections.Concurrent</code> ุชุนุฑู ุดุฏู (ุจุฎุด ฒฒ).</p>
<p>ุฏูุงู ุงุณุชูุงุฏู ุงุฒ ฺฉุงูฺฉุดู Thread-Safe:</p>
<ol>
<li>CLR ูโุชููู Finalizerูุง ุฑู ุฑู ุจุด ุงุฒ ฺฉ Thread ุจูโุทูุฑ ููุงุฒ ุงุฌุฑุง ฺฉููุ ูพุณ ููุช ุจู state ูุดุชุฑฺฉ ูุซู ฺฉ ฺฉุงูฺฉุดู ุงุณุชุงุชฺฉ ุฏุณุชุฑุณ ุฏุงุฑูุ ุจุงุฏ ุงุญุชูุงู Finalize ุดุฏู ููโุฒูุงู ุฏู ุดุก ุฑู ุฏุฑ ูุธุฑ ุจฺฏุฑู.</li>
<li>ุฏุฑ ููุงุช ุจุงุฏ ุงุดุงุก ุฑู ุงุฒ <code>FailedDeletions</code> dequeue ฺฉูู ุชุง ุจุชููู ฺฉุงุฑ ุจุฑุงุดูู ุงูุฌุงู ุจุฏู. ุงู ุนููุงุช ูู ุจุงุฏ Thread-Safe ุจุงุดูุ ฺูู ููฺฉูู ููโุฒูุงู ุจุง enqueue ุดุฏู ฺฉ ุดุก ุชูุณุท Finalizer ุงูุฌุงู ุจุดู.</li>
</ol>
<h2>๐ GC.ReRegisterForFinalize</h2>
<p>ฺฉ ุดุก ฺฉู <strong>Resurrect</strong> ุดุฏู (ุฏูุจุงุฑู ุฒูุฏู ุดุฏู) ุฏฺฏู Finalizerุด ุจุฑุง ุจุงุฑ ุฏูู ุงุฌุฑุง ููโุดูโูฺฏุฑ ุงูฺฉู ุดูุง ูุชุฏ <strong>GC.ReRegisterForFinalize</strong> ุฑู ุตุฏุง ุจุฒูุฏ.</p>
<p>ุฏุฑ ูุซุงู ุฒุฑุ ูุง ุชูุงุด ูโฺฉูู ุฏุฑ Finalizer ฺฉ ูุงู ูููุช ุฑู ุญุฐู ฺฉูู (ูุซู ูุซุงู ูุจู). ุงูุง ุงฺฏุฑ ุญุฐู ุดฺฉุณุช ุฎูุฑุฏุ ุดุก ุฑู ุฏูุจุงุฑู ุซุจุช ูโฺฉูู ุชุง ุฏุฑ Garbage Collection ุจุนุฏ ุฏูุจุงุฑู ุงูุชุญุงู ฺฉูู:</p>
<pre><code class="language-csharp">public class TempFileRef
{
  public readonly string FilePath;
  int _deleteAttempt;

  public TempFileRef(string filePath) { FilePath = filePath; }

  ~TempFileRef()
  {
    try { File.Delete(FilePath); }
    catch
    {
      if (_deleteAttempt++ &lt; 3)
        GC.ReRegisterForFinalize(this);
    }
  }
}
</code></pre>
<p>ุจุนุฏ ุงุฒ ุณููู ุชูุงุด ูุงููููุ Finalizer ูุง ุจุฏูู ุณุฑ ู ุตุฏุง ุงุฒ ุญุฐู ูุงู ุฏุณุช ูโฺฉุดู.
๐ง ูโุชููู ุงู ุฑู ุจูุชุฑ ฺฉูู ู ุจุง ูุซุงู ูุจู ุชุฑฺฉุจ ฺฉููโุนู ุจุนุฏ ุงุฒ ุณููู ุดฺฉุณุชุ ุดุก ุฑู ุจู ุตู <strong>FailedDeletions</strong> ุงุถุงูู ฺฉูู.</p>
<p>โ๏ธ ุชูุฌู:
ุญุชูุงู ููุท <strong>ฺฉโุจุงุฑ</strong> ุฏุฑูู Finalizer ูุชุฏ ReRegisterForFinalize ุฑู ุตุฏุง ุจุฒูุฏ.
ุงฺฏู ุฏูุจุงุฑ ุตุฏุง ุจุฒูุฏุ ุดุก ุฏูุจุงุฑู ุฏูุจุงุฑ ุซุจุช ูโุดู ู ุจุงุฏ ุฏู ุจุงุฑ ุฏฺฏู Finalize ุจุดู!</p>
<hr>
<h2>โ๏ธ GC ฺฺฏููู ฺฉุงุฑ ูโฺฉูุฏุ</h2>
<p><strong>CLR</strong> ุงุฒ ฺฉ Garbage Collector ุงุณุชุงูุฏุงุฑุฏ <strong>Generational Mark-and-Compact</strong> ุงุณุชูุงุฏู ูโฺฉูู ฺฉู ูุฏุฑุช ุญุงูุธูโ ุฎูุฏฺฉุงุฑ ุจุฑุง ุงุดุงุก ุฐุฎุฑูโุดุฏู ุฏุฑ <strong>Managed Heap</strong> ุฑู ุงูุฌุงู ูโุฏู.</p>
<p>GC ฺฉ <strong>Tracing GC</strong> ูุญุณูุจ ูโุดูุ ฺูู ุฌูู ูุฑ ุฏุณุชุฑุณ ุจู ุดุก ุฑู ููโฺฏุฑู. ุจูฺฉู ุจูโุทูุฑ ุฏูุฑูโุง ุจุฏุงุฑ ูโุดู ู ฺฏุฑุงู ุงุดุงุก ููุฌูุฏ ุฏุฑ heap ุฑู ุฏูุจุงู ูโฺฉูู ุชุง ุจูููู ฺฉุฏูู ุงุดุงุก ุฏฺฏู ุงุณุชูุงุฏู ููโุดู ู ุจุงุฏ ุฌูุนโุขูุฑ ุจุดู.</p>
<hr>
<h3>๐๏ธ ฺู ุฒูุงู GC ูุนุงู ูโุดูุ</h3>
<ul>
<li>ููุช ุชุฎุตุต ุญุงูุธู ุฌุฏุฏ ุจุง <code>new</code> ุงูุฌุงู ุจุดู ู ููุฏุงุฑ ูุดุฎุต ุงุฒ ุญุงูุธู ูุตุฑู ุดุฏู ุจุงุดู.</li>
<li>ุง ุฏุฑ ุฒูุงูโูุง ุฏฺฏู ุจุฑุง ฺฉุงูุด ูุฒุงู ุญุงูุธู ูุตุฑู ุจุฑูุงูู.</li>
<li>ููฺูู ูโุชููุฏ ุจูโุตูุฑุช ุฏุณุช ูุชุฏ <code>System.GC.Collect</code> ุฑู ุตุฏุง ุจุฒูุฏ.</li>
</ul>
<p>๐ ุฏุฑ ุทูู Garbage Collectionุ ููฺฉูู ูููโ Threadูุง ูุชููู (Freeze) ุจุดู (ุชูุถุญุงุช ุจุดุชุฑ ุฏุฑ ุจุฎุด ุจุนุฏ).</p>
<hr>
<h3>๐ ูุฑุขูุฏ ุฌูุนโุขูุฑ</h3>
<ol>
<li>
<p>GC ุงุฒ <strong>Root object references</strong> ุดุฑูุน ูโฺฉูู ู ฺฏุฑุงู ุงุดุงุก ุฑู ุฏูุจุงู ูโฺฉูู.</p>
</li>
<li>
<p>ูููโ ุงุดุงุฆ ฺฉู ุฏุฑ ุงู ูุณุฑ ููุณ ุจุดู ุจูโุนููุงู <strong>reachable</strong> ุนูุงูุชโฺฏุฐุงุฑ ูโุดู.</p>
</li>
<li>
<p>ุงุดุงุฆ ฺฉู ุนูุงูุช ูุฎูุฑุฏู ุจุงุดูุ ุจูุงุงุณุชูุงุฏู ูุญุณูุจ ูโุดู ู ูุงุจู ุฌูุนโุขูุฑ ูุณุชู.</p>
<ul>
<li>ุงุดุงุก ุจูุงุงุณุชูุงุฏู <strong>ุจุฏูู Finalizer</strong> ููุฑุงู ุญุฐู ูโุดู.</li>
<li>ุงุดุงุก ุจูุงุงุณุชูุงุฏู <strong>ุฏุงุฑุง Finalizer</strong> ุจู ุตู Finalizer Thread ุงุถุงูู ูโุดู ู ุฏุฑ GC ุจุนุฏ (ุจุฑุง ูููู Generation) ุญุฐู ุฎูุงููุฏ ุดุฏ (ูฺฏุฑ ุงูฺฉู Resurrect ุจุดู).</li>
</ul>
</li>
<li>
<p>ุงุดุงุก ุจุงูโูุงูุฏูโ ุฒูุฏู ุจู ุงุจุชุฏุง Heap ููุชูู ูโุดู (<strong>Compaction</strong>).</p>
</li>
</ol>
<p>๐ ูุฒุงุง:</p>
<ul>
<li>ุฌููฺฏุฑ ุงุฒ <strong>Fragmentation</strong> ุญุงูุธู.</li>
<li>ุณุงุฏูโุชุฑ ุดุฏู ุงุณุชุฑุงุชฺ ุชุฎุตุต ุญุงูุธู (ููุดู ุฏุฑ ุงูุชูุง Heap).</li>
</ul>
<hr>
<h3>๐จ ุฎุทุง ฺฉูุจูุฏ ุญุงูุธู</h3>
<p>ุงฺฏุฑ ุจุนุฏ ุงุฒ Garbage Collection ูุถุง ฺฉุงู ุจุฑุง ุชุฎุตุต ุญุงูุธู ุฌุฏุฏ ูุจุงุดู ู ุณุณุชูโุนุงูู ูู ูุชููู ุญุงูุธู ุจุดุชุฑ ุจุฏูุ ฺฉ <strong>OutOfMemoryException</strong> ูพุฑุชุงุจ ูโุดู.</p>
<hr>
<h3>๐ ูุธุงุฑุช ุจุฑ ูุถุนุช Heap</h3>
<p>ูโุชููุฏ ุงุทูุงุนุงุช ูุถุนุช ูุนู Heap ุฑู ุจุง ูุฑุงุฎูุงู:</p>
<pre><code class="language-csharp">GC.GetGCMemoryInfo();
</code></pre>
<p>ุงุฒ .NET 5 ุจู ุจุนุฏุ ุงู ูุชุฏ ุฏุงุฏูโูุง ูุฑุจูุท ุจู ฺฉุงุฑุง ุฑู ูู ุจุฑูโฺฏุฑุฏููู.</p>
<hr>
<h2>๐ ุชฺฉูฺฉโูุง ุจูููโุณุงุฒ GC</h2>
<h3>๐ฑ Generational Collection</h3>
<p>ูููโุชุฑู ุจูููโุณุงุฒ GC ุงูู ฺฉู <strong>ูุณู (Generational)</strong> ุนูู ูโฺฉูู.</p>
<p>ูุดุงูุฏู ุดุฏู ฺฉู ุฎู ุงุฒ ุงุดุงุก ุณุฑุน ุณุงุฎุชู ู ุณุฑุน ูู ุฑูุง ูโุดูุ ุงูุง ุจุนุถ ุงุฒ ุงุดุงุก <strong>ุทูู ุนูุฑ ุจุดุชุฑ</strong> ุฏุงุฑู ู ูุงุฒ ูุณุช ูุฑ ุจุงุฑ ุจุฑุฑุณ ุจุดู.</p>
<p>ุจู ููู ุฎุงุทุฑุ Heap ุจู ุณู ูุณู ุชูุณู ูโุดู:</p>
<ul>
<li><strong>Gen0</strong> โ ุงุดุงุก ุชุงุฒู ุณุงุฎุชูโุดุฏู.</li>
<li><strong>Gen1</strong> โ ุงุดุงุฆ ฺฉู ฺฉ ฺุฑุฎู GC ุฑู ูพุดุช ุณุฑ ฺฏุฐุงุดุชู.</li>
<li><strong>Gen2</strong> โ ูููโ ุงุดุงุก ุฏฺฏู (ุจููุฏูุฏุช).</li>
</ul>
<blockquote>
<p>Gen0 ู Gen1 ุจูโุนููุงู ูุณูโูุง <strong>Ephemeral (ฺฉูุชุงูโุนูุฑ)</strong> ุดูุงุฎุชู ูโุดู.</p>
</blockquote>
<hr>
<h3>โก ุงูุฏุงุฒู ูุณูโูุง</h3>
<ul>
<li>ุจุฎุด Gen0 ูุนูููุงู ฺฉูฺฺฉู (ฺูุฏ ุตุฏ KB ุชุง ฺูุฏ MB).</li>
<li>ููุช Gen0 ูพุฑ ูโุดูุ ฺฉ <strong>Gen0 Collection</strong> ุงุชูุงู ูโุงูุชู (ุฎู ุณุฑุน ู ุฑุงุฌ).</li>
<li>ููู ููุทู ุจุฑุง Gen1 ูู ูุฌูุฏ ุฏุงุฑู (ูุซู ฺฉ ุจุงูุฑ ุจุฑุง Gen2).</li>
<li>ุงูุง <strong>Full Collection</strong> (ฺฉู ุดุงูู Gen2 ูู ูโุดู) ุฎู ุณูฺฏูโุชุฑู ู ุจูโูุฏุฑุช ุงุชูุงู ูโุงูุชู.</li>
</ul>
<p>๐ ุดฺฉู 12-2 ุฏุฑ ฺฉุชุงุจ ุงุซุฑ ฺฉ Full Collection ุฑู ูุดูู ูโุฏู.</p>
<div align="center">
<p><img src="../../../assets/image/12/Table-12-3.jpeg" alt="Conventions-UsedThis-Book"></p>
</div>
<h2>โก ุณุฑุนุช ุฌูุนโุขูุฑ ูุณูโูุง (Gen0 ู Gen2)</h2>
<p>ุจูโุทูุฑ ุชูุฑุจ:</p>
<ul>
<li>ฺฉ <strong>Gen0 Collection</strong> ูุนูููุงู ฺฉูุชุฑ ุงุฒ <strong>ฑ ููโุซุงูู</strong> ุทูู ูโฺฉุดู ๐ ู ุฏุฑ ฺฉ ุจุฑูุงููโ ุนุงุฏ ุงุตูุงู ูุงุจู ุชูุฌู ูุณุช.</li>
<li>ฺฉ <strong>Full Collection (ุดุงูู Gen2)</strong> ููฺฉูู ุชุง <strong>ฑฐฐ ููโุซุงูู</strong> ุทูู ุจฺฉุดู โณุ ูุฎุตูุตุงู ุฏุฑ ุจุฑูุงููโูุง ุจุง ฺฏุฑุงู ุงุดุงุก ุจุฒุฑฺฏ.</li>
</ul>
<p>ุงู ุงุนุฏุงุฏ ุจุณุชู ุจู ุดุฑุงุท ุฎู ุชุบุฑ ูโฺฉููุ ุจูโูฺู ุฏุฑ ููุฑุฏ <strong>Gen2</strong> ฺฉู ุงูุฏุงุฒูโ ุซุงุจุช ูุฏุงุฑู (ุจุฑุฎูุงู Gen0 ู Gen1).
๐ ูุชุฌู: ุงุดุงุก ฺฉูุชุงูโุนูุฑ ุฎู ุจููู ุจุง GC ฺฉุงุฑ ูโฺฉูู.</p>
<p>ูุซูุงู ุฏุฑ ุงู ูุชุฏุ StringBuilderูุง ฺฉู ุณุงุฎุชู ุดุฏู ุจู ุงุญุชูุงู ุฒุงุฏ ุฎู ุณุฑุน ุชู Gen0 ุฌูุนโุขูุฑ ูโุดู:</p>
<pre><code class="language-csharp">string Foo()
{
  var sb1 = new StringBuilder(&quot;test&quot;);
  sb1.Append(&quot;...&quot;);
  var sb2 = new StringBuilder(&quot;test&quot;);
  sb2.Append(sb1.ToString());
  return sb2.ToString();
}
</code></pre>
<hr>
<h2>๐๏ธ Large Object Heap (LOH)</h2>
<p>GC ฺฉ heap ุฌุฏุงฺฏุงูู ุจุฑุง ุงุดุงุก ุจุฒุฑฺฏโุชุฑ ุงุฒ <strong>ธต,ฐฐฐ ุจุงุช</strong> ุฏุงุฑู.
ูุฏูุด ุงูู ฺฉู:</p>
<ul>
<li>ูุฒููโ ุจุงูุง ุฌุงุจูโุฌุง (Compaction) ุงุดุงุก ุจุฒุฑฺฏ ุฑู ุญุฐู ฺฉูู.</li>
<li>ุฌูู ุชุฑฺฏุฑ ุดุฏู ูฺฉุฑุฑ Gen0 Collection ุฑู ุจฺฏุฑู.</li>
</ul>
<h3>ูฺฺฏโูุง</h3>
<ul>
<li>
<p><strong>ูพุดโูุฑุถ</strong>: LOH ูุดุฑุฏู (Compact) ููโุดูุ ฺูู ุฌุงุจูโุฌุง ุจููฺฉโูุง ุฎู ุจุฒุฑฺฏ ูุฒููโ ุฒุงุฏ ุฏุงุฑู.</p>
</li>
<li>
<p><strong>ูุชุงุฌ</strong>:</p>
<ul>
<li>ุชุฎุตุต ุญุงูุธู ฺฉูุฏุชุฑ ูโุดู ฺูู GC ุจุงุฏ ุชู ูุณุท heap ูู ุฏูุจุงู ุญูุฑูโูุง ุขุฒุงุฏ ุจฺฏุฑุฏู (ุจุง ูุณุช ูพููุฏ).</li>
<li><strong>Fragmentation</strong> ุฑุฎ ูโุฏู: ุขุฒุงุฏ ุดุฏู ฺฉ ุดุก ููฺฉูู ุญูุฑูโุง ุงุฌุงุฏ ฺฉูู ฺฉู ุจุนุฏุงู ุณุฎุช ูพุฑ ุจุดู. ูุซูุงู ุญูุฑูโ ูุฑุจูุท ุจู ุดุก ธถ,ฐฐฐ ุจุงุช ููุท ุจุง ุงุดุงุฆ ูพุฑ ูโุดู ฺฉู ุจู ธต,ฐฐฐ ุชุง ธถ,ฐฐฐ ุจุงุช ุจุงุดู (ูฺฏุฑ ุงูฺฉู ุจุง ุญูุฑูโูุง ุฏฺฏู ฺฉ ุจุดู).</li>
</ul>
</li>
</ul>
<h3>ุฑุงูฺฉุงุฑูุง</h3>
<ol>
<li>
<p>ูุดุฑุฏูโุณุงุฒ LOH ุฏุฑ ุฌูุนโุขูุฑ ุจุนุฏ:</p>
<pre><code class="language-csharp">GCSettings.LargeObjectHeapCompactionMode =
    GCLargeObjectHeapCompactionMode.CompactOnce;
</code></pre>
</li>
<li>
<p>ุงุณุชูุงุฏู ุงุฒ <strong>Array Pooling</strong> (ุตูุญู 599) ุจุฑุง ุจุฑูุงููโูุง ฺฉู ุฒุงุฏ ุขุฑุงูโูุง ุจุฒุฑฺฏ ูโุณุงุฒู.</p>
</li>
</ol>
<p>๐ ูฺฉุชู: LOH ูุณู (Generational) ูุณุชโูููโ ุงุดุงุก LOH ุฏุฑ Gen2 ูุฑุงุฑ ูโฺฏุฑู.</p>
<hr>
<h2>๐ฅ๏ธ Workstation vs Server Collection</h2>
<p>.NET ุฏู ุญุงูุช GC ุงุฑุงุฆู ูโุฏู:</p>
<ul>
<li><strong>Workstation (ูพุดโูุฑุถ)</strong></li>
<li><strong>Server</strong> (ุจุฑุง ูพุฑุฏุงุฒุดโูุง ุณูฺฏู)</li>
</ul>
<p>ูุนุงูโุณุงุฒ ุญุงูุช Server ุฏุฑ <code>.csproj</code>:</p>
<pre><code class="language-xml">&lt;PropertyGroup&gt;
  &lt;ServerGarbageCollection&gt;true&lt;/ServerGarbageCollection&gt;
&lt;/PropertyGroup&gt;
</code></pre>
<p>ู ุฏุฑ ูุงู <code>.runtimeconfig.json</code> ูุงุฏ:</p>
<pre><code class="language-json">&quot;runtimeOptions&quot;: {
  &quot;configProperties&quot;: {
    &quot;System.GC.Server&quot;: true
  }
}
</code></pre>
<h3>ุชูุงูุชโูุง</h3>
<ul>
<li>
<p>ุฏุฑ ุญุงูุช <strong>Server</strong>ุ CLR ุจุฑุง ูุฑ <strong>ูุณุชูโ CPU</strong> ฺฉ Heap ู ฺฉ GC ุฌุฏุง ุฏุฑุณุช ูโฺฉูู.</p>
<ul>
<li>โ ุณุฑุนุช ุจุงูุงุชุฑ ุฏุฑ ุฌูุนโุขูุฑ</li>
<li>โ ูุตุฑู ุจุดุชุฑ ุญุงูุธู ู CPU (ูุฑ ูุณุชู ฺฉ Thread ุงุฎุชุตุงุต ูโุฎูุงุฏ)</li>
</ul>
</li>
<li>
<p>ุฏุฑ ุณุณุชูโูุง ุจุง ูพุฑุฏุงุฒุดโูุง ุฒุงุฏุ ุงู ููุถูุน ูโุชููู ุจุงุนุซ <strong>CPU Oversubscription</strong> ุจุดู โ ุณุณุชู ฺฉูุฏ ู ุบุฑูุงุจูโูพุงุณุฎ ุจู ูุธุฑ ูุงุฏ.</p>
</li>
<li>
<p>ููุท ุฑู ุณุณุชูโูุง <strong>ฺูุฏโูุณุชูโุง</strong> ูุนุงู ูโุดู. ุฑู ุชฺฉโูุณุชูโุงโูุง (ุง VM ุชฺฉโูุณุชูโุง) ูุงุฏุฏู ฺฏุฑูุชู ูโุดู.</p>
</li>
</ul>
<hr>
<h2>๐ Background Collection</h2>
<p>ุฏุฑ ูุฑ ุฏู ุญุงูุช Workstation ู Serverุ ูพุดโูุฑุถ <strong>Background GC</strong> ูุนุงูู.</p>
<p>ูโุชููุฏ ุฏุฑ <code>.csproj</code> ุบุฑูุนุงูุด ฺฉูุฏ:</p>
<pre><code class="language-xml">&lt;PropertyGroup&gt;
  &lt;ConcurrentGarbageCollection&gt;false&lt;/ConcurrentGarbageCollection&gt;
&lt;/PropertyGroup&gt;
</code></pre>
<p>ู ุฏุฑ <code>.runtimeconfig.json</code>:</p>
<pre><code class="language-json">&quot;runtimeOptions&quot;: {
  &quot;configProperties&quot;: {
    &quot;System.GC.Concurrent&quot;: false
  }
}
</code></pre>
<h3>ุงุซุฑุงุช</h3>
<ul>
<li>
<p>ุจุง ูุนุงู ุจูุฏู:</p>
<ul>
<li>ุงูพูฺฉุดู ุฑูุงูโุชุฑู ฺูู <strong>Pauseูุง</strong> ฺฉูุชุงูโุชุฑ ูโุดู.</li>
<li>ูุฒููโ ฺฉู ุฑู CPU ู ุญุงูุธู ุฏุงุฑู.</li>
</ul>
</li>
<li>
<p>ุจุง ุบุฑูุนุงู ุจูุฏู:</p>
<ul>
<li>ูุตุฑู CPU ู ุญุงูุธู ฺฉู ฺฉูุชุฑู.</li>
<li>ูู <strong>ููููโูุง (Latency)</strong> ูููุน GC ุทููุงูโุชุฑ ูโุดู.</li>
</ul>
</li>
</ul>
<p>๐ Background Collection ููุท ุจุฑุง <strong>Gen2</strong> ุจูโฺฉุงุฑ ูโุฑูุ ฺูู Gen0 ู Gen1 ุฎู ุณุฑุน ูุณุชู.</p>
<blockquote>
<p>ุงู ูุณุฎู ุจูุจูุฏโุงูุชูโ <strong>Concurrent Collection</strong> ูุฏููุ ู ูุดฺฉู ูุฏู ูพุฑ ุดุฏู Gen0 ุญู ุงุฌุฑุง Gen2 ุฑู ุญู ฺฉุฑุฏู.</p>
</blockquote>
<hr>
<h2>๐ GC Notifications</h2>
<p>ููุช <strong>Background Collection</strong> ุบุฑูุนุงู ุจุงุดูุ ูโุชููุฏ ุงุฒ GC ุจุฎูุงุฏ <strong>ูุจู ุงุฒ ฺฉ Full GC</strong> ุจูุชูู ุงุทูุงุน ุจุฏู.</p>
<p>๐ ฺฉุงุฑุจุฑุฏ: ุฏุฑ <strong>Server Farms</strong> โ ูุจู ุงุฒ GC ุฏุฑุฎูุงุณุชโูุง ุฑู ุจู ุณุฑูุฑ ุฏฺฏู ุจูุฑุณุชุฏุ ุจุนุฏ GC ุฑู ุงูุฌุงู ุจุฏุฏุ ุณูพุณ ุฏุฑุฎูุงุณุชโูุง ุฑู ุจุฑฺฏุฑุฏููุฏ.</p>
<h3>ูุฑุงุญู</h3>
<ol>
<li>
<p>ุซุจุชโูุงู ุจุฑุง ุงุนูุงู:</p>
<pre><code class="language-csharp">GC.RegisterForFullGCNotification();
</code></pre>
</li>
<li>
<p>ุงุฌุฑุง ฺฉ Thread ฺฉู:</p>
<ul>
<li><code>GC.WaitForFullGCApproach</code> โ ููุช GC ูุฒุฏฺฉู.</li>
<li>ุฏุฑุฎูุงุณุชโูุง ุฑู ุจู ุณุฑูุฑูุง ุฏฺฏู ููุชูู ฺฉูุฏ.</li>
<li>ุฏุณุช <code>GC.Collect()</code> ุฑู ุตุฏุง ุจุฒูุฏ.</li>
<li><code>GC.WaitForFullGCComplete</code> โ ููุช GC ุชููู ุดุฏุ ุฏูุจุงุฑู ุฏุฑุฎูุงุณุชโูุง ุฑู ุจฺฏุฑุฏ.</li>
</ul>
</li>
</ol>
<p>ู ุงู ฺุฑุฎู ุชฺฉุฑุงุฑ ูโุดู.</p>
<h2>๐งน ูุงุฏุงุฑ ฺฉุฑุฏู Garbage Collection</h2>
<p>ุดูุง ูโุชููุฏ ูุฑ ุฒูุงู ุจูโุตูุฑุช ุฏุณุช <strong>GC.Collect</strong> ุฑู ุตุฏุง ุจุฒูุฏ ุชุง ฺฉ Garbage Collection ุงูุฌุงู ุจุดู.</p>
<ul>
<li>ุจุฏูู ุขุฑฺฏููุงู: ฺฉ <strong>Full Collection</strong> ุงุฌุฑุง ูโุดู.</li>
<li>ุจุง ุนุฏุฏ (ูุซู <code>GC.Collect(0)</code>): ููุท ุชุง ูููู ูุณู ุฌูุนโุขูุฑ ูโุดู โ ุงูุฌุง ููุท <strong>Gen0</strong> ุจูโุณุฑุนุช ูพุงฺฉโุณุงุฒ ูโุดู.</li>
</ul>
<p>๐ ุชูุตู:
ูุนูููุงู ุจูุชุฑู ุจุฐุงุฑุฏ ุฎูุฏ <strong>GC</strong> ุฒูุงู ููุงุณุจ ุฌูุนโุขูุฑ ุฑู ุชุดุฎุต ุจุฏู. ฺูู:</p>
<ul>
<li>ููฺฉูู ุจุงุนุซ <strong>ุงุฑุชูุงุก ุบุฑุถุฑูุฑ</strong> ุงุดุงุก ุจุดู (Gen0 โ Gen1ุ ุง Gen1 โ Gen2).</li>
<li>ูโุชููู ุชูุธูุงุช ุฎูุฏฺฉุงุฑ ู ููุดููุฏ GC ุฑู ุจูโูู ุจุฒูู.</li>
</ul>
<h3>ุงุณุชุซูุงูุง</h3>
<p>ฺฉ ุณูุงุฑู ุฑุงุฌ: ููุช ุจุฑูุงูู ุจุฑุง ูุฏุช <strong>ุจู ุฎูุงุจ ูโุฑู</strong>.
ูุซุงู: ฺฉ <strong>Windows Service</strong> ฺฉู ุฑูุฒ ฺฉโุจุงุฑ ุงุฌุฑุง ูโุดู. ุจุนุฏ ุงุฒ ุงุฌุฑุง ูุนุงูุช ุฑูุฒุงูู (ูุซูุงู ุจุฑุฑุณ ุขูพุฏุชโูุง)ุ ุจูโูุฏุช ฒด ุณุงุนุช ุฏฺฏู ูฺ ฺฉุงุฑ ุงูุฌุงู ููโุฏู. ฺูู ูฺ ุชุฎุตุต ุญุงูุธูโุง ุงุชูุงู ููโุงูุชูุ GC ูู ูุนุงู ููโุดู. ุฏุฑ ุงู ุญุงูุช ุญุงูุธูโุง ฺฉู ูุตุฑู ุดุฏู ุจุฑุง ฺฉู ฒด ุณุงุนุช ุขุฒุงุฏ ููโุดูโeven ุงฺฏุฑ ฺฏุฑุงู ุงุดุงุก ุฎุงู ุจุงุดู!</p>
<p>โ ุฑุงูโุญู:
ุจูุงูุงุตูู ุจุนุฏ ุงุฒ ุงูุฌุงู ูุนุงูุช ุฑูุฒุงููุ ุตุฏุง ุจุฒูุฏ:</p>
<pre><code class="language-csharp">GC.Collect();
GC.WaitForPendingFinalizers();
GC.Collect();
</code></pre>
<p>ุงู ุชุถูู ูโฺฉูู ุญุช ุงุดุงุฆ ฺฉู Finalizer ุฏุงุฑู ูู ูพุงฺฉ ุจุดู. (ฺฏุงู ุฏุงุฎู ฺฉ ุญููู ุงุฌุฑุง ูโุดู ฺูู ุงุฌุฑุง Finalizerูุง ุฎูุฏุด ุจุงุนุซ ุขุฒุงุฏ ุดุฏู ุงุดุงุก ุจุดุชุฑ ูโุดู).</p>
<p>๐ ููุฑุฏ ุฏฺฏู: ููุช ุฏุงุฑุฏ ฺฉูุงุณ ุจุง <strong>Finalizer</strong> ุฑู ุชุณุช ูโฺฉูุฏ.</p>
<hr>
<h2>โ๏ธ ุชูุธู Garbage Collection ุฏุฑ ุฒูุงู ุงุฌุฑุง</h2>
<p>ุชูุธู ุจุง <code>GCSettings.LatencyMode</code>:</p>
<ul>
<li><strong>Interactive (ูพุดโูุฑุถ)</strong> โ ุชุนุงุฏู ุจู ูพุงุณุฎโุฏู ู ฺฉุงุฑุง.</li>
<li><strong>LowLatency</strong> ุง <strong>SustainedLowLatency</strong> โ ุฌูุนโุขูุฑ ุณุฑุนโุชุฑ ูู ูฺฉุฑุฑุชุฑ โ ููุงุณุจ ุจุฑุง ุงูพูฺฉุดูโูุง Real-Time โก.</li>
<li><strong>Batch</strong> โ ุจุดุชุฑู Throughputุ ูู ูพุงุณุฎโุฏู ุถุนูโุชุฑ โ ููุงุณุจ ูพุฑุฏุงุฒุดโูุง Batch.</li>
</ul>
<p>๐ ูฺฉุชู: ุงฺฏุฑ Background GC ุบุฑูุนุงู ุจุงุดูุ ุญุงูุช <strong>SustainedLowLatency</strong> ูพุดุชุจุงู ููโุดู.</p>
<p>ููฺูู ูโุชููุฏ:</p>
<ul>
<li>ูููุชุงู GC ุฑู ูุชููู ฺฉูุฏ: <code>GC.TryStartNoGCRegion()</code></li>
<li>ุฏูุจุงุฑู ูุนุงู ฺฉูุฏ: <code>GC.EndNoGCRegion()</code></li>
</ul>
<hr>
<h2>๐ Memory Pressure</h2>
<p>ุฒูุงู ุงุฌุฑุง CLR ุชุตูู ูโฺฏุฑู ฺฉ GC ุงูุฌุงู ุจุฏูุ ุจุฑ ุงุณุงุณ ูุงฺฉุชูุฑูุง ูุซู <strong>ุจุงุฑ ุญุงูุธูโ ฺฉู ุณุณุชู</strong>.</p>
<p>ุงูุง ุงฺฏุฑ ุจุฑูุงููโุชูู <strong>ุญุงูุธูโ Unmanaged</strong> ุชุฎุตุต ุจุฏู (ูุซู P/Invoke ุง Native Code)ุ CLR ููุท ุงุฒ Managed Memory ุฎุจุฑ ุฏุงุฑู โ ุนู ูุฒุงู ูุตุฑู ูุงูุน ุญุงูุธู ฺฉูุชุฑ ุงุฒ ฺุฒ ฺฉู ูุณุช ูุดูู ุฏุงุฏู ูโุดู.</p>
<p>ุฑุงูโุญู:</p>
<ul>
<li>
<p>ุจู CLR ุงุนูุงู ฺฉูุฏ ฺฉู ุญุงูุธูโ Unmanaged ุชุฎุตุต ุฏุงุฏู ุดุฏู:</p>
<pre><code class="language-csharp">GC.AddMemoryPressure(size);
</code></pre>
</li>
<li>
<p>ููุช ุขุฒุงุฏ ุดุฏ:</p>
<pre><code class="language-csharp">GC.RemoveMemoryPressure(size);
</code></pre>
</li>
</ul>
<hr>
<h2>๐ Array Pooling</h2>
<p>ุงฺฏุฑ ุฒุงุฏ ุขุฑุงู ูโุณุงุฒุฏุ ูโุชููุฏ ุจุง <strong>Array Pooling</strong> ุจุงุฑ GC ุฑู ฺฉู ฺฉูุฏ. ุงู ูุงุจูุช ุงุฒ .NET Core 3 ูุนุฑู ุดุฏ.</p>
<ul>
<li>
<p>ุงุฌุงุฑูโ ุขุฑุงู:</p>
<pre><code class="language-csharp">int[] pooledArray = ArrayPool&lt;int&gt;.Shared.Rent(100); // ุญุฏุงูู 100 ุจุงุช
</code></pre>
<p>(ููฺฉูู ุขุฑุงูโุง ุจุฒุฑฺฏโุชุฑ ุจุฑฺฏุฑุฏูุ ูุนูููุงู ุฏุฑ ุชูุงูโูุง ฒ ุชุฎุตุต ุฏุงุฏู ูโุดู).</p>
</li>
<li>
<p>ุจุฑฺฏุฑุฏุงูุฏู ุขุฑุงู:</p>
<pre><code class="language-csharp">ArrayPool&lt;int&gt;.Shared.Return(pooledArray);
</code></pre>
<p>(ูโุชููุฏ ฺฉ <code>bool</code> ูู ุจุฏุฏ ฺฉู ูุจู ุงุฒ ุจุงุฒฺฏุดุชุ ุขุฑุงู ูพุงฺฉ ุจุดู).</p>
</li>
</ul>
<p>๐ ูุญุฏูุฏุช:
ุงฺฏุฑ ุจุนุฏ ุงุฒ Return ููฺูุงู ุงุฒ ุขุฑุงู ุงุณุชูุงุฏู ฺฉูุฏ โ ุฎุทุง ุฌุฏ ุฑุฎ ูโุฏู โ. ฺูู ููฺฉูู ุชูุณุท APIูุง ุฏฺฏู ูุซู <strong>ASP.NET Core</strong> ุฏูุจุงุฑู ุงุณุชูุงุฏู ุจุดู.</p>
<hr>
<h2>๐๏ธ Pool ุงุฎุชุตุงุต</h2>
<p>ุจูโุฌุง Pool ุงุดุชุฑุงฺฉ ูโุชููุฏ Pool ุดุฎุต ุจุณุงุฒุฏ:</p>
<pre><code class="language-csharp">var myPool = ArrayPool&lt;int&gt;.Create();
int[] array = myPool.Rent(100);
...
</code></pre>
<p>ุงู ฺฉุงุฑ:</p>
<ul>
<li>โ ุฑุณฺฉ ุฎุฑุงุจ ฺฉุฑุฏู APIูุง ุฏฺฏู ุฑู ฺฉู ูโฺฉูู.</li>
<li>โ ูู ูุตุฑู ุญุงูุธูโ ฺฉู ุฑู ุจุงูุง ูโุจุฑู (ฺูู ูุฑุตุชโูุง Reuse ฺฉูโุชุฑ ูโุดู).</li>
</ul>
<p>๐พ <strong>ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู (Managed Memory Leaks)</strong></p>
<p>ุฏุฑ ุฒุจุงูโูุง unmanaged ูุงููุฏ C++ุ ุดูุง ุจุงุฏ ุจูโุตูุฑุช ุฏุณุช ุญุงูุธู ุฑุง ุฒูุงู ฺฉู ฺฉ ุดุก ุฏฺฏุฑ ูุงุฒ ูุณุช ุขุฒุงุฏ ฺฉูุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ูุดุช ุญุงูุธู ุฑุฎ ูโุฏูุฏ. ุฏุฑ ุฏูุง managedุ ุงู ููุน ุฎุทุง ุจูโุฏูู ุณุณุชู <strong>garbage collection</strong> ุฎูุฏฺฉุงุฑ <strong>CLR</strong> ุบุฑููฺฉู ุงุณุช.</p>
<p>ุจุง ุงู ุญุงูุ ุจุฑูุงููโูุง ุจุฒุฑฺฏ ู ูพฺุฏู .NET ูโุชูุงููุฏ ููุน ูุฑู ุฎูู ุงุฒ ููู ูุดฺฉู ุฑุง ูุดุงู ุฏููุฏ ฺฉู ูุชุฌู ุขู ูุดุงุจู ุงุณุช: ุจุฑูุงูู ุฏุฑ ุทูู ุนูุฑ ุฎูุฏ ุญุงูุธู ุจุดุชุฑ ูุตุฑู ูโฺฉูุฏ ุชุง ููุงุชุงู ูุงุฒ ุจู ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ ูพุฏุง ฺฉูุฏ. ุฎุจุฑ ุฎูุจ ุงู ุงุณุช ฺฉู <strong>ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู</strong> ูุนูููุงู ุฑุงุญุชโุชุฑ ูุงุจู ุชุดุฎุต ู ูพุดฺฏุฑ ุงุณุช.</p>
<p>ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู ุฒูุงู ุฑุฎ ูโุฏูุฏ ฺฉู ุงุดุงุก ุงุณุชูุงุฏูโูุดุฏู ุจูโูุงุณุทู ูุฑุงุฌุน ูุฑุงููุดโุดุฏู ุง ุงุณุชูุงุฏูโูุดุฏู ูููุฒ ุฒูุฏู ุจูุงููุฏ. ฺฉ ููููู ุฑุงุฌ <strong>event handlers</strong> ูุณุชูุฏโุงูโูุง ฺฉ ูุฑุฌุน ุจู ุดุก ูุฏู ูฺฏู ูโุฏุงุฑูุฏ (ูฺฏุฑ ุงูฺฉู ูุฏู ฺฉ ูุชุฏ static ุจุงุดุฏ). ุจูโุนููุงู ูุซุงูุ ฺฉูุงุณโูุง ุฒุฑ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:</p>
<pre><code class="language-csharp">class Host
{
 public event EventHandler Click;
}

class Client
{
 Host _host;
 public Client (Host host)
 {
   _host = host;
   _host.Click += HostClicked;
 }
 void HostClicked (object sender, EventArgs e) { ... }
}
</code></pre>
<p>ฺฉูุงุณ ุชุณุช ุฒุฑ ฺฉ ูุชุฏ ุฏุงุฑุฏ ฺฉู ฑฐฐฐ ุดุก Client ุงุฌุงุฏ ูโฺฉูุฏ:</p>
<pre><code class="language-csharp">class Test
{
 static Host _host = new Host();
 public static void CreateClients()
 {
   Client[] clients = Enumerable.Range(0, 1000)
     .Select(i =&gt; new Client(_host))
     .ToArray();
   // ุงูุฌุงู ฺฉุงุฑ ุจุง clients ...
 }
}
</code></pre>
<p>ููฺฉู ุงุณุช ุงูุชุธุงุฑ ุฏุงุดุชู ุจุงุดุฏ ูพุณ ุงุฒ ุงุฌุฑุง <strong>CreateClients</strong>ุ ุงู ฑฐฐฐ ุดุก Client ูุงุฌุฏ ุดุฑุงุท ุฌูุนโุขูุฑ ุดููุฏ. ูุชุฃุณูุงููุ ูุฑ Client ฺฉ ูุฑุฌุน ุฏฺฏุฑ ูู ุฏุงุฑุฏ: ุดุก <strong>_host</strong> ฺฉู event <strong>Click</strong> ูุฑ ููููู Client ุฑุง ูฺฏู ูโุฏุงุฑุฏ.</p>
<p>ุงู ูุดฺฉู ููฺฉู ุงุณุช ูุงุฏุฏู ฺฏุฑูุชู ุดูุฏ ุงฺฏุฑ event <strong>Click</strong> ุงุฌุฑุง ูุดูุฏ ุง ูุชุฏ <strong>HostClicked</strong> ฺฉุงุฑ ุงูุฌุงู ูุฏูุฏ ฺฉู ุชูุฌู ุฑุง ุฌูุจ ฺฉูุฏ.</p>
<p>ฺฉ ุงุฒ ุฑุงูโุญูโูุง ุงู ุงุณุช ฺฉู <strong>Client</strong> ุฑุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ ุชุง <strong>IDisposable</strong> ุจุงุดุฏ ู ุฏุฑ ูุชุฏ <strong>Dispose</strong>ุ <strong>event handler</strong> ุฑุง ูุบู ุงุดุชุฑุงฺฉ ฺฉูุฏ:</p>
<pre><code class="language-csharp">public void Dispose() { _host.Click -= HostClicked; }
</code></pre>
<p>ุณูพุณ ูุตุฑูโฺฉููุฏฺฏุงู Client ูพุณ ุงุฒ ุงุชูุงู ุงุณุชูุงุฏู ุงุฒ ูููููโูุง ุขูโูุง ุฑุง Dispose ูโฺฉููุฏ:</p>
<pre><code class="language-csharp">Array.ForEach(clients, c =&gt; c.Dispose());
</code></pre>
<hr>
<p>โฑ <strong>Timers</strong></p>
<p>ุฏุฑ ุจุฎุด ยซWeak Referencesยป ุฏุฑ ุตูุญู 603ุ ุฑุงูโุญู ุฏฺฏุฑ ุจุฑุง ุงู ูุดฺฉู ุงุฑุงุฆู ุดุฏู ุงุณุช ฺฉู ุฏุฑ ูุญุทโูุง ฺฉู ุชูุงู ุจู ุงุณุชูุงุฏู ุงุฒ ุงุดุงุก disposable ูุฏุงุฑูุฏ (ูุซูุงู <strong>WPF</strong>) ููุฏ ุงุณุช. ุฏุฑ ูุงูุนุ WPF ฺฉ ฺฉูุงุณ ุจู ูุงู <strong>WeakEventManager</strong> ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุงุฒ ุงูฺฏู weak references ุงุณุชูุงุฏู ูโฺฉูุฏ.</p>
<p>ุชุงูุฑูุง ูุฑุงููุดโุดุฏู ูุฒ ูโุชูุงููุฏ ุจุงุนุซ ูุดุช ุญุงูุธู ุดููุฏ (ุฏุฑ ูุตู 21 ุชุงูุฑูุง ุฑุง ุจุฑุฑุณ ฺฉุฑุฏูโุงู). ุฏู ุณูุงุฑู ูุชูุงูุช ูุฌูุฏ ุฏุงุฑุฏุ ุจุณุชู ุจู ููุน ุชุงูุฑ:</p>
<p>ุงุจุชุฏุง ุชุงูุฑ ุฏุฑ <strong>System.Timers</strong> ุฑุง ุจุฑุฑุณ ูโฺฉูู. ุฏุฑ ูุซุงู ุฒุฑุ ฺฉูุงุณ <strong>Foo</strong> (ููฺฏุงู ูููููโุณุงุฒ) ูุฑ ุซุงูู ูุชุฏ <strong>tmr_Elapsed</strong> ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ:</p>
<pre><code class="language-csharp">using System.Timers;
class Foo
{
 Timer _timer;
 Foo() 
 {
   _timer = new System.Timers.Timer { Interval = 1000 };
   _timer.Elapsed += tmr_Elapsed;
   _timer.Start();
 }
 void tmr_Elapsed(object sender, ElapsedEventArgs e) { ... }
}
</code></pre>
<p>ูุชุฃุณูุงููุ ูููููโูุง Foo ูุฑฺฏุฒ ุฌูุนโุขูุฑ ููโุดููุฏ! ูุดฺฉู ุงู ุงุณุช ฺฉู runtime ุฎูุฏุด ุจู ุชุงูุฑูุง ูุนุงู ูุฑุฌุน ุฏุงุฑุฏ ุชุง ุจุชูุงูุฏ event <strong>Elapsed</strong> ุขูโูุง ุฑุง ุงุฌุฑุง ฺฉูุฏุ ุจูุงุจุฑุงู:</p>
<ul>
<li>runtime ุดุก <strong>_timer</strong> ุฑุง ุฒูุฏู ูฺฏู ูโุฏุงุฑุฏ.</li>
<li><strong>_timer</strong> ุดุก Foo ุฑุง ุงุฒ ุทุฑู <strong>tmr_Elapsed</strong> ุฒูุฏู ูฺฏู ูโุฏุงุฑุฏ.</li>
</ul>
<p>ุฑุงู ุญู ูุงุถุญ ุงุณุช: ฺูู <strong>Timer</strong> ูพุงุฏูโุณุงุฒ <strong>IDisposable</strong> ุฏุงุฑุฏุ ุจุง Dispose ฺฉุฑุฏู ุชุงูุฑุ ุงุฌุฑุง ุขู ูุชููู ุดุฏู ู runtime ุฏฺฏุฑ ุจู ุดุก ูุฑุฌุน ูุฏุงุฑุฏ:</p>
<pre><code class="language-csharp">class Foo : IDisposable
{
 ...
 public void Dispose() { _timer.Dispose(); }
}
</code></pre>
<p>ฺฉ ุฏุณุชูุฑุงูุนูู ุฎูุจ ุงู ุงุณุช ฺฉู ุงฺฏุฑ ูุฑ ููุฏ ุฏุฑ ฺฉูุงุณ ุดูุง ุจู ุดุฆ ุงุฎุชุตุงุต ุฏุงุฑุฏ ฺฉู <strong>IDisposable</strong> ุฑุง ูพุงุฏูโุณุงุฒ ฺฉุฑุฏูุ ุฎูุฏุชุงู IDisposable ุฑุง ูพุงุฏูโุณุงุฒ ฺฉูุฏ.</p>
<p>ุชุงูุฑูุง <strong>WPF</strong> ู <strong>Windows Forms</strong> ูุฒ ุจู ููู ุดฺฉู ุฑูุชุงุฑ ูโฺฉููุฏ.</p>
<p>ุชุงูุฑ ุฏุฑ <strong>System.Threading</strong>ุ ุจุง ุงู ุญุงูุ ุฎุงุต ุงุณุช. .NET ุจู ุชุงูุฑูุง threading ูุนุงู ูุฑุฌุน ูุฏุงุฑุฏุ ุจูฺฉู ูุณุชููุงู delegateโูุง callback ุฑุง ูุฑุฌุน ูโฺฉูุฏ. ุงู ุจุฏุงู ูุนูุงุณุช ฺฉู ุงฺฏุฑ Dispose ฺฉุฑุฏู ุชุงูุฑ threading ูุฑุงููุด ุดูุฏุ ฺฉ finalizer ูโุชูุงูุฏ ุงุฌุฑุง ุดูุฏ ู ุชุงูุฑ ุฑุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ูุชููู ู Dispose ฺฉูุฏ:</p>
<pre><code class="language-csharp">static void Main()
{
 var tmr = new System.Threading.Timer(TimerTick, null, 1000, 1000);
 GC.Collect();
 System.Threading.Thread.Sleep(10000); // ุตุจุฑ 10 ุซุงูู
}

static void TimerTick(object notUsed) { Console.WriteLine(&quot;tick&quot;); }
</code></pre>
<p>ุงฺฏุฑ ุงู ูุซุงู ุฏุฑ ุญุงูุช release (debug ุบุฑูุนุงู ู ุจูููโุณุงุฒ ูุนุงู) ฺฉุงููพุงู ุดูุฏุ ุชุงูุฑ ูุจู ุงุฒ ุงูฺฉู ฺฉ ุจุงุฑ ูู ุงุฌุฑุง ุดูุฏุ ุฌูุนโุขูุฑ ู ููุง ุฎูุงูุฏ ุดุฏ!</p>
<p>ุฏูุจุงุฑูุ ุงู ูุดฺฉู ุจุง Dispose ฺฉุฑุฏู ุชุงูุฑ ููฺฏุงู ุงุชูุงู ุงุณุชูุงุฏู ุจุฑุทุฑู ูโุดูุฏ:</p>
<pre><code class="language-csharp">using (var tmr = new System.Threading.Timer(TimerTick, null, 1000, 1000))
{
 GC.Collect();
 System.Threading.Thread.Sleep(10000); // ุตุจุฑ 10 ุซุงูู
}
</code></pre>
<p>ูุฑุงุฎูุงู ุถูู <strong>tmr.Dispose</strong> ุฏุฑ ูพุงุงู <strong>using</strong> ุจุงุนุซ ูโุดูุฏ ฺฉู ูุชุบุฑ <strong>tmr</strong> โุงุณุชูุงุฏูโุดุฏูโ ุฏุฑ ูุธุฑ ฺฏุฑูุชู ุดูุฏ ู ุชุง ูพุงุงู ุจููฺฉ ุชูุณุท GC ูุฑุฏู ูุญุณูุจ ูุดูุฏ.</p>
<p>ุทูุฒ ุงู ุงุณุช ฺฉู ุงู ูุฑุงุฎูุงู Dispose ุฏุฑ ูุงูุน ุนูุฑ ุดุก ุฑุง ุทููุงูโุชุฑ ูโฺฉูุฏ! ๐ฏ</p>
<p>๐ต๏ธโโ๏ธ <strong>ุชุดุฎุต ูุดุช ุญุงูุธู (Diagnosing Memory Leaks)</strong></p>
<p>ุณุงุฏูโุชุฑู ุฑุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ <strong>ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู</strong> ุงู ุงุณุช ฺฉู ุงุฒ ููุงู ุงุจุชุฏุง ูุตุฑู ุญุงูุธู ุฑุง ุฏุฑ ุญู ููุดุชู ุจุฑูุงูู ุชุญุช ูุธุฑ ุฏุงุดุชู ุจุงุดุฏ. ูโุชูุงูุฏ ูุตุฑู ูุนู ุญุงูุธู ุงุดุงุก ุจุฑูุงูู ุฑุง ุจู ุงู ุตูุฑุช ุจูโุฏุณุช ุขูุฑุฏ (ุขุฑฺฏููุงู <strong>true</strong> ุจู GC ูโฺฏูุฏ ุงุจุชุฏุง ฺฉ ุฌูุนโุขูุฑ ุงูุฌุงู ุฏูุฏ):</p>
<pre><code class="language-csharp">long memoryUsed = GC.GetTotalMemory(true);
</code></pre>
<p>ุงฺฏุฑ ุงุฒ ุชูุณุนู ูุจุชู ุจุฑ ุชุณุช (<strong>test-driven development</strong>) ุงุณุชูุงุฏู ูโฺฉูุฏุ ูโุชูุงูุฏ ุงุฒ <strong>unit test</strong>ูุง ุจุฑุง ุงุทููุงู ุงุฒ ุขุฒุงุฏ ุดุฏู ุญุงูุธู ุงุณุชูุงุฏู ฺฉูุฏ. ุงฺฏุฑ ุงู ุจุฑุฑุณ ุดฺฉุณุช ุฎูุฑุฏุ ููุท ฺฉุงู ุงุณุช ุชุบุฑุงุช ุงุฎุฑ ุฎูุฏ ุฑุง ุจุฑุฑุณ ฺฉูุฏ.</p>
<p>ุงฺฏุฑ ูุจูุงู ฺฉ ุจุฑูุงูู ุจุฒุฑฺฏ ุจุง <strong>ูุดุช ุญุงูุธู ูุฏุฑุชโุดุฏู</strong> ุฏุงุฑุฏุ ุงุจุฒุงุฑ <strong>windbg.exe</strong> ูโุชูุงูุฏ ฺฉูฺฉโฺฉููุฏู ุจุงุดุฏ. ููฺูู ุงุจุฒุงุฑูุง ฺฏุฑุงูฺฉ ุฏูุณุชุงููโุชุฑ ูุงููุฏ <strong>CLR Profiler</strong> ูุงฺฉุฑูุณุงูุชุ <strong>Memory Profiler</strong> ุดุฑฺฉุช SciTech ู <strong>ANTS Memory Profiler</strong> ุดุฑฺฉุช Red Gate ูุฒ ููุฌูุฏ ูุณุชูุฏ.</p>
<p><strong>CLR</strong> ููฺูู ุดูุงุฑูุฏูโูุง ุฑูุฏุงุฏ ูุฎุชูู ุงุฑุงุฆู ูโุฏูุฏ ุชุง ุฏุฑ ูุธุงุฑุช ุจุฑ ููุงุจุน ฺฉูฺฉ ฺฉูุฏ.</p>
<hr>
<p>๐ <strong>Weak References</strong></p>
<p>ฺฏุงู ุงููุงุช ููุฏ ุงุณุช ฺฉู ฺฉ ูุฑุฌุน ุจู ุดุฆ ุฏุงุดุชู ุจุงุดู ฺฉู ุจุฑุง <strong>GC</strong> ยซูุงูุฑุฆยป ุจุงุดุฏ ู ูุงูุน ุฌูุนโุขูุฑ ุขู ูุดูุฏ. ุงู ููุน ูุฑุฌุน ุฑุง <strong>weak reference</strong> ูโูุงููุฏ ู ุจุง ฺฉูุงุณ <strong>System.WeakReference</strong> ูพุงุฏูโุณุงุฒ ูโุดูุฏ.</p>
<p>ุจุฑุง ุงุณุชูุงุฏู ุงุฒ <strong>WeakReference</strong>ุ ุขู ุฑุง ุจุง ุดุก ูุฏู ุงุฌุงุฏ ฺฉูุฏ:</p>
<pre><code class="language-csharp">var sb = new StringBuilder(&quot;this is a test&quot;);
var weak = new WeakReference(sb);
Console.WriteLine(weak.Target); // This is a test
</code></pre>
<p>ุงฺฏุฑ ุดุก ูุฏู ุชููุง ุชูุณุท ฺฉ ุง ฺูุฏ <strong>weak reference</strong> ูุฑุฌุน ุดูุฏุ GC ุขู ุฑุง ูุงุฌุฏ ุดุฑุงุท ุฌูุนโุขูุฑ ูโุฏุงูุฏ. ูพุณ ุงุฒ ุฌูุนโุขูุฑุ ูฺฺฏ <strong>Target</strong> ุจุฑุงุจุฑ <strong>null</strong> ุฎูุงูุฏ ุจูุฏ:</p>
<pre><code class="language-csharp">var weak = GetWeakRef();
GC.Collect();
Console.WriteLine(weak.Target); // (nothing)

WeakReference GetWeakRef() =&gt; new WeakReference(new StringBuilder(&quot;weak&quot;));
</code></pre>
<p>ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฌูุนโุขูุฑ ูุฏู ุจู ุจุฑุฑุณ null ู ุงุณุชูุงุฏู ุงุฒ ุขูุ ุขู ุฑุง ุจู ฺฉ ูุชุบุฑ ูุญู ุงุฎุชุตุงุต ุฏูุฏ:</p>
<pre><code class="language-csharp">var sb = (StringBuilder)weak.Target;
if (sb != null) { /* ุงุณุชูุงุฏู ุงุฒ sb */ }
</code></pre>
<p>ูพุณ ุงุฒ ุงุฎุชุตุงุต ูุฏู ุจู ฺฉ ูุชุบุฑ ูุญูุ ุขู ฺฉ <strong>strong root</strong> ูพุฏุง ูโฺฉูุฏ ู ุชุง ุฒูุงู ฺฉู ูุชุบุฑ ุฏุฑ ุงุณุชูุงุฏู ุจุงุดุฏุ ุฌูุนโุขูุฑ ููโุดูุฏ.</p>
<p>ฺฉูุงุณ ุฒุฑ ุงุฒ <strong>weak references</strong> ุจุฑุง ูพฺฏุฑ ููู ุงุดุงุก <strong>Widget</strong> ฺฉู ุงุฌุงุฏ ุดุฏูโุงูุฏ ุงุณุชูุงุฏู ูโฺฉูุฏุ ุจุฏูู ุงูฺฉู ูุงูุน ุฌูุนโุขูุฑ ุขูโูุง ุดูุฏ:</p>
<pre><code class="language-csharp">class Widget
{
 static List&lt;WeakReference&gt; _allWidgets = new List&lt;WeakReference&gt;();
 public readonly string Name;
 public Widget(string name)
 {
   Name = name;
   _allWidgets.Add(new WeakReference(this));
 }
 public static void ListAllWidgets()
 {
   foreach (WeakReference weak in _allWidgets)
   {
     Widget w = (Widget)weak.Target;
     if (w != null) Console.WriteLine(w.Name);
   }
 }
}
</code></pre>
<p>ุชููุง ูฺฉุชู ุงู ุงุณุช ฺฉู ุงู <strong>static list</strong> ุจุง ฺฏุฐุดุช ุฒูุงู ุฑุดุฏ ูโฺฉูุฏ ู <strong>weak references</strong> ุจุง <strong>target null</strong> ุฌูุน ูโุดููุฏ. ุจูุงุจุฑุงูุ ุจุงุฏ ฺฉ <strong>ุงุณุชุฑุงุชฺ ูพุงฺฉุณุงุฒ</strong> ูพุงุฏูโุณุงุฒ ฺฉูุฏ.</p>
<hr>
<p>๐พ <strong>Weak References ู Caching</strong></p>
<p>ฺฉ ุงุฒ ฺฉุงุฑุจุฑุฏูุง <strong>WeakReference</strong>ุ <strong>cache ฺฉุฑุฏู ุงุดุงุก ุจุฒุฑฺฏ</strong> ุงุณุช. ุงู ุฑูุด ุงุฌุงุฒู ูโุฏูุฏ ุฏุงุฏูโูุง ูพุฑุญุฌู ุจู ุทูุฑ ูููุช ุฐุฎุฑู ุดููุฏ ุจุฏูู ุงูฺฉู ูุตุฑู ุญุงูุธู ุจุด ุงุฒ ุญุฏ ุดูุฏ:</p>
<pre><code class="language-csharp">_weakCache = new WeakReference(...); // _weakCache ฺฉ ููุฏ ุงุณุช
...
var cache = _weakCache.Target;
if (cache == null) { /* cache ุฑุง ุฏูุจุงุฑู ุงุฌุงุฏ ู ุจู _weakCache ุงุฎุชุตุงุต ุฏูุฏ */ }
</code></pre>
<p>ุงู ุงุณุชุฑุงุชฺ ุฏุฑ ุนูู ููุท ุชุง ุญุฏ ูุคุซุฑ ุงุณุชุ ุฒุฑุง ุดูุง ฺฉูุชุฑู ุจุฑ ุฒูุงู ุงุฌุฑุง GC ู ูุณู ุฌูุนโุขูุฑ ุดุฏู ูุฏุงุฑุฏ. ุจูโูฺู ุงฺฏุฑ cache ุดูุง ุฏุฑ <strong>Gen0</strong> ุจุงุดุฏุ ููฺฉู ุงุณุช ุธุฑู ูฺฉุฑูุซุงูู ุฌูุนโุขูุฑ ุดูุฏ. ุจูุงุจุฑุงูุ ุจูุชุฑ ุงุณุช ุงุฒ <strong>cache ุฏู ุณุทุญ</strong> ุงุณุชูุงุฏู ฺฉูุฏ: ุงุจุชุฏุง ุจุง <strong>strong references</strong> ุดุฑูุน ฺฉูุฏ ู ุณูพุณ ุจู <strong>weak references</strong> ุชุจุฏู ฺฉูุฏ.</p>
<hr>
<p>๐ <strong>Weak References ู Events</strong></p>
<p>ูุจูุงู ุฏุฏู ฺฉู <strong>events</strong> ูโุชูุงููุฏ ุจุงุนุซ ูุดุช ุญุงูุธู ุดููุฏ. ุณุงุฏูโุชุฑู ุฑุงู ุญู ุงู ุงุณุช ฺฉู ุงุฒ subscribe ุฏุฑ ฺูู ุดุฑุงุท ุงุฌุชูุงุจ ฺฉูุฏ ุง ฺฉ ูุชุฏ <strong>Dispose</strong> ุจุฑุง unsubscribe ูพุงุฏูโุณุงุฒ ฺฉูุฏ. <strong>Weak references</strong> ุฑุงู ุญู ุฏฺฏุฑ ุงุฑุงุฆู ูโุฏููุฏ.</p>
<p>ุชุตูุฑ ฺฉูุฏ ฺฉ <strong>delegate</strong> ฺฉู ููุท <strong>weak references</strong> ุจู ุงูุฏุงู ุฎูุฏ ูฺฏู ูโุฏุงุฑุฏ. ฺูู delegateโุง ุงูุฏุงู ุฑุง ุฒูุฏู ูฺฏู ููโุฏุงุฑุฏโูฺฏุฑ ุงูฺฉู ุขู ุงูุฏุงู ูุฑุฌุน ูุณุชูู ุฏุงุดุชู ุจุงุดูุฏ. ุงูุจุชู ุงู ูุงูุน ุงุฌุฑุง delegate ููโุดูุฏ ฺฉู ููฺฉู ุงุณุช ุจู ูุฏู ุจุฏูู ูุฑุฌุน ุจุฑุณุฏุ ุจู ุฒูุงู ฺฉู ูุฏู ูุงุฌุฏ ุดุฑุงุท ุฌูุนโุขูุฑ ุดุฏู ู GC ูููุฒ ุขู ุฑุง ุฌูุนโุขูุฑ ูฺฉุฑุฏู ุงุณุช.</p>
<p>ุจุฑุง ุงูฺฉู ฺูู ุฑุงูโุญู ูุคุซุฑ ุจุงุดุฏุ ฺฉุฏ ุดูุง ุจุงุฏ ุฏุฑ ุงู ุณูุงุฑู ููุงูู ุจุงุดุฏ. ุฏุฑ ุงู ุตูุฑุช ูโุชูุงูุฏ ฺฉูุงุณ <strong>weak delegate</strong> ุฑุง ุจู ุงู ุดฺฉู ูพุงุฏูโุณุงุฒ ฺฉูุฏ:</p>
<pre><code class="language-csharp">public class WeakDelegate&lt;TDelegate&gt; where TDelegate : Delegate
{
 class MethodTarget
 {
   public readonly WeakReference Reference;
   public readonly MethodInfo Method;
   public MethodTarget(Delegate d)
   {
     if (d.Target != null) Reference = new WeakReference(d.Target);
     Method = d.Method;
   }
 }
 List&lt;MethodTarget&gt; _targets = new List&lt;MethodTarget&gt;();

 public void Combine(TDelegate target)
 {
   if (target == null) return;
   foreach (Delegate d in (target as Delegate).GetInvocationList())
     _targets.Add(new MethodTarget(d));
 }

 public void Remove(TDelegate target)
 {
   if (target == null) return;
   foreach (Delegate d in (target as Delegate).GetInvocationList())
   {
     MethodTarget mt = _targets.Find(w =&gt;
       Equals(d.Target, w.Reference?.Target) &amp;&amp;
       Equals(d.Method.MethodHandle, w.Method.MethodHandle));
     if (mt != null) _targets.Remove(mt);
   }
 }

 public TDelegate Target
 {
   get
   {
     Delegate combinedTarget = null;
     foreach (MethodTarget mt in _targets.ToArray())
     {
       WeakReference wr = mt.Reference;
       if (wr == null || wr.Target != null)
       {
         var newDelegate = Delegate.CreateDelegate(typeof(TDelegate), wr?.Target, mt.Method);
         combinedTarget = Delegate.Combine(combinedTarget, newDelegate);
       }
       else
         _targets.Remove(mt);
     }
     return combinedTarget as TDelegate;
   }
   set
   {
     _targets.Clear();
     Combine(value);
   }
 }
}
</code></pre>
<p>ุฏุฑ ูุชุฏูุง <strong>Combine</strong> ู <strong>Remove</strong>ุ ุชุจุฏู ูุฑุฌุน ุงุฒ target ุจู <strong>Delegate</strong> ุจุง <strong>as operator</strong> ุงูุฌุงู ูโุดูุฏ ุชุง ุงุฒ ุงุจูุงู ุจุงูููู ุจู <strong>custom conversion</strong> ู <strong>reference conversion</strong> ุฌููฺฏุฑ ุดูุฏ.</p>
<p>ุฏุฑ ูฺฺฏ <strong>Target</strong>ุ ฺฉ <strong>multicast delegate</strong> ุงุฌุงุฏ ูโฺฉูู ฺฉู ููู delegateูุง ุฒูุฏูโุง ฺฉู ุชูุณุท <strong>weak references</strong> ูฺฏู ุฏุงุดุชู ุดุฏูโุงูุฏ ุฑุง ุชุฑฺฉุจ ูโฺฉูุฏ ู ูุงุจู (dead) ุฑุง ุงุฒ ูุณุช ุญุฐู ูโฺฉูุฏ ุชุง ูุณุช _targets ุจโูพุงุงู ุฑุดุฏ ูฺฉูุฏ.</p>
<hr>
<p>๐ ูุซุงู ุงุณุชูุงุฏู ุงุฒ ุงู delegate ุฏุฑ ูพุงุฏูโุณุงุฒ event:</p>
<pre><code class="language-csharp">public class Foo
{
 WeakDelegate&lt;EventHandler&gt; _click = new WeakDelegate&lt;EventHandler&gt;();
 public event EventHandler Click
 {
   add { _click.Combine(value); }
   remove { _click.Remove(value); }
 }
 protected virtual void OnClick(EventArgs e)
   =&gt; _click.Target?.Invoke(this, e);
}
</code></pre>

  </main>

  <!-- ููุชุฑ ูุดุชุฑฺฉ -->
  <footer class="footer">
    <div class="container">
      <p>
        <img src="/icone/copyright.svg" alt="ฺฉูพโุฑุงุช" width="14" height="14"
             style="vertical-align:middle;margin-inline:4px">
        <span id="y"></span> Gitab โ ุจุฑุง ุชูุณุนูโุฏููุฏฺฏุงู
      </p>
    </div>
  </footer>

  <!-- ุณุงู + ุงุณฺฉุฑูพุช ุชู -->
  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    (() => {
      const root = document.documentElement;
      const btn = document.getElementById('themeToggle');
      const KEY = 'gitab-theme';
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      const getEffective = s => s === 'auto' ? (media.matches ? 'dark' : 'light') : s;
      function updateTheme(s) {
        root.setAttribute('data-theme', s);
        const mode = getEffective(s);
        root.dataset.colorMode = mode;
        btn.dataset.icon = mode === 'dark' ? 'moon' : 'sun';
      }
      const saved = localStorage.getItem(KEY) || 'auto';
      updateTheme(saved);
      btn.addEventListener('click', () => {
        const curr = localStorage.getItem(KEY) || 'auto';
        const next = curr === 'auto' ? 'dark' : curr === 'dark' ? 'light' : 'auto';
        localStorage.setItem(KEY, next);
        updateTheme(next);
      });
      media.addEventListener('change', () => {
        if ((localStorage.getItem(KEY) || 'auto') === 'auto') updateTheme('auto');
      });
      window.addEventListener('DOMContentLoaded', () => updateTheme(saved));
    })();
  </script>
</body>
</html>
